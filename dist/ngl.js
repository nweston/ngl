!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three"),require("chroma-js"),require("signals"),require("sprintf-js"),require("promise-polyfill")):"function"==typeof define&&define.amd?define(["exports","three","chroma-js","signals","sprintf-js","promise-polyfill"],e):e(t.NGL={},t.three,t.chroma,t.signalsWrapper,t.sprintfJs,t._Promise)}(this,function(de,fe,r,u,a,t){"use strict";var e,h,i,o,c,n,l,s;function p(t){if("undefined"!=typeof window){var e=new RegExp(t+"=([^&#=]*)").exec(window.location.search);return e?decodeURIComponent(e[1]):void 0}}function st(t,e){return void 0!==t?t:e}function w(t,e){var r=Object.assign({},t);for(var i in e){void 0===t[i]&&(r[i]=e[i])}return r}function d(t,e){for(var r in e){var i=e[r];void 0!==i&&(t[r]=i)}return t}function f(){var t=window.location.protocol;return null===t.match(/http(s)?:/gi)?"http:":t}function m(){if("undefined"==typeof window)return!1;var t=window.navigator.userAgent;return/Opera|OPR/.test(t)?"Opera":/Chrome/i.test(t)?"Chrome":/Firefox/i.test(t)?"Firefox":/Mobile(\/.*)? Safari/i.test(t)?"Mobile Safari":/MSIE/i.test(t)?"Internet Explorer":!!/Safari/i.test(t)&&"Safari"}function g(t){window.open(t,"_blank")||(window.location.href=t)}function y(t,e){if(void 0===e&&(e="download"),t){var r="Safari"===m(),i=/CriOS\/[\d]+/.test(window.navigator.userAgent),o=document.createElement("a");if("undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(t,e);else if((r||i)&&FileReader)if(t instanceof Blob){var n=new FileReader;n.onloadend=function(){s(n.result)},n.readAsDataURL(t)}else s(t);else{var a=!1;t instanceof Blob&&(t=URL.createObjectURL(t),a=!0),"download"in o?(o.style.display="hidden",document.body.appendChild(o),o.href=t,o.download=e,o.target="_blank",o.click(),document.body.removeChild(o)):g(t),a&&window.URL.revokeObjectURL(t)}}function s(t){g(i?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"))}}function v(t,e){return t<e?-1:e<t?1:0}function b(t,e,r){void 0===r&&(r=v);for(var i=0,o=t.length-1;i<=o;){var n=i+o>>1,a=r(e,t[n]);if(0<a)i=n+1;else{if(!(a<0))return n;o=n-1}}return-i-1}function x(t,e,r){var i=function(t,e){var r=t.length-1;if(t[r]<e)return-1;for(var i=0;i<=r;){var o=i+r>>1;t[o]>=e?r=o-1:i=o+1}return r+1}(t,e),o=function(t,e){if(t[0]>e)return-1;for(var r=0,i=t.length-1;r<=i;){var o=r+i>>1;t[o]>e?i=o-1:r=o+1}return r-1}(t,r);return-1===i||-1===o||o<i?0:o-i+1}function _(t){return t.sort().filter(function(t,e,r){return 0===e||t!==r[e-1]})}function C(t){if(28672<t.length){for(var e=[],r=0;r<t.length;r+=28672)e.push(String.fromCharCode.apply(null,t.subarray(r,r+28672)));return e.join("")}return String.fromCharCode.apply(null,t)}function A(t,e){switch(t){case"int8":return new Int8Array(e);case"int16":return new Int16Array(e);case"int32":return new Int32Array(e);case"uint8":return new Uint8Array(e);case"uint16":return new Uint16Array(e);case"uint32":return new Uint32Array(e);case"float32":return new Float32Array(e);default:throw new Error("arrayType unknown: "+t)}}function S(t,e){return new(65535<e?Uint32Array:Uint16Array)(t)}function L(t){return t.buffer&&t.buffer instanceof ArrayBuffer?t.buffer:t}function P(t,e){return void 0===t?t=new e:Array.isArray(t)&&(t=(new e).fromArray(t)),t}function I(t){return P(t,fe.Vector3)}function O(t){return P(t,fe.Matrix4)}function k(t){return P(t,fe.Quaternion)}function M(t){return e=t,r=Float32Array,e instanceof r?e:new r(e);var e,r}function B(t){return st(t,"").toString().toLowerCase()}t=t&&t.hasOwnProperty("default")?t.default:t,"undefined"!=typeof window&&function(){window.console=window.console||{};for(var t,e,r=window.console,i={},o=function(){},n="memory".split(","),a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profiles,profileEnd,show,table,time,timeEnd,timeline,timelineEnd,timeStamp,trace,warn".split(",");t=n.pop();)r[t]||(r[t]=i);for(;e=a.pop();)r[e]||(r[e]=o)}(),"undefined"==typeof window||void 0===window.HTMLCanvasElement||window.HTMLCanvasElement.prototype.toBlob||Object.defineProperty(window.HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,r){for(var i=window.atob(this.toDataURL(e,r).split(",")[1]),o=i.length,n=o>>2,a=new Uint8Array(o),s=new Uint32Array(a.buffer,0,n),c=0,u=0;c<n;c++)s[c]=i.charCodeAt(u++)|i.charCodeAt(u++)<<8|i.charCodeAt(u++)<<16|i.charCodeAt(u++)<<24;for(var h=3&o;h--;)a[u]=i.charCodeAt(u++);t(new window.Blob([a],{type:e||"image/png"}))}}),Math.cbrt=Math.cbrt||function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},Math.sign||(Math.sign=function(t){return 0===(t=+t)||isNaN(t)?Number(t):0<t?1:-1}),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t}),Number.isNaN||(Number.isNaN=function(t){return t!=t}),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(t){var e=arguments;if(null==t)throw new TypeError("Cannot convert first argument to object");for(var r,i=Object(t),o=!1,n=1;n<arguments.length;n++){var a=e[n];if(null!=a){for(var s=Object.keys(Object(a)),c=0,u=s.length;c<u;c++){var h=s[c];try{var l=Object.getOwnPropertyDescriptor(a,h);void 0!==l&&l.enumerable&&(i[h]=a[h])}catch(t){o||(o=!0,r=t)}}if(o)throw r}}return i}}),String.prototype.startsWith||(e=function(){var t;try{var e={},r=Object.defineProperty;t=r(e,e,e)&&r}catch(t){}return t}(),h={}.toString,i=function(t){if(null===this)throw TypeError();var e=String(this);if(t&&"[object RegExp]"===h.call(t))throw TypeError();var r=e.length,i=String(t),o=i.length,n=1<arguments.length?arguments[1]:void 0,a=n?Number(n):0;Number.isNaN(a)&&(a=0);var s=Math.min(Math.max(a,0),r);if(r<o+s)return!1;for(var c=-1;++c<o;)if(e.charCodeAt(s+c)!==i.charCodeAt(c))return!1;return!0},e?e(String.prototype,"startsWith",{value:i,configurable:!0,writable:!0}):String.prototype.startsWith=i),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){var r=this.toString();("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e>r.length)&&(e=r.length),e-=t.length;var i=r.indexOf(t,e);return-1!==i&&i===e}),String.prototype.repeat||(String.prototype.repeat=function(t){if(null===this)throw new TypeError("can't convert "+this+" to object");var e=""+this;if(t=+t,Number.isNaN(t)&&(t=0),t<0)throw new RangeError("repeat count must be non-negative");if(t===1/0)throw new RangeError("repeat count must be less than infinity");if(t=Math.floor(t),0===e.length||0===t)return"";if(e.length*t>=1<<28)throw new RangeError("repeat count must not overflow maximum string size");for(var r="";1==(1&t)&&(r+=e),0!==(t>>>=1);)e+=e;return r}),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),Array.prototype.includes||(Array.prototype.includes=function(t){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");var e=Object(this),r=parseInt(e.length,10)||0;if(0===r)return!1;var i,o,n=parseInt(arguments[1],10)||0;for(0<=n?i=n:(i=r+n)<0&&(i=0);i<r;){if(t===(o=e[i])||Number.isNaN(t)&&Number.isNaN(o))return!0;i++}return!1}),Array.from||(Array.from=(o=Object.prototype.toString,c=function(t){return"function"==typeof t||"[object Function]"===o.call(t)},n=Math.pow(2,53)-1,l=function(t){var e,r=(e=Number(t),isNaN(e)?0:0!==e&&isFinite(e)?(0<e?1:-1)*Math.floor(Math.abs(e)):e);return Math.min(Math.max(r,0),n)},function(t){var e=Object(t);if(null==t)throw new TypeError("Array.from requires an array-like object - not null or undefined");var r,i=1<arguments.length?arguments[1]:void 0;if(void 0!==i){if(!c(i))throw new TypeError("Array.from: when provided, the second argument must be a function");2<arguments.length&&(r=arguments[2])}for(var o,n=l(e.length),a=c(this)?Object(new this(n)):new Array(n),s=0;s<n;)o=e[s],a[s]=i?void 0===r?i(o,s):i.call(r,o,s):o,s+=1;return a.length=n,a})),"undefined"!=typeof window&&function(){for(var o=0,t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var e=(new Date).getTime(),r=Math.max(0,16-(e-o)),i=window.setTimeout(function(){t(e+r)},r);return o=e+r,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),"undefined"!=typeof window&&(void 0===window.performance&&(self.performance={}),void 0===window.performance.now&&(s=Date.now(),window.performance.now=function(){return Date.now()-s})),void 0!==Object.defineProperty&&(void 0===Number.MAX_SAFE_INTEGER&&Object.defineProperty(Number,"MAX_SAFE_INTEGER",{enumerable:!1,configurable:!1,writable:!1,value:Math.pow(2,53)-1}),void 0===Number.MIN_SAFE_INTEGER&&Object.defineProperty(Number,"MIN_SAFE_INTEGER",{enumerable:!1,configurable:!1,writable:!1,value:-(Math.pow(2,53)-1)}));var T=function(t){this.name=t,this._dict={}},D={names:{configurable:!0}};function et(t){return.01745*t}function j(t){return 57.29578*t}T.prototype.add=function(t,e){this._dict[B(t)]=e},T.prototype.get=function(t){return this._dict[B(t)]},D.names.get=function(){return Object.keys(this._dict)},Object.defineProperties(T.prototype,D);var R="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),F=new Array(36);function E(){for(var t,e=0,r=0;r<36;r++)8===r||13===r||18===r||23===r?F[r]="-":14===r?F[r]="4":(e<=2&&(e=33554432+16777216*Math.random()|0),t=15&e,e>>=4,F[r]=R[19===r?3&t|8:t]);return F.join("")}function $(t,e,r){return Math.max(e,Math.min(r,t))}function N(t,e,r){return t+(e-t)*r}function z(t,e,r,i,o,n){var a=(r-t)*n,s=(i-e)*n,c=o*o;return(2*e-2*r+a+s)*(o*c)+(-3*e+3*r-2*a-s)*c+a*o+e}function V(t,e,r){var i;return(r=$((r-(i=t))/(e-i),0,1))*r*(3-2*r)}var G,U,H={scale:"uniform",mode:"hcl",domain:[0,1],value:16777215,reverse:!1},W=new fe.Color,q=function(t){void 0===t&&(t={}),this.parameters=w(t,H),"string"==typeof this.parameters.value&&(this.parameters.value=W.set(this.parameters.value).getHex()),this.parameters.structure&&(this.atomProxy=this.parameters.structure.getAtomProxy())};q.prototype.getScale=function(t){void 0===t&&(t={});var e=w(t,this.parameters);return"rainbow"===e.scale?e.scale=["red","orange","yellow","green","blue"]:"rwb"===e.scale&&(e.scale=["red","white","blue"]),e.reverse&&e.domain.reverse(),r.scale(e.scale).mode(e.mode).domain(e.domain).out("num")},q.prototype.colorToArray=function(t,e,r){return void 0===e&&(e=[]),void 0===r&&(r=0),e[r]=(t>>16&255)/255,e[r+1]=(t>>8&255)/255,e[r+2]=(255&t)/255,e},q.prototype.atomColorToArray=function(t,e,r){return this.colorToArray(this.atomColor?this.atomColor(t):0,e,r)},q.prototype.bondColor=function(t,e){return this.atomProxy&&this.atomColor?(this.atomProxy.index=e?t.atomIndex1:t.atomIndex2,this.atomColor(this.atomProxy)):0},q.prototype.bondColorToArray=function(t,e,r,i){return this.colorToArray(this.bondColor(t,e),r,i)},q.prototype.volumeColorToArray=function(t,e,r){return this.colorToArray(this.volumeColor?this.volumeColor(t):0,e,r)},q.prototype.positionColorToArray=function(t,e,r){return this.colorToArray(this.positionColor?this.positionColor(t):0,e,r)},(U=G||(G={}))[U.PROTEIN=1]="PROTEIN",U[U.NUCLEIC=2]="NUCLEIC",U[U.RNA=3]="RNA",U[U.DNA=4]="DNA",U[U.POLYMER=5]="POLYMER",U[U.WATER=6]="WATER",U[U.HELIX=7]="HELIX",U[U.SHEET=8]="SHEET",U[U.TURN=9]="TURN",U[U.BACKBONE=10]="BACKBONE",U[U.SIDECHAIN=11]="SIDECHAIN",U[U.ALL=12]="ALL",U[U.HETERO=13]="HETERO",U[U.ION=14]="ION",U[U.SACCHARIDE=15]="SACCHARIDE",U[U.SUGAR=15]="SUGAR",U[U.BONDED=16]="BONDED",U[U.RING=17]="RING",U[U.AROMATICRING=18]="AROMATICRING",U[U.METAL=19]="METAL",U[U.NONE=20]="NONE";var X=["*","","ALL"],Y=["NONE"],K=[G.BACKBONE,G.SIDECHAIN,G.BONDED,G.RING,G.AROMATICRING,G.METAL],Z=[G.POLYMER,G.WATER],Q=["ALA","GLY","SER"],J=["CYS","SER","THR"],tt=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],rt=["PHE","TRP","TYR","HIS"],it=["ASN","GLN"],ot=["ASP","GLU"],nt=["ARG","HIS","LYS"],at=["ARG","ASP","GLU","HIS","LYS"],ct=["ASN","ARG","ASP","CYS","GLY","GLN","GLU","HIS","LYS","SER","THR","TYR"],ut=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],ht=["HIS","PHE","PRO","TRP","TYR"],lt=["ALA","GLY","ILE","LEU","VAL"];function pt(t,e){if(void 0===e.atomname&&void 0===e.element&&void 0===e.altloc&&void 0===e.atomindex&&void 0===e.keyword&&void 0===e.inscode&&void 0===e.resname&&void 0===e.sstruc&&void 0===e.resno&&void 0===e.chainname&&void 0===e.model)return-1;if(void 0!==e.keyword){if(e.keyword===G.BACKBONE&&!t.isBackbone())return!1;if(e.keyword===G.SIDECHAIN&&!t.isSidechain())return!1;if(e.keyword===G.BONDED&&!t.isBonded())return!1;if(e.keyword===G.RING&&!t.isRing())return!1;if(e.keyword===G.AROMATICRING&&!t.isAromatic())return!1;if(e.keyword===G.HETERO&&!t.isHetero())return!1;if(e.keyword===G.PROTEIN&&!t.isProtein())return!1;if(e.keyword===G.NUCLEIC&&!t.isNucleic())return!1;if(e.keyword===G.RNA&&!t.isRna())return!1;if(e.keyword===G.DNA&&!t.isDna())return!1;if(e.keyword===G.POLYMER&&!t.isPolymer())return!1;if(e.keyword===G.WATER&&!t.isWater())return!1;if(e.keyword===G.HELIX&&!t.isHelix())return!1;if(e.keyword===G.SHEET&&!t.isSheet())return!1;if(e.keyword===G.TURN&&!t.isTurn())return!1;if(e.keyword===G.ION&&!t.isIon())return!1;if(e.keyword===G.SACCHARIDE&&!t.isSaccharide())return!1;if(e.keyword===G.METAL&&!t.isMetal())return!1}if(void 0!==e.atomname&&e.atomname!==t.atomname)return!1;if(void 0!==e.element&&e.element!==t.element)return!1;if(void 0!==e.altloc&&e.altloc!==t.altloc)return!1;if(void 0!==e.atomindex&&b(e.atomindex,t.index)<0)return!1;if(void 0!==e.resname)if(Array.isArray(e.resname)){if(!e.resname.includes(t.resname))return!1}else if(e.resname!==t.resname)return!1;if(void 0!==e.sstruc&&e.sstruc!==t.sstruc)return!1;if(void 0!==e.resno)if(Array.isArray(e.resno)&&2===e.resno.length){if(e.resno[0]>t.resno||e.resno[1]<t.resno)return!1}else if(e.resno!==t.resno)return!1;return(void 0===e.inscode||e.inscode===t.inscode)&&((void 0===e.chainname||e.chainname===t.chainname)&&(void 0===e.model||e.model===t.modelIndex))}function dt(t,e){if(void 0===e.resname&&void 0===e.resno&&void 0===e.inscode&&void 0===e.sstruc&&void 0===e.model&&void 0===e.chainname&&void 0===e.atomindex&&(void 0===e.keyword||K.includes(e.keyword)))return-1;if(void 0!==e.keyword){if(e.keyword===G.HETERO&&!t.isHetero())return!1;if(e.keyword===G.PROTEIN&&!t.isProtein())return!1;if(e.keyword===G.NUCLEIC&&!t.isNucleic())return!1;if(e.keyword===G.RNA&&!t.isRna())return!1;if(e.keyword===G.DNA&&!t.isDna())return!1;if(e.keyword===G.POLYMER&&!t.isPolymer())return!1;if(e.keyword===G.WATER&&!t.isWater())return!1;if(e.keyword===G.HELIX&&!t.isHelix())return!1;if(e.keyword===G.SHEET&&!t.isSheet())return!1;if(e.keyword===G.TURN&&!t.isTurn())return!1;if(e.keyword===G.ION&&!t.isIon())return!1;if(e.keyword===G.SACCHARIDE&&!t.isSaccharide())return!1}if(void 0!==e.atomindex&&0===x(e.atomindex,t.atomOffset,t.atomEnd))return!1;if(void 0!==e.resname)if(Array.isArray(e.resname)){if(!e.resname.includes(t.resname))return!1}else if(e.resname!==t.resname)return!1;if(void 0!==e.sstruc&&e.sstruc!==t.sstruc)return!1;if(void 0!==e.resno)if(Array.isArray(e.resno)&&2===e.resno.length){if(e.resno[0]>t.resno||e.resno[1]<t.resno)return!1}else if(e.resno!==t.resno)return!1;return(void 0===e.inscode||e.inscode===t.inscode)&&((void 0===e.chainname||e.chainname===t.chainname)&&(void 0===e.model||e.model===t.modelIndex))}function ft(t,e){if(!(void 0!==e.chainname||void 0!==e.model||void 0!==e.atomindex||void 0!==e.keyword&&Z.includes(e.keyword)&&t.entity))return-1;if(void 0!==e.keyword){if(e.keyword===G.POLYMER&&!t.entity.isPolymer())return!1;if(e.keyword===G.WATER&&!t.entity.isWater())return!1}return(void 0===e.atomindex||0!==x(e.atomindex,t.atomOffset,t.atomEnd))&&((void 0===e.chainname||e.chainname===t.chainname)&&(void 0===e.model||e.model===t.modelIndex))}function mt(t,e){return void 0===e.model&&void 0===e.atomindex?-1:(void 0===e.atomindex||0!==x(e.atomindex,t.atomOffset,t.atomEnd))&&(void 0===e.model||e.model===t.index)}function gt(s,c){if(null===s)return!1;if(s.error)return!1;if(!s.rules||0===s.rules.length)return!1;for(var u=s.rules.length,h=!s.negate,l=!!s.negate,p=[],t=0;t<u;++t){var e=s.rules[t];e.hasOwnProperty("operator")&&(p[t]=gt(e,c))}return function(t){for(var e="AND"===s.operator,r=!1,i=0;i<u;++i){var o=s.rules[i],n=void 0;if(o.hasOwnProperty("operator")){var a=p[i];if(-1===(n=!1!==a?a(t):-1)){r=!0;continue}if(!0===n){if(e)continue;return h}if(e)return l}else{if(o.keyword===G.ALL){if(e)continue;return h}if(o.keyword===G.NONE){if(e)continue;return l}if(-1!==(n=c(t,o))){if(!0===n){if(e)continue;return h}if(e)return l}else r=!0}}return r?-1:e?h:l}}function yt(t,e){if(t.error)return t;if(!t.rules||0===t.rules.length)return t;var r=t.rules.length,i={operator:t.operator,rules:[]};t.hasOwnProperty("negate")&&(i.negate=t.negate);for(var o=0;o<r;++o){var n=t.rules[o];if(n.hasOwnProperty("operator")){var a=yt(n,e);null!==a&&i.rules.push(a)}else e(n)||i.rules.push(n)}return 0<i.rules.length?t:null}function vt(t,e){void 0===e&&(e=!1);var r=t;return e&&(r=yt(t,function(t){return void 0!==t.keyword&&!K.includes(t.keyword)||(void 0!==t.model||(void 0!==t.chainname||(void 0!==t.resname||(void 0!==t.resno||void 0!==t.sstruc))))})),gt(r,pt)}function bt(t,e){void 0===e&&(e=!1);var r=t;return e&&(r=yt(t,function(t){return!(void 0===t.keyword||!K.includes(t.keyword))||(void 0!==t.model||(void 0!==t.chainname||(void 0!==t.atomname||(void 0!==t.element||void 0!==t.altloc))))})),gt(r,dt)}function xt(t,e){void 0===e&&(e=!1);var r=t;return e&&(r=yt(t,function(t){return void 0!==t.keyword&&!Z.includes(t.keyword)||(void 0!==t.resname||(void 0!==t.resno||(void 0!==t.atomname||(void 0!==t.element||(void 0!==t.altloc||(void 0!==t.sstruc||void 0!==t.inscode))))))})),gt(r,ft)}function _t(t,e){void 0===e&&(e=!1);var r=t;return e&&(r=yt(t,function(t){return void 0!==t.keyword||(void 0!==t.chainname||(void 0!==t.resname||(void 0!==t.resno||(void 0!==t.atomname||(void 0!==t.element||(void 0!==t.altloc||(void 0!==t.sstruc||void 0!==t.inscode)))))))})),gt(r,mt)}var Ct=function(t){this.signals={stringChanged:new u.Signal},this.setString(t)},wt={type:{configurable:!0}};wt.type.get=function(){return"selection"},Ct.prototype.setString=function(t,e){if(void 0===t&&(t=this.string||""),t!==this.string){try{this.selection=function(t){var e={operator:void 0,rules:[]};if(!t)return e;var r,i,o=e,n=[];"("===(t=t.replace(/\(/g," ( ").replace(/\)/g," ) ").trim()).charAt(0)&&")"===t.substr(-1)&&(t=t.slice(1,-1).trim());for(var a=t.split(/\s+/),s=function(t){r={operator:t,rules:[]},void 0===o?e=o=r:(o.rules.push(r),n.push(o),o=r)},c=function(t){i=o,void 0===(o=n.pop())&&(s(t),u(i))},u=function(t){o.rules.push(t)},h=!1,l=0;l<a.length;++l){var p=a[l],d=p.toUpperCase();if("("!==p)if(")"!==p){if(0<h)if("NOT"===d)h=1;else if(1===h)h=2;else{if(2!==h)throw new Error("something went wrong with 'not'");h=!1,c()}if("AND"!==d)if("OR"!==d)if("NOT"!==p.toUpperCase()){if(+d!=+d){var f=G[d];if(void 0!==f){u({keyword:f});continue}}if("HYDROGEN"!==d)if("SMALL"!==d)if("NUCLEOPHILIC"!==d)if("HYDROPHOBIC"!==d)if("AROMATIC"!==d)if("AMIDE"!==d)if("ACIDIC"!==d)if("BASIC"!==d)if("CHARGED"!==d)if("POLAR"!==d)if("NONPOLAR"!==d)if("CYCLIC"!==d)if("ALIPHATIC"!==d)if("SIDECHAINATTACHED"!==d)if("LIGAND"!==d)if(-1===X.indexOf(d))if("@"!==p.charAt(0))if("#"!==p.charAt(0))if("_"!==p.charAt(0))if("["!==p[0]||"]"!==p[p.length-1])if(1<=p.length&&p.length<=4&&"^"!==p[0]&&":"!==p[0]&&"."!==p[0]&&"%"!==p[0]&&"/"!==p[0]&&isNaN(parseInt(p)))u({resname:d});else{var m={operator:"AND",rules:[]},g=p.split("/");if(1<g.length&&g[1]){if(isNaN(parseInt(g[1])))throw new Error("model must be an integer");m.rules.push({model:parseInt(g[1])})}var y=g[0].split("%");1<y.length&&m.rules.push({altloc:y[1]});var v=y[0].split(".");if(1<v.length&&v[1]){if(4<v[1].length)throw new Error("atomname must be one to four characters");m.rules.push({atomname:v[1].substring(0,4).toUpperCase()})}var b=v[0].split(":");1<b.length&&b[1]&&m.rules.push({chainname:b[1]});var x=b[0].split("^");if(1<x.length&&m.rules.push({inscode:x[1]}),x[0]){var _=void 0,w=void 0;"-"===x[0][0]&&(x[0]=x[0].substr(1),_=!0),x[0].includes("--")&&(x[0]=x[0].replace("--","-"),w=!0);var A=x[0].split("-");if(1===A.length){var S=parseInt(A[0]);if(isNaN(S))throw new Error("resi must be an integer");_&&(S*=-1),m.rules.push({resno:S})}else{if(2!==A.length)throw new Error("resi range must contain one '-'");var C=A.map(function(t){return parseInt(t)});_&&(C[0]*=-1),w&&(C[1]*=-1),m.rules.push({resno:[C[0],C[1]]})}}if(1===m.rules.length)u(m.rules[0]);else{if(!(1<m.rules.length))throw new Error("empty selection chunk");u(m)}}else{var P=d.substr(1,p.length-2).split(","),I=1<P.length?P:P[0];u({resname:I})}else u({element:d.substr(1)});else console.error("# for element selection deprecated, use _"),u({element:d.substr(1)});else{var O=p.substr(1).split(",").map(function(t){return parseInt(t)});O.sort(function(t,e){return t-e}),u({atomindex:O})}else u({keyword:G.ALL});else u({operator:"AND",rules:[{operator:"OR",rules:[{operator:"AND",rules:[{keyword:G.HETERO},{negate:!0,operator:void 0,rules:[{keyword:G.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{keyword:G.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{operator:"OR",rules:[{keyword:G.WATER},{keyword:G.ION}]}]}]});else u({operator:"OR",rules:[{keyword:G.SIDECHAIN},{operator:"AND",negate:!1,rules:[{keyword:G.PROTEIN},{operator:"OR",negate:!1,rules:[{atomname:"CA"},{atomname:"BB"}]}]},{operator:"AND",negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{operator:"AND",negate:!1,rules:[{keyword:G.NUCLEIC},{operator:"OR",negate:!0,rules:[{atomname:"P"},{atomname:"OP1"},{atomname:"OP2"},{atomname:"O3'"},{atomname:"O3*"},{atomname:"O5'"},{atomname:"O5*"},{atomname:"C5'"},{atomname:"C5*"}]}]}]});else u({resname:lt});else u({resname:ht});else u({resname:ut});else u({resname:ct});else u({resname:at});else u({resname:nt});else u({resname:ot});else u({resname:it});else u({resname:rt});else u({resname:tt});else u({resname:J});else u({resname:Q});else u({operator:"OR",rules:[{element:"H"},{element:"D"}]})}else h=1,s(),o.negate=!0;else"AND"===o.operator?c("OR"):o.operator="OR";else if("OR"===o.operator){var k=o.rules.pop();s("AND"),u(k)}else o.operator="AND"}else c(),o.negate&&c();else h=!1,s()}return void 0===e.operator&&1===e.rules.length&&e.rules[0].hasOwnProperty("operator")&&(e=e.rules[0]),e}(t)}catch(t){this.selection={error:t.message}}var r=this.selection;this.string=t,this.test=vt(r),this.residueTest=bt(r),this.chainTest=xt(r),this.modelTest=_t(r),this.atomOnlyTest=vt(r,!0),this.residueOnlyTest=bt(r,!0),this.chainOnlyTest=xt(r,!0),this.modelOnlyTest=_t(r,!0),e||this.signals.stringChanged.dispatch(this.string)}},Ct.prototype.isAllSelection=function(){return X.includes(this.string.toUpperCase())},Ct.prototype.isNoneSelection=function(){return Y.includes(this.string.toUpperCase())},Object.defineProperties(Ct.prototype,wt);var At=function(e){function t(t){var o=this;e.call(this,t),this.colormakerList=[],this.selectionList=[],(t.dataList||[]).forEach(function(t){var e=t[0],r=t[1],i=t[2];void 0===i&&(i={}),Vt.hasScheme(e)?Object.assign(i,{scheme:e,structure:o.parameters.structure}):Object.assign(i,{scheme:"uniform",value:new fe.Color(e).getHex()}),o.colormakerList.push(Vt.getScheme(i)),o.selectionList.push(new Ct(r))})}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){for(var e=0,r=this.selectionList.length;e<r;++e){var i=this.selectionList[e].test;if(i&&i(t))return this.colormakerList[e].atomColor(t)}return 16777215},t}(q),St={"":"",OrRd:"[S] Orange-Red",PuBu:"[S] Purple-Blue",BuPu:"[S] Blue-Purple",Oranges:"[S] Oranges",BuGn:"[S] Blue-Green",YlOrBr:"[S] Yellow-Orange-Brown",YlGn:"[S] Yellow-Green",Reds:"[S] Reds",RdPu:"[S] Red-Purple",Greens:"[S] Greens",YlGnBu:"[S] Yellow-Green-Blue",Purples:"[S] Purples",GnBu:"[S] Green-Blue",Greys:"[S] Greys",YlOrRd:"[S] Yellow-Orange-Red",PuRd:"[S] Purple-Red",Blues:"[S] Blues",PuBuGn:"[S] Purple-Blue-Green",Viridis:"[D] Viridis",Spectral:"[D] Spectral",RdYlGn:"[D] Red-Yellow-Green",RdBu:"[D] Red-Blue",PiYG:"[D] Pink-Yellowgreen",PRGn:"[D] Purplered-Green",RdYlBu:"[D] Red-Yellow-Blue",BrBG:"[D] Brown-Bluegreen",RdGy:"[D] Red-Grey",PuOr:"[D] Purple-Orange",Set1:"[Q] Set1",Set2:"[Q] Set2",Set3:"[Q] Set3",Dark2:"[Q] Dark2",Paired:"[Q] Paired",Pastel1:"[Q] Pastel1",Pastel2:"[Q] Pastel2",Accent:"[Q] Accent",rainbow:"[?] Rainbow",rwb:"[?] Red-White-Blue"},Pt={"":"",rgb:"Red Green Blue",hsv:"Hue Saturation Value",hsl:"Hue Saturation Lightness",hsi:"Hue Saturation Intensity",lab:"CIE L*a*b*",hcl:"Hue Chroma Lightness"},It=function(){this.schemes={},this.userSchemes={}};It.prototype.getScheme=function(t){var e=((t||{}).scheme||"").toLowerCase();return new(e in this.schemes?this.schemes[e]:e in this.userSchemes?this.userSchemes[e]:q)(t)},It.prototype.getSchemes=function(){var e={};return Object.keys(this.schemes).forEach(function(t){e[t]=t}),Object.keys(this.userSchemes).forEach(function(t){e[t]=t.split("|")[1]}),e},It.prototype.getScales=function(){return St},It.prototype.getModes=function(){return Pt},It.prototype.add=function(t,e){t=t.toLowerCase(),this.schemes[t]=e},It.prototype.addScheme=function(t,e){return t instanceof q||(t=this._createScheme(t)),this._addUserScheme(t,e)},It.prototype._addUserScheme=function(t,e){e=e||"";var r=(E()+"|"+e).toLowerCase();return this.userSchemes[r]=t,r},It.prototype.removeScheme=function(t){t=t.toLowerCase(),delete this.userSchemes[t]},It.prototype._createScheme=function(e){var t=function(t){q.call(this,t),e.call(this,t)};return(t.prototype=q.prototype).constructor=q,t},It.prototype.addSelectionScheme=function(r,t){var e=function(e){function t(t){e.call(this,Object.assign({dataList:r},t))}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t}(At);return this._addUserScheme(e,t)},It.prototype.hasScheme=function(t){return(t=t.toLowerCase())in this.schemes||t in this.userSchemes};var Ot=function(t){function e(){t.call(this,"parser")}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.__hasObjName=function(t,e){var r=this.get(t);return r&&r.prototype.__objName===e},e.prototype.isTrajectory=function(t){return this.__hasObjName(t,"frames")},e.prototype.isStructure=function(t){return this.__hasObjName(t,"structure")},e.prototype.isVolume=function(t){return this.__hasObjName(t,"volume")},e.prototype.isSurface=function(t){return this.__hasObjName(t,"surface")},e.prototype.isBinary=function(t){var e=this.get(t);return e&&e.prototype.isBinary},e.prototype.isXml=function(t){var e=this.get(t);return e&&e.prototype.isXml},e.prototype.isJson=function(t){var e=this.get(t);return e&&e.prototype.isJson},e.prototype.getTrajectoryExtensions=function(){var e=this;return this.names.filter(function(t){return e.isTrajectory(t)})},e.prototype.getStructureExtensions=function(){var e=this;return this.names.filter(function(t){return e.isStructure(t)})},e.prototype.getVolumeExtensions=function(){var e=this;return this.names.filter(function(t){return e.isVolume(t)})},e.prototype.getSurfaceExtensions=function(){var e=this;return this.names.filter(function(t){return e.isSurface(t)})},e}(T);function kt(t){return _(function e(t){var r=t;return t.forEach(function(t){t.__deps&&Array.prototype.push.apply(r,e(t.__deps))}),r}(t)).map(function(t){return t.toString()}).join("\n\n\n")}function Mt(t,e){var r="'use strict';\n\n"+kt(e);return r+="\n\n\nself.func = "+t.toString()+";",r+="\n\n\nself.onmessage = "+function(t){var e=t.data.__name,r=t.data.__postId;void 0===e?console.error("message __name undefined"):void 0===self.func?console.error("worker func undefined",e):self.func(t,function(e,t){e=e||{},void 0!==r&&(e.__postId=r);try{self.postMessage(e,t)}catch(t){console.error("self.postMessage:",t),self.postMessage(e)}})}.toString()+";",new Blob([r],{type:"application/javascript"})}var Bt=function(){this.activeWorkerCount=0,this._funcDict={},this._depsDict={},this._blobDict={}};Bt.prototype.add=function(t,e,r){this._funcDict[t]=e,this._depsDict[t]=r},Bt.prototype.get=function(t){return this._blobDict[t]||(this._blobDict[t]=Mt(this._funcDict[t],this._depsDict[t])),this._blobDict[t]};var Tt=m(),Dt=!1;try{var Rt=Object.defineProperty({},"passive",{get:function(){Dt=!0}});window.addEventListener("test",function(t){},Rt)}catch(t){}var Ft="undefined"!=typeof window&&void 0!==window.orientation,Et=!1;var $t=!1;var Lt,me={log:Function.prototype.bind.call(console.log,console),info:Function.prototype.bind.call(console.info,console),warn:Function.prototype.bind.call(console.warn,console),error:Function.prototype.bind.call(console.error,console),time:Function.prototype.bind.call(console.time,console),timeEnd:Function.prototype.bind.call(console.timeEnd,console)},Nt={color:"green",labelColor:8421504,labelAttachment:"bottom-center",labelSize:.7,labelZOffset:.5,labelYOffset:.1,labelBorder:!0,labelBorderColor:13882323,labelBorderWidth:.25,lineOpacity:.8,linewidth:5,opacity:.6,labelUnit:"angstrom",arcVisible:!0,planeVisible:!1};de.Debug=!!(Lt=p("debug"))&&("string"!=typeof Lt||/^1|true|t|yes|y$/i.test(Lt));var zt=["ngl","js"],jt=new Bt,Vt=new It,Gt=new T("datasource"),Ut=new T("representatation"),Ht=new Ot,Wt=new T("shader"),qt=new T("decompressor"),Xt=new T("component"),Yt=new T("buffer"),Kt=new T("picker");var Zt=function(t,e){void 0===e&&(e={}),this.chunkSize=10485760,this.newline="\n",this.__pointer=0,this.__partialLine="",this.compressed=st(e.compressed,!1),this.binary=st(e.binary,!1),this.json=st(e.json,!1),this.xml=st(e.xml,!1),this.src=t};Zt.prototype.isBinary=function(){return this.binary||this.compressed},Zt.prototype.read=function(){var r=this;return this._read().then(function(t){var e=r.compressed?qt.get(r.compressed):void 0;return r.compressed&&e?r.data=e(t):((r.binary||r.compressed)&&t instanceof ArrayBuffer&&(t=new Uint8Array(t)),r.data=t),r.data})},Zt.prototype._chunk=function(t,e){return e=Math.min(this.data.length,e),0===t&&this.data.length===e?this.data:this.isBinary()?this.data.subarray(t,e):this.data.substring(t,e)},Zt.prototype.chunk=function(t){var e=t+this.chunkSize;return this._chunk(t,e)},Zt.prototype.peekLines=function(t){var e,r=this.data,i=r.length,o=this.isBinary()?this.newline.charCodeAt(0):this.newline,n=0;for(e=0;e<i&&(r[e]===o&&++n,n!==t);++e);var a=this._chunk(0,e+1);return this.chunkToLines(a,"",i<e).lines},Zt.prototype.chunkCount=function(){return Math.floor(this.data.length/this.chunkSize)+1},Zt.prototype.asText=function(){return this.isBinary()?C(this.data):this.data},Zt.prototype.chunkToLines=function(t,e,r){var i=this.newline;if(!this.isBinary()&&t.length===this.data.length)return{lines:t.split(i),partialLine:""};var o=[],n=this.isBinary()?C(t):t,a=n.lastIndexOf(i);if(-1===a)e+=n;else{var s=e+n.substr(0,a);o=o.concat(s.split(i)),e=a===n.length-i.length?"":n.substr(a+i.length)}return r&&""!==e&&o.push(e),{lines:o,partialLine:e}},Zt.prototype.nextChunk=function(){var t=this.__pointer;if(!(t>this.data.length))return this.__pointer+=this.chunkSize,this.chunk(t)},Zt.prototype.nextChunkOfLines=function(){var t=this.nextChunk();if(void 0!==t){var e=this.__pointer>this.data.length,r=this.chunkToLines(t,this.__partialLine,e);return this.__partialLine=r.partialLine,r.lines}},Zt.prototype.eachChunk=function(t){for(var e=this.chunkSize,r=this.data.length,i=this.chunkCount(),o=0;o<r;o+=e){t(this.chunk(o),Math.round(o/e),i)}},Zt.prototype.eachChunkOfLines=function(n){var a=this;this.eachChunk(function(t,e,r){var i=e===r+1,o=a.chunkToLines(t,a.__partialLine,i);a.__partialLine=o.partialLine,n(o.lines,e,r)})},Zt.prototype.dispose=function(){delete this.src};var Qt=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._read=function(){var o=this;return new Promise(function(e,r){var t=o.src,i=new FileReader;i.onload=function(t){t.target&&e(t.target.result)},i.onerror=function(t){return r(t)},o.binary||o.compressed?i.readAsArrayBuffer(t):i.readAsText(t)})},e}(Zt),Jt=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._read=function(){var o=this;return new Promise(function(t,e){var r=o.src,i=new XMLHttpRequest;i.open("GET",r,!0),i.addEventListener("load",function(){if(200===i.status||304===i.status||0===i.status)try{t(i.response)}catch(t){e(t)}else e(i.statusText)},!1),i.addEventListener("error",function(t){return e("network error")},!1),o.isBinary()?i.responseType="arraybuffer":o.json?i.responseType="json":o.xml?i.responseType="document":i.responseType="text",i.send()})},e}(Zt),te=function(t,e){void 0===e&&(e={}),this.parameters=w(e,{ext:"",compressed:!1,binary:Ht.isBinary(e.ext||""),name:"",dir:"",path:"",protocol:""});var r={compressed:this.parameters.compressed,binary:this.parameters.binary,json:Ht.isJson(this.parameters.ext),xml:Ht.isXml(this.parameters.ext)};"undefined"!=typeof File&&t instanceof File||"undefined"!=typeof Blob&&t instanceof Blob?this.streamer=new Qt(t,r):this.streamer=new Jt(t,r)},ee=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.parserParams={voxelSize:e.voxelSize,firstModelOnly:e.firstModelOnly,asTrajectory:e.asTrajectory,cAlphaOnly:e.cAlphaOnly,name:this.parameters.name,path:this.parameters.path}}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.load=function(){return new(Ht.get(this.parameters.ext))(this.streamer,this.parserParams).parse()},t}(te),re=function(t,e,r){this.name=e,this.path=r,this.signals={elementAdded:new u.Signal,elementRemoved:new u.Signal,nameChanged:new u.Signal},this.type="Script",this.dir=r.substring(0,r.lastIndexOf("/")+1);try{this.fn=new Function("stage","__name","__path","__dir",t)}catch(t){me.error("Script compilation failed",t),this.fn=function(){}}};re.prototype.run=function(r){var i=this;return new Promise(function(t,e){try{i.fn.apply(null,[r,i.name,i.path,i.dir]),t()}catch(t){me.error("Script.fn",t),e(t)}})};var ie=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.load=function(){var t=this;return this.streamer.read().then(function(){return new re(t.streamer.asText(),t.parameters.name,t.parameters.path)})},e}(te);function oe(t){var e,r,i=qt.names,o="",n=(e=t instanceof File?t.name:t instanceof Blob?"":t).lastIndexOf("?"),a=-1!==n?e.substring(n):"",s=(e=e.substring(0,-1===n?e.length:n)).replace(/^.*[\\/]/,""),c=s.substring(0,s.lastIndexOf(".")),u=s.split("."),h=1<u.length?(u.pop()||"").toLowerCase():"",l=e.match(/^(.+):\/\/(.+)$/);l&&(o=l[1].toLowerCase(),e=l[2]||"");var p=e.substring(0,e.lastIndexOf("/")+1);if(i.includes(h)){r=h;var d=e.length-h.length-1;h=(e.substr(0,d).split(".").pop()||"").toLowerCase();var f=c.length-h.length-1;c=c.substr(0,f)}else r=!1;return{path:e,name:s,ext:h,base:c,dir:p,compressed:r,protocol:o,query:a,src:t}}function ne(t){var e=oe(t),r=Gt.get(e.protocol);return r&&!(e=oe(r.getUrl(e.src))).ext&&r.getExt&&(e.ext=r.getExt(t)),e}function ae(t,e){void 0===e&&(e={});var r,i=Object.assign(ne(t),e);return Ht.names.includes(i.ext)?r=new ee(i.src,i):zt.includes(i.ext)&&(r=new ie(i.src,i)),r?r.load():Promise.reject(new Error("autoLoad: ext '"+i.ext+"' unknown"))}var se=function(){};se.prototype.getBlob=function(){return new Blob([this.getData()],{type:this.mimeType})},se.prototype.download=function(t,e){t=st(t,this.defaultName),e=st(e,this.defaultExt),y(this.getBlob(),t+"."+e)};var ce=function(o){function t(t,e){o.call(this),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="pdb";var r,i=Object.assign({},e);this.renumberSerial=st(i.renumberSerial,!0),this.remarks=(r=st(i.remarks,[]),Array.isArray(r)?r:[r]),this.structure=t,this._records=[]}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype._writeRecords=function(){this._records.length=0,this._writeTitle(),this._writeRemarks(),this._writeAtoms()},t.prototype._writeTitle=function(){this._records.push(a.sprintf("TITLE %-74s",this.structure.name))},t.prototype._writeRemarks=function(){var e=this;this.remarks.forEach(function(t){e._records.push(a.sprintf("REMARK %-73s",t))}),this.structure.trajectory&&(this._records.push(a.sprintf("REMARK %-73s","Trajectory '"+this.structure.trajectory.name+"'")),this._records.push(a.sprintf("REMARK %-73s","Frame "+this.structure.trajectory.frame)))},t.prototype._writeAtoms=function(){var o=this,n=1,e=1;this.structure.eachModel(function(t){o._records.push(a.sprintf("MODEL %-74d",e++)),t.eachAtom(function(t){var e=t.hetero?"HETATM%5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s":"ATOM  %5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s",r=o.renumberSerial?n:t.serial,i=t.atomname;1===i.length&&(i=" "+i),o._records.push(a.sprintf(e,r,i,t.resname,st(t.chainname," "),t.resno,t.x,t.y,t.z,st(t.occupancy,1),st(t.bfactor,0),"",st(t.element,""))),n+=1}),o._records.push(a.sprintf("%-80s","ENDMDL")),e+=1}),this._records.push(a.sprintf("%-80s","END"))},t.prototype.getString=function(){return console.warn("PdbWriter.getString() is deprecated, use .getData instead"),this.getData()},t.prototype.getData=function(){return this._writeRecords(),this._records.join("\n")},t}(se),ue=function(e){function t(t){e.call(this),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="sdf",this.structure=t,this._records=[]}e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t;var r={idString:{configurable:!0},titleString:{configurable:!0},countsString:{configurable:!0},chargeLines:{configurable:!0}};return r.idString.get=function(){return this.structure.id},r.titleString.get=function(){return"  "+this.structure.title},r.countsString.get=function(){return a.sprintf("%3i%3i  0  0  0  0  0  0  0  0999 V2000",this.structure.atomCount,this.structure.bondCount)},r.chargeLines.get=function(){var e=[];this.structure.eachAtom(function(t){null!=t.formalCharge&&0!==t.formalCharge&&e.push([t.index,t.formalCharge])});for(var t=[],r=0;r<e.length;r+=8){for(var i=Math.min(8,e.length-r),o=a.sprintf("M  CHG%3i",i),n=r;n<r+i;n++)o+=a.sprintf(" %3i %3i",e[n][0]+1,e[n][1]);t.push(o)}return t},t.prototype.formatAtom=function(t){var e=0;null!=t.formalCharge&&0!==t.formalCharge&&(e=4-t.formalCharge);var r=a.sprintf("%10.4f%10.4f%10.4f %-3s 0%3i  0  0  0",t.x,t.y,t.z,t.element,e);if(48!==r.length)throw new Error("Incompatible atom for sdf format");return r},t.prototype.formatBond=function(t){return a.sprintf("%3i%3i%3i  0  0  0",t.atomIndex1+1,t.atomIndex2+1,t.bondOrder)},t.prototype._writeRecords=function(){this._records.length=0,this._writeHeader(),this._writeCTab(),this._writeFooter()},t.prototype._writeHeader=function(){this._records.push(this.idString,this.titleString,"")},t.prototype._writeCTab=function(){var e=this;this._records.push(this.countsString),this.structure.eachAtom(function(t){e._records.push(e.formatAtom(t))}),this.structure.eachBond(function(t){e._records.push(e.formatBond(t))}),this.chargeLines.forEach(function(t){e._records.push(t)}),this._records.push("M  END")},t.prototype._writeFooter=function(){this._records.push("$$$$")},t.prototype.getData=function(){return this._writeRecords(),this._records.join("\n")},Object.defineProperties(t.prototype,r),t}(se),he=[],le=function(t,e){void 0===e&&(e={}),this._mark=0,this._marks=[],this.offset=0;var r=!(this.littleEndian=!0);void 0===t&&(t=8192),"number"==typeof t?t=new ArrayBuffer(t):r=!0;var i=e.offset?e.offset>>>0:0,o=t.byteLength-i,n=i;t instanceof ArrayBuffer||(t.byteLength!==t.buffer.byteLength&&(n=t.byteOffset+i),t=t.buffer),this._lastWrittenByte=r?o:0,this.buffer=t,this.length=o,this.byteLength=o,this.byteOffset=n,this._data=new DataView(this.buffer,n,o)};le.prototype.available=function(t){return void 0===t&&(t=1),this.offset+t<=this.length},le.prototype.isLittleEndian=function(){return this.littleEndian},le.prototype.setLittleEndian=function(){return this.littleEndian=!0,this},le.prototype.isBigEndian=function(){return!this.littleEndian},le.prototype.setBigEndian=function(){return this.littleEndian=!1,this},le.prototype.skip=function(t){return void 0===t&&(t=1),this.offset+=t,this},le.prototype.seek=function(t){return this.offset=t,this},le.prototype.mark=function(){return this._mark=this.offset,this},le.prototype.reset=function(){return this.offset=this._mark,this},le.prototype.pushMark=function(){return this._marks.push(this.offset),this},le.prototype.popMark=function(){var t=this._marks.pop();if(void 0===t)throw new Error("Mark stack empty");return this.seek(t),this},le.prototype.rewind=function(){return this.offset=0,this},le.prototype.ensureAvailable=function(t){if(void 0===t&&(t=1),!this.available(t)){var e=2*(this.offset+t),r=new Uint8Array(e);r.set(new Uint8Array(this.buffer)),this.buffer=r.buffer,this.length=this.byteLength=e,this._data=new DataView(this.buffer)}return this},le.prototype.readBoolean=function(){return 0!==this.readUint8()},le.prototype.readInt8=function(){return this._data.getInt8(this.offset++)},le.prototype.readUint8=function(){return this._data.getUint8(this.offset++)},le.prototype.readByte=function(){return this.readUint8()},le.prototype.readBytes=function(t){void 0===t&&(t=1);for(var e=new Uint8Array(t),r=0;r<t;r++)e[r]=this.readByte();return e},le.prototype.readInt16=function(){var t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t},le.prototype.readUint16=function(){var t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t},le.prototype.readInt32=function(){var t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t},le.prototype.readUint32=function(){var t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t},le.prototype.readFloat32=function(){var t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t},le.prototype.readFloat64=function(){var t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t},le.prototype.readChar=function(){return String.fromCharCode(this.readInt8())},le.prototype.readChars=function(t){void 0===t&&(t=1),he.length=t;for(var e=0;e<t;e++)he[e]=this.readChar();return he.join("")},le.prototype.writeBoolean=function(t){return void 0===t&&(t=!1),this.writeUint8(t?255:0),this},le.prototype.writeInt8=function(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this},le.prototype.writeUint8=function(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this},le.prototype.writeByte=function(t){return this.writeUint8(t)},le.prototype.writeBytes=function(t){this.ensureAvailable(t.length);for(var e=0;e<t.length;e++)this._data.setUint8(this.offset++,t[e]);return this._updateLastWrittenByte(),this},le.prototype.writeInt16=function(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this},le.prototype.writeUint16=function(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this},le.prototype.writeInt32=function(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},le.prototype.writeUint32=function(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},le.prototype.writeFloat32=function(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},le.prototype.writeFloat64=function(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this},le.prototype.writeChar=function(t){return this.writeUint8(t.charCodeAt(0))},le.prototype.writeChars=function(t){for(var e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));return this},le.prototype.toArray=function(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)},le.prototype._updateLastWrittenByte=function(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)};var pe=function(e){function t(t){e.call(this),this.mimeType="application/vnd.ms-pki.stl",this.defaultName="surface",this.defaultExt="stl",this.surface=t}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.getData=function(){var t=this,e=this.surface.index.length/3,r=new le(2*e+3*e*4*4+80+4);r.skip(80),r.writeUint32(e);for(var i=new fe.Vector3,o=new fe.Vector3,n=new fe.Vector3,a=new fe.Vector3,s=0;s<e;s++){var c=[t.surface.index[3*s],t.surface.index[3*s+1],t.surface.index[3*s+2]];o.fromArray(t.surface.normal,3*c[0]),n.fromArray(t.surface.normal,3*c[1]),a.fromArray(t.surface.normal,3*c[2]),i.addVectors(o,n).add(a).normalize(),r.writeFloat32(i.x),r.writeFloat32(i.y),r.writeFloat32(i.z);for(var u=0;u<3;u++)i.fromArray(t.surface.position,3*c[u]),r.writeFloat32(i.x),r.writeFloat32(i.y),r.writeFloat32(i.z);r.writeUint16(0)}return new DataView(r.buffer)},t}(se),ge=function(){this.count=0,this.signals={countChanged:new u.Signal}};ge.prototype.clear=function(){this.change(-this.count)},ge.prototype.change=function(t){this.count+=t,this.signals.countChanged.dispatch(t,this.count),this.count<0&&me.warn("Counter.count below zero",this.count)},ge.prototype.increment=function(){this.change(1)},ge.prototype.decrement=function(){this.change(-1)},ge.prototype.listen=function(t){this.change(t.count),t.signals.countChanged.add(this.change,this)},ge.prototype.unlisten=function(t){var e=t.signals.countChanged;e.has(this.change,this)&&e.remove(this.change,this)},ge.prototype.onZeroOnce=function(t,e){var r=this;if(0===this.count)t.call(e);else{var i=function(){0===r.count&&(r.signals.countChanged.remove(i,r),t.call(e))};this.signals.countChanged.add(i,this)}},ge.prototype.dispose=function(){this.clear(),this.signals.countChanged.dispose()},Wt.add("shader/BasicLine.vert","void main(){\n#include begin_vertex\n#include project_vertex\n}"),Wt.add("shader/BasicLine.frag","uniform vec3 uColor;\n#include common\n#include fog_pars_fragment\nvoid main(){\ngl_FragColor = vec4( uColor, 1.0 );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}"),Wt.add("shader/Quad.vert","varying vec2 vUv;\nvoid main() {\nvUv = uv;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}"),Wt.add("shader/Quad.frag","varying vec2 vUv;\nuniform sampler2D tForeground;\nuniform float scale;\nvoid main() {\nvec4 foreground = texture2D( tForeground, vUv );\ngl_FragColor = foreground * scale;\n}");var ye=function(){this.signals={updated:new u.Signal},this.maxDuration=-1/0,this.minDuration=1/0,this.avgDuration=14,this.lastDuration=1/0,this.prevFpsTime=0,this.lastFps=1/0,this.lastFrames=1,this.frames=0,this.count=0,this.begin()};ye.prototype.update=function(){this.startTime=this.end(),this.currentTime=this.startTime,this.signals.updated.dispatch()},ye.prototype.begin=function(){this.startTime=window.performance.now(),this.lastFrames=this.frames},ye.prototype.end=function(){var t=window.performance.now();return this.count+=1,this.frames+=1,this.lastDuration=t-this.startTime,this.minDuration=Math.min(this.minDuration,this.lastDuration),this.maxDuration=Math.max(this.maxDuration,this.lastDuration),this.avgDuration-=this.avgDuration/30,this.avgDuration+=this.lastDuration/30,t>this.prevFpsTime+1e3&&(this.lastFps=this.frames,this.prevFpsTime=t,this.frames=0),t},Wt.add("shader/chunk/fog_fragment.glsl","#ifdef USE_FOG\nfloat depth = length( vViewPosition );\n#ifdef FOG_EXP2\nfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif"),Wt.add("shader/chunk/interior_fragment.glsl","if( gl_FrontFacing == false ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}"),Wt.add("shader/chunk/matrix_scale.glsl","float matrixScale( in mat4 m ){\nvec4 r = m[ 0 ];\nreturn sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );\n}"),Wt.add("shader/chunk/nearclip_vertex.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear - 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),Wt.add("shader/chunk/nearclip_fragment.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear )\ndiscard;\n#endif"),Wt.add("shader/chunk/opaque_back_fragment.glsl","#ifdef OPAQUE_BACK\n#ifdef FLIP_SIDED\nif( gl_FrontFacing == true ){\ngl_FragColor.a = 1.0;\n}\n#else\nif( gl_FrontFacing == false ){\ngl_FragColor.a = 1.0;\n}\n#endif\n#endif"),Wt.add("shader/chunk/radiusclip_vertex.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius + 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),Wt.add("shader/chunk/radiusclip_fragment.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius )\ndiscard;\n#endif"),Wt.add("shader/chunk/unpack_color.glsl","vec3 unpackColor(float f) {\nvec3 color;\ncolor.r = floor(f / 256.0 / 256.0);\ncolor.g = floor((f - color.r * 256.0 * 256.0) / 256.0);\ncolor.b = floor(f - color.r * 256.0 * 256.0 - color.g * 256.0);\nreturn color / 255.0;\n}");var ve=/^(?!\/\/)\s*#include\s+(\S+)/gim,be={};function xe(t,e){void 0===e&&(e={});var r=t+"|";for(var i in e)r+=i+":"+e[i];if(!be[r]){var o=function(t){if(void 0===t)return"";var e=[];for(var r in t){var i=t[r];i&&e.push("#define "+r+" "+i)}return e.join("\n")+"\n"}(e),n=Wt.get("shader/"+t);if(!n)throw new Error("empty shader, '"+t+"'");n=n.replace(ve,function(t,e){var r="shader/chunk/"+e+".glsl",i=Wt.get(r)||fe.ShaderChunk[e];if(!i)throw new Error("empty chunk, '"+e+"'");return i}),be[r]=o+n}return be[r]}if("undefined"!=typeof WebGLRenderingContext){var _e=WebGLRenderingContext.prototype,we=_e.getShaderParameter;_e.getShaderParameter=function(){return!de.Debug||we.apply(this,arguments)};var Ae=_e.getShaderInfoLog;_e.getShaderInfoLog=function(){return de.Debug?Ae.apply(this,arguments):""};var Se=_e.getProgramParameter;_e.getProgramParameter=function(t,e){return!de.Debug&&e===_e.LINK_STATUS||Se.apply(this,arguments)};var Ce=_e.getProgramInfoLog;_e.getProgramInfoLog=function(){return de.Debug?Ce.apply(this,arguments):""}}var Pe=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];Pe.forEach(function(t){t.forEach(function(t){t[0]*=.0625,t[1]*=.0625})});var Ie=function(t,e,r,i){this.canvas=document.createElement("canvas"),this._viewer=r,this._factor=st(i.factor,2),this._antialias=st(i.antialias,!1),this._onProgress=i.onProgress,this._onFinish=i.onFinish,this._antialias&&(this._factor*=2),this._n=this._factor*this._factor,this._width=this._viewer.width,this._height=this._viewer.height,this._antialias?(this.canvas.width=this._width*this._factor/2,this.canvas.height=this._height*this._factor/2):(this.canvas.width=this._width*this._factor,this.canvas.height=this._height*this._factor),this._ctx=this.canvas.getContext("2d"),this._viewerSampleLevel=r.sampleLevel,this._viewer.setSampling(-1)};Ie.prototype._renderTile=function(t){var e=this._viewer,r=this._width,i=this._height,o=this._factor,n=t%o*r,a=Math.floor(t/o)*i;if(e.camera.setViewOffset(r*o,i*o,n,a,r,i),e.render(),this._antialias){var s=Math.round((n+r)/2)-Math.round(n/2),c=Math.round((a+i)/2)-Math.round(a/2);this._ctx.drawImage(e.renderer.domElement,Math.round(n/2),Math.round(a/2),s,c)}else this._ctx.drawImage(e.renderer.domElement,Math.floor(n),Math.floor(a),Math.ceil(r),Math.ceil(i));"function"==typeof this._onProgress&&this._onProgress(t+1,this._n,!1)},Ie.prototype._finalize=function(){this._viewer.setSampling(this._viewerSampleLevel),this._viewer.camera.view=null,"function"==typeof this._onFinish&&this._onFinish(this._n+1,this._n,!1)},Ie.prototype.render=function(){for(var t=0;t<=this._n;++t)t===this._n?this._finalize():this._renderTile(t)},Ie.prototype.renderAsync=function(){for(var t=this,e=0,r=this._n,i=function(){e===r?t._finalize():t._renderTile(e),e+=1},o=0;o<=r;++o)setTimeout(i,0)};var Oe=2*Math.PI,ke=(Math.PI,180/Math.PI);function Me(t,e,r,i,o){void 0===r&&(r=1),void 0===i&&(i=0);var n=o?o.length:t.length/r,a=0,s=0;if(o)for(var c=0;c<n;++c){var u=(t[o[c]*r+i]+e)%e/e*Oe-Math.PI;a+=Math.cos(u),s+=Math.sin(u)}else for(var h=i;h<n;h+=r){var l=(t[h]+e)%e/e*Oe-Math.PI;a+=Math.cos(l),s+=Math.sin(l)}return a/=n,s/=n,(Math.atan2(s,a)+Math.PI)/Oe*e}function Be(t,e,r,i){void 0===i&&(i=0);for(var o=t.length,n=r||new Float32Array(o),a=0;a<o;a+=3)n[i+a+0]=(t[a+0]+e[a+0])/2,n[i+a+1]=(t[a+1]+e[a+1])/2,n[i+a+2]=(t[a+2]+e[a+2])/2;return n}function Te(t,e){for(var r=t.length,i=new Float32Array(r),o=0;o<r;o+=3)i[o+0]=e[o+0]-t[o+0],i[o+1]=e[o+1]-t[o+1],i[o+2]=e[o+2]-t[o+2];return i}function De(t,e,r){for(var i=r||new Float32Array(t),o=0;o<t;++o)i[o]=e;return i}function Re(t,e,r,i,o){for(var n=o||new Float32Array(3*t),a=0;a<t;++a){var s=3*a;n[s+0]=e,n[s+1]=r,n[s+2]=i}return n}function Fe(t){for(var e=new Float32Array(t),r=0;r<t;++r)e[r]=r;return e}function Ee(t,e,r,i){void 0===r&&(r=0);for(var o=i||new Float32Array(t*e),n=0;n<t;++n)for(var a=r+n*e,s=0;s<e;++s)o[a+s]=n;return o}function $e(t,e){for(var r=t.length,i=new Float32Array(r*e),o=0;o<r;++o)for(var n=o*e,a=t[o],s=0;s<e;++s)i[n+s]=a;return i}function Le(t,e,r,i,o){for(var n=0;n<o;++n)e[i+n]=t[r+n]}function Ne(t,e,r,i){Le(t,t,e,r,i)}function ze(t){for(var e=-1/0,r=0,i=t.length;r<i;++r)t[r]>e&&(e=t[r]);return e}function je(t){for(var e=1/0,r=0,i=t.length;r<i;++r)t[r]<e&&(e=t[r]);return e}function Ve(t,e,r){void 0===e&&(e=1),void 0===r&&(r=0);for(var i=t.length,o=0,n=r;n<i;n+=e)o+=t[n];return o}function Ge(t,e,r){return void 0===e&&(e=1),void 0===r&&(r=0),Ve(t,e,r)/(t.length/e)}var Ue={trim:!1,factor:1,antialias:!1,transparent:!1,onProgress:void 0};function He(n,i){void 0===i&&(i={});var t=w(i,Ue),r=t.trim,e=t.factor,a=t.antialias,s=t.transparent,c=n.renderer,u=n.camera,h=c.getClearAlpha(),o=c.getClearColor();function l(t){void 0===t&&(t=!1);var r=e;a&&(r*=2),t&&(r=1/r),n.scene.traverse(function(t){var e=t.material;e&&e.linewidth&&(e.linewidth*=r),e&&e.uniforms&&e.uniforms.size&&void 0===e.uniforms.size.__seen&&(e.uniforms.size.value*=r,e.uniforms.size.__seen=!0),e&&e.uniforms&&e.uniforms.linewidth&&void 0===e.uniforms.linewidth.__seen&&(e.uniforms.linewidth.value*=r,e.uniforms.linewidth.__seen=!0)}),n.scene.traverse(function(t){var e=t.material;e&&e.uniforms&&e.uniforms.size&&delete e.uniforms.size.__seen,e&&e.uniforms&&e.uniforms.linewidth&&delete e.uniforms.linewidth.__seen})}function p(t){if(r){var e=o;return function(t,e,r,i,o){var n,a,s,c,u=t.height,h=t.width,l=t.getContext("2d").getImageData(0,0,h,u).data;for(s=!1,a=0;a<u;a++){for(n=0;n<h;n++)if(l[c=4*(a*h+n)]!==e||l[c+1]!==r||l[c+2]!==i||l[c+3]!==o){s=!0;break}if(s)break}var p=a;for(s=!1,n=0;n<h;n++){for(a=0;a<u;a++)if(l[c=4*(a*h+n)]!==e||l[c+1]!==r||l[c+2]!==i||l[c+3]!==o){s=!0;break}if(s)break}var d=n;for(s=!1,a=u-1;0<=a;a--){for(n=h-1;0<=n;n--)if(l[c=4*(a*h+n)]!==e||l[c+1]!==r||l[c+2]!==i||l[c+3]!==o){s=!0;break}if(s)break}var f=a;for(s=!1,n=h-1;0<=n;n--){for(a=u-1;0<=a;a--)if(l[c=4*(a*h+n)]!==e||l[c+1]!==r||l[c+2]!==i||l[c+3]!==o){s=!0;break}if(s)break}var m=n,g=document.createElement("canvas");return g.width=m-d,g.height=f-p,g.getContext("2d").drawImage(t,d,p,g.width,g.height,0,0,g.width,g.height),g}(t,s?0:255*e.r,s?0:255*e.g,s?0:255*e.b,s?0:255)}return t}function d(t,e,r){"function"==typeof i.onProgress&&i.onProgress(t,e,r)}return new Promise(function(r,i){var o=new Ie(c,u,n,{factor:e,antialias:a,onProgress:d,onFinish:function(t,e){p(o.canvas).toBlob(function(t){c.setClearAlpha(h),l(!0),n.requestRender(),d(e,e,!0),t?r(t):i("error creating image")},"image/png")}});c.setClearAlpha(s?0:1),l(),o.renderAsync()})}var We=new fe.Vector3,qe=new fe.Matrix4,Xe=new fe.Matrix4;var Ye=new fe.Vector2,Ke=new fe.Matrix4,Ze=new fe.Matrix4;function Qe(t,e){Ke.getInverse(e.projectionMatrix),Ze.copy(e.projectionMatrix).transpose(),t.traverse(function(t){var e=t.material;if(e){var r=e.uniforms;r&&(r.projectionMatrixInverse&&r.projectionMatrixInverse.value.copy(Ke),r.projectionMatrixTranspose&&r.projectionMatrixTranspose.value.copy(Ze))}})}function Je(t,e,r){var i=t.createShader(r);if(i)return t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.log("error compiling shader "+i+": "+t.getShaderInfoLog(i)),t.deleteShader(i),null);console.log("error creating WebGL shader "+r)}function tr(t,e){var r=t.getExtension(e);return r||console.log("extension '"+e+"' not available"),r}var er=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function rr(t){var e=document.createElement("canvas");e.width=16,e.height=16,e.style.width="16px",e.style.height="16px";var r=e.getContext("webgl")||e.getContext("experimental-webgl");if(!r)return console.log("error creating webgl context for "+t),!1;if(!(r instanceof WebGLRenderingContext))return console.log("Got unexpected type for WebGL rendering context"),!1;tr(r,"OES_texture_float"),tr(r,"OES_texture_half_float"),tr(r,"WEBGL_color_buffer_float");var i=Je(r,"\nattribute vec4 a_position;\n\nvoid main() {\n  gl_Position = a_position;\n}",r.VERTEX_SHADER),o=Je(r,"\nprecision mediump float;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;\n}",r.FRAGMENT_SHADER);if(!i||!o)return!1;var n=function(r,t,e,i){var o=r.createProgram();if(o)return t.forEach(function(t){return r.attachShader(o,t)}),e&&e.forEach(function(t,e){r.bindAttribLocation(o,i?i[e]:e,t)}),r.linkProgram(o),r.getProgramParameter(o,r.LINK_STATUS)?o:(console.log("error linking program: "+r.getProgramInfoLog(o)),r.deleteProgram(o),null);console.log("error creating WebGL program")}(r,[i,o]);if(!n)return console.log("error creating WebGL program"),!1;r.useProgram(n);var a=r.getAttribLocation(n,"a_position"),s=r.getUniformLocation(n,"u_color");if(!s)return console.log("error getting 'u_color' uniform location"),!1;var c=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,c),r.bufferData(r.ARRAY_BUFFER,er,r.STATIC_DRAW),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0);var u=r.createTexture(),h=new Uint8Array([255,255,255,255]);r.bindTexture(r.TEXTURE_2D,u),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,h);var l=r.createTexture();r.bindTexture(r.TEXTURE_2D,l),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,t,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST);var p=r.createFramebuffer();if(r.bindFramebuffer(r.FRAMEBUFFER,p),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,l,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)return console.log("error creating framebuffer for "+t),!1;r.bindTexture(r.TEXTURE_2D,u),r.uniform4fv(s,[0,10,20,1]),r.drawArrays(r.TRIANGLES,0,6),r.bindTexture(r.TEXTURE_2D,l),r.bindFramebuffer(r.FRAMEBUFFER,null),r.clearColor(1,0,0,1),r.clear(r.COLOR_BUFFER_BIT),r.uniform4fv(s,[0,.1,.05,1]),r.drawArrays(r.TRIANGLES,0,6);var d=new Uint8Array(4);if(r.readPixels(0,0,1,1,r.RGBA,r.UNSIGNED_BYTE,d),0!==d[0]||d[1]<248||d[2]<248||d[3]<254)return console.log("not able to actually render to "+t+" texture"),!1;if(t===r.FLOAT){r.bindFramebuffer(r.FRAMEBUFFER,p);var f=new Float32Array(4);r.readPixels(0,0,1,1,r.RGBA,r.FLOAT,f);var m=r.getError();if(m)return console.log("error reading pixels as float: '"+function(t,e){switch(e){case t.NO_ERROR:return"no error";case t.INVALID_ENUM:return"invalid enum";case t.INVALID_VALUE:return"invalid value";case t.INVALID_OPERATION:return"invalid operation";case t.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case t.OUT_OF_MEMORY:return"out of memory";case t.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"}(r,m)+"'"),!1}return!0}var ir=new Float32Array(100),or=new Uint8Array(100),nr=[12,7,13,17,11,6,8,18,16,2,14,22,10,1,3,9,19,23,21,15,5,0,4,24,20],ar=new fe.Matrix4,sr=new fe.Vector2;function cr(t,e,r,i,o){var n=o.uniforms,a=[];if(n.objectId&&(n.objectId.value=Et?this.id:this.id/255,a.push("objectId")),(n.modelViewMatrixInverse||n.modelViewMatrixInverseTranspose||n.modelViewProjectionMatrix||n.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),n.modelViewMatrixInverse&&(n.modelViewMatrixInverse.value.getInverse(this.modelViewMatrix),a.push("modelViewMatrixInverse")),n.modelViewMatrixInverseTranspose&&(n.modelViewMatrixInverse?n.modelViewMatrixInverseTranspose.value.copy(n.modelViewMatrixInverse.value).transpose():n.modelViewMatrixInverseTranspose.value.getInverse(this.modelViewMatrix).transpose(),a.push("modelViewMatrixInverseTranspose")),n.modelViewProjectionMatrix&&(n.modelViewProjectionMatrix.value.multiplyMatrices(r.projectionMatrix,this.modelViewMatrix),a.push("modelViewProjectionMatrix")),n.modelViewProjectionMatrixInverse&&(n.modelViewProjectionMatrix?ar.copy(n.modelViewProjectionMatrix.value):ar.multiplyMatrices(r.projectionMatrix,this.modelViewMatrix),n.modelViewProjectionMatrixInverse.value.getInverse(ar),a.push("modelViewProjectionMatrixInverse")),a.length){var s=t.properties.get(o);if(s.program){var c=t.getContext(),u=s.program;c.useProgram(u.program);var h=u.getUniforms();a.forEach(function(t){h.setValue(c,t,n[t].value)})}}}var ur=function(t){if(this.boundingBox=new fe.Box3,this.boundingBoxSize=new fe.Vector3,this.boundingBoxLength=0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}},this.distVector=new fe.Vector3,this.signals={ticked:new u.Signal,rendered:new u.Signal},"string"==typeof t){var e=document.getElementById(t);this.container=null===e?document.createElement("div"):e}else t instanceof HTMLElement?this.container=t:this.container=document.createElement("div");if(this.container===document.body)this.width=window.innerWidth||1,this.height=window.innerHeight||1;else{var r=this.container.getBoundingClientRect();this.width=r.width||1,this.height=r.height||1,this.container.style.overflow="hidden"}this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.container.appendChild(this.wrapper),this._initParams(),this._initStats(),this._initCamera(),this._initScene(),!1!==this._initRenderer()?(this._initHelper(),this.setBackground(),this.setFog(),this.animate=this.animate.bind(this)):me.error("Viewer: could not initialize renderer")},hr={cameraDistance:{configurable:!0}};ur.prototype._initParams=function(){this.parameters={fogColor:new fe.Color(0),fogNear:50,fogFar:100,backgroundColor:new fe.Color(0),cameraType:"perspective",cameraFov:40,cameraEyeSep:.3,cameraZ:-80,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",lightColor:new fe.Color(14540253),lightIntensity:1,ambientColor:new fe.Color(14540253),ambientIntensity:.2,sampleLevel:0}},ur.prototype._initCamera=function(){var t=this.width,e=this.height;this.cameraRoll=0,this.cameraLookAt=new fe.Vector3,this.cameraBase=new fe.Object3D,this.cameraBase.name="cameraRigBase",this.cameraBase.translateZ(this.parameters.cameraZ),this.cameraStand=new fe.Object3D,this.cameraStand.name="cameraRigStand",this.cameraStand.parent=this.cameraBase,this.cameraStand.position.y=0,this.cameraBoom=new fe.Object3D,this.cameraBoom.name="cameraRigBoom",this.cameraBoom.parent=this.cameraStand,this.perspectiveCamera=new fe.PerspectiveCamera(this.parameters.cameraFov,t/e),this.perspectiveCamera.parent=this.cameraBoom,this.perspectiveCamera.lookAt(this.cameraLookAt),this.orthographicCamera=new fe.OrthographicCamera(t/-2,t/2,e/2,e/-2),this.orthographicCamera.position.z=this.parameters.cameraZ,this.orthographicCamera.lookAt(this.cameraLookAt),this.stereoCamera=new fe.StereoCamera,this.stereoCamera.aspect=.5,this.stereoCamera.eyeSep=this.parameters.cameraEyeSep;var r=this.parameters.cameraType;if("orthographic"===r)this.camera=this.orthographicCamera;else{if("perspective"!==r&&"stereo"!==r)throw new Error("Unknown cameraType '"+r+"'");this.camera=this.perspectiveCamera}this.camera.updateProjectionMatrix(),console.log("initCamera: "+this.cameraRigToStr())},ur.prototype._initStats=function(){this.stats=new ye},ur.prototype._initScene=function(){this.scene||(this.scene=new fe.Scene,this.scene.name="scene"),this.rotationGroup=new fe.Group,this.rotationGroup.name="rotationGroup",this.scene.add(this.rotationGroup),this.translationGroup=new fe.Group,this.translationGroup.name="translationGroup",this.rotationGroup.add(this.translationGroup),this.modelGroup=new fe.Group,this.modelGroup.name="modelGroup",this.translationGroup.add(this.modelGroup),this.pickingGroup=new fe.Group,this.pickingGroup.name="pickingGroup",this.translationGroup.add(this.pickingGroup),this.backgroundGroup=new fe.Group,this.backgroundGroup.name="backgroundGroup",this.translationGroup.add(this.backgroundGroup),this.helperGroup=new fe.Group,this.helperGroup.name="helperGroup",this.translationGroup.add(this.helperGroup),this.scene.fog=new fe.Fog(this.parameters.fogColor.getHex()),this.spotLight=new fe.SpotLight(this.parameters.lightColor.getHex(),this.parameters.lightIntensity),this.scene.add(this.spotLight),this.ambientLight=new fe.AmbientLight(this.parameters.ambientColor.getHex(),this.parameters.ambientIntensity),this.scene.add(this.ambientLight)},ur.prototype._initRenderer=function(){var t=window.devicePixelRatio,e=this.width,r=this.height;try{this.renderer=new fe.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0,antialias:!0})}catch(t){return!(this.wrapper.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;"><p style="padding:15px;text-align:center;">Your browser/graphics card does not seem to support <a target="_blank" href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>.<br/><br/>Find out how to get it <a target="_blank" href="http://get.webgl.org/">here</a>.</p></div>')}this.renderer.setPixelRatio(t),this.renderer.setSize(e,r),this.renderer.autoClear=!1,this.renderer.sortObjects=!0;var i,o,n=this.renderer.getContext();i=this.renderer.extensions.get("EXT_frag_depth"),$t=i,this.renderer.extensions.get("OES_element_index_uint"),o=this.renderer.extensions.get("OES_texture_float")&&this.renderer.extensions.get("WEBGL_color_buffer_float")||this.renderer.extensions.get("OES_texture_float")&&rr(n.FLOAT),Et=o,this.wrapper.appendChild(this.renderer.domElement);var a=e*t,s=r*t;this.renderer.extensions.get("OES_texture_float"),this.supportsHalfFloat=this.renderer.extensions.get("OES_texture_half_float")&&rr(36193),this.renderer.extensions.get("WEBGL_color_buffer_float"),de.Debug&&console.log(JSON.stringify({Browser:Tt,OES_texture_float:!!this.renderer.extensions.get("OES_texture_float"),OES_texture_half_float:!!this.renderer.extensions.get("OES_texture_half_float"),WEBGL_color_buffer_float:!!this.renderer.extensions.get("WEBGL_color_buffer_float"),"testTextureSupport Float":rr(n.FLOAT),"testTextureSupport HalfFloat":rr(36193),"this.supportsHalfFloat":this.supportsHalfFloat,SupportsReadPixelsFloat:Et},null,2)),this.pickingTarget=new fe.WebGLRenderTarget(a,s,{minFilter:fe.NearestFilter,magFilter:fe.NearestFilter,stencilBuffer:!1,format:fe.RGBAFormat,type:Et?fe.FloatType:fe.UnsignedByteType}),this.pickingTarget.texture.generateMipmaps=!1,this.renderer.setRenderTarget(this.pickingTarget),this.renderer.clear(),this.renderer.setRenderTarget(null),this.sampleTarget=new fe.WebGLRenderTarget(a,s,{minFilter:fe.LinearFilter,magFilter:fe.LinearFilter,format:fe.RGBAFormat}),this.holdTarget=new fe.WebGLRenderTarget(a,s,{minFilter:fe.NearestFilter,magFilter:fe.NearestFilter,format:fe.RGBAFormat,type:fe.UnsignedByteType}),this.compositeUniforms={tForeground:new fe.Uniform(this.sampleTarget.texture),scale:new fe.Uniform(1)},this.compositeMaterial=new fe.ShaderMaterial({uniforms:this.compositeUniforms,vertexShader:xe("Quad.vert"),fragmentShader:xe("Quad.frag"),premultipliedAlpha:!0,transparent:!0,blending:fe.AdditiveBlending,depthTest:!1,depthWrite:!1}),this.compositeCamera=new fe.OrthographicCamera(-1,1,1,-1,0,1),this.compositeScene=new fe.Scene,this.compositeScene.name="compositeScene",this.compositeScene.add(new fe.Mesh(new fe.PlaneGeometry(2,2),this.compositeMaterial))},ur.prototype._initHelper=function(){var t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),e=new Float32Array(24),r=new fe.BufferGeometry;r.setIndex(new fe.BufferAttribute(t,1)),r.setAttribute("position",new fe.BufferAttribute(e,3));var i=new fe.ShaderMaterial({uniforms:{uColor:{value:new fe.Color("skyblue")}},vertexShader:xe("BasicLine.vert"),fragmentShader:xe("BasicLine.frag")});this.boundingBoxMesh=new fe.LineSegments(r,i),this.helperGroup.add(this.boundingBoxMesh)},ur.prototype.updateHelper=function(){var t=this.boundingBoxMesh.geometry.attributes.position,e=t.array,r=this.boundingBox,i=r.min,o=r.max;e[0]=o.x,e[1]=o.y,e[2]=o.z,e[3]=i.x,e[4]=o.y,e[5]=o.z,e[6]=i.x,e[7]=i.y,e[8]=o.z,e[9]=o.x,e[10]=i.y,e[11]=o.z,e[12]=o.x,e[13]=o.y,e[14]=i.z,e[15]=i.x,e[16]=o.y,e[17]=i.z,e[18]=i.x,e[19]=i.y,e[20]=i.z,e[21]=o.x,e[22]=i.y,e[23]=i.z,t.needsUpdate=!0,this.boundingBox.isEmpty()||this.boundingBoxMesh.geometry.computeBoundingSphere()},ur.prototype.getCameraRig=function(){return sr.set(this.cameraBase.position.x,this.cameraBase.position.z),{baseX:this.cameraBase.position.x,baseZ:this.cameraBase.position.z,baseR:sr.length(),baseTheta:sr.angle(),standHeight:this.cameraStand.position.y,boomLength:this.cameraBoom.position.y,boomRotation:this.cameraBoom.rotation.y,boomElevation:this.cameraBoom.rotation.z,cameraRoll:this.cameraRoll,lookAt:this.cameraLookAt}},ur.prototype.cameraRigToStr=function(){return sr.set(this.cameraBase.position.x,this.cameraBase.position.z),"base x,z: "+sr.x.toFixed(2)+", "+sr.y.toFixed(2)+", r,: "+sr.length().toFixed(2)+", "+j(sr.angle()).toFixed(1)+"; stand ht: "+this.cameraStand.position.y.toFixed(2)+"; boom len: "+this.cameraBoom.position.y.toFixed(2)+", :"+j(this.cameraBoom.rotation.y).toFixed(1)+", :"+j(this.cameraBoom.rotation.z).toFixed(1)+"; roll: "+j(this.cameraRoll).toFixed(1)+"; lookAt: "+this.cameraLookAt.toArray().map(function(t){return t.toFixed(2)})},ur.prototype.updateCameraRig=function(t){var e="";if(null==t.baseR&&null==t.baseTheta||(e="rtheta"),(null!=t.baseX||null!=t.baseZ)&&e)throw new Error("updateCameraRig: for base, pass r/theta _or_ x/y, not both.");if("rtheta"==e){if(void 0===t.baseR||void 0===t.baseTheta){var r=this.cameraBasePolar();void 0===t.baseR&&(t.baseR=r[0]),void 0===t.baseTheta&&(t.baseTheta=r[1])}var i=t.baseR*Math.cos(t.baseTheta),o=t.baseR*Math.sin(t.baseTheta);this.cameraBase.position.set(i,0,o)}void 0!==t.baseX&&(this.cameraBase.position.x=t.baseX),void 0!==t.baseZ&&(this.cameraBase.position.z=t.baseZ),void 0!==t.standHeight&&this.cameraStand.position.set(0,t.standHeight,0),void 0!==t.boomLength&&this.cameraBoom.position.set(0,t.boomLength,0),void 0===t.boomRotation&&void 0===t.boomElevation||(void 0===t.boomRotation&&(t.boomRotation=this.cameraBoom.rotation.y),void 0===t.boomElevation&&(t.boomElevation=this.cameraBoom.rotation.z),this.cameraBoom.rotation.set(0,t.boomRotation,t.boomElevation)),t.cameraRoll&&(this.cameraRoll=t.cameraRoll),t.cameraLookAt&&(this.cameraLookAt=t.cameraLookAt),t.deferUpdate||this.setLookAt()},ur.prototype.setLookAt=function(t){t instanceof fe.Vector3?this.cameraLookAt.copy(t):void 0!==t&&this.cameraLookAt.fromArray(t),this.camera.lookAt(this.cameraLookAt),this.camera.rotateZ(this.cameraRoll)},ur.prototype.cameraBasePolar=function(){return sr.set(this.cameraBase.position.x,this.cameraBase.position.z),[sr.length(),sr.angle()]},hr.cameraDistance.get=function(){return sr.set(this.cameraBase.position.x,this.cameraBase.position.z),sr.length()},hr.cameraDistance.set=function(t){this.updateCameraRig({baseR:t})},ur.prototype.add=function(e,t){var r=this;t?t.forEach(function(t){return r.addBuffer(e,t)}):this.addBuffer(e),e.parameters.background?(this.backgroundGroup.add(e.group),this.backgroundGroup.add(e.wireframeGroup)):(this.modelGroup.add(e.group),this.modelGroup.add(e.wireframeGroup)),e.pickable&&this.pickingGroup.add(e.pickingGroup),de.Debug&&this.updateHelper()},ur.prototype.addBuffer=function(e,r){function i(t){t instanceof fe.Group?t.children.forEach(i):(t.userData.buffer=e,t.userData.instance=r,t.onBeforeRender=cr)}var t=e.getMesh();r&&t.applyMatrix(r.matrix),i(t),e.group.add(t);var o=e.getWireframeMesh();if(r&&(o.matrix.copy(t.matrix),o.position.copy(t.position),o.quaternion.copy(t.quaternion),o.scale.copy(t.scale)),i(o),e.wireframeGroup.add(o),e.pickable){var n=e.getPickingMesh();r&&(n.matrix.copy(t.matrix),n.position.copy(t.position),n.quaternion.copy(t.quaternion),n.scale.copy(t.scale)),i(n),e.pickingGroup.add(n)}r?this._updateBoundingBox(e.geometry,e.matrix,r.matrix):this._updateBoundingBox(e.geometry,e.matrix)},ur.prototype.remove=function(e){this.translationGroup.children.forEach(function(t){t.remove(e.group),t.remove(e.wireframeGroup)}),e.pickable&&this.pickingGroup.remove(e.pickingGroup),this.updateBoundingBox(),de.Debug&&this.updateHelper()},ur.prototype._updateBoundingBox=function(t,e,r){var o=this.boundingBox;function i(t,e,r){t.boundingBox||t.computeBoundingBox();var i=t.boundingBox.clone();e&&i.applyMatrix4(e),r&&i.applyMatrix4(r),i.min.equals(i.max)&&i.expandByScalar(5),o.union(i)}function n(t){var e,r;void 0!==t.geometry&&(t.userData.buffer&&(e=t.userData.buffer.matrix),t.userData.instance&&(r=t.userData.instance.matrix),i(t.geometry,e,r))}t?i(t,e,r):(o.makeEmpty(),this.modelGroup.traverse(n),this.backgroundGroup.traverse(n)),o.getSize(this.boundingBoxSize),this.boundingBoxLength=this.boundingBoxSize.length()},ur.prototype.updateBoundingBox=function(){this._updateBoundingBox(),de.Debug&&this.updateHelper()},ur.prototype.getPickingPixels=function(){var t=this.width,e=this.height,r=t*e*4,i=Et?new Float32Array(r):new Uint8Array(r);return this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,0,0,t,e,i),i},ur.prototype.getImage=function(l){var p=this;return new Promise(function(t){if(l){var e=p,r=e.width,i=e.height,o=r*i*4,n=p.getPickingPixels();if(Et){for(var a=new Uint8Array(o),s=0;s<o;++s)a[s]=Math.round(255*n[s]);n=a}var c=document.createElement("canvas");c.width=r,c.height=i;var u=c.getContext("2d"),h=u.getImageData(0,0,r,i);h.data.set(n),u.putImageData(h,0,0),c.toBlob(t,"image/png")}else p.renderer.domElement.toBlob(t,"image/png")})},ur.prototype.makeImage=function(t){return void 0===t&&(t={}),He(this,t)},ur.prototype.setLight=function(t,e,r,i){var o=this.parameters;void 0!==t&&o.lightColor.set(t),void 0!==e&&(o.lightIntensity=e),void 0!==r&&o.ambientColor.set(r),void 0!==i&&(o.ambientIntensity=i),this.requestRender()},ur.prototype.setFog=function(t,e,r){var i=this.parameters;void 0!==t&&i.fogColor.set(t),void 0!==e&&(i.fogNear=e),void 0!==r&&(i.fogFar=r),this.requestRender()},ur.prototype.setBackground=function(t){var e=this.parameters;t&&e.backgroundColor.set(t),this.setFog(e.backgroundColor),this.renderer.setClearColor(e.backgroundColor,0),this.renderer.domElement.style.backgroundColor=e.backgroundColor.getStyle(),this.requestRender()},ur.prototype.setSampling=function(t){void 0!==t&&(this.parameters.sampleLevel=t,this.sampleLevel=t),this.requestRender()},ur.prototype.setCamera=function(t,e,r){var i=this.parameters;if(t&&(i.cameraType=t),e&&(i.cameraFov=e),r&&(i.cameraEyeSep=r),"orthographic"===i.cameraType)this.camera!==this.orthographicCamera&&(this.camera=this.orthographicCamera,this.camera.position.copy(this.perspectiveCamera.position),this.camera.up.copy(this.perspectiveCamera.up),this.updateZoom());else{if("perspective"!==i.cameraType&&"stereo"!==i.cameraType)throw new Error("Unknown cameraType '"+i.cameraType+"'");this.camera!==this.perspectiveCamera&&(this.camera=this.perspectiveCamera,this.camera.position.copy(this.orthographicCamera.position),this.camera.up.copy(this.orthographicCamera.up))}this.perspectiveCamera.fov=i.cameraFov,this.stereoCamera.eyeSep=i.cameraEyeSep,this.camera.updateProjectionMatrix(),this.requestRender()},ur.prototype.setClip=function(t,e,r,i,o){var n=this.parameters;void 0!==t&&(n.clipNear=t),void 0!==e&&(n.clipFar=e),void 0!==r&&(n.clipDist=r),void 0!==i&&(n.clipMode=i),void 0!==o&&(n.clipScale=o),this.requestRender()},ur.prototype.setSize=function(t,e){this.width=t||1,this.height=e||1,this.perspectiveCamera.aspect=this.width/this.height,this.orthographicCamera.left=-this.width/2,this.orthographicCamera.right=this.width/2,this.orthographicCamera.top=this.height/2,this.orthographicCamera.bottom=-this.height/2,this.camera.updateProjectionMatrix();var r=window.devicePixelRatio;this.renderer.setPixelRatio(r),this.renderer.setSize(t,e);var i=this.width*r,o=this.height*r;this.pickingTarget.setSize(i,o),this.sampleTarget.setSize(i,o),this.holdTarget.setSize(i,o),this.requestRender()},ur.prototype.handleResize=function(){if(this.container===document.body)this.setSize(window.innerWidth,window.innerHeight);else{var t=this.container.getBoundingClientRect();this.setSize(t.width,t.height)}},ur.prototype.updateInfo=function(t){var e=this.info,r=e.memory,i=e.render;if(t)r.programs=0,r.geometries=0,r.textures=0,i.calls=0,i.vertices=0,i.points=0;else{var o=this.renderer.info,n=o.memory,a=o.render;r.geometries=n.geometries,r.textures=n.textures,i.calls+=a.calls,i.faces+=a.triangles,i.points+=a.points}},ur.prototype.animate=function(){if(this.signals.ticked.dispatch(this.stats),500<window.performance.now()-this.stats.startTime&&!this.isStill&&this.sampleLevel<3&&-1!==this.sampleLevel){var t=this.sampleLevel;this.sampleLevel=3,this.renderPending=!0,this.render(),this.isStill=!0,this.sampleLevel=t,de.Debug&&me.log("rendered still frame")}window.requestAnimationFrame(this.animate)},ur.prototype.pick=function(t,e){if("stereo"===this.parameters.cameraType)return{pid:0,instance:void 0,picker:void 0};t*=window.devicePixelRatio,e*=window.devicePixelRatio,t=Math.max(t-2,0),e=Math.max(e-2,0);var r,i,o=0,n=Et?ir:or;this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,t,e,5,5,n);for(var a=0;a<nr.length;a++){var s=4*nr[a],c=Math.round(n[s+3]),u=this.pickingGroup.getObjectById(c);u&&(r=u.userData.instance,i=u.userData.buffer.picking,o=Et?Math.round(255*n[s])<<16&16711680|Math.round(255*n[s+1])<<8&65280|255&Math.round(255*n[s+2]):n[s]<<16|n[s+1]<<8|n[s+2])}return{pid:o,instance:r,picker:i}},ur.prototype.requestRender=function(){var t=this;this.renderPending||(22<window.performance.now()-this.stats.startTime&&(this.stats.begin(),this.isStill=!1),this.renderPending=!0,window.requestAnimationFrame(function(){t.render(),t.stats.update()}))},ur.prototype.updateZoom=function(){var t=et(this.perspectiveCamera.fov),e=2*Math.tan(t/2)*-this.cameraDistance;this.orthographicCamera.zoom=this.height/e},ur.prototype.absoluteToRelative=function(t){return 50*(1-t/this.bRadius)},ur.prototype.relativeToAbsolute=function(t){return this.bRadius*(1-t/50)},ur.prototype.__updateClipping=function(){var t=this.parameters;this.bRadius=Math.max(10,.5*this.boundingBoxLength),isFinite(this.bRadius)||(this.bRadius=50),this.camera.getWorldPosition(this.distVector),this.cDist=this.distVector.length(),this.cDist||(this.cameraDistance=Math.abs(t.cameraZ),this.cDist=Math.abs(t.cameraZ));var e=this.scene.fog;if(e.color.set(t.fogColor),"camera"===t.clipMode)this.camera.near=t.clipNear,this.camera.far=t.clipFar,e.near=t.fogNear,e.far=t.fogFar;else if("absolute"===t.clipScale)this.camera.near=this.cDist-t.clipNear,this.camera.far=this.cDist+t.clipFar,e.near=this.cDist-t.fogNear,e.far=this.cDist+t.fogFar;else{var r=(50-t.clipNear)/50,i=-(50-t.clipFar)/50;this.camera.near=this.cDist-this.bRadius*r,this.camera.far=this.cDist+this.bRadius*i;var o=(50-t.fogNear)/50,n=-(50-t.fogFar)/50;e.near=this.cDist-this.bRadius*o,e.far=this.cDist+this.bRadius*n}"camera"!==t.clipMode&&("PerspectiveCamera"===this.camera.type?(this.camera.near=Math.max(.1,t.clipDist,this.camera.near),this.camera.far=Math.max(1,this.camera.far),e.near=Math.max(.1,e.near),e.far=Math.max(1,e.far)):"OrthographicCamera"===this.camera.type&&0<t.clipDist&&(this.camera.near=Math.max(t.clipDist,this.camera.near)))},ur.prototype.__updateCamera=function(){var t,y,e=this.camera;e.updateMatrix(),e.updateMatrixWorld(!0),e.updateProjectionMatrix(),function(t,e,r,n,a){var i=new fe.Vector2;r.getSize(i);var s=i.height,c=r.getPixelRatio(),u="OrthographicCamera"===e.type;Ye.set(i.width,i.height),Ke.getInverse(e.projectionMatrix),Ze.copy(e.projectionMatrix).transpose(),t.traverse(function(t){var e=t.material;if(e){var r=e.uniforms;if(r){if(e.clipNear){var i=(50-e.clipNear)/50,o=n-a*i;r.clipNear.value=o}r.canvasHeight&&(r.canvasHeight.value=s),r.resolution&&r.resolution.value.copy(Ye),r.pixelRatio&&(r.pixelRatio.value=c),r.projectionMatrixInverse&&r.projectionMatrixInverse.value.copy(Ke),r.projectionMatrixTranspose&&r.projectionMatrixTranspose.value.copy(Ze),r.ortho&&(r.ortho.value=u)}}})}(this.scene,e,this.renderer,this.cDist,this.bRadius),t=this.scene,y=e,t.traverseVisible(function(t){if(t instanceof fe.Points&&t.userData.buffer.parameters.sortParticles){var e=t.geometry.attributes,r=e.position.count;if(0!==r){var i,o,n,a,s,c,u;qe.multiplyMatrices(y.matrixWorldInverse,t.matrixWorld),Xe.multiplyMatrices(y.projectionMatrix,qe),t.userData.sortData?(i=t.userData.sortData,n=i.__zArray,o=i.__sortArray,a=i.__cmpFn):(n=new Float32Array(r),o=new Uint32Array(r),i={__zArray:n,__sortArray:o,__cmpFn:a=function(t,e){var r=n[t],i=n[e];return i<r?1:r<i?-1:0}},t.userData.sortData=i);for(var h=0;h<r;++h)We.fromArray(e.position.array,3*h),We.applyMatrix4(Xe),n[h]=-We.z,o[h]=h;for(var l in function(i,t,e,r){void 0===e&&(e=0),t=t||function(t,e){return e<t?1:t<e?-1:0};var o,n,a,s=[],c=-1,u=e,h=r=(r||i.length)-1;function l(t,e){var r=i[t];i[t]=i[e],i[e]=r}for(;;)if(h-u<=25){for(var p=u+1;p<=h;++p){for(o=i[p],n=p-1;u<=n&&0<t(i[n],o);)i[n+1]=i[n],--n;i[n+1]=o}if(-1===c)break;h=s[c--],u=s[c--]}else{for(l(u+(a=h)>>1,n=u+1),0<t(i[u],i[h])&&l(u,h),0<t(i[n],i[h])&&l(n,h),0<t(i[u],i[n])&&l(u,n),o=i[n];;){for(;t(i[++n],o)<0;);for(;0<t(i[--a],o););if(a<n)break;l(n,a)}i[u+1]=i[a],i[a]=o,a-u<=h-n+1?(s[++c]=n,s[++c]=h,h=a-1):(s[++c]=u,s[++c]=a-1,u=n)}}(o,a),e){var p=e[l],d=p.array,f=p.itemSize;i[l]||(i[l]=new Float32Array(f*r)),u=i[l],i[l]=d;for(var m=0;m<r;++m){s=o[m];for(var g=0;g<f;++g)c=s*f+g,u[m*f+g]=d[c]}e[l].array=u,e[l].needsUpdate=!0}}}})},ur.prototype.__setVisibility=function(t,e,r,i){this.modelGroup.visible=t,this.pickingGroup.visible=e,this.backgroundGroup.visible=r,this.helperGroup.visible=i},ur.prototype.__updateLights=function(){this.spotLight.color.set(this.parameters.lightColor),this.spotLight.intensity=this.parameters.lightIntensity,this.distVector.copy(this.camera.position).setLength(100*this.boundingBoxLength),this.spotLight.position.copy(this.camera.position).add(this.distVector),this.ambientLight.color.set(this.parameters.ambientColor),this.ambientLight.intensity=this.parameters.ambientIntensity},ur.prototype.__renderPickingGroup=function(t){this.renderer.setRenderTarget(this.pickingTarget||null),this.renderer.clear(),this.__setVisibility(!1,!0,!1,!1),this.renderer.render(this.scene,t),this.renderer.setRenderTarget(null),this.updateInfo(),this.renderer.setRenderTarget(null)},ur.prototype.__renderModelGroup=function(t,e){this.renderer.setRenderTarget(e||null),this.renderer.clear(),this.__setVisibility(!1,!1,!0,!1),this.renderer.render(this.scene,t),this.renderer.clear(!1,!0,!0),this.updateInfo(),this.__setVisibility(!0,!1,!1,de.Debug),this.renderer.render(this.scene,t),this.renderer.setRenderTarget(null),this.updateInfo()},ur.prototype.__renderSuperSample=function(t){var e=this,r=Pe[Math.max(0,Math.min(this.sampleLevel,5))],i=1/r.length;this.compositeUniforms.tForeground.value=this.sampleTarget.texture;var o=this.sampleTarget.width,n=this.sampleTarget.height;"stereo"===this.parameters.cameraType&&(o/=2);for(var a=0;a<r.length;++a){var s=r[a];t.setViewOffset(o,n,s[0],s[1],o,n),t.updateProjectionMatrix(),Qe(e.scene,t);var c=i;c+=1/32*((a+.5)/r.length-.5),e.compositeUniforms.scale.value=c,e.__renderModelGroup(t,e.sampleTarget),e.renderer.setRenderTarget(e.holdTarget),0===a&&e.renderer.clear(),e.renderer.render(e.compositeScene,e.compositeCamera)}this.compositeUniforms.scale.value=1,this.compositeUniforms.tForeground.value=this.holdTarget.texture,t.clearViewOffset(),this.renderer.setRenderTarget(null),this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)},ur.prototype.__renderStereo=function(t){void 0===t&&(t=!1);var e=this.stereoCamera;e.update(this.perspectiveCamera);var r=this.renderer,i=new fe.Vector2;r.getSize(i),r.setScissorTest(!0),r.setScissor(0,0,i.width/2,i.height),r.setViewport(0,0,i.width/2,i.height),Qe(this.scene,e.cameraL),this.__render(t,e.cameraL),r.setScissor(i.width/2,0,i.width/2,i.height),r.setViewport(i.width/2,0,i.width/2,i.height),Qe(this.scene,e.cameraR),this.__render(t,e.cameraR),r.setScissorTest(!1),r.setViewport(0,0,i.width,i.height)},ur.prototype.__render=function(t,e){void 0===t&&(t=!1),t?this.lastRenderedPicking||this.__renderPickingGroup(e):0<this.sampleLevel&&"stereo"!==this.parameters.cameraType?this.__renderSuperSample(e):this.__renderModelGroup(e)},ur.prototype.render=function(t){if(void 0===t&&(t=!1),this.rendering)me.warn("'tried to call 'render' from within 'render'");else{this.rendering=!0;try{this.__updateClipping(),this.__updateCamera(),this.__updateLights(),this.updateInfo(!0),"stereo"===this.parameters.cameraType?this.__renderStereo(t):this.__render(t,this.camera),this.lastRenderedPicking=t}finally{this.rendering=!1,this.renderPending=!1}this.signals.rendered.dispatch()}},ur.prototype.clear=function(){me.log("scene cleared"),this.scene.remove(this.rotationGroup),this._initScene(),this.renderer.clear()},ur.prototype.dispose=function(){this.renderer.dispose()},Object.defineProperties(ur.prototype,hr);function lr(t){var e=t.touches[0].pageX-t.touches[1].pageX,r=t.touches[0].pageY-t.touches[1].pageY;return Math.sqrt(e*e+r*r)}var pr=function(t,e){void 0===e&&(e={}),this.domElement=t,this.signals={moved:new u.Signal,scrolled:new u.Signal,dragged:new u.Signal,dropped:new u.Signal,clicked:new u.Signal,hovered:new u.Signal,doubleClicked:new u.Signal},this.position=new fe.Vector2,this.prevPosition=new fe.Vector2,this.down=new fe.Vector2,this.canvasPosition=new fe.Vector2,this.prevClickCP=new fe.Vector2,this.moving=!1,this.hovering=!0,this.scrolled=!1,this.lastMoved=1/0,this.which=0,this.buttons=0,this.pressed=!1,this.altKey=!1,this.ctrlKey=!1,this.metaKey=!1,this.shiftKey=!1,this.domElement.style.touchAction="none",this.hoverTimeout=st(e.hoverTimeout,50),this.handleScroll=st(e.handleScroll,!0),this.doubleClickSpeed=st(e.doubleClickSpeed,500),this._listen=this._listen.bind(this),this._onMousewheel=this._onMousewheel.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onContextmenu=this._onContextmenu.bind(this),this._onTouchstart=this._onTouchstart.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._listen();var r={passive:!1};document.addEventListener("mousewheel",this._onMousewheel,r),document.addEventListener("wheel",this._onMousewheel,r),document.addEventListener("MozMousePixelScroll",this._onMousewheel,r),document.addEventListener("mousemove",this._onMousemove,r),document.addEventListener("mousedown",this._onMousedown,r),document.addEventListener("mouseup",this._onMouseup,r),document.addEventListener("contextmenu",this._onContextmenu,r),document.addEventListener("touchstart",this._onTouchstart,r),document.addEventListener("touchend",this._onTouchend,r),document.addEventListener("touchmove",this._onTouchmove,r)},dr={key:{configurable:!0}};dr.key.get=function(){var t=0;return this.altKey&&(t+=1),this.ctrlKey&&(t+=2),this.metaKey&&(t+=4),this.shiftKey&&(t+=8),t},pr.prototype.setParameters=function(t){void 0===t&&(t={}),this.hoverTimeout=st(t.hoverTimeout,this.hoverTimeout)},pr.prototype._listen=function(){var t=window.performance.now(),e=this.canvasPosition;this.doubleClickPending&&t-this.lastClicked>this.doubleClickSpeed&&(this.doubleClickPending=!1),t-this.lastMoved>this.hoverTimeout&&(this.moving=!1),(this.scrolled||!this.moving&&!this.hovering)&&(this.scrolled=!1,-1!==this.hoverTimeout&&this.overElement&&(this.hovering=!0,this.signals.hovered.dispatch(e.x,e.y))),window.requestAnimationFrame(this._listen)},pr.prototype._onMousewheel=function(t){var e=this;if(t.target===this.domElement&&this.handleScroll){t.preventDefault(),this._setKeys(t);var r=0;r="deltaY"in t&&"deltaMode"in t?t.deltaMode===WheelEvent.DOM_DELTA_PIXEL?.025*-t.deltaY:t.deltaMode===WheelEvent.DOM_DELTA_LINE?-t.deltaY*(2.5/3):2.5*-t.deltaY:"deltaY"in t&&!("detail"in t)?.025*-t.deltaY:void 0!==t.wheelDelta?.025*-t.wheelDelta:void 0!==t.wheelDeltaY?.025*-t.wheelDeltaY:-t.detail/3,this.signals.scrolled.dispatch(r),setTimeout(function(){e.scrolled=!0},this.hoverTimeout)}},pr.prototype._onMousemove=function(t){t.target===this.domElement?(t.preventDefault(),this.overElement=!0):this.overElement=!1,this._setKeys(t),this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(t.clientX,t.clientY),this._setCanvasPosition(t);var e=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(e,r),this.pressed&&this.signals.dragged.dispatch(e,r)},pr.prototype._onMousedown=function(t){t.target===this.domElement&&(t.preventDefault(),this._setKeys(t),this.moving=!1,this.hovering=!1,this.down.set(t.clientX,t.clientY),this.position.set(t.clientX,t.clientY),this.which=t.which,this.buttons=function(t){if("object"==typeof t){if("buttons"in t)return t.buttons;if("which"in t){var e=t.which;if(2===e)return 4;if(3===e)return 2;if(0<e)return 1<<e-1}else if("button"in t){var r=t.button;if(1===r)return 4;if(2===r)return 2;if(0<=r)return 1<<r}}return 0}(t),this.pressed=!0,this._setCanvasPosition(t))},pr.prototype._onMouseup=function(t){t.target===this.domElement&&t.preventDefault(),this._setKeys(t);var e=this.canvasPosition;this._distance()<4&&(this.lastClicked=window.performance.now(),this.doubleClickPending&&this.prevClickCP.distanceTo(e)<4&&(this.signals.doubleClicked.dispatch(e.x,e.y),this.doubleClickPending=!1),this.signals.clicked.dispatch(e.x,e.y),this.doubleClickPending=!0,this.prevClickCP.copy(e)),this.which=void 0,this.buttons=void 0,this.pressed=void 0},pr.prototype._onContextmenu=function(t){t.target===this.domElement&&t.preventDefault()},pr.prototype._onTouchstart=function(t){if(t.target===this.domElement)switch(t.preventDefault(),this.pressed=!0,t.touches.length){case 1:this.moving=!1,this.hovering=!1,this.down.set(t.touches[0].pageX,t.touches[0].pageY),this.position.set(t.touches[0].pageX,t.touches[0].pageY),this._setCanvasPosition(t.touches[0]);break;case 2:this.down.set((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2),this.position.set((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2),this.lastTouchDistance=lr(t)}},pr.prototype._onTouchend=function(t){t.target===this.domElement&&t.preventDefault(),this.which=void 0,this.buttons=void 0,this.pressed=void 0},pr.prototype._onTouchmove=function(t){switch(t.target===this.domElement?(t.preventDefault(),this.overElement=!0):this.overElement=!1,t.touches.length){case 1:this._setKeys(t),this.which=1,this.buttons=1,this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(t.touches[0].pageX,t.touches[0].pageY),this._setCanvasPosition(t.touches[0]);var e=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(e,r),this.pressed&&this.signals.dragged.dispatch(e,r);break;case 2:var i=lr(t),o=i-this.lastTouchDistance;if(this.lastTouchDistance=i,this.prevPosition.copy(this.position),this.position.set((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2),2<Math.abs(o)&&this.handleScroll&&this.position.distanceTo(this.prevPosition)<2)this.which=0,this.buttons=0,this.signals.scrolled.dispatch(o/2);else{this.which=3,this.buttons=2;var n=this.prevPosition.x-this.position.x,a=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(n,a),this.pressed&&this.signals.dragged.dispatch(n,a)}}},pr.prototype._distance=function(){return this.position.distanceTo(this.down)},pr.prototype._setCanvasPosition=function(t){var e,r,i=this.domElement.getBoundingClientRect();"offsetX"in t&&"offsetY"in t?(e=t.offsetX,r=t.offsetY):(e=t.clientX-i.left,r=t.clientY-i.top),this.canvasPosition.set(e,i.height-r)},pr.prototype._setKeys=function(t){this.altKey=t.altKey,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey},pr.prototype.dispose=function(){document.removeEventListener("mousewheel",this._onMousewheel),document.removeEventListener("wheel",this._onMousewheel),document.removeEventListener("MozMousePixelScroll",this._onMousewheel),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mousedown",this._onMousedown),document.removeEventListener("mouseup",this._onMouseup),document.removeEventListener("contextmenu",this._onContextmenu),document.removeEventListener("touchstart",this._onTouchstart),document.removeEventListener("touchend",this._onTouchend),document.removeEventListener("touchmove",this._onTouchmove)},Object.defineProperties(pr.prototype,dr);var fr=new fe.Matrix4,mr=new fe.Matrix4,gr=new fe.Matrix4,yr=new fe.Matrix4,vr=new fe.Vector3,br=new fe.Quaternion,xr=new fe.Matrix4,_r=new fe.Vector3,wr=new fe.Vector3,Ar=function(t,e){void 0===e&&(e={}),this.stage=t,this.rotateSpeed=st(e.rotateSpeed,2),this.zoomSpeed=st(e.zoomSpeed,1.2),this.panSpeed=st(e.panSpeed,1),this.viewer=t.viewer,this.mouse=t.mouseObserver,this.controls=t.viewerControls},Sr={component:{configurable:!0},atom:{configurable:!0}};Sr.component.get=function(){return this.stage.transformComponent},Sr.atom.get=function(){return this.stage.transformAtom},Ar.prototype._setPanVector=function(t,e,r){void 0===r&&(r=0);var i=this.controls.getCanvasScaleFactor(r);_r.set(t,e,0),_r.multiplyScalar(this.panSpeed*i)},Ar.prototype._getRotateXY=function(t,e){return[this.rotateSpeed*-t*.01,this.rotateSpeed*e*.01]},Ar.prototype._getCameraRotation=function(){var t=(new fe.Matrix4).extractRotation(this.viewer.camera.matrixWorld);return t.multiply((new fe.Matrix4).makeRotationY(Math.PI)),t},Ar.prototype._transformPanVector=function(){this.component&&(xr.extractRotation(this.component.transform),xr.premultiply(this.viewer.rotationGroup.matrix),xr.getInverse(xr),xr.multiply(this._getCameraRotation()),_r.applyMatrix4(xr))},Ar.prototype.zoom=function(t){this.controls.zoom(this.zoomSpeed*t*.02)},Ar.prototype.pan=function(t,e){this._setPanVector(t,e),xr.getInverse(this.viewer.rotationGroup.matrix),xr.multiply(this._getCameraRotation()),_r.applyMatrix4(xr),this.controls.translate(_r)},Ar.prototype.panComponent=function(t,e){this.component&&(this._setPanVector(t,e),this._transformPanVector(),this.component.position.add(_r),this.component.updateMatrix())},Ar.prototype.panAtom=function(t,e){this.atom&&this.component&&(this.atom.positionToVector3(wr),wr.add(this.viewer.translationGroup.position),wr.applyMatrix4(this.viewer.rotationGroup.matrix),this._setPanVector(t,e,wr.z),this._transformPanVector(),this.atom.positionAdd(_r),this.component.updateRepresentations({position:!0}))},Ar.prototype.rotate=function(t,e){var r=this._getRotateXY(t,e),i=r[0],o=r[1];fr.makeRotationX(o),mr.makeRotationY(i),fr.multiply(mr),this.controls.applyMatrix(fr)},Ar.prototype.zRotate=function(t,e){var r=this.rotateSpeed*((-t+e)/-2)*.01;gr.makeRotationZ(r),this.controls.applyMatrix(gr)},Ar.prototype.rotateComponent=function(t,e){if(this.component){var r=this._getRotateXY(t,e),i=r[0],o=r[1];yr.extractRotation(this.component.transform),yr.premultiply(this.viewer.rotationGroup.matrix),yr.getInverse(yr),vr.set(1,0,0),vr.applyMatrix4(yr),fr.makeRotationAxis(vr,o),vr.set(0,1,0),vr.applyMatrix4(yr),mr.makeRotationAxis(vr,i),fr.multiply(mr),br.setFromRotationMatrix(fr),this.component.quaternion.premultiply(br),this.component.updateMatrix()}},Object.defineProperties(Ar.prototype,Sr);var Cr=new fe.Vector3;var Pr=function(t,e){this.stage=e,this.pid=t.pid,this.picker=t.picker,this.instance=t.instance,this.stage=e,this.controls=e.viewerControls,this.mouse=e.mouseObserver},Ir={type:{configurable:!0},altKey:{configurable:!0},ctrlKey:{configurable:!0},metaKey:{configurable:!0},shiftKey:{configurable:!0},canvasPosition:{configurable:!0},component:{configurable:!0},object:{configurable:!0},position:{configurable:!0},closestBondAtom:{configurable:!0},closeAtom:{configurable:!0},arrow:{configurable:!0},atom:{configurable:!0},axes:{configurable:!0},bond:{configurable:!0},box:{configurable:!0},cone:{configurable:!0},clash:{configurable:!0},contact:{configurable:!0},cylinder:{configurable:!0},distance:{configurable:!0},ellipsoid:{configurable:!0},octahedron:{configurable:!0},point:{configurable:!0},mesh:{configurable:!0},slice:{configurable:!0},sphere:{configurable:!0},tetrahedron:{configurable:!0},torus:{configurable:!0},surface:{configurable:!0},unitcell:{configurable:!0},unknown:{configurable:!0},volume:{configurable:!0},wideline:{configurable:!0}};Ir.type.get=function(){return this.picker.type},Ir.altKey.get=function(){return this.mouse.altKey},Ir.ctrlKey.get=function(){return this.mouse.ctrlKey},Ir.metaKey.get=function(){return this.mouse.metaKey},Ir.shiftKey.get=function(){return this.mouse.shiftKey},Ir.canvasPosition.get=function(){return this.mouse.canvasPosition},Ir.component.get=function(){return this.stage.getComponentsByObject(this.picker.data).list[0]},Ir.object.get=function(){return this.picker.getObject(this.pid)},Ir.position.get=function(){return this.picker.getPosition(this.pid,this.instance,this.component)},Ir.closestBondAtom.get=function(){if("bond"===this.type&&this.bond){var t,e,r,i=this.bond,o=this.controls,n=this.canvasPosition,a=o.getPositionOnCanvas(i.atom1),s=o.getPositionOnCanvas(i.atom2);return e=a,r=s,(t=n).distanceTo(e)<t.distanceTo(r)?i.atom1:i.atom2}},Ir.closeAtom.get=function(){var t=this.canvasPosition,e=this.closestBondAtom;if(e){var r=this.controls.getPositionOnCanvas(e);e.positionToVector3(Cr),this.instance&&Cr.applyMatrix4(this.instance.matrix),Cr.applyMatrix4(this.component.matrix);var i=this.controls.viewer;Cr.add(i.translationGroup.position),Cr.applyMatrix4(i.rotationGroup.matrix);var o=this.controls.getCanvasScaleFactor(Cr.z),n=this.component.getMaxRepresentationRadius(e.index);return t.distanceTo(r)<=n/o?e:void 0}},Ir.arrow.get=function(){return this._objectIfType("arrow")},Ir.atom.get=function(){return this._objectIfType("atom")},Ir.axes.get=function(){return this._objectIfType("axes")},Ir.bond.get=function(){return this._objectIfType("bond")},Ir.box.get=function(){return this._objectIfType("box")},Ir.cone.get=function(){return this._objectIfType("cone")},Ir.clash.get=function(){return this._objectIfType("clash")},Ir.contact.get=function(){return this._objectIfType("contact")},Ir.cylinder.get=function(){return this._objectIfType("cylinder")},Ir.distance.get=function(){return this._objectIfType("distance")},Ir.ellipsoid.get=function(){return this._objectIfType("ellipsoid")},Ir.octahedron.get=function(){return this._objectIfType("octahedron")},Ir.point.get=function(){return this._objectIfType("point")},Ir.mesh.get=function(){return this._objectIfType("mesh")},Ir.slice.get=function(){return this._objectIfType("slice")},Ir.sphere.get=function(){return this._objectIfType("sphere")},Ir.tetrahedron.get=function(){return this._objectIfType("tetrahedron")},Ir.torus.get=function(){return this._objectIfType("torus")},Ir.surface.get=function(){return this._objectIfType("surface")},Ir.unitcell.get=function(){return this._objectIfType("unitcell")},Ir.unknown.get=function(){return this._objectIfType("unknown")},Ir.volume.get=function(){return this._objectIfType("volume")},Ir.wideline.get=function(){return this._objectIfType("wideline")},Pr.prototype._objectIfType=function(t){return this.type===t?this.object:void 0},Pr.prototype.getLabel=function(){var t=this.atom||this.closeAtom,e="nothing";return this.arrow?e=this.arrow.name:t?e="atom: "+t.qualifiedName()+" ("+t.structure.name+")":this.axes?e="axes":this.bond?e="bond: "+this.bond.atom1.qualifiedName()+" - "+this.bond.atom2.qualifiedName()+" ("+this.bond.structure.name+")":this.box?e=this.box.name:this.cone?e=this.cone.name:this.clash?e="clash: "+this.clash.clash.sele1+" - "+this.clash.clash.sele2:this.contact?e=this.contact.type+": "+this.contact.atom1.qualifiedName()+" - "+this.contact.atom2.qualifiedName()+" ("+this.contact.atom1.structure.name+")":this.cylinder?e=this.cylinder.name:this.distance?e="distance: "+this.distance.atom1.qualifiedName()+" - "+this.distance.atom2.qualifiedName()+" ("+this.distance.structure.name+")":this.ellipsoid?e=this.ellipsoid.name:this.octahedron?e=this.octahedron.name:this.point?e=this.point.name:this.mesh?e="mesh: "+(this.mesh.name||this.mesh.serial)+" ("+this.mesh.shape.name+")":this.slice?e="slice: "+this.slice.value.toPrecision(3)+" ("+this.slice.volume.name+")":this.sphere?e=this.sphere.name:this.surface?e="surface: "+this.surface.surface.name:this.tetrahedron?e=this.tetrahedron.name:this.torus?e=this.torus.name:this.unitcell?e="unitcell: "+this.unitcell.unitcell.spacegroup+" ("+this.unitcell.structure.name+")":this.unknown?e="unknown":this.volume?e="volume: "+this.volume.value.toPrecision(3)+" ("+this.volume.volume.name+")":this.wideline&&(e=this.wideline.name),e},Object.defineProperties(Pr.prototype,Ir);var Or=function(t){this.stage=t,this.viewer=t.viewer};Or.prototype.pick=function(t,e){var r=this.viewer.pick(t,e);if(r.picker&&"ignore"!==r.picker.type&&void 0!==r.pid){var i=r.picker.array;if(!(i&&r.pid>=i.length))return new Pr(r,this.stage);console.error("pid >= picker.array.length")}};var kr=new fe.Quaternion,Mr=new fe.Vector3,Br=new fe.Vector3,Tr=new fe.Vector3,Dr=new fe.Vector3,Rr=new fe.Matrix4,Fr=new fe.Vector3,Er=new fe.Matrix4,$r=function(t){this.stage=t,this.signals={changed:new u.Signal},this.viewer=t.viewer},Lr={position:{configurable:!0},rotation:{configurable:!0}};Lr.position.get=function(){return this.viewer.translationGroup.position},Lr.rotation.get=function(){return this.viewer.rotationGroup.quaternion},$r.prototype.changed=function(){this.viewer.requestRender(),this.signals.changed.dispatch()},$r.prototype.getPositionOnCanvas=function(t,e){var r=P(e,fe.Vector2),i=this.viewer;return Tr.copy(t).add(i.translationGroup.position).applyMatrix4(i.rotationGroup.matrix).project(i.camera),r.set((Tr.x+1)*i.width/2,(Tr.y+1)*i.height/2)},$r.prototype.getCanvasScaleFactor=function(t){void 0===t&&(t=0);var e=this.viewer.camera;if(e instanceof fe.OrthographicCamera)return 1/e.zoom;t=Math.abs(t),t+=this.getCameraDistance();var r=et(e.fov);return 2*t*Math.tan(r/2)/this.viewer.height},$r.prototype.getOrientation=function(t){var e=O(t);e.copy(this.viewer.rotationGroup.matrix);var r=this.getCameraDistance();return e.scale(Dr.set(r,r,r)),e.setPosition(this.viewer.translationGroup.position),e},$r.prototype.orient=function(t){O(t).decompose(Mr,kr,Br);var e=this.viewer;e.rotationGroup.setRotationFromQuaternion(kr),e.translationGroup.position.copy(Mr),e.cameraDistance=Br.z,e.updateZoom(),this.changed()},$r.prototype.translate=function(t){this.viewer.translationGroup.position.add(I(t)),this.changed()},$r.prototype.center=function(t){this.viewer.translationGroup.position.copy(I(t)).negate(),this.changed()},$r.prototype.zoom=function(t){this.distance(this.getCameraDistance()*(1-t))},$r.prototype.getCameraDistance=function(){return this.viewer.cameraDistance},$r.prototype.distance=function(t){this.viewer.cameraDistance=Math.max(Math.abs(t),.2),this.viewer.updateZoom(),this.changed()},$r.prototype.spin=function(t,e){Rr.getInverse(this.viewer.rotationGroup.matrix),Fr.copy(I(t)).applyMatrix4(Rr),this.viewer.rotationGroup.rotateOnAxis(Fr,e),this.changed()},$r.prototype.rotate=function(t){this.viewer.rotationGroup.setRotationFromQuaternion(k(t)),this.changed()},$r.prototype.align=function(t){Er.getInverse(O(t)),this.viewer.rotationGroup.setRotationFromMatrix(Er),this.changed()},$r.prototype.applyMatrix=function(t){this.viewer.rotationGroup.applyMatrix(O(t)),this.changed()},Object.defineProperties($r.prototype,Lr);var Nr=function(t,e){for(var r,i=[],o=arguments.length-2;0<o--;)i[o]=arguments[o+2];this.pausedTime=-1,this.elapsedDuration=0,this.pausedDuration=0,this.ignoreGlobalToggle=!1,this._paused=!1,this._resolveList=[],this.duration=st(t,1e3),this.controls=e,this.startTime=window.performance.now(),(r=this)._init.apply(r,i)},zr={done:{configurable:!0},paused:{configurable:!0}};zr.done.get=function(){return 1===this.alpha},zr.paused.get=function(){return this._paused},Nr.prototype.tick=function(t){if(!this._paused)return this.elapsedDuration=t.currentTime-this.startTime-this.pausedDuration,0===this.duration?this.alpha=1:this.alpha=V(0,1,this.elapsedDuration/this.duration),this._tick(t),this.done&&this._resolveList.forEach(function(t){return t()}),this.done},Nr.prototype.pause=function(t){t&&(this._hold=!0),-1===this.pausedTime&&(this.pausedTime=window.performance.now()),this._paused=!0},Nr.prototype.resume=function(t){!t&&this._hold||(this.pausedDuration+=window.performance.now()-this.pausedTime,this._paused=!1,this._hold=!1,this.pausedTime=-1)},Nr.prototype.toggle=function(){this._paused?this.resume():this.pause()},Nr.prototype.then=function(t){var e=this;return(this.done?Promise.resolve():new Promise(function(t){return e._resolveList.push(t)})).then(t)},Object.defineProperties(Nr.prototype,zr);var jr=function(o){function t(t,e){for(var r=[],i=arguments.length-2;0<i--;)r[i]=arguments[i+2];o.apply(this,[st(t,1/0),e].concat(r))}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype._init=function(t,e){Array.isArray(t)?this.axis=(new fe.Vector3).fromArray(t):this.axis=st(t,new fe.Vector3(0,1,0)),this.angle=st(e,.01)},t.prototype._tick=function(t){this.axis&&this.angle&&this.controls.spin(this.axis,this.angle*t.lastDuration/16)},t}(Nr),Vr=function(o){function t(t,e){for(var r=[],i=arguments.length-2;0<i--;)r[i]=arguments[i+2];o.apply(this,[st(t,1/0),e].concat(r)),this.angleSum=0,this.direction=1}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype._init=function(t,e,r){Array.isArray(t)?this.axis=(new fe.Vector3).fromArray(t):this.axis=st(t,new fe.Vector3(0,1,0)),this.angleStep=st(e,.01),this.angleEnd=st(r,.2)},t.prototype._tick=function(t){if(this.axis&&this.angleStep&&this.angleEnd){var e=V(0,1,Math.abs(this.angleSum)/this.angleEnd),r=this.angleStep*this.direction*(1.1-e);this.controls.spin(this.axis,r*t.lastDuration/16),this.angleSum+=this.angleStep,this.angleSum>=this.angleEnd&&(this.direction*=-1,this.angleSum=-this.angleEnd)}},t}(Nr),Gr=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._init=function(t,e){this.moveFrom=I(st(t,new fe.Vector3)),this.moveTo=I(st(e,new fe.Vector3))},e.prototype._tick=function(){this.controls.position.lerpVectors(this.moveFrom,this.moveTo,this.alpha).negate(),this.controls.changed()},e}(Nr),Ur=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._init=function(t,e){this.zoomFrom=t,this.zoomTo=e},e.prototype._tick=function(){this.controls.distance(N(this.zoomFrom,this.zoomTo,this.alpha))},e}(Nr),Hr=function(t){function e(){t.apply(this,arguments),this._currentRotation=new fe.Quaternion}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._init=function(t,e){this.rotateFrom=k(t),this.rotateTo=k(e),this._currentRotation=new fe.Quaternion},e.prototype._tick=function(){this._currentRotation.copy(this.rotateFrom).slerp(this.rotateTo,this.alpha),this.controls.rotate(this._currentRotation)},e}(Nr),Wr=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._init=function(t,e,r){this.valueFrom=t,this.valueTo=e,this.callback=r},e.prototype._tick=function(){this.callback(N(this.valueFrom,this.valueTo,this.alpha))},e}(Nr),qr=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype._init=function(t){this.callback=t},e.prototype._tick=function(){1===this.alpha&&this.callback()},e}(Nr),Xr=function(t){void 0===t&&(t=[]),this._resolveList=[],this._list=t},Yr={done:{configurable:!0}};Yr.done.get=function(){return this._list.every(function(t){return t.done})},Xr.prototype.then=function(t){var e=this;return(this.done?Promise.resolve():new Promise(function(t){e._resolveList.push(t),e._list.forEach(function(t){t.then(function(){e._resolveList.forEach(function(t){t()}),e._resolveList.length=0})})})).then(t)},Object.defineProperties(Xr.prototype,Yr);var Kr=function(t){this.stage=t,this.animationList=[],this.finishedList=[],this.viewer=t.viewer,this.controls=t.viewerControls},Zr={paused:{configurable:!0}};Zr.paused.get=function(){return this.animationList.every(function(t){return t.paused})},Kr.prototype.add=function(t){return 0===t.duration?t.tick(this.viewer.stats):this.animationList.push(t),t},Kr.prototype.remove=function(t){var e=this.animationList,r=e.indexOf(t);-1<r&&e.splice(r,1)},Kr.prototype.run=function(t){for(var e=this.finishedList,r=this.animationList,i=r.length,o=0;o<i;++o){var n=r[o];n.tick(t)&&e.push(n)}var a=e.length;if(a){for(var s=0;s<a;++s)this.remove(e[s]);e.length=0}},Kr.prototype.spin=function(t,e,r){return this.add(new jr(r,this.controls,t,e))},Kr.prototype.rock=function(t,e,r,i){return this.add(new Vr(i,this.controls,t,e,r))},Kr.prototype.rotate=function(t,e){var r=this.viewer.rotationGroup.quaternion.clone();return this.add(new Hr(e,this.controls,r,t))},Kr.prototype.move=function(t,e){var r=this.controls.position.clone().negate();return this.add(new Gr(e,this.controls,r,t))},Kr.prototype.zoom=function(t,e){var r=this.viewer.camera.position.z;return this.add(new Ur(e,this.controls,r,t))},Kr.prototype.zoomMove=function(t,e,r){return new Xr([this.move(t,r),this.zoom(e,r)])},Kr.prototype.orient=function(t,e){var r=new fe.Vector3,i=new fe.Quaternion,o=new fe.Vector3;return O(t).decompose(r,i,o),new Xr([this.move(r.negate(),e),this.rotate(i,e),this.zoom(-o.x,e)])},Kr.prototype.value=function(t,e,r,i){return this.add(new Wr(i,this.controls,t,e,r))},Kr.prototype.timeout=function(t,e){return this.add(new qr(e,this.controls,t))},Kr.prototype.spinComponent=function(t,e,r,i){return this.add(new jr(i,t.controls,e,r))},Kr.prototype.rockComponent=function(t,e,r,i,o){return this.add(new Vr(o,t.controls,e,r,i))},Kr.prototype.moveComponent=function(t,e,r){var i=t.controls.position.clone().negate();return this.add(new Gr(r,t.controls,i,e))},Kr.prototype.pause=function(){this.animationList.forEach(function(t){return t.pause()})},Kr.prototype.resume=function(){this.animationList.forEach(function(t){return t.resume()})},Kr.prototype.toggle=function(){this.paused?this.resume():this.pause()},Kr.prototype.clear=function(){this.animationList.length=0},Kr.prototype.dispose=function(){this.clear()},Object.defineProperties(Kr.prototype,Zr);var Qr=function(t,e){if(this.fn=t,this.queue=[],this.pending=!1,this.next=this.next.bind(this),e){for(var r=0,i=e.length;r<i;++r)this.queue.push(e[r]);this.next()}};Qr.prototype.run=function(t){this.fn(t,this.next)},Qr.prototype.next=function(){var t=this,e=this.queue.shift();void 0!==e?(this.pending=!0,setTimeout(function(){return t.run(e)})):this.pending=!1},Qr.prototype.push=function(t){this.queue.push(t),this.pending||this.next()},Qr.prototype.kill=function(){this.queue.length=0},Qr.prototype.length=function(){return this.queue.length};var Jr=function(t,e,r){this.type="",this.parameters={lazy:{type:"boolean"},clipNear:{type:"range",step:1,max:100,min:0,buffer:!0},clipRadius:{type:"number",precision:1,max:1e3,min:0,buffer:!0},clipCenter:{type:"vector3",precision:1,buffer:!0},flatShaded:{type:"boolean",buffer:!0},opacity:{type:"range",step:.01,max:1,min:0,buffer:!0},depthWrite:{type:"boolean",buffer:!0},side:{type:"select",buffer:!0,options:{front:"front",back:"back",double:"double"}},wireframe:{type:"boolean",buffer:!0},colorScheme:{type:"select",update:"color",options:{}},colorScale:{type:"select",update:"color",options:Vt.getScales()},colorReverse:{type:"boolean",update:"color"},colorValue:{type:"color",update:"color"},colorDomain:{type:"hidden",update:"color"},colorMode:{type:"select",update:"color",options:Vt.getModes()},roughness:{type:"range",step:.01,max:1,min:0,buffer:!0},metalness:{type:"range",step:.01,max:1,min:0,buffer:!0},diffuse:{type:"color",buffer:!0},diffuseInterior:{type:"boolean",buffer:!0},useInteriorColor:{type:"boolean",buffer:!0},interiorColor:{type:"color",buffer:!0},interiorDarkening:{type:"range",step:.01,max:1,min:0,buffer:!0},matrix:{type:"hidden",buffer:!0},disablePicking:{type:"boolean",rebuild:!0}},this.viewer=e,this.tasks=new ge,this.queue=new Qr(this.make.bind(this)),this.bufferList=[],this.parameters.colorScheme&&(this.parameters.colorScheme.options=Vt.getSchemes()),this.toBePrepared=!1};Jr.prototype.init=function(t){var e=t||{};this.clipNear=st(e.clipNear,0),this.clipRadius=st(e.clipRadius,0),this.clipCenter=st(e.clipCenter,new fe.Vector3),this.flatShaded=st(e.flatShaded,!1),this.side=st(e.side,"double"),this.opacity=st(e.opacity,1),this.depthWrite=st(e.depthWrite,!0),this.wireframe=st(e.wireframe,!1),this.setColor(e.color,e),this.colorScheme=st(e.colorScheme,"uniform"),this.colorScale=st(e.colorScale,""),this.colorReverse=st(e.colorReverse,!1),this.colorValue=st(e.colorValue,9474192),this.colorDomain=st(e.colorDomain,void 0),this.colorMode=st(e.colorMode,"hcl"),this.visible=st(e.visible,!0),this.quality=st(e.quality,void 0),this.roughness=st(e.roughness,.4),this.metalness=st(e.metalness,0),this.diffuse=st(e.diffuse,16777215),this.diffuseInterior=st(e.diffuseInterior,!1),this.useInteriorColor=st(e.useInteriorColor,!1),this.interiorColor=st(e.interiorColor,2236962),this.interiorDarkening=st(e.interiorDarkening,0),this.lazy=st(e.lazy,!1),this.lazyProps={build:!1,bufferParams:{},what:{}},this.matrix=st(e.matrix,new fe.Matrix4),this.disablePicking=st(e.disablePicking,!1);var r=this.parameters;!0===r.sphereDetail&&(r.sphereDetail={type:"integer",max:3,min:0,rebuild:"impostor"}),!0===r.radialSegments&&(r.radialSegments={type:"integer",max:25,min:5,rebuild:"impostor"}),!0===r.openEnded&&(r.openEnded={type:"boolean",rebuild:"impostor",buffer:!0}),!0===r.disableImpostor&&(r.disableImpostor={type:"boolean",rebuild:!0}),"low"===e.quality?(r.sphereDetail&&(this.sphereDetail=0),r.radialSegments&&(this.radialSegments=5)):"medium"===e.quality?(r.sphereDetail&&(this.sphereDetail=1),r.radialSegments&&(this.radialSegments=10)):"high"===e.quality?(r.sphereDetail&&(this.sphereDetail=2),r.radialSegments&&(this.radialSegments=20)):(r.sphereDetail&&(this.sphereDetail=st(e.sphereDetail,1)),r.radialSegments&&(this.radialSegments=st(e.radialSegments,10))),r.openEnded&&(this.openEnded=st(e.openEnded,!0)),r.disableImpostor&&(this.disableImpostor=st(e.disableImpostor,!1))},Jr.prototype.getColorParams=function(t){return Object.assign({scheme:this.colorScheme,scale:this.colorScale,reverse:this.colorReverse,value:this.colorValue,domain:this.colorDomain,mode:this.colorMode},t)},Jr.prototype.getBufferParams=function(t){return void 0===t&&(t={}),Object.assign({clipNear:this.clipNear,clipRadius:this.clipRadius,clipCenter:this.clipCenter,flatShaded:this.flatShaded,opacity:this.opacity,depthWrite:this.depthWrite,side:this.side,wireframe:this.wireframe,roughness:this.roughness,metalness:this.metalness,diffuse:this.diffuse,diffuseInterior:this.diffuseInterior,useInteriorColor:this.useInteriorColor,interiorColor:this.interiorColor,interiorDarkening:this.interiorDarkening,matrix:this.matrix,disablePicking:this.disablePicking},t)},Jr.prototype.setColor=function(t,e){var r=Object.keys(Vt.getSchemes());if("string"==typeof t&&r.includes(t.toLowerCase()))e?e.colorScheme=t:this.setParameters({colorScheme:t});else if(void 0!==t){var i=new fe.Color(t).getHex();e?(e.colorScheme="uniform",e.colorValue=i):this.setParameters({colorScheme:"uniform",colorValue:i})}return this},Jr.prototype.prepare=function(t){},Jr.prototype.create=function(){},Jr.prototype.update=function(t){this.build()},Jr.prototype.build=function(t){if(!this.lazy||this.visible&&this.opacity){if(!this.toBePrepared)return this.tasks.increment(),void this.make();0<this.queue.length()?(this.tasks.change(1-this.queue.length()),this.queue.kill()):this.tasks.increment(),this.queue.push(t||!1)}else this.lazyProps.build=!0},Jr.prototype.make=function(t,e){var r=this;de.Debug&&me.time("Representation.make "+this.type);var i=function(){t?(r.update(t),r.viewer.requestRender(),r.tasks.decrement(),e&&e()):(r.clear(),r.create(),r.manualAttach||r.disposed||(de.Debug&&me.time("Representation.attach "+r.type),r.attach(function(){de.Debug&&me.timeEnd("Representation.attach "+r.type),r.tasks.decrement(),e&&e()}))),de.Debug&&me.timeEnd("Representation.make "+r.type)};this.toBePrepared?this.prepare(i):i()},Jr.prototype.attach=function(t){this.setVisibility(this.visible),t()},Jr.prototype.setVisibility=function(e,t){if(this.visible=e,this.visible&&this.opacity){var r=this.lazyProps,i=r.bufferParams,o=r.what;if(r.build)return r.build=!1,this.build(),this;(Object.keys(i).length||Object.keys(o).length)&&(r.bufferParams={},r.what={},this.updateParameters(i,o))}return this.bufferList.forEach(function(t){t.setVisibility(e)}),t||this.viewer.requestRender(),this},Jr.prototype.setParameters=function(t,e,r){var i=this;void 0===e&&(e={}),void 0===r&&(r=!1);var o=t||{},n=this.parameters,a={};for(var s in this.opacity||void 0===o.opacity||(this.lazyProps.build?r=!(this.lazyProps.build=!1):(Object.assign(a,this.lazyProps.bufferParams),Object.assign(e,this.lazyProps.what),this.lazyProps.bufferParams={},this.lazyProps.what={})),this.setColor(o.color,o),o)if(void 0!==o[s]&&void 0!==n[s]&&(n[s].int&&(o[s]=parseInt(o[s])),n[s].float&&(o[s]=parseFloat(o[s])),o[s]!==i[s]||o[s].equals&&!o[s].equals(i[s]))){if(i[s]&&i[s].copy&&o[s].copy?i[s].copy(o[s]):i[s]&&i[s].set?i[s].set(o[s]):i[s]=o[s],n[s].buffer)if(!0===n[s].buffer)a[s]=o[s];else a[n[s].buffer]=o[s];n[s].update&&(e[n[s].update]=!0),!n[s].rebuild||"impostor"===n[s].rebuild&&$t&&!i.disableImpostor||(r=!0)}return r?this.build():this.updateParameters(a,e),this},Jr.prototype.updateParameters=function(e,t){if(void 0===e&&(e={}),this.lazy&&(!this.visible||!this.opacity)&&!1===e.hasOwnProperty("opacity"))return Object.assign(this.lazyProps.bufferParams,e),void Object.assign(this.lazyProps.what,t);this.bufferList.forEach(function(t){t.setParameters(e)}),Object.keys(t).length&&this.update(t),this.viewer.requestRender()},Jr.prototype.getParameters=function(){var e=this,r={lazy:this.lazy,visible:this.visible,quality:this.quality};return Object.keys(this.parameters).forEach(function(t){null!==e.parameters[t]&&(r[t]=e[t])}),r},Jr.prototype.clear=function(){var e=this;this.bufferList.forEach(function(t){e.viewer.remove(t),t.dispose()}),this.bufferList.length=0,this.viewer.requestRender()},Jr.prototype.dispose=function(){this.disposed=!0,this.queue.kill(),this.tasks.dispose(),this.clear()};var ti=function(i){var o=this;this.pending=0,this.postCount=0,this.onmessageDict={},this.onerrorDict={},this.name=i,this.blobUrl=window.URL.createObjectURL(jt.get(i)),this.worker=new Worker(this.blobUrl),jt.activeWorkerCount+=1,this.worker.onmessage=function(t){o.pending-=1;var e=t.data.__postId;de.Debug&&me.timeEnd("Worker.postMessage "+i+" #"+e);var r=o.onmessageDict[e];r&&r.call(o.worker,t),delete o.onmessageDict[e],delete o.onerrorDict[e]},this.worker.onerror=function(t){if(o.pending-=1,t.data){var e=t.data.__postId,r=o.onerrorDict[e];r?r.call(o.worker,t):me.error("Worker.onerror",e,i,t),delete o.onmessageDict[e],delete o.onerrorDict[e]}else me.error("Worker.onerror",i,t)}};ti.prototype.post=function(e,t,r,i){void 0===e&&(e={}),this.onmessageDict[this.postCount]=r,this.onerrorDict[this.postCount]=i,e.__name=this.name,e.__postId=this.postCount,e.__debug=de.Debug,de.Debug&&me.time("Worker.postMessage "+this.name+" #"+this.postCount);try{this.worker.postMessage(e,t)}catch(t){me.error("worker.post:",t),this.worker.postMessage(e)}return this.pending+=1,this.postCount+=1,this},ti.prototype.terminate=function(){this.worker?(this.worker.terminate(),window.URL.revokeObjectURL(this.blobUrl),jt.activeWorkerCount-=1):me.log("no worker to terminate")};var ei=function(t,e){void 0===e&&(e=2),this.pool=[],this.count=0,this.maxCount=Math.min(8,e),this.name=t};function ri(t){for(var e=t.length,r=e/3,i=0,o=0,n=0,a=0;a<e;a+=3)i+=t[a+0],o+=t[a+1],n+=t[a+2];return new fe.Vector3(i/r,o/r,n/r)}function ii(t,e,r){return r?t.sub(r).projectOnVector(e).add(r):t.projectOnVector(e),t}function oi(t){for(var e=1/0,r=1/0,i=1/0,o=-1/0,n=-1/0,a=-1/0,s=0,c=t.length;s<c;s+=3){var u=t[s],h=t[s+1],l=t[s+2];u<e&&(e=u),h<r&&(r=h),l<i&&(i=l),o<u&&(o=u),n<h&&(n=h),a<l&&(a=l)}return[ci([e,r,i]),ci([o,n,a])]}function ni(t,e){for(var r=0,i=e.length;r<i;r+=3){var o=e[r],n=e[r+1],a=e[r+2];e[r]=t[0]*o+t[4]*n+t[8]*a+t[12],e[r+1]=t[1]*o+t[5]*n+t[9]*a+t[13],e[r+2]=t[2]*o+t[6]*n+t[10]*a+t[14]}}function ai(t,e){for(var r=0,i=e.length;r<i;r+=3){var o=e[r],n=e[r+1],a=e[r+2];e[r]=t[0]*o+t[3]*n+t[6]*a,e[r+1]=t[1]*o+t[4]*n+t[7]*a,e[r+2]=t[2]*o+t[5]*n+t[8]*a}}function si(t){for(var e=0,r=t.length;e<r;e+=3){var i=t[e],o=t[e+1],n=t[e+2],a=1/Math.sqrt(i*i+o*o+n*n);t[e]=i*a,t[e+1]=o*a,t[e+2]=n*a}}function ci(t){return new Float32Array(t||3)}function ui(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],c=r[2];t[0]=o*c-n*s,t[1]=n*a-i*c,t[2]=i*s-o*a}function hi(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function li(t,e,r){t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2]}function pi(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}function di(t,e,r){void 0===r&&(r=0),t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2]}function fi(t,e,r){void 0===r&&(r=0),e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2]}function mi(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}function gi(t,e,r){yi(t,e,1/r)}function yi(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}function vi(t,e){yi(t,e,1/mi(e))}function bi(t,e,r){t[0]=e[0]-r,t[1]=e[1]-r,t[2]=e[2]-r}function xi(t,e,r){t[0]=e[0]+r,t[1]=e[1]+r,t[2]=e[2]+r}function _i(t,e){t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2])}function wi(t,e){t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2])}function Ai(t,e){t[0]=-e[0],t[1]=-e[1],t[2]=-e[2]}function Si(t,e){void 0===e&&(e=9);for(var r=Math.floor(e/2),i=t.position1.length/3,o=3*(r*i),n=1/e,a=Te(t.position1,t.position2),s=new Float32Array(o),c=new Float32Array(o),u=new fe.Vector3,h=0;h<i;++h){var l=3*h;u.set(a[l],a[l+1],a[l+2]);for(var p=t.position1[l],d=t.position1[l+1],f=t.position1[l+2],m=0;m<r;++m){var g=r*l+3*m,y=n*(2*m+1),v=n*(2*m+2);s[g]=p+u.x*y,s[g+1]=d+u.y*y,s[g+2]=f+u.z*y,c[g]=p+u.x*v,c[g+1]=d+u.y*v,c[g+2]=f+u.z*v}}var b=Be(s,c),x=function(t,e){for(var r=t.length/3,i=new Float32Array(r*e*3),o=0;o<r;++o)for(var n=3*o,a=o*e*3,s=t[n+0],c=t[n+1],u=t[n+2],h=0;h<e;++h){var l=a+3*h;i[l+0]=s,i[l+1]=c,i[l+2]=u}return i}(t.color,r),_={position:b,position1:s,position2:c,color:x,color2:x};return t.radius&&(_.radius=$e(t.radius,r)),t.picking&&t.picking.array&&(t.picking.array=$e(t.picking.array,r),_.picking=t.picking),t.primitiveId&&(_.primitiveId=$e(t.primitiveId,r)),_}function Ci(t,e){void 0===e&&(e=.1);for(var r=Te(t.position1,t.position2),i=[],o=[],n=[],a=t.radius?[]:void 0,s=t.picking?[]:void 0,c=t.primitiveId?[]:void 0,u=new fe.Vector3,h=t.position1.length/3,l=0,p=0;p<h;++p){var d=3*p;u.set(r[d],r[d+1],r[d+2]);for(var f=u.length()/e,m=Math.floor(f/2),g=1/f,y=t.position1[d],v=t.position1[d+1],b=t.position1[d+2],x=0;x<m;++x){var _=3*l+3*x,w=g*(2*x+1),A=g*(2*x+2);i[_]=y+u.x*w,i[_+1]=v+u.y*w,i[_+2]=b+u.z*w,o[_]=y+u.x*A,o[_+1]=v+u.y*A,o[_+2]=b+u.z*A,t.color&&(n[_]=t.color[d],n[_+1]=t.color[d+1],n[_+2]=t.color[d+2]),a&&(a[l+x]=t.radius[p]),s&&(t.picking.array?s[l+x]=t.picking.array[p]:s[l+x]=p),c&&(c[l+x]=t.primitiveId[p])}l+=m}var S=new Float32Array(i),C=new Float32Array(o),P=Be(S,C),I=new Float32Array(n),O={position:P,position1:S,position2:C,color:I,color2:I};return a&&(O.radius=new Float32Array(a)),s&&t.picking&&(t.picking.array=new Float32Array(s),O.picking=t.picking),c&&(O.primitiveId=new Float32Array(c)),O}function Pi(t,e){void 0===e&&(e=.1);for(var r=Te(t.position1,t.position2),i=[],o=[],n=[],a=t.radius?[]:void 0,s=t.picking?[]:void 0,c=t.primitiveId?[]:void 0,u=new fe.Vector3,h=t.position1.length/3,l=e,p=!0,d=0,f=0,m=0,g=0;g<h;++g){var y=3*g,v=t.position1[y],b=t.position1[y+1],x=t.position1[y+2];u.set(r[y],r[y+1],r[y+2]);var _=u.length();p&&(i[f]=v,i[f+1]=b,i[f+2]=x);for(var w=l,A=1/_;w<_;){var S=p?o:i;S[f]=v+u.x*w*A,S[f+1]=b+u.y*w*A,S[f+2]=x+u.z*w*A,p&&(f=3*++d),p=!p,w+=l=e}p&&(o[f]=t.position2[y],o[f+1]=t.position2[y+1],o[f+2]=t.position2[y+2],f=3*++d),l=w-_;for(var C=m;C<d;C++){if(t.color){var P=3*C;n[P]=t.color[y],n[P+1]=t.color[y+1],n[P+2]=t.color[y+2]}a&&(a[C]=t.radius[g]),s&&(t.picking.array?s[C]=t.picking.array[g]:s[C]=g),c&&(c[C]=t.primitiveId[g])}m=d}if(!p&&0<h){var I=3*d;o[I]=t.position2[3*h-3],o[I+1]=t.position2[3*h-2],o[I+1]=t.position2[3*h-1]}var O=new Float32Array(i),k=new Float32Array(o),M=Be(O,k),B=new Float32Array(n),T={position:M,position1:O,position2:k,color:B,color2:B};return a&&(T.radius=new Float32Array(a)),s&&t.picking&&(t.picking.array=new Float32Array(s),T.picking=t.picking),c&&(T.primitiveId=new Float32Array(c)),T}ei.prototype.post=function(t,e,r,i){void 0===t&&(t={});var o=this.getNextWorker();return o?o.post(t,e,r,i):console.error("unable to get worker from pool"),this},ei.prototype.terminate=function(){this.pool.forEach(function(t){t.terminate()})},ei.prototype.getNextWorker=function(){for(var t,e=this,r=1/0,i=0;i<this.maxCount;++i){if(i>=e.count){t=new ti(e.name),e.pool.push(t),e.count+=1;break}var o=e.pool[i];if(0===o.pending){t=o;break}o.pending<r&&(r=o.pending,t=o)}return t},ei.prototype.constructor=ei,oi.__deps=[ci],gi.__deps=[yi],vi.__deps=[yi,mi];var Ii=new fe.Vector3,Oi=function(){},ki={Picker:{configurable:!0},Buffer:{configurable:!0}};ki.Picker.get=function(){return Kt.get(this.type)},ki.Buffer.get=function(){return Yt.get(this.type)},Oi.getShapeKey=function(t){return this.type+t[0].toUpperCase()+t.substr(1)},Oi.expandBoundingBox=function(t,e){},Oi.valueToShape=function(t,e,r){var i,o,n=t._primitiveData[this.getShapeKey(e)];switch(this.fields[e]){case"v3":case"c":o=n,void 0!==(i=r).toArray?i=i.toArray():void 0!==i.x?i=[i.x,i.y,i.z]:void 0!==i.r&&(i=[i.r,i.g,i.b]),o.push.apply(o,i);break;default:n.push(r)}},Oi.objectToShape=function(e,r){var i=this;Object.keys(this.fields).forEach(function(t){i.valueToShape(e,t,r[t])}),this.valueToShape(e,"name",r.name),this.expandBoundingBox(e.boundingBox,r)},Oi.valueFromShape=function(t,e,r){var i=t._primitiveData[this.getShapeKey(r)];switch(this.fields[r]){case"v3":return(new fe.Vector3).fromArray(i,3*e);case"c":return(new fe.Color).fromArray(i,3*e);default:return i[e]}},Oi.objectFromShape=function(e,r){var i=this,t=this.valueFromShape(e,r,"name");void 0===t&&(t=this.type+": "+r+" ("+e.name+")");var o={shape:e,name:t};return Object.keys(this.fields).forEach(function(t){o[t]=i.valueFromShape(e,r,t)}),o},Oi.arrayFromShape=function(t,e){var r=t._primitiveData[this.getShapeKey(e)];switch(this.fields[e]){case"s":return r;default:return new Float32Array(r)}},Oi.dataFromShape=function(e){var r=this,i={};return this.Picker&&(i.picking=new this.Picker(e)),Object.keys(this.fields).forEach(function(t){i[t]=r.arrayFromShape(e,t)}),i},Oi.bufferFromShape=function(t,e){return new this.Buffer(this.dataFromShape(t),e)},Object.defineProperties(Oi,ki),Oi.type="",Oi.fields={};var Mi=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){return this.valueFromShape(t,e,"position")},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position))},e}(Oi);Mi.type="sphere",Mi.fields={position:"v3",color:"c",radius:"f"};var Bi=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){return this.valueFromShape(t,e,"position")},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position))},e}(Oi);Bi.type="box",Bi.fields={position:"v3",color:"c",size:"f",heightAxis:"v3",depthAxis:"v3"};var Ti=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(Bi);Ti.type="octahedron";var Di=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(Bi);Di.type="tetrahedron";var Ri=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){var r=this.valueFromShape(t,e,"position1"),i=this.valueFromShape(t,e,"position2");return r.add(i).multiplyScalar(.5)},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position1)),t.expandByPoint(Ii.fromArray(e.position2))},e.bufferFromShape=function(t,e){void 0===e&&(e={});var r=this.dataFromShape(t);return"cylinder"===this.type&&e.dashedCylinder&&(r=Ci(r)),new this.Buffer(r,e)},e}(Oi);Ri.type="cylinder",Ri.fields={position1:"v3",position2:"v3",color:"c",radius:"f"};var Fi=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(Ri);Fi.type="arrow";var Ei=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(Ri);Ei.type="cone";var $i=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(Mi);$i.type="ellipsoid",$i.fields={position:"v3",color:"c",radius:"f",majorAxis:"v3",minorAxis:"v3"};var Li=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}($i);Li.type="torus";var Ni=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){return this.valueFromShape(t,e,"position")},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position))},e}(Oi);Ni.type="text",Ni.fields={position:"v3",color:"c",size:"f",text:"s"};var zi=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){return this.valueFromShape(t,e,"position")},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position))},e}(Oi);zi.type="point",zi.fields={position:"v3",color:"c"};var ji=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).positionFromShape=function(t,e){var r=this.valueFromShape(t,e,"position1"),i=this.valueFromShape(t,e,"position2");return r.add(i).multiplyScalar(.5)},e.expandBoundingBox=function(t,e){t.expandByPoint(Ii.fromArray(e.position1)),t.expandByPoint(Ii.fromArray(e.position2))},e}(Oi);ji.type="wideline",ji.fields={position1:"v3",position2:"v3",color:"c"};var Vi=function(t,e){var r=this;this.exp=3;var i=e||function(t){for(var e=t.x,r=t.y,i=t.z,o=new fe.Box3,n=e.length,a=o.min,s=o.max,c=0;c<n;c++)a.x=Math.min(e[c],a.x),a.y=Math.min(r[c],a.y),a.z=Math.min(i[c],a.z),s.x=Math.max(e[c],s.x),s.y=Math.max(r[c],s.y),s.z=Math.max(i[c],s.z);return o}(t);this.minX=i.min.x,this.minY=i.min.y,this.minZ=i.min.z,this.boundX=1+(i.max.x-this.minX>>this.exp),this.boundY=1+(i.max.y-this.minY>>this.exp),this.boundZ=1+(i.max.z-this.minZ>>this.exp);for(var o=this.boundX*this.boundY*this.boundZ,n=void 0!==t.count?t.count:t.x.length,a=t.x,s=t.y,c=t.z,u=0,h=new Uint32Array(o),l=new Int32Array(n),p=0;p<n;++p){var d=a[p]-r.minX>>r.exp,f=s[p]-r.minY>>r.exp,m=c[p]-r.minZ>>r.exp,g=(d*r.boundY+f)*r.boundZ+m;1===(h[g]+=1)&&(u+=1),l[p]=g}for(var y=new Uint16Array(u),v=0,b=0;v<o;++v){var x=h[v];0<x&&(h[v]=b+1,y[b]=x,b+=1)}for(var _=new Uint32Array(u),w=1;w<u;++w)_[w]+=_[w-1]+y[w-1];for(var A=new Uint16Array(u),S=new Int32Array(n),C=0;C<n;++C){var P=h[l[C]];if(0<P){var I=P-1;S[_[I]+A[I]]=C,A[I]+=1}}this.grid=h,this.bucketCount=y,this.bucketOffset=_,this.bucketArray=S,this.xArray=a,this.yArray=s,this.zArray=c};Vi.prototype.within=function(t,e,r,i){var o=[];return this.eachWithin(t,e,r,i,function(t){return o.push(t)}),o},Vi.prototype.eachWithin=function(t,e,r,i,o){for(var n=this,a=i*i,s=Math.max(0,t-i-this.minX>>this.exp),c=Math.max(0,e-i-this.minY>>this.exp),u=Math.max(0,r-i-this.minZ>>this.exp),h=Math.min(this.boundX,1+(t+i-this.minX>>this.exp)),l=Math.min(this.boundY,1+(e+i-this.minY>>this.exp)),p=Math.min(this.boundZ,1+(r+i-this.minZ>>this.exp)),d=s;d<h;++d)for(var f=c;f<l;++f)for(var m=u;m<p;++m){var g=(d*n.boundY+f)*n.boundZ+m,y=n.grid[g];if(0<y)for(var v=y-1,b=n.bucketOffset[v],x=b+n.bucketCount[v],_=b;_<x;++_){var w=n.bucketArray[_],A=n.xArray[w]-t,S=n.yArray[w]-e,C=n.zArray[w]-r,P=A*A+S*S+C*C;P<=a&&o(w,P)}}};var Gi=function(t){void 0===t&&(t=0),this._fields=this._defaultFields,this._init(0)};Gi.prototype._init=function(t){this.length=t;for(var e=this.count=0,r=this._fields.length;e<r;++e){var i=this._fields[e],o=i[0],n=i[1],a=i[2];this._initField(o,n,a)}},Gi.prototype._initField=function(t,e,r){this[t]=A(r,this.length*e)},Gi.prototype.addField=function(t,e,r){this._fields.push([t,e,r]),this._initField(t,e,r)},Gi.prototype.resize=function(t){var e=this;this.length=Math.round(t||0),this.count=Math.min(this.count,this.length);for(var r=0,i=this._fields.length;r<i;++r){var o=e._fields[r][0],n=e._fields[r][1],a=e.length*n,s=new e[o].constructor(a);e[o].length>a?s.set(e[o].subarray(0,a)):s.set(e[o]),e[o]=s}},Gi.prototype.growIfFull=function(){if(this.count>=this.length){var t=Math.round(1.5*this.length);this.resize(Math.max(256,t))}},Gi.prototype.copyFrom=function(t,e,r,i){for(var o=0,n=this._fields.length;o<n;++o)for(var a=this._fields[o][0],s=this._fields[o][1],c=this[a],u=t[a],h=0;h<i;++h)for(var l=s*(e+h),p=s*(r+h),d=0;d<s;++d)c[l+d]=u[p+d]},Gi.prototype.copyWithin=function(t,e,r){for(var i=0,o=this._fields.length;i<o;++i)for(var n=this._fields[i][0],a=this._fields[i][1],s=this[n],c=0;c<r;++c)for(var u=a*(t+c),h=a*(e+c),l=0;l<a;++l)s[u+l]=s[h+l]},Gi.prototype.sort=function(c){me.time("Store.sort");var u=this,h=new this.constructor(1);!function t(e,r){if(e<r){var i=Math.floor((e+r)/2),o=e,n=r;do{for(;c(o,i)<0;)o+=1;for(;0<c(n,i);)n-=1;o<=n&&(o===i?i=n:n===i&&(i=o),(a=o)!==(s=n)&&(h.copyFrom(u,0,a,1),u.copyWithin(a,s,1),u.copyFrom(h,s,0,1)),o+=1,n-=1)}while(o<=n);t(e,n),t(o,r)}var a,s}(0,this.count-1),me.timeEnd("Store.sort")},Gi.prototype.clear=function(){this.count=0},Gi.prototype.dispose=function(){delete this.length,delete this.count;for(var t=0,e=this._fields.length;t<e;++t){delete this[this._fields[t][0]]}};var Ui=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["index1",1,"int32"],["index2",1,"int32"],["type",1,"int8"]]},e.prototype.addContact=function(t,e,r){this.growIfFull();var i=this.count;t<e?(this.index1[i]=t,this.index2[i]=e):(this.index2[i]=t,this.index1[i]=e),r&&(this.type[i]=r),this.count+=1},Object.defineProperties(e.prototype,r),e}(Gi);function Hi(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24}var Wi=function(t,e){this.length=t,this._words=new Uint32Array(t+32>>>5),!0===e&&this.setAll()};function qi(t){for(var e=t.edgeCount,r=t.nodeCount,i=t.nodeArray1,o=t.nodeArray2,n=new Uint8Array(r),a=new Int32Array(r),s=0;s<e;++s)n[i[s]]+=1,n[o[s]]+=1;for(var c=1;c<r;++c)a[c]+=a[c-1]+n[c-1];for(var u=2*e,h=new Int32Array(u),l=0;l<u;++l)h[l]=-1;for(var p=0;p<e;++p){for(var d=i[p],f=o[p],m=a[d];-1!==h[m]&&m<u;)m+=1;h[m]=p;for(var g=a[f];-1!==h[g]&&g<u;)g+=1;h[g]=p}return{countArray:n,offsetArray:a,indexArray:h}}function Xi(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),{type:t,group:e,x:0,y:0,z:0,atomSet:[]}}function Yi(t,e){t.x+=e.x,t.y+=e.y,t.z+=e.z,t.atomSet.push(e.index)}function Ki(t,e){var r=e.atomSet.length;if(0<r){var i=t.types,o=t.groups,n=t.centers,a=t.atomSets;i.push(e.type),o.push(e.group),n.x.push(e.x/r),n.y.push(e.y/r),n.z.push(e.z/r),a.push(e.atomSet)}}Wi.prototype.get=function(t){return 0!=(this._words[t>>>5]&1<<t)},Wi.prototype.set=function(t){this._words[t>>>5]|=1<<t},Wi.prototype.clear=function(t){this._words[t>>>5]&=~(1<<t)},Wi.prototype.flip=function(t){this._words[t>>>5]^=1<<t},Wi.prototype._assignRange=function(t,e,r){if(!(e<t)){for(var i=this._words,o=!0===r?4294967295:0,n=t>>>5,a=e>>>5,s=n;s<a;++s)i[s]=o;var c=n<<5,u=a<<5;if(!0===r)if(e-t<32)for(var h=t,l=e+1;h<l;++h)i[h>>>5]|=1<<h;else{for(var p=t,d=c;p<d;++p)i[p>>>5]|=1<<p;for(var f=u,m=e+1;f<m;++f)i[f>>>5]|=1<<f}else if(e-t<32)for(var g=t,y=e+1;g<y;++g)i[g>>>5]&=~(1<<g);else{for(var v=t,b=c;v<b;++v)i[v>>>5]&=~(1<<v);for(var x=u,_=e+1;x<_;++x)i[x>>>5]&=~(1<<x)}return this}},Wi.prototype.setRange=function(t,e){return this._assignRange(t,e,!0)},Wi.prototype.clearRange=function(t,e){return this._assignRange(t,e,!1)},Wi.prototype.setBits=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=this._words,i=t.length,o=0;o<i;++o){var n=t[o];r[n>>>5]|=1<<n}return this},Wi.prototype.clearBits=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=this._words,i=t.length,o=0;o<i;++o){var n=t[o];r[n>>>5]&=~(1<<n)}return this},Wi.prototype.setAll=function(){return this._assignRange(0,this.length-1,!0)},Wi.prototype.clearAll=function(){return this._assignRange(0,this.length-1,!1)},Wi.prototype.flipAll=function(){for(var t=this._words.length,e=this._words,r=32-this.length%32,i=0;i<t-1;++i)e[i]=~e[i];return e[t-1]=~(e[t-1]<<r)>>>r,this},Wi.prototype._isRangeValue=function(t,e,r){if(!(e<t)){for(var i=this._words,o=!0===r?4294967295:0,n=t>>>5,a=e>>>5,s=n;s<a;++s)if(i[s]!==o)return!1;if(e-t<32){for(var c=t,u=e+1;c<u;++c)if(!!(i[c>>>5]&1<<c)!==r)return!1}else{for(var h=a<<5,l=t,p=n<<5<<5;l<p;++l)if(!!(i[l>>>5]&1<<l)!==r)return!1;for(var d=h,f=e+1;d<f;++d)if(!!(i[d>>>5]&1<<d)!==r)return!1}return!0}},Wi.prototype.isRangeSet=function(t,e){return this._isRangeValue(t,e,!0)},Wi.prototype.isRangeClear=function(t,e){return this._isRangeValue(t,e,!1)},Wi.prototype.isAllSet=function(){return this._isRangeValue(0,this.length-1,!0)},Wi.prototype.isAllClear=function(){return this._isRangeValue(0,this.length-1,!1)},Wi.prototype.isSet=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=this._words,i=t.length,o=0;o<i;++o){var n=t[o];if(0==(r[n>>>5]&1<<n))return!1}return!0},Wi.prototype.isClear=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=this._words,i=t.length,o=0;o<i;++o){var n=t[o];if(0!=(r[n>>>5]&1<<n))return!1}return!0},Wi.prototype.isEqualTo=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0;o<i;++o)if(e[o]!==r[o])return!1;return!0},Wi.prototype.getSize=function(){for(var t=this._words.length,e=this._words,r=0,i=0;i<t;++i)r+=Hi(e[i]);return r},Wi.prototype.difference=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0;o<i;++o)e[o]=e[o]&~r[o];for(var n=e.length;n<i;++n)e[n]=0;return this},Wi.prototype.union=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0;o<i;++o)e[o]|=r[o];for(var n=e.length;n<i;++n)e[n]=0;return this},Wi.prototype.intersection=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0;o<i;++o)e[o]&=r[o];for(var n=e.length;n<i;++n)e[n]=0;return this},Wi.prototype.intersects=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0;o<i;++o)if(0!=(e[o]&r[o]))return!0;return!1},Wi.prototype.getIntersectionSize=function(t){for(var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=0,n=0;n<i;++n)o+=Hi(e[n]&r[n]);return o},Wi.prototype.makeIntersection=function(t){var e=this._words,r=t._words,i=Math.min(e.length,r.length),o=new Uint32Array(i),n=Object.create(Wi.prototype);n._words=o,n.length=Math.min(this.length,t.length);for(var a=0;a<i;++a)o[a]=e[a]&r[a];return n},Wi.prototype.forEach=function(t){for(var e=this._words.length,r=this._words,i=0,o=0;o<e;++o)for(var n=r[o];0!==n;){var a=n&-n;t((o<<5)+Hi(a-1),i),n^=a,++i}},Wi.prototype.toArray=function(){for(var t=this._words,e=new Array(this.getSize()),r=this._words.length,i=0,o=0;o<r;++o)for(var n=t[o];0!==n;){var a=n&-n;e[i++]=(o<<5)+Hi(a-1),n^=a}return e},Wi.prototype.toString=function(){return"{"+this.toArray().join(",")+"}"},Wi.prototype.toSeleString=function(){var t=this.toArray().join(",");return t?"@"+t:"NONE"},Wi.prototype.clone=function(){var t=Object.create(Wi.prototype);return t.length=this.length,t._words=new Uint32Array(this._words),t};var Zi=0,Qi=["D-BETA-PEPTIDE, C-GAMMA LINKING","D-GAMMA-PEPTIDE, C-DELTA LINKING","D-PEPTIDE COOH CARBOXY TERMINUS","D-PEPTIDE NH3 AMINO TERMINUS","D-PEPTIDE LINKING","L-BETA-PEPTIDE, C-GAMMA LINKING","L-GAMMA-PEPTIDE, C-DELTA LINKING","L-PEPTIDE COOH CARBOXY TERMINUS","L-PEPTIDE NH3 AMINO TERMINUS","L-PEPTIDE LINKING","PEPTIDE LINKING","PEPTIDE-LIKE"],Ji=["RNA OH 3 PRIME TERMINUS","RNA OH 5 PRIME TERMINUS","RNA LINKING"],to=["DNA OH 3 PRIME TERMINUS","DNA OH 5 PRIME TERMINUS","DNA LINKING","L-DNA LINKING","L-RNA LINKING"],eo=["D-SACCHARIDE","D-SACCHARIDE 1,4 AND 1,4 LINKING","D-SACCHARIDE 1,4 AND 1,6 LINKING","L-SACCHARIDE","L-SACCHARIDE 1,4 AND 1,4 LINKING","L-SACCHARIDE 1,4 AND 1,6 LINKING","SACCHARIDE"],ro=["NON-POLYMER"].concat(["OTHER"],eo),io=["h","g","i"],oo=["e","b"],no=["s","t","l",""],ao={H:1,D:1,T:1,HE:2,LI:3,BE:4,B:5,C:6,N:7,O:8,F:9,NE:10,NA:11,MG:12,AL:13,SI:14,P:15,S:16,CL:17,AR:18,K:19,CA:20,SC:21,TI:22,V:23,CR:24,MN:25,FE:26,CO:27,NI:28,CU:29,ZN:30,GA:31,GE:32,AS:33,SE:34,BR:35,KR:36,RB:37,SR:38,Y:39,ZR:40,NB:41,MO:42,TC:43,RU:44,RH:45,PD:46,AG:47,CD:48,IN:49,SN:50,SB:51,TE:52,I:53,XE:54,CS:55,BA:56,LA:57,CE:58,PR:59,ND:60,PM:61,SM:62,EU:63,GD:64,TB:65,DY:66,HO:67,ER:68,TM:69,YB:70,LU:71,HF:72,TA:73,W:74,RE:75,OS:76,IR:77,PT:78,AU:79,HG:80,TL:81,PB:82,BI:83,PO:84,AT:85,RN:86,FR:87,RA:88,AC:89,TH:90,PA:91,U:92,NP:93,PU:94,AM:95,CM:96,BK:97,CF:98,ES:99,FM:100,MD:101,NO:102,LR:103,RF:104,DB:105,SG:106,BH:107,HS:108,MT:109,DS:110,RG:111,CN:112,NH:113,FL:114,MC:115,LV:116,TS:117,OG:118},so={1:1.1,2:1.4,3:1.81,4:1.53,5:1.92,6:1.7,7:1.55,8:1.52,9:1.47,10:1.54,11:2.27,12:1.73,13:1.84,14:2.1,15:1.8,16:1.8,17:1.75,18:1.88,19:2.75,20:2.31,21:2.3,22:2.15,23:2.05,24:2.05,25:2.05,26:2.05,27:2,28:2,29:2,30:2.1,31:1.87,32:2.11,33:1.85,34:1.9,35:1.83,36:2.02,37:3.03,38:2.49,39:2.4,40:2.3,41:2.15,42:2.1,43:2.05,44:2.05,45:2,46:2.05,47:2.1,48:2.2,49:2.2,50:1.93,51:2.17,52:2.06,53:1.98,54:2.16,55:3.43,56:2.68,57:2.5,58:2.48,59:2.47,60:2.45,61:2.43,62:2.42,63:2.4,64:2.38,65:2.37,66:2.35,67:2.33,68:2.32,69:2.3,70:2.28,71:2.27,72:2.25,73:2.2,74:2.1,75:2.05,76:2,77:2,78:2.05,79:2.1,80:2.05,81:1.96,82:2.02,83:2.07,84:1.97,85:2.02,86:2.2,87:3.48,88:2.83,89:2,90:2.4,91:2,92:2.3,93:2,94:2,95:2,96:2,97:2,98:2,99:2,100:2,101:2,102:2,103:2,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:2,114:2,115:2,116:2,117:2,118:2},co={1:.31,2:.28,3:1.28,4:.96,5:.84,6:.76,7:.71,8:.66,9:.57,10:.58,11:1.66,12:1.41,13:1.21,14:1.11,15:1.07,16:1.05,17:1.02,18:1.06,19:2.03,20:1.76,21:1.7,22:1.6,23:1.53,24:1.39,25:1.39,26:1.32,27:1.26,28:1.24,29:1.32,30:1.22,31:1.22,32:1.2,33:1.19,34:1.2,35:1.2,36:1.16,37:2.2,38:1.95,39:1.9,40:1.75,41:1.64,42:1.54,43:1.47,44:1.46,45:1.42,46:1.39,47:1.45,48:1.44,49:1.42,50:1.39,51:1.39,52:1.38,53:1.39,54:1.4,55:2.44,56:2.15,57:2.07,58:2.04,59:2.03,60:2.01,61:1.99,62:1.98,63:1.98,64:1.96,65:1.94,66:1.92,67:1.92,68:1.89,69:1.9,70:1.87,71:1.87,72:1.75,73:1.7,74:1.62,75:1.51,76:1.44,77:1.41,78:1.36,79:1.36,80:1.32,81:1.45,82:1.46,83:1.48,84:1.4,85:1.5,86:1.5,87:2.6,88:2.21,89:2.15,90:2.06,91:2,92:1.96,93:1.9,94:1.87,95:1.8,96:1.69,97:1.6,98:1.6,99:1.6,100:1.6,101:1.6,102:1.6,103:1.6,104:1.6,105:1.6,106:1.6,107:1.6,108:1.6,109:1.6,110:1.6,111:1.6,112:1.6,113:1.6,114:1.6,115:1.6,116:1.6,117:1.6,118:1.6},uo={1:[1],2:[0],3:[1],4:[2],5:[3],6:[4],7:[3],8:[2],9:[1],10:[0],11:[1],12:[2],13:[6],14:[6],15:[3,5,7],16:[2,4,6],17:[1],18:[0],19:[1],20:[2],31:[3],32:[4],33:[3,5],34:[2,4,6],35:[1],36:[0],37:[1],38:[2],49:[3],50:[4],51:[3,5],52:[2],53:[1,2,5],54:[0,2],55:[1],56:[2],81:[3],82:[4],83:[3],84:[2],85:[1],86:[0],87:[1],88:[2]},ho={1:1,2:2,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:1,12:2,13:3,14:4,15:5,16:6,17:7,18:8,19:1,20:2,21:3,22:4,23:5,24:6,25:7,26:8,27:9,28:10,29:11,30:2,31:3,32:4,33:5,34:6,35:7,36:8,37:1,38:2,39:3,40:4,41:5,42:6,43:7,44:8,45:9,46:10,47:11,48:2,49:3,50:4,51:5,52:6,53:7,54:8,55:1,56:2,57:3,58:4,59:3,60:4,61:5,62:6,63:7,64:8,65:9,66:10,67:11,68:12,69:13,70:14,71:15,72:4,73:5,74:6,75:7,76:8,77:9,78:10,79:11,80:2,81:3,82:4,83:5,84:6,85:7,86:8,87:1,88:2,89:3,90:4,91:3,92:4,93:5,94:6,95:7,96:8,97:9,98:10,99:11,100:12,101:13,102:14,103:15,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:3,114:4,115:5,116:6,117:7,118:8},lo={ALA:[.17,.5,.33],ARG:[.81,1.81,1],ASN:[.42,.85,.43],ASP:[1.23,3.64,2.41],ASH:[-.07,.43,.5],CYS:[-.24,-.02,.22],GLN:[.58,.77,.19],GLU:[2.02,3.63,1.61],GLH:[-.01,.11,.12],GLY:[.01,1.15,1.14],HIS:[.17,.11,-.06],ILE:[-.31,-1.12,-.81],LEU:[-.56,-1.25,-.69],LYS:[.99,2.8,1.81],MET:[-.23,-.67,-.44],PHE:[-1.13,-1.71,-.58],PRO:[.45,.14,-.31],SER:[.13,.46,.33],THR:[.14,.25,.11],TRP:[-1.85,-2.09,-.24],TYR:[-.94,-.71,.23],VAL:[.07,-.46,-.53]},po=[0,0,0],fo={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",SEC:"U",PYL:"O"},mo=Object.keys(fo),go=["A","C","T","G","U","I"],yo=["DA","DC","DT","DG","DU","DI"],vo=["A","G","I","DA","DG","DI"],bo=go.concat(yo),xo=["SOL","WAT","HOH","H2O","W","DOD","D3O","TIP3","TIP4","SPC"],_o=["118","119","1AL","1CU","2FK","2HP","2OF","3CO","3MT","3NI","3OF","3P8","4MO","4PU","543","6MO","ACT","AG","AL","ALF","AM","ATH","AU","AU3","AUC","AZI","BA","BCT","BEF","BF4","BO4","BR","BS3","BSY","CA","CAC","CD","CD1","CD3","CD5","CE","CHT","CL","CO","CO3","CO5","CON","CR","CS","CSB","CU","CU1","CU3","CUA","CUZ","CYN","DME","DMI","DSC","DTI","DY","E4N","EDR","EMC","ER3","EU","EU3","F","FE","FE2","FPO","GA","GD3","GEP","HAI","HG","HGC","IN","IOD","IR","IR3","IRI","IUM","K","KO4","LA","LCO","LCP","LI","LU","MAC","MG","MH2","MH3","MLI","MLT","MMC","MN","MN3","MN5","MN6","MO1","MO2","MO3","MO4","MO5","MO6","MOO","MOS","MOW","MW1","MW2","MW3","NA","NA2","NA5","NA6","NAO","NAW","NCO","NET","NH4","NI","NI1","NI2","NI3","NO2","NO3","NRU","O4M","OAA","OC1","OC2","OC3","OC4","OC5","OC6","OC7","OC8","OCL","OCM","OCN","OCO","OF1","OF2","OF3","OH","OS","OS4","OXL","PB","PBM","PD","PDV","PER","PI","PO3","PO4","PR","PT","PT4","PTN","RB","RH3","RHD","RU","SB","SCN","SE4","SEK","SM","SMO","SO3","SO4","SR","T1A","TB","TBA","TCN","TEA","TH","THE","TL","TMA","TRA","UNX","V","VN3","VO4","W","WO5","Y1","YB","YB2","YH","YT3","ZCM","ZN","ZN2","ZN3","ZNO","ZO3","OHX"],wo=["045","0AT","0BD","0MK","0NZ","0TS","0V4","0XY","0YT","10M","147","149","14T","15L","16G","18T","18Y","1AR","1BW","1GL","1GN","1JB","1LL","1NA","1S3","26M","26Q","26R","26V","26W","26Y","27C","289","291","293","2DG","2F8","2FG","2FL","2FP","2GL","2M4","2M5","32O","34V","3CM","3DO","3DY","3FM","3LR","3MF","3MG","3SA","3ZW","46D","46M","46Z","48Z","4CQ","4GC","4NN","50A","5DI","5GF","5MM","5RP","5SA","5SP","64K","6PG","6SA","7JZ","7SA","A1Q","A2G","AAB","AAL","AAO","ABC","ABD","ABE","ABF","ABL","ACG","ACI","ACR","ACX","ADA","ADG","ADR","AF1","AFD","AFL","AFO","AFP","AFR","AGC","AGH","AGL","AHR","AIG","ALL","ALX","AMU","AOG","AOS","ARA","ARB","ARE","ARI","ASG","ASO","AXP","AXR","B0D","B16","B2G","B4G","B6D","B8D","B9D","BBK","BCD","BDG","BDP","BDR","BEM","BFP","BGC","BGL","BGP","BGS","BHG","BMA","BMX","BNG","BNX","BOG","BRI","BXF","BXP","BXX","BXY","C3X","C4X","C5X","CAP","CBI","CBK","CBS","CDR","CEG","CGF","CHO","CR1","CR6","CRA","CT3","CTO","CTR","CTT","D6G","DAF","DAG","DDA","DDB","DDL","DEL","DFR","DFX","DG0","DGC","DGD","DGM","DGS","DIG","DLF","DLG","DMU","DNO","DOM","DP5","DQQ","DQR","DR2","DR3","DR4","DRI","DSR","DT6","DVC","E4P","E5G","EAG","EBG","EBQ","EGA","EJT","EPG","ERE","ERI","F1P","F1X","F6P","FBP","FCA","FCB","FCT","FDP","FDQ","FFC","FIX","FMO","FRU","FSI","FU4","FUB","FUC","FUD","FUL","FXP","G16","G1P","G2F","G3I","G4D","G4S","G6D","G6P","G6S","GAC","GAD","GAL","GC1","GC4","GCD","GCN","GCO","GCS","GCT","GCU","GCV","GCW","GCX","GE1","GFG","GFP","GIV","GL0","GL2","GL5","GL6","GL7","GL9","GLA","GLB","GLC","GLD","GLF","GLG","GLO","GLP","GLS","GLT","GLW","GMH","GN1","GNX","GP1","GP4","GPH","GPM","GQ1","GQ2","GQ4","GS1","GS4","GSA","GSD","GTE","GTH","GTK","GTR","GTZ","GU0","GU1","GU2","GU3","GU4","GU5","GU6","GU8","GU9","GUF","GUP","GUZ","GYP","GYV","H2P","HDL","HMS","HS2","HSD","HSG","HSH","HSJ","HSQ","HSR","HSU","HSX","HSY","HSZ","IAB","IDG","IDR","IDS","IDT","IDU","IDX","IDY","IMK","IN1","IPT","ISL","KBG","KD2","KDA","KDM","KDO","KFN","KO1","KO2","KTU","L6S","LAG","LAI","LAK","LAO","LAT","LB2","LBT","LCN","LDY","LGC","LGU","LM2","LMT","LMU","LOG","LOX","LPK","LSM","LTM","LVZ","LXB","LXZ","M1F","M3M","M6P","M8C","MA1","MA2","MA3","MAB","MAG","MAL","MAN","MAT","MAV","MAW","MBG","MCU","MDA","MDM","MDP","MFA","MFB","MFU","MG5","MGA","MGL","MLB","MMA","MMN","MN0","MRP","MTT","MUG","MVP","MXY","N1L","N9S","NAA","NAG","NBG","NDG","NED","NG1","NG6","NGA","NGB","NGC","NGE","NGF","NGL","NGS","NGY","NHF","NM6","NM9","NTF","NTO","NTP","NXD","NYT","OPG","OPM","ORP","OX2","P3M","P53","P6P","PA5","PNA","PNG","PNW","PRP","PSJ","PSV","PTQ","QDK","QPS","QV4","R1P","R1X","R2B","R5P","RAA","RAE","RAF","RAM","RAO","RAT","RB5","RBL","RCD","RDP","REL","RER","RF5","RG1","RGG","RHA","RIB","RIP","RNS","RNT","ROB","ROR","RPA","RST","RUB","RUU","RZM","S6P","S7P","SA0","SCR","SDD","SF6","SF9","SG4","SG5","SG6","SG7","SGA","SGC","SGD","SGN","SGS","SHB","SHG","SI3","SIO","SOE","SOL","SSG","SUC","SUP","SUS","T6P","T6T","TAG","TCB","TDG","TGK","TGY","TH1","TIA","TM5","TM6","TM9","TMR","TMX","TOA","TOC","TRE","TYV","UCD","UDC","VG1","X0X","X1X","X2F","X4S","X5S","X6X","XBP","XDN","XDP","XIF","XIM","XLF","XLS","XMM","XUL","XXR","XYP","XYS","YO5","Z3Q","Z6J","Z9M","ZDC","ZDM"],Ao=["CA","C","N","O","O1","O2","OC1","OC2","OX1","OXT","H","H1","H2","H3","HA","HN","BB"],So=["P","OP1","OP2","HOP2","HOP3","O2'","O3'","O4'","O5'","C1'","C2'","C3'","C4'","C5'","H1'","H2'","H2''","HO2'","H3'","H4'","H5'","H5''","HO3'","HO5'","O2*","O3*","O4*","O5*","C1*","C2*","C3*","C4*","C5*"],Co={};function Po(t){switch(t){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;default:return 8}}Co[1]={trace:"CA",direction1:"C",direction2:["O","OC1","O1","OX1","OXT"],backboneStart:"N",backboneEnd:"C"},Co[2]={trace:["C4'","C4*"],direction1:["C1'","C1*"],direction2:["C3'","C3*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},Co[3]={trace:["C3'","C3*"],direction1:["C2'","C2*"],direction2:["O4'","O4*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},Co[4]={trace:["CA","BB"],backboneStart:["CA","BB"],backboneEnd:["CA","BB"]},Co[5]={trace:["C4'","C4*","P"],backboneStart:["C4'","C4*","P"],backboneEnd:["C4'","C4*","P"]},Co[6]={trace:["C3'","C3*","C2'","P"],backboneStart:["C3'","C3*","C2'","P"],backboneEnd:["C3'","C3*","C2'","P"]},Co[Zi]={};var Io=new Map([[2,et(180)],[3,et(120)],[4,et(109.4721)],[6,et(90)]]);function Oo(e,t){var r=[],i=new fe.Vector3,o=new fe.Vector3;return i.subVectors(t,e),e.eachBondedAtom(function(t){1!==t.number&&(o.subVectors(t,e),r.push(i.angleTo(o)))}),r}function ko(e,t){var r=e.clone(),i=new fe.Vector3;i.subVectors(t,e);var o=[new fe.Vector3,new fe.Vector3],n=0;if(e.eachBondedAtom(function(t){1<n||1!==t.number&&(r.index=t.index,o[n++].subVectors(t,e))}),1===n&&r.eachBondedAtom(function(t){1<n||1!==t.number&&t.index!==e.index&&o[n++].subVectors(t,e)}),2===n){var a=o[0].cross(o[1]);return Math.abs(Math.PI/2-a.angleTo(i))}}function Mo(t,s){var e=t.structure,r=e.atomCount,c=new Int8Array(r),u=new Int8Array(r),h=new Int8Array(r),l=new Int8Array(r);return e.eachAtom(function(t){var e=t.index,r=function(i,t){var e,r=i.bondToElementCount(1),o=i.formalCharge||0,n="always"===t.assignCharge||"auto"===t.assignCharge&&0===o,a="always"===t.assignH||"auto"===t.assignH&&0===r,s=i.bondCount,c=(e=0,i.eachBond(function(t){return e+=t.bondOrder}),e),u=function(e){var i=e.structure.getBondProxy(),t=e.number,o=8===t||7===t;if(o&&4===e.bondCount)return!1;var n=!1;return e.eachBond(function(t){if(1<t.bondOrder)n=!0;else if(o){var r=t.getOtherAtom(e);r.eachBond(function(t){if(1<t.bondOrder){var e=r.number;if((15===e||16===e)&&8===t.getOtherAtom(r).number)return;n=!0}},i)}}),n}(i),h=0<c-s,l=0,p=8;switch(i.number){case 1:n&&(0===s?(o=1,p=0):1===s&&(o=0,p=1));break;case 6:n&&(o=0),a&&(l=Math.max(0,4-c-Math.abs(o))),p=Po(s+l+Math.max(0,-o));break;case 7:if(n)if(a)if(u&&c<4)o=s-r==1&&c-r==2?1:0;else{var d=!1;i.eachBondedAtom(function(t){(16===t.number||t.isMetal())&&(d=!0)}),o=d?0:1}else o=c-3;a&&(l=Math.max(0,3-c+o)),p=Po(u&&!h?s+l-o:s+l+1-o);break;case 8:n&&(a||(o=c-2),1===c&&i.eachBondedAtom(function(r){r.eachBond(function(t){var e=t.getOtherAtom(r);e.index!==i.index&&8===e.number&&2===t.bondOrder&&(o=-1)})})),a&&(l=Math.max(0,2-c+o)),p=Po(u&&!h?s+l-o+1:s+l-o+2);break;case 16:n&&(a||(o=c<=3&&!i.bondToElementCount(8)?c-2:0)),a&&c<2&&(l=Math.max(0,2-c+o)),c<=3&&(p=Po(s+l-o+2));break;case 9:case 17:case 35:case 53:case 85:n&&(o=c-1);break;case 3:case 11:case 19:case 37:case 55:case 87:n&&(o=1-c);break;case 4:case 12:case 20:case 38:case 56:case 88:n&&(o=2-c);break;default:console.warn("Requested charge, protonation for an unhandled element",i.element)}return[o,l,l+r,p]}(t,s),i=r[0],o=r[1],n=r[2],a=r[3];c[e]=i,u[e]=o,h[e]=n,l[e]=a}),{charge:c,implicitH:u,totalH:h,idealGeometry:l}}function Bo(t){if(t["@valenceModel"])return t["@valenceModel"];var e=Mo(t,{assignCharge:"auto",assignH:"auto"});return t["@valenceModel"]=e}function To(t){return 15===t.number&&t.bondToElementCount(8)===t.bondCount}var Do=["ARG","HIS","LYS"],Ro=["GLU","ASP"];function Fo(t,e,r){void 0===r&&(r={});for(var f=st(r.maxIonicDist,Uo.maxIonicDist),i=st(r.maxPiStackingDist,Uo.maxPiStackingDist),m=st(r.maxPiStackingOffset,Uo.maxPiStackingOffset),g=st(r.maxPiStackingAngle,Uo.maxPiStackingAngle),o=st(r.maxCationPiDist,Uo.maxCationPiDist),y=st(r.maxCationPiOffset,Uo.maxCationPiOffset),v=st(r.masterModelIndex,Uo.masterModelIndex),n=Math.max(f+2,i,o),b=i*i,x=o*o,a=e.features,s=e.spatialHash,c=e.contactStore,u=e.featureSet,_=a.types,h=a.centers,w=a.atomSets,l=h.x,p=h.y,A=h.z,d=_.length,S=t.atomStore.x,C=t.atomStore.y,P=t.atomStore.z,I=t.getAtomProxy(),O=t.getAtomProxy(),k=new fe.Vector3,M=new fe.Vector3,B=new fe.Vector3,T=new fe.Vector3,D=new fe.Vector3,R=new fe.Vector3,F=new fe.Vector3,E=function(t,e){k.set(S[t[0]],C[t[0]],P[t[0]]),M.set(S[t[1]],C[t[1]],P[t[1]]),B.set(S[t[2]],C[t[2]],P[t[2]]),T.subVectors(k,M),D.subVectors(k,B),e.crossVectors(T,D)},$=function(t,e,r){return k.set(l[t],p[t],A[t]),M.set(l[e],p[e],A[e]),k.sub(M).projectOnPlane(r).add(M).distanceTo(M)},L=function(t,e,r){u.setBits(t,e),c.addContact(t,e,r)},N=function(d){s.eachWithin(l[d],p[d],A[d],n,function(t,e){if(!(t<=d||(I.index=w[d][0],O.index=w[t][0],Wo(I,O,v)))){var r,i,o,n,a,s=_[d],c=_[t];if(a=c,2===(n=s)&&1===a||1===n&&2===a)(function(t,e,r){for(var i=t.length,o=e.length,n=0;n<i;++n){I.index=t[n];for(var a=0;a<o;++a)if(O.index=e[a],I.distanceTo(O)<=r)return!0}return!1})(w[d],w[t],f)&&L(d,t,1);else if(o=c,3===s&&3===o){if(e<=b){E(w[d],R),E(w[t],F);var u=j(R.angleTo(F));Math.min($(d,t,F),$(t,d,R))<=m&&(u<=g||180-g<=u?L(d,t,3):u<=g+90&&90-g<=u&&L(d,t,3))}}else if(i=c,(3===(r=s)&&1===i||1===r&&3===i)&&e<=x){var h=3===s?[d,t]:[t,d],l=h[0],p=h[1];E(w[l],R),$(p,l,R)<=y&&L(l,p,2)}}})},z=0;z<d;++z)N(z)}function Eo(t){return"HIS"===t.resname&&7==t.number&&t.isRing()}var $o=[3,11,19,37,55,12,20,38,56,13,31,49,81,21,50,82,83,51,80];var Lo=[17,35,53,85];var No=[7,8,16],zo=[6,7,15,16];var jo=et(180),Vo=et(120);function Go(t,e,r){return!Ho(t,e,r)&&(t.modelIndex!==e.modelIndex||t.altloc&&e.altloc&&t.altloc!==e.altloc)}var Uo={maxHydrophobicDist:4,maxHbondDist:3.5,maxHbondSulfurDist:4.1,maxHbondAccAngle:45,maxHbondDonAngle:45,maxHbondAccPlaneAngle:90,maxHbondDonPlaneAngle:30,maxPiStackingDist:5.5,maxPiStackingOffset:2,maxPiStackingAngle:30,maxCationPiDist:6,maxCationPiOffset:2,maxIonicDist:5,maxHalogenBondDist:4,maxHalogenBondAngle:30,maxMetalDist:3,refineSaltBridges:!0,masterModelIndex:-1,lineOfSightDistFactor:1};function Ho(t,e,r){return t.modelIndex===r&&e.modelIndex!==r||e.modelIndex===r&&t.modelIndex!==r}function Wo(t,e,r){return!Ho(t,e,r)&&(t.modelIndex!==e.modelIndex||t.residueIndex===e.residueIndex||t.altloc&&e.altloc&&t.altloc!==e.altloc)}function qo(t){var e,s,r,c,i,u,o,h,n,a,l,p,d,f,m,g,y,v,b,x,_,w,A,S,C,P,I,O,k={types:[],groups:[],centers:{x:[],y:[],z:[]},atomSets:[]};return de.Debug&&me.time("calculateFeatures"),s=k,r=Bo((e=t).data).charge,c={},e.eachResidue(function(t){if(Do.includes(t.resname)){var e=Xi(1);t.eachAtom(function(t){7===t.number&&t.isSidechain()&&Yi(e,t)}),Ki(s,e)}else mo.includes(t.resname)||t.isNucleic()||(t.eachAtom(function(t){var e,r,i,o,n=!1,a=Xi(1);o=0,6===(i=t).number&&3===i.bondCount&&3===i.bondToElementCount(7)&&i.eachBondedAtom(function(t){t.bondCount-t.bondToElementCount(1)==1&&++o}),2===o?(a.group=8,n=!0):(r=0,6===(e=t).number&&3===e.bondCount&&2===e.bondToElementCount(7)&&1===e.bondToElementCount(6)&&e.eachBondedAtom(function(t){t.bondCount-t.bondToElementCount(1)==1&&++r}),2===r&&(a.group=9,n=!0)),n&&(t.eachBondedAtom(function(t){7===t.number&&(c[t.index]=!0,Yi(a,t))}),Ki(s,a))}),t.eachAtom(function(t){var e=Xi(1);0<r[t.index]&&(c[t.index]||(Yi(e,t),Ki(s,e)))}))}),u=k,o=Bo((i=t).data).charge,h={},i.eachResidue(function(t){if(Ro.includes(t.resname)){var e=Xi(2);t.eachAtom(function(t){8===t.number&&t.isSidechain()&&Yi(e,t)}),Ki(u,e)}else if(bo.includes(t.resname)){var r=Xi(2);t.eachAtom(function(t){To(t)&&(r.group=6,t.eachBondedAtom(function(t){8===t.number&&Yi(r,t)}),Ki(u,r))})}else mo.includes(t.resname)||bo.includes(t.resname)||(t.eachAtom(function(t){var e,r,i,o,n=!1,a=Xi(2);16===(o=t).number&&3===o.bondToElementCount(8)?(a.group=4,n=!0):To(t)?(a.group=6,n=!0):16===(i=t).number&&4===i.bondToElementCount(8)?(a.group=5,n=!0):(r=0,6===(e=t).number&&2===e.bondToElementCount(8)&&1===e.bondToElementCount(6)&&e.eachBondedAtom(function(t){8===t.number&&t.bondCount-t.bondToElementCount(1)==1&&++r}),2===r&&(a.group=10,n=!0)),n&&(t.eachBondedAtom(function(t){8===t.number&&(h[t.index]=!0,Yi(a,t))}),Ki(u,a))}),t.eachAtom(function(t){var e=Xi(2);o[t.index]<0&&(h[t.index]||(Yi(e,t),Ki(u,e)))}))}),a=k,l=(n=t).getAtomProxy(),n.eachResidue(function(t){var e=t.getAromaticRings();if(e){var r=t.atomOffset;e.forEach(function(t){var e=Xi(3);t.forEach(function(t){l.index=t+r,Yi(e,l)}),Ki(a,e)})}}),d=k,f=Bo((p=t).data),m=f.charge,g=f.implicitH,y=f.idealGeometry,p.eachAtom(function(t){var e=Xi(5),r=t.number;if(8===r)Yi(e,t),Ki(d,e);else if(7===r){if(Eo(t))Yi(e,t),Ki(d,e);else if(m[t.index]<1){var i=t.bondCount+g[t.index],o=y[t.index];(4===o&&i<4||3===o&&i<3||2===o&&i<2)&&(Yi(e,t),Ki(d,e))}}else 16===r&&("CYS"!==t.resname&&"MET"!==t.resname&&-1!==t.formalCharge||(Yi(e,t),Ki(d,e)))}),b=k,x=Bo((v=t).data).totalH,v.eachAtom(function(t){var e=Xi(4),r=t.number;Eo(t)?(Yi(e,t),Ki(b,e)):0<x[t.index]&&(7===r||8===r||16===r)&&(Yi(e,t),Ki(b,e))}),w=k,A=Bo((_=t).data).totalH,_.eachAtom(function(t){if(6===t.number&&0<A[t.index]&&(0<t.bondToElementCount(7)||0<t.bondToElementCount(8)||function(i){if(!i.isAromatic())return!1;var t=i.residueType.getRings();if(!t)return!1;var e=!1;return t.rings.forEach(function(t){e||t.some(function(t){return i.index-i.residueAtomOffset===t})&&(e=t.some(function(t){var e=i.residueType.atomTypeIdList[t],r=i.atomMap.get(e).number;return 7===r||8===r}))}),e}(t))){var e=Xi(9);Yi(e,t),Ki(w,e)}}),S=k,t.eachAtom(function(t){var e=!1,r=!1,i=mo.includes(t.resname),o=bo.includes(t.resname);if(i||o?i?8===t.number?["ASP","GLU","SER","THR","TYR","ASN","GLN"].includes(t.resname)&&t.isSidechain()?r=e=!0:t.isBackbone()&&(r=e=!0):16===t.number&&"CYS"===t.resname?r=e=!0:7===t.number&&"HIS"===t.resname&&t.isSidechain()&&(e=!0):o&&(8===t.number&&t.isBackbone()?r=e=!0:["N3","N4","N7"].includes(t.atomname)?e=!0:["O2","O4","O6"].includes(t.atomname)&&(r=e=!0)):t.isHalogen()||8===t.number||16===t.number?r=e=!0:7===t.number&&(e=!0),e){var n=Xi(11);Yi(n,t),Ki(S,n)}if(r){var a=Xi(10);Yi(a,t),Ki(S,a)}}),C=k,t.eachAtom(function(t){if(t.isTransitionMetal()||30===t.number||48===t.number){var e=Xi(12);Yi(e,t),Ki(C,e)}else if($o.includes(t.number)){var r=Xi(13);Yi(r,t),Ki(C,r)}}),P=k,t.eachAtom(function(t){var e=Xi(8),r=!1;6===t.number?(r=!0,t.eachBondedAtom(function(t){var e=t.number;6!==e&&1!==e&&(r=!1)})):9===t.number&&(r=!0),r&&(Yi(e,t),Ki(P,e))}),I=k,t.eachAtom(function(t){if(No.includes(t.number)){var e=!1;if(t.eachBondedAtom(function(t){zo.includes(t.number)&&(e=!0)}),e){var r=Xi(7);Yi(r,t),Ki(I,r)}}}),O=k,t.eachAtom(function(t){if(Lo.includes(t.number)&&1===t.bondToElementCount(6)){var e=Xi(6);Yi(e,t),Ki(O,e)}}),de.Debug&&me.timeEnd("calculateFeatures"),k}function Xo(t,e){void 0===e&&(e=Uo);var r,i,o,n=qo(t),a=(i=(r=n).types,o=r.centers,{features:r,spatialHash:new Vi(o),contactStore:new Ui,featureSet:new Wi(i.length,!1)});de.Debug&&me.time("calculateContacts"),Fo(t,a,e),function(t,e,r){void 0===r&&(r={});for(var i=st(r.maxHbondDist,Uo.maxHbondDist),o=st(r.maxHbondSulfurDist,Uo.maxHbondSulfurDist),S=et(st(r.maxHbondAccAngle,Uo.maxHbondAccAngle)),C=et(st(r.maxHbondDonAngle,Uo.maxHbondDonAngle)),P=et(st(r.maxHbondAccPlaneAngle,Uo.maxHbondAccPlaneAngle)),I=et(st(r.maxHbondDonPlaneAngle,Uo.maxHbondDonPlaneAngle)),O=st(r.masterModelIndex,Uo.masterModelIndex),n=Math.max(i,o),k=i*i,a=e.features,s=e.spatialHash,M=e.contactStore,B=e.featureSet,T=a.types,c=a.centers,D=a.atomSets,u=c.x,h=c.y,l=c.z,p=T.length,R=Bo(t.data).idealGeometry,F=t.getAtomProxy(),E=t.getAtomProxy(),d=function(A){s.eachWithin(u[A],h[A],l[A],n,function(t,e){if(!(t<=A)){var r,i,o=T[A],n=T[t],a=(i=n,9===(r=o)&&5===i||5===r&&9===i);if(a||(c=n,5===(s=o)&&4===c||4===s&&5===c)){var s,c,u=5===n?[A,t]:[t,A],h=u[0],l=u[1];if(F.index=D[h][0],E.index=D[l][0],E.index!==F.index&&!Wo(F,E,O)&&!(16!==F.number&&16!==E.number&&k<e||F.connectedTo(E))){var p=Oo(F,E),d=Io.get(R[F.index])||et(120);if(!p.some(function(t){return Math.abs(d-t)>C})){if(3===R[F.index]){var f=ko(F,E);if(void 0!==f&&I<f)return}var m=Oo(E,F),g=Io.get(R[E.index])||et(120);if(!m.some(function(t){return S<g-t})){if(3===R[E.index]){var y=ko(E,F);if(void 0!==y&&P<y)return}B.setBits(h,l);var v,b,x,_,w=a?8:(_=b=E,(v=F).isWater()&&_.isWater()?9:(x=b,v.isBackbone()&&x.isBackbone()?10:4));M.addContact(h,l,w)}}}}}})},f=0;f<p;++f)d(f)}(t,a,e),function(t,e,r){void 0===r&&(r={});for(var i=st(r.maxMetalDist,Uo.maxMetalDist),c=st(r.masterModelIndex,Uo.masterModelIndex),o=e.features,n=e.spatialHash,u=e.contactStore,h=e.featureSet,l=o.types,a=o.centers,p=o.atomSets,d=a.x,f=a.y,m=a.z,s=l.length,g=t.getAtomProxy(),y=t.getAtomProxy(),v=function(s){n.eachWithin(d[s],f[s],m[s],i,function(t,e){if(!(t<=s||(g.index=p[s][0],y.index=p[t][0],Wo(g,y,c)))){var r=g.isMetal(),i=y.isMetal();if(r||i){var o,n,a=r?[l[s],l[t]]:[l[t],l[s]];n=a[1],(12===(o=a[0])?11===n||12===n:13===o?10===n:void 0)&&(h.setBits(s,t),u.addContact(s,t,7))}}})},b=0;b<s;++b)v(b)}(t,a,e),function(t,e,r){void 0===r&&(r={});for(var i=st(r.maxHydrophobicDist,Uo.maxHydrophobicDist),n=st(r.masterModelIndex,Uo.masterModelIndex),o=e.features,a=e.spatialHash,s=e.contactStore,c=e.featureSet,u=o.types,h=o.centers,l=o.atomSets,p=h.x,d=h.y,f=h.z,m=u.length,g=t.getAtomProxy(),y=t.getAtomProxy(),v=function(o){a.eachWithin(p[o],d[o],f[o],i,function(t,e){var r,i;t<=o||(g.index=l[o][0],y.index=l[t][0],Wo(g,y,n)||9===g.number&&9===y.number||g.connectedTo(y)||(r=u[o],i=u[t],8===r&&8===i&&(c.setBits(o,t),s.addContact(o,t,6))))})},b=0;b<m;++b)v(b)}(t,a,e),function(t,e,r){void 0===r&&(r={});for(var i=st(r.maxHalogenBondDist,Uo.maxHalogenBondDist),h=et(st(r.maxHalogenBondAngle,Uo.maxHalogenBondAngle)),l=st(r.masterModelIndex,Uo.masterModelIndex),o=e.features,n=e.spatialHash,p=e.contactStore,d=e.featureSet,f=o.types,a=o.centers,m=o.atomSets,s=a.x,c=a.y,g=a.z,u=f.length,y=t.getAtomProxy(),v=t.getAtomProxy(),b=function(u){n.eachWithin(s[u],c[u],g[u],i,function(t,e){if(!(t<=u)&&(y.index=m[u][0],v.index=m[t][0],!Wo(y,v,l)&&(r=f[u],i=f[t],7===r&&6===i||6===r&&7===i))){var r,i,o=6===f[u]?[y,v]:[v,y],n=o[0],a=o[1],s=Oo(n,a);if(1===s.length&&!(jo-s[0]>h)){var c=Oo(a,n);0!==c.length&&(c.some(function(t){return h<Vo-t})||(d.setBits(u,t),p.addContact(u,t,5)))}}})},x=0;x<u;++x)b(x)}(t,a,e);var s,c,u,h,l,p,d,f,m,g,y,v,b,x,_,w,A,S,C,P,I,O,k,M,B,T,D,R,F,E,$,L,N,z,j,V,G,U,H,W,q,X,Y,K,Z,Q,J,tt=(c=(s=a).contactStore,u=qi({nodeArray1:c.index1,nodeArray2:c.index2,edgeCount:c.count,nodeCount:s.featureSet.length}),h=new Wi(s.contactStore.count,!0),Object.assign({adjacencyList:u,contactSet:h},s));return function(t,e,r){void 0===r&&(r={}),de.Debug&&me.time("refineLineOfSight");var i=st(r.lineOfSightDistFactor,Uo.lineOfSightDistFactor),a=st(r.masterModelIndex,Uo.masterModelIndex),s=t.spatialHash,c=e.contactSet,o=e.contactStore,n=e.features,u=o.index1,h=o.index2,l=n.centers,p=n.atomSets,d=l.x,f=l.y,m=l.z,g=t.getAtomProxy(),y=t.getAtomProxy(),v=t.getAtomProxy(),b=new fe.Vector3,x=new fe.Vector3,_=3*i,w=i*i;c.forEach(function(r){b.set(d[u[r]],f[u[r]],m[u[r]]),x.set(d[h[r]],f[h[r]],m[h[r]]);var t=(b.x+x.x)/2,e=(b.y+x.y)/2,i=(b.z+x.z)/2,o=p[u[r]],n=p[h[r]];g.index=o[0],y.index=n[0],s.eachWithin(t,e,i,_,function(t,e){v.index=t,1!==v.number&&v.vdw*v.vdw*w>e&&!Go(g,v,a)&&!Go(y,v,a)&&!o.includes(t)&&!n.includes(t)&&1<b.distanceToSquared(v)&&1<x.distanceToSquared(v)&&(c.clear(r),de.Debug&&me.log("removing",g.qualifiedName(),y.qualifiedName(),"because",v.qualifiedName()))})}),de.Debug&&me.timeEnd("refineLineOfSight")}(t,tt,e),l=t,d=(p=tt).contactSet,f=p.contactStore,m=p.features,g=f.type,y=f.index1,v=f.index2,b=m.atomSets,x=l.getAtomProxy(),_=l.getAtomProxy(),w={},A=function(t,e,r){var i=w[r]||[1/0,-1],o=i[0],n=i[1];t<o?(-1!==n&&d.clear(n),w[r]=[t,e]):d.clear(e)},d.forEach(function(t){if(6===g[t]){x.index=b[y[t]][0],_.index=b[v[t]][0];var e=x.distanceTo(_);A(e,t,x.index+"|"+_.residueIndex),A(e,t,_.index+"|"+x.residueIndex)}}),e.refineSaltBridges&&(C=(S=tt).contactSet,P=S.contactStore,I=S.features,O=P.type,k=P.index1,M=P.index2,B=I.atomSets,T={},D=function(t,e){T[t]||(T[t]=[]),T[t].push(e)},C.forEach(function(e){1===O[e]&&(B[k[e]].forEach(function(t){return D(t,e)}),B[M[e]].forEach(function(t){return D(t,e)}))}),C.forEach(function(t){if(4===(e=O[t])||9===e||10===e){var e,r=T[B[k[t]][0]],i=T[B[M[t]][0]];if(r&&i)for(var o=r.length,n=0;n<o;++n)if(i.includes(r[n]))return void C.clear(t)}})),F=(R=tt).contactSet,E=R.contactStore,$=R.features,L=E.type,N=E.index1,z=E.index2,j=$.atomSets,V={},G=function(t,e){V[t]||(V[t]=[]),V[t].push(e)},F.forEach(function(e){3===L[e]&&(j[N[e]].forEach(function(t){return G(t,e)}),j[z[e]].forEach(function(t){return G(t,e)}))}),F.forEach(function(t){if(6===L[t]||2===L[t]){var e=V[j[N[t]][0]],r=V[j[z[t]][0]];if(e&&r)for(var i=e.length,o=0;o<i;++o)if(r.includes(e[o]))return void F.clear(t)}}),H=(U=tt).contactSet,W=U.contactStore,q=U.features,X=W.type,Y=W.index1,K=W.index2,Z=q.atomSets,Q={},J=function(t,e){Q[t]||(Q[t]=[]),Q[t].push(e)},H.forEach(function(e){1===X[e]&&(Z[Y[e]].forEach(function(t){return J(t,e)}),Z[K[e]].forEach(function(t){return J(t,e)}))}),H.forEach(function(t){if(7===X[t]){var e=Q[Z[Y[t]][0]],r=Q[Z[K[t]][0]];if(e&&r)for(var i=e.length,o=0;o<i;++o)if(r.includes(e[o]))return void H.clear(e[o])}}),de.Debug&&me.timeEnd("calculateContacts"),tt}var Yo={hydrogenBond:!0,hydrophobic:!0,halogenBond:!0,ionicInteraction:!0,metalCoordination:!0,cationPi:!0,piStacking:!0,weakHydrogenBond:!0,waterHydrogenBond:!0,backboneHydrogenBond:!0,radius:1,filterSele:""},Ko=new fe.Color;function Zo(t,e,r){var a=w(r,Yo),s=[];a.hydrogenBond&&s.push(4),a.hydrophobic&&s.push(6),a.halogenBond&&s.push(5),a.ionicInteraction&&s.push(1),a.metalCoordination&&s.push(7),a.cationPi&&s.push(2),a.piStacking&&s.push(3),a.weakHydrogenBond&&s.push(8),a.waterHydrogenBond&&s.push(9),a.backboneHydrogenBond&&s.push(10);var c,i=t.features,o=t.contactSet,n=t.contactStore,u=i.centers,h=i.atomSets,l=u.x,p=u.y,d=u.z,f=n.index1,m=n.index2,g=n.type,y=[],v=[],b=[],x=[],_=[];return a.filterSele&&(c=Array.isArray(a.filterSele)?a.filterSele.map(function(t){return e.getAtomSet(new Ct(t))}):e.getAtomSet(new Ct(a.filterSele))),o.forEach(function(t){var e=g[t];if(s.includes(e)){if(c){var r=h[f[t]][0],i=h[m[t]][0];if(Array.isArray(c)){if(!(c[0].isSet(r)&&c[1].isSet(i)||c[1].isSet(r)&&c[0].isSet(i)))return}else if(!c.isSet(r)&&!c.isSet(i))return}var o=f[t],n=m[t];y.push(l[o],p[o],d[o]),v.push(l[n],p[n],d[n]),b.push.apply(b,function(t){switch(t){case 4:case 9:case 10:return Ko.setHex(2851770).toArray();case 6:return Ko.setHex(8421504).toArray();case 5:return Ko.setHex(4259775).toArray();case 1:return Ko.setHex(15779860).toArray();case 7:return Ko.setHex(9191577).toArray();case 2:return Ko.setHex(16744448).toArray();case 3:return Ko.setHex(9220966).toArray();case 8:return Ko.setHex(12967404).toArray();default:return Ko.setHex(13421772).toArray()}}(e)),x.push(a.radius),_.push(t)}}),{position1:new Float32Array(y),position2:new Float32Array(v),color:new Float32Array(b),color2:new Float32Array(b),radius:new Float32Array(x),picking:new sn(_,t,e)}}var Qo=function(t){this.array=t},Jo={type:{configurable:!0},data:{configurable:!0}};Jo.type.get=function(){return""},Jo.data.get=function(){return{}},Qo.prototype.getIndex=function(t){return this.array?this.array[t]:t},Qo.prototype.getObject=function(t){return{}},Qo.prototype._applyTransformations=function(t,e,r){return e&&t.applyMatrix4(e.matrix),r&&t.applyMatrix4(r.matrix),t},Qo.prototype._getPosition=function(t){return new fe.Vector3},Qo.prototype.getPosition=function(t,e,r){return this._applyTransformations(this._getPosition(t),e,r)},Object.defineProperties(Qo.prototype,Jo);var tn=function(e){function t(t){e.call(this),this.shape=t}e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t;var r={primitive:{configurable:!0},data:{configurable:!0},type:{configurable:!0}};return r.primitive.get=function(){},r.data.get=function(){return this.shape},r.type.get=function(){return this.primitive.type},t.prototype.getObject=function(t){return this.primitive.objectFromShape(this.shape,this.getIndex(t))},t.prototype._getPosition=function(t){return this.primitive.positionFromShape(this.shape,this.getIndex(t))},Object.defineProperties(t.prototype,r),t}(Qo),en=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Ri},Object.defineProperties(e.prototype,r),e}(tn),rn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Fi},Object.defineProperties(e.prototype,r),e}(tn),on=function(r){function t(t,e){r.call(this,t),this.structure=e}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"atom"},e.data.get=function(){return this.structure},t.prototype.getObject=function(t){return this.structure.getAtomProxy(this.getIndex(t))},t.prototype._getPosition=function(t){return(new fe.Vector3).copy(this.getObject(t))},Object.defineProperties(t.prototype,e),t}(Qo),nn=function(e){function t(t){e.call(this),this.axes=t}e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"axes"},r.data.get=function(){return this.axes},t.prototype.getObject=function(){return{axes:this.axes}},t.prototype._getPosition=function(){return this.axes.center.clone()},Object.defineProperties(t.prototype,r),t}(Qo),an=function(i){function t(t,e,r){i.call(this,t),this.structure=e,this.bondStore=r||e.bondStore}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"bond"},e.data.get=function(){return this.structure},t.prototype.getObject=function(t){var e=this.structure.getBondProxy(this.getIndex(t));return e.bondStore=this.bondStore,e},t.prototype._getPosition=function(t){var e=this.getObject(t);return(new fe.Vector3).copy(e.atom1).add(e.atom2).multiplyScalar(.5)},Object.defineProperties(t.prototype,e),t}(Qo),sn=function(i){function t(t,e,r){i.call(this,t),this.contacts=e,this.structure=r}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"contact"},e.data.get=function(){return this.contacts},t.prototype.getObject=function(t){var e=this.getIndex(t),r=this.contacts,i=r.features,o=r.contactStore,n=i.centers,a=i.atomSets,s=n.x,c=n.y,u=n.z,h=o.index1,l=o.index2,p=o.type,d=h[e],f=l[e];return{center1:new fe.Vector3(s[d],c[d],u[d]),center2:new fe.Vector3(s[f],c[f],u[f]),atom1:this.structure.getAtomProxy(a[d][0]),atom2:this.structure.getAtomProxy(a[f][0]),type:function(t){switch(t){case 4:case 9:case 10:return"hydrogen bond";case 6:return"hydrophobic contact";case 5:return"halogen bond";case 1:return"ionic interaction";case 7:return"metal coordination";case 2:return"cation-pi interaction";case 3:return"pi-pi stacking";case 8:return"weak hydrogen bond";default:return"unknown contact"}}(p[e])}},t.prototype._getPosition=function(t){var e=this.getObject(t),r=e.center1,i=e.center2;return(new fe.Vector3).addVectors(r,i).multiplyScalar(.5)},Object.defineProperties(t.prototype,e),t}(Qo),cn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Ei},Object.defineProperties(e.prototype,r),e}(tn),un=function(i){function t(t,e,r){i.call(this,t),this.validation=e,this.structure=r}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"clash"},e.data.get=function(){return this.validation},t.prototype.getObject=function(t){var e=this.validation,r=this.getIndex(t);return{validation:e,index:r,clash:e.clashArray[r]}},t.prototype._getAtomProxyFromSele=function(t){var e=new Ct(t),r=this.structure.getAtomIndices(e)[0];return this.structure.getAtomProxy(r)},t.prototype._getPosition=function(t){var e=this.getObject(t).clash,r=this._getAtomProxyFromSele(e.sele1),i=this._getAtomProxyFromSele(e.sele2);return(new fe.Vector3).copy(r).add(i).multiplyScalar(.5)},Object.defineProperties(t.prototype,e),t}(Qo),hn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"distance"},Object.defineProperties(e.prototype,r),e}(an),ln=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return $i},Object.defineProperties(e.prototype,r),e}(tn),pn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Ti},Object.defineProperties(e.prototype,r),e}(tn),dn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Bi},Object.defineProperties(e.prototype,r),e}(tn),fn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"ignore"},Object.defineProperties(e.prototype,r),e}(Qo),mn=function(r){function t(t,e){r.call(this,t),this.mesh=e}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"mesh"},t.prototype.getObject=function(){var t=this.mesh;return{shape:this.shape,name:t.name,serial:t.serial}},t.prototype._getPosition=function(){return this.__position||(this.__position=ri(this.mesh.position)),this.__position},Object.defineProperties(t.prototype,e),t}(tn),gn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Mi},Object.defineProperties(e.prototype,r),e}(tn),yn=function(r){function t(t,e){r.call(this,t),this.surface=e}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"surface"},e.data.get=function(){return this.surface},t.prototype.getObject=function(t){return{surface:this.surface,index:this.getIndex(t)}},t.prototype._getPosition=function(){return this.surface.center.clone()},Object.defineProperties(t.prototype,e),t}(Qo),vn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Di},Object.defineProperties(e.prototype,r),e}(tn),bn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return Li},Object.defineProperties(e.prototype,r),e}(tn),xn=function(r){function t(t,e){r.call(this),this.unitcell=t,this.structure=e}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"unitcell"},e.data.get=function(){return this.unitcell},t.prototype.getObject=function(){return{unitcell:this.unitcell,structure:this.structure}},t.prototype._getPosition=function(){return this.unitcell.getCenter(this.structure)},Object.defineProperties(t.prototype,e),t}(Qo),_n=(function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};r.type.get=function(){return"unknown"},Object.defineProperties(e.prototype,r)}(Qo),function(r){function t(t,e){r.call(this,t),this.volume=e}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},data:{configurable:!0}};return e.type.get=function(){return"volume"},e.data.get=function(){return this.volume},t.prototype.getObject=function(t){var e=this.volume,r=this.getIndex(t);return{volume:e,index:r,value:e.data[r]}},t.prototype._getPosition=function(t){var e=this.volume.position,r=this.getIndex(t);return new fe.Vector3(e[3*r],e[3*r+1],e[3*r+2])},Object.defineProperties(t.prototype,e),t}(Qo)),wn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"slice"},Object.defineProperties(e.prototype,r),e}(_n),An=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return zi},Object.defineProperties(e.prototype,r),e}(tn),Sn=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return ji},Object.defineProperties(e.prototype,r),e}(tn);function Cn(){return new Uint32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0])}function Pn(){return new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1])}function In(){return[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]]}function On(M,I,O,k,d){var f,B,m,T,c,u,h,D=0,R=!1,F=!1,E=!1,l=I*O*k,$=I,L=I*O,N=new Int32Array(12),g=[],y=[],z=[],v=[],j=Cn(),V=Pn(),G=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]];function b(t,e,r){return t+(e-t)*r}function U(t,e,r){return L*(r=(r+h)%k)+$*(e=(e+u)%O)+(t=(t+c)%I)}function H(t,e,r,i,o,n,a){var s=3*t;if(B[s]<0){var c=(D-n)/(a-n),u=f,h=3*m;if(g[h+0]=r+c,g[h+1]=i,g[h+2]=o,!R){var l=3*t;y[h]=-b(u[l],u[l+3],c),y[h+1]=-b(u[l+1],u[l+4],c),y[h+2]=-b(u[l+2],u[l+5],c)}d&&(v[m]=d[t+Math.round(c)]),B[s]=m,N[e]=m,m+=1}else N[e]=B[s]}function W(t,e,r,i,o,n,a){var s=3*t+1;if(B[s]<0){var c=(D-n)/(a-n),u=f,h=3*m;if(g[h]=r,g[h+1]=i+c,g[h+2]=o,!R){var l=3*t,p=l+3*$;y[h]=-b(u[l],u[p],c),y[h+1]=-b(u[l+1],u[p+1],c),y[h+2]=-b(u[l+2],u[p+2],c)}d&&(v[m]=d[t+Math.round(c)*$]),B[s]=m,N[e]=m,m+=1}else N[e]=B[s]}function q(t,e,r,i,o,n,a){var s=3*t+2;if(B[s]<0){var c=(D-n)/(a-n),u=f,h=3*m;if(g[h]=r,g[h+1]=i,g[h+2]=o+c,!R){var l=3*t,p=l+3*L;y[h]=-b(u[l],u[p],c),y[h+1]=-b(u[l+1],u[p+1],c),y[h+2]=-b(u[l+2],u[p+2],c)}d&&(v[m]=d[t+Math.round(c)*L]),B[s]=m,N[e]=m,m+=1}else N[e]=B[s]}function X(t){var e=3*t;0===f[e]&&(f[e]=M[(t-1+l)%l]-M[(t+1)%l],f[e+1]=M[(t-$+l)%l]-M[(t+$)%l],f[e+2]=M[(t-L+l)%l]-M[(t+L)%l])}function Y(t,e,r,i,o){var n,a,s,c,u,h,l;E?(i=U(t,e,r),n=U(t+1,e,r),a=U(t,e+1,r),s=U(t,e,r+1),c=U(t+1,e+1,r),u=U(t+1,e,r+1),h=U(t,e+1,r+1),l=U(t+1,e+1,r+1)):(n=i+1,c=(a=i+$)+1,u=(s=i+L)+1,l=(h=a+L)+1);var p=0,d=M[i],f=M[n],m=M[a],g=M[c],y=M[s],v=M[u],b=M[h],x=M[l];d<D&&(p|=1),f<D&&(p|=2),m<D&&(p|=8),g<D&&(p|=4),y<D&&(p|=16),v<D&&(p|=32),b<D&&(p|=128),x<D&&(p|=64);var _=j[p];if(0===_)return 0;var w=t+1,A=e+1,S=r+1;1&_&&(R||(X(i),X(n)),H(i,0,t,e,r,d,f)),2&_&&(R||(X(n),X(c)),W(n,1,w,e,r,f,g)),4&_&&(R||(X(a),X(c)),H(a,2,t,A,r,m,g)),8&_&&(R||(X(i),X(a)),W(i,3,t,e,r,d,m)),16&_&&(R||(X(s),X(u)),H(s,4,t,e,S,y,v)),32&_&&(R||(X(u),X(l)),W(u,5,w,e,S,v,x)),64&_&&(R||(X(h),X(l)),H(h,6,t,A,S,b,x)),128&_&&(R||(X(s),X(h)),W(s,7,t,e,S,y,b)),256&_&&(R||(X(i),X(s)),q(i,8,t,e,r,d,y)),512&_&&(R||(X(n),X(u)),q(n,9,w,e,r,f,v)),1024&_&&(R||(X(c),X(l)),q(c,10,w,A,r,g,x)),2048&_&&(R||(X(a),X(h)),q(a,11,t,A,r,m,b));for(var C,P,I,O=p<<4,k=0;-1!==V[O+k];)C=V[O+k],P=V[O+k+1],I=V[O+k+2],F?(G[C][P]&o&&(z[T++]=N[C],z[T++]=N[P]),G[P][I]&o&&(z[T++]=N[P],z[T++]=N[I]),G[C][I]&o&&(z[T++]=N[C],z[T++]=N[I])):(z[T++]=N[P],z[T++]=N[C],z[T++]=N[I]),k+=3}function p(t,e,r,i,o,n){var a,s,c,u,h,l,p,d,f,m,g,y,v;if(t=void 0!==t?t:0,e=void 0!==e?e:0,r=void 0!==r?r:0,i=void 0!==i?i:I-1,o=void 0!==o?o:O-1,n=void 0!==n?n:k-1,E||(R?(t=Math.max(0,t),e=Math.max(0,e),r=Math.max(0,r),i=Math.min(I-1,i),o=Math.min(O-1,o),n=Math.min(k-1,n)):(t=Math.max(1,t),e=Math.max(1,e),r=Math.max(1,r),i=Math.min(I-2,i),o=Math.min(O-2,o),n=Math.min(k-2,n))),E)for(d=t-2,f=e-2,g=i+2,y=o+2,v=n+2,h=m=r-2;h<v;++h)for(u=f;u<y;++u)for(c=d;c<g;++c)s=3*U(c,u,h),B[s]=-1,B[s+1]=-1,B[s+2]=-1;else for(d=Math.max(0,t-2),f=Math.max(0,e-2),m=Math.max(0,r-2),g=Math.min(I,i+2),y=Math.min(O,o+2),v=Math.min(k,n+2),h=m;h<v;++h)for(p=L*h,u=f;u<y;++u)for(l=p+$*u,c=d;c<g;++c)B[a=3*(l+c)]=-1,B[a+1]=-1,B[a+2]=-1;if(!E){var b,x=t,_=e,w=r,A=i,S=o,C=n;for(b=!1,h=r;h<n;++h){for(u=e;u<o;++u){for(c=t;c<i;++c)if(M[a=I*O*h+I*u+c]>=D){w=h,b=!0;break}if(b)break}if(b)break}for(b=!1,u=e;u<o;++u){for(h=w;h<n;++h){for(c=t;c<i;++c)if(M[a=I*O*h+I*u+c]>=D){_=u,b=!0;break}if(b)break}if(b)break}for(b=!1,c=t;c<i;++c){for(u=_;u<o;++u){for(h=w;h<n;++h)if(M[a=I*O*h+I*u+c]>=D){x=c,b=!0;break}if(b)break}if(b)break}for(b=!1,h=n;r<=h;--h){for(u=o;e<=u;--u){for(c=i;t<=c;--c)if(M[a=I*O*h+I*u+c]>=D){C=h,b=!0;break}if(b)break}if(b)break}for(b=!1,u=o;e<=u;--u){for(h=C;r<=h;--h){for(c=i;t<=c;--c)if(M[a=I*O*h+I*u+c]>=D){S=u,b=!0;break}if(b)break}if(b)break}for(b=!1,c=i;t<=c;--c){for(u=S;e<=u;--u){for(h=C;r<=h;--h)if(M[a=I*O*h+I*u+c]>=D){A=c,b=!0;break}if(b)break}if(b)break}R?(t=Math.max(0,x-1),e=Math.max(0,_-1),r=Math.max(0,w-1),i=Math.min(I-1,A+1),o=Math.min(O-1,S+1),n=Math.min(k-1,C+1)):(t=Math.max(1,x-1),e=Math.max(1,_-1),r=Math.max(1,w-1),i=Math.min(I-2,A+1),o=Math.min(O-2,S+1),n=Math.min(k-2,C+1))}var P=15;for(h=r;h<n;++h,P&=-5)for(p=L*h,P|=2,u=e;u<o;++u,P&=-3)for(l=p+$*u,P|=1,c=t;c<i;++c,P&=-2)Y(c,u,h,a=l+c,P)}this.triangulate=function(t,e,r,i,o){D=t,F=i,E=o,(R=e||F)||f||(f=new Float32Array(3*l));var n=3*l;if(B&&B.length===n||(B=new Int32Array(n)),void(T=m=0)!==r){var a=r[0].map(Math.round),s=r[1].map(Math.round);c=I*Math.ceil(Math.abs(a[0])/I),u=O*Math.ceil(Math.abs(a[1])/O),h=k*Math.ceil(Math.abs(a[2])/k),p(a[0],a[1],a[2],s[0],s[1],s[2])}else c=u=h=0,p();return g.length=3*m,R||(y.length=3*m),z.length=T,d&&(v.length=m),{position:new Float32Array(g),normal:R?void 0:new Float32Array(y),index:S(z,g.length/3),atomindex:d?new Int32Array(v):void 0,contour:F}}}Kt.add("arrow",rn),Kt.add("box",dn),Kt.add("cone",cn),Kt.add("cylinder",en),Kt.add("ellipsoid",ln),Kt.add("octahedron",pn),Kt.add("sphere",gn),Kt.add("tetrahedron",vn),Kt.add("torus",bn),Kt.add("point",An),Kt.add("wideline",Sn),Object.assign(On,{__deps:[Cn,Pn,In,S]});var kn=function(t,e){this.cols=t,this.rows=e,this.size=this.cols*this.rows,this.data=new Float32Array(this.size)};function Mn(t,e){for(var r=0,i=0,o=e.rows,n=e.cols,a=0,s=0,c=0,u=e.data,h=t.data;r<o;s+=1,a+=n,r++)for(c=s,i=0;i<n;c+=o,i++)h[c]=u[a+i]}function Bn(t,e,r){for(var i=0,o=0,n=0,a=0,s=0,c=0,u=0,h=e.cols,l=e.rows,p=r.rows,d=e.data,f=r.data,m=t.data,g=0;i<l;a+=h,i++)for(o=c=0;o<p;u++,o++){for(s=a,n=g=0;n<h;s++,c++,n++)g+=d[s]*f[c];m[u]=g}}function Tn(t,e,r){var i=t.data,o=e.data,n=r.data,a=o[0],s=o[1],c=o[2],u=o[3],h=o[4],l=o[5],p=o[6],d=o[7],f=o[8],m=n[0],g=n[1],y=n[2],v=n[3],b=n[4],x=n[5],_=n[6],w=n[7],A=n[8];i[0]=a*m+s*v+c*_,i[1]=a*g+s*b+c*w,i[2]=a*y+s*x+c*A,i[3]=u*m+h*v+l*_,i[4]=u*g+h*b+l*w,i[5]=u*y+h*x+l*A,i[6]=p*m+d*v+f*_,i[7]=p*g+d*b+f*w,i[8]=p*y+d*x+f*A}function Dn(t){for(var e=t.rows,r=t.cols,i=t.data,o=new Array(r),n=0;n<r;++n)o[n]=0;for(var a=0,s=0;a<e;++a)for(var c=0;c<r;++c,++s)o[c]+=i[s];for(var u=0;u<r;++u)o[u]/=e;return o}function Rn(t,e){for(var r=t.rows,i=t.cols,o=t.data,n=0,a=0;n<r;++n)for(var s=0;s<i;++s,++a)o[a]-=e[s]}function Fn(t,e,r,i){i=t[e],t[e]=t[r],t[r]=i}kn.prototype.copyTo=function(t){t.data.set(this.data)};var En=1.192092896e-7,$n=1e-37;function Ln(t,e,r,i){var o=0,n=0,a=t.rows,s=t.cols,c=a,u=s;c<u&&(o=1,n=c,c=u,u=n);var h=new kn(c,c),l=new kn(1,u),p=new kn(u,u);if(0===o)Mn(h,t);else{for(n=0;n<s*a;n++)h.data[n]=t.data[n];for(;n<u*c;n++)h.data[n]=0}if(function(t,e,r,i,o,n,a,s){for(var c,u,h=2*En,l=$n,p=0,d=0,f=0,m=0,g=Math.max(n,30),y=0,v=0,b=0,x=0,_=0,w=0,A=0,S=0,C=0,P=0,I=0,O=0,k=0,M=0,B=0,T=0,D=0,R=4660,F=0,E=0,$=0,L=new Float64Array(a<<3);p<a;p++){for(I=f=0;f<n;f++)I+=(S=t[p*e+f])*S;if(L[p]=I,i){for(f=0;f<a;f++)i[p*o+f]=0;i[p*o+p]=1}}for(;m<g;m++){for(p=_=0;p<a-1;p++)for(d=p+1;d<a;d++){for(y=p*e|0,v=d*e|0,B=L[p],T=0,D=L[d],f=2,T+=t[y]*t[v],T+=t[y+1]*t[v+1];f<n;f++)T+=t[y+f]*t[v+f];if(!(Math.abs(T)<=h*Math.sqrt(B*D))){for(c=T*=2,u=O=B-D,c=Math.abs(c),k=(u=Math.abs(u))<c?(u/=c,c*Math.sqrt(1+u*u)):0<u?(c/=u,u*Math.sqrt(1+c*c)):0,O<0?(M=.5*(k-O),w=T/(k*(A=Math.sqrt(M/k))*2)):A=T/(k*(w=Math.sqrt((k+O)/(2*k)))*2),D=B=0,f=2,C=w*t[y]+A*t[v],P=-A*t[y]+w*t[v],B+=(t[y]=C)*C,D+=(t[v]=P)*P,C=w*t[y+1]+A*t[v+1],P=-A*t[y+1]+w*t[v+1],B+=(t[y+1]=C)*C,D+=(t[v+1]=P)*P;f<n;f++)C=w*t[y+f]+A*t[v+f],P=-A*t[y+f]+w*t[v+f],B+=(t[y+f]=C)*C,D+=(t[v+f]=P)*P;if(L[p]=B,L[d]=D,_=1,i)for(x=d*o|0,f=2,C=w*i[b=p*o|0]+A*i[x],P=-A*i[b]+w*i[x],i[b]=C,i[x]=P,C=w*i[b+1]+A*i[x+1],P=-A*i[b+1]+w*i[x+1],i[b+1]=C,i[x+1]=P;f<a;f++)C=w*i[b+f]+A*i[x+f],P=-A*i[b+f]+w*i[x+f],i[b+f]=C,i[x+f]=P}}if(0===_)break}for(p=0;p<a;p++){for(I=f=0;f<n;f++)I+=(S=t[p*e+f])*S;L[p]=Math.sqrt(I)}for(p=0;p<a-1;p++){for(f=(d=p)+1;f<a;f++)L[d]<L[f]&&(d=f);if(p!==d&&(Fn(L,p,d,I),i)){for(f=0;f<n;f++)Fn(t,p*e+f,d*e+f,S);for(f=0;f<a;f++)Fn(i,p*o+f,d*o+f,S)}}for(p=0;p<a;p++)r[p]=L[p];if(i)for(p=0;p<s;p++){for(I=p<a?L[p]:0;I<=l;){for(E=1/n,f=0;f<n;f++)F=0!=(256&(R=214013*R+2531011)>>16)?E:-E,t[p*e+f]=F;for(m=0;m<2;m++)for(d=0;d<p;d++){for(f=I=0;f<n;f++)I+=t[p*e+f]*t[d*e+f];for(f=$=0;f<n;f++)S=t[p*e+f]-I*t[d*e+f],t[p*e+f]=S,$+=Math.abs(S);for($=$?1/$:0,f=0;f<n;f++)t[p*e+f]*=$}for(f=I=0;f<n;f++)I+=(S=t[p*e+f])*S;I=Math.sqrt(I)}for(A=1/I,f=0;f<n;f++)t[p*e+f]*=A}}(h.data,c,l.data,p.data,u,c,u,c),e){for(n=0;n<u;n++)e.data[n]=l.data[n];for(;n<s;n++)e.data[n]=0}0===o?(r&&Mn(r,h),i&&Mn(i,p)):(r&&Mn(r,p),i&&Mn(i,h))}function Nn(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function zn(t,e,r,i,o,n,a,s,c,u,h,l,p,d,f,m,g){t[0]=e,t[4]=r,t[8]=i,t[12]=o,t[1]=n,t[5]=a,t[9]=s,t[13]=c,t[2]=u,t[6]=h,t[10]=l,t[14]=p,t[3]=d,t[7]=f,t[11]=m,t[15]=g}function jn(t,e,r){var i=e[0],o=e[4],n=e[8],a=e[12],s=e[1],c=e[5],u=e[9],h=e[13],l=e[2],p=e[6],d=e[10],f=e[14],m=e[3],g=e[7],y=e[11],v=e[15],b=r[0],x=r[4],_=r[8],w=r[12],A=r[1],S=r[5],C=r[9],P=r[13],I=r[2],O=r[6],k=r[10],M=r[14],B=r[3],T=r[7],D=r[11],R=r[15];t[0]=i*b+o*A+n*I+a*B,t[4]=i*x+o*S+n*O+a*T,t[8]=i*_+o*C+n*k+a*D,t[12]=i*w+o*P+n*M+a*R,t[1]=s*b+c*A+u*I+h*B,t[5]=s*x+c*S+u*O+h*T,t[9]=s*_+c*C+u*k+h*D,t[13]=s*w+c*P+u*M+h*R,t[2]=l*b+p*A+d*I+f*B,t[6]=l*x+p*S+d*O+f*T,t[10]=l*_+p*C+d*k+f*D,t[14]=l*w+p*P+d*M+f*R,t[3]=m*b+g*A+y*I+v*B,t[7]=m*x+g*S+y*O+v*T,t[11]=m*_+g*C+y*k+v*D,t[15]=m*w+g*P+y*M+v*R}function Vn(t,e,r,i){zn(t,e,0,0,0,0,r,0,0,0,0,i,0,0,0,0,1)}function Gn(t,e,r,i){zn(t,1,0,0,e,0,1,0,r,0,0,1,i,0,0,0,1)}function Un(t,e){var r=Math.cos(e),i=Math.sin(e);zn(t,r,0,i,0,0,1,0,0,-i,0,r,0,0,0,0,1)}function Hn(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function Wn(t,e){var r=ci([e[0],e[1],e[2]]),i=ci([e[4],e[5],e[6]]),o=ci([e[8],e[9],e[10]]),n=ci();ui(n,i,o),t[0]=n[0],t[1]=n[1],t[2]=n[2],ui(n,o,r),t[3]=n[0],t[4]=n[1],t[5]=n[2],ui(n,r,i),t[6]=n[0],t[7]=n[1],t[8]=n[2]}function qn(t,e,r,i){r=r||1,i=i||!0;var o=t.length/3,n=e.length/3,a=void 0;i&&(a=new Float32Array(3*o));var s,c,u,h,l=new Float32Array(3*o),p=new Array(20);for(s=0;s<20;++s)p[s]=new Uint32Array(o);for(s=0;s<o;++s)p[0][s]=0;for(s=0;s<n;++s){var d=3*s,f=3*s+1,m=3*s+2;for(h=!0,u=p[c=0][e[d]];c<u;++c)if(e[f]===p[c+1][e[d]]){h=!1;break}for(h&&(p[0][e[d]]++,p[p[0][e[d]]][e[d]]=e[f]),h=!0,u=p[c=0][e[d]];c<u;++c)if(e[m]===p[c+1][e[d]]){h=!1;break}for(h&&(p[0][e[d]]++,p[p[0][e[d]]][e[d]]=e[m]),h=!0,u=p[c=0][e[f]];c<u;++c)if(e[d]===p[c+1][e[f]]){h=!1;break}for(h&&(p[0][e[f]]++,p[p[0][e[f]]][e[f]]=e[d]),h=!0,u=p[c=0][e[f]];c<u;++c)if(e[m]===p[c+1][e[f]]){h=!1;break}for(h&&(p[0][e[f]]++,p[p[0][e[f]]][e[f]]=e[m]),h=!0,c=0;c<p[0][e[m]];++c)if(e[d]===p[c+1][e[m]]){h=!1;break}for(h&&(p[0][e[m]]++,p[p[0][e[m]]][e[m]]=e[d]),h=!0,u=p[c=0][e[m]];c<u;++c)if(e[f]===p[c+1][e[m]]){h=!1;break}h&&(p[0][e[m]]++,p[p[0][e[m]]][e[m]]=e[f])}for(var g,y,v,b,x,_=0;_<r;++_){for(s=0;s<o;++s)if(g=3*s,(v=p[0][s])<3)l[g]=t[g],l[g+1]=t[g+1],l[g+2]=t[g+2];else if(3===v||4===v){for(l[g]=0,l[g+1]=0,c=l[g+2]=0;c<v;++c)y=3*p[c+1][s],l[g]+=t[y],l[g+1]+=t[y+1],l[g+2]+=t[y+2];l[g]+=.5*t[g],l[g+1]+=.5*t[g+1],l[g+2]+=.5*t[g+2],x=.5+v,l[g]/=x,l[g+1]/=x,l[g+2]/=x}else{for(l[g]=0,l[g+1]=0,c=l[g+2]=0;c<v;++c)y=3*p[c+1][s],l[g]+=t[y],l[g+1]+=t[y+1],l[g+2]+=t[y+2];l[g]+=1*t[g],l[g+1]+=1*t[g+1],l[g+2]+=1*t[g+2],b=1+v,l[g]/=b,l[g+1]/=b,l[g+2]/=b}if(t.set(l),i){Xn(t,e,a);var w=3*o;for(g=0;g<w;g+=3)t[g]+=.75/4.5*-1*a[g],t[g+1]+=.75/4.5*-1*a[g+1],t[g+2]+=.75/4.5*-1*a[g+2]}}}function Xn(t,e,r){var i,o;if(void 0===r)r=new Float32Array(t.length);else for(i=0,o=r.length;i<o;i++)r[i]=0;var n=new Float32Array(3),a=new Float32Array(3),s=new Float32Array(3),c=new Float32Array(3),u=new Float32Array(3);if(e)for(i=0,o=e.length;i<o;i+=3){var h=3*e[i],l=3*e[i+1],p=3*e[i+2];di(n,t,h),di(a,t,l),di(s,t,p),li(c,s,a),li(u,n,a),ui(c,c,u),r[h]+=c[0],r[h+1]+=c[1],r[h+2]+=c[2],r[l]+=c[0],r[l+1]+=c[1],r[l+2]+=c[2],r[p]+=c[0],r[p+1]+=c[1],r[p+2]+=c[2]}else for(i=0,o=t.length;i<o;i+=9)di(n,t,i),di(a,t,i+3),di(s,t,i+6),li(c,s,a),li(u,n,a),ui(c,c,u),r[i]=c[0],r[i+1]=c[1],r[i+2]=c[2],r[i+3]=c[0],r[i+4]=c[1],r[i+5]=c[2],r[i+6]=c[0],r[i+7]=c[1],r[i+8]=c[2];return si(r),r}function Yn(t){for(var e={},r=0,i=t.length;r<i;++r)e[t[r]]=!0;return e}function Kn(t,e,r,i,o){var n=1/i*3;bi(t,t,o+(n+=r)),xi(e,e,o+n),yi(t,t,i),_i(t,t),gi(t,t,i),yi(e,e,i),wi(e,e),gi(e,e,i);var a=new Float32Array(3);li(a,e,t),yi(a,a,i),wi(a,a),xi(a,a,1);var s=256*Math.pow(10,6),c=a[0]*a[1]*a[2]*3;s<=c&&(yi(t,t,i*=Math.pow(s/c,1/3)),_i(t,t),gi(t,t,i),yi(e,e,i),wi(e,e),gi(e,e,i),li(a,e,t),yi(a,a,i),wi(a,a),xi(a,a,1));var u=new Float32Array(t);Ai(u,u);var h=Nn(),l=Nn();Un(l,et(90)),jn(h,h,l);var p=Nn();Vn(p,-1/i,1/i,1/i),jn(h,h,p);var d=Nn();return Gn(d,-i*u[2],-i*u[1],-i*u[0]),jn(h,h,d),{dim:a,tran:u,matrix:h,scaleFactor:i}}Vn.__deps=[zn],Gn.__deps=[zn],Un.__deps=[zn],Wn.__deps=[ci,ui],Object.assign(qn,{__deps:[Xn]}),Object.assign(Xn,{__deps:[li,ui,di,si]}),Object.assign(Kn,{__deps:[et,bi,xi,gi,yi,_i,wi,li,Ai,Nn,jn,Gn,Vn,Un]});var Zn=function(t,e,r){this.name=t||"",this.path=e||"",this.info={},this.center=new fe.Vector3,this.boundingBox=new fe.Box3,r instanceof fe.Geometry||r instanceof fe.BufferGeometry||r instanceof fe.Group?this.fromGeometry(r):r&&(this.set(r.position,r.index,r.normal,r.color,r.atomindex,r.contour),this.boundingBox.setFromArray(r.position),this.boundingBox.getCenter(this.center))},Qn={type:{configurable:!0}};function Jn(t,e,r,i,o){var c=new On(t,e,r,i,o);this.getSurface=function(t,e,r,i,o,n){void 0===n&&(n=!1);var a=c.triangulate(t,e,r,o,n);if(e&&!o&&(qn(a.position,a.index,e,!0),a.normal=Xn(a.position,a.index)),i&&(ni(i,a.position),a.normal)){var s=Hn();Wn(s,i),ai(s,a.normal)}return a}}Qn.type.get=function(){return"Surface"},Zn.prototype.set=function(t,e,r,i,o,n){void 0===n&&(n=!1),this.position=t,this.index=e,this.normal=r,this.color=i,this.atomindex=o,this.size=t.length/3,this.contour=n},Zn.prototype.fromGeometry=function(t){var e,r,i,o;if(de.Debug&&me.time("GeometrySurface.fromGeometry"),t instanceof fe.Geometry?(t.computeVertexNormals(!0),e=(new fe.BufferGeometry).fromGeometry(t)):e=t instanceof fe.BufferGeometry?t:t[0],e.boundingBox||e.computeBoundingBox(),this.boundingBox.copy(e.boundingBox),this.boundingBox.getCenter(this.center),e instanceof fe.BufferGeometry){var n=e.attributes,a=!!n.normal&&n.normal.array;(!a||0===a[0]&&0===a[1]&&0===a[2])&&e.computeVertexNormals(),r=n.position.array,i=n.index?n.index.array:null,o=n.normal.array}this.set(r,i,o,void 0,void 0),de.Debug&&me.timeEnd("GeometrySurface.setGeometry")},Zn.prototype.getPosition=function(){return this.position},Zn.prototype.getColor=function(t){var e=t||{},r=(e.surface=this).size,i=new Float32Array(3*r),o=Vt.getScheme(e);if(o.volumeColor||"random"===e.scheme)for(var n=0;n<r;++n)o.volumeColorToArray(n,i,3*n);else if(o.positionColor)for(var a=new fe.Vector3,s=this.position,c=0;c<r;++c){var u=3*c;a.set(s[u],s[u+1],s[u+2]),o.positionColorToArray(a,i,u)}else if(o.atomColor&&this.atomindex)for(var h=e.structure.getAtomProxy(),l=this.atomindex,p=0;p<r;++p)h.index=l[p],o.atomColorToArray(h,i,3*p);else{var d=new fe.Color(e.value);Re(r,d.r,d.g,d.b,i)}return i},Zn.prototype.getPicking=function(t){return this.atomindex&&t?new on(this.atomindex,t):new yn(Fe(this.size),this)},Zn.prototype.getNormal=function(){return this.normal},Zn.prototype.getSize=function(t,e){return De(this.size,t*e)},Zn.prototype.getIndex=function(){return this.index},Zn.prototype.getFilteredIndex=function(t,e){if(t&&this.atomindex){for(var r=new Ct(t),i=e.getAtomSet(r),o=[],n=this.atomindex,a=this.index,s=a.length,c=this.contour?2:3,u=0,h=0;h<s;h+=c){for(var l=!0,p=0;p<c;p++){var d=n[a[h+p]];if(!i.get(d)){l=!1;break}}if(l)for(var f=0;f<c;f++,u++)o[u]=a[h+f]}return S(o,this.position.length/3)}return this.index},Zn.prototype.getAtomindex=function(){return this.atomindex},Zn.prototype.dispose=function(){},Object.defineProperties(Zn.prototype,Qn),Object.assign(Jn,{__deps:[qn,Xn,On,ni,ai,Hn,Wn]}),jt.add("surf",function(t,e){var r=t.data.args,i=t.data.params;if(r&&(self.volsurf=new Jn(r[0],r[1],r[2],r[3],r[4])),i){var o=self.volsurf.getSurface(i.isolevel,i.smooth,i.box,i.matrix,i.contour,i.wrap),n=[o.position.buffer,o.index.buffer];o.normal&&n.push(o.normal.buffer),o.atomindex&&n.push(o.atomindex.buffer),e({sd:o,p:i},n)}},[Jn]);var ta=function(t,e,r,i,o,n,a){this.name=t,this.path=e,this.matrix=new fe.Matrix4,this.normalMatrix=new fe.Matrix3,this.inverseMatrix=new fe.Matrix4,this.center=new fe.Vector3,this.boundingBox=new fe.Box3,this.setData(r,i,o,n,a)},ea={type:{configurable:!0},position:{configurable:!0},min:{configurable:!0},max:{configurable:!0},sum:{configurable:!0},mean:{configurable:!0},rms:{configurable:!0}};function ra(t){return"front"===t?fe.FrontSide:"back"===t?fe.BackSide:fe.DoubleSide}ea.type.get=function(){return"Volume"},ta.prototype.setData=function(t,e,r,i,o){this.nx=e||1,this.ny=r||1,this.nz=i||1,this.data=t||new Float32Array(1),this.setAtomindex(o),delete this._position,delete this._min,delete this._max,delete this._mean,delete this._rms,this.worker&&this.worker.terminate()},ta.prototype.setStats=function(t,e,r,i){this._min=t,this._max=e,this._mean=r,this._rms=i},ta.prototype.setMatrix=function(t){this.matrix.copy(t);var e=this.boundingBox,r=this.center,i=this.nx-1,o=this.ny-1,n=this.nz-1;e.makeEmpty(),e.expandByPoint(r.set(i,o,n)),e.expandByPoint(r.set(i,o,0)),e.expandByPoint(r.set(i,0,n)),e.expandByPoint(r.set(i,0,0)),e.expandByPoint(r.set(0,o,n)),e.expandByPoint(r.set(0,0,n)),e.expandByPoint(r.set(0,o,0)),e.expandByPoint(r.set(0,0,0)),e.applyMatrix4(this.matrix),e.getCenter(this.center);var a=this.matrix.elements,s=new fe.Vector3(a[0],a[1],a[2]),c=new fe.Vector3(a[4],a[5],a[6]),u=new fe.Vector3(a[8],a[9],a[10]),h=new fe.Vector3,l=this.normalMatrix.elements;h.crossVectors(c,u),l[0]=h.x,l[1]=h.y,l[2]=h.z,h.crossVectors(u,s),l[3]=h.x,l[4]=h.y,l[5]=h.z,h.crossVectors(s,c),l[6]=h.x,l[7]=h.y,l[8]=h.z,this.inverseMatrix.getInverse(this.matrix)},ta.prototype.setAtomindex=function(t){this.atomindex=t},ta.prototype.getBox=function(t,e,r){return r||(r=new fe.Box3),r.set(t,t),r.expandByScalar(e),r.applyMatrix4(this.inverseMatrix),r.min.round(),r.max.round(),r},ta.prototype._getBox=function(t,e){if(t&&e){this.__box||(this.__box=new fe.Box3);var r=this.getBox(t,e,this.__box);return[r.min.toArray(),r.max.toArray()]}},ta.prototype._makeSurface=function(t,e,r){var i=this.name+"@"+e.toPrecision(2),o=new Zn(i,"",t);return o.info.isolevel=e,o.info.smooth=r,o.info.volume=this,o},ta.prototype.getSurface=function(t,e,r,i,o,n){void 0===n&&(n=!1),t=isNaN(t)?this.getValueForSigma(2):t,e=st(e,0),void 0===this.volsurf&&(this.volsurf=new Jn(this.data,this.nx,this.ny,this.nz,this.atomindex));var a=this._getBox(r,i),s=this.volsurf.getSurface(t,e,a,this.matrix.elements,o,n);return this._makeSurface(s,t,e)},ta.prototype.getSurfaceWorker=function(r,i,o,n,a,s,c){var u=this;if(r=isNaN(r)?this.getValueForSigma(2):r,i=i||0,window.hasOwnProperty("Worker")){void 0===this.workerPool&&(this.workerPool=new ei("surf",2));var t={},e=this.workerPool.getNextWorker();0===e.postCount&&Object.assign(t,{args:[this.data,this.nx,this.ny,this.nz,this.atomindex]}),Object.assign(t,{params:{isolevel:r,smooth:i,box:this._getBox(o,n),matrix:this.matrix.elements,contour:a,wrap:s}}),e.post(t,void 0,function(t){var e=t.data.sd,r=t.data.p;c(u._makeSurface(e,r.isolevel,r.smooth))},function(t){console.warn("Volume.getSurfaceWorker error - trying without worker",t);var e=u.getSurface(r,i,o,n,a,s);c(e)})}else{var h=this.getSurface(r,i,o,n,a,s);c(h)}},ta.prototype.getValueForSigma=function(t){return this.mean+st(t,2)*this.rms},ta.prototype.getSigmaForValue=function(t){return(st(t,0)-this.mean)/this.rms},ea.position.get=function(){if(!this._position){for(var t=this.nz,e=this.ny,r=this.nx,i=new Float32Array(r*e*t*3),o=0,n=0;n<t;++n)for(var a=0;a<e;++a)for(var s=0;s<r;++s)i[o+0]=s,i[o+1]=a,i[o+2]=n,o+=3;ni(this.matrix.elements,i),this._position=i}return this._position},ta.prototype.getDataAtomindex=function(){return this.atomindex},ta.prototype.getDataPosition=function(){return this.position},ta.prototype.getDataColor=function(t){var e=t||{};e.volume=this,e.scale=e.scale||"Spectral",e.domain=e.domain||[this.min,this.max];for(var r=Vt.getScheme(e),i=this.position.length/3,o=new Float32Array(3*i),n=0;n<i;++n)r.volumeColorToArray(n,o,3*n);return o},ta.prototype.getDataPicking=function(){var t=Fe(this.position.length/3);return new _n(t,this)},ta.prototype.getDataSize=function(t,e){var r,i=this.data,o=this.position.length/3;switch(t){case"value":r=new Float32Array(i);break;case"abs-value":r=new Float32Array(i);for(var n=0;n<o;++n)r[n]=Math.abs(r[n]);break;case"value-min":r=new Float32Array(i);for(var a=this.min,s=0;s<o;++s)r[s]-=a;break;case"deviation":r=new Float32Array(i);break;default:r=De(o,t)}if(1!==e)for(var c=0;c<o;++c)r[c]*=e;return r},ea.min.get=function(){return void 0===this._min&&(this._min=je(this.data)),this._min},ea.max.get=function(){return void 0===this._max&&(this._max=ze(this.data)),this._max},ea.sum.get=function(){return void 0===this._sum&&(this._sum=Ve(this.data)),this._sum},ea.mean.get=function(){return void 0===this._mean&&(this._mean=Ge(this.data)),this._mean},ea.rms.get=function(){return void 0===this._rms&&(this._rms=function(t){for(var e=t.length,r=0,i=0;i<e;++i){var o=t[i];r+=o*o}return Math.sqrt(r/e)}(this.data)),this._rms},ta.prototype.clone=function(){var t=new ta(this.name,this.path,this.data,this.nx,this.ny,this.nz,this.atomindex);return t.matrix.copy(this.matrix),t.header=Object.assign({},this.header),t},ta.prototype.dispose=function(){this.workerPool&&this.workerPool.terminate()},Object.defineProperties(ta.prototype,ea),Wt.add("shader/Mesh.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#elif defined( NOLIGHT )\nvColor = color;\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Wt.add("shader/Mesh.frag","#define STANDARD\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#elif defined( NOLIGHT )\ngl_FragColor = vec4( vColor, opacity );\n#else\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\n#include interior_fragment\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#include opaque_back_fragment\n#endif\n}");var ia={f:1,v2:2,v3:3,c:3};function oa(t,e){t.matrix.copy(e),t.matrix.decompose(t.position,t.quaternion,t.scale),t.matrixWorldNeedsUpdate=!0}var na={opaqueBack:!1,side:"double",opacity:1,depthWrite:!0,clipNear:0,clipRadius:0,clipCenter:new fe.Vector3,flatShaded:!1,wireframe:!1,roughness:.4,metalness:0,diffuse:16777215,diffuseInterior:!1,useInteriorColor:!1,interiorColor:14540253,interiorDarkening:0,forceTransparent:!1,matrix:new fe.Matrix4,disablePicking:!1,sortParticles:!1,background:!1},aa={opaqueBack:{updateShader:!0},side:{updateShader:!0,property:!0},opacity:{uniform:!0},depthWrite:{property:!0},clipNear:{updateShader:!0,property:!0},clipRadius:{updateShader:!0,uniform:!0},clipCenter:{uniform:!0},flatShaded:{updateShader:!0},background:{updateShader:!0},wireframe:{updateVisibility:!0},roughness:{uniform:!0},metalness:{uniform:!0},diffuse:{uniform:!0},diffuseInterior:{updateShader:!0},useInteriorColor:{updateShader:!0},interiorColor:{uniform:!0},interiorDarkening:{uniform:!0},matrix:{}},sa=function(t,e){void 0===e&&(e={}),this.parameterTypes=aa,this.geometry=new fe.BufferGeometry,this.indexVersion=0,this.wireframeIndexVersion=-1,this.group=new fe.Group,this.wireframeGroup=new fe.Group,this.pickingGroup=new fe.Group,this.vertexShader="",this.fragmentShader="",this.isImpostor=!1,this.isText=!1,this.isSurface=!1,this.isPoint=!1,this.isLine=!1,this.dynamic=!0,this.visible=!0,this.wireframeIndexCount=0,this.parameters=w(e,this.defaultParameters),this.uniforms=fe.UniformsUtils.merge([fe.UniformsLib.common,{fogColor:{value:new fe.Color(0)},fogNear:{value:0},fogFar:{value:0},opacity:{value:this.parameters.opacity},clipNear:{value:0},clipRadius:{value:this.parameters.clipRadius},clipCenter:{value:this.parameters.clipCenter}},{emissive:{value:new fe.Color(0)},roughness:{value:this.parameters.roughness},metalness:{value:this.parameters.metalness},interiorColor:{value:new fe.Color(this.parameters.interiorColor)},interiorDarkening:{value:this.parameters.interiorDarkening}},fe.UniformsLib.lights]),this.uniforms.diffuse.value.set(this.parameters.diffuse),this.pickingUniforms={clipNear:{value:0},objectId:{value:0},opacity:{value:this.parameters.opacity}};var r=t.position||t.position1;this._positionDataSize=r?r.length/3:0,t.primitiveId||(t.primitiveId=Fe(this._positionDataSize)),this.addAttributes({position:{type:"v3",value:t.position},color:{type:"c",value:t.color},primitiveId:{type:"f",value:t.primitiveId}}),e.matrix&&(this.matrix=e.matrix),t.index&&this.initIndex(t.index),this.picking=t.picking,this.makeWireframeGeometry()},ca={defaultParameters:{configurable:!0},matrix:{configurable:!0},transparent:{configurable:!0},size:{configurable:!0},attributeSize:{configurable:!0},pickable:{configurable:!0}};ca.defaultParameters.get=function(){return na},ca.matrix.set=function(t){this.setMatrix(t)},ca.matrix.get=function(){return this.group.matrix.clone()},ca.transparent.get=function(){return this.parameters.opacity<1||this.parameters.forceTransparent},ca.size.get=function(){return this._positionDataSize},ca.attributeSize.get=function(){return this.size},ca.pickable.get=function(){return!!this.picking&&!this.parameters.disablePicking},sa.prototype.setMatrix=function(t){oa(this.group,t),oa(this.wireframeGroup,t),oa(this.pickingGroup,t)},sa.prototype.initIndex=function(t){this.geometry.setIndex(new fe.BufferAttribute(t,1)),this.geometry.getIndex().setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)},sa.prototype.makeMaterial=function(){var t=ra(this.parameters.side),e=new fe.ShaderMaterial({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!0,fog:!0,side:t});e.vertexColors=fe.VertexColors,e.extensions.derivatives=this.parameters.flatShaded,e.extensions.fragDepth=this.isImpostor;var r=new fe.ShaderMaterial({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!1,fog:!0,side:t});r.vertexColors=fe.VertexColors;var i=new fe.ShaderMaterial({uniforms:this.pickingUniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:!1,depthWrite:this.parameters.depthWrite,lights:!1,fog:!1,side:t,blending:fe.NoBlending});i.vertexColors=fe.VertexColors,i.extensions.fragDepth=this.isImpostor,e.clipNear=this.parameters.clipNear,r.clipNear=this.parameters.clipNear,i.clipNear=this.parameters.clipNear,this.material=e,this.wireframeMaterial=r,this.pickingMaterial=i,this.updateShader()},sa.prototype.makeWireframeGeometry=function(){this.makeWireframeIndex();var t=this.geometry,e=this.wireframeIndex,r=new fe.BufferGeometry;r.attributes=t.attributes,e&&(r.setIndex(new fe.BufferAttribute(e,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)),r.setDrawRange(0,this.wireframeIndexCount)),this.wireframeGeometry=r},sa.prototype.makeWireframeIndex=function(){var o=[];function t(t,e){if(e<t){var r=t;t=e,e=r}var i=o[t];return void 0===i?(o[t]=[e],!0):!i.includes(e)&&(i.push(e),!0)}var e=this.geometry,r=e.index;if(this.parameters.wireframe)if(r){var i,n=r.array,a=n.length;if(e.drawRange.count!==1/0&&(a=e.drawRange.count),this.wireframeIndex&&this.wireframeIndex.length>2*a)i=this.wireframeIndex;else i=S(2*a,e.attributes.position.count);for(var s=0,c=o.length=0;c<a;c+=3){var u=n[c+0],h=n[c+1],l=n[c+2];t(u,h)&&(i[s+0]=u,i[s+1]=h,s+=2),t(h,l)&&(i[s+0]=h,i[s+1]=l,s+=2),t(l,u)&&(i[s+0]=l,i[s+1]=u,s+=2)}this.wireframeIndex=i,this.wireframeIndexCount=s,this.wireframeIndexVersion=this.indexVersion}else{var p,d=e.attributes.position.count;p=this.wireframeIndex&&this.wireframeIndex.length>2*d?this.wireframeIndex:S(2*d,d);for(var f=0,m=0;f<d;f+=3)p[m+0]=f,p[m+1]=f+1,p[m+2]=f+1,p[m+3]=f+2,p[m+4]=f+2,p[m+5]=f,m+=6;this.wireframeIndex=p,this.wireframeIndexCount=2*d,this.wireframeIndexVersion=this.indexVersion}else this.wireframeIndex=new Uint16Array(0),this.wireframeIndexCount=0},sa.prototype.updateWireframeIndex=function(){if(this.wireframeGeometry&&this.wireframeIndex){if(this.wireframeGeometry.setDrawRange(0,1/0),this.wireframeIndexVersion<this.indexVersion&&this.makeWireframeIndex(),this.wireframeGeometry.index&&this.wireframeIndex.length>this.wireframeGeometry.index.array.length)this.wireframeGeometry.setIndex(new fe.BufferAttribute(this.wireframeIndex,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0));else{var t=this.wireframeGeometry.getIndex();t.set(this.wireframeIndex),t.needsUpdate=0<this.wireframeIndexCount,t.updateRange.count=this.wireframeIndexCount}this.wireframeGeometry.setDrawRange(0,this.wireframeIndexCount)}},sa.prototype.getRenderOrder=function(){var t=0;return this.isText?t=1:this.transparent&&(t=this.isSurface?3:2),t},sa.prototype._getMesh=function(t){this.material||this.makeMaterial();var e,r=this.geometry,i=this[t];return(e=this.isLine?new fe.LineSegments(r,i):this.isPoint?new fe.Points(r,i):new fe.Mesh(r,i)).frustumCulled=!1,e.renderOrder=this.getRenderOrder(),e},sa.prototype.getMesh=function(){return this._getMesh("material")},sa.prototype.getWireframeMesh=function(){var t;return this.material||this.makeMaterial(),this.wireframeGeometry||this.makeWireframeGeometry(),(t=new fe.LineSegments(this.wireframeGeometry,this.wireframeMaterial)).frustumCulled=!1,t.renderOrder=this.getRenderOrder(),t},sa.prototype.getPickingMesh=function(){return this._getMesh("pickingMaterial")},sa.prototype.getShader=function(t,e){return xe(t,this.getDefines(e))},sa.prototype.getVertexShader=function(t){return this.getShader(this.vertexShader,t)},sa.prototype.getFragmentShader=function(t){return this.getShader(this.fragmentShader,t)},sa.prototype.getDefines=function(t){var e={};return this.parameters.clipNear&&(e.NEAR_CLIP=1),this.parameters.clipRadius&&(e.RADIUS_CLIP=1),"picking"===t?e.PICKING=1:(("background"===t||this.parameters.background)&&(e.NOLIGHT=1),this.parameters.flatShaded&&(e.FLAT_SHADED=1),this.parameters.opaqueBack&&(e.OPAQUE_BACK=1),this.parameters.diffuseInterior&&(e.DIFFUSE_INTERIOR=1),this.parameters.useInteriorColor&&(e.USE_INTERIOR_COLOR=1)),e},sa.prototype.getParameters=function(){return this.parameters},sa.prototype.addUniforms=function(t){this.uniforms=fe.UniformsUtils.merge([this.uniforms,t]),this.pickingUniforms=fe.UniformsUtils.merge([this.pickingUniforms,t])},sa.prototype.addAttributes=function(t){for(var e in t){var r=void 0,i=t[e],o=this.attributeSize*ia[i.type];i.value?(o!==i.value.length&&me.error("attribute value has wrong length",e),r=i.value):r=A("float32",o),this.geometry.setAttribute(e,new fe.BufferAttribute(r,ia[i.type]).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0))}},sa.prototype.updateRenderOrder=function(){var e=this.getRenderOrder();function t(t){t.renderOrder=e}this.group.children.forEach(t),this.pickingGroup&&this.pickingGroup.children.forEach(t)},sa.prototype.updateShader=function(){var t=this.material,e=this.wireframeMaterial,r=this.pickingMaterial;t.vertexShader=this.getVertexShader(),t.fragmentShader=this.getFragmentShader(),t.needsUpdate=!0,e.vertexShader=this.getShader("Line.vert"),e.fragmentShader=this.getShader("Line.frag"),e.needsUpdate=!0,r.vertexShader=this.getVertexShader("picking"),r.fragmentShader=this.getFragmentShader("picking"),r.needsUpdate=!0},sa.prototype.setParameters=function(t){var e=t,r=this.parameterTypes,i=this.parameters,o={},n={},a=!1,s=!1;for(var c in e){var u=e[c];void 0!==u&&(i[c]=u,void 0!==r[c]&&(r[c].property&&(!0!==r[c].property?o[r[c].property]=u:o[c]=u),r[c].uniform&&(!0!==r[c].uniform?n[r[c].uniform]=u:n[c]=u),r[c].updateShader&&(a=!0),r[c].updateVisibility&&(s=!0),this.dynamic&&"wireframe"===c&&!0===u&&this.updateWireframeIndex(),"flatShaded"===c&&(this.material.extensions.derivatives=this.parameters.flatShaded||this.isText),"forceTransparent"===c&&(o.transparent=this.transparent),"matrix"===c&&(this.matrix=u)))}this.setProperties(o),this.setUniforms(n),a&&this.updateShader(),s&&this.setVisibility(this.visible)},sa.prototype.setAttributes=function(t){var e=this.geometry,r=e.attributes;for(var i in t)if("picking"!==i){var o=t[i],n=o.length;if("index"===i){var a=e.getIndex();e.setDrawRange(0,1/0),n>a.array.length?e.setIndex(new fe.BufferAttribute(o,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(a.set(o),a.needsUpdate=0<n,a.updateRange.count=n,e.setDrawRange(0,n)),this.indexVersion++,this.parameters.wireframe&&this.updateWireframeIndex()}else{var s=r[i];n>s.array.length?e.setAttribute(i,new fe.BufferAttribute(o,s.itemSize).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(r[i].set(o),r[i].needsUpdate=0<n,r[i].updateRange.count=n)}}},sa.prototype.setUniforms=function(t){if(t){var e=this.material.uniforms,r=this.wireframeMaterial.uniforms,i=this.pickingMaterial.uniforms;for(var o in t)"opacity"===o&&this.setProperties({transparent:this.transparent}),void 0!==e[o]&&(e[o].value.isVector3?e[o].value.copy(t[o]):e[o].value.set?e[o].value.set(t[o]):e[o].value=t[o]),void 0!==r[o]&&(r[o].value.isVector3?r[o].value.copy(t[o]):r[o].value.set?r[o].value.set(t[o]):r[o].value=t[o]),void 0!==i[o]&&(i[o].value.isVector3?i[o].value.copy(t[o]):i[o].value.set?i[o].value.set(t[o]):i[o].value=t[o])}},sa.prototype.setProperties=function(t){if(t){var e=this.material,r=this.wireframeMaterial,i=this.pickingMaterial;for(var o in t){var n=o,a=t[n];"transparent"===n?this.updateRenderOrder():"side"===n&&(a=ra(a)),e[n]=a,r[n]=a,i[n]=a}e.needsUpdate=!0,r.needsUpdate=!0,i.needsUpdate=!0}},sa.prototype.setVisibility=function(t){this.visible=t,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=t,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=t,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=t))},sa.prototype.dispose=function(){this.material&&this.material.dispose(),this.wireframeMaterial&&this.wireframeMaterial.dispose(),this.pickingMaterial&&this.pickingMaterial.dispose(),this.geometry.dispose(),this.wireframeGeometry&&this.wireframeGeometry.dispose()},sa.prototype.toJSON=function(){var t={};for(var e in this)"group"!==e&&"wireframeGroup"!==e&&"pickingGroup"!=e&&"picking"!==e&&(t[e]=this[e]);return t},Object.defineProperties(sa.prototype,ca);var ua=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.vertexShader="Mesh.vert",this.fragmentShader="Mesh.frag",this.addAttributes({normal:{type:"v3",value:t.normal}}),void 0===t.normal&&this.geometry.computeVertexNormals()}return r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t}(sa),ha=function(t){function e(){t.apply(this,arguments),this.isSurface=!0}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(ua);function la(t){t.visible=!0}function pa(t){t.visible=!1}var da=function(t){this.group=new fe.Group,this.wireframeGroup=new fe.Group,this.pickingGroup=new fe.Group,this.frontMeshes=[],this.backMeshes=[],this.size=t.size,this.side=t.parameters.side,this.visible=t.visible,this.geometry=t.geometry,this.picking=t.picking,this.group=new fe.Group,this.wireframeGroup=new fe.Group,this.pickingGroup=new fe.Group,this.matrix=t.matrix;var e=t,r=new t.constructor({position:new Float32Array(0)});e.makeMaterial(),r.makeMaterial(),r.picking=t.picking,r.geometry=t.geometry,r.wireframeGeometry=t.wireframeGeometry,r.setParameters(t.getParameters()),r.updateShader(),e.setParameters({side:"front"}),r.setParameters({side:"back",opacity:r.parameters.opacity}),this.buffer=t,this.frontBuffer=e,this.backBuffer=r},fa={matrix:{configurable:!0},pickable:{configurable:!0},parameters:{configurable:!0}};fa.matrix.set=function(t){sa.prototype.setMatrix.call(this,t)},fa.matrix.get=function(){return this.group.matrix.clone()},fa.pickable.get=function(){return!!this.picking&&!this.parameters.disablePicking},fa.parameters.get=function(){return this.buffer.parameters},da.prototype.getParameters=function(){var t=Object.assign({},this.buffer.parameters);return t.side=this.side,t},da.prototype.getMesh=function(t){var e,r;return t?(r=this.backBuffer.getPickingMesh(),e=this.frontBuffer.getPickingMesh()):(r=this.backBuffer.getMesh(),e=this.frontBuffer.getMesh()),this.frontMeshes.push(e),this.backMeshes.push(r),this.setParameters({side:this.side}),(new fe.Group).add(r,e)},da.prototype.getWireframeMesh=function(){return this.buffer.getWireframeMesh()},da.prototype.getPickingMesh=function(){return this.getMesh(!0)},da.prototype.setAttributes=function(t){this.buffer.setAttributes(t)},da.prototype.setParameters=function(t){"front"===(t=Object.assign({},t)).side?(this.frontMeshes.forEach(la),this.backMeshes.forEach(pa)):"back"===t.side?(this.frontMeshes.forEach(pa),this.backMeshes.forEach(la)):"double"===t.side&&(this.frontMeshes.forEach(la),this.backMeshes.forEach(la)),void 0!==t.side&&(this.side=t.side),delete t.side,void 0!==t.matrix&&(this.matrix=t.matrix),delete t.matrix,this.frontBuffer.setParameters(t),void 0!==t.wireframe&&(this.wireframe=t.wireframe,this.setVisibility(this.visible)),delete t.wireframe,this.backBuffer.setParameters(t)},da.prototype.setVisibility=function(t){this.visible=t,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=t,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=t,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=t))},da.prototype.dispose=function(){this.frontBuffer.dispose(),this.backBuffer.dispose()},da.prototype.toJSON=function(){var t={};for(var e in this)["side","size","visible","matrix","parameters"].includes(e)&&(t[e]=this[e]);return t},Object.defineProperties(da.prototype,fa),Wt.add("shader/Line.vert","uniform float clipNear;\nuniform vec3 clipCenter;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include color_pars_vertex\nvoid main(){\n#include color_vertex\n#include begin_vertex\n#include project_vertex\nvViewPosition = -mvPosition.xyz;\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Wt.add("shader/Line.frag","uniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\ngl_FragColor = vec4( vColor, opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}");var ma=function(t){function e(){t.apply(this,arguments),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag"}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e}(sa),ga=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="surface",this.parameters=Object.assign({isolevelType:{type:"select",options:{value:"value",sigma:"sigma"}},isolevel:{type:"number",precision:2,max:1e3,min:-1e3},negateIsolevel:{type:"boolean"},isolevelScroll:{type:"boolean"},smooth:{type:"integer",precision:1,max:10,min:0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},boxSize:{type:"integer",precision:1,max:100,min:0},colorVolume:{type:"hidden"},contour:{type:"boolean",rebuild:!0},useWorker:{type:"boolean",rebuild:!0},wrap:{type:"boolean",rebuild:!0}},this.parameters),t instanceof ta?(this.surface=void 0,this.volume=t):(this.surface=t,this.volume=void 0),this.boxCenter=new fe.Vector3,this.__boxCenter=new fe.Vector3,this.box=new fe.Box3,this.__box=new fe.Box3,this._position=new fe.Vector3,this.setBox=function(){this._position.copy(e.translationGroup.position).negate(),this._position.equals(this.boxCenter)||this.setParameters({boxCenter:this._position})},this.toBePrepared=!0,this.viewer.signals.ticked.add(this.setBox,this),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"uniform"),e.colorValue=st(e.colorValue,14540253),this.isolevelType=st(e.isolevelType,"sigma"),this.isolevel=st(e.isolevel,2),this.negateIsolevel=st(e.negateIsolevel,!1),this.isolevelScroll=st(e.isolevelScroll,!1),this.smooth=st(e.smooth,0),this.background=st(e.background,!1),this.opaqueBack=st(e.opaqueBack,!0),this.boxSize=st(e.boxSize,0),this.colorVolume=st(e.colorVolume,void 0),this.contour=st(e.contour,!1),this.useWorker=st(e.useWorker,!0),this.wrap=st(e.wrap,!1),i.prototype.init.call(this,e),this.build()},t.prototype.attach=function(t){var e=this;this.bufferList.forEach(function(t){e.viewer.add(t)}),this.setVisibility(this.visible),t()},t.prototype.prepare=function(e){var t,r=this;if(this.volume)if(t="sigma"===this.isolevelType?this.volume.getValueForSigma(this.isolevel):this.isolevel,this.negateIsolevel&&(t*=-1),!this.surface||this.__isolevel!==t||this.__smooth!==this.smooth||this.__contour!==this.contour||this.__wrap!==this.wrap||this.__boxSize!==this.boxSize||0<this.boxSize&&!this.__boxCenter.equals(this.boxCenter)){this.__isolevel=t,this.__smooth=this.smooth,this.__contour=this.contour,this.__wrap=this.wrap,this.__boxSize=this.boxSize,this.__boxCenter.copy(this.boxCenter),this.__box.copy(this.box);var i=function(t){r.surface=t,e()};this.useWorker?this.volume.getSurfaceWorker(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap,i):i(this.volume.getSurface(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap))}else e();else e()},t.prototype.create=function(){var t,e={position:this.surface.getPosition(),color:this.surface.getColor(this.getColorParams()),index:this.surface.getIndex()};if(this.contour)t=new ma(e,this.getBufferParams({wireframe:!1}));else{Object.assign(e,{normal:this.surface.getNormal(),picking:this.surface.getPicking()});var r=new ha(e,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));t=new da(r)}this.bufferList.push(t)},t.prototype.update=function(t){if(0!==this.bufferList.length){var e={};(t=t||{}).position&&(e.position=this.surface.getPosition()),t.color&&(e.color=this.surface.getColor(this.getColorParams())),t.index&&(e.index=this.surface.getIndex()),t.normal&&(e.normal=this.surface.getNormal()),this.bufferList.forEach(function(t){t.setAttributes(e)})}},t.prototype.setParameters=function(t,e,r){return t&&void 0!==t.isolevelType&&this.volume&&("value"===this.isolevelType&&"sigma"===t.isolevelType?this.isolevel=this.volume.getSigmaForValue(this.isolevel):"sigma"===this.isolevelType&&"value"===t.isolevelType&&(this.isolevel=this.volume.getValueForSigma(this.isolevel)),this.isolevelType=t.isolevelType),t&&t.boxCenter&&(this.boxCenter.copy(t.boxCenter),delete t.boxCenter),t&&t.wireframe&&(t.contour||void 0===t.contour&&this.contour)&&(t.wireframe=!1),i.prototype.setParameters.call(this,t,e,r),this.volume&&this.volume.getBox(this.boxCenter,this.boxSize,this.box),t&&void 0!==t.colorVolume&&e&&(e.color=!0),this.surface&&(void 0!==t.isolevel||void 0!==t.negateIsolevel||void 0!==t.smooth||void 0!==t.wrap||void 0!==t.boxSize||0<this.boxSize&&!this.__box.equals(this.box))&&this.build({position:!0,color:!0,index:!0,normal:!this.contour}),this},t.prototype.getColorParams=function(){var t=i.prototype.getColorParams.call(this);return t.volume=this.colorVolume,t},t.prototype.dispose=function(){this.viewer.signals.ticked.remove(this.setBox,this),i.prototype.dispose.call(this)},t}(Jr),ya=function(){};ya.zoomScroll=function(t,e){t.trackballControls.zoom(e)},ya.clipNearScroll=function(t,e){var r=t.getParameters();t.setParameters({clipNear:r.clipNear+e/10})},ya.focusScroll=function(t,e){var r=t.getFocus(),i=Math.sign(e)*function(t,e,r){if(e<t)return t;var i=t/e;return((2*r-e)*i+(2*e-3*r))*i*i+r}((100-r)/10,5,.2);t.setFocus(r+i)},ya.zoomFocusScroll=function(t,e){t.trackballControls.zoom(e);var r=t.viewer.camera.position.z;t.setFocus(100-Math.abs(r/8))},ya.isolevelScroll=function(t,e){var i=Math.sign(e)/10;t.eachRepresentation(function(t,e){if(t.repr instanceof ga){var r=t.getParameters();r.isolevelScroll&&t.setParameters({isolevel:r.isolevel+i})}})},ya.panDrag=function(t,e,r){t.trackballControls.pan(e,r)},ya.rotateDrag=function(t,e,r){t.trackballControls.rotate(e,r)},ya.zRotateDrag=function(t,e,r){t.trackballControls.zRotate(e,r)},ya.zoomDrag=function(t,e,r){t.trackballControls.zoom((e+r)/-2)},ya.zoomFocusDrag=function(t,e,r){t.trackballControls.zoom((e+r)/-2);var i=t.viewer.camera.position.z;t.setFocus(100-Math.abs(i/8))},ya.panComponentDrag=function(t,e,r){t.trackballControls.panComponent(e,r)},ya.panAtomDrag=function(t,e,r){t.trackballControls.panAtom(e,r)},ya.rotateComponentDrag=function(t,e,r){t.trackballControls.rotateComponent(e,r)},ya.movePick=function(t,e){e&&t.animationControls.move(e.position.clone())},ya.tooltipPick=function(t,e){var r=t.tooltip;if(t.getParameters().tooltip&&e){var i=e.mouse.position;r.innerText=e.getLabel(),r.style.bottom=window.innerHeight-i.y+3+"px",r.style.left=i.x+3+"px",r.style.display="block"}else r.style.display="none"};var va={default:[["scroll",ya.zoomScroll],["scroll-shift",ya.focusScroll],["scroll-ctrl",ya.isolevelScroll],["scroll-shift-ctrl",ya.zoomFocusScroll],["drag-left",ya.rotateDrag],["drag-right",ya.panDrag],["drag-ctrl-left",ya.panDrag],["drag-ctrl-right",ya.zRotateDrag],["drag-shift-left",ya.zoomDrag],["drag-middle",ya.zoomFocusDrag],["drag-ctrl-shift-right",ya.panComponentDrag],["drag-ctrl-shift-left",ya.rotateComponentDrag],["clickPick-right",ya.measurePick=function(t,e){if(e&&(e.atom||e.bond)){var r=e.atom||e.closestBondAtom;e.component.measurePick(r)}else t.measureClear()}],["clickPick-ctrl-left",ya.measurePick],["clickPick-middle",ya.movePick],["clickPick-left",ya.movePick],["hoverPick",ya.tooltipPick]],pymol:[["drag-left",ya.rotateDrag],["drag-middle",ya.panDrag],["drag-right",ya.zoomDrag],["drag-shift-right",ya.focusScroll],["clickPick-ctrl+shift-middle",ya.movePick],["hoverPick",ya.tooltipPick]],coot:[["scroll",ya.isolevelScroll],["drag-left",ya.rotateDrag],["drag-middle",ya.panDrag],["drag-ctrl-left",ya.panDrag],["drag-right",ya.zoomFocusDrag],["drag-ctrl-right",ya.focusScroll],["clickPick-middle",ya.movePick],["hoverPick",ya.tooltipPick]],astexviewer:[["drag-left",ya.rotateDrag],["drag-ctrl-left",ya.panDrag],["drag-shift-left",ya.zoomDrag],["scroll",ya.focusScroll],["clickPick-middle",ya.movePick],["hoverPick",ya.tooltipPick]]};function ba(t){var e=t.split(/[-+]/),r="";e.includes("scroll")&&(r="scroll"),e.includes("drag")&&(r="drag"),e.includes("click")&&(r="click"),e.includes("doubleClick")&&(r="doubleClick"),e.includes("hover")&&(r="hover"),e.includes("clickPick")&&(r="clickPick"),e.includes("hoverPick")&&(r="hoverPick");var i=0;e.includes("alt")&&(i+=1),e.includes("ctrl")&&(i+=2),e.includes("meta")&&(i+=4),e.includes("shift")&&(i+=8);var o=0;return e.includes("left")&&(o+=1),e.includes("right")&&(o+=2),e.includes("middle")&&(o+=4),[r,i,o]}var xa=function(t,e){void 0===e&&(e={}),this.stage=t,this.actionList=[],this.mouse=t.mouseObserver,this.disabled=e.disabled||!1,this.preset(e.preset||"default")};xa.prototype.run=function(e){for(var r=this,i=[],t=arguments.length-1;0<t--;)i[t]=arguments[t+1];if(!this.disabled){var o=this.mouse.key||0,n=this.mouse.buttons||0;this.actionList.forEach(function(t){t.type===e&&t.key===o&&t.button===n&&t.callback.apply(t,[r.stage].concat(i))})}},xa.prototype.add=function(t,e){var r=ba(t),i=r[0],o=r[1],n=r[2];this.actionList.push({type:i,key:o,button:n,callback:e})},xa.prototype.remove=function(t,e){var r=t.includes("*"),i=ba(t),o=i[0],n=i[1],a=i[2],s=this.actionList.filter(function(t){return!((t.type===o||r&&""===o)&&(t.key===n||r&&0===n)&&(t.button===a||r&&0===a)&&(t.callback===e||void 0===e))});this.actionList=s},xa.prototype.preset=function(t){var e=this;this.clear(),(va[t]||[]).forEach(function(t){return e.add(t[0],t[1])})},xa.prototype.clear=function(){this.actionList.length=0};var _a=function(){};_a.autoView=function(t){t.autoView(1e3)},_a.toggleAnimations=function(t){t.animationControls.toggle()},_a.toggleRock=function(t){t.toggleRock()};var wa={default:[["i",_a.toggleSpin=function(t){t.toggleSpin()}],["k",_a.toggleRock],["p",_a.toggleAnimations],["a",_a.toggleAntialiasing=function(t){var e=t.getParameters();t.setParameters({sampleLevel:-1===e.sampleLevel?0:-1})}],["r",_a.autoView]]},Aa=function(t,e){void 0===e&&(e={}),this.stage=t,this.actionList=[],this.disabled=e.disabled||!1,this.preset(e.preset||"default")};Aa.prototype.run=function(e){var r=this;this.disabled||this.actionList.forEach(function(t){t.key===e&&t.callback(r.stage)})},Aa.prototype.add=function(t,e){this.actionList.push({key:t,callback:e})},Aa.prototype.remove=function(e,r){var t=this.actionList.filter(function(t){return!(t.key===e&&(t.callback===r||void 0===r))});this.actionList=t},Aa.prototype.preset=function(t){var e=this;this.clear(),(wa[t]||[]).forEach(function(t){return e.add(t[0],t[1])})},Aa.prototype.clear=function(){this.actionList.length=0};var Sa=function(t){this.stage=t,this.stage=t,this.mouse=t.mouseObserver,this.controls=t.mouseControls,this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this)};Sa.prototype._onClick=function(t,e){var r=this.stage.pickingControls.pick(t,e);this.stage.signals.clicked.dispatch(r),this.controls.run("clickPick",r)},Sa.prototype._onHover=function(t,e){var r=this.stage.pickingControls.pick(t,e);r&&this.mouse.down.equals(this.mouse.position)&&(this.stage.transformComponent=r.component,this.stage.transformAtom=r.atom),this.stage.signals.hovered.dispatch(r),this.controls.run("hoverPick",r)},Sa.prototype.dispose=function(){this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)};var Ca=function(t){this.stage=t,this.stage=t,this.mouse=t.mouseObserver,this.controls=t.mouseControls,this.mouse.signals.moved.add(this._onMove,this),this.mouse.signals.scrolled.add(this._onScroll,this),this.mouse.signals.dragged.add(this._onDrag,this),this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this),this.mouse.signals.doubleClicked.add(this._onDblclick,this)};Ca.prototype._onMove=function(){this.stage.tooltip.style.display="none"},Ca.prototype._onScroll=function(t){this.controls.run("scroll",t)},Ca.prototype._onDrag=function(t,e){this.controls.run("drag",t,e)},Ca.prototype._onClick=function(t,e){this.controls.run("click",t,e)},Ca.prototype._onDblclick=function(t,e){this.controls.run("doubleClick",t,e)},Ca.prototype._onHover=function(t,e){this.controls.run("hover",t,e)},Ca.prototype.dispose=function(){this.mouse.signals.moved.remove(this._onMove,this),this.mouse.signals.scrolled.remove(this._onScroll,this),this.mouse.signals.dragged.remove(this._onDrag,this),this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)};var Pa=function(t){this.stage=t,this.viewer=t.viewer,this.animationControls=t.animationControls,this.viewer.signals.ticked.add(this._onTick,this)};Pa.prototype._onTick=function(t){this.animationControls.run(t)},Pa.prototype.dispose=function(){this.viewer.signals.ticked.remove(this._onTick,this)};var Ia=!!Dt&&{passive:!0},Oa=function(t){this.stage=t,this.stage=t,this.controls=t.keyControls,this.domElement=t.viewer.renderer.domElement,this.domElement.setAttribute("tabIndex","-1"),this.domElement.style.outline="none",this._focusDomElement=this._focusDomElement.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onKeypress=this._onKeypress.bind(this),this.domElement.addEventListener("mousedown",this._focusDomElement),this.domElement.addEventListener("touchstart",this._focusDomElement,Ia),this.domElement.addEventListener("keydown",this._onKeydown),this.domElement.addEventListener("keyup",this._onKeyup),this.domElement.addEventListener("keypress",this._onKeypress)};Oa.prototype._onKeydown=function(){},Oa.prototype._onKeyup=function(){},Oa.prototype._onKeypress=function(t){var e;e="key"in KeyboardEvent.prototype?t.key:String.fromCharCode(t.which||t.keyCode),this.controls.run(e)},Oa.prototype._focusDomElement=function(){this.domElement.focus()},Oa.prototype.dispose=function(){this.domElement.removeEventListener("mousedown",this._focusDomElement),this.domElement.removeEventListener("touchstart",this._focusDomElement,Ia),this.domElement.removeEventListener("keydown",this._onKeypress),this.domElement.removeEventListener("keyup",this._onKeypress),this.domElement.removeEventListener("keypress",this._onKeypress)};var ka=function(t,e,r,i){void 0===i&&(i={}),this.component=t,this.position=e,this.offsetX=st(i.offsetX,0),this.offsetY=st(i.offsetY,0),this.visible=st(i.visible,!0),this.stage=t.stage,this.viewer=t.stage.viewer,this._viewerPosition=new fe.Vector3,this._updateViewerPosition(),this._canvasPosition=new fe.Vector2,this._cameraPosition=new fe.Vector3,this.element=document.createElement("div"),Object.assign(this.element.style,{display:"block",position:"absolute",pointerEvents:"none",whiteSpace:"nowrap",left:"-10000px"}),this.viewer.wrapper.appendChild(this.element),this.setContent(r),this.updateVisibility(),this.viewer.signals.rendered.add(this._update,this),this.component.signals.matrixChanged.add(this._updateViewerPosition,this)};ka.prototype.setContent=function(t){var e=this.element.style.display;if("none"===e&&(this.element.style.left="-10000px",this.element.style.display="block"),t instanceof HTMLElement)this.element.appendChild(t);else{var r=document.createElement("div");r.innerText=t,Object.assign(r.style,{backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.element.appendChild(r)}this._clientRect=this.element.getBoundingClientRect(),"none"===e&&(this.element.style.display=e)},ka.prototype.setVisibility=function(t){this.visible=t,this.updateVisibility()},ka.prototype.getVisibility=function(){return this.visible&&this.component.parameters.visible},ka.prototype.updateVisibility=function(){this.element.style.display=this.getVisibility()?"block":"none"},ka.prototype._updateViewerPosition=function(){this._viewerPosition.copy(this.position).applyMatrix4(this.component.matrix)},ka.prototype._update=function(){if(this.getVisibility()){var t=this.element.style,e=this._canvasPosition,r=this._viewerPosition,i=this._clientRect;if(this._cameraPosition.copy(r).add(this.viewer.translationGroup.position).applyMatrix4(this.viewer.rotationGroup.matrix).sub(this.viewer.camera.position),this._cameraPosition.z<0)t.display="none";else{t.display="block";var o=this._cameraPosition.length(),n=this.viewer.scene.fog;t.opacity=(1-V(n.near,n.far,o)).toString(),t.zIndex=Math.round(100*(n.far-o)).toString(),this.stage.viewerControls.getPositionOnCanvas(r,e),t.bottom=this.offsetX+e.y+i.height/2+"px",t.left=this.offsetY+e.x-i.width/2+"px"}}},ka.prototype.dispose=function(){this.viewer.wrapper.removeChild(this.element),this.viewer.signals.ticked.remove(this._update,this),this.component.signals.matrixChanged.remove(this._updateViewerPosition,this)};var Ma=new fe.Matrix4,Ba=new fe.Vector3,Ta=new fe.Quaternion,Da=function(t){this.component=t,this.signals={changed:new u.Signal},this.stage=t.stage,this.viewer=t.stage.viewer},Ra={position:{configurable:!0},rotation:{configurable:!0}};Ra.position.get=function(){return this.component.position},Ra.rotation.get=function(){return this.component.quaternion},Da.prototype.changed=function(){this.component.updateMatrix(),this.viewer.requestRender(),this.signals.changed.dispatch()},Da.prototype.spin=function(t,e){Ma.getInverse(this.viewer.rotationGroup.matrix),Ba.copy(I(t)).applyMatrix4(Ma),Ma.extractRotation(this.component.transform),Ma.premultiply(this.viewer.rotationGroup.matrix),Ma.getInverse(Ma),Ba.copy(I(t)),Ba.applyMatrix4(Ma),Ma.makeRotationAxis(Ba,e),Ta.setFromRotationMatrix(Ma),this.component.quaternion.premultiply(Ta),this.changed()},Object.defineProperties(Da.prototype,Ra);var Fa={"":"",vdw:"by vdW radius",covalent:"by covalent radius",sstruc:"by secondary structure",bfactor:"by bfactor",size:"size",data:"data",explicit:"explicit"},Ea=function(t){void 0===t&&(t={}),this.max=10,this.type=st(t.type,"size"),this.scale=st(t.scale,1),this.size=st(t.size,1),this.data=st(t.data,{})};Ea.prototype.atomRadius=function(t){var e;switch(this.type){case"vdw":e=t.vdw;break;case"covalent":e=t.covalent;break;case"bfactor":e=t.bfactor||1;break;case"sstruc":var r=t.sstruc;e="h"===r?.25:"g"===r?.25:"i"===r?.25:"e"===r?.25:"b"===r?.25:So.includes(t.atomname)?.4:.1;break;case"data":e=st(this.data[t.index],1);break;case"explicit":null===(e=t.radius)&&(e=this.size);break;default:e=this.size}return Math.min(e*this.scale,this.max)},Ea.types=Fa;var $a=new fe.Vector3(-1,-1,-1),La=new fe.Matrix4,Na=function(t){var e=t.rows,r=e/3,i=new kn(e,3),o=new kn(3,3),n=new kn(1,3),a=new kn(3,3),s=new kn(3,3),c=Dn(t);Rn(t,c),Mn(i,t),Bn(o,i,i),Ln(o,n,a,s);var u=new fe.Vector3(c[0],c[1],c[2]),h=new fe.Vector3(a.data[0],a.data[3],a.data[6]),l=new fe.Vector3(a.data[1],a.data[4],a.data[7]),p=new fe.Vector3(a.data[2],a.data[5],a.data[8]),d=h.clone().multiplyScalar(Math.sqrt(n.data[0]/r)),f=l.clone().multiplyScalar(Math.sqrt(n.data[1]/r)),m=p.clone().multiplyScalar(Math.sqrt(n.data[2]/r));this.begA=u.clone().sub(d),this.endA=u.clone().add(d),this.begB=u.clone().sub(f),this.endB=u.clone().add(f),this.begC=u.clone().sub(m),this.endC=u.clone().add(m),this.center=u,this.vecA=d,this.vecB=f,this.vecC=m,this.normVecA=h,this.normVecB=l,this.normVecC=p};Na.prototype.getBasisMatrix=function(t){void 0===t&&(t=new fe.Matrix4);var e=t;return e.makeBasis(this.normVecB,this.normVecA,this.normVecC),e.determinant()<0&&e.scale($a),e},Na.prototype.getRotationQuaternion=function(t){void 0===t&&(t=new fe.Quaternion);var e=t;return e.setFromRotationMatrix(this.getBasisMatrix(La)),e.inverse()},Na.prototype.getProjectedScaleForAtoms=function(t){var s=-1/0,c=-1/0,u=-1/0,h=-1/0,l=-1/0,p=-1/0,d=new fe.Vector3,f=new fe.Vector3,m=this.center,g=this.normVecA,y=this.normVecB,v=this.normVecC;return t.eachAtom(function(t){ii(d.copy(t),g,m);var e=f.subVectors(d,m).normalize().dot(g),r=d.distanceTo(m);0<e?s<r&&(s=r):c<r&&(c=r),ii(d.copy(t),y,m);var i=f.subVectors(d,m).normalize().dot(y),o=d.distanceTo(m);0<i?u<o&&(u=o):h<o&&(h=o),ii(d.copy(t),v,m);var n=f.subVectors(d,m).normalize().dot(v),a=d.distanceTo(m);0<n?l<a&&(l=a):p<a&&(p=a)}),{d1a:s,d2a:u,d3a:l,d1b:-c,d2b:-h,d3b:-p}};var za=function(t,e,r,i){this.volume=t,this.setFilter(e,r,i)},ja={header:{configurable:!0},matrix:{configurable:!0},normalMatrix:{configurable:!0},inverseMatrix:{configurable:!0},center:{configurable:!0},boundingBox:{configurable:!0},min:{configurable:!0},max:{configurable:!0},mean:{configurable:!0},rms:{configurable:!0}};ja.header.get=function(){return this.volume.header},ja.matrix.get=function(){return this.volume.matrix},ja.normalMatrix.get=function(){return this.volume.normalMatrix},ja.inverseMatrix.get=function(){return this.volume.inverseMatrix},ja.center.get=function(){return this.volume.center},ja.boundingBox.get=function(){return this.volume.boundingBox},ja.min.get=function(){return this.volume.min},ja.max.get=function(){return this.volume.max},ja.mean.get=function(){return this.volume.mean},ja.rms.get=function(){return this.volume.rms},za.prototype._getFilterHash=function(t,e,r){return JSON.stringify([t,e,r])},za.prototype.setFilter=function(t,e,r){isNaN(t)&&this.header&&(t=this.header.DMEAN+2*this.header.ARMS),t=void 0===t||isNaN(t)?-1/0:t,e=st(e,1/0),r=st(r,!1);var i=this.volume.data,o=this.volume.position,n=this.volume.atomindex,a=this._getFilterHash(t,e,r);if(a!==this._filterHash){if(t===-1/0&&e===1/0)this.data=i,this.position=o,this.atomindex=n;else{var s=i.length;this._dataBuffer||(this._dataBuffer=new ArrayBuffer(4*s),this._positionBuffer=new ArrayBuffer(3*s*4),n&&(this._atomindexBuffer=new ArrayBuffer(4*s)));var c,u=new Float32Array(this._dataBuffer),h=new Float32Array(this._positionBuffer);n&&(c=new Uint32Array(this._atomindexBuffer));for(var l=0,p=0;p<s;++p){var d=3*p,f=i[p];if(!r&&t<=f&&f<=e||r&&(f<t||e<f)){var m=3*l;u[l]=f,h[m+0]=o[d+0],h[m+1]=o[d+1],h[m+2]=o[d+2],n&&c&&(c[l]=n[p]),l+=1}}this.data=new Float32Array(this._dataBuffer,0,l),this.position=new Float32Array(this._positionBuffer,0,3*l),n&&(this.atomindex=new Int32Array(this._atomindexBuffer,0,l))}this._filterHash=a}},Object.defineProperties(za.prototype,ja),za.prototype.getValueForSigma=ta.prototype.getValueForSigma,za.prototype.getSigmaForValue=ta.prototype.getSigmaForValue,za.prototype.getDataAtomindex=ta.prototype.getDataAtomindex,za.prototype.getDataPosition=ta.prototype.getDataPosition,za.prototype.getDataColor=ta.prototype.getDataColor,za.prototype.getDataPicking=ta.prototype.getDataPicking,za.prototype.getDataSize=ta.prototype.getDataSize;var Va=function(t,e){var r=qi({nodeArray1:t.atomIndex1,nodeArray2:t.atomIndex2,edgeCount:t.count,nodeCount:e});this.countArray=r.countArray,this.offsetArray=r.offsetArray,this.indexArray=r.indexArray},Ga=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["atomIndex1",1,"int32"],["atomIndex2",1,"int32"],["bondOrder",1,"int8"]]},e.prototype.addBond=function(t,e,r){this.growIfFull();var i=this.count,o=t.index,n=e.index;o<n?(this.atomIndex1[i]=o,this.atomIndex2[i]=n):(this.atomIndex2[i]=o,this.atomIndex1[i]=n),r&&(this.bondOrder[i]=r),this.count+=1},e.prototype.addBondIfConnected=function(t,e,r){return!!t.connectedTo(e)&&(this.addBond(t,e,r),!0)},Object.defineProperties(e.prototype,r),e}(Gi),Ua=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["residueIndex",1,"uint32"],["atomTypeId",1,"uint16"],["x",1,"float32"],["y",1,"float32"],["z",1,"float32"],["serial",1,"int32"],["bfactor",1,"float32"],["altloc",1,"uint8"],["occupancy",1,"float32"]]},e.prototype.setAltloc=function(t,e){this.altloc[t]=e.charCodeAt(0)},e.prototype.getAltloc=function(t){var e=this.altloc[t];return e?String.fromCharCode(e):""},Object.defineProperties(e.prototype,r),e}(Gi),Ha=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["chainIndex",1,"uint32"],["atomOffset",1,"uint32"],["atomCount",1,"uint16"],["residueTypeId",1,"uint16"],["resno",1,"int32"],["sstruc",1,"uint8"],["inscode",1,"uint8"]]},e.prototype.setSstruc=function(t,e){this.sstruc[t]=e.charCodeAt(0)},e.prototype.getSstruc=function(t){var e=this.sstruc[t];return e?String.fromCharCode(e):""},e.prototype.setInscode=function(t,e){this.inscode[t]=e.charCodeAt(0)},e.prototype.getInscode=function(t){var e=this.inscode[t];return e?String.fromCharCode(e):""},Object.defineProperties(e.prototype,r),e}(Gi),Wa=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["entityIndex",1,"uint16"],["modelIndex",1,"uint16"],["residueOffset",1,"uint32"],["residueCount",1,"uint32"],["chainname",4,"uint8"],["chainid",4,"uint8"]]},e.prototype.setChainname=function(t,e){var r=4*t;this.chainname[r]=e.charCodeAt(0),this.chainname[r+1]=e.charCodeAt(1),this.chainname[r+2]=e.charCodeAt(2),this.chainname[r+3]=e.charCodeAt(3)},e.prototype.getChainname=function(t){for(var e="",r=0;r<4;++r){var i=this.chainname[4*t+r];if(!i)break;e+=String.fromCharCode(i)}return e},e.prototype.setChainid=function(t,e){var r=4*t;this.chainid[r]=e.charCodeAt(0),this.chainid[r+1]=e.charCodeAt(1),this.chainid[r+2]=e.charCodeAt(2),this.chainid[r+3]=e.charCodeAt(3)},e.prototype.getChainid=function(t){for(var e="",r=0;r<4;++r){var i=this.chainid[4*t+r];if(!i)break;e+=String.fromCharCode(i)}return e},Object.defineProperties(e.prototype,r),e}(Gi),qa=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["chainOffset",1,"uint32"],["chainCount",1,"uint32"]]},Object.defineProperties(e.prototype,r),e}(Gi),Xa=function(t){this.polymer=t,this.size=t.residueCount};Xa.prototype.getCenterIterator=function(s){void 0===s&&(s=0);var c=this.getPosition().center,u=c.length/3,h=0,e=-1,l=[new fe.Vector3,new fe.Vector3,new fe.Vector3,new fe.Vector3];return{size:u,next:function(){var t=this.get(e);return e+=1,t},get:function(t){t=Math.min(u-1,Math.max(0,t));var e=l[h%4],r=3*t;if(e.fromArray(c,r),s){for(var i=Math.min(s,t,u-t-1),o=1;o<=i;++o){var n=3*o,a=(i+1-o)/(i+1);e.x+=a*c[r-n+0]+a*c[r+n+0],e.y+=a*c[r-n+1]+a*c[r+n+1],e.z+=a*c[r-n+2]+a*c[r+n+2]}e.x/=i+1,e.y/=i+1,e.z/=i+1}return h+=1,e},reset:function(){h=0,e=-1}}},Xa.prototype.getColor=function(t){var e=this.polymer,r=e.structure,i=e.residueCount,o=e.residueIndexStart,n=new Float32Array(3*i),a=t||{};a.structure=r;for(var s=Vt.getScheme(a),c=r.getResidueProxy(),u=r.getAtomProxy(),h=0;h<i;++h)c.index=o+h,u.index=c.traceAtomIndex,s.atomColorToArray(u,n,3*h);return{color:n}},Xa.prototype.getPicking=function(){for(var t=this.polymer,e=t.structure,r=t.residueCount,i=t.residueIndexStart,o=new Float32Array(r),n=e.getResidueProxy(),a=0;a<r;++a)n.index=i+a,o[a]=n.traceAtomIndex;return{picking:new on(o,e)}},Xa.prototype.getSize=function(t){for(var e=this.polymer,r=e.structure,i=e.residueCount,o=e.residueIndexStart,n=new Float32Array(i),a=new Ea(t),s=r.getResidueProxy(),c=r.getAtomProxy(),u=0;u<i;++u)s.index=o+u,c.index=s.traceAtomIndex,n[u]=a.atomRadius(c);return{size:n}},Xa.prototype.getPosition=function(){for(var t=this.polymer,e=t.structure,r=t.residueCount,i=r-3,o=new Float32Array(3*r),n=new Float32Array(3*r),a=new Float32Array(r),s=new Float32Array(r),c=new Float32Array(r),u=new Float32Array(r),h=new Float32Array(3*r),l=new fe.Vector3,p=new fe.Vector3,d=new fe.Vector3,f=new fe.Vector3,m=new fe.Vector3,g=new fe.Vector3,y=new fe.Vector3,v=new fe.Vector3,b=new fe.Vector3,x=new fe.Vector3,_=new fe.Vector3,w=new fe.Vector3(0,0,0),A="trace",S=e.getAtomProxy(),C=e.getAtomProxy(t.getAtomIndexByType(0,A)),P=e.getAtomProxy(t.getAtomIndexByType(1,A)),I=e.getAtomProxy(t.getAtomIndexByType(2,A)),O=0;O<i;++O){S.index=C.index,C.index=P.index,P.index=I.index,I.index=t.getAtomIndexByType(O+3,A);var k=3*O;l.subVectors(C,S),p.subVectors(P,C),d.subVectors(I,P),f.subVectors(l,p),m.subVectors(p,d),b.crossVectors(f,m).normalize(),b.toArray(n,k),0<O&&(a[O]=b.angleTo(x));var M=Math.cos(f.angleTo(m));u[O]=180/Math.PI*Math.acos(M);var B=f.length(),T=m.length();s[O]=Math.sqrt(T*B)/Math.max(2,2*(1-M)),c[O]=Math.abs(p.dot(b)),g.copy(f).multiplyScalar(s[O]/B),y.copy(m).multiplyScalar(s[O]/T),g.subVectors(C,g),y.subVectors(P,y),g.toArray(o,k+3),y.toArray(o,k+6),_.subVectors(S,w),_.toArray(h,k),x.copy(b),w.copy(g)}g.fromArray(o,3),y.fromArray(o,6),b.subVectors(g,y).normalize(),S.index=t.getAtomIndexByType(0,A),w.copy(S),v.copy(S),ii(v,b,g),v.toArray(o,0),_.subVectors(w,g),_.toArray(h,0),g.fromArray(o,3*r-6),y.fromArray(o,3*r-9),b.subVectors(g,y).normalize(),S.index=t.getAtomIndexByType(r-1,A),w.copy(S),v.copy(S),ii(v,b,g),v.toArray(o,3*r-3);for(var D=r-3;D<r;++D)g.fromArray(o,3*D),S.index=t.getAtomIndexByType(D,A),w.copy(S),_.subVectors(w,g),_.toArray(h,3*D);var R=new Float32Array(r),F=new Float32Array(r),E=new Float32Array(r),$=new Float32Array(r);R[1]=s[0],F[1]=u[0],E[1]=s[0];for(var L=2;L<r-2;++L)R[L]=.5*(s[L-2]+s[L-1]),F[L]=.5*(u[L-2]+u[L-1]),E[L]=.5*(c[L-2]+c[L-1]),g.fromArray(n,3*(L-2)),y.fromArray(n,3*(L-1)),$[L]=180/Math.PI*Math.acos(Math.cos(g.angleTo(y)));R[r-2]=s[r-4],F[r-2]=u[r-4],E[r-2]=c[r-4];var N=new Float32Array(3*r);Le(n,N,0,0,3),Le(n,N,0,3,3);for(var z=2;z<r-2;++z)g.fromArray(n,3*(z-2)),y.fromArray(n,3*(z-1)),b.addVectors(y,g).multiplyScalar(.5).normalize(),b.toArray(N,3*z);return Le(n,N,3*r-12,3*r-6,3),Le(n,N,3*r-12,3*r-3,3),{center:o,axis:N,bending:$,radius:R,rise:E,twist:F,resdir:h}};var Ya=function(t){this.polymer=t,this.helixorient=new Xa(t),this.position=this.helixorient.getPosition()};Ya.prototype.getAxis=function(t,e,r,i,o){t=t||30,e=e||2.5,r=void 0!==r&&r;var n=this.polymer,a=n.structure,s=n.residueCount,c=n.residueIndexStart,u=this.position,h=i||{};h.structure=a;for(var l,p,d=Vt.getScheme(h),f=new Ea(o),m=0,g=0,y=[],v=[],b=[],x=[],_=[],w=[],A=[],S=[],C=[],P=new Float32Array(3*s),I=new Float32Array(3*s),O=new fe.Vector3,k=new fe.Vector3,M=a.getResidueProxy(),B=a.getResidueProxy(),T=a.getAtomProxy(),D=new fe.Vector3,R=new fe.Vector3,F=!1,E=0;E<s;++E)if(M.index=c+E,D.fromArray(u.center,3*E),E===s-1?F=!0:(B.index=c+E+1,R.fromArray(u.center,3*E+3),r&&M.sstruc!==B.sstruc?F=!0:D.distanceTo(R)>e?F=!0:u.bending[E]>t&&(F=!0)),F){if(E-m<4){m=E,F=!1;continue}T.index=M.traceAtomIndex,P=u.axis.subarray(3*m+3,3*E),I=u.center.subarray(3*m,3*E+3),l=ri(P).normalize(),p=ri(I),O.fromArray(I),ii(O,l,p),k.fromArray(I,I.length-3),ii(k,l,p),l.subVectors(k,O),l.toArray(y,g),p.toArray(v,g),O.toArray(b,g),k.toArray(x,g),d.atomColorToArray(T,_,g),w.push(T.index),A.push(f.atomRadius(T)),S.push(c+m),C.push(c+E+1-m),g+=3,m=E,F=!1}var $=new Float32Array(w);return{axis:new Float32Array(y),center:new Float32Array(v),begin:new Float32Array(b),end:new Float32Array(x),color:new Float32Array(_),picking:new on($,a),size:new Float32Array(A),residueOffset:S,residueCount:C}};var Ka=function(t){this.scoreFunction=t,this.content=[],this.scoreFunction=t};Ka.prototype.push=function(t){this.content.push(t),this.bubbleUp(this.content.length-1)},Ka.prototype.pop=function(){var t=this.content[0],e=this.content.pop();return e&&0<this.content.length&&(this.content[0]=e,this.sinkDown(0)),t},Ka.prototype.peek=function(){return this.content[0]},Ka.prototype.remove=function(t){for(var e=this.content.length,r=0;r<e;r++)if(this.content[r]===t){var i=this.content.pop();return void(i&&r!==e-1&&(this.content[r]=i,this.scoreFunction(i)<this.scoreFunction(t)?this.bubbleUp(r):this.sinkDown(r)))}throw new Error("Node not found.")},Ka.prototype.size=function(){return this.content.length},Ka.prototype.bubbleUp=function(t){for(var e=this.content[t];0<t;){var r=Math.floor((t+1)/2)-1,i=this.content[r];if(!(this.scoreFunction(e)<this.scoreFunction(i)))break;this.content[r]=e,this.content[t]=i,t=r}},Ka.prototype.sinkDown=function(t){for(var e=this.content.length,r=this.content[t],i=this.scoreFunction(r),o=0;;){var n=2*(t+1),a=n-1,s=null;if(a<e){var c=this.content[a];(o=this.scoreFunction(c))<i&&(s=a)}if(n<e){var u=this.content[n];this.scoreFunction(u)<(null===s?i:o)&&(s=n)}if(null===s)break;this.content[t]=this.content[s],this.content[s]=r,t=s}};var Za=function(t,e){this.points=t,this.metric=e,this.maxDepth=0,this.currentNode=0;for(var r=t.length/3,i=new Uint32Array(r),o=0;o<r;++o)i[o]=o;this.indices=i,this.nodes=new Int32Array(4*r),this.rootIndex=this.buildTree(0,-1,0,r)};Za.prototype.buildTree=function(t,e,r,i){t>this.maxDepth&&(this.maxDepth=t);var o=i-r;if(0===o)return-1;var n=4*this.currentNode,a=this.nodes;if(this.currentNode+=1,1===o)return a[n]=r,a[n+1]=-1,a[n+2]=-1,a[n+3]=e,n;for(var s,c,u,h,l,p=this.indices,d=this.points,f=r+Math.floor(o/2),m=t%3,g=r,y=i-1;g<y;){for(h=d[3*p[u=g+y>>1]+m],c=p[u],p[u]=p[y],p[y]=c,s=l=g;s<y;++s)d[3*p[s]+m]<h&&(c=p[l],p[l]=p[s],p[s]=c,++l);if(c=p[y],p[y]=p[l],p[l]=c,f===(u=l))break;f<u?y=u-1:g=u+1}return a[n]=f,a[n+1]=this.buildTree(t+1,n,r,f),a[n+2]=this.buildTree(t+1,n,f+1,i),a[n+3]=e,n},Za.prototype.getNodeDepth=function(t){var e=this.nodes[t+3];return-1===e?0:this.getNodeDepth(e)+1},Za.prototype.nearest=function(d,f,m){var g=this,y=new Ka(function(t){return-t[1]}),v=this.nodes,b=this.points,x=this.indices,_=function(t){var e,r,i=g.getNodeDepth(t)%3,o=3*x[v[t]],n=[b[o+0],b[o+1],b[o+2]],a=g.metric(d,n);function s(t,e){y.push([t,e]),y.size()>f&&y.pop()}var c=v[t+1],u=v[t+2];if(-1!==u||-1!==c){e=-1===u?c:-1===c?u:d[i]<=b[o+i]?c:u,_(e),(y.size()<f||a<y.peek()[1])&&a<=m&&s(t,a);for(var h=[],l=0;l<3;l+=1)h[l]=l===i?d[l]:b[o+l];var p=g.metric(h,n);(y.size()<f||Math.abs(p)<y.peek()[1])&&Math.abs(p)<=m&&-1!==(r=e===c?u:c)&&_(r)}else(y.size()<f||a<y.peek()[1])&&a<=m&&s(t,a)};_(this.rootIndex);for(var t=[],e=0,r=Math.min(y.size(),f);e<r;e+=1)t.push(y.content[e]);return t},Za.prototype.verify=function(t,e){void 0===e&&(e=0);var r=1;if(void 0===t&&(t=this.rootIndex),-1===t)throw new Error("node is null");var i=e%3,o=this.nodes,n=this.points,a=this.indices,s=o[t+1],c=o[t+2];if(-1!==s){if(n[3*a[o[s]]+i]>n[3*a[o[t]]+i])throw new Error("left child is > parent!");r+=this.verify(s,e+1)}if(-1!==c){if(n[3*a[o[c]]+i]<n[3*a[o[t]]+i])throw new Error("right child is < parent!");r+=this.verify(c,e+1)}return r};var Qa=function(t,e){void 0===e&&(e=0),this.structure=t,this.index=e,this.chainStore=t.chainStore,this.residueStore=t.residueStore,this.atomStore=t.atomStore,this.residueMap=t.residueMap,this.atomMap=t.atomMap},Ja={bondHash:{configurable:!0},entity:{configurable:!0},entityIndex:{configurable:!0},modelIndex:{configurable:!0},chainIndex:{configurable:!0},residue:{configurable:!0},residueIndex:{configurable:!0},sstruc:{configurable:!0},inscode:{configurable:!0},resno:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0},residueType:{configurable:!0},atomType:{configurable:!0},residueAtomOffset:{configurable:!0},resname:{configurable:!0},hetero:{configurable:!0},atomname:{configurable:!0},number:{configurable:!0},element:{configurable:!0},vdw:{configurable:!0},covalent:{configurable:!0},x:{configurable:!0},y:{configurable:!0},z:{configurable:!0},serial:{configurable:!0},bfactor:{configurable:!0},occupancy:{configurable:!0},altloc:{configurable:!0},partialCharge:{configurable:!0},radius:{configurable:!0},formalCharge:{configurable:!0},aromatic:{configurable:!0},bondCount:{configurable:!0}};function ts(t,e){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return r*r+i*i+o*o}function es(t,e){return Math.sqrt(ts(t,e))}Ja.bondHash.get=function(){return this.structure.bondHash},Ja.entity.get=function(){return this.structure.entityList[this.entityIndex]},Ja.entityIndex.get=function(){return this.chainStore.entityIndex[this.chainIndex]},Ja.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},Ja.chainIndex.get=function(){return this.residueStore.chainIndex[this.residueIndex]},Ja.residue.get=function(){return console.warn("residue - might be expensive"),this.structure.getResidueProxy(this.residueIndex)},Ja.residueIndex.get=function(){return this.atomStore.residueIndex[this.index]},Ja.residueIndex.set=function(t){this.atomStore.residueIndex[this.index]=t},Ja.sstruc.get=function(){return this.residueStore.getSstruc(this.residueIndex)},Ja.inscode.get=function(){return this.residueStore.getInscode(this.residueIndex)},Ja.resno.get=function(){return this.residueStore.resno[this.residueIndex]},Ja.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},Ja.chainid.get=function(){return this.chainStore.getChainid(this.chainIndex)},Ja.residueType.get=function(){return this.residueMap.get(this.residueStore.residueTypeId[this.residueIndex])},Ja.atomType.get=function(){return this.atomMap.get(this.atomStore.atomTypeId[this.index])},Ja.residueAtomOffset.get=function(){return this.residueStore.atomOffset[this.residueIndex]},Ja.resname.get=function(){return this.residueType.resname},Ja.hetero.get=function(){return this.residueType.hetero},Ja.atomname.get=function(){return this.atomType.atomname},Ja.number.get=function(){return this.atomType.number},Ja.element.get=function(){return this.atomType.element},Ja.vdw.get=function(){return this.atomType.vdw},Ja.covalent.get=function(){return this.atomType.covalent},Ja.x.get=function(){return this.atomStore.x[this.index]},Ja.x.set=function(t){this.atomStore.x[this.index]=t},Ja.y.get=function(){return this.atomStore.y[this.index]},Ja.y.set=function(t){this.atomStore.y[this.index]=t},Ja.z.get=function(){return this.atomStore.z[this.index]},Ja.z.set=function(t){this.atomStore.z[this.index]=t},Ja.serial.get=function(){return this.atomStore.serial[this.index]},Ja.serial.set=function(t){this.atomStore.serial[this.index]=t},Ja.bfactor.get=function(){return this.atomStore.bfactor[this.index]},Ja.bfactor.set=function(t){this.atomStore.bfactor[this.index]=t},Ja.occupancy.get=function(){return this.atomStore.occupancy[this.index]},Ja.occupancy.set=function(t){this.atomStore.occupancy[this.index]=t},Ja.altloc.get=function(){return this.atomStore.getAltloc(this.index)},Ja.altloc.set=function(t){this.atomStore.setAltloc(this.index,t)},Ja.partialCharge.get=function(){return this.atomStore.partialCharge?this.atomStore.partialCharge[this.index]:null},Ja.partialCharge.set=function(t){this.atomStore.partialCharge&&(this.atomStore.partialCharge[this.index]=t)},Ja.radius.get=function(){return this.atomStore.radius?this.atomStore.radius[this.index]:null},Ja.radius.set=function(t){this.atomStore.radius&&(this.atomStore.radius[this.index]=t)},Ja.formalCharge.get=function(){return this.atomStore.formalCharge?this.atomStore.formalCharge[this.index]:null},Ja.formalCharge.set=function(t){this.atomStore.formalCharge&&(this.atomStore.formalCharge[this.index]=t)},Ja.aromatic.get=function(){return this.atomStore.aromatic?this.atomStore.aromatic[this.index]:this.residueType.isAromatic(this)?1:0},Ja.aromatic.set=function(t){this.atomStore.aromatic&&(this.atomStore.aromatic[this.index]=t)},Ja.bondCount.get=function(){return this.bondHash.countArray[this.index]},Qa.prototype.eachBond=function(t,e){e=e||this.structure._bp;for(var r=this.index,i=this.bondHash,o=i.indexArray,n=i.countArray[r],a=i.offsetArray[r],s=0;s<n;++s)e.index=o[a+s],t(e)},Qa.prototype.eachBondedAtom=function(e,t){var r=t||this.structure._ap,i=this.index;this.eachBond(function(t){r.index=i!==t.atomIndex1?t.atomIndex1:t.atomIndex2,e(r)}),this.index=i},Qa.prototype.hasBondTo=function(e){var r=!1;return this.eachBondedAtom(function(t){e.index===t.index&&(r=!0)}),r},Qa.prototype.bondToElementCount=function(e){var r=0,t=this.index;return this.eachBondedAtom(function(t){t.number===e&&(r+=1)}),this.index=t,r},Qa.prototype.hasBondToElement=function(t){return 0<this.bondToElementCount(t)},Qa.prototype.isBackbone=function(){var t=this.residueType.backboneIndexList;return 0<t.length&&t.includes(this.index-this.residueAtomOffset)},Qa.prototype.isPolymer=function(){if(0<this.structure.entityList.length)return this.entity.isPolymer();var t=this.residueType.moleculeType;return 3===t||4===t||5===t},Qa.prototype.isSidechain=function(){return this.isPolymer()&&!this.isBackbone()},Qa.prototype.isCg=function(){var t=this.residueType.backboneType;return 4===t||5===t||6===t},Qa.prototype.isTrace=function(){return this.index===this.residueType.traceAtomIndex+this.residueAtomOffset},Qa.prototype.isHetero=function(){return 1===this.residueType.hetero},Qa.prototype.isProtein=function(){return 3===this.residueType.moleculeType},Qa.prototype.isNucleic=function(){var t=this.residueType.moleculeType;return 4===t||5===t},Qa.prototype.isRna=function(){return 4===this.residueType.moleculeType},Qa.prototype.isDna=function(){return 5===this.residueType.moleculeType},Qa.prototype.isWater=function(){return 1===this.residueType.moleculeType},Qa.prototype.isIon=function(){return 2===this.residueType.moleculeType},Qa.prototype.isSaccharide=function(){return 6===this.residueType.moleculeType},Qa.prototype.isHelix=function(){return io.includes(this.sstruc)},Qa.prototype.isSheet=function(){return oo.includes(this.sstruc)},Qa.prototype.isTurn=function(){return no.includes(this.sstruc)&&this.isProtein()},Qa.prototype.isBonded=function(){return 0!==this.bondHash.countArray[this.index]},Qa.prototype.isRing=function(){return void 0!==this.residueType.getRings().atomRings[this.index-this.residueAtomOffset]},Qa.prototype.isAromatic=function(){return 1===this.aromatic},Qa.prototype.isMetal=function(){return this.atomType.isMetal()},Qa.prototype.isNonmetal=function(){return this.atomType.isNonmetal()},Qa.prototype.isMetalloid=function(){return this.atomType.isMetalloid()},Qa.prototype.isHalogen=function(){return this.atomType.isHalogen()},Qa.prototype.isDiatomicNonmetal=function(){return this.atomType.isDiatomicNonmetal()},Qa.prototype.isPolyatomicNonmetal=function(){return this.atomType.isPolyatomicNonmetal()},Qa.prototype.isAlkaliMetal=function(){return this.atomType.isAlkaliMetal()},Qa.prototype.isAlkalineEarthMetal=function(){return this.atomType.isAlkalineEarthMetal()},Qa.prototype.isNobleGas=function(){return this.atomType.isNobleGas()},Qa.prototype.isTransitionMetal=function(){return this.atomType.isTransitionMetal()},Qa.prototype.isPostTransitionMetal=function(){return this.atomType.isPostTransitionMetal()},Qa.prototype.isLanthanide=function(){return this.atomType.isLanthanide()},Qa.prototype.isActinide=function(){return this.atomType.isActinide()},Qa.prototype.getDefaultValence=function(){return this.atomType.getDefaultValence()},Qa.prototype.getValenceList=function(){return this.atomType.getValenceList()},Qa.prototype.getOuterShellElectronCount=function(){return this.atomType.getOuterShellElectronCount()},Qa.prototype.distanceTo=function(t){var e=this.atomStore,r=t.atomStore,i=this.index,o=t.index,n=e.x[i]-r.x[o],a=e.y[i]-r.y[o],s=e.z[i]-r.z[o],c=n*n+a*a+s*s;return Math.sqrt(c)},Qa.prototype.connectedTo=function(t){var e=this.atomStore,r=t.atomStore,i=this.index,o=t.index;if(e.altloc&&r.altloc){var n=e.altloc[i],a=r.altloc[o];if(0!==n&&0!==a&&32!==n&&32!==a&&n!==a)return!1}var s=e.x[i]-r.x[o],c=e.y[i]-r.y[o],u=e.z[i]-r.z[o],h=s*s+c*c+u*u;if(h<48&&this.isCg())return!0;if(isNaN(h))return!1;var l=this.covalent+t.covalent,p=l+.3,d=l-.5;return h<p*p&&d*d<h},Qa.prototype.positionFromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this},Qa.prototype.positionToArray=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var r=this.index,i=this.atomStore;return t[e+0]=i.x[r],t[e+1]=i.y[r],t[e+2]=i.z[r],t},Qa.prototype.positionToVector3=function(t){return void 0===t&&(t=new fe.Vector3),t.x=this.x,t.y=this.y,t.z=this.z,t},Qa.prototype.positionFromVector3=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},Qa.prototype.positionAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},Qa.prototype.positionSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},Qa.prototype.getResidueBonds=function(t){void 0===t&&(t=!1);var e,r,i,o,n=this.residueAtomOffset,a=this.index-this.residueAtomOffset,s=this.residueType.getBonds(),c=s.atomIndices1,u=s.atomIndices2;for(t||(o=[]),e=c.indexOf(a);-1!==e;){if(i=u[e]+n,!o)return i;o.push(i),e=c.indexOf(a,e+1)}for(r=u.indexOf(a);-1!==r;){if(i=c[r]+n,!o)return i;o.push(i),r=u.indexOf(a,r+1)}return o},Qa.prototype.qualifiedName=function(t){void 0===t&&(t=!1);var e="";return this.resname&&!t&&(e+="["+this.resname+"]"),void 0!==this.resno&&(e+=this.resno),this.inscode&&(e+="^"+this.inscode),this.chainname&&(e+=":"+this.chainname),this.atomname&&(e+="."+this.atomname),this.altloc&&(e+="%"+this.altloc),1<this.structure.modelStore.count&&(e+="/"+this.modelIndex),e},Qa.prototype.clone=function(){return new Qa(this.structure,this.index)},Qa.prototype.toObject=function(){return{index:this.index,residueIndex:this.residueIndex,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,modelIndex:this.modelIndex}},Object.defineProperties(Qa.prototype,Ja);var rs=new Float32Array(3),is=function(t,e){void 0===e&&(e=!1),de.Debug&&me.time("Kdtree build");var r=e?ts:es,i=new Float32Array(3*t.atomCount),o=new Uint32Array(t.atomCount),n=0;t.eachAtom(function(t){i[n+0]=t.x,i[n+1]=t.y,i[n+2]=t.z,o[n/3]=t.index,n+=3}),this.atomIndices=o,this.points=i,this.kdtree=new Za(i,r),de.Debug&&me.timeEnd("Kdtree build")};is.prototype.nearest=function(t,e,r){t instanceof fe.Vector3?t.toArray(rs):t instanceof Qa&&t.positionToArray(rs);for(var i=this.kdtree.nearest(rs,e,r),o=this.kdtree.indices,n=this.kdtree.nodes,a=this.atomIndices,s=[],c=0,u=i.length;c<u;++c){var h=i[c],l=h[0],p=h[1];s.push({index:a[o[n[l]]],distance:p})}return s};var os={" ":"X","!":"Y","#":"Z",$:"-X","%":"-Y","&":"-Z","'":"Y+1/2","(":"1/2+X",")":"1/2+Y","*":"1/2-X","+":"1/2+Z",",":"1/2-Y","-":"1/2-Z",".":"X+1/2","/":"Z+1/2",0:"-X+1/2",1:"-Y+1/2",2:"-Z+1/2",3:"1/4+X",4:"1/4-Y",5:"1/4+Z",6:"1/4-X",7:"1/4+Y",8:"3/4-Y",9:"3/4+Z",":":"3/4+Y",";":"3/4+X","<":"3/4-X","=":"1/4-Z",">":"3/4-Z","?":"X-Y","@":"Y-X",A:"Z+1/3",B:"Z+2/3",C:"X+2/3",D:"Y+1/3",E:"-Y+2/3",F:"X-Y+1/3",G:"Y-X+2/3",H:"-X+1/3",I:"X+1/3",J:"Y+2/3",K:"-Y+1/3",L:"X-Y+2/3",M:"Y-X+1/3",N:"-X+2/3",O:"2/3+X",P:"1/3+Y",Q:"1/3+Z",R:"2/3-Y",S:"1/3+X-Y",T:"2/3+Y-X",U:"1/3-X",V:"2/3-X",W:"1/3-Y",X:"1/3-Z",Y:"2/3+Y",Z:"1/3+Y-X","[":"2/3+X-Y","]":"1/3+X","^":"2/3+Z",_:"2/3-Z","`":"5/6+Z",a:"1/6+Z",b:"5/6-Z",c:"1/6-Z",d:"Z+5/6",e:"Z+1/6",f:"Z+1/4",g:"+Y"},ns={"P 1":" !#","P -1":" !#$%&","P 1 2 1":" !#$!&","P 1 21 1":" !#$'&","C 1 2 1":" !#$!&()#*)&","P 1 m 1":" !# %#","P 1 c 1":" !# %+","C 1 m 1":" !# %#()#(,#","C 1 c 1":" !# %+()#(,+","P 1 2/m 1":" !# %#$!&$%&","P 1 21/m 1":" !#$)&$%& ,#","C 1 2/m 1":" !# %#$!&$%&()#(,#*)&*,&","P 1 2/c 1":" !#$!-$%& %+","P 1 21/c 1":" !#$%&$)- ,+","C 1 2/c 1":" !#$!-$%& %+()#*)-*,&(,+","P 2 2 2":" !#$%#$!& %&","P 2 2 21":" !#$%+$!- %&","P 21 21 2":" !#$%#*)&(,&","P 21 21 21":" !#*%+$)-(,&","C 2 2 21":" !#$%+$!- %&()#*,+*)-(,&","C 2 2 2":" !#$%#$!& %&()#*,#*)&(,&","F 2 2 2":" !#$%#$!& %& )+$,+$)- ,-(!+*%+*!-(%-()#*,#*)&(,&","I 2 2 2":" !#$%# %&$!&.'/01/.120'2","I 21 21 21":" !#*%+$)-(,&()+$,#*!& %-","P m m 2":" !#$%# %#$!#","P m c 21":" !#$%+ %+$!#","P c c 2":" !#$%# %+$!+","P m a 2":" !#$%#(%#*!#","P c a 21":" !#$%+(%#*!+","P n c 2":" !#$%# ,+$)+","P m n 21":" !#*%+(%+$!#","P b a 2":" !#$%#(,#*)#","P n a 21":" !#$%+(,#*)+","P n n 2":" !#$%#(,+*)+","C m m 2":" !#$%# %#$!#()#*,#(,#*)#","C m c 21":" !#$%+ %+$!#()#*,+(,+*)#","C c c 2":" !#$%# %+$!+()#*,#(,+*)+","A m m 2":" !#$%# %#$!# )+$,+ ,+$)+","A b m 2":" !#$%# ,#$)# )+$,+ %+$!+","A m a 2":" !#$%#(%#*!# )+$,+(,+*)+","A b a 2":" !#$%#(,#*)# )+$,+(%+*!+","F m m 2":" !#$%# %#$!# )+$,+ ,+$)+(!+*%+(%+*!+()#*,#(,#*)#","F d d 2":" !#$%#345675 )+$,+3896:9(!+*%+;49<79()#*,#;85<:5","I m m 2":" !#$%# %#$!#()+*,+(,+*)+","I b a 2":" !#$%#(,#*)#()+*,+ %+$!+","I m a 2":" !#$%#(%#*!#()+*,+ ,+$)+","P 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#","P 2/n 2/n 2/n":" !#$%#$!& %&*,-()-(,+*)+","P 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+","P 2/b 2/a 2/n":" !#$%#$!& %&*,&()&(,#*)#","P 21/m 2/m 2/a":" !#*%#$!&(%&$%&(!& %#*!#","P 2/n 21/n 2/a":" !#*%#*)- ,-$%&(!&(,+$)+","P 2/m 2/n 21/a":" !#*%+*!- %&$%&(!-(%+$!#","P 21/c 2/c 2/a":" !#*%#$!-(%-$%&(!& %+*!+","P 21/b 21/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#","P 21/c 21/c 2/n":" !#*,#$)-(%-$%&()& ,+*!+","P 2/b 21/c 21/m":" !#$%+$)- ,&$%& !- ,+$)#","P 21/n 21/n 2/m":" !#$%#*)-(,-$%& !&(,+*)+","P 21/m 21/m 2/n":" !#$%#*'&.,&*,&.'& %#$!#","P 21/b 2/c 21/n":" !#*,+$!-(,&$%&()- %+*)#","P 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#","P 21/n 21/m 21/a":" !#0%/$'&.12$%&.!2 1#0'/","C 2/m 2/c 21/m":" !#$%+$!- %&$%& !- %+$!#()#*,+*)-(,&*,&()-(,+*)#","C 2/m 2/c 21/a":" !#$,+$)- %&$%& )- ,+$!#()#*%+*!-(,&*,&(!-(%+*)#","C 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()#*,#*)&(,&*,&()&(,#*)#","C 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+()#*,#*)-(,-*,&()&(,+*)+","C 2/m 2/m 2/a":" !#$,#$)& %&$%& )& ,#$!#()#*%#*!&(,&*,&(!&(%#*)#","C 2/c 2/c 2/a":" !#*,#$!&(,&$,-(!- ,+*!+()#$%#*)& %&*%- )-(%+$)+","F 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!# )+$,+$)- ,-$,- )- ,+$)+(!+*%+*!-(%-*%-(!-(%+*!+()#*,#*)&(,&*,&()&(,#*)#","F 2/d 2/d 2/d":" !#$%#$!& %&64=37=345675 )+$,+$)- ,-68>3:>3896:9(!+*%+*!-(%-<4>;7>;49<79()#*,#*)&(,&<8=;:=;85<:5","I 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()+*,+*)-(,-*,-()-(,+*)+","I 2/b 2/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#()+*,+$!- %-*,-()- %+$!+","I 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#()+$,#*!& %-*,- )&(%#$!+","I 21/m 21/m 21/a":" !#$,#$)& %&$%& )& ,#$!#()+*%+*!-(,-*,-(!-(%+*)+","P 4":" !#$%#% #!$#","P 41":" !#$%+% 5!$9","P 42":" !#$%#% +!$+","P 43":" !#$%+% 9!$5","I 4":" !#$%#% #!$#()+*,+,(+)*+","I 41":" !#*,+%(5)$9()+$%#, 9!*5","P -4":" !#$%#!$&% &","I -4":" !#$%#!$&% &()+*,+)*-,(-","P 4/m":" !#$%#% #!$#$%& !&!$&% &","P 42/m":" !#$%#% +!$+$%& !&!$-% -","P 4/n":" !#$%#,(#)*#*,&()&!$&% &","P 42/n":" !#$%#,(+)*+*,-()-!$&% &","I 4/m":" !#$%#% #!$#$%& !&!$&% &()+*,+,(+)*+*,-()-)*-,(-","I 41/a":" !#*,+%(5)$9$,=(!>!$&,(-()+$%#, 9!*5*%> )=)*-% &","P 4 2 2":" !#$%#% #!$#$!& %&! &%$&","P 4 21 2":" !#$%#,(#)*#*)&(,&! &%$&","P 41 2 2":" !#$%+% 5!$9$!& %-! >%$=","P 41 21 2":" !#$%+,(5)*9*)=(,>! &%$-","P 42 2 2":" !#$%#% +!$+$!& %&! -%$-","P 42 21 2":" !#$%#,(+)*+*)-(,-! &%$&","P 43 2 2":" !#$%+% 9!$5$!& %-! =%$>","P 43 21 2":" !#$%+,(9)*5*)>(,=! &%$-","I 4 2 2":" !#$%#% #!$#$!& %&! &%$&()+*,+,(+)*+*)-(,-)(-,*-","I 41 2 2":" !#*,+%(5)$9*!> ,=)(-%$&()+$%#, 9!*5$)=(%>! &,*-","P 4 m m":" !#$%#% #!$# %#$!#%$#! #","P 4 b m":" !#$%#% #!$#(,#*)#,*#)(#","P 42 c m":" !#$%#% +!$+ %+$!+%$#! #","P 42 n m":" !#$%#,(+)*+(,+*)+%$#! #","P 4 c c":" !#$%#% #!$# %+$!+%$+! +","P 4 n c":" !#$%#% #!$#(,+*)+,*+)(+","P 42 m c":" !#$%#% +!$+ %#$!#%$+! +","P 42 b c":" !#$%#% +!$+(,#*)#,*+)(+","I 4 m m":" !#$%#% #!$# %#$!#%$#! #()+*,+,(+)*+(,+*)+,*+)(+","I 4 c m":" !#$%#% #!$# %+$!+%$+! +()+*,+,(+)*+(,#*)#,*#)(#","I 41 m d":" !#*,+%(5)$9 %#*)+%*5) 9()+$%#, 9!*5(,+$!#,$9!(5","I 41 c d":" !#*,+%(5)$9 %+*)#%*9) 5()+$%#, 9!*5(,#$!+,$5!(9","P -4 2 m":" !#$%#% &!$&$!& %&%$#! #","P -4 2 c":" !#$%#% &!$&$!- %-%$+! +","P -4 21 m":" !#$%#% &!$&*)&(,&,*#)(#","P -4 21 c":" !#$%#% &!$&*)-(,-,*+)(+","P -4 m 2":" !#$%#!$&% & %#$!#! &%$&","P -4 c 2":" !#$%#% &!$& %+$!+! -%$-","P -4 b 2":" !#$%#% &!$&(,#*)#)(&,*&","P -4 n 2":" !#$%#% &!$&(,+*)+)(-,*-","I -4 m 2":" !#$%#% &!$& %#$!#! &%$&()+*,+,(-)*-(,+*)+)(-,*-","I -4 c 2":" !#$%#% &!$& %+$!+! -%$-()+*,+,(-)*-(,#*)#)(&,*&","I -4 2 m":" !#$%#% &!$&$!& %&%$#! #()+*,+,(-)*-*)-(,-,*+)(+","I -4 2 d":" !#$%#% &!$&*!>(%>,$9) 9()+*,+,(-)*-$)= ,=%*5!(5","P 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #","P 4/m 2/c 2/c":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +","P 4/n 2/b 2/m":" !#$%#% #!$#$!& %&! &%$&*,&()&)*&,(&(,#*)#,*#)(#","P 4/n 2/n 2/c":" !#$%#% #!$#$!& %&! &%$&*,-()-)*-,(-(,+*)+,*+)(+","P 4/m 21/b 2/m":" !#$%#% #!$#*)&(,&)(&,*&$%& !&!$&% &(,#*)#,*#)(#","P 4/m 21/n 2/c":" !#$%#% #!$#*)-(,-)(-,*-$%& !&!$&% &(,+*)+,*+)(+","P 4/n 21/m 2/m":" !#$%#,(#)*#*)&(,&! &%$&*,&()&!$&% & %#$!#,*#)(#","P 4/n 2/c 2/c":" !#$%#,(#)*#*)-(,-! -%$-*,&()&!$&% & %+$!+,*+)(+","P 42/m 2/m 2/c":" !#$%#% +!$+$!& %&! -%$-$%& !&!$-% - %#$!#%$+! +","P 42/m 2/c 2/m":" !#$%#% +!$+$!- %-! &%$&$%& !&!$-% - %+$!+%$#! #","P 42/n 2/b 2/c":" !#$%#,(+)*+$!- %-)(&,*&*,-()-!$&% &(,#*)#%$+! +","P 42/n 2/n 2/m":" !#$%#,(+)*+$!& %&)(-,*-*,-()-!$&% &(,+*)+%$#! #","P 42/m 21/b 2/c":" !#$%#% +!$+*)&(,&)(-,*-$%& !&!$-% -(,#*)#,*+)(+","P 42/m 21/n 2/m":" !#$%#,./'*/*'-.,-! &%$&$%& !&'*-,.-.,/*'/%$#! #","P 42/n 21/m 2/c":" !#$%#,(+)*+*)-(,-! &%$&*,-()-!$&% & %#$!#,*+)(+","P 42/n 21/c 2/m":" !#$%#,(+)*+*)&(,&! -%$-*,-()-!$&% & %+$!+,*#)(#","I 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #()+*,+,(+)*+*)-(,-)(-,*-*,-()-)*-,(-(,+*)+,*+)(+","I 4/m 2/c 2/m":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +()+*,+,(+)*+*)&(,&)(&,*&*,-()-)*-,(-(,#*)#,*#)(#","I 41/a 2/m 2/d":" !#*,+%(5)$9*!> ,=)(-%$&$,=(!>!$&,(-(,+$!#,$9!(5()+$%#, 9!*5$)=(%>! &,*-*%> )=)*-% & %#*)+%*5) 9","I 41/a 2/c 2/d":" !#*,+%(5)$9*!= ,>)(&%$-$,=(!>!$&,(-(,#$!+,$5!(9()+$%#, 9!*5$)>(%=! -,*&*%> )=)*-% & %+*)#%*9) 5","P 3":" !#%?#@$#","P 31":" !#%?A@$B","P 32":" !#%?B@$A","H 3":" !#%?#@$#CDAEFAGHAIJBKLBMNB","R 3":" !## !!# ","P -3":" !#%?#@$#$%&!@&? &","H -3":" !#%?#@$#$%&!@&? &OPQRSQTUQVWXYZX[]X]Y^W[^ZV^UR_PT_SO_","R -3":" !## !!# $%&&$%%&$","P 3 1 2":" !#%?#@$#%$&@!& ?&","P 3 2 1":" !#%?#@$#! &?%&$@&","P 31 1 2":" !#%?Q@$^%$_@!X ?&","P 31 2 1":" !#%?A@$B! &?%_$@X","P 32 1 2":" !#%?^@$Q%$X@!_ ?&","P 32 2 1":" !#%?B@$A! &?%X$@_","H 3 2":" !#%?#@$#! &?%&$@&OPQRSQTUQY]X[WXVZX]Y^W[^ZV^PO_SR_UT_","R 3 2":" !## !!# %$&$&%&%$","P 3 m 1":" !#%?#@$#%$#@!# ?#","P 3 1 m":" !#%?#@$#! #?%#$@#","P 3 c 1":" !#%?#@$#%$+@!+ ?+","P 3 1 c":" !#%?#@$#! +?%+$@+","H 3 m":" !#%?#@$#%$#@!# ?#OPQRSQTUQRUQTPQOSQ]Y^W[^ZV^WV^ZY^][^","R 3 m":" !## !!# ! # #!#! ","H 3 c":" !#%?#@$#%$+@!+ ?+OPQRSQTUQRU`TP`OS`]Y^W[^ZV^WVaZYa][a","R 3 c":" !## !!# '././'/'.","P -3 1 2/m":" !#%?#@$#%$&@!& ?&$%&!@&? &! #?%#$@#","P -3 1 2/c":" !#%?#@$#%$-@!- ?-$%&!@&? &! +?%+$@+","P -3 2/m 1":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#","P -3 2/c 1":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+","H -3 2/m":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#OPQRSQTUQY]X[WXVZXVWXYZX[]XRUQTPQOSQ]Y^W[^ZV^PO_SR_UT_UR_PT_SO_WV^ZY^][^","R -3 2/m":" !## !!# %$&$&%&%$$%&&$%%&$! # #!#! ","H -3 2/c":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+OPQRSQTUQY]b[WbVZbVWXYZX[]XRU`TP`OS`]Y^W[^ZV^POcSRcUTcUR_PT_SO_WVaZYa][a","R -3 2/c":" !## !!# 102021210$%&&$%%&$'././'/'.","P 6":" !#%?#@$#$%#!@#? #","P 61":" !#%?A@$B$%/!@d? e","P 65":" !#%?B@$A$%/!@e? d","P 62":" !#%?^@$Q$%#!@^? Q","P 64":" !#%?Q@$^$%#!@Q? ^","P 63":" !#%?#@$#$%+!@+? +","P -6":" !#%?#@$# !&%?&@$&","P 6/m":" !#%?#@$#$%#!@#? #$%&!@&? & !&%?&@$&","P 63/m":" !#%?#@$#$%+!@+? +$%&!@&? & !-%?-@$-","P 6 2 2":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&","P 61 2 2":" !#%?Q@$^$%+!@`? a! X?%&$@_%$b@!- ?c","P 65 2 2":" !#%?^@$Q$%+!@a? `! _?%&$@X%$c@!- ?b","P 62 2 2":" !#%?^@$Q$%#!@^? Q! _?%&$@X%$_@!& ?X","P 64 2 2":" !#%?Q@$^$%#!@Q? ^! X?%&$@_%$X@!& ?_","P 63 2 2":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-","P 6 m m":" !#%?#@$#$%#!@#? #%$#@!# ?#! #?%#$@#","P 6 c c":" !#%?#@$#$%#!@#? #%$+@!+ ?+! +?%+$@+","P 63 c m":" !#%?#@$#$%+!@+? +%$+@!+ ?+! #?%#$@#","P 63 m c":" !#%?#@$#$%+!@+? +%$#@!# ?#! +?%+$@+","P -6 m 2":" !#%?#@$# !&%?&@$&%$#@!# ?#%$&@!& ?&","P -6 c 2":" !#%?#@$# !-%?-@$-%$+@!+ ?+%$&@!& ?&","P -6 2 m":" !#%?#@$# !&%?&@$&! &?%&$@&! #?%#$@#","P -6 2 c":" !#%?#@$# !-%?-@$-! &?%&$@&! +?%+$@+","P 6/m 2/m 2/m":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&$%&!@&? & !&@$&%?&%$#@!# ?#! #?%#$@#","P 6/m 2/c 2/c":" !#%?#@$#$%#!@#? #! -?%-$@-%$-@!- ?-$%&!@&? & !&@$&%?&%$+@!+ ?+! +?%+$@+","P 63/m 2/c 2/m":" !#%?#@$#$%+!@+? +! -?%-$@-%$&@!& ?&$%&!@&? & !-@$-%?-%$+@!+ ?+! #?%#$@#","P 63/m 2/m 2/c":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-$%&!@&? & !-@$-%?-%$#@!# ?#! +?%+$@+","P 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ","F 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%&  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ","I 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(","P 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(","I 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- ","P 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$","P 2/n -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& *,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","F 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-($,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- *,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$","F 2/d -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& 64=37=345675=64=375345674=67=3453756 )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(68>3:>3896:9=<8=;:5;85<:4><7>;49;79<(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(<4>;7>;49<79>68>3:93896:8=<:=;85;:5<()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- <8=;:=;8f<:f><4>;79;49<78>6:>3893:96","I 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","P 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*","I 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*()+$,#*g& %-+()#$,&*!- %)+(,#$!&*%- *,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$","P 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$","P 42 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","F 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$","F 41 3 2":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46 )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<(!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86","I 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","P 43 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7;>46=:<5839398<5:6=4;>75:<983>7;=46","P 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<","I 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46","P -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ","F -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&%  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(+%*+!*-%(- +)$+,$-) -,#)(#,*&)*&,((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() +,$+)$-, -(#)*#,*&)(&,+!(+%*-!*-%(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(#,*#)*&,(&(+!*+%*-!(-%+) +,$-)$-, ","I -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","P -4 3 n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","F -4 3 c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() #,$#)$&, &(#!*#%*&!(&%+! +%$-!$-% (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(#%*#!*&%(& +!$+%$-! -%#) #,$&)$&, ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! +%$+!$-% - #)$#,$&) &,#!(#%*&!*&%(","I -4 3 d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7354<9:6>8;=357<946>:;=857394<>:6=8;()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- :;98657<=43>;9:658<=73>49:;586=7<>43","P 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","P 4/n -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/m -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/n -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","F 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#!  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*%*+!(+%(-!*-$-) -, +)$+,&,(&)*#,*#)((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%**%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*,$+) +, -)$-*&)(&,(#)*#,-%(-!*+%*+!(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$*,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$,*#)(#,(&)*&*-!(-%(+!*+%-, -)$+,$+) ","F 4/m -3 2/c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() &,$&)$#, #(#%*#!*&%(&!+!$+% -! -%$$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*,$#) #, &)$&*&!(&%(#!*#%-% -!$+%$+! (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(&%*&!*#%(# +%$+!$-% -!#)$#, &) &,$*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*%*#!(#%(&!*&$-! -% +!$+%&, &)$#,$#) ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! -%$-!$+% + #,$#)$&, &)#!*#%(&!(&%**,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$%$+! +% -!$-$&) &, #)$#,&%(&!*#%*#!(","F 41/d -3 2/m":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=4664=3:>;85<79=64>3:5;89<74=6:>385;79<,$+! #%(-)*&*&)(-% #!$+,-%(&)*+,$#!  )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<68>37=;49<:5=<8>;753496:4><:=;893756,*#!(+% &)$-*-!(&, +)$#%-, &!$+%*#)((!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<<4>;:=389675>68=379;45<:8=<7>;453:96%$#) +,(&!*-$&! -,(#)*+%&% -)$#,*+!(()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86<8=;7>3456:9><4=;:9385678>67=349;:5<%*+)(#, -!$&$-) &%(+!*#,&,(-!*#%$+) ","F 41/d -3 2/c":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46<8>;7=3496:5><8=;793456:8><7=;493:56%*#)(+, &!$-$-! &,(+)*#%&, -!$#%*+)( )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<<4=;:>385679>64=3:9;85<78=67>345;:9<%$+) #,(-!*&$&) -%(#!*+,&%(-)*#,$+! (!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<68=37>;45<:9=<4>;:5389674>6:=389;75<,*+!(#% -)$&*-)(&% +!$#,-,(&!*+%$#) ()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>8664>3:=;89<75=68>375;49<:4=<:>;853796,$#! +%(&)*-*&!(-, #)$+%-% &)$+,*#!(","I 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","I 41/a -3 2/d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<$%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*4<97358;=:6>6>:;=8357<94=8;>:694<573()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46*,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$865:;943>7<=<=73>4;9:658>43=7<5869:;","P 1 1 2":" !#$%#","P 1 1 21":" !#$%+","B 1 1 2":" !#$%#(g+*%+","A 1 2 1":" !#$!& )+$)-","C 1 21 1":" !#$)&()#*!&","I 1 2 1":" !#$!&.'/0'2","I 1 21 1":" !#$)&.'/0!-","P 1 1 m":" !# !&","P 1 1 b":" !# )&","B 1 1 m":" !# !&(!+(!-","B 1 1 b":" !# )&(!+()-","P 1 1 2/m":" !# !&$%#$%&","P 1 1 21/m":" !#$%+$%& !-","B 1 1 2/m":" !# !&$%#$%&(!+(!-*%+*%-","P 1 1 2/b":" !#$,#$%& )&","P 1 1 21/b":" !#$%&$,+ )-","B 1 1 2/b":" !#$,#$%& )&(!+*,+*%-()-","P 21 2 2":" !#$!&(%&*%#","P 2 21 2":" !# ,&$)&$%#","P 21 21 2 (a)":" !#*,#.%&$'&","P 21 2 21":" !#$!&(%-*%+","P 2 21 21":" !# %&$)-$,+","C 2 2 21a)":" !#*%+(,&$)-()#$,+ %&*!-","C 2 2 2a":" !#*,#.%&$'&()#$%# ,&*!&","F 2 2 2a":" !#*,#.%&$'& '/*%/.12$!2.!/$,/ %20'2.'#$%# 1&0!&","I 2 2 2a":" !#*,#.%&$'&()+$%+*!- ,-","P 21/m 21/m 2/n a":" !#*,#$)&(%&$%&.'& ,#*!#","P 42 21 2a":" !#*,#%.+'$+$'&.%&! -,*-","I 2 3a":" !#*,#.%&$'&!# ,- '&$%/$# !-*!/$%&.%()+$%+ ,-*!-)+(%&(!-*,#*+()&$)#*,- ,"},as=/^[1-9]$/;function ss(t){var e="";return 0<t.length&&(e=":"+_(t).join(" OR :")),new Ct(e)}var cs=function(t){void 0===t&&(t=""),this.name=t,this.partList=[]},us={type:{configurable:!0}};us.type.get=function(){return"Assembly"},cs.prototype.addPart=function(t,e){var r=new hs(t,e);return this.partList.push(r),r},cs.prototype.getAtomCount=function(r){return this.partList.reduce(function(t,e){return t+e.getAtomCount(r)},0)},cs.prototype.getResidueCount=function(r){return this.partList.reduce(function(t,e){return t+e.getResidueCount(r)},0)},cs.prototype.getInstanceCount=function(){var e=0;return this.partList.forEach(function(t){e+=t.matrixList.length}),e},cs.prototype.isIdentity=function(t){if(1!==this.partList.length)return!1;var e=this.partList[0];if(1!==e.matrixList.length)return!1;if(!(new fe.Matrix4).equals(e.matrixList[0]))return!1;var r=[];return t.eachChain(function(t){r.push(t.chainname)}),r=_(r),e.chainList.length===r.length},cs.prototype.getBoundingBox=function(r){var i=new fe.Box3;return this.partList.forEach(function(t){var e=t.getBoundingBox(r);i.expandByPoint(e.min),i.expandByPoint(e.max)}),i},cs.prototype.getCenter=function(t){return this.getBoundingBox(t).getCenter(new fe.Vector3)},cs.prototype.getSelection=function(){var e=[];return this.partList.forEach(function(t){e=e.concat(t.chainList)}),ss(e)},Object.defineProperties(cs.prototype,us);var hs=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.matrixList=t,this.chainList=e},ls={type:{configurable:!0}};ls.type.get=function(){return"AssemblyPart"},hs.prototype._getCount=function(t,e){var r=this,i=0;return t.eachChain(function(t){(0===r.chainList.length||r.chainList.includes(t.chainname))&&(i+=t[e])}),this.matrixList.length*i},hs.prototype.getAtomCount=function(t){return this._getCount(t,"atomCount")},hs.prototype.getResidueCount=function(t){return this._getCount(t,"residueCount")},hs.prototype.getBoundingBox=function(t){var e=new fe.Box3,r=new fe.Box3,i=this.getSelection(),o=t.getBoundingBox(i);return this.matrixList.forEach(function(t){r.copy(o).applyMatrix4(t),e.expandByPoint(r.min),e.expandByPoint(r.max)}),e},hs.prototype.getSelection=function(){return ss(this.chainList)},hs.prototype.getView=function(t){var e=this.getSelection();return e?t.getView(e):t},hs.prototype.getInstanceList=function(){for(var t=[],e=0,r=this.matrixList.length;e<r;++e)t.push({id:e+1,name:e,matrix:this.matrixList[e]});return t},Object.defineProperties(hs.prototype,ls);var ps=function(t){this.structure=t,this.currentModelindex=null,this.currentChainid=null,this.currentResname=null,this.currentResno=null,this.currentInscode=void 0,this.currentHetero=null,this.previousResname="",this.previousHetero=null,this.ai=-1,this.ri=-1,this.ci=-1,this.mi=-1};function ds(t,e){if(e){de.Debug&&me.time("assignSecondaryStructure");var r=[];t.eachModel(function(t){t.eachChain(function(t){r.push(t.chainname)})});var c=r.slice().sort(),u=[];c.forEach(function(t){u.push(r.indexOf(t))});var l=e.helices.filter(function(t){return 0<=b(c,t[0])});l.sort(function(t,e){var r=t[0],i=e[0],o=t[1],n=e[1];if(r===i)return o===n?0:o<n?-1:1;var a=b(c,r),s=b(c,i);return u[a]<u[s]?-1:1});var p=t.residueStore;t.eachModel(function(t){var a=0,s=l.length;if(0!==s){var c=l[a],u=!1,h=!1;t.eachChain(function(t){var e=!1;if(t.chainname===c[0])for(var r=t.residueCount,i=t.residueOffset,o=i+r,n=i;n<o;++n)if(p.resno[n]===c[1]&&p.getInscode(n)===c[2]&&(u=!0),u&&(p.sstruc[n]=c[6],p.resno[n]===c[4]&&p.getInscode(n)===c[5]&&(u=!1,(a+=1)<s?(n=i-1,c=l[a],e=t.chainname!==c[0]):h=!0)),e||h)return})}});var d=e.sheets.filter(function(t){return 0<=b(c,t[0])});d.sort(function(t,e){var r=t[0],i=e[0];if(r===i)return 0;var o=b(c,r),n=b(c,i);return u[o]<u[n]?-1:1});var f="e".charCodeAt(0);t.eachModel(function(t){var a=0,s=d.length;if(0!==s){var c=d[a],u=!1,h=!1;t.eachChain(function(t){var e=!1;if(t.chainname===c[0])for(var r=t.residueCount,i=t.residueOffset,o=i+r,n=i;n<o;++n)if(p.resno[n]===c[1]&&p.getInscode(n)===c[2]&&(u=!0),u&&(p.sstruc[n]=f,p.resno[n]===c[4]&&p.getInscode(n)===c[5]&&(u=!1,(a+=1)<s?(n=i-1,c=d[a],e=t.chainname!==c[0]):h=!0)),e||h)return})}}),de.Debug&&me.timeEnd("assignSecondaryStructure")}}ps.prototype.addResidueType=function(t){for(var e=this.structure.atomStore,r=this.structure.residueStore,i=this.structure.residueMap,o=r.atomCount[t],n=r.atomOffset[t],a=new Array(o),s=0;s<o;++s)a[s]=e.atomTypeId[n+s];r.residueTypeId[t]=i.add(this.previousResname,a,this.previousHetero)},ps.prototype.addAtom=function(t,e,r,i,o,n,a,s){var c=this.structure.atomStore,u=this.structure.residueStore,h=this.structure.chainStore,l=this.structure.modelStore,p=!1,d=!1,f=!1;this.currentModelindex!==t?(f=d=p=!0,this.mi+=1,this.ci+=1,this.ri+=1):this.currentChainid!==r?(f=d=!0,this.ci+=1,this.ri+=1):this.currentResno===o&&this.currentResname===i&&this.currentInscode===s||(f=!0,this.ri+=1),this.ai+=1,p&&(l.growIfFull(),l.chainOffset[this.mi]=this.ci,l.chainCount[this.mi]=0,l.count+=1,h.modelIndex[this.ci]=this.mi),d&&(h.growIfFull(),h.setChainname(this.ci,e),h.setChainid(this.ci,r),h.residueOffset[this.ci]=this.ri,h.residueCount[this.ci]=0,h.count+=1,h.modelIndex[this.ci]=this.mi,l.chainCount[this.mi]+=1,u.chainIndex[this.ri]=this.ci),f&&(this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,0<this.ri&&this.addResidueType(this.ri-1),u.growIfFull(),u.resno[this.ri]=o,void 0!==a&&(u.sstruc[this.ri]=a.charCodeAt(0)),void 0!==s&&(u.inscode[this.ri]=s.charCodeAt(0)),u.atomOffset[this.ri]=this.ai,u.atomCount[this.ri]=0,u.count+=1,u.chainIndex[this.ri]=this.ci,h.residueCount[this.ci]+=1),c.count+=1,c.residueIndex[this.ai]=this.ri,u.atomCount[this.ri]+=1,this.currentModelindex=t,this.currentChainid=r,this.currentResname=i,this.currentResno=o,this.currentInscode=s,this.currentHetero=n},ps.prototype.finalize=function(){this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,-1<this.ri&&this.addResidueType(this.ri)};var fs,ms=(fs=function(t,e,r,i){for(var o=t.structure,n=t.residueIndexStart,a=o.getResidueProxy(),s=o.getResidueProxy(),c=o.getAtomProxy(),u=o.getAtomProxy(),h=Math.max(0,e-2);h<=e;++h)for(var l=2;l<5;++l)if(!(h+l>=t.residueCount)){a.index=n+h,s.index=n+h+l,c.index=a.traceAtomIndex,u.index=s.traceAtomIndex;var p=c.distanceTo(u);if(Math.abs(p-r[l-2])>i)return!1}return!0},function(t){de.Debug&&me.time("calculateSecondaryStructure"),t.eachPolymer(function(t){if(!(t.residueCount<4)){if(t.isCg())!function(t){for(var e=t.residueStore,r=t.residueIndexStart,i=new Ya(t).position,o=new fe.Vector3,n=new fe.Vector3,a=0,s=t.residueCount;a<s;++a){o.fromArray(i.center,3*a),n.fromArray(i.center,3*a+3);var c=o.distanceTo(n);c<2&&1<c&&i.bending[a]<20&&(e.sstruc[r+a]="h".charCodeAt(0),e.sstruc[r+a+1]="h".charCodeAt(0))}}(t);else{if(!t.isProtein())return;!function(t){for(var e=t.residueStore,r=t.residueIndexStart,i=0,o=t.residueCount;i<o;++i){var n="c";fs(t,i,[5.45,5.18,6.37],2.1)?n="h":fs(t,i,[6.1,10.4,13],1.42)&&(n="e"),e.sstruc[r+i]=n.charCodeAt(0)}}(t)}var e,r=0;t.eachResidue(function(t){t.sstruc===e?r+=1:(1===r&&(t.index-=1,t.sstruc="c"),r=1,e=t.sstruc)})}}),de.Debug&&me.timeEnd("calculateSecondaryStructure")}),gs="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function ys(t){for(var e=gs.length,r=t,i=0,o=gs[r%e];e<=r;)r=Math.floor(r/e),o+=gs[r%e],i+=1;return 5<=i&&me.warn("chainname overflow"),o}function vs(t,a){void 0===a&&(a=!1),de.Debug&&me.time("calculateChainnames");var e=!0;if(t.eachChain(function(t){t.chainname&&(e=!1)}),e){var s=t.modelStore,c=t.chainStore,u=t.residueStore,h=t.getAtomProxy(),l=t.getAtomProxy(),p=0,d=0,f=0,m=0,g=[];1===u.count?g.push({mIndex:0,chainname:"A",rStart:0,rCount:1}):t.eachResidueN(2,function(t,e){var r=!1,i=t.backboneType,o=e.backboneType,n=Zi;m=t.index,t.modelIndex!==e.modelIndex?r=!0:t.moleculeType!==e.moleculeType?r=!0:i!==n&&i===o&&(h.index=t.backboneEndAtomIndex,l.index=e.backboneStartAtomIndex,r=a?!h.hasBondTo(l):!h.connectedTo(l)),r||e.index!==u.count-1||(r=!0,m=e.index),r&&(g.push({mIndex:d,chainname:ys(p),rStart:f,rCount:m-f+1}),p+=1,t.modelIndex!==e.modelIndex&&(p=0,d+=1),e.index===u.count-1&&m!==e.index&&g.push({mIndex:d,chainname:ys(p),rStart:u.count-1,rCount:1}),f=e.index,m=e.index)}),c.count=0,g.forEach(function(t){!function(t,e,r,i){for(var o=c.count,n=0;n<i;++n)u.chainIndex[r+n]=o;c.growIfFull(),c.modelIndex[o]=t,c.setChainname(o,e),c.setChainid(o,e),c.residueOffset[o]=r,c.residueCount[o]=i,c.count+=1,s.chainCount[t]+=1}(t.mIndex,t.chainname,t.rStart,t.rCount)});var r=0;t.eachModel(function(t){s.chainOffset[t.index]=r,s.chainCount[t.index]-=1,r+=s.chainCount[t.index]})}de.Debug&&me.timeEnd("calculateChainnames")}function bs(t){de.Debug&&me.time("calculateBonds"),ws(t),As(t),de.Debug&&me.timeEnd("calculateBonds")}var xs={"HIS|CD2|CG":2,"HIS|CE1|ND1":2,"ARG|CZ|NH2":2,"PHE|CE1|CZ":2,"PHE|CD2|CE2":2,"PHE|CD1|CG":2,"TRP|CD1|CG":2,"TRP|CD2|CE2":2,"TRP|CE3|CZ3":2,"TRP|CH2|CZ2":2,"ASN|CG|OD1":2,"GLN|CD|OE1":2,"TYR|CD1|CG":2,"TYR|CD2|CE2":2,"TYR|CE1|CZ":2,"ASP|CG|OD1":2,"GLU|CD|OE1":2,"G|C8|N7":2,"G|C4|C5":2,"G|C2|N3":2,"G|C6|O6":2,"C|C4|N3":2,"C|C5|C6":2,"C|C2|O2":2,"A|C2|N3":2,"A|C6|N1":2,"A|C4|C5":2,"A|C8|N7":2,"U|C5|C6":2,"U|C2|O2":2,"U|C4|O4":2,"DG|C8|N7":2,"DG|C4|C5":2,"DG|C2|N3":2,"DG|C6|O6":2,"DC|C4|N3":2,"DC|C5|C6":2,"DC|C2|O2":2,"DA|C2|N3":2,"DA|C6|N1":2,"DA|C4|C5":2,"DA|C8|N7":2,"DT|C5|C6":2,"DT|C2|O2":2,"DT|C4|O4":2};function _s(t,e,r){var i;return e=(i=e<r?[e,r]:[r,e])[0],r=i[1],mo.includes(t)&&"C"===e&&"O"===r?2:bo.includes(t)&&"OP1"===e&&"P"===r?2:xs[t+"|"+e+"|"+r]||1}function ws(t,g){void 0===g&&(g=!1),de.Debug&&me.time("calculateBondsWithin");var y=t.bondStore,v=t.rungBondStore,b=t.getAtomSet(!1),x=t.getAtomProxy(),_=t.getAtomProxy(),w=t.getBondProxy(),A=g?null:function(t){de.Debug&&me.time("calculateAtomBondMap");var i=[];return t.eachBond(function(t){var e=t.atomIndex1,r=t.atomIndex2;void 0===i[e]&&(i[e]=[]),i[e][r]=t.index}),de.Debug&&me.timeEnd("calculateAtomBondMap"),i}(t);t.eachResidue(function(t){if(!g&&A){var e=t.atomCount,r=t.atomOffset;if(500<e)return void me.warn("more than 500 atoms, skip residue for auto-bonding",t.qualifiedName());for(var i=t.getBonds(),o=i.atomIndices1,n=i.atomIndices2,a=i.bondOrders,s=o.length,c=0;c<s;++c){var u=o[c],h=n[c],l=u+r,p=h+r,d=A[l];if(void 0!==d&&void 0!==d[p])w.index=d[p],a[t.residueType.getBondIndex(u,h)]=w.bondOrder;else x.index=l,_.index=p,y.addBond(x,_,a[c])}}var f=t.residueType.traceAtomIndex,m=t.residueType.rungEndAtomIndex;-1!==f&&-1!==m&&(x.index=t.traceAtomIndex,_.index=t.rungEndAtomIndex,v.addBond(x,_),b.set(x.index),b.set(_.index))}),t.atomSetDict.rung=b,de.Debug&&me.timeEnd("calculateBondsWithin")}function As(t,o,n){void 0===o&&(o=!1),void 0===n&&(n=!1),de.Debug&&me.time("calculateBondsBetween");var a=t.bondStore,s=t.backboneBondStore,c=t.getAtomSet(!1),u=t.getAtomProxy(),h=t.getAtomProxy();function e(t,e){var r=t.backboneType,i=e.backboneType;r!==Zi&&r===i&&(u.index=t.backboneEndAtomIndex,h.index=e.backboneStartAtomIndex,(n&&u.hasBondTo(h)||u.connectedTo(h))&&(o||a.addBond(u,h,1),u.index=t.traceAtomIndex,h.index=e.traceAtomIndex,s.addBond(u,h),c.set(u.index),c.set(h.index)))}0===s.count&&s.resize(t.residueStore.count),t.eachResidueN(2,e);var r=t.getResidueProxy(),i=t.getResidueProxy();if(t.eachChain(function(t){0!==t.residueCount&&(r.index=t.residueOffset,i.index=t.residueOffset+t.residueCount-1,e(i,r))}),t.atomSetDict.backbone=c,!o){de.Debug&&me.time("calculateBondsBetween inter");var l=t.spatialHash;t.eachResidue(function(t){t.backboneType!==Zi||t.isWater()||t.eachAtom(function(e){e.isMetal()||l.eachWithin(e.x,e.y,e.z,4,function(t){h.index=t,e.modelIndex!==h.modelIndex||e.residueIndex===h.residueIndex||h.isMetal()||a.addBondIfConnected(e,h,1)})})}),de.Debug&&me.timeEnd("calculateBondsBetween inter")}de.Debug&&me.timeEnd("calculateBondsBetween")}function Ss(t){if(t.unitcell){de.Debug&&me.time("buildUnitcellAssembly");var o=t.unitcell,n=t.center.clone().applyMatrix4(o.cartToFrac),a=n.clone().floor(),s=function(t){var e=ns[t],r={};if(void 0===e)return console.warn("spacegroup '"+t+"' not found in symop library"),r;for(var i=[],o=0,n=e.length;o<n;o+=3){for(var a=[],s=0;s<3;++s)a.push(os[e[o+s]]);i.push(a)}return i.forEach(function(t){var s=0,e=(new fe.Matrix4).set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),c=e.elements;r[t.toString()]=e,t.forEach(function(t){for(var e=!1,r=!1,i=0,o=t.length;i<o;++i){var n=t[i];if("-"===n)e=!0;else if("+"===n)e=!1;else if("/"===n)r=!0;else if("X"===n)c[0+s]=e?-1:1;else if("Y"===n)c[4+s]=e?-1:1;else if("Z"===n)c[8+s]=e?-1:1;else if(as.test(n)){var a=parseInt(n);r?c[12+s]/=a:c[12+s]=a}else me.warn("getSymmetryOperations: unknown token '"+n+"'")}s+=1})}),r}(o.spacegroup),c=new fe.Vector3,u=new fe.Vector3,e=new cs("UNITCELL"),r=m(),i=[];if(t.biomolDict.NCS){i.push.apply(i,[new fe.Matrix4].concat(t.biomolDict.NCS.partList[0].matrixList));var h=[];r.forEach(function(e){i.forEach(function(t){h.push(e.clone().multiply(t))})}),e.addPart(h)}else e.addPart(r);var l=new fe.Vector3,p=new cs("SUPERCELL"),d=Array.prototype.concat.call(m(l.set(1,0,0)),m(l.set(0,1,0)),m(l.set(0,0,1)),m(l.set(-1,0,0)),m(l.set(0,-1,0)),m(l.set(0,0,-1)),m(l.set(1,1,0)),m(l.set(1,0,1)),m(l.set(0,1,1)),m(l.set(-1,-1,0)),m(l.set(-1,0,-1)),m(l.set(0,-1,-1)),m(l.set(1,-1,-1)),m(l.set(1,1,-1)),m(l.set(1,-1,1)),m(l.set(-1,1,1)),m(l.set(-1,-1,1)),m(l.set(-1,1,-1)),m(l.set(0,1,-1)),m(l.set(0,-1,1)),m(l.set(1,0,-1)),m(l.set(-1,0,1)),m(l.set(1,-1,0)),m(l.set(-1,1,0)),m(),m(l.set(1,1,1)),m(l.set(-1,-1,-1)));if(t.biomolDict.NCS){var f=[];d.forEach(function(e){i.forEach(function(t){f.push(e.clone().multiply(t))})}),p.addPart(f)}else p.addPart(d);t.biomolDict.UNITCELL=e,t.biomolDict.SUPERCELL=p,de.Debug&&me.timeEnd("buildUnitcellAssembly")}function m(r){var i=[];return Object.keys(s).forEach(function(t){var e=s[t].clone();c.copy(n).applyMatrix4(e).floor(),u.setFromMatrixPosition(e),u.sub(c),u.add(a),r&&u.add(r),e.setPosition(u),e.multiplyMatrices(o.fracToCart,e),e.multiply(o.cartToFrac),i.push(e)}),i}}var Cs=["H","C","O","N","S","P"],Ps=["NA","CL","FE"];function Is(t){var e=t.trim().toUpperCase();parseInt(e.charAt(0))&&(e=e.substr(1)),parseInt(e.charAt(0))&&(e=e.substr(1));var r=e.length;if(0===r)return"";if(1===r)return e;if(2===r){if(-1!==Ps.indexOf(e))return e;if(-1!==Cs.indexOf(e[0]))return e[0]}return 3<=r&&-1!==Cs.indexOf(e[0])?e[0]:""}function Os(t){var e=t.bondHash,m=e.countArray,g=e.offsetArray,y=e.indexArray,v=t.getBondProxy();t.eachResidue(function(t){var e=t.residueType;if(void 0===e.bonds){var u=t.atomOffset,h=[],l=[],p=[],d={},f=u+t.atomCount;t.eachAtom(function(t){for(var e=t.index,r=g[e],i=0,o=m[e];i<o;++i){v.index=y[r+i];var n=v.atomIndex1;if(!(n<u||f<=n)){var a=v.atomIndex2;if(!(a<u||f<=a)){if(a<n){var s=a;a=n,n=s}var c=n+"|"+a;void 0===d[c]&&(d[c]=!0,h.push(n-u),l.push(a-u),p.push(v.bondOrder))}}}}),e.bonds={atomIndices1:h,atomIndices2:l,bondOrders:p}}})}var ks=[3,11,19,37,55,87],Ms=[4,12,20,38,56,88],Bs=[6,15,16,34],Ts=[1,7,8,9,17,35,53],Ds=[2,10,18,36,54,86],Rs=[13,30,31,48,49,50,80,81,82,83,84,85,112],Fs=[5,14,32,33,51,52,85],Es=[9,17,35,53,85],$s=function(t,e,r){this.structure=t,this.atomname=e,r=r||Is(e),this.element=r,this.number=ao[r]||0,this.vdw=so[this.number]||2,this.covalent=co[this.number]||1.6};$s.prototype.getDefaultValence=function(){var t=uo[this.number];return t?t[0]:-1},$s.prototype.getValenceList=function(){return uo[this.number]||[]},$s.prototype.getOuterShellElectronCount=function(){return ho[this.number]||2},$s.prototype.isMetal=function(){return this.isAlkaliMetal()||this.isAlkalineEarthMetal()||this.isLanthanide()||this.isActinide()||this.isTransitionMetal()||this.isPostTransitionMetal()},$s.prototype.isNonmetal=function(){return this.isDiatomicNonmetal()||this.isPolyatomicNonmetal()||this.isNobleGas()},$s.prototype.isMetalloid=function(){return Fs.includes(this.number)},$s.prototype.isHalogen=function(){return Es.includes(this.number)},$s.prototype.isDiatomicNonmetal=function(){return Ts.includes(this.number)},$s.prototype.isPolyatomicNonmetal=function(){return Bs.includes(this.number)},$s.prototype.isAlkaliMetal=function(){return ks.includes(this.number)},$s.prototype.isAlkalineEarthMetal=function(){return Ms.includes(this.number)},$s.prototype.isNobleGas=function(){return Ds.includes(this.number)},$s.prototype.isTransitionMetal=function(){var t=this.number;return 21<=t&&t<=29||39<=t&&t<=47||72<=t&&t<=79||104<=t&&t<=108},$s.prototype.isPostTransitionMetal=function(){return Rs.includes(this.number)},$s.prototype.isLanthanide=function(){return 57<=this.number&&this.number<=71},$s.prototype.isActinide=function(){return 89<=this.number&&this.number<=103};var Ls=function(t){this.structure=t,this.dict={},this.list=[],this.structure=t};Ls.prototype.add=function(t,e){t=t.toUpperCase(),e=e?e.toUpperCase():Is(t);var r=t+"|"+e,i=this.dict[r];if(void 0===i){var o=new $s(this.structure,t,e);i=this.list.length,this.dict[r]=i,this.list.push(o)}return i},Ls.prototype.get=function(t){return this.list[t]};var Ns=function(t,e,r,i,o,n){this.structure=t,this.bondReferenceAtomIndices=[],this.resname=e,this.atomTypeIdList=r,this.hetero=i?1:0,this.chemCompType=o,this.bonds=n,this.atomCount=r.length,this.moleculeType=this.getMoleculeType(),this.backboneType=this.getBackboneType(0),this.backboneEndType=this.getBackboneType(-1),this.backboneStartType=this.getBackboneType(1),this.backboneIndexList=this.getBackboneIndexList();var a=Co[this.backboneType],s=Co[this.backboneStartType],c=Co[this.backboneEndType],u=this.getAtomIndexByName(a.trace);this.traceAtomIndex=st(u,-1);var h=this.getAtomIndexByName(a.direction1);this.direction1AtomIndex=st(h,-1);var l=this.getAtomIndexByName(a.direction2);this.direction2AtomIndex=st(l,-1);var p=this.getAtomIndexByName(s.backboneStart);this.backboneStartAtomIndex=st(p,-1);var d,f=this.getAtomIndexByName(c.backboneEnd);this.backboneEndAtomIndex=st(f,-1),d=vo.includes(e)?this.getAtomIndexByName("N1"):this.getAtomIndexByName("N3"),this.rungEndAtomIndex=st(d,-1)};Ns.prototype.getBackboneIndexList=function(){var t,e=[];switch(this.moleculeType){case 3:t=Ao;break;case 4:case 5:t=So;break;default:return e}for(var r=this.structure.atomMap,i=this.atomTypeIdList,o=0,n=this.atomCount;o<n;++o){var a=r.get(i[o]);t.includes(a.atomname)&&e.push(o)}return e},Ns.prototype.getMoleculeType=function(){return this.isProtein()?3:this.isRna()?4:this.isDna()?5:this.isWater()?1:this.isIon()?2:this.isSaccharide()?6:0},Ns.prototype.getBackboneType=function(t){return this.hasProteinBackbone(t)?1:this.hasRnaBackbone(t)?2:this.hasDnaBackbone(t)?3:this.hasCgProteinBackbone(t)?4:this.hasCgRnaBackbone(t)?5:this.hasCgDnaBackbone(t)?6:Zi},Ns.prototype.isProtein=function(){return this.chemCompType?Qi.includes(this.chemCompType):this.hasAtomWithName("CA","C","N")||mo.includes(this.resname)},Ns.prototype.isCg=function(){var t=this.backboneType;return 4===t||5===t||6===t},Ns.prototype.isNucleic=function(){return this.isRna()||this.isDna()},Ns.prototype.isRna=function(){return this.chemCompType?Ji.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C4'","C4*"],["O2'","O2*","F2'","F2*"])||go.includes(this.resname)&&this.hasAtomWithName(["O2'","O2*","F2'","F2*"]))},Ns.prototype.isDna=function(){return this.chemCompType?to.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C3'","C3*"])&&!this.hasAtomWithName(["O2'","O2*","F2'","F2*"])||yo.includes(this.resname))},Ns.prototype.isHetero=function(){return 1===this.hetero},Ns.prototype.isIon=function(){return _o.includes(this.resname)},Ns.prototype.isWater=function(){return xo.includes(this.resname)},Ns.prototype.isSaccharide=function(){return this.chemCompType?eo.includes(this.chemCompType):wo.includes(this.resname)},Ns.prototype.isStandardAminoacid=function(){return mo.includes(this.resname)},Ns.prototype.isStandardBase=function(){return bo.includes(this.resname)},Ns.prototype.hasBackboneAtoms=function(t,e){var r=Co[e];return-1===t?this.hasAtomWithName(r.trace,r.backboneEnd,r.direction1,r.direction2):0===t?this.hasAtomWithName(r.trace,r.direction1,r.direction2):1===t?this.hasAtomWithName(r.trace,r.backboneStart,r.direction1,r.direction2):this.hasAtomWithName(r.trace,r.backboneStart,r.backboneEnd,r.direction1,r.direction2)},Ns.prototype.hasProteinBackbone=function(t){return this.isProtein()&&this.hasBackboneAtoms(t,1)},Ns.prototype.hasRnaBackbone=function(t){return this.isRna()&&this.hasBackboneAtoms(t,2)},Ns.prototype.hasDnaBackbone=function(t){return this.isDna()&&this.hasBackboneAtoms(t,3)},Ns.prototype.hasCgProteinBackbone=function(t){return this.atomCount<7&&this.isProtein()&&this.hasBackboneAtoms(t,4)},Ns.prototype.hasCgRnaBackbone=function(t){return this.atomCount<11&&this.isRna()&&this.hasBackboneAtoms(t,5)},Ns.prototype.hasCgDnaBackbone=function(t){return this.atomCount<11&&this.isDna()&&this.hasBackboneAtoms(t,6)},Ns.prototype.hasBackbone=function(t){return this.hasProteinBackbone(t)||this.hasRnaBackbone(t)||this.hasDnaBackbone(t)||this.hasCgProteinBackbone(t)||this.hasCgRnaBackbone(t)||this.hasCgDnaBackbone(t)},Ns.prototype.getAtomIndexByName=function(t){var e=this.atomCount,r=this.structure.atomMap,i=this.atomTypeIdList;if(Array.isArray(t))for(var o=0;o<e;++o){var n=i[o];if(t.includes(r.get(n).atomname))return o}else for(var a=0;a<e;++a){var s=i[a];if(t===r.get(s).atomname)return a}},Ns.prototype.hasAtomWithName=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=t.length,i=0;i<r;++i)if(void 0!==t[i]&&void 0===this.getAtomIndexByName(t[i]))return!1;return!0},Ns.prototype.getBonds=function(t){return void 0===this.bonds&&(this.bonds=function(t){var e=t.structure,r=e.getAtomProxy(),i=e.getAtomProxy(),o=t.atomCount,n=t.atomOffset,a=n+o-1,s=[],c=[],u=[];if(500<o)de.Debug&&me.warn("more than 500 atoms, skip residue for auto-bonding",t.qualifiedName());else if(50<o)for(var h=new is(t,!0),l=t.isCg()?1.2:2.3,p=n;p<a;++p){r.index=p;for(var d=r.covalent+l+.3,f=h.nearest(r,1/0,d*d),m=f.length,g=0;g<m;++g)i.index=f[g].index,r.index<i.index&&r.connectedTo(i)&&(s.push(r.index-n),c.push(i.index-n),u.push(_s(r.resname,r.atomname,i.atomname)))}else for(var y=n;y<a;++y)for(var v=(r.index=y)+1;v<=a;++v)i.index=v,r.connectedTo(i)&&(s.push(y-n),c.push(v-n),u.push(_s(r.resname,r.atomname,i.atomname)));return{atomIndices1:s,atomIndices2:c,bondOrders:u}}(t)),this.bonds},Ns.prototype.getRings=function(){return void 0===this.rings&&this.calculateRings(),this.rings},Ns.prototype.getBondGraph=function(){return void 0===this.bondGraph&&this.calculateBondGraph(),this.bondGraph},Ns.prototype.getAromatic=function(t){return void 0===this.aromaticAtoms&&this.calculateAromatic(this.structure.getResidueProxy(t.residueIndex)),this.aromaticAtoms},Ns.prototype.getAromaticRings=function(t){return void 0===this.aromaticRings&&this.calculateAromatic(t),this.aromaticRings},Ns.prototype.calculateBondGraph=function(){for(var t=this.bondGraph={},e=this.getBonds(),r=e.atomIndices1.length,i=e.atomIndices1,o=e.atomIndices2,n=0;n<r;++n){var a=i[n],s=o[n];(t[a]=t[a]||[]).push(s),(t[s]=t[s]||[]).push(a)}},Ns.prototype.calculateRings=function(){for(var t=function(t,e){for(var r={count:e,visited:new Int32Array(e),queue:new Int32Array(e),pred:new Int32Array(e),left:new Int32Array(Us),right:new Int32Array(Us),color:new Int32Array(e),currentColor:0,rings:[],atomRings:[],bonds:t},i=0;i<e;i++)r.visited[i]=-1,r.pred[i]=-1;return r}(this.getBondGraph(),this.atomCount),e=0;e<t.count;e++)0<=t.visited[e]||Gs(t,e);this.rings={atomRings:t.atomRings,rings:t.rings}},Ns.prototype.isAromatic=function(t){return this.aromaticAtoms=this.getAromatic(t),1===this.aromaticAtoms[t.index-t.residueAtomOffset]},Ns.prototype.calculateAromatic=function(e){var r=this,i=this.aromaticAtoms=new Uint8Array(this.atomCount),t=this.getRings().rings,o=t.map(function(t){return function(t){if(t.some(function(t){return!zs.includes(t.number)}))return!1;var e=0,r=new kn(3,t.length),i=r.data;return t.forEach(function(t){i[e+0]=t.x,i[e+1]=t.y,i[e+2]=t.z,e+=3}),new Na(r).vecC.length()<js}(t.map(function(t){return r.structure.getAtomProxy(t+e.atomOffset)}))}),n=this.aromaticRings=[];t.forEach(function(t,e){o[e]&&(n.push(t),t.forEach(function(t){return i[t]=1}))})},Ns.prototype.assignBondReferenceAtomIndices=function(){for(var t=this.getBondGraph(),e=this.getRings(),r=e.atomRings,i=e.rings,o=this.bonds,n=o.atomIndices1,a=o.atomIndices2,s=o.bondOrders,c=this.bondReferenceAtomIndices,u=o.atomIndices1.length,h=c.length=0;h<u;++h)if(!(s[h]<=1)){var l=void 0,p=n[h],d=a[h],f=r[p],m=r[d];if(f&&m)for(var g=0;g<f.length;g++)if(-1!==m.indexOf(f[g])){l=i[f[g]];break}if(1<t[p].length)for(var y=0;y<t[p].length;++y){var v=t[p][y];if(v!==d&&(void 0===l||-1!==l.indexOf(v))){c[h]=v;break}}else if(1<t[d].length)for(var b=0;b<t[d].length;++b){var x=t[d][b];if(x!==p&&(void 0===l||-1!==l.indexOf(x))){c[h]=x;break}}}},Ns.prototype.getBondIndex=function(t,e){for(var r=this.bonds,i=r.atomIndices1,o=r.atomIndices2,n=i.indexOf(t),a=o.indexOf(e),s=a;-1!==n;){for(;-1!==a;){if(n===a)return n;a=o.indexOf(e,a+1)}n=i.indexOf(t,n+1),a=s}},Ns.prototype.getBondReferenceAtomIndex=function(t,e){var r=this.getBondIndex(t,e);if(void 0!==r)return 0===this.bondReferenceAtomIndices.length&&this.assignBondReferenceAtomIndices(),this.bondReferenceAtomIndices[r]};var zs=[5,6,7,8,14,15,16,32,33,50,51,83],js=.05;function Vs(t,e,r){if(!(r<e)){for(var i=t.pred,o=t.color,n=t.left,a=t.right,s=++t.currentColor,c=e,u=0;u<Us&&(o[c]=s,!((c=i[c])<0));u++);var h=0,l=0,p=!1,d=0;c=r;for(var f=0;f<Us;f++){if(o[c]===s){d=c,p=!0;break}if((c=i[a[l++]=c])<0)break}if(p){c=e;for(var m=0;m<Us&&d!==(n[h++]=c)&&!((c=i[c])<0);m++);for(var g=h+l,y=new Array(g),v=0,b=0;b<h;b++)y[v++]=n[b];for(var x=l-1;0<=x;x--)y[v++]=a[x];for(var _=t.rings.length,w=0;w<g;++w){var A=y[w];t.atomRings[A]?t.atomRings[A].push(_):t.atomRings[A]=[_]}t.rings.push(y)}}}function Gs(t,e){var r=t.bonds,i=t.visited,o=t.queue,n=t.pred;i[e]=1,o[0]=e;for(var a=0,s=1;a<s;){var c=o[a++];if(void 0!==r[c])for(var u=r[c].length,h=0;h<u;h++){var l=r[c][h];0<i[l]?n[l]!==c&&n[c]!==l&&Vs(t,c,l):(i[l]=1,n[o[s++]=l]=c)}}}var Us=4;var Hs=function(t){this.structure=t,this.dict={},this.list=[]};Hs.prototype.add=function(t,e,r,i,o){void 0===i&&(i=""),t=t.toUpperCase();var n,a,s=(n=r,void 0===(a=i)&&(a=""),t+"|"+e.join(",")+"|"+(n?1:0)+"|"+a),c=this.dict[s];if(void 0===c){var u=new Ns(this.structure,t,e,r,i,o);c=this.list.length,this.dict[s]=c,this.list.push(u)}return c},Hs.prototype.get=function(t){return this.list[t]};var Ws=function(t,e){void 0===e&&(e=0),this.structure=t,this.index=e,this.bondStore=t.bondStore,this._v12=new fe.Vector3,this._v13=new fe.Vector3,this._ap1=this.structure.getAtomProxy(),this._ap2=this.structure.getAtomProxy(),this._ap3=this.structure.getAtomProxy()},qs={atom1:{configurable:!0},atom2:{configurable:!0},atomIndex1:{configurable:!0},atomIndex2:{configurable:!0},bondOrder:{configurable:!0}};qs.atom1.get=function(){return this.structure.getAtomProxy(this.atomIndex1)},qs.atom2.get=function(){return this.structure.getAtomProxy(this.atomIndex2)},qs.atomIndex1.get=function(){return this.bondStore.atomIndex1[this.index]},qs.atomIndex1.set=function(t){this.bondStore.atomIndex1[this.index]=t},qs.atomIndex2.get=function(){return this.bondStore.atomIndex2[this.index]},qs.atomIndex2.set=function(t){this.bondStore.atomIndex2[this.index]=t},qs.bondOrder.get=function(){return this.bondStore.bondOrder[this.index]},qs.bondOrder.set=function(t){this.bondStore.bondOrder[this.index]=t},Ws.prototype.getOtherAtomIndex=function(t){return t===this.atomIndex1?this.atomIndex2:this.atomIndex1},Ws.prototype.getOtherAtom=function(t){return this.structure.getAtomProxy(this.getOtherAtomIndex(t.index))},Ws.prototype.getReferenceAtomIndex=function(){var t=this._ap1,e=this._ap2;if(t.index=this.atomIndex1,e.index=this.atomIndex2,t.residueIndex===e.residueIndex){var r=t.index-t.residueAtomOffset,i=e.index-e.residueAtomOffset,o=t.residueType.getBondReferenceAtomIndex(r,i);if(void 0!==o)return o+t.residueAtomOffset;console.warn("No reference atom found",t.index,e.index)}},Ws.prototype.calculateShiftDir=function(t){void 0===t&&(t=new fe.Vector3);var e=this._ap1,r=this._ap2,i=this._ap3,o=this._v12,n=this._v13;e.index=this.atomIndex1,r.index=this.atomIndex2;var a=this.getReferenceAtomIndex();o.subVectors(e,r).normalize(),void 0!==a?(i.index=a,n.subVectors(e,i)):n.copy(e),n.normalize();var s=o.dot(n);return 1-Math.abs(s)<1e-5&&(n.set(1,0,0),s=o.dot(n),1-Math.abs(s)<1e-5&&(n.set(0,1,0),s=o.dot(n))),t.copy(n.sub(o.multiplyScalar(s))).normalize()},Ws.prototype.qualifiedName=function(){return this.atomIndex1+"="+this.atomIndex2},Ws.prototype.clone=function(){return new Ws(this.structure,this.index)},Ws.prototype.toObject=function(){return{atomIndex1:this.atomIndex1,atomIndex2:this.atomIndex2,bondOrder:this.bondOrder}},Object.defineProperties(Ws.prototype,qs);var Xs=function(t,e){void 0===e&&(e=0),this.structure=t,this.index=e,this.chainStore=t.chainStore,this.residueStore=t.residueStore,this.atomStore=t.atomStore,this.residueMap=t.residueMap,this.atomMap=t.atomMap},Ys={entity:{configurable:!0},entityIndex:{configurable:!0},chain:{configurable:!0},chainIndex:{configurable:!0},atomOffset:{configurable:!0},atomCount:{configurable:!0},atomEnd:{configurable:!0},modelIndex:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0},resno:{configurable:!0},sstruc:{configurable:!0},inscode:{configurable:!0},residueType:{configurable:!0},resname:{configurable:!0},hetero:{configurable:!0},moleculeType:{configurable:!0},backboneType:{configurable:!0},backboneStartType:{configurable:!0},backboneEndType:{configurable:!0},traceAtomIndex:{configurable:!0},direction1AtomIndex:{configurable:!0},direction2AtomIndex:{configurable:!0},backboneStartAtomIndex:{configurable:!0},backboneEndAtomIndex:{configurable:!0},rungEndAtomIndex:{configurable:!0},x:{configurable:!0},y:{configurable:!0},z:{configurable:!0}};Ys.entity.get=function(){return this.structure.entityList[this.entityIndex]},Ys.entityIndex.get=function(){return this.chainStore.entityIndex[this.chainIndex]},Ys.chain.get=function(){return this.structure.getChainProxy(this.chainIndex)},Ys.chainIndex.get=function(){return this.residueStore.chainIndex[this.index]},Ys.chainIndex.set=function(t){this.residueStore.chainIndex[this.index]=t},Ys.atomOffset.get=function(){return this.residueStore.atomOffset[this.index]},Ys.atomOffset.set=function(t){this.residueStore.atomOffset[this.index]=t},Ys.atomCount.get=function(){return this.residueStore.atomCount[this.index]},Ys.atomCount.set=function(t){this.residueStore.atomCount[this.index]=t},Ys.atomEnd.get=function(){return this.atomOffset+this.atomCount-1},Ys.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},Ys.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},Ys.chainid.get=function(){return this.chainStore.getChainid(this.chainIndex)},Ys.resno.get=function(){return this.residueStore.resno[this.index]},Ys.resno.set=function(t){this.residueStore.resno[this.index]=t},Ys.sstruc.get=function(){return this.residueStore.getSstruc(this.index)},Ys.sstruc.set=function(t){this.residueStore.setSstruc(this.index,t)},Ys.inscode.get=function(){return this.residueStore.getInscode(this.index)},Ys.inscode.set=function(t){this.residueStore.setInscode(this.index,t)},Ys.residueType.get=function(){return this.residueMap.get(this.residueStore.residueTypeId[this.index])},Ys.resname.get=function(){return this.residueType.resname},Ys.hetero.get=function(){return this.residueType.hetero},Ys.moleculeType.get=function(){return this.residueType.moleculeType},Ys.backboneType.get=function(){return this.residueType.backboneType},Ys.backboneStartType.get=function(){return this.residueType.backboneStartType},Ys.backboneEndType.get=function(){return this.residueType.backboneEndType},Ys.traceAtomIndex.get=function(){return this.residueType.traceAtomIndex+this.atomOffset},Ys.direction1AtomIndex.get=function(){return this.residueType.direction1AtomIndex+this.atomOffset},Ys.direction2AtomIndex.get=function(){return this.residueType.direction2AtomIndex+this.atomOffset},Ys.backboneStartAtomIndex.get=function(){return this.residueType.backboneStartAtomIndex+this.atomOffset},Ys.backboneEndAtomIndex.get=function(){return this.residueType.backboneEndAtomIndex+this.atomOffset},Ys.rungEndAtomIndex.get=function(){return this.residueType.rungEndAtomIndex+this.atomOffset},Ys.x.get=function(){for(var t=0,e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.x[e];return t/this.atomCount},Ys.y.get=function(){for(var t=0,e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.y[e];return t/this.atomCount},Ys.z.get=function(){for(var t=0,e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.z[e];return t/this.atomCount},Xs.prototype.eachAtom=function(t,e){var r=this.atomCount,i=this.atomOffset,o=this.structure._ap,n=i+r;if(e&&e.atomOnlyTest)for(var a=e.atomOnlyTest,s=i;s<n;++s)o.index=s,a(o)&&t(o);else for(var c=i;c<n;++c)o.index=c,t(o)},Xs.prototype.positionToArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},Xs.prototype.isProtein=function(){return 3===this.residueType.moleculeType},Xs.prototype.isNucleic=function(){var t=this.residueType.moleculeType;return 4===t||5===t},Xs.prototype.isRna=function(){return 4===this.residueType.moleculeType},Xs.prototype.isDna=function(){return 5===this.residueType.moleculeType},Xs.prototype.isCg=function(){var t=this.residueType.backboneType;return 4===t||5===t||6===t},Xs.prototype.isPolymer=function(){if(0<this.structure.entityList.length)return this.entity.isPolymer();var t=this.residueType.moleculeType;return 3===t||4===t||5===t},Xs.prototype.isHetero=function(){return 1===this.residueType.hetero},Xs.prototype.isWater=function(){return 1===this.residueType.moleculeType},Xs.prototype.isIon=function(){return 2===this.residueType.moleculeType},Xs.prototype.isSaccharide=function(){return 6===this.residueType.moleculeType},Xs.prototype.isStandardAminoacid=function(){return this.residueType.isStandardAminoacid()},Xs.prototype.isStandardBase=function(){return this.residueType.isStandardBase()},Xs.prototype.isHelix=function(){return io.includes(this.sstruc)},Xs.prototype.isSheet=function(){return oo.includes(this.sstruc)},Xs.prototype.isTurn=function(){return no.includes(this.sstruc)&&this.isProtein()},Xs.prototype.getAtomType=function(t){return this.atomMap.get(this.atomStore.atomTypeId[t])},Xs.prototype.getResname1=function(){return fo[this.resname.toUpperCase()]||"X"},Xs.prototype.getBackboneType=function(t){switch(t){case-1:return this.residueType.backboneStartType;case 1:return this.residueType.backboneEndType;default:return this.residueType.backboneType}},Xs.prototype.getAtomIndexByName=function(t){var e=this.residueType.getAtomIndexByName(t);return void 0!==e&&(e+=this.atomOffset),e},Xs.prototype.hasAtomWithName=function(t){return this.residueType.hasAtomWithName(t)},Xs.prototype.getAtomnameList=function(){console.warn("getAtomnameList - might be expensive");for(var t=this.atomCount,e=this.atomOffset,r=new Array(t),i=0;i<t;++i)r[i]=this.getAtomType(e+i).atomname;return r},Xs.prototype.connectedTo=function(t){var e=this.structure.getAtomProxy(this.backboneEndAtomIndex),r=this.structure.getAtomProxy(t.backboneStartAtomIndex);return!(!e||!r)&&e.connectedTo(r)},Xs.prototype.getNextConnectedResidue=function(){var t=this.chainStore.residueOffset[this.chainIndex],e=this.chainStore.residueCount[this.chainIndex],r=this.index+1;if(r<t+e){var i=this.structure.getResidueProxy(r);if(this.connectedTo(i))return i}else if(r===t+e){var o=this.structure.getResidueProxy(t);if(this.connectedTo(o))return o}},Xs.prototype.getPreviousConnectedResidue=function(t){var e=this.chainStore.residueOffset[this.chainIndex],r=this.index-1;if(e<=r){var i=st(t,this.structure.getResidueProxy());if(i.index=r,i.connectedTo(this))return i}else if(r===e-1){var o=this.chainStore.residueCount[this.chainIndex],n=st(t,this.structure.getResidueProxy());if(n.index=e+o-1,n.connectedTo(this))return n}},Xs.prototype.getBonds=function(){return this.residueType.getBonds(this)},Xs.prototype.getRings=function(){return this.residueType.getRings()},Xs.prototype.getAromaticRings=function(){return this.residueType.getAromaticRings(this)},Xs.prototype.qualifiedName=function(t){void 0===t&&(t=!1);var e="";return this.resname&&!t&&(e+="["+this.resname+"]"),void 0!==this.resno&&(e+=this.resno),this.inscode&&(e+="^"+this.inscode),this.chain&&(e+=":"+this.chainname),e+="/"+this.modelIndex},Xs.prototype.clone=function(){return new Xs(this.structure,this.index)},Xs.prototype.toObject=function(){return{index:this.index,chainIndex:this.chainIndex,atomOffset:this.atomOffset,atomCount:this.atomCount,resno:this.resno,resname:this.resname,sstruc:this.sstruc}},Object.defineProperties(Xs.prototype,Ys);var Ks=function(t,e,r){this.structure=t,this.residueIndexStart=e,this.residueIndexEnd=r,this.chainStore=t.chainStore,this.residueStore=t.residueStore,this.atomStore=t.atomStore,this.residueCount=r-e+1;var i=this.structure.getResidueProxy(this.residueIndexStart),o=this.structure.getResidueProxy(this.residueIndexEnd);this.isPrevConnected=void 0!==i.getPreviousConnectedResidue();var n=o.getNextConnectedResidue();this.isNextConnected=void 0!==n,this.isNextNextConnected=void 0!==n&&void 0!==n.getNextConnectedResidue(),this.isCyclic=o.connectedTo(i),this.__residueProxy=this.structure.getResidueProxy()},Zs={chainIndex:{configurable:!0},modelIndex:{configurable:!0},chainname:{configurable:!0}};Zs.chainIndex.get=function(){return this.residueStore.chainIndex[this.residueIndexStart]},Zs.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},Zs.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},Ks.prototype.isProtein=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isProtein()},Ks.prototype.isCg=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isCg()},Ks.prototype.isNucleic=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isNucleic()},Ks.prototype.getMoleculeType=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.moleculeType},Ks.prototype.getBackboneType=function(t){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.getBackboneType(t)},Ks.prototype.getAtomIndexByType=function(t,e){this.isCyclic?-1===t?t=this.residueCount-1:t===this.residueCount&&(t=0):(-1!==t||this.isPrevConnected||(t+=1),t!==this.residueCount||this.isNextNextConnected||(t-=1));var r,i=this.__residueProxy;switch(i.index=this.residueIndexStart+t,e){case"trace":r=i.traceAtomIndex;break;case"direction1":r=i.direction1AtomIndex;break;case"direction2":r=i.direction2AtomIndex;break;default:r=i.getAtomIndexByName(e)}return r},Ks.prototype.eachAtom=function(e,r){this.eachResidue(function(t){t.eachAtom(e,r)})},Ks.prototype.eachAtomN=function(t,e,r){for(var i=this.residueCount,o=new Array(t),n=0;n<t;++n)o[n]=this.structure.getAtomProxy(this.getAtomIndexByType(n,r));e.apply(this,o);for(var a=t;a<i;++a){for(var s=1;s<t;++s)o[s-1].index=o[s].index;o[t-1].index=this.getAtomIndexByType(a,r),e.apply(this,o)}},Ks.prototype.eachResidue=function(t){for(var e=this.structure.getResidueProxy(),r=this.residueCount,i=this.residueIndexStart,o=0;o<r;++o)e.index=i+o,t(e)},Ks.prototype.qualifiedName=function(){var t=this.structure.getResidueProxy(this.residueIndexStart),e=this.structure.getResidueProxy(this.residueIndexEnd);return t.qualifiedName()+" - "+e.qualifiedName()},Object.defineProperties(Ks.prototype,Zs);var Qs=function(t,e){void 0===e&&(e=0),this.structure=t,this.index=e,this.chainStore=t.chainStore,this.residueStore=t.residueStore},Js={entity:{configurable:!0},model:{configurable:!0},entityIndex:{configurable:!0},modelIndex:{configurable:!0},residueOffset:{configurable:!0},residueCount:{configurable:!0},residueEnd:{configurable:!0},atomOffset:{configurable:!0},atomEnd:{configurable:!0},atomCount:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0}};Js.entity.get=function(){return this.structure.entityList[this.entityIndex]},Js.model.get=function(){return this.structure.getModelProxy(this.modelIndex)},Js.entityIndex.get=function(){return this.chainStore.entityIndex[this.index]},Js.entityIndex.set=function(t){this.chainStore.entityIndex[this.index]=t},Js.modelIndex.get=function(){return this.chainStore.modelIndex[this.index]},Js.modelIndex.set=function(t){this.chainStore.modelIndex[this.index]=t},Js.residueOffset.get=function(){return this.chainStore.residueOffset[this.index]},Js.residueOffset.set=function(t){this.chainStore.residueOffset[this.index]=t},Js.residueCount.get=function(){return this.chainStore.residueCount[this.index]},Js.residueCount.set=function(t){this.chainStore.residueCount[this.index]=t},Js.residueEnd.get=function(){return this.residueOffset+this.residueCount-1},Js.atomOffset.get=function(){return this.residueStore.atomOffset[this.residueOffset]},Js.atomEnd.get=function(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1},Js.atomCount.get=function(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1},Js.chainname.get=function(){return this.chainStore.getChainname(this.index)},Js.chainname.set=function(t){this.chainStore.setChainname(this.index,t)},Js.chainid.get=function(){return this.chainStore.getChainid(this.index)},Js.chainid.set=function(t){this.chainStore.setChainid(this.index,t)},Qs.prototype.eachAtom=function(e,r){this.eachResidue(function(t){t.eachAtom(e,r)},r)},Qs.prototype.eachResidue=function(t,e){var r=this.residueCount,i=this.residueOffset,o=this.structure._rp,n=i+r;if(e&&e.test){var a=e.residueOnlyTest;if(a)for(var s=i;s<n;++s)o.index=s,a(o)&&t(o);else for(var c=i;c<n;++c)o.index=c,t(o)}else for(var u=i;u<n;++u)o.index=u,t(o)},Qs.prototype.eachResidueN=function(t,e){var r=this.residueCount,i=this.residueOffset,o=i+r;if(!(r<t)){for(var n=new Array(t),a=0;a<t;++a)n[a]=this.structure.getResidueProxy(i+a);e.apply(this,n);for(var s=i+t;s<o;++s){for(var c=0;c<t;++c)n[c].index+=1;e.apply(this,n)}}},Qs.prototype.eachPolymer=function(t,e){for(var r=0,i=0,o=e?e.residueOnlyTest:void 0,n=this.model.structure,a=this.residueCount,s=this.residueOffset,c=s+a,u=this.structure.getResidueProxy(),h=this.structure.getResidueProxy(s),l=this.structure.getAtomProxy(),p=this.structure.getAtomProxy(),d=!0,f=s+1;f<c;++f){u.index=h.index,h.index=f;var m=d?u.backboneEndType:u.backboneType,g=h.backboneType;d&&(r=u.index,d=!1),i=h.index,m!==Zi&&m===g?(l.index=u.backboneEndAtomIndex,p.index=h.backboneStartAtomIndex,l&&p&&l.connectedTo(p)&&(!o||o(u)&&o(h))||(1<u.index-r&&t(new Ks(n,r,u.index)),r=i)):(m!==Zi&&1<u.index-r&&t(new Ks(n,r,u.index)),r=i)}1<i-r&&this.structure.getResidueProxy(r).backboneEndType&&t(new Ks(n,r,i))},Qs.prototype.qualifiedName=function(){return":"+this.chainname+"/"+this.modelIndex},Qs.prototype.clone=function(){return new Qs(this.structure,this.index)},Qs.prototype.toObject=function(){return{index:this.index,residueOffset:this.residueOffset,residueCount:this.residueCount,chainname:this.chainname}},Object.defineProperties(Qs.prototype,Js);var tc=function(t,e){void 0===e&&(e=0),this.structure=t,this.index=e,this.modelStore=t.modelStore,this.chainStore=t.chainStore,this.residueStore=t.residueStore},ec={chainOffset:{configurable:!0},chainCount:{configurable:!0},residueOffset:{configurable:!0},atomOffset:{configurable:!0},chainEnd:{configurable:!0},residueEnd:{configurable:!0},atomEnd:{configurable:!0},residueCount:{configurable:!0},atomCount:{configurable:!0}};ec.chainOffset.get=function(){return this.modelStore.chainOffset[this.index]},ec.chainOffset.set=function(t){this.modelStore.chainOffset[this.index]=t},ec.chainCount.get=function(){return this.modelStore.chainCount[this.index]},ec.chainCount.set=function(t){this.modelStore.chainCount[this.index]=t},ec.residueOffset.get=function(){return this.chainStore.residueOffset[this.chainOffset]},ec.atomOffset.get=function(){return this.residueStore.atomOffset[this.residueOffset]},ec.chainEnd.get=function(){return this.chainOffset+this.chainCount-1},ec.residueEnd.get=function(){return this.chainStore.residueOffset[this.chainEnd]+this.chainStore.residueCount[this.chainEnd]-1},ec.atomEnd.get=function(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1},ec.residueCount.get=function(){return 0===this.chainCount?0:this.residueEnd-this.residueOffset+1},ec.atomCount.get=function(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1},tc.prototype.eachAtom=function(e,r){this.eachChain(function(t){t.eachAtom(e,r)},r)},tc.prototype.eachResidue=function(e,r){this.eachChain(function(t){t.eachResidue(e,r)},r)},tc.prototype.eachPolymer=function(e,r){if(r&&r.chainOnlyTest){var i=r.chainOnlyTest;this.eachChain(function(t){i(t)&&t.eachPolymer(e,r)})}else this.eachChain(function(t){t.eachPolymer(e,r)})},tc.prototype.eachChain=function(t,e){var r=this.chainCount,i=this.chainOffset,o=this.structure._cp,n=i+r;if(e&&e.test){var a=e.chainOnlyTest;if(a)for(var s=i;s<n;++s)o.index=s,a(o)&&t(o);else for(var c=i;c<n;++c)o.index=c,t(o)}else for(var u=i;u<n;++u)o.index=u,t(o)},tc.prototype.qualifiedName=function(){return"/"+this.index},tc.prototype.clone=function(){return new tc(this.structure,this.index)},tc.prototype.toObject=function(){return{index:this.index,chainOffset:this.chainOffset,chainCount:this.chainCount}},Object.defineProperties(tc.prototype,ec);var rc=function(t,e){void 0===t&&(t=""),void 0===e&&(e=""),this.signals={refreshed:new u.Signal},this.init(t,e)},ic={type:{configurable:!0}};rc.prototype.init=function(t,e){this.name=t,this.path=e,this.title="",this.id="",this.data={structure:this,"@spatialLookup":void 0,"@valenceModel":void 0},this.header={},this.extraData={},this.atomSetCache={},this.atomSetDict={},this.biomolDict={},this.entityList=[],this.unitcell=void 0,this.frames=[],this.boxes=[],this.validation=void 0,this.bondStore=new Ga(0),this.backboneBondStore=new Ga(0),this.rungBondStore=new Ga(0),this.atomStore=new Ua(0),this.residueStore=new Ha(0),this.chainStore=new Wa(0),this.modelStore=new qa(0),this.atomMap=new Ls(this),this.residueMap=new Hs(this),this.bondHash=void 0,this.spatialHash=void 0,this.atomSet=void 0,this.bondSet=void 0,this.center=new fe.Vector3,this.boundingBox=new fe.Box3,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy()},ic.type.get=function(){return"Structure"},rc.prototype.finalizeAtoms=function(){this.atomSet=this.getAtomSet(),this.atomCount=this.atomStore.count,this.boundingBox=this.getBoundingBox(void 0,this.boundingBox),this.center=this.boundingBox.getCenter(new fe.Vector3),this.spatialHash=new Vi(this.atomStore,this.boundingBox)},rc.prototype.finalizeBonds=function(){for(var t in this.bondSet=this.getBondSet(),this.bondCount=this.bondStore.count,this.bondHash=new Va(this.bondStore,this.atomStore.count),this.atomSetCache={},this.atomSetDict.rung||(this.atomSetDict.rung=this.getAtomSet(!1)),this.atomSetDict)this.atomSetCache["__"+t]=this.atomSetDict[t].clone()},rc.prototype.getBondProxy=function(t){return new Ws(this,t)},rc.prototype.getAtomProxy=function(t){return new Qa(this,t)},rc.prototype.getResidueProxy=function(t){return new Xs(this,t)},rc.prototype.getChainProxy=function(t){return new Qs(this,t)},rc.prototype.getModelProxy=function(t){return new tc(this,t)},rc.prototype.getBondSet=function(){var t=this.bondStore.count,e=new Wi(t),r=this.atomSet;if(r)if(r.isAllSet())e.setAll();else if(r.isAllClear())e.clearAll();else for(var i=this.getBondProxy(),o=0;o<t;++o)i.index=o,r.isSet(i.atomIndex1,i.atomIndex2)&&e.set(i.index);else e.setAll();return e},rc.prototype.getBackboneBondSet=function(){var t=this.backboneBondStore.count,e=new Wi(t),r=this.atomSetCache.__backbone;if(r){var i=this.getBondProxy();i.bondStore=this.backboneBondStore;for(var o=0;o<t;++o)i.index=o,r.isSet(i.atomIndex1,i.atomIndex2)&&e.set(i.index)}else e.setAll();return e},rc.prototype.getRungBondSet=function(){var t=this.rungBondStore.count,e=new Wi(t),r=this.atomSetCache.__rung;if(r){var i=this.getBondProxy();i.bondStore=this.rungBondStore;for(var o=0;o<t;++o)i.index=o,r.isSet(i.atomIndex1,i.atomIndex2)&&e.set(i.index)}else e.setAll();return e},rc.prototype.getAtomSet=function(t){var e=this.atomStore.count;if(void 0===t)return new Wi(e,!0);if(t instanceof Wi)return t;if(!0===t)return new Wi(e,!0);if(t&&t.test){var r=t.string;if(r in this.atomSetCache)return this.atomSetCache[r];if(""===r)return new Wi(e,!0);var i=new Wi(e);return this.eachAtom(function(t){i.set(t.index)},t),this.atomSetCache[r]=i}return!1===t?new Wi(e):new Wi(e,!0)},rc.prototype.getAtomSetWithinSelection=function(t,e){var r=this.spatialHash,i=this.getAtomSet(!1),o=this.getAtomProxy();return r&&this.getAtomSet(t).forEach(function(t){o.index=t,r.within(o.x,o.y,o.z,e).forEach(function(t){i.set(t)})}),i},rc.prototype.getAtomSetWithinPoint=function(t,e){var r=t,i=this.getAtomSet(!1);return this.spatialHash&&this.spatialHash.within(r.x,r.y,r.z,e).forEach(function(t){i.set(t)}),i},rc.prototype.getAtomSetWithinVolume=function(t,e,r,i,o){var n=new za(t,r,i,o),a=n.getDataPosition(),s=a.length,c=n.matrix.getMaxScaleOnAxis(),u=this.getAtomSet(!1);if(!this.spatialHash)return u;for(var h=0;h<s;h+=3)this.spatialHash.within(a[h],a[h+1],a[h+2],c).forEach(function(t){u.set(t)});return u},rc.prototype.getAtomSetWithinGroup=function(t){var r=this.atomStore.residueIndex,i=this.getAtomSet(!1),o=this.getResidueProxy();return this.getAtomSet(t).forEach(function(t){o.index=r[t];for(var e=o.atomOffset;e<=o.atomEnd;++e)i.set(e)}),i},rc.prototype.getSelection=function(){return!1},rc.prototype.getStructure=function(){return this},rc.prototype.eachEntity=function(e,r){this.entityList.forEach(function(t){void 0!==r&&t.getEntityType()!==r||e(t)})},rc.prototype.eachBond=function(e,t){var r,i=this.getBondProxy();if(t&&t.test&&(r=this.getBondSet(),this.bondSet&&r.intersection(this.bondSet)),r)r.forEach(function(t){i.index=t,e(i)});else for(var o=this.bondStore.count,n=0;n<o;++n)i.index=n,e(i)},rc.prototype.eachAtom=function(e,r){if(r&&r.test)this.eachModel(function(t){t.eachAtom(e,r)},r);else for(var t=this.atomStore.count,i=this.getAtomProxy(),o=0;o<t;++o)i.index=o,e(i)},rc.prototype.eachResidue=function(t,e){if(e&&e.test){var r=this.modelStore.count,i=this.getModelProxy(),o=e.modelOnlyTest;if(o)for(var n=0;n<r;++n)i.index=n,o(i)&&i.eachResidue(t,e);else for(var a=0;a<r;++a)i.index=a,i.eachResidue(t,e)}else for(var s=this.residueStore.count,c=this.getResidueProxy(),u=0;u<s;++u)c.index=u,t(c)},rc.prototype.eachResidueN=function(t,e){var r=this.residueStore.count;if(!(r<t)){for(var i=new Array(t),o=0;o<t;++o)i[o]=this.getResidueProxy(o);e.apply(this,i);for(var n=t;n<r;++n){for(var a=0;a<t;++a)i[a].index+=1;e.apply(this,i)}}},rc.prototype.eachPolymer=function(e,r){if(r&&r.modelOnlyTest){var i=r.modelOnlyTest;this.eachModel(function(t){i(t)&&t.eachPolymer(e,r)})}else this.eachModel(function(t){t.eachPolymer(e,r)})},rc.prototype.eachChain=function(e,r){if(r&&r.test)this.eachModel(function(t){t.eachChain(e,r)});else for(var t=this.chainStore.count,i=this.getChainProxy(),o=0;o<t;++o)i.index=o,e(i)},rc.prototype.eachModel=function(t,e){var r=this.modelStore.count,i=this.getModelProxy();if(e&&e.test){var o=e.modelOnlyTest;if(o)for(var n=0;n<r;++n)i.index=n,o(i)&&t(i);else for(var a=0;a<r;++a)i.index=a,t(i)}else for(var s=0;s<r;++s)i.index=s,t(i)},rc.prototype.getAtomData=function(t){var e=Object.assign({},t);e.colorParams&&(e.colorParams.structure=this.getStructure());var i,o,r=e.what,n=st(e.atomSet,this.atomSet),a={},s=this.getAtomProxy(),c=n.getSize();r&&!r.position||(a.position=new Float32Array(3*c)),r&&!r.color||!e.colorParams||(a.color=new Float32Array(3*c),o=Vt.getScheme(e.colorParams)),r&&!r.picking||(a.picking=new on(new Float32Array(c),this.getStructure())),r&&!r.radius||(a.radius=new Float32Array(c),i=new Ea(e.radiusParams)),r&&!r.index||(a.index=new Uint32Array(c));var u=a.position,h=a.color,l=a.picking,p=a.radius,d=a.index;return n.forEach(function(t,e){var r=3*e;s.index=t,u&&s.positionToArray(u,r),h&&o.atomColorToArray(s,h,r),l&&(l.array[e]=t),p&&(p[e]=i.atomRadius(s)),d&&(d[e]=t)}),a},rc.prototype.getBondData=function(t){var e=Object.assign({},t);e.colorParams&&(e.colorParams.structure=this.getStructure());var r,i,o=e.what,n=st(e.bondSet,this.bondSet),a=st(e.multipleBond,"off"),s="off"!==a,c="offset"===a,u=st(e.bondScale,.4),h=st(e.bondSpacing,1),l={},p=this.getBondProxy();e.bondStore&&(p.bondStore=e.bondStore);var d,f=this.getAtomProxy(),m=this.getAtomProxy();if(s){var g=p.bondStore.bondOrder;d=0,n.forEach(function(t){d+=g[t]})}else d=n.getSize();o&&!o.position||(l.position1=new Float32Array(3*d),l.position2=new Float32Array(3*d)),o&&!o.color||!e.colorParams||(l.color=new Float32Array(3*d),l.color2=new Float32Array(3*d),i=Vt.getScheme(e.colorParams)),o&&!o.picking||(l.picking=new an(new Float32Array(d),this.getStructure(),e.bondStore)),(!o||o.radius||s&&o.position)&&(r=new Ea(e.radiusParams)),o&&!o.radius||(l.radius=new Float32Array(d),e.radius2&&(l.radius2=new Float32Array(d)));var y,v,b,x,_,w,A=l.position1,S=l.position2,C=l.color,P=l.color2,I=l.picking,O=l.radius,k=l.radius2,M=0,B=new fe.Vector3,T=new fe.Vector3,D=new fe.Vector3;return n.forEach(function(t){if(v=3*M,p.index=t,f.index=p.atomIndex1,m.index=p.atomIndex2,x=p.bondOrder,A)if(s&&1<x){var e=r.atomRadius(f);w=e*u/(.5*x),p.calculateShiftDir(D),c?(_=2*h*e,D.multiplyScalar(_),D.negate(),T.subVectors(m,f).multiplyScalar(Math.max(.1,_/1.88)),f.positionToArray(A,v),m.positionToArray(S,v),2<=x&&(B.addVectors(f,D).add(T).toArray(A,v+3),B.addVectors(m,D).sub(T).toArray(S,v+3),3<=x&&(B.subVectors(f,D).add(T).toArray(A,v+6),B.subVectors(m,D).sub(T).toArray(S,v+6)))):(_=(h-u)*e,D.multiplyScalar(_),2===x?(B.addVectors(f,D).toArray(A,v),B.subVectors(f,D).toArray(A,v+3),B.addVectors(m,D).toArray(S,v),B.subVectors(m,D).toArray(S,v+3)):3===x?(f.positionToArray(A,v),B.addVectors(f,D).toArray(A,v+3),B.subVectors(f,D).toArray(A,v+6),m.positionToArray(S,v),B.addVectors(m,D).toArray(S,v+3),B.subVectors(m,D).toArray(S,v+6)):(f.positionToArray(A,v),m.positionToArray(S,v)))}else f.positionToArray(A,v),m.positionToArray(S,v);if(C&&P&&(i.bondColorToArray(p,1,C,v),i.bondColorToArray(p,0,P,v),s&&1<x))for(y=1;y<x;++y)Ne(C,v,b=3*y+v,3),Ne(P,v,b,3);if(I&&I.array&&(I.array[M]=t,s&&1<x))for(y=1;y<x;++y)I.array[M+y]=t;if(O&&(O[M]=r.atomRadius(f),s&&1<x))for(w=O[M]*u/(c?1:.5*x),y=c?1:0;y<x;++y)O[M+y]=w;if(k&&(k[M]=r.atomRadius(m),s&&1<x))for(w=k[M]*u/(c?1:.5*x),y=c?1:0;y<x;++y)k[M+y]=w;M+=s?x:1}),l},rc.prototype.getBackboneAtomData=function(t){return t=Object.assign({atomSet:this.atomSetCache.__backbone},t),this.getAtomData(t)},rc.prototype.getBackboneBondData=function(t){return t=Object.assign({bondSet:this.getBackboneBondSet(),bondStore:this.backboneBondStore},t),this.getBondData(t)},rc.prototype.getRungAtomData=function(t){return t=Object.assign({atomSet:this.atomSetCache.__rung},t),this.getAtomData(t)},rc.prototype.getRungBondData=function(t){return t=Object.assign({bondSet:this.getRungBondSet(),bondStore:this.rungBondStore},t),this.getBondData(t)},rc.prototype.getBoundingBox=function(t,e){de.Debug&&me.time("getBoundingBox"),e=e||new fe.Box3;var o=1/0,n=1/0,a=1/0,s=-1/0,c=-1/0,u=-1/0;return this.eachAtom(function(t){var e=t.x,r=t.y,i=t.z;e<o&&(o=e),r<n&&(n=r),i<a&&(a=i),s<e&&(s=e),c<r&&(c=r),u<i&&(u=i)},t),e.min.set(o,n,a),e.max.set(s,c,u),de.Debug&&me.timeEnd("getBoundingBox"),e},rc.prototype.getPrincipalAxes=function(t){de.Debug&&me.time("getPrincipalAxes");var e=0,r=new kn(3,this.atomCount),i=r.data;return this.eachAtom(function(t){i[e+0]=t.x,i[e+1]=t.y,i[e+2]=t.z,e+=3},t),de.Debug&&me.timeEnd("getPrincipalAxes"),new Na(r)},rc.prototype.atomCenter=function(t){return t?this.getBoundingBox(t).getCenter(new fe.Vector3):this.center.clone()},rc.prototype.hasCoords=function(){if(void 0===this._hasCoords){var t=this.atomStore;this._hasCoords=0!==je(t.x)||0!==ze(t.x)||0!==je(t.y)||0!==ze(t.y)||0!==je(t.z)||0!==ze(t.z)||t.count/this.modelStore.count==1}return this._hasCoords},rc.prototype.getSequence=function(t){var e=[],r=this.getResidueProxy();return this.eachAtom(function(t){r.index=t.residueIndex,t.index===r.traceAtomIndex&&e.push(r.getResname1())},t),e},rc.prototype.getAtomIndices=function(t){if(t&&t.string){var e=[];return this.eachAtom(function(t){e.push(t.index)},t),new Uint32Array(e)}return this.getAtomData({what:{index:!0}}).index},rc.prototype.getChainnameCount=function(t){var e=new Set;return this.eachChain(function(t){t.residueCount&&e.add(t.chainname)},t),e.size},rc.prototype.updatePosition=function(e){var r=0;this.eachAtom(function(t){t.positionFromArray(e,r),r+=3},void 0),this._hasCoords=void 0},rc.prototype.refreshPosition=function(){this.getBoundingBox(void 0,this.boundingBox),this.boundingBox.getCenter(this.center),this.spatialHash=new Vi(this.atomStore,this.boundingBox)},rc.prototype.dispose=function(){this.frames&&(this.frames.length=0),this.boxes&&(this.boxes.length=0),this.bondStore.dispose(),this.backboneBondStore.dispose(),this.rungBondStore.dispose(),this.atomStore.dispose(),this.residueStore.dispose(),this.chainStore.dispose(),this.modelStore.dispose(),delete this.bondStore,delete this.atomStore,delete this.residueStore,delete this.chainStore,delete this.modelStore,delete this.frames,delete this.boxes,delete this.bondSet,delete this.atomSet},Object.defineProperties(rc.prototype,ic);var oc=new fe.Box3,nc=[Fi,Bi,Ei,Ri,$i,Ti,Mi,Di,Ni,Li,zi,ji],ac={aspectRatio:1.5,sphereDetail:2,radialSegments:50,disableImpostor:!1,openEnded:!1,dashedCylinder:!1,labelParams:{},pointSize:2,sizeAttenuation:!1,useTexture:!0,lineWidth:2},sc=function(t,e){var r=this;void 0===t&&(t="shape"),void 0===e&&(e={}),this.boundingBox=new fe.Box3,this.bufferList=[],this.meshCount=0,this._primitiveData={},this.name=t,this.parameters=w(e,ac),nc.forEach(function(e){Object.keys(e.fields).forEach(function(t){r._primitiveData[e.getShapeKey(t)]=[]}),r._primitiveData[e.getShapeKey("name")]=[]})},cc={center:{configurable:!0},type:{configurable:!0}};sc.prototype.addBuffer=function(t){this.bufferList.push(t);var e=t.geometry;return e.boundingBox||e.computeBoundingBox(),this.boundingBox.union(e.boundingBox),this},sc.prototype.addMesh=function(t,e,r,i,o){t=M(t),e=M(e),Array.isArray(r)&&(r=S(r,t.length)),i&&(i=M(i));var n={position:t,color:e,index:r,normal:i},a=new mn(this,Object.assign({serial:this.meshCount,name:o},n)),s=new ua(Object.assign({picking:a},n));return this.bufferList.push(s),oc.setFromArray(t),this.boundingBox.union(oc),this.meshCount+=1,this},sc.prototype.addSphere=function(t,e,r,i){return Mi.objectToShape(this,{position:t,color:e,radius:r,name:i}),this},sc.prototype.addEllipsoid=function(t,e,r,i,o,n){return $i.objectToShape(this,{position:t,color:e,radius:r,majorAxis:i,minorAxis:o,name:n}),this},sc.prototype.addTorus=function(t,e,r,i,o,n){return Li.objectToShape(this,{position:t,color:e,radius:r,majorAxis:i,minorAxis:o,name:n}),this},sc.prototype.addCylinder=function(t,e,r,i,o){return Ri.objectToShape(this,{position1:t,position2:e,color:r,radius:i,name:o}),this},sc.prototype.addCone=function(t,e,r,i,o){return Ei.objectToShape(this,{position1:t,position2:e,color:r,radius:i,name:o}),this},sc.prototype.addArrow=function(t,e,r,i,o){return Fi.objectToShape(this,{position1:t,position2:e,color:r,radius:i,name:o}),this},sc.prototype.addBox=function(t,e,r,i,o,n){return Bi.objectToShape(this,{position:t,color:e,size:r,heightAxis:i,depthAxis:o,name:n}),this},sc.prototype.addOctahedron=function(t,e,r,i,o,n){return Ti.objectToShape(this,{position:t,color:e,size:r,heightAxis:i,depthAxis:o,name:n}),this},sc.prototype.addTetrahedron=function(t,e,r,i,o,n){return Di.objectToShape(this,{position:t,color:e,size:r,heightAxis:i,depthAxis:o,name:n}),this},sc.prototype.addText=function(t,e,r,i){return Ni.objectToShape(this,{position:t,color:e,size:r,text:i}),this},sc.prototype.addPoint=function(t,e,r){return zi.objectToShape(this,{position:t,color:e,name:r}),this},sc.prototype.addWideline=function(t,e,r,i){return ji.objectToShape(this,{position1:t,position2:e,color:r,name:i}),this},sc.prototype.addLabel=function(t,e,r,i){return console.warn("Shape.addLabel is deprecated, use .addText instead"),this.addText(t,e,r,i)},sc.prototype.getBufferList=function(){var e=this,r=[];return nc.forEach(function(t){e._primitiveData[t.getShapeKey("color")].length&&r.push(t.bufferFromShape(e,e.parameters))}),this.bufferList.concat(r)},sc.prototype.dispose=function(){var r=this;this.bufferList.forEach(function(t){t.dispose()}),this.bufferList.length=0,nc.forEach(function(e){Object.keys(e.fields).forEach(function(t){r._primitiveData[e.getShapeKey(t)].length=0}),r._primitiveData[e.getShapeKey("name")].length=0})},cc.center.get=function(){return this._center||(this._center=this.boundingBox.getCenter(new fe.Vector3)),this._center},cc.type.get=function(){return"Shape"},Object.defineProperties(sc.prototype,cc);var uc=function(i){function t(t,e,r){Array.isArray(t)||(t=[t]),i.call(this,t,e,r),this.type="buffer",this.parameters=Object.assign({},this.parameters,{colorScheme:null,colorScale:null,colorValue:null,colorDomain:null,colorMode:null}),this.buffer=t,this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){i.prototype.init.call(this,t),this.build()},t.prototype.create=function(){this.bufferList.push.apply(this.bufferList,this.buffer)},t.prototype.attach=function(t){var e=this;this.bufferList.forEach(function(t){e.viewer.add(t),t.setParameters(e.getBufferParams())}),this.setVisibility(this.visible),t()},t}(Jr),hc=new fe.Matrix4,lc=new fe.Matrix3;var pc=function(v){function t(t,e,r){var i,o,n,a,s,c,u,h,l,p,d;void 0===e&&(e={}),v.call(this,(i=t,a=(o=r).attributes.position.array,s=o.index?o.index.array:void 0,c=i.position.length/3,u=a.length/3,h=c*u,l=new Float32Array(3*h),p=new Float32Array(3*h),d=new Float32Array(3*h),s&&(n=S(c*s.length,h)),{position:l,color:d,index:n,normal:p,primitiveId:i.primitiveId||Ee(c,u),picking:i.picking}),e),this.updateNormals=!1;var f=r.attributes.position.array,m=r.attributes.normal.array,g=r.index?r.index.array:void 0;this.geoPosition=f,this.geoNormal=m,this.geoIndex=g,this.positionCount=t.position.length/3,this.geoPositionCount=f.length/3,this.transformedGeoPosition=new Float32Array(3*this.geoPositionCount),this.transformedGeoNormal=new Float32Array(3*this.geoPositionCount);var y=this.geometry.attributes;this.meshPosition=y.position.array,this.meshColor=y.color.array,this.meshNormal=y.normal.array,this.setAttributes(t),g&&(this.meshIndex=this.geometry.getIndex().array,this.makeIndex())}return v&&(t.__proto__=v),((t.prototype=Object.create(v&&v.prototype)).constructor=t).prototype.setAttributes=function(t,e){void 0===t&&(t={}),void 0===e&&(e=!1);var r,i,o,n,a,s,c,u,h,l=this.geometry.attributes,p=this.updateNormals;t.position&&(r=t.position,o=this.geoPosition,c=this.meshPosition,a=this.transformedGeoPosition,l.position.needsUpdate=!0,(p||e)&&(n=this.geoNormal,h=this.meshNormal,s=this.transformedGeoNormal,l.normal.needsUpdate=!0)),t.color&&(i=t.color,u=this.meshColor,l.color.needsUpdate=!0);for(var d=this.positionCount,f=this.geoPositionCount,m=0;m<d;++m){var g=void 0,y=void 0,v=m*f*3,b=3*m;if(r&&a&&c&&h&&o&&n&&(a.set(o),hc.makeTranslation(r[b],r[b+1],r[b+2]),this.applyPositionTransform(hc,m,b),ni(hc.elements,a),c.set(a,v),p&&s?(s.set(n),lc.getNormalMatrix(hc),ai(lc.elements,s),h.set(s,v)):e&&h.set(n,v)),i&&u)for(g=0;g<f;++g)u[y=v+3*g]=i[b],u[y+1]=i[b+1],u[y+2]=i[b+2]}},t.prototype.makeIndex=function(){var t=this.geoIndex,e=this.meshIndex;if(t)for(var r=this.positionCount,i=this.geoPositionCount,o=3*(t.length/3),n=0;n<r;++n){var a=n*o,s=a+o;e.set(t,a);for(var c=a;c<s;++c)e[c]+=n*i}},t}(ua),dc=new fe.Vector3,fc=Object.assign({sphereDetail:1},na),mc=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.IcosahedronBufferGeometry(1,st(e.sphereDetail,1))),this.setAttributes(t,!0)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return fc},t.prototype.applyPositionTransform=function(t,e){var r=this._radius[e];dc.set(r,r,r),t.scale(dc)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),r.prototype.setAttributes.call(this,t,e)},Object.defineProperties(t.prototype,e),t}(pc);Wt.add("shader/SphereImpostor.vert","uniform mat4 projectionMatrixInverse;\nuniform float clipNear;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\nattribute vec2 mapping;\nattribute float radius;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\n#include matrix_scale\nconst mat4 D = mat4(\n1.0, 0.0, 0.0, 0.0,\n0.0, 1.0, 0.0, 0.0,\n0.0, 0.0, 1.0, 0.0,\n0.0, 0.0, 0.0, -1.0\n);\nmat4 transpose( in mat4 inMatrix ) {\nvec4 i0 = inMatrix[0];\nvec4 i1 = inMatrix[1];\nvec4 i2 = inMatrix[2];\nvec4 i3 = inMatrix[3];\nmat4 outMatrix = mat4(\nvec4(i0.x, i1.x, i2.x, i3.x),\nvec4(i0.y, i1.y, i2.y, i3.y),\nvec4(i0.z, i1.z, i2.z, i3.z),\nvec4(i0.w, i1.w, i2.w, i3.w)\n);\nreturn outMatrix;\n}\nvoid ComputePointSizeAndPositionInClipCoordSphere(){\nvec2 xbc;\nvec2 ybc;\nmat4 T = mat4(\nradius, 0.0, 0.0, 0.0,\n0.0, radius, 0.0, 0.0,\n0.0, 0.0, radius, 0.0,\nposition.x, position.y, position.z, 1.0\n);\nmat4 R = transpose( projectionMatrix * modelViewMatrix * T );\nfloat A = dot( R[ 3 ], D * R[ 3 ] );\nfloat B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );\nfloat C = dot( R[ 0 ], D * R[ 0 ] );\nxbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nxbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;\nA = dot( R[ 3 ], D * R[ 3 ] );\nB = -2.0 * dot( R[ 1 ], D * R[ 3 ] );\nC = dot( R[ 1 ], D * R[ 1 ] );\nybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sy = abs( ybc[ 0 ] - ybc[ 1 ] ) * 0.5;\ngl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );\ngl_Position.xy -= mapping * vec2( sx, sy );\ngl_Position.xy *= gl_Position.w;\n}\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\nvRadius = radius * matrixScale( modelViewMatrix );\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nmvPosition.z -= vRadius;\ngl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );\nComputePointSizeAndPositionInClipCoordSphere();\nvRadiusSq = vRadius * vRadius;\nvec4 vPoint4 = projectionMatrixInverse * gl_Position;\nvPoint = vPoint4.xyz / vPoint4.w;\nvPointViewPosition = -mvPosition.xyz / mvPosition.w;\n}"),Wt.add("shader/SphereImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool flag2 = false;\nbool interior = false;\nvec3 cameraPos;\nvec3 cameraNormal;\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nbool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){\nvec3 cameraSpherePos = -vPointViewPosition;\ncameraSpherePos.z += vRadius;\nvec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );\nvec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );\nvec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );\nfloat B = dot( rayDirection, cameraSphereDir );\nfloat det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );\nif( det < 0.0 ){\ndiscard;\nreturn false;\n}\nfloat sqrtDet = sqrt( det );\nfloat posT = mix( B + sqrtDet, B + sqrtDet, ortho );\nfloat negT = mix( B - sqrtDet, sqrtDet - B, ortho );\ncameraPos = rayDirection * negT + rayOrigin;\n#ifdef NEAR_CLIP\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}else if( calcClip( cameraPos ) > 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nflag2 = true;\n}\n#else\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}\n#endif\ncameraNormal = normalize( cameraPos - cameraSpherePos );\ncameraNormal *= float(!interior) * 2.0 - 1.0;\nreturn !interior;\n}\nvoid main(void){\nbool flag = Impostor( cameraPos, cameraNormal );\n#ifdef NEAR_CLIP\nif( calcClip( cameraPos ) > 0.0 )\ndiscard;\n#endif\ngl_FragDepthEXT = calcDepth( cameraPos );\nif( !flag ){\n#ifdef NEAR_CLIP\nif( flag2 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}else if( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#else\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#endif\n}\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vNormal = cameraNormal;\nvec3 vViewPosition = -cameraPos;\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var gc=function(o){function t(t,e,r){void 0===r&&(r={}),o.call(this,e,r),this.index=S(this.indexSize,this.attributeSize),this.makeIndex(),this.initIndex(this.index),this.addAttributes({mapping:{type:t,value:null}}),this.setAttributes({primitiveId:Fe(this.size)})}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={attributeSize:{configurable:!0},indexSize:{configurable:!0}};return e.attributeSize.get=function(){return this.size*this.mappingSize},e.indexSize.get=function(){return this.size*this.mappingIndicesSize},t.prototype.addAttributes=function(t){var e={};for(var r in t){var i=t[r];e[r]={type:i.type,value:null}}o.prototype.addAttributes.call(this,e)},t.prototype.getAttributeIndex=function(t){return 3*t*this.mappingSize},t.prototype.setAttributes=function(t){t&&!t.position&&t.position1&&t.position2&&(t.position=Be(t.position1,t.position2));var e,r,i,o,n,a,s,c=this.size,u=this.mappingSize,h=this.geometry.attributes;for(var l in t)if("index"!==l&&"picking"!==l){r=t[l],i=(e=h[l]).itemSize,o=e.array;for(var p=0;p<c;++p){a=(n=p*i)*u;for(var d=0;d<u;++d){s=a+i*d;for(var f=0;f<i;++f)o[s+f]=r[n+f]}}e.needsUpdate=!0}},t.prototype.makeMapping=function(){for(var t=this.size,e=this.mapping,r=this.mappingSize,i=this.mappingItemSize,o=this.geometry.attributes.mapping.array,n=0;n<t;n++)o.set(e,n*i*r)},t.prototype.makeIndex=function(){for(var t=this.size,e=this.mappingSize,r=this.mappingIndices,i=this.mappingIndicesSize,o=this.index,n=0;n<t;n++){var a=n*i,s=n*e;o.set(r,a);for(var c=0;c<i;++c)o[a+c]+=s}},Object.defineProperties(t.prototype,e),t}(sa),yc=new Float32Array([-1,1,-1,-1,1,1,1,-1]),vc=new Uint16Array([0,1,2,1,3,2]),bc=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,"v2",t,e)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return e.mapping.get=function(){return yc},e.mappingIndices.get=function(){return vc},e.mappingIndicesSize.get=function(){return 6},e.mappingSize.get=function(){return 4},e.mappingItemSize.get=function(){return 2},Object.defineProperties(t.prototype,e),t}(gc),xc=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.isImpostor=!0,this.vertexShader="SphereImpostor.vert",this.fragmentShader="SphereImpostor.frag",this.addUniforms({projectionMatrixInverse:{value:new fe.Matrix4},ortho:{value:0}}),this.addAttributes({radius:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}return r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t}(bc),_c=(Object.assign({disableImpostor:!1},fc),function(t,e){return!$t||e&&e.disableImpostor?new mc(t,e):new xc(t,e)});Yt.add("sphere",_c),Wt.add("shader/Point.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float size;\nuniform float canvasHeight;\nuniform float pixelRatio;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\nvarying vec3 vViewPosition;\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\n#include begin_vertex\n#include project_vertex\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * pixelRatio * ( ( canvasHeight / 2.0 ) / -mvPosition.z );\n#else\ngl_PointSize = size * pixelRatio;\n#endif\n#ifndef PICKING\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),Wt.add("shader/Point.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\n#ifdef USE_MAP\nif( texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).a < 0.5 )\ndiscard;\n#endif\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\n#ifdef USE_MAP\ndiffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif\n#include color_fragment\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var wc=Object.assign({pointSize:1,sizeAttenuation:!0,sortParticles:!1,alphaTest:.5,useTexture:!1,forceTransparent:!1,edgeBleach:0},na),Ac=Object.assign({pointSize:{uniform:"size"},sizeAttenuation:{updateShader:!0},sortParticles:{},alphaTest:{updateShader:!0},useTexture:{updateShader:!0},forceTransparent:{},edgeBleach:{uniform:!0}},aa),Sc=function(i){function t(t,e){void 0===e&&(e={}),i.call(this,t,e),this.parameterTypes=Ac,this.vertexShader="Point.vert",this.fragmentShader="Point.frag",this.isPoint=!0,this.addUniforms({size:{value:this.parameters.pointSize},canvasHeight:{value:1},pixelRatio:{value:1},map:{value:null}})}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return wc},t.prototype.makeMaterial=function(){i.prototype.makeMaterial.call(this),this.makeTexture();var t=this.material,e=this.wireframeMaterial,r=this.pickingMaterial;t.uniforms.map.value=this.tex,t.needsUpdate=!0,e.uniforms.map.value=this.tex,e.needsUpdate=!0,r.uniforms.map.value=this.tex,r.needsUpdate=!0},t.prototype.makeTexture=function(){this.tex&&this.tex.dispose(),this.tex=function(t){for(var e,r,i=t||{},o=st(i.width,256),n=st(i.height,256),a=[o/2,n/2],s=Math.min(o/2,n/2),c=st(i.delta,1/(s+1))*s,u=0,h=0,l=new Uint8Array(o*n*4),p=0,d=l.length;p<d;p+=4){var f=1-V(s-c,s,(e=a[0]-u,r=a[1]-h,Math.sqrt(e*e+r*r)));l[p]=255*f,l[p+1]=255*f,l[p+2]=255*f,l[p+3]=255*f,++u===o&&(u=0,h++)}var m=new fe.DataTexture(l,o,n);return m.needsUpdate=!0,m}({delta:this.parameters.edgeBleach})},t.prototype.getDefines=function(t){var e=i.prototype.getDefines.call(this,t);return this.parameters.sizeAttenuation&&(e.USE_SIZEATTENUATION=1),this.parameters.useTexture&&(e.USE_MAP=1),0<this.parameters.alphaTest&&this.parameters.alphaTest<=1&&(e.ALPHATEST=this.parameters.alphaTest.toPrecision(2)),e},t.prototype.setUniforms=function(t){t&&void 0!==t.edgeBleach&&(this.makeTexture(),t.map=this.tex),i.prototype.setUniforms.call(this,t)},t.prototype.dispose=function(){i.prototype.dispose.call(this),this.tex&&this.tex.dispose()},Object.defineProperties(t.prototype,e),t}(sa);Yt.add("point",Sc);var Cc=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="dot",this.parameters=Object.assign({thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdOut:{type:"boolean",rebuild:!0},dotType:{type:"select",rebuild:!0,options:{"":"",sphere:"sphere",point:"point"}},radiusType:{type:"select",options:{"":"",value:"value","abs-value":"abs-value","value-min":"value-min",deviation:"deviation",size:"size"}},radius:{type:"number",precision:3,max:10,min:.001,property:"size"},scale:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,disableImpostor:!0,pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{colorScheme:{type:"select",update:"color",options:{"":"",value:"value",uniform:"uniform",random:"random"}}}),t instanceof ta?(this.surface=void 0,this.volume=new za(t)):(this.surface=t,this.volume=void 0),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"uniform"),e.colorValue=st(e.colorValue,14540253),this.thresholdType=st(e.thresholdType,"sigma"),this.thresholdMin=st(e.thresholdMin,2),this.thresholdMax=st(e.thresholdMax,1/0),this.thresholdOut=st(e.thresholdOut,!1),this.dotType=st(e.dotType,"point"),this.radius=st(e.radius,.1),this.scale=st(e.scale,1),this.pointSize=st(e.pointSize,1),this.sizeAttenuation=st(e.sizeAttenuation,!0),this.sortParticles=st(e.sortParticles,!1),this.useTexture=st(e.useTexture,!1),this.alphaTest=st(e.alphaTest,.5),this.forceTransparent=st(e.forceTransparent,!1),this.edgeBleach=st(e.edgeBleach,0),i.prototype.init.call(this,e),this.build()},t.prototype.attach=function(t){var e=this;this.bufferList.forEach(function(t){e.viewer.add(t)}),this.setVisibility(this.visible),t()},t.prototype.create=function(){var t={};if(this.volume){var e,r,i=this.volume;"sigma"===this.thresholdType?(e=i.getValueForSigma(this.thresholdMin),r=i.getValueForSigma(this.thresholdMax)):(e=this.thresholdMin,r=this.thresholdMax),i.setFilter(e,r,this.thresholdOut),Object.assign(t,{position:i.getDataPosition(),color:i.getDataColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(t,{radius:i.getDataSize(this.radius,this.scale),picking:i.getDataPicking()})}else{var o=this.surface;Object.assign(t,{position:o.getPosition(),color:o.getColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(t,{radius:o.getSize(this.radius,this.scale),picking:o.getPicking()})}"sphere"===this.dotType?this.dotBuffer=new _c(t,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!1})):this.dotBuffer=new Sc(t,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach})),this.bufferList.push(this.dotBuffer)},t.prototype.update=function(t){if(void 0===t&&(t={}),0!==this.bufferList.length){var e={};t.color&&(this.volume?Object.assign(e,{color:this.volume.getDataColor(this.getColorParams())}):Object.assign(e,{color:this.surface.getColor(this.getColorParams())})),"sphere"===this.dotType&&(t.radius||t.scale)&&(this.volume?Object.assign(e,{radius:this.volume.getDataSize(this.radius,this.scale)}):Object.assign(e,{radius:this.surface.getSize(this.radius,this.scale)})),this.dotBuffer.setAttributes(e)}},t.prototype.setParameters=function(t,e,r){return void 0===e&&(e={}),t&&void 0!==t.thresholdType&&this.volume instanceof ta&&("value"===this.thresholdType&&"sigma"===t.thresholdType?(this.thresholdMin=this.volume.getSigmaForValue(this.thresholdMin),this.thresholdMax=this.volume.getSigmaForValue(this.thresholdMax)):"sigma"===this.thresholdType&&"value"===t.thresholdType&&(this.thresholdMin=this.volume.getValueForSigma(this.thresholdMin),this.thresholdMax=this.volume.getValueForSigma(this.thresholdMax)),this.thresholdType=t.thresholdType),t&&void 0!==t.radiusType&&("radius"===t.radiusType?this.radius=.1:this.radius=parseFloat(t.radiusType),e.radius=!0,"sphere"!==this.dotType||$t&&!this.disableImpostor||(r=!0)),t&&void 0!==t.radius&&(e.radius=!0,"sphere"!==this.dotType||$t&&!this.disableImpostor||(r=!0)),t&&void 0!==t.scale&&(e.scale=!0,"sphere"!==this.dotType||$t&&!this.disableImpostor||(r=!0)),i.prototype.setParameters.call(this,t,e,r),this},t}(Jr);Wt.add("shader/Image.vert","uniform float clipRadius;\nuniform vec3 clipCenter;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid main() {\n#include begin_vertex\n#include project_vertex\nvUv = uv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n}"),Wt.add("shader/Image.frag","uniform sampler2D map;\nuniform float opacity;\nuniform vec2 mapSize;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform sampler2D pickingMap;\nuniform float objectId;\n#else\n#include fog_pars_fragment\n#endif\n#if defined( CUBIC_INTERPOLATION )\n#if defined( CATMULROM_FILTER ) || defined( MITCHELL_FILTER )\n#if defined( CATMULROM_FILTER )\nconst float B = 0.0;\nconst float C = 0.5;\n#elif defined( MITCHELL_FILTER )\nconst float B = 0.333;\nconst float C = 0.333;\n#endif\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f < 1.0 ){\nreturn ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +\n( -18.0 + 12.0 * B + 6.0 *C ) * ( f * f ) +\n( 6.0 - 2.0 * B ) ) / 6.0;\n}else if( f >= 1.0 && f < 2.0 ){\nreturn ( ( -B - 6.0 * C ) * ( f * f * f )\n+ ( 6.0 * B + 30.0 * C ) * ( f *f ) +\n( - ( 12.0 * B ) - 48.0 * C ) * f +\n8.0 * B + 24.0 * C ) / 6.0;\n}else{\nreturn 0.0;\n}\n}\n#elif defined( BSPLINE_FILTER )\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f >= 0.0 && f <= 1.0 ){\nreturn ( 2.0 / 3.0 ) + ( 0.5 ) * ( f * f * f ) - ( f * f );\n}else if( f > 1.0 && f <= 2.0 ){\nreturn 1.0 / 6.0 * pow( ( 2.0 - f ), 3.0 );\n}\nreturn 1.0;\n}\n#else\nfloat filter( float x ){\nreturn 1.0;\n}\n#endif\nvec4 biCubic( sampler2D tex, vec2 texCoord ){\nvec2 texelSize = 1.0 / mapSize;\ntexCoord -= texelSize / 2.0;\nvec4 nSum = vec4( 0.0 );\nfloat nDenom = 0.0;\nvec2 cell = fract( texCoord * mapSize );\nfor( float m = -1.0; m <= 2.0; ++m ){\nfor( float n = -1.0; n <= 2.0; ++n ){\nvec4 vecData = texture2D(\ntex, texCoord + texelSize * vec2( m, n )\n);\nfloat c = filter( m - cell.x ) * filter( -n + cell.y );\nnSum += vecData * c;\nnDenom += c;\n}\n}\nreturn nSum / nDenom;\n}\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( CUBIC_INTERPOLATION )\ngl_FragColor = biCubic( map, vUv );\n#else\ngl_FragColor = texture2D( map, vUv );\n#endif\n#if defined( PICKING )\nif( gl_FragColor.a < 0.3 )\ndiscard;\ngl_FragColor = vec4( texture2D( pickingMap, vUv ).xyz, objectId );\n#else\nif( gl_FragColor.a < 0.01 )\ndiscard;\ngl_FragColor.a *= opacity;\n#include fog_fragment\n#endif\n}");var Pc=new Uint16Array([0,1,2,1,3,2]),Ic=new Float32Array([0,1,0,0,1,1,1,0]),Oc=Object.assign({filter:"nearest",forceTransparent:!0},na),kc=Object.assign({filter:{updateShader:!0,uniform:!0}},aa),Mc=function(l){function t(t,e){l.call(this,{position:t.position,index:Pc,picking:t.picking},e),this.parameterTypes=kc,this.alwaysTransparent=!0,this.hasWireframe=!1,this.vertexShader="Image.vert",this.fragmentShader="Image.frag";var r=t.imageData,i=t.width,o=t.height,n=new fe.DataTexture(r,i,o);n.flipY=!0,this.tex=n;for(var a=r.length,s=new Uint8Array(a),c=0;c<a;c+=4){var u=c/4;s[c]=u>>16&255,s[c+1]=u>>8&255,s[c+2]=255&u}var h=new fe.DataTexture(s,i,o);h.flipY=!0,h.minFilter=fe.NearestFilter,h.magFilter=fe.NearestFilter,this.pickingTex=h,this.addUniforms({map:{value:n},pickingMap:{value:h},mapSize:{value:new fe.Vector2(i,o)}}),this.geometry.setAttribute("uv",new fe.BufferAttribute(Ic,2))}l&&(t.__proto__=l),(t.prototype=Object.create(l&&l.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return Oc},t.prototype.getDefines=function(t){var e=l.prototype.getDefines.call(this,t),r=this.parameters.filter;return r.startsWith("cubic")&&(e.CUBIC_INTERPOLATION=1,r.endsWith("bspline")?e.BSPLINE_FILTER=1:r.endsWith("catmulrom")?e.CATMULROM_FILTER=1:r.endsWith("mitchell")&&(e.MITCHELL_FILTER=1)),e},t.prototype.updateTexture=function(){var t=this.tex,e=this.parameters.filter;e.startsWith("cubic")?(t.minFilter=fe.NearestFilter,t.magFilter=fe.NearestFilter):"linear"===e?(t.minFilter=fe.LinearFilter,t.magFilter=fe.LinearFilter):(t.minFilter=fe.NearestFilter,t.magFilter=fe.NearestFilter),t.needsUpdate=!0,this.pickingTex.needsUpdate=!0},t.prototype.makeMaterial=function(){l.prototype.makeMaterial.call(this),this.updateTexture();var t=this.material;t.uniforms.map.value=this.tex,t.blending=fe.NormalBlending,t.needsUpdate=!0;var e=this.wireframeMaterial;e.uniforms.map.value=this.tex,e.blending=fe.NormalBlending,e.needsUpdate=!0;var r=this.pickingMaterial;r.uniforms.map.value=this.tex,r.uniforms.pickingMap.value=this.pickingTex,r.blending=fe.NormalBlending,r.needsUpdate=!0},t.prototype.setUniforms=function(t){t&&void 0!==t.filter&&(this.updateTexture(),t.map=this.tex),l.prototype.setUniforms.call(this,t)},Object.defineProperties(t.prototype,e),t}(sa),Bc=function(t,e){var r=e||{};this.dimension=st(r.dimension,"x"),this.positionType=st(r.positionType,"percent"),this.position=st(r.position,30),this.thresholdType=st(r.thresholdType,"sigma"),this.thresholdMin=st(r.thresholdMin,-1/0),this.thresholdMax=st(r.thresholdMax,1/0),this.normalize=st(r.normalize,!1),this.volume=t};Bc.prototype.getPositionFromCoordinate=function(t){var e,r=this.dimension,i=this.volume,o=i.matrix,n=(new fe.Vector3).setFromMatrixPosition(o)[r],a=(new fe.Vector3).setFromMatrixScale(o)[r];return e="x"===r?i.nx:"y"===r?i.ny:i.nz,Math.round(((t-n)/(e/100)+1)/a)},Bc.prototype.getData=function(t){t=t||{};var e,o=this.volume,r=o.data,n=o.matrix;function i(t){return Math.round(t/100*(e-1))}function a(t,e,r,i){return 3*(r*o.ny*o.nx+e*o.nx+t)+i}e="coordinate"===this.positionType?this.getPositionFromCoordinate(this.position):this.position;var s,c,u,h,l,p=new Float32Array(12),d=new fe.Vector3,f=0,m=0,g=0,y=o.nx,v=o.ny,b=o.nz;function x(t,e,r,i){d.set(t,e,r).applyMatrix4(n).toArray(p,i)}"x"===this.dimension?(u=i(o.nx),h=o.ny-1,l=o.nz-1,s=o.nz,c=o.ny,y=(f=u)+1,x(u,0,0,0),x(u,h,0,3),x(u,0,l,6),x(u,h,l,9)):"y"===this.dimension?(u=o.nx-1,h=i(o.ny),l=o.nz-1,s=o.nz,c=o.nx,v=(m=h)+1,x(0,h,0,0),x(u,h,0,3),x(0,h,l,6),x(u,h,l,9)):"z"===this.dimension&&(u=o.nx-1,h=o.ny-1,l=i(o.nz),s=o.nx,c=o.ny,b=(g=l)+1,x(0,0,l,0),x(0,h,l,3),x(u,0,l,6),x(u,h,l,9));var _,w,A=0,S=0,C=new Uint8Array(s*c*4),P=new Float32Array(s*c);"sigma"===this.thresholdType?(_=o.getValueForSigma(this.thresholdMin),w=o.getValueForSigma(this.thresholdMax)):(_=this.thresholdMin,w=this.thresholdMax);var I=Object.assign({},t.colorParams,{volume:o});this.normalize&&(I.domain=[0,1]);var O,k=Vt.getScheme(I),M=new Float32Array(3),B=k.getScale(),T=0,D=0;if(this.normalize){T=1/0,O=-1/0;for(var R=m;R<v;++R)for(var F=f;F<y;++F)for(var E=g;E<b;++E){var $=r[a(F,R,E,0)/3];$<T&&(T=$),O<$&&(O=$)}D=O-T}for(var L=m;L<v;++L)for(var N=f;N<y;++N)for(var z=g;z<b;++z){var j=a(N,L,z,0)/3,V=r[j];this.normalize&&(V=(V-T)/D),k.colorToArray(B(V),M),C[A]=Math.round(255*M[0]),C[A+1]=Math.round(255*M[1]),C[A+2]=Math.round(255*M[2]),C[A+3]=_<V&&V<w?255:0,P[S]=j,++S,A+=4}var G=new wn(P,o);return{position:p,imageData:C,width:s,height:c,picking:G}};var Tc=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="slice",this.parameters=Object.assign({filter:{type:"select",buffer:!0,options:{nearest:"nearest",linear:"linear","cubic-bspline":"cubic-bspline","cubic-catmulrom":"cubic-catmulrom","cubic-mitchell":"cubic-mitchell"}},positionType:{type:"select",rebuild:!0,options:{percent:"percent",coordinate:"coordinate"}},position:{type:"range",step:.1,max:100,min:1,rebuild:!0},dimension:{type:"select",rebuild:!0,options:{x:"x",y:"y",z:"z"}},thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},normalize:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null,linewidth:null,colorScheme:null,roughness:null,metalness:null,diffuse:null}),this.volume=t,this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=this.volume,r=t||{};r.colorDomain=st(r.colorDomain,[e.min,e.max]),r.colorScheme=st(r.colorScheme,"value"),r.colorScale=st(r.colorScale,"Spectral"),this.colorScheme="value",this.dimension=st(r.dimension,"x"),this.filter=st(r.filter,"cubic-bspline"),this.positionType=st(r.positionType,"percent"),this.position=st(r.position,30),this.thresholdType=st(r.thresholdType,"sigma"),this.thresholdMin=st(r.thresholdMin,-1/0),this.thresholdMax=st(r.thresholdMax,1/0),this.normalize=st(r.normalize,!1),i.prototype.init.call(this,r),this.build()},t.prototype.attach=function(t){var e=this;this.bufferList.forEach(function(t){e.viewer.add(t)}),this.setVisibility(this.visible),t()},t.prototype.create=function(){var t=new Bc(this.volume,{positionType:this.positionType,position:this.position,dimension:this.dimension,thresholdType:this.thresholdType,thresholdMin:this.thresholdMin,thresholdMax:this.thresholdMax,normalize:this.normalize}),e=new Mc(t.getData({colorParams:this.getColorParams()}),this.getBufferParams({filter:this.filter}));this.bufferList.push(e)},t}(Jr);function Dc(t){me.error("makeRepresentation: representation type "+t+" unknown")}var Rc={name:"some element",status:""},Fc=function(t,e){void 0===e&&(e={}),this.stage=t,this.signals={statusChanged:new u.Signal,nameChanged:new u.Signal,disposed:new u.Signal},this.parameters=w(e,this.defaultParameters),this.uuid=E()},Ec={defaultParameters:{configurable:!0},name:{configurable:!0}};Ec.defaultParameters.get=function(){return Rc},Ec.name.get=function(){return this.parameters.name},Fc.prototype.setStatus=function(t){return this.parameters.status=t,this.signals.statusChanged.dispatch(t),this},Fc.prototype.setName=function(t){return this.parameters.name=t,this.signals.nameChanged.dispatch(t),this},Fc.prototype.dispose=function(){this.signals.disposed.dispatch()},Object.defineProperties(Fc.prototype,Ec);var $c=Object.assign({visible:!0},Rc),Lc=function(o){function t(t,e,r,i){void 0===r&&(r={}),o.call(this,t,Object.assign({name:e.type},r)),this.parent=i,this.signals=Object.assign({visibilityChanged:new u.Signal,parametersChanged:new u.Signal},this.signals),this.setRepresentation(e)}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={defaultParameters:{configurable:!0},visible:{configurable:!0},type:{configurable:!0}};return e.defaultParameters.get=function(){return $c},e.visible.get=function(){return this.parameters.visible},e.type.get=function(){return"representation"},t.prototype.getType=function(){return this.repr.type},t.prototype.setRepresentation=function(t){this._disposeRepresentation(),this.repr=t,this.stage.tasks.listen(this.repr.tasks),this.updateVisibility()},t.prototype._disposeRepresentation=function(){this.repr&&(this.stage.tasks.unlisten(this.repr.tasks),this.repr.dispose())},t.prototype.dispose=function(){this.parent&&this.parent.hasRepresentation(this)?this.parent.removeRepresentation(this):(this._disposeRepresentation(),this.signals.disposed.dispatch())},t.prototype.setVisibility=function(t){return this.parameters.visible=t,this.updateVisibility(),this.signals.visibilityChanged.dispatch(this.parameters.visible),this},t.prototype.getVisibility=function(){return this.parent?this.parent.parameters.visible&&this.parameters.visible:this.parameters.visible},t.prototype.toggleVisibility=function(){return this.setVisibility(!this.parameters.visible)},t.prototype.updateVisibility=function(){this.repr.setVisibility(this.getVisibility())},t.prototype.update=function(t){return this.repr.update(t),this},t.prototype.build=function(t){return this.repr.build(t),this},t.prototype.setSelection=function(t){var e=this.repr;return e.setSelection&&e.setSelection(t),this},t.prototype.setParameters=function(t){return this.repr.setParameters(t),this.signals.parametersChanged.dispatch(this.repr.getParameters()),this},t.prototype.getParameters=function(){return this.repr.getParameters()},t.prototype.setColor=function(t){return this.repr.setColor(t),this},Object.defineProperties(t.prototype,e),t}(Fc),Nc=new fe.Matrix4,zc=new fe.Vector3,jc={name:"",status:"",visible:!0},Vc=function(t,e,r){void 0===r&&(r={}),this.stage=t,this.object=e,this.signals={representationAdded:new u.Signal,representationRemoved:new u.Signal,visibilityChanged:new u.Signal,matrixChanged:new u.Signal,statusChanged:new u.Signal,nameChanged:new u.Signal,disposed:new u.Signal},this.reprList=[],this.annotationList=[],this.matrix=new fe.Matrix4,this.position=new fe.Vector3,this.quaternion=new fe.Quaternion,this.scale=new fe.Vector3(1,1,1),this.transform=new fe.Matrix4,this.parameters=w(r,this.defaultParameters),this.uuid=E(),this.viewer=t.viewer,this.controls=new Da(this)},Gc={defaultParameters:{configurable:!0},name:{configurable:!0},status:{configurable:!0},visible:{configurable:!0}};Gc.defaultParameters.get=function(){return jc},Gc.name.get=function(){return this.parameters.name},Gc.status.get=function(){return this.parameters.status},Gc.visible.get=function(){return this.parameters.visible},Vc.prototype.setPosition=function(t){return Array.isArray(t)?this.position.fromArray(t):this.position.copy(t),this.updateMatrix(),this},Vc.prototype.setRotation=function(t){if(Array.isArray(t))if(3===t.length){var e=(new fe.Euler).fromArray(t);this.quaternion.setFromEuler(e)}else this.quaternion.fromArray(t);else t instanceof fe.Euler?this.quaternion.setFromEuler(t):this.quaternion.copy(t);return this.updateMatrix(),this},Vc.prototype.setScale=function(t){return this.scale.set(t,t,t),this.updateMatrix(),this},Vc.prototype.setTransform=function(t){return this.transform.copy(t),this.updateMatrix(),this},Vc.prototype.updateMatrix=function(){var e=this,t=this.getCenterUntransformed(zc);this.matrix.makeTranslation(-t.x,-t.y,-t.z),Nc.makeRotationFromQuaternion(this.quaternion),this.matrix.premultiply(Nc),Nc.makeScale(this.scale.x,this.scale.y,this.scale.z),this.matrix.premultiply(Nc);var r=this.position;Nc.makeTranslation(r.x+t.x,r.y+t.y,r.z+t.z),this.matrix.premultiply(Nc),this.matrix.premultiply(this.transform),this.reprList.forEach(function(t){t.setParameters({matrix:e.matrix})}),this.stage.viewer.updateBoundingBox(),this.signals.matrixChanged.dispatch(this.matrix)},Vc.prototype.addAnnotation=function(t,e,r){var i=new ka(this,t,e,r);return this.annotationList.push(i),i},Vc.prototype.eachAnnotation=function(t){this.annotationList.slice().forEach(t)},Vc.prototype.removeAnnotation=function(t){var e=this.annotationList.indexOf(t);-1!==e&&(this.annotationList.splice(e,1),t.dispose())},Vc.prototype.removeAllAnnotations=function(){this.eachAnnotation(function(t){return t.dispose()}),this.annotationList.length=0},Vc.prototype._addRepresentation=function(t,e,r,i){void 0===i&&(i=!1);var o=r||{},n=this.stage.getParameters();o.matrix=this.matrix.clone(),o.quality=o.quality||n.quality,o.disableImpostor=st(o.disableImpostor,!n.impostor),o.useWorker=st(o.useWorker,n.workerDefault),o.visible=st(o.visible,!0);var a=Object.assign({},o,{visible:this.parameters.visible&&o.visible}),s=function(t,e,r,i){var o;if(de.Debug&&me.time("makeRepresentation "+t),e instanceof rc){if(!(o=Ut.get(t)))return void Dc(t)}else if(e instanceof Zn)if("surface"===t)o=ga;else{if("dot"!==t)return void Dc(t);o=Cc}else if(e instanceof ta)if("surface"===t)o=ga;else if("dot"===t)o=Cc;else{if("slice"!==t)return void Dc(t);o=Tc}else if(e instanceof sc)o=uc,e=e.getBufferList();else{if("buffer"!==t)return void me.error("makeRepresentation: object "+e+" unknown");o=uc}var n=new o(e,r,i);return de.Debug&&me.timeEnd("makeRepresentation "+t),n}(t,e,this.viewer,a),c=new Lc(this.stage,s,o,this);return i||(this.reprList.push(c),this.signals.representationAdded.dispatch(c)),c},Vc.prototype.addBufferRepresentation=function(t,e){return this._addRepresentation.call(this,"buffer",t,e)},Vc.prototype.hasRepresentation=function(t){return-1!==this.reprList.indexOf(t)},Vc.prototype.eachRepresentation=function(t){this.reprList.slice().forEach(t)},Vc.prototype.removeRepresentation=function(t){var e=this.reprList.indexOf(t);-1!==e&&(this.reprList.splice(e,1),t.dispose(),this.signals.representationRemoved.dispatch(t))},Vc.prototype.updateRepresentations=function(e){this.reprList.forEach(function(t){return t.update(e)}),this.stage.viewer.requestRender()},Vc.prototype.removeAllRepresentations=function(){this.eachRepresentation(function(t){return t.dispose()})},Vc.prototype.dispose=function(){this.removeAllAnnotations(),this.removeAllRepresentations(),delete this.annotationList,delete this.reprList,this.signals.disposed.dispatch()},Vc.prototype.setVisibility=function(t){return this.parameters.visible=t,this.eachRepresentation(function(t){return t.updateVisibility()}),this.eachAnnotation(function(t){return t.updateVisibility()}),this.signals.visibilityChanged.dispatch(t),this},Vc.prototype.setStatus=function(t){return this.parameters.status=t,this.signals.statusChanged.dispatch(t),this},Vc.prototype.setName=function(t){return this.parameters.name=t,this.signals.nameChanged.dispatch(t),this},Vc.prototype.getBox=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this).getBoxUntransformed.apply(t,e).clone().applyMatrix4(this.matrix)},Vc.prototype.getCenter=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this).getCenterUntransformed.apply(t,e).clone().applyMatrix4(this.matrix)},Vc.prototype.getZoom=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return this.stage.getZoomForBox((t=this).getBox.apply(t,e))},Vc.prototype.getBoxUntransformed=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return new fe.Box3},Vc.prototype.getCenterUntransformed=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.getBoxUntransformed().getCenter(new fe.Vector3)},Vc.prototype.autoView=function(t){this.stage.animationControls.zoomMove(this.getCenter(),this.getZoom(),st(t,0))},Object.defineProperties(Vc.prototype,Gc);var Uc=function(t){void 0===t&&(t=[]);for(var e=(this.list=t).length,r=0;r<e;++r){t[r].signals.disposed.add(this._remove,this)}},Hc={first:{configurable:!0}};Uc.prototype._remove=function(t){var e=this.list.indexOf(t);-1!==e&&this.list.splice(e,1)},Hc.first.get=function(){return 0<this.list.length?this.list[0]:void 0},Uc.prototype.forEach=function(t){return this.list.forEach(t),this},Uc.prototype.dispose=function(){return this.forEach(function(t){return t.dispose()})},Object.defineProperties(Uc.prototype,Hc);var Wc=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.setParameters=function(e){return this.forEach(function(t){return t.setParameters(e)})},e.prototype.setVisibility=function(e){return this.forEach(function(t){return t.setVisibility(e)})},e.prototype.setSelection=function(e){return this.forEach(function(t){return t.setSelection(e)})},e.prototype.setColor=function(e){return this.forEach(function(t){return t.setColor(e)})},e.prototype.update=function(e){return this.forEach(function(t){return t.update(e)})},e.prototype.build=function(e){return this.forEach(function(t){return t.build(e)})},e.prototype.dispose=function(t){return this.forEach(function(t){return t.dispose()})},e}(Uc),qc=Object.assign({defaultStep:1,defaultTimeout:50,defaultInterpolateType:"",defaultInterpolateStep:5,defaultMode:"loop",defaultDirection:"forward",initialFrame:0},Rc),Xc=function(o){function t(t,e,r){var i=this;void 0===r&&(r={}),o.call(this,t,Object.assign({name:e.name},r)),this.trajectory=e,this.signals=Object.assign(this.signals,{frameChanged:new u.Signal,playerChanged:new u.Signal,countChanged:new u.Signal,parametersChanged:new u.Signal}),e.signals.frameChanged.add(function(t){i.signals.frameChanged.dispatch(t)}),e.signals.playerChanged.add(function(t){i.signals.playerChanged.dispatch(t)}),e.signals.countChanged.add(function(t){i.signals.countChanged.dispatch(t)}),void 0!==r.initialFrame&&this.setFrame(r.initialFrame)}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={defaultParameters:{configurable:!0},type:{configurable:!0}};return e.defaultParameters.get=function(){return qc},e.type.get=function(){return"trajectory"},t.prototype.setFrame=function(t){this.trajectory.setFrame(t)},t.prototype.setParameters=function(t){void 0===t&&(t={}),this.trajectory.setParameters(t),this.signals.parametersChanged.dispatch(t)},t.prototype.dispose=function(){this.trajectory.dispose(),o.prototype.dispose.call(this)},Object.defineProperties(t.prototype,e),t}(Fc),Yc=function(t,e){this.name=t,this.path=e,this.coordinates=[],this.boxes=[],this.times=[],this.timeOffset=0,this.deltaTime=1},Kc={type:{configurable:!0}};Kc.type.get=function(){return"Frames"},Object.defineProperties(Yc.prototype,Kc);var Zc=function(t,e){var r,i;if(this.A=new kn(3,3),this.W=new kn(1,3),this.U=new kn(3,3),this.V=new kn(3,3),this.VH=new kn(3,3),this.R=new kn(3,3),this.tmp=new kn(3,3),this.c=new kn(3,3),t instanceof rc)r=t.atomCount;else{if(!(t instanceof Float32Array))return;r=t.length/3}if(e instanceof rc)i=e.atomCount;else{if(!(e instanceof Float32Array))return;i=e.length/3}var o=Math.min(r,i),n=new kn(3,o),a=new kn(3,o);this.coords1t=new kn(o,3),this.coords2t=new kn(o,3),this.transformationMatrix=new fe.Matrix4,this.c.data.set([1,0,0,0,1,0,0,0,-1]),this.prepCoords(t,n,o,!1),this.prepCoords(e,a,o,!1),this._superpose(n,a)};Zc.prototype._superpose=function(t,e){var r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b,x,_,w,A;this.mean1=Dn(t),this.mean2=Dn(e),Rn(t,this.mean1),Rn(e,this.mean2),Mn(this.coords1t,t),Mn(this.coords2t,e),Bn(this.A,this.coords2t,this.coords1t),Ln(this.A,this.W,this.U,this.V),r=this.V,i=this.VH,o=r.data,n=i.data,a=o[4],s=o[8],c=o[5],u=o[7],h=o[0],l=h*a,p=h*c,d=o[3],f=o[1],m=d*f,g=o[2],y=d*g,v=o[6],_=1/(l*s-p*u-m*s+y*u+(b=v*f)*c-(x=v*g)*a),n[0]=(a*s-c*u)*_,n[1]=-(f*s-g*u)*_,n[2]=-(-f*c+g*a)*_,n[3]=-(d*s-c*v)*_,n[4]=(h*s-x)*_,n[5]=-(p-y)*_,n[6]=-(-d*u+a*v)*_,n[7]=-(h*u-b)*_,n[8]=(l-m)*_,Tn(this.R,this.U,this.VH),w=this.R,(A=w.data)[0]*A[4]*A[8]-A[0]*A[5]*A[7]-A[3]*A[1]*A[8]+A[3]*A[2]*A[7]+A[6]*A[1]*A[5]-A[6]*A[2]*A[4]<0&&(de.Debug&&me.log("R not a right handed system"),Tn(this.tmp,this.c,this.VH),Tn(this.R,this.U,this.tmp));var S=new kn(4,4),C=new kn(4,4),P=new kn(4,4),I=new kn(4,4),O=new kn(4,4),k=new kn(4,4),M=this.R.data,B=this.mean1,T=this.mean2;I.data.set([1,0,0,-B[0],0,1,0,-B[1],0,0,1,-B[2],0,0,0,1]),O.data.set([M[0],M[1],M[2],0,M[3],M[4],M[5],0,M[6],M[7],M[8],0,0,0,0,1]),k.data.set([1,0,0,T[0],0,1,0,T[1],0,0,1,T[2],0,0,0,1]),Mn(C,I),Bn(S,O,C),Mn(P,S),Bn(C,k,P),Mn(S,C),this.transformationMatrix.elements=S.data},Zc.prototype.prepCoords=function(t,e,r,i){var o=0,n=e.data,a=3,s=3*r;if(i&&(s=4*r,a=4),t instanceof rc)t.eachAtom(function(t){o<s&&(n[o+0]=t.x,n[o+1]=t.y,n[o+2]=t.z,i&&(n[o+3]=1),o+=a)});else if(t instanceof Float32Array)for(;o<s;o+=a)o<s&&(n[o]=t[o],n[o+1]=t[o+1],n[o+2]=t[o+2],i&&(n[o+3]=1));else me.warn("prepCoords: input type unknown")},Zc.prototype.transform=function(t){var e;if(t instanceof rc)e=t.atomCount;else{if(!(t instanceof Float32Array))return;e=t.length/3}var r=new kn(4,e),i=new kn(e,4);this.prepCoords(t,r,e,!0);var o=this.transformationMatrix,n=o.determinant();if(!n)return n;var a=new kn(4,4);a.data=o.elements,function(t,e,r){for(var i=0,o=0,n=0,a=0,s=0,c=0,u=0,h=0,l=e.cols,p=e.rows,d=r.cols,f=e.data,m=r.data,g=t.data,y=0;i<p;a+=l,i++)for(o=u=0;o<d;h++,u++,o++){for(c=u,s=a,n=y=0;n<l;s++,c+=d,n++)y+=f[s]*m[c];g[h]=y}}(i,r,a);var s=0,c=i.data;if(t instanceof rc){t.eachAtom(function(t){t.x=c[s],t.y=c[s+1],t.z=c[s+2],s+=4});var u=new fe.Matrix4;u.getInverse(o);var h=t.biomolDict;for(var l in h){if(h.hasOwnProperty(l))h[l].partList.forEach(function(t){t.matrixList.forEach(function(t){t.premultiply(o),t.multiply(u)})})}}else if(t instanceof Float32Array)for(var p=4*e;s<p;s+=4)t[s]=c[s],t[s+1]=c[s+1],t[s+2]=c[s+2];else me.warn("transform: input type unknown");return this.transformationMatrix};var Qc={step:1,timeout:50,start:0,end:0,interpolateType:"",interpolateStep:5,mode:"loop",direction:"forward"},Jc=function(t,e){var r=this;void 0===e&&(e={}),this.signals={startedRunning:new u.Signal,haltedRunning:new u.Signal},this._run=!1,this._previousTime=0,this._currentTime=0,this._currentStep=1,t.signals.playerChanged.add(function(t){t!==r&&r.pause()},this);var i=st(t.frameCount,1);this.traj=t,this.parameters=w(e,Qc),this.parameters.end=Math.min(st(e.end,i-1),i-1),this.parameters.step=st(e.step,Math.ceil((i+1)/100)),this._currentFrame=this.parameters.start,this._direction="bounce"===this.parameters.direction?"forward":this.parameters.direction,t.signals.countChanged.add(function(t){r.parameters.end=Math.min(st(r.parameters.end,t-1),t-1)},this),this._animate=this._animate.bind(this)},tu={isRunning:{configurable:!0}};tu.isRunning.get=function(){return this._run},Jc.prototype.setParameters=function(t){void 0===t&&(t={}),d(this.parameters,t),void 0!==t.direction&&"bounce"!==this.parameters.direction&&(this._direction=this.parameters.direction)},Jc.prototype._animate=function(){if(this._run){this._currentTime=window.performance.now();var t=this._currentTime-this._previousTime,e=this.parameters.interpolateType?this.parameters.interpolateStep:1,r=this.parameters.timeout/e,i=this.traj;if(i&&i.frameCount&&!i.inProgress&&r<=t)if(this.parameters.interpolateType)if(this._currentStep>this.parameters.interpolateStep&&(this._currentStep=1),1===this._currentStep&&(this._currentFrame=this._nextInterpolated()),i.hasFrame(this._currentFrame)){this._currentStep+=1;var o=this._currentStep/(this.parameters.interpolateStep+1),n=this._currentFrame,a=n[0],s=n[1],c=n[2],u=n[3];i.setFrameInterpolated(a,s,c,u,o,this.parameters.interpolateType),this._previousTime=this._currentTime}else i.loadFrame(this._currentFrame);else{var h=this._next();i.hasFrame(h)?(i.setFrame(h),this._previousTime=this._currentTime):i.loadFrame(h)}window.requestAnimationFrame(this._animate)}},Jc.prototype._next=function(){var t,e=this.parameters;return((t="forward"===this._direction?this.traj.currentFrame+e.step:this.traj.currentFrame-e.step)>e.end||t<e.start)&&("bounce"===e.direction&&("forward"===this._direction?this._direction="backward":this._direction="forward"),"once"===e.mode?(this.pause(),t="forward"===e.direction?e.end:"backward"===e.direction?e.start:"forward"===this._direction?e.start:e.end):"forward"===this._direction?(t=e.start,e.interpolateType&&(t=Math.min(e.end,t+e.step))):(t=e.end,e.interpolateType&&(t=Math.max(e.start,t-e.step)))),t},Jc.prototype._nextInterpolated=function(){var t,e,r,i=this.parameters,o=this._next();return"forward"===this._direction?(t=Math.max(i.start,o-i.step),e=Math.max(i.start,o-2*i.step),r=Math.max(i.start,o-3*i.step)):(t=Math.min(i.end,o+i.step),e=Math.min(i.end,o+2*i.step),r=Math.min(i.end,o+3*i.step)),[o,t,e,r]},Jc.prototype.toggle=function(){this._run?this.pause():this.play()},Jc.prototype.play=function(){if(!this._run){this.traj.player!==this&&this.traj.setPlayer(this),this._currentStep=1;var t=this.parameters,e=this.traj.currentFrame,r=Math.ceil(e/t.step)*t.step;"forward"===t.direction&&e>=t.end?r=t.start:"backward"===t.direction&&e<=t.start&&(r=t.end),this.traj.setFrame(r),this._run=!0,this._animate(),this.signals.startedRunning.dispatch()}},Jc.prototype.pause=function(){this._run=!1,this.signals.haltedRunning.dispatch()},Jc.prototype.stop=function(){this.pause(),this.traj.setFrame(this.parameters.start)},Object.defineProperties(Jc.prototype,tu);var eu=function(t,e,r){var i=this;void 0===r&&(r={}),this.signals={countChanged:new u.Signal,frameChanged:new u.Signal,playerChanged:new u.Signal},this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this._frameCount=0,this._currentFrame=-1,this._disposed=!1,this.deltaTime=st(r.deltaTime,0),this.timeOffset=st(r.timeOffset,0),this.centerPbc=st(r.centerPbc,!1),this.removePbc=st(r.removePbc,!1),this.removePeriodicity=st(r.removePeriodicity,!1),this.superpose=st(r.superpose,!1),this.name=t.replace(/^.*[\\/]/,""),this.trajPath=t,this.selection=new Ct(st(r.sele,"backbone and not hydrogen")),this.selection.signals.stringChanged.add(function(){i.selectionIndices=i.structure.getAtomIndices(i.selection),i._resetCache(),i._saveInitialCoords(),i.setFrame(i._currentFrame)})},ru={frameCount:{configurable:!0},currentFrame:{configurable:!0}};ru.frameCount.get=function(){return this._frameCount},ru.currentFrame.get=function(){return this._currentFrame},eu.prototype._init=function(t){this.setStructure(t),this._loadFrameCount(),this.setPlayer(new Jc(this))},eu.prototype._loadFrameCount=function(){},eu.prototype.setStructure=function(t){this.structure=t,this.atomCount=t.atomCount,this.backboneIndices=this._getIndices(new Ct("backbone and not hydrogen")),this._makeAtomIndices(),this._saveStructureCoords(),this.selectionIndices=this._getIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)},eu.prototype._saveInitialCoords=function(){var t=this;this.structure.hasCoords()?(this.initialCoords=new Float32Array(this.structureCoords),this._makeSuperposeCoords()):this.frameCache[0]?(this.initialCoords=new Float32Array(this.frameCache[0]),this._makeSuperposeCoords()):this.loadFrame(0,function(){return t._saveInitialCoords()})},eu.prototype._saveStructureCoords=function(){this.structureCoords=this.structure.getAtomData({what:{position:!0}}).position},eu.prototype.setSelection=function(t){return this.selection.setString(t),this},eu.prototype._getIndices=function(t){var e=0,r=t.test,i=[];return r&&this.structure.eachAtom(function(t){r(t)&&i.push(e),e+=1}),i},eu.prototype._makeSuperposeCoords=function(){var t=3*this.selectionIndices.length;this.coords1=new Float32Array(t),this.coords2=new Float32Array(t);for(var e=this.initialCoords,r=this.coords2,i=0;i<t;i+=3){var o=3*this.selectionIndices[i/3];r[i+0]=e[o+0],r[i+1]=e[o+1],r[i+2]=e[o+2]}},eu.prototype._makeAtomIndices=function(){me.error("Trajectory._makeAtomIndices not implemented")},eu.prototype._resetCache=function(){this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this.initialCoords=new Float32Array(0)},eu.prototype.setParameters=function(t){void 0===t&&(t={});var e=!1;void 0!==t.centerPbc&&t.centerPbc!==this.centerPbc&&(this.centerPbc=t.centerPbc,e=!0),void 0!==t.removePeriodicity&&t.removePeriodicity!==this.removePeriodicity&&(this.removePeriodicity=t.removePeriodicity,e=!0),void 0!==t.removePbc&&t.removePbc!==this.removePbc&&(this.removePbc=t.removePbc,e=!0),void 0!==t.superpose&&t.superpose!==this.superpose&&(this.superpose=t.superpose,e=!0),this.deltaTime=st(t.deltaTime,this.deltaTime),this.timeOffset=st(t.timeOffset,this.timeOffset),e&&(this._resetCache(),this.setFrame(this._currentFrame))},eu.prototype.hasFrame=function(t){var e=this;return Array.isArray(t)?t.every(function(t){return!!e.frameCache[t]}):!!this.frameCache[t]},eu.prototype.setFrame=function(t,e){var r=this;return void 0===t||(this.inProgress=!0,-1===t||this.frameCache[t]?(this._updateStructure(t),e&&e()):this.loadFrame(t,function(){r._updateStructure(t),e&&e()})),this},eu.prototype._interpolate=function(t,e,r,i,o,n){var a,s=this.frameCache;a="spline"===n?function(t,e,r,i,o){for(var n=t.length,a=new Float32Array(n),s=0;s<n;s+=3){var c=s+1,u=s+2;a[s]=z(i[s],r[s],e[s],t[s],o,1),a[c]=z(i[c],r[c],e[c],t[c],o,1),a[u]=z(i[u],r[u],e[u],t[u],o,1)}return a}(s[t],s[e],s[r],s[i],o):function(t,e,r){for(var i=t.length,o=new Float32Array(i),n=0;n<i;n+=3){var a=n+1,s=n+2;o[n]=N(e[n],t[n],r),o[a]=N(e[a],t[a],r),o[s]=N(e[s],t[s],r)}return o}(s[t],s[e],o),this.structure.updatePosition(a),this._currentFrame=t,this.signals.frameChanged.dispatch(t)},eu.prototype.setFrameInterpolated=function(t,e,r,i,o,n,a){var s=this;if(void 0===t)return this;var c=this.frameCache,u=[];return c[i]||u.push(i),c[r]||u.push(r),c[e]||u.push(e),c[t]||u.push(t),u.length?this.loadFrame(u,function(){s._interpolate(t,e,r,i,o,n),a&&a()}):(this._interpolate(t,e,r,i,o,n),a&&a()),this},eu.prototype.loadFrame=function(t,e){var r=this;Array.isArray(t)?t.forEach(function(t){r.loadQueue[t]||r.frameCache[t]||(r.loadQueue[t]=!0,r._loadFrame(t,function(){delete r.loadQueue[t]}))}):this.loadQueue[t]||this.frameCache[t]||(this.loadQueue[t]=!0,this._loadFrame(t,function(){delete r.loadQueue[t],e&&e()}))},eu.prototype._loadFrame=function(t,e){me.error("Trajectory._loadFrame not implemented",t,e)},eu.prototype._updateStructure=function(t){this._disposed?console.error("updateStructure: traj disposed"):(-1===t?this.structureCoords&&this.structure.updatePosition(this.structureCoords):this.structure.updatePosition(this.frameCache[t]),this.structure.trajectory={name:this.trajPath,frame:t},this._currentFrame=t,this.inProgress=!1,this.signals.frameChanged.dispatch(t))},eu.prototype._doSuperpose=function(t){for(var e=3*this.selectionIndices.length,r=this.coords1,i=this.coords2,o=0;o<e;o+=3){var n=3*this.selectionIndices[o/3];r[o+0]=t[n+0],r[o+1]=t[n+1],r[o+2]=t[n+2]}new Zc(r,i).transform(t)},eu.prototype._process=function(t,e,r,i){if(this._setFrameCount(i),e){if(0<this.backboneIndices.length&&this.centerPbc){var o=[e[0],e[4],e[8]];!function(t,e,r){if(0!==r[0]&&0!==r[8]&&0!==r[4])for(var i=t.length,o=r[0],n=r[1],a=r[2],s=-e[0]+o+o/2,c=-e[1]+n+n/2,u=-e[2]+a+a/2,h=0;h<i;h+=3)t[h+0]=(t[h+0]+s)%o,t[h+1]=(t[h+1]+c)%n,t[h+2]=(t[h+2]+u)%a}(r,(a=this.backboneIndices,[Me(s=r,(c=o)[0],3,0,a),Me(s,c[1],3,1,a),Me(s,c[2],3,2,a)]),o)}if(this.removePeriodicity)!function(t,e,r){if(0!==e[0]&&0!==e[8]&&0!==e[4]){for(var i=t.length,o=3;o<i;o+=3)for(var n=0;n<3;++n){var a=(t[o+n]-r[n])/e[3*n+n];.5<Math.abs(a)&&(t[o+n]-=e[3*n+n]*Math.round(a))}}}(r,e,[Ge(n=r,3,0),Ge(n,3,1),Ge(n,3,2)]);this.removePbc&&function(t,e){if(0!==e[0]&&0!==e[8]&&0!==e[4]){for(var r=t.length,i=3;i<r;i+=3)for(var o=0;o<3;++o){var n=t[i+o]-t[i-3+o];if(Math.abs(n)>.9*e[3*o+o])if(0<n)for(var a=0;a<3;++a)t[i+a]-=e[3*o+a];else for(var s=0;s<3;++s)t[i+s]+=e[3*o+s]}}}(r,e)}var n,a,s,c;0<this.selectionIndices.length&&this.coords1&&this.superpose&&this._doSuperpose(r),this.frameCache[t]=r,this.boxCache[t]=e,this.frameCacheSize+=1},eu.prototype._setFrameCount=function(t){t!==this._frameCount&&(this._frameCount=t,this.signals.countChanged.dispatch(t))},eu.prototype.dispose=function(){this._resetCache(),this._disposed=!0,this.player&&this.player.stop()},eu.prototype.setPlayer=function(t){this.player=t,this.signals.playerChanged.dispatch(t)},eu.prototype.getFrameTime=function(t){return this.timeOffset+t*this.deltaTime},Object.defineProperties(eu.prototype,ru);var iu=function(o){function t(t,e,r){var i=r||{};i.timeOffset=st(i.timeOffset,t.timeOffset),i.deltaTime=st(i.deltaTime,t.deltaTime),o.call(this,"",e,i),this.name=t.name,this.path=t.path,this.frames=t.coordinates,this.boxes=t.boxes,this._init(e)}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"frames"},t.prototype._makeAtomIndices=function(){"StructureView"===this.structure.type?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0},t.prototype._loadFrame=function(t,e){var r,i=this.frames[t];if(this.atomIndices){var o=this.atomIndices,n=o.length;r=new Float32Array(3*n);for(var a=0;a<n;++a){var s=3*a,c=3*o[a];r[s+0]=i[c+0],r[s+1]=i[c+1],r[s+2]=i[c+2]}}else r=new Float32Array(i);var u=this.boxes[t],h=this.frames.length;this._process(t,u,r,h),"function"==typeof e&&e()},t.prototype._loadFrameCount=function(){this.frames&&this._setFrameCount(this.frames.length)},Object.defineProperties(t.prototype,e),t}(eu),ou=function(i){function t(t,e,r){i.call(this,"",e,r),this._init(e)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"structure"},t.prototype._makeAtomIndices=function(){this.structure.atomSet&&this.structure.atomSet.getSize()<this.structure.atomStore.count?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0},t.prototype._loadFrame=function(t,e){var r,i=this.structure,o=i.frames[t];if(this.atomIndices){var n=this.atomIndices,a=n.length;r=new Float32Array(3*a);for(var s=0;s<a;++s){var c=3*s,u=3*n[s];r[c+0]=o[u+0],r[c+1]=o[u+1],r[c+2]=o[u+2]}}else r=new Float32Array(o);var h=i.boxes[t],l=i.frames.length;this._process(t,h,r,l),"function"==typeof e&&e()},t.prototype._loadFrameCount=function(){this._setFrameCount(this.structure.frames.length)},Object.defineProperties(t.prototype,e),t}(eu),nu=function(i){function t(t,e,r){i.call(this,t,e,r),this._init(e)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"remote"},t.prototype._makeAtomIndices=function(){var t=[];if("StructureView"===this.structure.type){for(var e=this.structure.getAtomIndices(),r=e.length,i=e[0],o=e[0],n=1;n<r;++n){var a=e[n];o+1<a&&(t.push([i,o+1]),i=a),o=a}t.push([i,o+1])}else t.push([0,this.atomCount]);this.atomIndices=t},t.prototype._loadFrame=function(o,n){var a=this,s=new XMLHttpRequest,c=de.TrajectoryDatasource.getFrameUrl(this.trajPath,o),t=de.TrajectoryDatasource.getFrameParams(this.trajPath,this.atomIndices);s.open("POST",c,!0),s.responseType="arraybuffer",s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.addEventListener("load",function(){var t=s.response;if(t){var e=new Int32Array(t,0,1)[0],r=new Float32Array(t,8,9),i=new Float32Array(t,44);a._process(o,r,i,e),"function"==typeof n&&n()}else me.error("empty arrayBuffer for '"+c+"'")},!1),s.send(t)},t.prototype._loadFrameCount=function(){var t=this,e=new XMLHttpRequest,r=de.TrajectoryDatasource.getCountUrl(this.trajPath);e.open("GET",r,!0),e.addEventListener("load",function(){t._setFrameCount(parseInt(e.response))},!1),e.send()},Object.defineProperties(t.prototype,e),t}(eu);rc.prototype.getView=function(t){return new au(this,t)};var au=function(r){function t(t,e){r.call(this),this.structure=t,this.selection=e,this.center=new fe.Vector3,this.boundingBox=new fe.Box3,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy(),this.selection&&this.selection.signals.stringChanged.add(this.refresh,this),this.structure.signals.refreshed.add(this.refresh,this),this.refresh()}r&&(t.__proto__=r);var e={type:{configurable:!0},name:{configurable:!0},path:{configurable:!0},title:{configurable:!0},id:{configurable:!0},data:{configurable:!0},atomSetDict:{configurable:!0},biomolDict:{configurable:!0},entityList:{configurable:!0},unitcell:{configurable:!0},frames:{configurable:!0},boxes:{configurable:!0},validation:{configurable:!0},bondStore:{configurable:!0},backboneBondStore:{configurable:!0},rungBondStore:{configurable:!0},atomStore:{configurable:!0},residueStore:{configurable:!0},chainStore:{configurable:!0},modelStore:{configurable:!0},atomMap:{configurable:!0},residueMap:{configurable:!0},bondHash:{configurable:!0},spatialHash:{configurable:!0},_hasCoords:{configurable:!0}};return((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.init=function(){},e.type.get=function(){return"StructureView"},e.name.get=function(){return this.structure.name},e.path.get=function(){return this.structure.path},e.title.get=function(){return this.structure.title},e.id.get=function(){return this.structure.id},e.data.get=function(){return this.structure.data},e.atomSetDict.get=function(){return this.structure.atomSetDict},e.biomolDict.get=function(){return this.structure.biomolDict},e.entityList.get=function(){return this.structure.entityList},e.unitcell.get=function(){return this.structure.unitcell},e.frames.get=function(){return this.structure.frames},e.boxes.get=function(){return this.structure.boxes},e.validation.get=function(){return this.structure.validation},e.bondStore.get=function(){return this.structure.bondStore},e.backboneBondStore.get=function(){return this.structure.backboneBondStore},e.rungBondStore.get=function(){return this.structure.rungBondStore},e.atomStore.get=function(){return this.structure.atomStore},e.residueStore.get=function(){return this.structure.residueStore},e.chainStore.get=function(){return this.structure.chainStore},e.modelStore.get=function(){return this.structure.modelStore},e.atomMap.get=function(){return this.structure.atomMap},e.residueMap.get=function(){return this.structure.residueMap},e.bondHash.get=function(){return this.structure.bondHash},e.spatialHash.get=function(){return this.structure.spatialHash},e._hasCoords.get=function(){return this.structure._hasCoords},e._hasCoords.set=function(t){this.structure._hasCoords=t},t.prototype.refresh=function(){de.Debug&&me.time("StructureView.refresh"),this.atomSetCache={};var t=this.structure;if(this.selection.isAllSelection()&&t!==this&&t.atomSet&&t.bondSet){for(var e in this.atomSet=t.atomSet.clone(),this.bondSet=t.bondSet.clone(),this.atomSetDict){var r=this.atomSetDict[e];this.atomSetCache["__"+e]=r.clone()}this.atomCount=t.atomCount,this.bondCount=t.bondCount,this.boundingBox.copy(t.boundingBox),this.center.copy(t.center)}else if(this.selection.isNoneSelection()&&t!==this&&t.atomSet&&t.bondSet){for(var i in this.atomSet=new Wi(t.atomCount),this.bondSet=new Wi(t.bondCount),this.atomSetDict)this.atomSetCache["__"+i]=new Wi(t.atomCount);this.atomCount=0,this.bondCount=0,this.boundingBox.makeEmpty(),this.center.set(0,0,0)}else{for(var o in this.atomSet=this.getAtomSet(this.selection,!0),t.atomSet&&(this.atomSet=this.atomSet.intersection(t.atomSet)),this.bondSet=this.getBondSet(),this.atomSetDict){var n=this.atomSetDict[o];this.atomSetCache["__"+o]=n.makeIntersection(this.atomSet)}this.atomCount=this.atomSet.getSize(),this.bondCount=this.bondSet.getSize(),this.boundingBox=this.getBoundingBox(),this.center=this.boundingBox.getCenter(new fe.Vector3)}de.Debug&&me.timeEnd("StructureView.refresh"),this.signals.refreshed.dispatch()},t.prototype.setSelection=function(t){this.selection=t,this.refresh()},t.prototype.getSelection=function(t){var e=[];t&&t.string&&e.push(t.string);var r=this.structure.getSelection();r&&r.string&&e.push(r.string),this.selection&&this.selection.string&&e.push(this.selection.string);var i="";return 0<e.length&&(i="( "+e.join(" ) AND ( ")+" )"),new Ct(i)},t.prototype.getStructure=function(){return this.structure.getStructure()},t.prototype.eachBond=function(t,e){this.structure.eachBond(t,this.getSelection(e))},t.prototype.eachAtom=function(e,t){var r=this.getAtomProxy(),i=this.getAtomSet(t),o=this.atomStore.count;if(i.getSize()<o)i.forEach(function(t){r.index=t,e(r)});else for(var n=0;n<o;++n)r.index=n,e(r)},t.prototype.eachResidue=function(t,e){this.structure.eachResidue(t,this.getSelection(e))},t.prototype.eachResidueN=function(t,e){console.error("StructureView.eachResidueN() not implemented")},t.prototype.eachChain=function(t,e){this.structure.eachChain(t,this.getSelection(e))},t.prototype.eachModel=function(t,e){this.structure.eachModel(t,this.getSelection(e))},t.prototype.getAtomSet=function(t,e){void 0===e&&(e=!1);var r=this.structure.getAtomSet(t);return!e&&this.atomSet&&(r=r.makeIntersection(this.atomSet)),r},t.prototype.getAtomIndices=function(t){return this.structure.getAtomIndices(this.getSelection(t))},t.prototype.refreshPosition=function(){return this.structure.refreshPosition()},t.prototype.dispose=function(){this.selection&&this.selection.signals.stringChanged.remove(this.refresh,this),this.structure.signals.refreshed.remove(this.refresh,this),delete this.structure,delete this.atomSet,delete this.bondSet,delete this.atomCount,delete this.bondCount},Object.defineProperties(t.prototype,e),t}(rc),su=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]];function cu(r,t){var i,o=0,n={};return t.forEach(function(t){i=0;var e={};t.forEach(function(t){e[r[i++]]=t}),n[r[o++]]=e}),n}var uu={blosum62:cu("ARNDCQEGHILKMFPSTWYVBZ?",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:cu("ACDEFGHIKLMNPQRSTVWY",su)},hu=function(t,e,r,i,o){void 0===r&&(r=-10),void 0===i&&(i=-1),void 0===o&&(o="blosum62"),this.seq1=t,this.seq2=e,this.gapPenalty=r,this.gapExtensionPenalty=i,o&&(this.substMatrix=uu[o])};function lu(t,e,r,i,o){var n,a,s,c,u;if(void 0===r&&(r=!1),void 0===i&&(i=""),void 0===o&&(o=""),r){var h=t,l=e;i&&o&&(h=t.getView(new Ct(i)),l=e.getView(new Ct(o)));var p,d,f=h.getSequence(),m=l.getSequence(),g=new hu(f.join(""),m.join(""));g.calc(),g.trace(),a=n=0,s=g.ali1.length;for(var y=[],v=[],b=0;b<s;++b){var x=g.ali1[b],_=g.ali2[b];d=p=0,"-"===x?v[a]=!1:(v[a]=!0,p=1),"-"===_?y[n]=!1:(y[n]=!0,d=1),n+=p,a+=d}var w=[],A=[],S=h.getAtomProxy(),C=l.getAtomProxy();n=0,h.eachResidue(function(t){void 0!==t.traceAtomIndex&&t.traceAtomIndex===t.getAtomIndexByName("CA")&&(y[n]&&(S.index=t.getAtomIndexByName("CA"),w.push(S.x,S.y,S.z)),n+=1)}),n=0,l.eachResidue(function(t){void 0!==t.traceAtomIndex&&t.traceAtomIndex===t.getAtomIndexByName("CA")&&(v[n]&&(C.index=t.getAtomIndexByName("CA"),A.push(C.x,C.y,C.z)),n+=1)}),c=new Float32Array(w),u=new Float32Array(A)}else{c=t.getView(new Ct(i+" and .CA")),u=e.getView(new Ct(o+" and .CA"))}var P=new Zc(c,u).transform(t);return t.refreshPosition(),P}hu.prototype.initMatrices=function(){var t=this;this.n=this.seq1.length,this.m=this.seq2.length,this.score=void 0,this.ali="",this.S=[],this.V=[],this.H=[];for(var e=0;e<=this.n;++e){t.S[e]=[],t.V[e]=[],t.H[e]=[];for(var r=0;r<=this.m;++r)t.S[e][r]=0,t.V[e][r]=0,t.H[e][r]=0}for(var i=0;i<=this.n;++i)t.S[i][0]=t.gap(0),t.H[i][0]=-1/0;for(var o=0;o<=this.m;++o)t.S[0][o]=t.gap(0),t.V[0][o]=-1/0;this.S[0][0]=0},hu.prototype.gap=function(t){return this.gapPenalty+t*this.gapExtensionPenalty},hu.prototype.makeScoreFn=function(){var o=this.seq1,n=this.seq2,a=this.substMatrix;return a?function(t,e){var r=o[t],i=n[e];try{return a[r][i]}catch(t){return-4}}:(me.warn("Alignment: no subst matrix"),function(t,e){return o[t]===n[e]?5:-3})},hu.prototype.calc=function(){de.Debug&&me.time("Alignment.calc"),this.initMatrices();for(var t,e,r,i,o,n=this.gap(0),a=this.makeScoreFn(),s=this.gapExtensionPenalty,c=this.V,u=this.H,h=this.S,l=this.n,p=this.m,d=1;d<=l;++d){e=h[d-1],t=c[d-1],r=c[d],i=u[d],o=h[d];for(var f=1;f<=p;++f)r[f]=Math.max(e[f]+n,t[f]+s),i[f]=Math.max(o[f-1]+n,i[f-1]+s),o[f]=Math.max(e[f-1]+a(d-1,f-1),r[f],i[f])}de.Debug&&me.timeEnd("Alignment.calc"),de.Debug&&me.log(this.S,this.V,this.H)},hu.prototype.trace=function(){var t=this;de.Debug&&me.time("Alignment.trace"),this.ali1="",this.ali2="";var e,r=this.makeScoreFn(),i=this.n,o=this.m;for(this.S[i][o]>=this.V[i][o]?(e="S",this.score=this.S[i][o]):this.V[i][o]>=this.H[i][o]?(e="V",this.score=this.V[i][o]):(e="H",this.score=this.H[i][o]),de.Debug&&me.log("Alignment: SCORE",this.score),de.Debug&&me.log("Alignment: S, V, H",this.S[i][o],this.V[i][o],this.H[i][o]);0<i&&0<o;)"S"===e?t.S[i][o]===t.S[i-1][o-1]+r(i-1,o-1)?(t.ali1=t.seq1[i-1]+t.ali1,t.ali2=t.seq2[o-1]+t.ali2,--i,--o,e="S"):t.S[i][o]===t.V[i][o]?e="V":t.S[i][o]===t.H[i][o]?e="H":(--i,--o):"V"===e?t.V[i][o]===t.V[i-1][o]+t.gapExtensionPenalty?(t.ali1=t.seq1[i-1]+t.ali1,t.ali2="-"+t.ali2,--i,e="V"):t.V[i][o]===t.S[i-1][o]+t.gap(0)?(t.ali1=t.seq1[i-1]+t.ali1,t.ali2="-"+t.ali2,--i,e="S"):--i:"H"===e?t.H[i][o]===t.H[i][o-1]+t.gapExtensionPenalty?(t.ali1="-"+t.ali1,t.ali2=t.seq2[o-1]+t.ali2,--o,e="H"):t.H[i][o]===t.S[i][o-1]+t.gap(0)?(t.ali1="-"+t.ali1,t.ali2=t.seq2[o-1]+t.ali2,--o,e="S"):--o:me.error("Alignment: no matrix");for(;0<i;)t.ali1=t.seq1[i-1]+t.ali1,t.ali2="-"+t.ali2,--i;for(;0<o;)t.ali1="-"+t.ali1,t.ali2=t.seq2[o-1]+t.ali2,--o;de.Debug&&me.timeEnd("Alignment.trace"),de.Debug&&me.log([this.ali1,this.ali2])};var pu=Object.assign({sele:"",defaultAssembly:""},jc),du=function(c){function t(t,e,r){var i,o,n,a,s;void 0===r&&(r={}),c.call(this,t,e,Object.assign({name:e.name},r)),this.structure=e,this.trajList=[],this.signals=Object.assign(this.signals,{trajectoryAdded:new u.Signal,trajectoryRemoved:new u.Signal,defaultAssemblyChanged:new u.Signal}),this.initSelection(this.parameters.sele),this.pickBuffer=(i=4,n=o=0,a=[],{has:function(t){return-1!==a.indexOf(t)},get:function(t){return a[t]},push:function(t){a[o]=t,o=(i+o+1)%i,++n},get count(){return n},get data(){return a.slice(0,Math.min(n,i))},clear:function(){o=n=0,a.length=0}}),this.pickDict=(s={},{has:function(t){return void 0!==s[JSON.stringify(t)]},add:function(t,e){s[JSON.stringify(t)]=e},del:function(t){delete s[JSON.stringify(t)]},get values(){return Object.keys(s).map(function(t){return s[t]})}}),this.spacefillRepresentation=this.addRepresentation("spacefill",{sele:"none",opacity:Nt.opacity,color:Nt.color,disablePicking:!0,radiusType:"data"},!0),this.distanceRepresentation=this.addRepresentation("distance",Nt,!0),this.angleRepresentation=this.addRepresentation("angle",Nt,!0),this.dihedralRepresentation=this.addRepresentation("dihedral",Nt,!0),this.measureRepresentations=new Wc([this.spacefillRepresentation,this.distanceRepresentation,this.angleRepresentation,this.dihedralRepresentation]),this.setDefaultAssembly(this.parameters.defaultAssembly)}c&&(t.__proto__=c),(t.prototype=Object.create(c&&c.prototype)).constructor=t;var e={defaultParameters:{configurable:!0},type:{configurable:!0}};return e.defaultParameters.get=function(){return pu},e.type.get=function(){return"structure"},t.prototype.initSelection=function(t){var e=this;this.selection=new Ct(t),this.structureView=new au(this.structure,this.selection),this.selection.signals.stringChanged.add(function(){e.structureView.setSelection(e.selection),e.rebuildRepresentations(),e.rebuildTrajectories()})},t.prototype.setSelection=function(t){return this.parameters.sele=t,this.selection.setString(t),this},t.prototype.setDefaultAssembly=function(t){if(void 0===this.structure.biomolDict[t]&&(t=""),this.parameters.defaultAssembly!==t){var e={defaultAssembly:t};this.reprList.forEach(function(t){return t.setParameters(e)}),this.measureRepresentations.setParameters(e),this.parameters.defaultAssembly=t,this.signals.defaultAssemblyChanged.dispatch(t)}return this},t.prototype.rebuildRepresentations=function(){this.reprList.forEach(function(t){t.build()}),this.measureRepresentations.build()},t.prototype.rebuildTrajectories=function(){var e=this;this.trajList.forEach(function(t){t.trajectory.setStructure(e.structureView)})},t.prototype.updateRepresentations=function(t){c.prototype.updateRepresentations.call(this,t),this.measureRepresentations.update(t)},t.prototype.addRepresentation=function(t,e,r){var i=this;void 0===e&&(e={}),void 0===r&&(r=!1),e.defaultAssembly=this.parameters.defaultAssembly;var o=this._addRepresentation(t,this.structureView,e,r);return r||o.signals.parametersChanged.add(function(){return i.measureUpdate()}),o},t.prototype.addTrajectory=function(t,e){var r=this;void 0===t&&(t=""),void 0===e&&(e={});var i,o,n,a=(i=t,o=this.structureView,n=e,i&&i instanceof Yc?new iu(i,o,n):!i&&o.frames?new ou(i,o,n):new nu(i,o,n));a.signals.frameChanged.add(function(){r.updateRepresentations({position:!0})});var s=new Xc(this.stage,a,e);return this.trajList.push(s),this.signals.trajectoryAdded.dispatch(s),s},t.prototype.removeTrajectory=function(t){var e=this.trajList.indexOf(t);-1!==e&&this.trajList.splice(e,1),t.dispose(),this.signals.trajectoryRemoved.dispatch(t)},t.prototype.dispose=function(){this.trajList.slice().forEach(function(t){return t.dispose()}),this.trajList.length=0,this.structure.dispose(),this.measureRepresentations.dispose(),c.prototype.dispose.call(this)},t.prototype.autoView=function(t,e){"number"==typeof t&&(e=t,t=""),this.stage.animationControls.zoomMove(this.getCenter(t),this.getZoom(t),st(e,0))},t.prototype.getBoxUntransformed=function(t){return t?this.structureView.getBoundingBox(new Ct(t)):this.structureView.boundingBox},t.prototype.getCenterUntransformed=function(t){return t&&"string"==typeof t?this.structure.atomCenter(new Ct(t)):this.structure.center},t.prototype.superpose=function(t,e,r,i){return lu(this.structureView,t.structureView,e,r,i),this.updateRepresentations({position:!0}),this},t.prototype.getMaxRepresentationRadius=function(t){var r=0,i=this.structure.getAtomProxy(t);return this.eachRepresentation(function(t){if(t.getVisibility()){var e=t.repr;r=Math.max(e.getAtomRadius(i),r)}}),r},t.prototype.measurePick=function(t){var e=this.pickBuffer.count;if(this.lastPick===t.index&&1<=e){if(1<e){var r=this.pickBuffer.data,i=this.pickBuffer.data.sort();this.pickDict.has(i)?this.pickDict.del(i):this.pickDict.add(i,r),2===e?this.distanceRepresentation.setParameters({atomPair:this.pickDict.values.filter(function(t){return 2===t.length})}):3===e?this.angleRepresentation.setParameters({atomTriple:this.pickDict.values.filter(function(t){return 3===t.length})}):4===e&&this.dihedralRepresentation.setParameters({atomQuad:this.pickDict.values.filter(function(t){return 4===t.length})})}this.pickBuffer.clear(),this.lastPick=void 0}else this.pickBuffer.has(t.index)||this.pickBuffer.push(t.index),this.lastPick=t.index;this.measureUpdate()},t.prototype.measureClear=function(){this.pickBuffer.clear(),this.lastPick=void 0,this.spacefillRepresentation.setSelection("none")},t.prototype.measureBuild=function(){var t=this.measureData();this.distanceRepresentation.setParameters({atomPair:t.distance}),this.angleRepresentation.setParameters({atomTriple:t.angle}),this.dihedralRepresentation.setParameters({atomQuad:t.dihedral})},t.prototype.measureUpdate=function(){var r=this,t=this.pickBuffer.data,i={};t.forEach(function(t){var e=Math.max(.1,r.getMaxRepresentationRadius(t));i[t]=e*(2.3-V(.1,2,e))}),this.spacefillRepresentation.setSelection(t.length?"@"+t.join(","):"none"),this.spacefillRepresentation.setParameters({radiusData:i})},t.prototype.measureData=function(){var t=this.pickDict.values;return{distance:t.filter(function(t){return 2===t.length}),angle:t.filter(function(t){return 3===t.length}),dihedral:t.filter(function(t){return 4===t.length})}},t.prototype.removeAllMeasurements=function(t){var r=this.pickDict,i=r.values,e=function(e){i.filter(function(t){return t.length===e}).forEach(function(t){return r.del(t.slice().sort())})};(!t||1&t)&&e(2),(!t||2&t)&&e(3),(!t||4&t)&&e(4),this.measureBuild()},t.prototype.removeMeasurement=function(t){this.pickDict.del(t.slice().sort()),this.measureBuild()},t.prototype.addMeasurement=function(t){if(!(t.length<2||4<t.length)){var e=t.slice().sort();this.pickDict.has(e)||this.pickDict.add(e,t),this.measureBuild()}},Object.defineProperties(t.prototype,e),t}(Vc);Xt.add("structure",du),Xt.add("structureview",du);var fu=function(i){function t(t,e,r){void 0===r&&(r={}),i.call(this,t,e,Object.assign({name:e.name},r)),this.surface=e}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"surface"},t.prototype.addRepresentation=function(t,e){return void 0===e&&(e={}),this._addRepresentation(t,this.surface,e)},t.prototype.getBoxUntransformed=function(){return this.surface.boundingBox},t.prototype.getCenterUntransformed=function(){return this.surface.center},t.prototype.dispose=function(){this.surface.dispose(),i.prototype.dispose.call(this)},Object.defineProperties(t.prototype,e),t}(Vc);Xt.add("surface",fu);var mu=function(i){function t(t,e,r){void 0===r&&(r={}),i.call(this,t,e,Object.assign({name:e.name},r)),this.volume=e}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"volume"},t.prototype.addRepresentation=function(t,e){return void 0===e&&(e={}),this._addRepresentation(t,this.volume,e)},t.prototype.getBoxUntransformed=function(){return this.volume.boundingBox},t.prototype.getCenterUntransformed=function(){return this.volume.center},t.prototype.dispose=function(){this.volume.dispose(),i.prototype.dispose.call(this)},Object.defineProperties(t.prototype,e),t}(Vc);Xt.add("volume",mu);var gu=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.addRepresentation=function(e,r){return this.forEach(function(t){return t.addRepresentation(e,r)})},e.prototype.autoView=function(e){return this.forEach(function(t){return t.autoView(e)})},e}(Uc);function yu(t,e){return t instanceof RegExp?null!==e.name.match(t):e.name===t}var vu=new fe.Vector3,bu={impostor:!0,quality:"medium",workerDefault:!0,sampleLevel:0,backgroundColor:"black",rotateSpeed:2,zoomSpeed:1.2,panSpeed:1,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",fogNear:50,fogFar:100,cameraFov:40,cameraEyeSep:.3,cameraType:"perspective",lightColor:14540253,lightIntensity:1,ambientColor:14540253,ambientIntensity:.2,hoverTimeout:0,tooltip:!0,mousePreset:"default"},xu=function(t,e){void 0===e&&(e={}),this.signals={parametersChanged:new u.Signal,fullscreenChanged:new u.Signal,componentAdded:new u.Signal,componentRemoved:new u.Signal,clicked:new u.Signal,hovered:new u.Signal},this.tasks=new ge,this.compList=[],this.defaultFileParams={},this.logList=[],this.viewer=new ur(t),this.viewer.renderer&&(this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{display:"none",position:"fixed",zIndex:"1000000",pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.viewer.container.appendChild(this.tooltip),this.mouseObserver=new pr(this.viewer.renderer.domElement),this.viewerControls=new $r(this),this.trackballControls=new Ar(this),this.pickingControls=new Or(this),this.animationControls=new Kr(this),this.mouseControls=new xa(this),this.keyControls=new Aa(this),this.pickingBehavior=new Sa(this),this.mouseBehavior=new Ca(this),this.animationBehavior=new Pa(this),this.keyBehavior=new Oa(this),this.spinAnimation=this.animationControls.spin([0,1,0],.005),this.spinAnimation.pause(!0),this.rockAnimation=this.animationControls.rock([0,1,0],.005),this.rockAnimation.pause(!0),this.parameters=w(e,bu),this.setParameters(this.parameters),this.viewer.animate())};xu.prototype.setParameters=function(t){void 0===t&&(t={}),d(this.parameters,t);var e=t,r=this.parameters,i=this.viewer,o=this.trackballControls;return void 0!==e.quality&&this.setQuality(r.quality),void 0!==e.impostor&&this.setImpostor(r.impostor),void 0!==e.rotateSpeed&&(o.rotateSpeed=r.rotateSpeed),void 0!==e.zoomSpeed&&(o.zoomSpeed=r.zoomSpeed),void 0!==e.panSpeed&&(o.panSpeed=r.panSpeed),void 0!==e.mousePreset&&this.mouseControls.preset(r.mousePreset),this.mouseObserver.setParameters({hoverTimeout:r.hoverTimeout}),i.setClip(r.clipNear,r.clipFar,r.clipDist,r.clipMode,r.clipScale),i.setFog(void 0,r.fogNear,r.fogFar),i.setCamera(r.cameraType,r.cameraFov,r.cameraEyeSep),i.setSampling(r.sampleLevel),i.setBackground(r.backgroundColor),i.setLight(r.lightColor,r.lightIntensity,r.ambientColor,r.ambientIntensity),this.signals.parametersChanged.dispatch(this.getParameters()),this},xu.prototype.log=function(t){console.log("STAGE LOG",t),this.logList.push(t)},xu.prototype.getParameters=function(){return Object.assign({},this.parameters)},xu.prototype.defaultFileRepresentation=function(t){if(t instanceof du){var e,r,i;t.setSelection("/0");var o=t.structure;if(o.biomolDict.BU1){var n=o.biomolDict.BU1;e=n.getAtomCount(o),r=n.getResidueCount(o),i=n.getInstanceCount(),t.setDefaultAssembly("BU1")}else e=o.getModelProxy(0).atomCount,r=o.getModelProxy(0).residueCount,i=1;var a=e;Ft&&(a*=4);var s=o.atomStore.count/o.residueStore.count<2;s&&(a*=10);var c="chainname",u="RdYlBu",h=!1;if(1===o.getChainnameCount(new Ct("polymer and /0"))&&(c="residueindex",u="spectral",h=!0),de.Debug&&console.log(a,e,i,s),r/i<4)t.addRepresentation("ball+stick",{colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"});else if(5<i&&15e3<a||7e5<a){var l=Math.min(1.5,Math.max(.1,2e3/(a/i)));s&&(l=Math.min(l,.15)),t.addRepresentation("surface",{colorScheme:c,colorScale:u,colorReverse:h,sele:"polymer",surfaceType:"sas",probeRadius:1.4,scaleFactor:l,useWorker:!1})}else 25e4<a?t.addRepresentation("backbone",{colorScheme:c,colorScale:u,colorReverse:h,lineOnly:!0}):1e5<a?t.addRepresentation("backbone",{colorScheme:c,colorScale:u,colorReverse:h,quality:"low",disableImpostor:!0,radiusScale:2}):8e4<a?t.addRepresentation("backbone",{colorScheme:c,colorScale:u,colorReverse:h,radiusScale:2}):(t.addRepresentation("cartoon",{colorScheme:c,colorScale:u,colorReverse:h,radiusScale:.7,aspectRatio:5,quality:"auto"}),a<5e4&&t.addRepresentation("base",{colorScheme:c,colorScale:u,colorReverse:h,quality:"auto"}),t.addRepresentation("ball+stick",{sele:"ligand",colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"}));t.structure.frames.length&&t.addTrajectory()}else t instanceof fu?t.addRepresentation("surface"):t instanceof mu&&t.addRepresentation("surface");this.tasks.onZeroOnce(this.autoView,this)},xu.prototype.loadFile=function(t,e){var r=this;void 0===e&&(e={});var i=Object.assign({},this.defaultFileParams,e),o=oe(t).name;this.tasks.increment(),this.log("loading file '"+o+"'");var n=st(i.ext,oe(t).ext);return(Ht.isTrajectory(n)?Promise.reject(new Error("loadFile: ext '"+n+"' is a trajectory and must be loaded into a structure component")):ae(t,i)).then(function(t){r.log("loaded '"+o+"'");var e=r.addComponentFromObject(t,i);return i.defaultRepresentation&&r.defaultFileRepresentation(e),r.tasks.decrement(),e},function(t){r.tasks.decrement();var e="error loading file: '"+t+"'";throw r.log(e),e})},xu.prototype.loadScript=function(t){var r=this,i=oe(t).name;return this.log("loading script '"+i+"'"),ae(t).then(function(t){r.tasks.increment(),r.log("running script '"+i+"'"),t.run(r).then(function(){r.tasks.decrement(),r.log("finished script '"+i+"'")}),r.log("called script '"+i+"'")},function(t){r.tasks.decrement();var e="errored script '"+i+"' \""+t+'"';throw r.log(e),e})},xu.prototype.addComponent=function(t){t?(this.compList.push(t),this.signals.componentAdded.dispatch(t)):me.warn("Stage.addComponent: no component given")},xu.prototype.addComponentFromObject=function(t,e){void 0===e&&(e={});var r=Xt.get(t.type);if(r){var i=new r(this,t,e);return this.addComponent(i),i}me.warn("no component for object type",t.type)},xu.prototype.removeComponent=function(t){var e=this.compList.indexOf(t);-1!==e&&(this.compList.splice(e,1),t.dispose(),this.signals.componentRemoved.dispatch(t))},xu.prototype.removeAllComponents=function(){var e=this;this.compList.slice().forEach(function(t){return e.removeComponent(t)})},xu.prototype.handleResize=function(){this.viewer.handleResize()},xu.prototype.setSize=function(t,e){var r=this.viewer.container;r!==document.body&&(void 0!==t&&(r.style.width=t),void 0!==e&&(r.style.height=e),this.handleResize())},xu.prototype.toggleFullscreen=function(t){if(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled){var e=this;t=t||this.viewer.container,this.lastFullscreenElement=t,r()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():(t.dataset.normalWidth=t.style.width||"",t.dataset.normalHeight=t.style.height||"",t.style.width=window.screen.width+"px",t.style.height=window.screen.height+"px",t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",i),document.addEventListener("mozfullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),document.addEventListener("MSFullscreenChange",i),this.handleResize(),this.signals.fullscreenChanged.dispatch(!0),setTimeout(function(){e.handleResize()},100))}else me.log("fullscreen mode (currently) not possible");function r(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function i(){if(!r()&&e.lastFullscreenElement){var t=e.lastFullscreenElement;t.style.width=t.dataset.normalWidth||"",t.style.height=t.dataset.normalHeight||"",document.removeEventListener("fullscreenchange",i),document.removeEventListener("mozfullscreenchange",i),document.removeEventListener("webkitfullscreenchange",i),document.removeEventListener("MSFullscreenChange",i),e.handleResize(),e.signals.fullscreenChanged.dispatch(!1)}}},xu.prototype.setSpin=function(t){t?(this.spinAnimation.resume(!0),this.rockAnimation.pause(!0)):this.spinAnimation.pause(!0)},xu.prototype.setRock=function(t){t?(this.rockAnimation.resume(!0),this.spinAnimation.pause(!0)):this.rockAnimation.pause(!0)},xu.prototype.toggleSpin=function(){this.setSpin(this.spinAnimation.paused)},xu.prototype.toggleRock=function(){this.setRock(this.rockAnimation.paused)},xu.prototype.getFocus=function(){var t=this.parameters;if("scene"!==t.clipMode)return 0;var e=t.clipNear;return"absolute"===t.clipScale&&(e=this.viewer.absoluteToRelative(e)),2*e},xu.prototype.setFocus=function(t){var e,r,i,o;"scene"===this.parameters.clipMode&&("relative"===this.parameters.clipScale?(e=$(t/2,0,49.9),o=$(2*(r=100-e)-(i=50),0,100)):(i=0,o=2*(r=e=this.viewer.relativeToAbsolute(t/2))),this.setParameters({clipNear:e,clipFar:r,fogNear:i,fogFar:o}))},xu.prototype.getZoomForBox=function(t){var e=t.getSize(vu),r=Math.max(e.x,e.y,e.z),i=Math.min(e.x,e.y,e.z),o=r+Math.sqrt(i),n=et(this.viewer.perspectiveCamera.fov),a=this.viewer.width,s=this.viewer.height,c=s<a?1:a/s;return o=Math.abs(.5*o/c/Math.sin(n/2)),-(o+=this.parameters.clipDist)},xu.prototype.getBox=function(){return this.viewer.boundingBox},xu.prototype.getZoom=function(){return this.getZoomForBox(this.getBox())},xu.prototype.getCenter=function(t){return this.getBox().getCenter(t||new fe.Vector3)},xu.prototype.autoView=function(t){this.animationControls.zoomMove(this.getCenter(),this.getZoom(),st(t,0))},xu.prototype.makeImage=function(t){var i=this;return void 0===t&&(t={}),new Promise(function(e,r){i.tasks.onZeroOnce(function(){i.tasks.increment(),i.viewer.makeImage(t).then(function(t){i.tasks.decrement(),e(t)}).catch(function(t){i.tasks.decrement(),r(t)})})})},xu.prototype.setImpostor=function(r){this.parameters.impostor=r;var i=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(t){if(i.includes(t.getType())){var e=t.getParameters();e.disableImpostor=!r,t.build(e)}})},xu.prototype.setQuality=function(r){this.parameters.quality=r;var i=["tube","cartoon","ribbon","trace","rope"],o=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(t){var e=t.getParameters();if(!i.includes(t.getType())){if(!o.includes(t.getType()))return;if(!e.disableImpostor)return void(t.repr.quality=r)}e.quality=r,t.build(e)})},xu.prototype.eachComponent=function(e,r){this.compList.slice().forEach(function(t){void 0!==r&&r!==t.type||e(t)})},xu.prototype.eachRepresentation=function(r,i){this.eachComponent(function(e){e.reprList.slice().forEach(function(t){void 0!==i&&i!==t.getType()||r(t,e)})})},xu.prototype.getComponentsByName=function(e){var r=[];return this.eachComponent(function(t){(void 0===e||yu(e,t))&&r.push(t)}),new gu(r)},xu.prototype.getComponentsByObject=function(e){var r=[];return this.eachComponent(function(t){t.object===e&&r.push(t)}),new gu(r)},xu.prototype.getRepresentationsByName=function(r){var i=[];return this.eachRepresentation(function(t,e){(void 0===r||yu(r,t))&&i.push(t)}),new Wc(i)},xu.prototype.measureClear=function(){this.eachComponent(function(t){return t.measureClear()},"structure")},xu.prototype.measureUpdate=function(){this.eachComponent(function(t){return t.measureUpdate()},"structure")},xu.prototype.dispose=function(){this.tasks.dispose(),this.viewer.dispose()};var _u=function(i){function t(t,e,r){void 0===r&&(r={}),i.call(this,t,e,Object.assign({name:e.name},r)),this.shape=e}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"shape"},t.prototype.addRepresentation=function(t,e){return void 0===e&&(e={}),this._addRepresentation(t,this.shape,e)},t.prototype.getBoxUntransformed=function(){return this.shape.boundingBox},t.prototype.getCenterUntransformed=function(){return this.shape.center},t.prototype.dispose=function(){this.shape.dispose(),i.prototype.dispose.call(this)},Object.defineProperties(t.prototype,e),t}(Vc);Xt.add("shape",_u);var wu=function(r){function t(t){var e=this;r.call(this,t),t.scale||(this.parameters.scale="rainbow",this.parameters.reverse=st(t.reverse,!0)),this.scalePerModel={},t.structure.eachModel(function(t){e.parameters.domain=[t.atomOffset,t.atomEnd],e.scalePerModel[t.index]=e.getScale()})}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){return this.scalePerModel[t.modelIndex](t.index)},t}(q);Vt.add("atomindex",wu);var Au=function(o){function t(t){if(o.call(this,t),t.scale||(this.parameters.scale="OrRd"),!t.domain){var e,r=1/0,i=-1/0;t.sele&&(e=new Ct(t.sele)),t.structure.eachAtom(function(t){var e=t.bfactor;r=Math.min(r,e),i=Math.max(i,e)},e),this.parameters.domain=[r,i]}this.bfactorScale=this.getScale()}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.atomColor=function(t){return this.bfactorScale(t.bfactor)},t}(q);Vt.add("bfactor",Au);var Su=function(e){function t(t){var i=this;e.call(this,t),this.chainidDictPerModel={},this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(t){var e=0,r={};t.eachChain(function(t){void 0===r[t.chainid]&&(r[t.chainid]=e,e+=1)}),i.parameters.domain=[0,e-1],i.chainidDictPerModel[t.index]=r,i.scalePerModel[t.index]=i.getScale()})}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){var e=this.chainidDictPerModel[t.modelIndex];return this.scalePerModel[t.modelIndex](e[t.chainid])},t}(q);Vt.add("chainid",Su);var Cu=function(r){function t(t){var e=this;r.call(this,t),this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(t){e.parameters.domain=[t.chainOffset,t.chainEnd],e.scalePerModel[t.index]=e.getScale()})}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){return this.scalePerModel[t.modelIndex](t.chainIndex)},t}(q);Vt.add("chainindex",Cu);var Pu=function(e){function t(t){var i=this;e.call(this,t),this.chainnameDictPerModel={},this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(t){var e=0,r={};t.eachChain(function(t){void 0===r[t.chainname]&&(r[t.chainname]=e,e+=1)}),i.parameters.domain=[0,e-1],i.chainnameDictPerModel[t.index]=r,i.scalePerModel[t.index]=i.getScale()})}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){var e=this.chainnameDictPerModel[t.modelIndex];return this.scalePerModel[t.modelIndex](e[t.chainname])},t}(q);Vt.add("chainname",Pu);var Iu=function(r){function t(t){r.call(this,t),this.rsrzDict={},this.rsccDict={},t.scale||(this.parameters.scale="RdYlBu"),this.rsrzScale=this.getScale({domain:[2,0]}),this.rsccScale=this.getScale({domain:[.678,1]});var e=t.structure.validation;e&&(this.rsrzDict=e.rsrzDict,this.rsccDict=e.rsccDict)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){var e=t.resno+"";t.inscode&&(e+="^"+t.inscode),t.chainname&&(e+=":"+t.chainname),e+="/"+t.modelIndex;var r=this.rsrzDict[e];if(void 0!==r)return this.rsrzScale(r);var i=this.rsccDict[e];return void 0!==i?this.rsccScale(i):9474192},t}(q);Vt.add("densityfit",Iu);var Ou={ARG:{CD:.1,CZ:.5,NE:-.1},ASN:{CG:.55,OD1:-.55},ASP:{CB:-.16,CG:.36,OD1:-.6,OD2:-.6},CYS:{CB:.19,SG:-.19},GLN:{CD:.55,OE1:-.55},GLU:{CD:.36,CG:-.16,OE1:-.6,OE2:-.6},HIS:{CB:.1,CD2:.2,CE1:.45,CG:.15,ND1:.05,NE2:.05},LYS:{CE:.25,NZ:.75},MET:{CE:.06,CG:.06,SD:-.12},PTR:{C:.55,CA:.1,CZ:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SEP:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SER:{CB:.25,OG:-.25},THR:{CB:.25,OG1:-.25},TPO:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,OG1:-1.1,O1P:-.85,O2P:-.85,O3P:-.85,P:1.4},TRP:{CD1:.06,CD2:.1,CE2:-.04,CE3:-.03,CG:-.03,NE1:-.06},TYR:{CZ:.25,OH:-.25},backbone:{C:.55,O:-.55,N:-.35,CA:.1}},ku=1.04;var Mu=function(r){function t(t){var i=this;r.call(this,t),this.delta=new fe.Vector3,this.hCharges=[],t.scale||(this.parameters.scale="rwb"),t.domain||(this.parameters.domain=[-50,50]),this.scale=this.getScale(),this.charges=new Float32Array(t.structure.atomCount);var o=[];t.structure.eachAtom(function(t){var e;if(i.charges[t.index]=(null!==(e=t).partialCharge?e.partialCharge:e.isProtein()&&(Ou[e.resname]&&Ou[e.resname][e.atomname]||Ou.backbone[e.atomname])||0)*t.occupancy,"N"===t.atomname){if(3<=t.bondCount)return;if(t.bondToElementCount(1))return;var r=function(t,e){void 0===e&&(e=new fe.Vector3);var r=!1,i=!1,o=!1;return e.set(2*t.x,2*t.y,2*t.z),t.eachBondedAtom(function(t){if(!r)return"H"===t.atomname?(e.set(t.x,t.y,t.z),void(r=!0)):void(i||"CA"!==t.atomname?o||"C"!==t.atomname||(o=!0,e.sub(t)):(e.sub(t),i=!0))}),r?e:i&&o?(e.normalize(),e.multiplyScalar(ku),e.add(t),e):void 0}(t);void 0!==r&&(o.push(r),i.hCharges.push(.25*t.occupancy))}});var e=t.structure.getBoundingBox();e.expandByScalar(ku),this.hStore=function(t){for(var e=t.length,r=new Float32Array(e),i=new Float32Array(e),o=new Float32Array(e),n=0;n<t.length;n++){var a=t[n];r[n]=a.x,i[n]=a.y,o[n]=a.z}return{x:r,y:i,z:o,count:e}}(o),this.hHash=new Vi(this.hStore,e),this.hash=new Vi(t.structure.atomStore,e)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.positionColor=function(t){var i=this.charges,o=this.hCharges,n=0;return this.hash.eachWithin(t.x,t.y,t.z,12,function(t,e){var r=i[t];0!==r&&(n+=r/e)}),this.hHash.eachWithin(t.x,t.y,t.z,12,function(t,e){var r=o[t];0!==r&&(n+=r/e)}),this.scale(332*n)},t}(q);Vt.add("electrostatic",Mu);var Bu={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120},Tu=function(e){function t(t){t.value=st(t.value,Bu.C),e.call(this,t)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){var e=t.element;return"C"===e?this.parameters.value:Bu[e]||16777215},t}(q);Vt.add("element",Tu);var Du=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="Spectral"),t.domain||(this.parameters.domain=[0,t.structure.entityList.length-1]),this.entityindexScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){return this.entityindexScale(t.entityIndex)},t}(q);Vt.add("entityindex",Du);var Ru=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.atomColor=function(t){var e=t.entity;switch(e?e.entityType:void 0){case 1:return 8374655;case 2:return 16629894;case 3:return 12496596;case 4:return 3697840;default:return 16777113}},e}(q);Vt.add("entitytype",Ru);var Fu=function(r){function t(t){r.call(this,t),this.geoAtomDict={},this.geoDict={};var e=t.structure.validation;e&&(this.geoAtomDict=e.geoAtomDict,this.geoDict=e.geoDict)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){var e,r=t.resno+"";t.inscode&&(r+="^"+t.inscode),t.chainname&&(r+=":"+t.chainname),r+="/"+t.modelIndex;var i,o=this.geoAtomDict[r];if(void 0!==o){var n=o[t.atomname]||0;i=n,e=16843009*((i=(858993459&(i-=i>>1&1431655765))+(i>>2&858993459))+(i>>4)&252645135)>>24}else e=this.geoDict[r]||0;return 0===e?2188972:1===e?16703627:2===e?16018755:3<=e?10813478:9474192},t}(q);Vt.add("geoquality",Fu);var Eu=function(a){function t(t){a.call(this,t),this.resHF={},t.scale||(this.parameters.scale="RdYlGn");for(var e in lo)this.resHF[e]=lo[e][0];if(this.defaultResidueHydrophobicity=po[0],!t.domain){var r=1/0,i=-1/0;for(var o in this.resHF){var n=this.resHF[o];r=Math.min(r,n),i=Math.max(i,n)}this.parameters.domain=[r,0,i]}this.hfScale=this.getScale()}return a&&(t.__proto__=a),((t.prototype=Object.create(a&&a.prototype)).constructor=t).prototype.atomColor=function(t){return this.hfScale(this.resHF[t.resname]||this.defaultResidueHydrophobicity)},t}(q);Vt.add("hydrophobicity",Eu);var $u=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="rainbow"),t.domain||(this.parameters.domain=[0,t.structure.modelStore.count]),this.modelindexScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){return this.modelindexScale(t.modelIndex)},t}(q);Vt.add("modelindex",$u);var Lu=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.atomColor=function(t){switch(t.residueType.moleculeType){case 1:return 3697840;case 2:return 15729279;case 3:return 12496596;case 4:return 16629894;case 5:return 12540695;case 6:return 8374655;default:return 16777113}},e}(q);Vt.add("moleculetype",Lu);var Nu=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="PuBu"),t.domain||(this.parameters.domain=[0,1]),this.occupancyScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){return this.occupancyScale(t.occupancy)},t}(q);Vt.add("occupancy",Nu);var zu=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="rwb"),t.domain||(this.parameters.domain=[-1,1]),this.partialchargeScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){return this.partialchargeScale(t.partialCharge||0)},t}(q);function ju(){return 16777215*Math.random()}Vt.add("partialcharge",zu);var Vu=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.atomColor=function(){return ju()},e.prototype.volumeColor=function(){return ju()},e.prototype.positionColor=function(){return ju()},e}(q);Vt.add("random",Vu);var Gu=function(r){function t(t){r.call(this,t),this.rciDict={},t.scale||(this.parameters.scale="RdYlBu"),this.rciScale=this.getScale({domain:[.6,0]});var e=t.structure.validation;e&&(this.rciDict=e.rciDict)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){var e="["+t.resname+"]"+t.resno;t.chainname&&(e+=":"+t.chainname);var r=this.rciDict[e];return void 0!==r?this.rciScale(r):9474192},t}(q);Vt.add("randomcoilindex",Gu);var Uu=function(r){function t(t){var e=this;r.call(this,t),this.scalePerChain={},t.scale||(this.parameters.scale="rainbow",this.parameters.reverse=st(t.reverse,!0)),t.structure.eachChain(function(t){e.parameters.domain=[t.residueOffset,t.residueEnd],e.scalePerChain[t.index]=e.getScale()})}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.atomColor=function(t){return this.scalePerChain[t.chainIndex](t.residueIndex)},t}(q);Vt.add("residueindex",Uu);var Hu={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:14423100,G:3329330,I:10145074,X:8190976,C:16766720,T:4286945,U:4251856,D:35723,DA:14423100,DG:3329330,DI:10145074,DX:8190976,DC:16766720,DT:4286945,DU:4251856,DD:35723},Wu=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.atomColor=function(t){return Hu[t.resname]||16711935},e}(q);Vt.add("resname",Wu);var qu=16711808,Xu=10485888,Yu=6291584,Ku=16762880,Zu=6324479,Qu=16777215,Ju=11403518,th=16580962,eh=10921722,rh=function(e){function t(t){e.call(this,t),this.residueProxy=t.structure.getResidueProxy()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.atomColor=function(t){var e=t.sstruc,r=this.residueProxy;return"h"===e?qu:"g"===e?Xu:"i"===e?Yu:"e"===e||"b"===e?Ku:"t"===e?Zu:(r.index=t.residueIndex,r.isDna()?Ju:r.isRna()?th:r.isSaccharide()?eh:r.isProtein()||"s"===e||"l"===e?Qu:8421504)},t}(q);Vt.add("sstruc",rh);var ih=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.atomColor=function(){return this.parameters.value},e.prototype.bondColor=function(){return this.parameters.value},e.prototype.valueColor=function(){return this.parameters.value},e.prototype.volumeColor=function(){return this.parameters.value},e}(q);Vt.add("uniform",ih);var oh=function(e){function t(t){e.call(this,t),this.valueScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.volumeColor=function(t){return this.valueScale(this.parameters.volume.data[t])},t}(q);Vt.add("value",oh);var nh=function(e){function t(t){e.call(this,t),this.vec=new fe.Vector3,this.valueScale=this.getScale()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.positionColor=function(t){var e=this.parameters.volume;if(!e||!e.inverseMatrix)return this.parameters.value;var r=this.vec,i=e.data,o=e.nx,n=e.ny,a=o*n;r.copy(t),r.applyMatrix4(e.inverseMatrix);var s=Math.floor(r.x),c=Math.floor(r.y),u=Math.floor(r.z),h=(u*n+c)*o+s,l=h+1,p=h+o,d=h+a,f=p+1,m=d+1,g=p+a,y=g+1,v=i[h],b=i[l],x=i[p],_=i[d],w=i[f],A=i[m],S=i[g],C=i[y],P=r.x-s,I=r.y-c,O=r.z-u,k=N(v,b,P),M=N(_,A,P),B=N(x,w,P),T=N(S,C,P),D=N(N(k,B,I),N(M,T,I),O);return this.valueScale(D)},t}(q);Vt.add("volume",nh);var ah=function(n){function t(t,e,r){var i=r||{};if(n.call(this,t,e,i),this.type="structure",this.parameters=Object.assign({radiusType:{type:"select",options:Ea.types},radiusData:{type:"hidden"},radiusSize:{type:"number",precision:3,max:10,min:.001},radiusScale:{type:"number",precision:3,max:10,min:.001},assembly:null,defaultAssembly:{type:"hidden"}},this.parameters),this.selection=new Ct(i.sele),this.dataList=[],this.structure=t,this.structureView=this.structure.getView(this.selection),t.biomolDict){var o={default:"default","":t.unitcell?"AU":"FULL"};Object.keys(t.biomolDict).forEach(function(t){o[t]=t}),this.parameters.assembly={type:"select",options:o,rebuild:!0}}else this.parameters.assembly=null}n&&(t.__proto__=n),(t.prototype=Object.create(n&&n.prototype)).constructor=t;var e={defaultScale:{configurable:!0}};return e.defaultScale.get=function(){return{vdw:1,covalent:1,bfactor:.01,sstruc:1}},t.prototype.init=function(t){var e=this,r=t||{};r.colorScheme=st(r.colorScheme,"element"),this.setRadius(r.radius,r),this.radiusType=st(r.radiusType,"vdw"),this.radiusData=st(r.radiusData,{}),this.radiusSize=st(r.radiusSize,1),this.radiusScale=st(r.radiusScale,1),this.assembly=st(r.assembly,"default"),this.defaultAssembly=st(r.defaultAssembly,""),"auto"===r.quality&&(r.quality=this.getQuality()),n.prototype.init.call(this,r),this.selection.signals.stringChanged.add(function(){e.build()}),this.build()},t.prototype.setRadius=function(t,e){var r=Object.keys(Fa);return"string"==typeof t&&r.includes(t.toLowerCase())?e.radiusType=t:void 0!==t&&(e.radiusType="size",e.radiusSize=t),this},t.prototype.getAssembly=function(){var t="default"===this.assembly?this.defaultAssembly:this.assembly;return this.structure.biomolDict[t]},t.prototype.getQuality=function(){var t,e=this.structureView,r=this.getAssembly();return t=r?r.getAtomCount(e):e.atomCount,Ft&&(t*=4),e.atomStore.count/e.residueStore.count<2&&(t*=10),t<15e3?"high":t<8e4?"medium":"low"},t.prototype.create=function(){var o=this;if(0!==this.structureView.atomCount)if(this.structureView.hasCoords()){this.needsBuild=!1;var t=this.getAssembly();if(t)t.partList.forEach(function(t,e){var r=t.getView(o.structureView);if(0!==r.atomCount){var i=o.createData(r,e);i&&(i.sview=r,i.instanceList=t.getInstanceList(),o.dataList.push(i))}});else{var e=this.createData(this.structureView,0);e&&(e.sview=this.structureView,this.dataList.push(e))}}else this.needsBuild=!0},t.prototype.update=function(e){var r=this;!this.lazy||this.visible?this.needsBuild?this.build():this.dataList.forEach(function(t){0<t.bufferList.length&&r.updateData(e,t)},this):Object.assign(this.lazyProps.what,e)},t.prototype.updateData=function(t,e){this.build()},t.prototype.getColorParams=function(){return Object.assign(Object.assign({},n.prototype.getColorParams.call(this)),{structure:this.structure})},t.prototype.getRadiusParams=function(t){return{type:this.radiusType,scale:this.radiusScale,size:this.radiusSize,data:this.radiusData}},t.prototype.getAtomParams=function(t,e){return Object.assign({what:t,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},e)},t.prototype.getBondParams=function(t,e){return Object.assign({what:t,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},e)},t.prototype.getAtomRadius=function(t){return this.structureView.atomSet.isSet(t.index)?new Ea(this.getRadiusParams()).atomRadius(t):0},t.prototype.setSelection=function(t,e){return this.selection.setString(t,e),this},t.prototype.setParameters=function(t,e,r){void 0===e&&(e={}),void 0===r&&(r=!1);var i=t||{};return this.setRadius(i.radius,i),void 0===i.radiusType&&void 0===i.radiusData&&void 0===i.radiusSize&&void 0===i.radiusScale||(e.radius=!0,$t&&!this.disableImpostor||(r=!0)),void 0!==i.defaultAssembly&&i.defaultAssembly!==this.defaultAssembly&&("default"===this.assembly&&void 0===i.assembly||"default"===i.assembly)&&(r=!0),n.prototype.setParameters.call(this,i,e,r),this},t.prototype.getParameters=function(){return Object.assign(n.prototype.getParameters.call(this),{sele:this.selection?this.selection.string:void 0,defaultAssembly:this.defaultAssembly})},t.prototype.attach=function(t){var r=this.viewer,i=this.bufferList;this.dataList.forEach(function(e){e.bufferList.forEach(function(t){i.push(t),r.add(t,e.instanceList)})}),this.setVisibility(this.visible),t()},t.prototype.clear=function(){this.dataList.length=0,n.prototype.clear.call(this)},t.prototype.dispose=function(){this.structureView.dispose(),delete this.structure,delete this.structureView,n.prototype.dispose.call(this)},Object.defineProperties(t.prototype,e),t}(Jr),sh=function(i){function t(t,e,r){i.call(this,t,e,r),this.n=0,this.parameters=Object.assign({labelVisible:{type:"boolean"},labelSize:{type:"number",precision:3,max:10,min:.001},labelColor:{type:"color"},labelFontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:"fontFamily"},labelFontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:"fontStyle"},labelFontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:"fontWeight"},labelsdf:{type:"boolean",buffer:"sdf"},labelXOffset:{type:"number",precision:1,max:20,min:-20,buffer:"xOffset"},labelYOffset:{type:"number",precision:1,max:20,min:-20,buffer:"yOffset"},labelZOffset:{type:"number",precision:1,max:20,min:-20,buffer:"zOffset"},labelAttachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},labelBorder:{type:"boolean",buffer:"showBorder"},labelBorderColor:{type:"color",buffer:"borderColor"},labelBorderWidth:{type:"number",precision:2,max:.3,min:0,buffer:"borderWidth"},labelBackground:{type:"boolean",rebuild:!0},labelBackgroundColor:{type:"color",buffer:"backgroundColor"},labelBackgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},labelBackgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:"backgroundOpacity"},labelFixedSize:{type:"boolean",buffer:"fixedSize"},lineOpacity:{type:"range",min:0,max:1,step:.01},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters,{flatShaded:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};this.labelVisible=st(e.labelVisible,!0),this.labelSize=st(e.labelSize,2),this.labelColor=st(e.labelColor,16777215),this.labelFontFamily=st(e.labelFontFamily,"sans-serif"),this.labelFontStyle=st(e.labelFontstyle,"normal"),this.labelFontWeight=st(e.labelFontWeight,"bold"),this.labelsdf=st(e.labelsdf,"Chrome"===Tt),this.labelXOffset=st(e.labelXOffset,0),this.labelYOffset=st(e.labelYOffset,0),this.labelZOffset=st(e.labelZOffset,.5),this.labelAttachment=st(e.labelAttachment,"bottom-left"),this.labelBorder=st(e.labelBorder,!1),this.labelBorderColor=st(e.labelBorderColor,"lightgrey"),this.labelBorderWidth=st(e.labelBorderWidth,.15),this.labelBackground=st(e.labelBackground,!1),this.labelBackgroundColor=st(e.labelBackgroundColor,"lightgrey"),this.labelBackgroundMargin=st(e.labelBackgroundMargin,.5),this.labelBackgroundOpacity=st(e.labelBackgroundOpacity,1),this.labelFixedSize=st(e.labelFixedSize,!1),this.lineOpacity=st(e.lineOpacity,1),this.linewidth=st(e.linewidth,2),i.prototype.init.call(this,e)},t.prototype.update=function(t){t.position?this.build():i.prototype.update.call(this,t)},t.prototype.updateData=function(t,e){var r={};if(t&&!t.labelSize||Object.assign(r,{size:De(this.n,this.labelSize)}),!t||t.labelColor){var i=new fe.Color(this.labelColor);Object.assign(r,{color:Re(this.n,i.r,i.g,i.b)})}this.textBuffer.setAttributes(r)},t.prototype.setParameters=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r=!1),t&&t.labelSize&&(e.labelSize=!0),t&&(t.labelColor||0===t.labelColor)&&(r=e.labelColor=!0),i.prototype.setParameters.call(this,t,e,r),t&&void 0!==t.opacity&&this.textBuffer.setParameters({opacity:1}),t&&void 0!==t.labelVisible&&this.setVisibility(this.visible),this},t.prototype.setVisibility=function(t,e){return i.prototype.setVisibility.call(this,t,!0),this.textBuffer&&this.textBuffer.setVisibility(this.labelVisible&&this.visible),e||this.viewer.requestRender(),this},t.prototype.getLabelBufferParams=function(t){return void 0===t&&(t={}),i.prototype.getBufferParams.call(this,Object.assign({fontFamily:this.labelFontFamily,fontStyle:this.labelFontStyle,fontWeight:this.labelFontWeight,sdf:this.labelsdf,xOffset:this.labelXOffset,yOffset:this.labelYOffset,zOffset:this.labelZOffset,attachment:this.labelAttachment,showBorder:this.labelBorder,borderColor:this.labelBorderColor,borderWidth:this.labelBorderWidth,showBackground:this.labelBackground,backgroundColor:this.labelBackgroundColor,backgroundMargin:this.labelBackgroundMargin,backgroundOpacity:this.labelBackgroundOpacity,fixedSize:this.labelFixedSize,disablePicking:!0,visible:this.labelVisible},t,{opacity:1}))},t.prototype.getAtomRadius=function(){return 0},t}(ah);function ch(a,t){var s=a.getAtomProxy(),c=new Ct,e=t.length;if(0===e)return new Float32Array(0);var u=t[0].length,h=a.getAtomSet(),l=new Float32Array(e*u*3),p=0;return t.forEach(function(t){for(var e=!1,r=0;r<u;r++){var i=t[r];if("number"==typeof i&&Number.isInteger(i)){if(!h.get(i)){e=!0;break}s.index=i}else{c.setString(i);var o=a.getAtomIndices(c);if(!o.length){e=!0;break}s.index=o[0]}var n=p+3*r;l[n++]=s.x,l[n++]=s.y,l[n++]=s.z}e||(p+=3*u)}),l.subarray(0,p)}function uh(t,e,r,i,o){var n=Math.cos(o),a=Math.sin(o);t[0]=e[0]+r[0]*n+i[0]*a,t[1]=e[1]+r[1]*n+i[1]*a,t[2]=e[2]+r[2]*n+i[2]*a}function hh(t,e,r,i,o,n,a){for(var s=0;s<e;s++){for(var c=0;c<r;c++)i[c]=t[c*e+s];lh(i,o,n,a,r);for(var u=0;u<r;u++)t[u*e+s]=o[u]}for(var h=0;h<r;h++){for(var l=0;l<e;l++)i[l]=t[h*e+l];lh(i,o,n,a,e);for(var p=0;p<e;p++)t[h*e+p]=Math.sqrt(o[p])}}function lh(t,e,r,i,o){i[r[0]=0]=Number.MIN_SAFE_INTEGER,i[1]=Number.MAX_SAFE_INTEGER;for(var n=1,a=0;n<o;n++){for(var s=(t[n]+n*n-(t[r[a]]+r[a]*r[a]))/(2*n-2*r[a]);s<=i[a];)a--,s=(t[n]+n*n-(t[r[a]]+r[a]*r[a]))/(2*n-2*r[a]);r[++a]=n,i[a]=s,i[a+1]=Number.MAX_SAFE_INTEGER}for(var c=0,u=0;c<o;c++){for(;i[u+1]<c;)u++;e[c]=(c-r[u])*(c-r[u])+t[r[u]]}}Wt.add("shader/SDFFont.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float xOffset;\nuniform float yOffset;\nuniform float zOffset;\nuniform bool ortho;\nuniform float canvasHeight;\nuniform float pixelRatio;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\nattribute vec2 mapping;\nattribute vec2 inputTexCoord;\nattribute float inputSize;\n#include matrix_scale\n#include common\nvoid main(void){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\ntexCoord = inputTexCoord;\nfloat scale = matrixScale( modelViewMatrix );\nfloat _xOffset = xOffset * scale;\nfloat _yOffset = yOffset * scale;\nfloat _zOffset = zOffset * scale;\nif( texCoord.x == 10.0 ){\n_zOffset -= 0.001;\n}\nvec4 cameraPos = modelViewMatrix * vec4( position, 1.0 );\n#ifdef FIXED_SIZE\nif ( ortho ) {\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPosition.z) * 0.1;\n} else {\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPos.z) * 0.1;\n}\n#endif\nvec4 cameraCornerPos = vec4( cameraPos.xyz, 1.0 );\ncameraCornerPos.xy += mapping * inputSize * 0.01 * scale;\ncameraCornerPos.x += _xOffset;\ncameraCornerPos.y += _yOffset;\nif( ortho ){\ncameraCornerPos.xyz += normalize( -cameraPosition ) * _zOffset;\n} else {\ncameraCornerPos.xyz += normalize( -cameraCornerPos.xyz ) * _zOffset;\n}\ngl_Position = projectionMatrix * cameraCornerPos;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -cameraCornerPos.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),Wt.add("shader/SDFFont.frag","uniform sampler2D fontTexture;\nuniform float opacity;\nuniform bool showBorder;\nuniform vec3 borderColor;\nuniform float borderWidth;\nuniform vec3 backgroundColor;\nuniform float backgroundOpacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\nconst vec3 vColor = vec3( 0.0 );\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#endif\nconst float gamma = 2.2 * 1.4142 / 128.0;\nconst float padding = 0.75;\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\nif( texCoord.x > 1.0 ){\ngl_FragColor = vec4( backgroundColor, backgroundOpacity );\n}else{\nfloat sdf = texture2D( fontTexture, texCoord ).a;\nif( showBorder ) sdf += borderWidth;\nfloat a = smoothstep(padding - gamma, padding + gamma, sdf);\nif( a < 0.2 ) discard;\na *= opacity;\nvec3 outgoingLight = vColor;\nif( showBorder && sdf < ( padding + borderWidth ) ){\noutgoingLight = borderColor;\n}\ngl_FragColor = vec4( outgoingLight, a );\n}\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var ph={};var dh={font:"sans-serif",size:36,style:"normal",variant:"normal",weight:"normal",outline:3,width:1024,height:1024},fh=function(t){void 0===t&&(t={}),this.gamma=1,this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.cutoff=.25,this.parameters=w(t,dh);var e=this.parameters;this.radius=e.size/8,this.padding=e.size/3;var r=this.lineHeight=e.size+2*e.outline+Math.round(e.size/4),i=this.maxWidth=e.width/4,o=this.canvas=document.createElement("canvas");o.width=i,o.height=r;var n=this.context=this.canvas.getContext("2d");n.font=e.style+" "+e.variant+" "+e.weight+" "+e.size+"px "+e.font,n.fillStyle="black",n.textAlign="left",n.textBaseline="bottom",n.lineJoin="round",this.gridOuter=new Float64Array(r*i),this.gridInner=new Float64Array(r*i),this.f=new Float64Array(Math.max(r,i)),this.d=new Float64Array(Math.max(r,i)),this.z=new Float64Array(Math.max(r,i)+1),this.v=new Int16Array(Math.max(r,i)),this.data=new Uint8Array(e.width*e.height*4),this.canvas2=document.createElement("canvas"),this.canvas2.width=e.width,this.canvas2.height=e.height,this.context2=this.canvas2.getContext("2d"),this.placeholder=this.map(String.fromCharCode(65533));for(var a=32;a<=126;++a)this.map(String.fromCharCode(a));this.map(String.fromCharCode(176)),this.map(String.fromCharCode(8491)),this.texture=new fe.CanvasTexture(this.canvas2),this.texture.flipY=!1,this.texture.needsUpdate=!0};fh.prototype.map=function(t){var e=this.parameters;return void 0===this.mapped[t]&&(this.draw(t),this.currentX+this.scratchW>e.width&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>e.height&&console.warn("canvas to small"),this.mapped[t]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH},this.context2.drawImage(this.canvas,0,0,this.scratchW,this.scratchH,this.currentX,this.currentY,this.scratchW,this.scratchH),this.currentX+=this.scratchW),this.mapped[t]},fh.prototype.get=function(t){return this.mapped[t]||this.placeholder},fh.prototype.draw=function(t){var e=this.parameters,r=this.lineHeight,i=e.outline,o=this.context,n=this.maxWidth,a=i,s=r-e.outline,c=o.measureText(t),u=Math.min(n,Math.ceil(c.width+2*a+1)),h=u*r;o.clearRect(0,0,u,r),o.fillText(t,a,s);for(var l=o.getImageData(0,0,u,r),p=l.data,d=0;d<h;d++){var f=l.data[4*d+3]/255;this.gridOuter[d]=1===f?0:0===f?Number.MAX_SAFE_INTEGER:Math.pow(Math.max(0,.5-f),2),this.gridInner[d]=1===f?Number.MAX_SAFE_INTEGER:0===f?0:Math.pow(Math.max(0,f-.5),2)}hh(this.gridOuter,u,r,this.f,this.d,this.v,this.z),hh(this.gridInner,u,r,this.f,this.d,this.v,this.z);for(var m=0;m<h;m++){var g=this.gridOuter[m]-this.gridInner[m];p[4*m+3]=Math.max(0,Math.min(255,Math.round(255-255*(g/this.radius+this.cutoff))))}o.putImageData(l,0,0),this.scratchW=u,this.scratchH=r};var mh=Object.assign({fontFamily:"sans-serif",fontStyle:"normal",fontWeight:"bold",fontSize:36,xOffset:0,yOffset:0,zOffset:.5,attachment:"bottom-left",showBorder:!1,borderColor:"lightgrey",borderWidth:.15,showBackground:!1,backgroundColor:"lightgrey",backgroundMargin:.5,backgroundOpacity:1,forceTransparent:!0,fixedSize:!1},na),gh=Object.assign({fontFamily:{uniform:!0},fontStyle:{uniform:!0},fontWeight:{uniform:!0},fontSize:{uniform:!0},xOffset:{uniform:!0},yOffset:{uniform:!0},zOffset:{uniform:!0},showBorder:{uniform:!0},borderColor:{uniform:!0},borderWidth:{uniform:!0},backgroundColor:{uniform:!0},backgroundOpacity:{uniform:!0},fixedSize:{updateShader:!0}},aa);function yh(t,e){for(var r=t.position.length/3,i=0,o=0;o<r;++o)i+=t.text[o].length;return e.showBackground&&(i+=r),i}var vh=function(o){function t(t,e){void 0===e&&(e={}),o.call(this,{position:new Float32Array(3*yh(t,e)),color:new Float32Array(3*yh(t,e)),picking:new fn},e),this.parameterTypes=gh,this.alwaysTransparent=!0,this.hasWireframe=!1,this.isText=!0,this.vertexShader="SDFFont.vert",this.fragmentShader="SDFFont.frag",this.text=t.text,this.positionCount=t.position.length/3,this.addUniforms({fontTexture:{value:null},xOffset:{value:this.parameters.xOffset},yOffset:{value:this.parameters.yOffset},zOffset:{value:this.parameters.zOffset},ortho:{value:!1},showBorder:{value:this.parameters.showBorder},borderColor:{value:new fe.Color(this.parameters.borderColor)},borderWidth:{value:this.parameters.borderWidth},backgroundColor:{value:new fe.Color(this.parameters.backgroundColor)},backgroundOpacity:{value:this.parameters.backgroundOpacity},canvasHeight:{value:1},pixelRatio:{value:1}}),this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}}),this.setAttributes(t),this.makeTexture(),this.makeMapping()}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return mh},t.prototype.makeMaterial=function(){o.prototype.makeMaterial.call(this);var t=this.texture,e=this.material;e.transparent=!0,e.extensions.derivatives=!0,e.lights=!1,e.uniforms.fontTexture.value=t,e.needsUpdate=!0;var r=this.wireframeMaterial;r.transparent=!0,r.extensions.derivatives=!0,r.lights=!1,r.uniforms.fontTexture.value=t,r.needsUpdate=!0;var i=this.pickingMaterial;i.extensions.derivatives=!0,i.lights=!1,i.uniforms.fontTexture.value=t,i.needsUpdate=!0},t.prototype.setAttributes=function(t){var e,r,i,o,n,a;void 0===t&&(t={});var s=this.text,c=this.geometry.attributes;t.position&&(e=t.position,o=c.position.array,c.position.needsUpdate=!0),t.size&&(r=t.size,n=c.inputSize.array,c.inputSize.needsUpdate=!0),t.color&&(i=t.color,a=c.color.array,c.color.needsUpdate=!0);for(var u,h,l,p,d=this.positionCount,f=0,m=0;m<d;++m)for(h=3*m,p=s[m].length,this.parameters.showBackground&&(p+=1),l=0;l<p;++l,++f)for(var g=0;g<4;g++)u=4*f*3+3*g,e&&(o[u]=e[h],o[u+1]=e[h+1],o[u+2]=e[h+2]),r&&(n[4*f+g]=r[m]),i&&(a[u]=i[h],a[u+1]=i[h+1],a[u+2]=i[h+2])},t.prototype.makeTexture=function(){var t,e;this.textAtlas=(t={font:this.parameters.fontFamily,style:this.parameters.fontStyle,weight:this.parameters.fontWeight,size:this.parameters.fontSize},e=JSON.stringify(t),void 0===ph[e]&&(ph[e]=new fh(t)),ph[e]),this.texture=this.textAtlas.texture},t.prototype.makeMapping=function(){for(var t,e,r,i,o,n,a,s,c=this.textAtlas,u=this.text,h=this.parameters.attachment,l=c.lineHeight*this.parameters.backgroundMargin*.1-10,p=this.geometry.attributes,d=p.inputTexCoord.array,f=p.mapping.array,m=this.positionCount,g=0,y=0;y<m;++y){for(i=0,n=(r=u[y]).length,o=0;o<n;++o)i+=(t=c.get(r[o])).w-2*c.parameters.outline;for(s=h.startsWith("top")?c.lineHeight/1.25:h.startsWith("middle")?c.lineHeight/2.5:0,a=h.endsWith("right")?i:h.endsWith("center")?i/2:0,a+=c.parameters.outline,s+=c.parameters.outline,this.parameters.showBackground&&(f[(e=2*g*4)+0]=-c.lineHeight/6-a-l,f[e+1]=c.lineHeight-s+l,f[e+2]=-c.lineHeight/6-a-l,f[e+3]=0-s-l,f[e+4]=i+c.lineHeight/6-a+2*c.parameters.outline+l,f[e+5]=c.lineHeight-s+l,f[e+6]=i+c.lineHeight/6-a+2*c.parameters.outline+l,f[e+7]=0-s-l,d[e+0]=10,d[e+2]=10,d[e+4]=10,d[e+6]=10,g+=1),o=i=0;o<n;++o,++g){t=c.get(r[o]),f[(e=2*g*4)+0]=i-a,f[e+1]=t.h-s,f[e+2]=i-a,f[e+3]=0-s,f[e+4]=i+t.w-a,f[e+5]=t.h-s,f[e+6]=i+t.w-a,f[e+7]=0-s;var v=c.parameters.width,b=c.parameters.height,x=[t.x/v,t.y/b,t.x/v,(t.y+t.h)/b,(t.x+t.w)/v,t.y/b,(t.x+t.w)/v,(t.y+t.h)/b];d.set(x,e),i+=t.w-2*c.parameters.outline}}p.inputTexCoord.needsUpdate=!0,p.mapping.needsUpdate=!0},t.prototype.getDefines=function(t){var e=o.prototype.getDefines.call(this,t);return this.parameters.fixedSize&&(e.FIXED_SIZE=1),e},t.prototype.setUniforms=function(t){!t||void 0===t.fontFamily&&void 0===t.fontStyle&&void 0===t.fontWeight&&void 0===t.fontSize||(this.makeTexture(),this.makeMapping(),this.texture.needsUpdate=!0,t.fontTexture=this.texture),o.prototype.setUniforms.call(this,t)},Object.defineProperties(t.prototype,e),t}(bc);Yt.add("text",vh),Wt.add("shader/WideLine.vert","\nuniform float clipNear;\nuniform vec3 clipCenter;\nuniform float linewidth;\nuniform vec2 resolution;\nuniform mat4 projectionMatrixInverse;\nattribute vec2 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\nfloat a = projectionMatrix[ 2 ][ 2 ]; float b = projectionMatrix[ 3 ][ 2 ]; float nearEstimate = - 0.5 * b / a;\nfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\nend.xyz = mix( start.xyz, end.xyz, alpha );\n}\nvoid main() {\nfloat aspect = resolution.x / resolution.y;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nflag = mapping.y;\nvColor = color;\nvColor2 = color2;\n#endif\nvec4 start = modelViewMatrix * vec4( position1, 1.0 );\nvec4 end = modelViewMatrix * vec4( position2, 1.0 );\nbool perspective = ( projectionMatrix[ 2 ][ 3 ] == -1.0 ); if ( perspective ) {\nif ( start.z < 0.0 && end.z >= 0.0 ) {\ntrimSegment( start, end );\n} else if ( end.z < 0.0 && start.z >= 0.0 ) {\ntrimSegment( end, start );\n}\n}\nvec4 clipStart = projectionMatrix * start;\nvec4 clipEnd = projectionMatrix * end;\nvec2 ndcStart = clipStart.xy / clipStart.w;\nvec2 ndcEnd = clipEnd.xy / clipEnd.w;\nvec2 dir = ndcEnd - ndcStart;\ndir.x *= aspect;\ndir = normalize( dir );\nvec2 offset = vec2( dir.y, - dir.x );\ndir.x /= aspect;\noffset.x /= aspect;\nif ( mapping.x < 0.0 ) offset *= - 1.0;\noffset *= linewidth;\noffset /= resolution.y;\nvec4 clip = ( mapping.y < 0.5 ) ? clipStart : clipEnd;\noffset *= clip.w;\nclip.xy += offset;\ngl_Position = clip;\n#ifndef PICKING\nvViewPosition = ( projectionMatrixInverse * clip ).xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Wt.add("shader/WideLine.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\n#endif\nvoid main() {\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\nif ( flag < 0.0 ) {\ndiffuseColor.rgb *= vColor;\n} else {\ndiffuseColor.rgb *= vColor2;\n}\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var bh=Object.assign({linewidth:2},na),xh=Object.assign({linewidth:{uniform:!0}},aa),_h=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.parameterTypes=xh,this.vertexShader="WideLine.vert",this.fragmentShader="WideLine.frag",!t.color2&&t.color&&(t.color2=t.color),this.addUniforms({linewidth:{value:this.parameters.linewidth},resolution:{value:new fe.Vector2},projectionMatrixInverse:{value:new fe.Matrix4}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null}}),this.setAttributes(t),this.makeMapping()}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return bh},t.prototype.setParameters=function(t){r.prototype.setParameters.call(this,t)},Object.defineProperties(t.prototype,e),t}(bc);Yt.add("wideline",_h);var wh=function(a){function t(t,e,r){a.call(this,t,e,r),this.type="angle",this.parameters=Object.assign({atomTriple:{type:"hidden",rebuild:!0},vectorVisible:{type:"boolean",default:!0},arcVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(r)}return a&&(t.__proto__=a),((t.prototype=Object.create(a&&a.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.side=st(e.side,"double"),e.opacity=st(e.opacity,.5),this.atomTriple=st(e.atomTriple,[]),this.arcVisible=st(e.arcVisible,!0),this.sectorVisible=st(e.sectorVisible,!0),this.vectorVisible=st(e.vectorVisible,!0),a.prototype.init.call(this,e)},t.prototype.createData=function(t){if(t.atomCount&&this.atomTriple.length){var e,r,i=function(d,t){void 0===t&&(t={});for(var f=st(t.angleStep,Math.PI/90),e=d.length/9,m=new Float32Array(e),g=new Float32Array(3*e),y=new Array(e),v=new Float32Array(6*e),b=new Float32Array(6*e),x=new Array(e),_=new Array(e),w=new Array(e),A=0,S=ci(),C=ci(),P=ci(),I=ci(),O=ci(),k=ci(),M=ci(),B=ci(),T=ci(),r=function(t){var e=9*t;di(S,d,e),di(C,d,e+3),di(P,d,e+6);var r=6*t;fi(S,v,r),fi(C,b,r),fi(C,v,r+3),fi(P,b,r+3),li(I,S,C),li(O,P,C),vi(I,I),vi(O,O),ui(k,I,O);var i=mi(k),o=hi(I,O),n=m[t]=Math.atan2(i,o);y[t]=(ke*n).toFixed(1)+String.fromCharCode(176),0===mi(k)&&(k[0]=1,k[1]=0,k[2]=0),ui(M,k,I),vi(M,M),uh(B,C,I,M,n/2),fi(B,g,3*t);var a=Math.ceil(n/f),s=new Float32Array(9*a);w[t]=s;var c=new Float32Array(3*a),u=new Float32Array(3*a);x[t]=c,_[t]=u,pi(T,C,I);for(var h=function(t,e){var r=9*e,i=3*e;fi(C,s,r),fi(T,s,r+3),fi(T,c,i),uh(T,C,I,M,t),fi(T,s,r+6),fi(T,u,i)},l=0,p=f;p<n;p+=f)h(p,l),l++;h(n,l),A+=a},i=0;i<e;i++)r(i);for(var o=3*A,n=9*A,a=new Float32Array(o),s=new Float32Array(o),c=new Float32Array(n),u=0,h=0,l=0;l<e;l++){var p=x[l],D=_[l];Le(p,a,0,h,p.length),Le(D,s,0,h,D.length),h+=p.length;var R=w[l];Le(R,c,0,u,R.length),u+=R.length}return{labelPosition:g,labelText:y,vectorPosition1:v,vectorPosition2:b,arcPosition1:a,arcPosition2:s,sectorPosition:c}}((e=t,r=this.atomTriple,function(e){for(var t=[],r=e.length/9,i=0;i<r;i++){for(var o=!0,n=i;n<i+3;n+=3)e[n]===e[n+3]&&e[n+1]===e[n+4]&&e[n+2]===e[n+5]&&(o=!1);o&&t.push(i)}var a=new Float32Array(9*t.length),s=0;return t.forEach(function(t){Le(e,a,9*t,9*s,9),s++}),a}(ch(e,r)))),o=this.n=i.labelPosition.length/3,n=new fe.Color(this.labelColor);this.textBuffer=new vh({position:i.labelPosition,size:De(o,this.labelSize),color:Re(o,n.r,n.g,n.b),text:i.labelText},this.getLabelBufferParams());var a=new fe.Color(this.colorValue);return this.vectorBuffer=new _h(Pi({position1:i.vectorPosition1,position2:i.vectorPosition2,color:Re(2*o,a.r,a.g,a.b),color2:Re(2*o,a.r,a.g,a.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.vectorVisible,opacity:this.lineOpacity})),this.arcLength=i.arcPosition1.length/3,this.arcBuffer=new _h(Pi({position1:i.arcPosition1,position2:i.arcPosition2,color:Re(this.arcLength,a.r,a.g,a.b),color2:Re(this.arcLength,a.r,a.g,a.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.arcVisible,opacity:this.lineOpacity})),this.sectorLength=i.sectorPosition.length/3,this.sectorBuffer=new ua({position:i.sectorPosition,color:Re(this.sectorLength,a.r,a.g,a.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.vectorBuffer,this.arcBuffer,this.sectorBuffer]}}},t.prototype.updateData=function(t,e){a.prototype.updateData.call(this,t,e);var r={},i={},o={};if(t.color){var n=new fe.Color(this.colorValue);Object.assign(r,{color:Re(2*this.n,n.r,n.g,n.b),color2:Re(2*this.n,n.r,n.g,n.b)}),Object.assign(i,{color:Re(this.arcLength,n.r,n.g,n.b),color2:Re(this.arcLength,n.r,n.g,n.b)}),Object.assign(o,{color:Re(this.sectorLength,n.r,n.g,n.b)})}this.vectorBuffer.setAttributes(r),this.arcBuffer.setAttributes(i),this.sectorBuffer.setAttributes(o)},t.prototype.setParameters=function(t){return a.prototype.setParameters.call(this,t,{},!1),!t||void 0===t.vectorVisible&&void 0===t.arcVisible&&void 0===t.sectorVisible||this.setVisibility(this.visible),t&&t.lineOpacity&&(this.vectorBuffer.setParameters({opacity:t.lineOpacity}),this.arcBuffer.setParameters({opacity:t.lineOpacity})),t&&void 0!==t.opacity&&(this.vectorBuffer.setParameters({opacity:this.lineOpacity}),this.arcBuffer.setParameters({opacity:this.lineOpacity})),t&&t.linewidth&&(this.vectorBuffer.setParameters({linewidth:t.linewidth}),this.arcBuffer.setParameters({linewidth:t.linewidth})),this},t.prototype.setVisibility=function(t,e){return a.prototype.setVisibility.call(this,t,!0),this.vectorBuffer&&this.vectorBuffer.setVisibility(this.vectorVisible&&this.visible),this.arcBuffer&&this.arcBuffer.setVisibility(this.arcVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),e||this.viewer.requestRender(),this},t}(sh);Ut.add("angle",wh);var Ah=new fe.Vector3,Sh=new fe.Vector3,Ch=new fe.Vector3,Ph=new fe.Vector3(0,1,0),Ih=Object.assign({radialSegments:1,openEnded:!0},na);function Oh(t){void 0===t&&(t={});var e=st(t.radialSegments,10),r=st(t.openEnded,!0),i=(new fe.Matrix4).makeRotationX(Math.PI/2),o=new fe.CylinderBufferGeometry(1,1,1,e,1,r);return o.applyMatrix(i),o}var kh=function(o){function t(t,e){void 0===e&&(e={}),o.call(this,function(t,e){void 0===e&&(e={});var r=Oh(e),i=t.position1.length,o=r.attributes.position.array.length/3,n=i/3,a=new Float32Array(2*n*o);return Ee(n,o,0,a),Ee(n,o,n*o,a),{position:new Float32Array(2*i),color:new Float32Array(2*i),primitiveId:a,picking:t.picking}}(t,e),e,Oh(e)),this.updateNormals=!0;var r=t.position1.length,i=t.radius.length;this.__center=new Float32Array(r),this._position=new Float32Array(2*r),this._color=new Float32Array(2*r),this._from=new Float32Array(2*r),this._to=new Float32Array(2*r),this._radius=new Float32Array(2*i),this.setAttributes(t,!0)}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return Ih},t.prototype.applyPositionTransform=function(t,e,r){Sh.fromArray(this._from,r),Ch.fromArray(this._to,r),t.lookAt(Sh,Ch,Ph);var i=this._radius[e];Ah.set(i,i,Sh.distanceTo(Ch)),t.scale(Ah)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={});var r={};t.position1&&t.position2&&(Be(t.position1,t.position2,this.__center),Be(t.position1,this.__center,this._position),Be(this.__center,t.position2,this._position,t.position1.length),this._from.set(t.position1),this._from.set(this.__center,t.position1.length),this._to.set(this.__center),this._to.set(t.position2,this.__center.length),r.position=this._position),t.color&&t.color2&&(this._color.set(t.color),this._color.set(t.color2,t.color.length),r.color=this._color),t.radius&&(this._radius.set(t.radius),this._radius.set(t.radius,t.radius.length),r.radius=this._radius),o.prototype.setAttributes.call(this,r,e)},Object.defineProperties(t.prototype,e),t}(pc);Wt.add("shader/CylinderImpostor.vert","\nattribute vec3 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\nattribute float radius;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform mat4 modelViewMatrixInverse;\nuniform float ortho;\n#include matrix_scale\nvoid main(){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nbase_radius.w = radius * matrixScale( modelViewMatrix );\nvec3 center = position;\nvec3 dir = normalize( position2 - position1 );\nfloat ext = length( position2 - position1 ) / 2.0;\nvec3 cam_dir;\nif( ortho == 0.0 ){\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;\n}else{\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;\n}\ncam_dir = normalize( cam_dir );\nvec3 ldir;\nfloat b = dot( cam_dir, dir );\nend_b.w = b;\nif( b < 0.0 )\nldir = -ext * dir;\nelse\nldir = ext * dir;\nvec3 left = normalize( cross( cam_dir, ldir ) );\nleft = radius * left;\nvec3 up = radius * normalize( cross( left, ldir ) );\naxis = normalize( normalMatrix * ldir );\nU = normalize( normalMatrix * up );\nV = normalize( normalMatrix * left );\nvec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );\nbase_radius.xyz = base4.xyz / base4.w;\nvec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );\nvec4 end4 = top_position;\nend_b.xyz = end4.xyz / end4.w;\nw = modelViewMatrix * vec4(\ncenter + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0\n);\ngl_Position = projectionMatrix * w;\ngl_Position.z = 0.99;\n}"),Wt.add("shader/CylinderImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat distSq3( vec3 v3a, vec3 v3b ){\nreturn (\n( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +\n( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +\n( v3a.z - v3b.z ) * ( v3a.z - v3b.z )\n);\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nvoid main(){\nvec3 point = w.xyz / w.w;\nvec3 base = base_radius.xyz;\nfloat vRadius = base_radius.w;\nvec3 end = end_b.xyz;\nfloat b = end_b.w;\nvec3 end_cyl = end;\nvec3 surface_point = point;\nvec3 ray_target = surface_point;\nvec3 ray_origin = vec3(0.0);\nvec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);\nmat3 basis = mat3( U, V, axis );\nvec3 diff = ray_target - 0.5 * (base + end_cyl);\nvec3 P = diff * basis;\nfloat dz = dot( axis, ray_direction );\nfloat radius2 = vRadius*vRadius;\nvec3 D = vec3(dot(U, ray_direction),\ndot(V, ray_direction),\ndz);\nfloat a0 = P.x*P.x + P.y*P.y - radius2;\nfloat a1 = P.x*D.x + P.y*D.y;\nfloat a2 = D.x*D.x + D.y*D.y;\nfloat d = a1*a1 - a0*a2;\nif (d < 0.0)\ndiscard;\nfloat dist = (-a1 + sqrt(d)) / a2;\nvec3 new_point = ray_target + dist * ray_direction;\nvec3 tmp_point = new_point - base;\nvec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );\nray_origin = mix( ray_origin, surface_point, ortho );\nfloat front_cap_test = dot( tmp_point, axis );\nfloat end_cap_test = dot((new_point - end_cyl), axis);\n#ifndef CAP\nvec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\nvec3 tmp_point2 = new_point2 - base;\n#endif\nif (front_cap_test < 0.0)\n{\nfloat dNV = dot(-axis, ray_direction);\nif (dNV < 0.0)\ndiscard;\nfloat near = dot(-axis, (base)) / dNV;\nvec3 front_point = ray_direction * near + ray_origin;\nif (dot(front_point - base, front_point-base) > radius2)\ndiscard;\n#ifdef CAP\nnew_point = front_point;\n_normal = axis;\n#else\nnew_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(axis, end_cyl) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - end_cyl, new_point2-base) < radius2)\ndiscard;\ninterior = true;\n#endif\n}\nif( end_cap_test > 0.0 )\n{\nfloat dNV = dot(axis, ray_direction);\nif (dNV < 0.0)\ndiscard;\nfloat near = dot(axis, end_cyl) / dNV;\nvec3 end_point = ray_direction * near + ray_origin;\nif( dot(end_point - end_cyl, end_point-base) > radius2 )\ndiscard;\n#ifdef CAP\nnew_point = end_point;\n_normal = axis;\n#else\nnew_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - base, new_point2-base) < radius2)\ndiscard;\ninterior = true;\n#endif\n}\ngl_FragDepthEXT = calcDepth( new_point );\n#ifdef NEAR_CLIP\nif( calcClip( new_point ) > 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\nif( calcClip( new_point ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#endif\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -new_point;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){\nif( b < 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}else{\nif( b > 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Mh=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),Bh=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),Th=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,"v3",t,e)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return e.mapping.get=function(){return Mh},e.mappingIndices.get=function(){return Bh},e.mappingIndicesSize.get=function(){return 12},e.mappingSize.get=function(){return 6},e.mappingItemSize.get=function(){return 3},Object.defineProperties(t.prototype,e),t}(gc),Dh=Object.assign({openEnded:!1},na),Rh=Object.assign({openEnded:{updateShader:!0}},aa),Fh=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.parameterTypes=Rh,this.isImpostor=!0,this.vertexShader="CylinderImpostor.vert",this.fragmentShader="CylinderImpostor.frag",this.addUniforms({modelViewMatrixInverse:{value:new fe.Matrix4},ortho:{value:0}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return Dh},t.prototype.getDefines=function(t){var e=r.prototype.getDefines.call(this,t);return this.parameters.openEnded||(e.CAP=1),e},Object.defineProperties(t.prototype,e),t}(Th),Eh=(Object.assign({disableImpostor:!1},Ih,Dh),function(t,e){return void 0===e&&(e={}),!t.color2&&t.color&&(t.color2=t.color),!$t||e&&e.disableImpostor?new kh(t,e):new Fh(t,e)});Yt.add("cylinder",Eh);var $h=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="axes",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0,showAxes:{type:"boolean",rebuild:!0},showBox:{type:"boolean",rebuild:!0}},this.parameters,{assembly:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.radiusSize=st(e.radiusSize,.5),e.colorValue=st(e.colorValue,"lightgreen"),e.useInteriorColor=st(e.useInteriorColor,!0),this.showAxes=st(e.showAxes,!0),this.showBox=st(e.showBox,!1),i.prototype.init.call(this,e)},t.prototype.getPrincipalAxes=function(){var t,e=this.getAssembly();return e&&(t=e.partList[0].getSelection()),this.structureView.getPrincipalAxes(t)},t.prototype.getAxesData=function(t){var i=this.getPrincipalAxes(),e=new fe.Color(this.colorValue),r=0,o=0;this.showAxes&&(r+=6,o+=3),this.showBox&&(r+=8,o+=12);var n=new Float32Array(3*r),a=Re(r,e.r,e.g,e.b),s=De(r,this.radiusSize),c=new Float32Array(3*o),u=new Float32Array(3*o),h=Re(o,e.r,e.g,e.b),l=De(o,this.radiusSize),p=0;if(this.showAxes){var d=function(t,e){t.toArray(n,2*p),e.toArray(n,2*p+3),t.toArray(c,p),e.toArray(u,p),p+=3};d(i.begA,i.endA),d(i.begB,i.endB),d(i.begC,i.endC)}if(this.showBox){var f=new fe.Vector3,m=i.getProjectedScaleForAtoms(t),g=m.d1a,y=m.d2a,v=m.d3a,b=m.d1b,x=m.d2b,_=m.d3b,w=2*p,A=function(t,e,r){f.copy(i.center).addScaledVector(i.normVecA,t).addScaledVector(i.normVecB,e).addScaledVector(i.normVecC,r),f.toArray(n,w),w+=3};A(g,y,v),A(g,y,_),A(g,x,_),A(g,x,v),A(b,x,_),A(b,x,v),A(b,y,v),A(b,y,_);var S=p,C=function(t,e){f.fromArray(n,2*p+3*t).toArray(c,S),f.fromArray(n,2*p+3*e).toArray(u,S),S+=3};C(0,1),C(0,3),C(0,6),C(1,2),C(1,7),C(2,3),C(2,4),C(3,5),C(4,5),C(4,7),C(5,6),C(6,7)}var P=new nn(i);return{vertex:{position:n,color:a,radius:s,picking:P},edge:{position1:c,position2:u,color:h,color2:h,radius:l,picking:P}}},t.prototype.create=function(){var t=this.getAxesData(this.structureView);this.sphereBuffer=new _c(t.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new Eh(t.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})},t.prototype.createData=function(t){},t.prototype.updateData=function(t,e){var r=this.getAxesData(e.sview),i={},o={};t&&!t.position||(Object.assign(i,{position:r.vertex.position}),Object.assign(o,{position1:r.edge.position1,position2:r.edge.position2})),t&&!t.color||(Object.assign(i,{color:r.vertex.color}),Object.assign(o,{color:r.edge.color,color2:r.edge.color})),t&&!t.radius||(Object.assign(i,{radius:r.vertex.radius}),Object.assign(o,{radius:r.edge.radius})),this.sphereBuffer.setAttributes(i),this.cylinderBuffer.setAttributes(o)},t}(ah);Ut.add("axes",$h);var Lh=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="ball+stick",this.parameters=Object.assign({sphereDetail:!0,radialSegments:!0,openEnded:!0,disableImpostor:!0,aspectRatio:{type:"number",precision:1,max:10,min:1},lineOnly:{type:"boolean",rebuild:!0},cylinderOnly:{type:"boolean",rebuild:!0},multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondScale:{type:"number",precision:2,max:1,min:.01},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.radiusType=st(e.radiusType,"size"),e.radiusSize=st(e.radiusSize,.15),e.useInteriorColor=st(e.useInteriorColor,!0),this.aspectRatio=st(e.aspectRatio,2),this.lineOnly=st(e.lineOnly,!1),this.cylinderOnly=st(e.cylinderOnly,!1),this.multipleBond=st(e.multipleBond,"off"),this.bondSpacing=st(e.bondSpacing,1),this.bondScale=st(e.bondScale,.4),this.linewidth=st(e.linewidth,2),i.prototype.init.call(this,e)},t.prototype.getAtomRadius=function(t){return this.aspectRatio*i.prototype.getAtomRadius.call(this,t)},t.prototype.getAtomParams=function(t,e){var r=i.prototype.getAtomParams.call(this,t,e);return r.radiusParams.scale*=this.aspectRatio,r},t.prototype.getAtomData=function(t,e,r){return t.getAtomData(this.getAtomParams(e,r))},t.prototype.getBondParams=function(t,e){return e=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,bondScale:this.bondScale},e),i.prototype.getBondParams.call(this,t,e)},t.prototype.getBondData=function(t,e,r){return t.getBondData(this.getBondParams(e,r))},t.prototype.createData=function(t){var e=[];if(this.lineOnly)this.lineBuffer=new _h(this.getBondData(t,{position:!0,color:!0,picking:!0}),this.getBufferParams({linewidth:this.linewidth})),e.push(this.lineBuffer);else{var r=new Eh(this.getBondData(t),this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}));if(e.push(r),!this.cylinderOnly){var i=new _c(this.getAtomData(t),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));e.push(i)}}return{bufferList:e}},t.prototype.updateData=function(t,e){"off"!==this.multipleBond&&t&&t.radius&&(t.position=!0);var r=this.getBondData(e.sview,t);if(this.lineOnly){var i={};t&&!t.position||Object.assign(i,{position1:r.position1,position2:r.position2}),t&&!t.color||Object.assign(i,{color:r.color,color2:r.color2}),e.bufferList[0].setAttributes(i)}else{var o={};if(t&&!t.position||Object.assign(o,{position1:r.position1,position2:r.position2}),t&&!t.color||Object.assign(o,{color:r.color,color2:r.color2}),t&&!t.radius||Object.assign(o,{radius:r.radius}),e.bufferList[0].setAttributes(o),!this.cylinderOnly){var n=this.getAtomData(e.sview,t),a={};t&&!t.position||Object.assign(a,{position:n.position}),t&&!t.color||Object.assign(a,{color:n.color}),t&&!t.radius||Object.assign(a,{radius:n.radius}),e.bufferList[1].setAttributes(a)}}},t.prototype.setParameters=function(t){void 0===t&&(t={});var e=!1,r={};return(t.aspectRatio||t.bondSpacing||t.bondScale)&&(Object.assign(r,{radius:!0}),$t&&!this.disableImpostor||(e=!0)),i.prototype.setParameters.call(this,t,r,e),this},t}(ah);Ut.add("ball+stick",Lh);var Nh=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="backbone",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.aspectRatio=st(e.aspectRatio,1),e.radiusSize=st(e.radiusSize,.25),i.prototype.init.call(this,e)},t.prototype.getAtomRadius=function(t){return t.isTrace()?i.prototype.getAtomRadius.call(this,t):0},t.prototype.getAtomData=function(t,e,r){return t.getBackboneAtomData(this.getAtomParams(e,r))},t.prototype.getBondData=function(t,e,r){return t.getBackboneBondData(this.getBondParams(e,r))},t}(Lh);Ut.add("backbone",Nh);var zh=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="base",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.aspectRatio=st(e.aspectRatio,1),e.radiusSize=st(e.radiusSize,.3),i.prototype.init.call(this,e)},t.prototype.getAtomData=function(t,e,r){return t.getRungAtomData(this.getAtomParams(e,r))},t.prototype.getBondData=function(t,e,r){var i=this.getBondParams(e,r);return Object.assign(i.colorParams,{rung:!0}),t.getRungBondData(i)},t}(Lh);Ut.add("base",zh);var jh=function(t,e){this.m=t,this.tension=e,this.dt=1/this.m,this.delta=1e-4,this.vec1=new fe.Vector3,this.vec2=new fe.Vector3,this.vDir=new fe.Vector3,this.vTan=new fe.Vector3,this.vNorm=new fe.Vector3,this.vBin=new fe.Vector3,this.m2=Math.ceil(this.m/2)};jh.prototype.interpolateToArr=function(t,e,r,i,o,n,a){n[a+0]=z(t.x,e.x,r.x,i.x,o,this.tension),n[a+1]=z(t.y,e.y,r.y,i.y,o,this.tension),n[a+2]=z(t.z,e.z,r.z,i.z,o,this.tension)},jh.prototype.interpolateToVec=function(t,e,r,i,o,n){n.x=z(t.x,e.x,r.x,i.x,o,this.tension),n.y=z(t.y,e.y,r.y,i.y,o,this.tension),n.z=z(t.z,e.z,r.z,i.z,o,this.tension)},jh.prototype.interpolatePosition=function(t,e,r,i,o,n){for(var a=0;a<this.m;++a){var s=n+3*a,c=this.dt*a;this.interpolateToArr(t,e,r,i,c,o,s)}},jh.prototype.interpolateTangent=function(t,e,r,i,o,n){for(var a=this,s=0;s<this.m;++s){var c=a.dt*s,u=c-a.delta,h=c+a.delta,l=n+3*s;u<0&&(u=0),1<h&&(h=1),a.interpolateToVec(t,e,r,i,u,a.vec1),a.interpolateToVec(t,e,r,i,h,a.vec2),a.vec2.sub(a.vec1).normalize(),a.vec2.toArray(o,l)}},jh.prototype.vectorSubdivide=function(t,e,r,i,o){for(var n,a=e.next(),s=e.next(),c=e.next(),u=e.size,h=u-1,l=i||0,p=0;p<h;++p)n=a,a=s,s=c,c=e.next(),t.apply(this,[n,a,s,c,r,l]),l+=3*this.m;o&&(n=e.get(u-2),a=e.get(u-1),s=e.get(0),c=e.get(1),t.apply(this,[n,a,s,c,r,l]),l+=3*this.m)},jh.prototype.getPosition=function(t,e,r,i){t.reset(),this.vectorSubdivide(this.interpolatePosition,t,e,r,i);var o=t.size-1,n=o*this.m*3;i&&(n+=3*this.m);var a=t.get(i?0:o);e[n]=a.x,e[n+1]=a.y,e[n+2]=a.z},jh.prototype.getTangent=function(t,e,r,i){t.reset(),this.vectorSubdivide(this.interpolateTangent,t,e,r,i);var o=(t.size-1)*this.m*3;i&&(o+=3*this.m),Le(e,e,o-3,o,3)},jh.prototype.interpolateNormalDir=function(t,e,r,i,o,n,a,s,c,u,h,l,p){for(var d=this,f=0;f<this.m;++f){var m=l+3*f;p&&(m+=3*d.m2);var g=d.dt*f;d.interpolateToVec(t,e,r,i,g,d.vec1),d.interpolateToVec(o,n,a,s,g,d.vec2),d.vDir.subVectors(d.vec2,d.vec1).normalize(),d.vTan.fromArray(c,m),d.vBin.crossVectors(d.vDir,d.vTan).normalize(),d.vBin.toArray(h,m),d.vNorm.crossVectors(d.vTan,d.vBin).normalize(),d.vNorm.toArray(u,m)}},jh.prototype.interpolateNormal=function(t,e,r,i,o){for(var n=0;n<this.m;++n){var a=o+3*n;t.copy(this.vNorm),this.vTan.fromArray(e,a),this.vBin.crossVectors(t,this.vTan).normalize(),this.vBin.toArray(i,a),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(r,a)}},jh.prototype.getNormal=function(t,e,r,i,o,n){this.vNorm.set(0,0,1);for(var a=t-1,s=o||0,c=0;c<a;++c)this.interpolateNormal(this.vDir,e,r,i,s),s+=3*this.m;n&&(this.interpolateNormal(this.vDir,e,r,i,s),s+=3*this.m),this.vBin.toArray(i,s),this.vNorm.toArray(r,s)},jh.prototype.getNormalDir=function(t,e,r,i,o,n,a,s){t.reset(),e.reset();var c=new fe.Vector3,u=new fe.Vector3,h=new fe.Vector3,l=new fe.Vector3,p=new fe.Vector3,d=(new fe.Vector3).copy(t.next()),f=(new fe.Vector3).copy(t.next()),m=(new fe.Vector3).copy(t.next()),g=new fe.Vector3,y=(new fe.Vector3).copy(e.next()),v=(new fe.Vector3).copy(e.next()),b=(new fe.Vector3).copy(e.next());this.vNorm.set(0,0,1);for(var x=t.size,_=x-1,w=n||0,A=0;A<_;++A)p.copy(d),d.copy(f),f.copy(m),m.copy(t.next()),g.copy(y),y.copy(v),v.copy(b),b.copy(e.next()),0===A?(c.subVectors(g,p),u.subVectors(y,d),c.dot(u)<0&&(u.multiplyScalar(-1),y.addVectors(d,u)),h.subVectors(v,f),u.dot(h)<0&&(h.multiplyScalar(-1),v.addVectors(f,h))):h.copy(l),l.subVectors(b,m),h.dot(l)<0&&(l.multiplyScalar(-1),b.addVectors(m,l)),this.interpolateNormalDir(p,d,f,m,g,y,v,b,r,i,o,w,s),w+=3*this.m;if(a&&(p.copy(t.get(x-2)),d.copy(t.get(x-1)),f.copy(t.get(0)),m.copy(t.get(1)),g.copy(e.get(x-2)),y.copy(e.get(x-1)),v.copy(e.get(0)),b.copy(e.get(1)),h.copy(l),l.subVectors(b,m),h.dot(l)<0&&(l.multiplyScalar(-1),b.addVectors(m,l)),this.interpolateNormalDir(p,d,f,m,g,y,v,b,r,i,o,w,s),w+=3*this.m),s){this.vBin.fromArray(o,3*this.m2),this.vNorm.fromArray(i,3*this.m2);for(var S=0;S<this.m2;++S)this.vBin.toArray(o,3*S),this.vNorm.toArray(i,3*S)}else this.vBin.toArray(o,w),this.vNorm.toArray(i,w)},jh.prototype.interpolateColor=function(t,e,r,i,o){var n,a;for(n=0;n<this.m2;++n)a=o+3*n,r.apply(this,[t,i,a]);for(n=this.m2;n<this.m;++n)a=o+3*n,r.apply(this,[e,i,a])},jh.prototype.getColor=function(t,e,r,i,o){var n;t.reset(),t.next();for(var a=t.next(),s=t.size,c=s-1,u=i||0,h=0;h<c;++h)n=a,a=t.next(),this.interpolateColor(n,a,e,r,u),u+=3*this.m;o&&(n=t.get(s-1),a=t.get(0),this.interpolateColor(n,a,e,r,u),u+=3*this.m),r[u]=r[u-3],r[u+1]=r[u-2],r[u+2]=r[u-1]},jh.prototype.interpolatePicking=function(t,e,r,i,o){var n;for(n=0;n<this.m2;++n)i[o+n]=r.apply(this,[t]);for(n=this.m2;n<this.m;++n)i[o+n]=r.apply(this,[e])},jh.prototype.getPicking=function(t,e,r,i,o){var n;t.reset(),t.next();for(var a=t.next(),s=t.size,c=s-1,u=i||0,h=0;h<c;++h)n=a,a=t.next(),this.interpolatePicking(n,a,e,r,u),u+=this.m;o&&(n=t.get(s-1),a=t.get(0),this.interpolatePicking(n,a,e,r,u),u+=this.m),r[u]=r[u-1]},jh.prototype.interpolateSize=function(t,e,r,i,o){for(var n=r.apply(this,[t]),a=r.apply(this,[e]),s=0;s<this.m;++s){var c=s/this.m;i[o+s]=(1-c)*n+c*a}},jh.prototype.getSize=function(t,e,r,i,o){var n;t.reset(),t.next();for(var a=t.next(),s=t.size,c=s-1,u=i||0,h=0;h<c;++h)n=a,a=t.next(),this.interpolateSize(n,a,e,r,u),u+=this.m;o&&(n=t.get(s-1),a=t.get(0),this.interpolateSize(n,a,e,r,u),u+=this.m),r[u]=r[u-1]};var Vh=function(t,e){this.polymer=t,this.size=t.residueCount;var r=e||{};this.directional=r.directional||!1,this.positionIterator=r.positionIterator||!1,this.subdiv=r.subdiv||1,this.smoothSheet=r.smoothSheet||!1,r.tension?this.tension=r.tension:this.tension=this.polymer.isNucleic()?.5:.9,this.interpolator=new jh(this.subdiv,this.tension)};Vh.prototype.getAtomIterator=function(i,o){var n=this.polymer,t=n.structure,a=n.residueCount,s=0,e=-1,c=[t.getAtomProxy(),t.getAtomProxy(),t.getAtomProxy(),t.getAtomProxy()],u=[new fe.Vector3,new fe.Vector3,new fe.Vector3,new fe.Vector3];var h=t.getAtomProxy(),l=t.getAtomProxy();function r(t){var e=c[s%4];if(e.index=n.getAtomIndexByType(t,i),o&&0<t&&t<a&&"e"===e.sstruc){var r=u[s%4];return h.index=n.getAtomIndexByType(t+1,i),l.index=n.getAtomIndexByType(t-1,i),r.addVectors(h,l).add(e).add(e).multiplyScalar(.25),s+=1,r}return s+=1,e}return{size:a,next:function(){var t=r(e);return e+=1,t},get:r,reset:function(){s=0,e=-1}}},Vh.prototype.getSubdividedColor=function(t){var e=this.subdiv,r=this.polymer,i=(r.residueCount-1)*e*3+3;r.isCyclic&&(i+=3*e);var o=new Float32Array(i),n=this.getAtomIterator("trace"),a=t||{};a.structure=r.structure;var s=Vt.getScheme(a);return this.interpolator.getColor(n,function(t,e,r){s.atomColorToArray(t,e,r)},o,0,r.isCyclic),{color:o}},Vh.prototype.getSubdividedPicking=function(){var t=this.subdiv,e=this.polymer,r=(e.residueCount-1)*t+1;e.isCyclic&&(r+=t);var i=e.structure,o=this.getAtomIterator("trace"),n=new Float32Array(r);return this.interpolator.getPicking(o,function(t){return t.index},n,0,e.isCyclic),{picking:new on(n,i)}},Vh.prototype.getSubdividedPosition=function(){return{position:this.getPosition()}},Vh.prototype.getSubdividedOrientation=function(){var t=this.getTangent(),e=this.getNormals(t);return{tangent:t,normal:e.normal,binormal:e.binormal}},Vh.prototype.getSubdividedSize=function(t){var e=this.subdiv,r=this.polymer,i=(r.residueCount-1)*e+1;r.isCyclic&&(i+=e);var o=new Float32Array(i),n=this.getAtomIterator("trace"),a=new Ea(t);return this.interpolator.getSize(n,function(t){return a.atomRadius(t)},o,0,r.isCyclic),{size:o}},Vh.prototype.getPosition=function(){var t=this.subdiv,e=this.polymer,r=(e.residueCount-1)*t*3+3;e.isCyclic&&(r+=3*t);var i=new Float32Array(r),o=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getPosition(o,i,0,e.isCyclic),i},Vh.prototype.getTangent=function(){var t=this.subdiv,e=this.polymer,r=(this.size-1)*t*3+3;e.isCyclic&&(r+=3*t);var i=new Float32Array(r),o=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getTangent(o,i,0,e.isCyclic),i},Vh.prototype.getNormals=function(t){var e=this.subdiv,r=this.polymer,i=r.isProtein(),o=this.size,n=(o-1)*e*3+3;r.isCyclic&&(n+=3*e);var a=new Float32Array(n),s=new Float32Array(n);if(this.directional&&!this.polymer.isCg()){var c=this.getAtomIterator("direction1"),u=this.getAtomIterator("direction2");this.interpolator.getNormalDir(c,u,t,a,s,0,r.isCyclic,i)}else this.interpolator.getNormal(o,t,a,s,0,r.isCyclic);return{normal:a,binormal:s}};var Gh=new fe.Vector3,Uh=new fe.Vector3,Hh=Object.assign({radialSegments:4,capped:!1,aspectRatio:1},na);var Wh=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,function(t,e){void 0===e&&(e={});var r=st(e.radialSegments,4),i=st(e.capped,!1),o=i?r:0,n=i?r-2:0,a=t.position.length/3,s=a*r*3+2*o*3,c=2*(a-1)*r*3+2*n*3;return{position:new Float32Array(s),color:new Float32Array(s),index:S(c,s/3),normal:new Float32Array(s),picking:t.picking}}(t,e),e),this.capVertices=this.parameters.capped?this.parameters.radialSegments:0,this.capTriangles=this.parameters.capped?this.parameters.radialSegments-2:0,this.size2=t.position.length/3,t.primitiveId=Fe(this.size2),this.setAttributes(t),this.makeIndex()}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return Hh},t.prototype.setAttributes=function(t){void 0===t&&(t={});var e,r,i,o,n,a,s,c,u,h,l,p,d,f=this.parameters.aspectRatio,m=this.size2,g=m-1,y=this.parameters.radialSegments,v=this.geometry.attributes;t.position&&(e=t.position,r=t.normal,i=t.binormal,o=t.tangent,a=t.size,c=v.position.array,h=v.normal.array,v.position.needsUpdate=!0,v.normal.needsUpdate=!0),t.color&&(n=t.color,u=v.color.array,v.color.needsUpdate=!0),t.primitiveId&&(s=t.primitiveId,l=v.primitiveId.array,v.primitiveId.needsUpdate=!0);var b=0,x=0,_=0,w=0,A=0,S=0,C=0,P=0,I=0,O=0,k=[],M=[],B=[],T=[],D=[],R=[];if(e)for(var F=0;F<y;++F){var E=F/y*2*Math.PI;k[F]=f*Math.cos(E),M[F]=Math.sin(E),B[F]=f*Math.cos(E-.01),T[F]=Math.sin(E-.01),D[F]=f*Math.cos(E+.01),R[F]=Math.sin(E+.01)}for(var $=0;$<m;++$){d=(p=3*$)*y,e&&o&&r&&i&&a&&(Gh.set(o[p],o[p+1],o[p+2]),x=r[p],_=r[p+1],w=r[p+2],A=i[p],S=i[p+1],C=i[p+2],P=e[p],I=e[p+1],O=e[p+2],b=a[$]);for(var L=0;L<y;++L){var N=d+3*L;if(e){var z=-b*k[L],j=b*M[L],V=-b*B[L],G=b*T[L],U=-b*D[L],H=b*R[L];c[N]=P+z*x+j*A,c[N+1]=I+z*_+j*S,c[N+2]=O+z*w+j*C,Uh.set(U*x+H*A-(V*x+G*A),U*_+H*S-(V*_+G*S),U*w+H*C-(V*w+G*C)).cross(Gh),h[N]=Uh.x,h[N+1]=Uh.y,h[N+2]=Uh.z}n&&(u[N]=n[p],u[N+1]=n[p+1],u[N+2]=n[p+2]),s&&(l[$*y+L]=s[$])}}d=3*m*y;for(var W=p=0;W<y;++W){var q=p+3*W,X=d+3*W;e&&o&&(c[X]=c[q],c[X+1]=c[q+1],c[X+2]=c[q+2],h[X]=o[p],h[X+1]=o[p+1],h[X+2]=o[p+2]),n&&(u[X]=u[q],u[X+1]=u[q+1],u[X+2]=u[q+2]),s&&(l[m*y+W]=l[0+W])}p=3*(m-1)*y,d=3*(m+1)*y;for(var Y=0;Y<y;++Y){var K=p+3*Y,Z=d+3*Y;e&&o&&(c[Z]=c[K],c[Z+1]=c[K+1],c[Z+2]=c[K+2],h[Z]=o[3*g],h[Z+1]=o[3*g+1],h[Z+2]=o[3*g+2]),n&&(u[Z]=u[K],u[Z+1]=u[K+1],u[Z+2]=u[K+2]),s&&(l[(m+1)*y+Y]=l[(m-1)*y+Y])}},t.prototype.makeIndex=function(){for(var t,e,r=this.geometry.getIndex().array,i=this.size2,o=i-1,n=this.capTriangles,a=this.parameters.radialSegments,s=this.parameters.radialSegments+1,c=0;c<o;++c)for(var u=c*a*3*2,h=c*a,l=(c+1)*a,p=0;p<a;++p)r[e=u+3*p*2]=h+p,r[e+1]=h+(p+1)%a,r[e+2]=l+p,r[e+3]=l+p,r[e+4]=h+(p+1)%a,r[e+5]=l+(p+1)%a;for(var d=[0],f=1;f<s/2;++f)d.push(f),a-f!==f&&d.push(a-f);e=o*a*3*2,t=i*a;for(var m=0;m<d.length-2;++m)m%2==0?(r[e+3*m+0]=t+d[m+0],r[e+3*m+1]=t+d[m+1],r[e+3*m+2]=t+d[m+2]):(r[e+3*m+0]=t+d[m+2],r[e+3*m+1]=t+d[m+1],r[e+3*m+2]=t+d[m+0]);e=o*a*3*2+3*n,t=i*a+a;for(var g=0;g<d.length-2;++g)g%2==0?(r[e+3*g+0]=t+d[g+0],r[e+3*g+1]=t+d[g+1],r[e+3*g+2]=t+d[g+2]):(r[e+3*g+0]=t+d[g+2],r[e+3*g+1]=t+d[g+1],r[e+3*g+2]=t+d[g+0])},Object.defineProperties(t.prototype,e),t}(ua),qh=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="cartoon",this.parameters=Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1,rebuild:!0},subdiv:{type:"integer",max:50,min:1,rebuild:!0},radialSegments:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean",rebuild:!0},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"chainname"),e.colorScale=st(e.colorScale,"RdYlBu"),e.radiusType=st(e.radiusType,"sstruc"),e.radiusScale=st(e.radiusScale,.7),e.useInteriorColor=st(e.useInteriorColor,!0),this.aspectRatio=st(e.aspectRatio,5),this.tension=st(e.tension,NaN),this.capped=st(e.capped,!0),this.smoothSheet=st(e.smoothSheet,!1),"low"===e.quality?(this.subdiv=3,this.radialSegments=6):"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=st(e.subdiv,6),i.prototype.init.call(this,e)},t.prototype.getSplineParams=function(t){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:1!==this.aspectRatio,smoothSheet:this.smoothSheet},t)},t.prototype.getSpline=function(t){return new Vh(t,this.getSplineParams())},t.prototype.getAspectRatio=function(t){return t.isCg()?1:this.aspectRatio},t.prototype.getAtomRadius=function(t){return t.isTrace()?i.prototype.getAtomRadius.call(this,t):0},t.prototype.createData=function(t){var c=this,u=[],h=[];return this.structure.eachPolymer(function(t){if(!(t.residueCount<4)){h.push(t);var e=c.getSpline(t),r=c.getAspectRatio(t),i=e.getSubdividedPosition(),o=e.getSubdividedOrientation(),n=e.getSubdividedColor(c.getColorParams()),a=e.getSubdividedPicking(),s=e.getSubdividedSize(c.getRadiusParams());u.push(new Wh(Object.assign({},i,o,n,a,s),c.getBufferParams({radialSegments:c.radialSegments,aspectRatio:r,capped:c.capped})))}},t.getSelection()),{bufferList:u,polymerList:h}},t.prototype.updateData=function(t,e){de.Debug&&me.time(this.type+" repr update"),t=t||{};for(var r=0,i=e.polymerList.length;r<i;++r){var o={},n=e.polymerList[r],a=this.getSpline(n),s=this.getAspectRatio(n);if(Object.assign(e.bufferList[r],{aspectRatio:s}),t.position||t.radius){var c=a.getSubdividedPosition(),u=a.getSubdividedOrientation(),h=a.getSubdividedSize(this.getRadiusParams(s));o.position=c.position,o.normal=u.normal,o.binormal=u.binormal,o.tangent=u.tangent,o.size=h.size}if(t.color){var l=a.getSubdividedColor(this.getColorParams());o.color=l.color}if(t.picking){var p=a.getSubdividedPicking();o.picking=p.picking}e.bufferList[r].setAttributes(o)}de.Debug&&me.timeEnd(this.type+" repr update")},t.prototype.setParameters=function(t){var e={};return t&&t.aspectRatio&&(e.radius=!0),t&&t.tension&&(e.position=!0),i.prototype.setParameters.call(this,t,e,!1),this},t}(ah);Ut.add("cartoon",qh);var Xh=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="contact",this.parameters=Object.assign({hydrogenBond:{type:"boolean",rebuild:!0},weakHydrogenBond:{type:"boolean",rebuild:!0},waterHydrogenBond:{type:"boolean",rebuild:!0},backboneHydrogenBond:{type:"boolean",rebuild:!0},hydrophobic:{type:"boolean",rebuild:!0},halogenBond:{type:"boolean",rebuild:!0},ionicInteraction:{type:"boolean",rebuild:!0},metalCoordination:{type:"boolean",rebuild:!0},cationPi:{type:"boolean",rebuild:!0},piStacking:{type:"boolean",rebuild:!0},filterSele:{type:"text",rebuild:!0},labelVisible:{type:"boolean",rebuild:!0},labelFixedSize:{type:"boolean",buffer:"fixedSize"},labelSize:{type:"number",precision:3,max:10,min:.001,rebuild:!0},labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},maxHydrophobicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondSulfurDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondAccAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondDonAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondAccPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxHbondDonPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxPiStackingDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingAngle:{type:"integer",max:180,min:0,rebuild:!0},maxCationPiDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxCationPiOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxIonicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondAngle:{type:"integer",max:180,min:0,rebuild:!0},maxMetalDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},refineSaltBridges:{type:"boolean",rebuild:!0},masterModelIndex:{type:"integer",max:1e3,min:-1,rebuild:!0},lineOfSightDistFactor:{type:"number",precision:1,max:10,min:0,rebuild:!0},radialSegments:!0,disableImpostor:!0},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.radiusSize=st(e.radiusSize,.05),e.useInteriorColor=st(e.useInteriorColor,!0),this.hydrogenBond=st(e.hydrogenBond,!0),this.weakHydrogenBond=st(e.weakHydrogenBond,!1),this.waterHydrogenBond=st(e.waterHydrogenBond,!1),this.backboneHydrogenBond=st(e.backboneHydrogenBond,!1),this.hydrophobic=st(e.hydrophobic,!1),this.halogenBond=st(e.halogenBond,!0),this.ionicInteraction=st(e.ionicInteraction,!0),this.metalCoordination=st(e.metalCoordination,!0),this.cationPi=st(e.cationPi,!0),this.piStacking=st(e.piStacking,!0),this.filterSele=st(e.filterSele,""),this.labelVisible=st(e.labelVisible,!1),this.labelFixedSize=st(e.labelFixedSize,!1),this.labelSize=st(e.labelSize,2),this.labelUnit=st(e.labelUnit,""),this.maxHydrophobicDist=st(e.maxHydrophobicDist,4),this.maxHbondDist=st(e.maxHbondDist,3.5),this.maxHbondSulfurDist=st(e.maxHbondSulfurDist,4.1),this.maxHbondAccAngle=st(e.maxHbondAccAngle,45),this.maxHbondDonAngle=st(e.maxHbondDonAngle,45),this.maxHbondAccPlaneAngle=st(e.maxHbondAccPlaneAngle,90),this.maxHbondDonPlaneAngle=st(e.maxHbondDonPlaneAngle,30),this.maxPiStackingDist=st(e.maxPiStackingDist,5.5),this.maxPiStackingOffset=st(e.maxPiStackingOffset,2),this.maxPiStackingAngle=st(e.maxPiStackingAngle,30),this.maxCationPiDist=st(e.maxCationPiDist,6),this.maxCationPiOffset=st(e.maxCationPiOffset,2),this.maxIonicDist=st(e.maxIonicDist,5),this.maxHalogenBondDist=st(e.maxHalogenBondDist,3.5),this.maxHalogenBondAngle=st(e.maxHalogenBondAngle,30),this.maxMetalDist=st(e.maxMetalDist,3),this.refineSaltBridges=st(e.refineSaltBridges,!0),this.masterModelIndex=st(e.masterModelIndex,-1),this.lineOfSightDistFactor=st(e.lineOfSightDistFactor,1),i.prototype.init.call(this,e)},t.prototype.getAtomRadius=function(){return 0},t.prototype.getContactData=function(t){var e={maxHydrophobicDist:this.maxHydrophobicDist,maxHbondDist:this.maxHbondDist,maxHbondSulfurDist:this.maxHbondSulfurDist,maxHbondAccAngle:this.maxHbondAccAngle,maxHbondDonAngle:this.maxHbondDonAngle,maxHbondAccPlaneAngle:this.maxHbondAccPlaneAngle,maxHbondDonPlaneAngle:this.maxHbondDonPlaneAngle,maxPiStackingDist:this.maxPiStackingDist,maxPiStackingOffset:this.maxPiStackingOffset,maxPiStackingAngle:this.maxPiStackingAngle,maxCationPiDist:this.maxCationPiDist,maxCationPiOffset:this.maxCationPiOffset,maxIonicDist:this.maxIonicDist,maxHalogenBondDist:this.maxHalogenBondDist,maxHalogenBondAngle:this.maxHalogenBondAngle,maxMetalDist:this.maxMetalDist,refineSaltBridges:this.refineSaltBridges,masterModelIndex:this.masterModelIndex,lineOfSightDistFactor:this.lineOfSightDistFactor},r={hydrogenBond:this.hydrogenBond,weakHydrogenBond:this.weakHydrogenBond,waterHydrogenBond:this.waterHydrogenBond,backboneHydrogenBond:this.backboneHydrogenBond,hydrophobic:this.hydrophobic,halogenBond:this.halogenBond,ionicInteraction:this.ionicInteraction,metalCoordination:this.metalCoordination,cationPi:this.cationPi,piStacking:this.piStacking,radius:this.radiusSize*this.radiusScale,filterSele:this.filterSele};return Zo(Xo(t,e),t,r)},t.prototype.createData=function(t){var e=this.getContactData(t),r=[new Eh(Si(e),this.getBufferParams({sphereDetail:1,dullInterior:!0,disableImpostor:this.disableImpostor}))];if(this.labelVisible){var i={size:this.labelSize,unit:this.labelUnit};r.push(new vh(function(t,e){for(var r=Be(t.position1,t.position2),i=[],o=Te(t.position1,t.position2),n=o.length/3,a=0;a<n;a++){var s=3*a,c=Math.sqrt(Math.pow(o[s],2)+Math.pow(o[s+1],2)+Math.pow(o[s+2],2));switch(e.unit){case"angstrom":i[a]=c.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":i[a]=(c/10).toFixed(2)+" nm";break;default:i[a]=c.toFixed(2)}}return{position:r,size:De(r.length/3,e.size),color:t.color,text:i}}(e,i),{fixedSize:this.labelFixedSize}))}return{bufferList:r}},t}(ah);Ut.add("contact",Xh);var Yh=function(a){function t(t,e,r){a.call(this,t,e,r),this.type="dihedral",this.parameters=Object.assign({atomQuad:{type:"hidden",rebuild:!0},extendLine:{type:"boolean",rebuild:!0,default:!0},lineVisible:{type:"boolean",default:!0},planeVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(r)}return a&&(t.__proto__=a),((t.prototype=Object.create(a&&a.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.side=st(e.side,"double"),e.opacity=st(e.opacity,.5),this.atomQuad=st(e.atomQuad,[]),this.extendLine=st(e.extendLine,!0),this.lineVisible=st(e.lineVisible,!0),this.planeVisible=st(e.planeVisible,!0),this.sectorVisible=st(e.sectorVisible,!0),a.prototype.init.call(this,e)},t.prototype.createData=function(t){if(t.atomCount&&this.atomQuad.length){var e=function(m,g){void 0===g&&(g={});for(var y=st(g.angleStep,Math.PI/90),t=m.length,e=m.length/12,v=new Float32Array(e),b=new Float32Array(3*e),x=new Array(e),_=new Array(e),w=new Array(e),A=new Array(e),S=new Array(e),C=0,P=0,I=0,O=ci(),k=ci(),M=ci(),B=ci(),T=ci(),D=ci(),R=ci(),F=ci(),E=ci(),$=ci(),L=ci(),N=ci(),z=ci(),j=ci(),V=ci(),G=0,r=function(t){if(di(O,m,t),di(k,m,t+3),di(M,m,t+6),di(B,m,t+9),li(T,O,k),li(D,M,k),0!==mi(D)){li(R,B,M),yi(F,D,.5),pi(E,k,F),vi(T,T),vi(D,D),vi(R,R),li(F,O,E);var e=0<hi(F,D);li(F,B,E);var r=hi(F,D)<0;if(yi(F,D,hi(D,T)),li($,T,F),yi(F,D,hi(D,R)),li(L,R,F),0!==mi($)&&0!==mi(L)){vi($,$),vi(L,L);var i=v[G]=Math.acos(hi($,L));x[G]=(ke*i).toFixed(1)+String.fromCharCode(176),ui(j,$,D),vi(j,j),hi(j,L)<0&&Ai(j,j),uh(F,E,$,j,i/2),fi(F,b,3*G);var o=Math.ceil(i/y),n=o+(g.extendLine?4:2),a=g.extendLine?36:0,s=new Float32Array(3*n),c=new Float32Array(3*n),u=new Float32Array(9*o),h=new Float32Array(a);_[G]=s,w[G]=c,A[G]=u,S[G]=h,g.extendLine&&(e?(li(F,O,M),vi(F,F),yi(N,F,1/hi($,F)),pi(N,N,M)):(yi(N,T,1/hi($,T)),pi(N,N,k)),r?(li(F,B,k),vi(F,F),yi(z,F,1/hi(L,F)),pi(z,z,k)):(yi(z,R,1/hi(L,R)),pi(z,z,M))),pi(V,E,$);var l=0;g.extendLine?(fi(O,s,l),fi(N,c,l),fi(N,s,l+=3),fi(V,c,l),l+=3,fi(N,h,0),fi(V,h,3),fi(e?M:k,h,6),fi(e?M:k,h,9),fi(V,h,12),fi(E,h,15)):(fi(E,s,l),fi(V,c,l),l+=3);for(var p=function(t,e){var r=9*e;fi(E,u,r),fi(V,u,r+3),fi(V,s,l),uh(V,E,$,j,t),fi(V,u,r+6),fi(V,c,l),l+=3},d=0,f=y;f<i;f+=y)p(f,d++);p(i,d++),g.extendLine?(fi(V,s,3*(n-2)),fi(z,c,3*(n-2)),fi(z,s,3*(n-1)),fi(B,c,3*(n-1)),fi(z,h,18),fi(V,h,21),fi(r?k:M,h,24),fi(r?k:M,h,27),fi(V,h,30),fi(E,h,33)):(fi(V,s,l),fi(E,c,l),l+=3),C+=3*n,P+=9*o,I+=a,G+=1}}},i=0;i<t;i+=12)r(i);for(var o=G,n=new Float32Array(C),a=new Float32Array(C),s=new Float32Array(P),c=new Float32Array(I),u=0,h=0,l=0,p=0;p<o;p++){var d=_[p],f=w[p],U=A[p],H=S[p];Le(d,n,0,u,d.length),Le(f,a,0,u,f.length),Le(U,s,0,h,U.length),Le(H,c,0,l,H.length),u+=d.length,h+=U.length,l+=H.length}return{labelPosition:b.subarray(0,3*o),labelText:x.slice(0,o),linePosition1:n,linePosition2:a,planePosition:c,sectorPosition:s}}(ch(t,this.atomQuad),{extendLine:this.extendLine}),r=this.n=e.labelText.length,i=new fe.Color(this.labelColor);this.textBuffer=new vh({position:e.labelPosition,size:De(r,this.labelSize),color:Re(r,i.r,i.g,i.b),text:e.labelText},this.getLabelBufferParams());var o=new fe.Color(this.colorValue);this.lineLength=e.linePosition1.length/3;var n=Re(this.lineLength,o.r,o.g,o.b);return this.lineBuffer=new _h(Pi({position1:e.linePosition1,position2:e.linePosition2,color:n,color2:n}),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.planeLength=e.planePosition.length/3,this.planeBuffer=new ua({position:e.planePosition,color:Re(this.planeLength,o.r,o.g,o.b)},this.getBufferParams({visible:this.planeVisible})),this.sectorLength=e.sectorPosition.length/3,this.sectorBuffer=new ua({position:e.sectorPosition,color:Re(this.sectorLength,o.r,o.g,o.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.lineBuffer,this.planeBuffer,this.sectorBuffer]}}},t.prototype.updateData=function(t,e){a.prototype.updateData.call(this,t,e);var r={},i={},o={};if(t.color){var n=new fe.Color(this.colorValue);Object.assign(r,{color:Re(this.lineLength,n.r,n.g,n.b),color2:Re(this.lineLength,n.r,n.g,n.b)}),Object.assign(i,{color:Re(this.planeLength,n.r,n.g,n.b)}),Object.assign(o,{color:Re(this.sectorLength,n.r,n.g,n.b)})}this.lineBuffer.setAttributes(r),this.planeBuffer.setAttributes(i),this.sectorBuffer.setAttributes(o)},t.prototype.setParameters=function(t){return a.prototype.setParameters.call(this,t,{},!1),!t||void 0===t.lineVisible&&void 0===t.sectorVisible&&void 0===t.planeVisible||this.setVisibility(this.visible),t&&t.lineOpacity&&this.lineBuffer.setParameters({opacity:t.lineOpacity}),t&&void 0!==t.opacity&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),t&&t.linewidth&&this.lineBuffer.setParameters({linewidth:t.linewidth}),this},t.prototype.setVisibility=function(t,e){return a.prototype.setVisibility.call(this,t,!0),this.lineBuffer&&this.lineBuffer.setVisibility(this.lineVisible&&this.visible),this.planeBuffer&&this.planeBuffer.setVisibility(this.planeVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),e||this.viewer.requestRender(),this},t}(sh);Ut.add("dihedral",Yh);var Kh=3,Zh=3;function Qh(t,e){function r(t,e){return e in t}var i=Object.assign({},t);for(var o in i)r(i,o)&&r(e,o)&&(i[o]=st(e[o],i[o]));return i}function Jh(t,e){var r=new fe.Color(t),i=new Float32Array(3*e);return Re(e,r.r,r.g,r.b,i),i}var tl=function(o){function t(t,e,r){o.call(this,t,e,r),this.type="dihedral-histogram",this.parameters=Object.assign({histogramsData:{type:"hidden",rebuild:!0},histogramBinBorderVisible:{type:"boolean",default:!0},scaleBinToSectorArea:{type:"boolean",rebuild:!0,default:!1}},this.parameters),this.init(r)}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.init=function(t){var e=t||{},r=Qh({histogramBinBorderColor:"grey",adjacentBondArrowColor:"black",distantBondArrowColor:"magenta",frontHistogramColor:"green",backHistogramColor:"blue",opaqueMiddleDiscColor:"white"},e);Object.assign(this,r);var i=Qh({histogramsData:[],histogramOpacity:1,opaqueMiddleDiscVisible:!0,opaqueMiddleDiscOpacity:1,histogramBinBorderVisible:!0,histogramBinBorderWidth:1,histogramBinBorderOpacity:.5,bondArrowVisible:!0,bondArrowWidth:2,bondArrowOpacity:1,scaleBinToSectorArea:!1},e);Object.assign(this,i),this.histogramsData.forEach(function(t){var e=Qh(r,t);Object.assign(t,e)}),e.side=st(e.side,"double"),e.opacity=st(e.opacity,.5),e.radiusType=st(e.radiusType,"size"),e.radiusSize=st(e.radiusSize,.15),o.prototype.init.call(this,e)},t.prototype.getHistogramBinBorderBufferParameters=function(){return this.getBufferParams({linewidth:this.histogramBinBorderWidth,visible:this.histogramBinBorderVisible,opacity:this.histogramBinBorderOpacity})},t.prototype.getBondArrowsBufferParameters=function(){return this.getBufferParams({linewidth:this.bondArrowWidth,visible:this.bondArrowVisible,opacity:this.bondArrowOpacity})},t.prototype.getOpaqueMiddleDiscBufferParameters=function(){return this.getBufferParams({visible:this.opaqueMiddleDiscVisible,opacity:this.opaqueMiddleDiscOpacity})},t.prototype.getHistogramBufferParameters=function(){return this.getBufferParams({visible:!0,opacity:this.histogramOpacity,side:"double"})},t.prototype.createData=function(e){if(e.atomCount&&this.histogramsData.length){this.histogramsData.forEach(function(t){return t.atomPositions=ch(e,[t.atomQuad])});var r=this.scaleBinToSectorArea?function(t){return Math.sqrt(t)}:function(t){return t};this.histogramsData.forEach(function(t){return t.histogram360Scaled=t.histogram360.map(r)});for(var t=[],i=0;i<this.histogramsData.length;i++){var o=void 0,n=this.histogramsData[i];3<=n.histogram360.length&&(o=el(n)),void 0!==o&&t.push(o)}return this.frontHistogramBinBordersBuffer=s(t.map(function(t){return t.frontHistogramBinBorders}),this.getHistogramBinBorderBufferParameters()),this.backHistogramBinBordersBuffer=s(t.map(function(t){return t.backHistogramBinBorders}),this.getHistogramBinBorderBufferParameters()),this.adjacentBondArrowsBuffer=s(t.map(function(t){return t.adjacentBondArrows}),this.getBondArrowsBufferParameters()),this.distantBondArrowsBuffer=s(t.map(function(t){return t.distantBondArrows}),this.getBondArrowsBufferParameters()),this.opaqueMiddleDiscBuffer=c(t.map(function(t){return t.opaqueMiddleDisc}),this.getOpaqueMiddleDiscBufferParameters()),this.frontHistogramBuffer=c(t.map(function(t){return t.frontHistogram}),this.getHistogramBufferParameters()),this.backHistogramBuffer=c(t.map(function(t){return t.backHistogram}),this.getHistogramBufferParameters()),{bufferList:[].concat(this.frontHistogramBinBordersBuffer,this.backHistogramBinBordersBuffer,this.adjacentBondArrowsBuffer,this.distantBondArrowsBuffer,this.opaqueMiddleDiscBuffer,this.frontHistogramBuffer,this.backHistogramBuffer)}}function a(t){for(var e=t.map(function(t){return t.length}),r=new Float32Array(Ve(e)),i=0,o=0;o<t.length;o++)r.set(t[o],i),i+=t[o].length;return r}function s(t,e){return new _h({position1:a(t.map(function(t){return t.startPoints})),position2:a(t.map(function(t){return t.endPoints})),color:a(t.map(function(t){return t.startColors})),color2:a(t.map(function(t){return t.endColors}))},e)}function c(t,e){return new ua({position:a(t.map(function(t){return t.triangles})),color:a(t.map(function(t){return t.triangleColors}))},e)}},t.prototype.setParameters=function(t){return o.prototype.setParameters.call(this,t,{},!1),t&&void 0!==t.histogramBinBorderVisible&&this.setVisibility(this.visible),this},t.prototype.setVisibility=function(t,e){return o.prototype.setVisibility.call(this,t,!0),this.frontHistogramBinBordersBuffer&&this.frontHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),this.backHistogramBinBordersBuffer&&this.backHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),e||this.viewer.requestRender(),this},t}(ah);function el(t){for(var e=t.atomPositions,s=t.histogram360Scaled,r=s.length<=180?360:2*s.length,i={triangles:new Float32Array(r*Zh*Kh),triangleColors:Jh(t.opaqueMiddleDiscColor,r*Zh)},o={triangles:new Float32Array(s.length*Zh*Kh),triangleColors:Jh(t.frontHistogramColor,s.length*Zh)},n={triangles:new Float32Array(s.length*Zh*Kh),triangleColors:Jh(t.backHistogramColor,s.length*Zh)},a={startPoints:new Float32Array(s.length*Kh),endPoints:new Float32Array(s.length*Kh),startColors:Jh(t.histogramBinBorderColor,s.length),endColors:Jh(t.histogramBinBorderColor,s.length)},c={startPoints:new Float32Array(s.length*Kh),endPoints:new Float32Array(s.length*Kh),startColors:Jh(t.histogramBinBorderColor,s.length),endColors:Jh(t.histogramBinBorderColor,s.length)},u={startPoints:new Float32Array(2*Kh),endPoints:new Float32Array(2*Kh),startColors:Jh(t.adjacentBondArrowColor,s.length),endColors:Jh(t.adjacentBondArrowColor,s.length)},h={startPoints:new Float32Array(2*Kh),endPoints:new Float32Array(2*Kh),startColors:Jh(t.distantBondArrowColor,s.length),endColors:Jh(t.distantBondArrowColor,s.length)},l=ci(),p=ci(),d=ci(),f=ci(),m=ci(),g=ci(),y=ci(),v=ci(),b=ci(),x=ci(),_=ci(),w=ci(),A=ci(),S=ci(),C=ci(),P=ci(),I=[l,p,d,f],O=0;O<I.length;O++)di(I[O],e,O*Kh);if(li(m,l,p),li(g,d,p),li(v,f,d),0!==mi(g)&&(yi(C,g,.5),pi(b,p,C),vi(m,m),vi(g,g),vi(v,v),Ai(y,g),yi(C,y,hi(y,m)),li(x,m,C),yi(C,g,hi(g,v)),li(_,v,C),0!==mi(x)&&0!==mi(_))){vi(x,x),vi(_,_);var k=Math.acos(hi(x,_));ui(w,y,x),ui(A,g,_),vi(w,w),vi(A,A);var M=k;hi(w,_)<0&&(M=-k),pi(S,b,x);for(var B=Math.max.apply(null,s),T=2*Math.PI/s.length,D=2*Math.PI/r,R=0;R<r;R++){var F=R*Zh*Kh;fi(b,i.triangles,F),uh(S,b,x,w,R*D),fi(S,i.triangles,F+1*Kh),uh(S,b,x,w,(R+1)*D),fi(S,i.triangles,F+2*Kh)}return yi(C,g,-.01),pi(b,b,C),$(o,a,0,x,w),yi(C,g,.02),pi(b,b,C),$(n,c,1,_,A),{opaqueMiddleDisc:i,frontHistogram:o,backHistogram:n,frontHistogramBinBorders:a,backHistogramBinBorders:c,adjacentBondArrows:u,distantBondArrows:h}}function E(t,e,r,i,o){var n=e*Zh*Kh;fi(b,t,n);var a=Number(s[e])/B;yi(C,r,a),yi(P,i,a),uh(S,b,C,P,e*o),fi(S,t,n+1*Kh),uh(S,b,C,P,(e+1)*o),fi(S,t,n+2*Kh)}function $(t,e,r,i,o){Le(b,u.startPoints,0,r*Kh,b.length),uh(C,b,i,o,0+0*T),Le(C,u.endPoints,0,r*Kh,b.length),Le(b,h.startPoints,0,r*Kh,b.length),uh(C,b,i,o,M),Le(C,h.endPoints,0,r*Kh,b.length);for(var n=0;n<s.length;n++)Le(b,e.startPoints,0,3*n,b.length),uh(C,b,i,o,0+T*n),Le(C,e.endPoints,0,3*n,C.length);for(var a=0;a<s.length;a++)E(t.triangles,a,i,o,T)}}Ut.add("dihedral-histogram",tl);var rl=function(n){function t(t,e,r){n.call(this,t,e,r),this.type="distance",this.parameters=Object.assign({radialSegments:!0,openEnded:!0,disableImpostor:!0,labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},useCylinder:{type:"boolean",rebuild:!0},atomPair:{type:"hidden",rebuild:!0}},this.parameters),this.init(r)}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.linewidth=st(e.linewidth,5),e.radiusType=st(e.radiusType,"size"),e.radiusSize=st(e.radiusSize,.2),this.labelUnit=st(e.labelUnit,""),this.useCylinder=st(e.useCylinder,!1),this.atomPair=st(e.atomPair,[]),n.prototype.init.call(this,e)},t.prototype.getDistanceData=function(c,t){var u=this,e=t.length,h=new Array(e),l=new Float32Array(3*e),p=new Ct,d=new Ct,f=new Ga,m=c.getAtomProxy(),g=c.getAtomProxy(),y=0,v=c.getAtomSet();t.forEach(function(t,e){var r=t[0],i=t[1];if("number"==typeof r&&Number.isInteger(r)&&"number"==typeof i&&Number.isInteger(i)){if(!v.get(r)||!v.get(i))return void(y+=1);m.index=r,g.index=i}else{p.setString(r),d.setString(i);var o=c.getAtomIndices(p),n=c.getAtomIndices(d);if(!o.length||!n.length)return void(y+=1);m.index=o[0],g.index=n[0]}f.addBond(m,g,1),e-=y;var a=m.distanceTo(g);switch(u.labelUnit){case"angstrom":h[e]=a.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":h[e]=(a/10).toFixed(2)+" nm";break;default:h[e]=a.toFixed(2)}var s=3*e;l[s+0]=(m.x+g.x)/2,l[s+1]=(m.y+g.y)/2,l[s+2]=(m.z+g.z)/2}),0<y&&(e-=y,l=l.subarray(0,3*e));var r=new Wi(f.count,!0);return{text:h,position:l,bondSet:r,bondStore:f}},t.prototype.getBondData=function(t,e,r){var i=t.getBondData(this.getBondParams(e,r));return i.picking&&(i.picking=new hn(i.picking.array,i.picking.structure,r.bondStore)),i},t.prototype.createData=function(t){if(t.atomCount&&this.atomPair.length){var e=this.atomPair.length,r=new fe.Color(this.labelColor),i=this.getDistanceData(t,this.atomPair);this.textBuffer=new vh({position:i.position,size:De(e,this.labelSize),color:Re(e,r.r,r.g,r.b),text:i.text},this.getLabelBufferParams());var o={bondSet:i.bondSet,bondStore:i.bondStore},n=this.getBondData(t,{position:!0,color:!0,picking:!0,radius:this.useCylinder},o);return this.useCylinder?this.distanceBuffer=new Eh(n,this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})):this.distanceBuffer=new _h(Ci(n),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),{bondSet:i.bondSet,bondStore:i.bondStore,position:i.position,bufferList:[this.textBuffer,this.distanceBuffer]}}},t.prototype.updateData=function(t,e){n.prototype.updateData.call(this,t,e);var r={bondSet:e.bondSet,bondStore:e.bondStore},i=this.getBondData(e.sview,t,r),o={};t&&!t.color||Object.assign(o,{color:i.color,color2:i.color2}),t&&!t.radius||Object.assign(o,{radius:i.radius}),this.distanceBuffer.setAttributes(o)},t.prototype.setParameters=function(t){return n.prototype.setParameters.call(this,t,{},!1),this.useCylinder||(t&&t.lineOpacity&&this.distanceBuffer.setParameters({opacity:t.lineOpacity}),t&&void 0!==t.opacity&&this.distanceBuffer.setParameters({opacity:this.lineOpacity}),t&&t.linewidth&&this.distanceBuffer.setParameters({linewidth:t.linewidth})),this},t}(sh);function il(t){return 2*(t.position.length/3)*3}Ut.add("distance",rl);var ol=Object.assign({scale:1,color:"grey"},na),nl=function(o){function t(t,e){void 0===e&&(e={}),o.call(this,{position:new Float32Array(il(t)),color:new Float32Array(il(t))},e),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag";var r=new fe.Color(this.parameters.color),i=this.geometry.attributes;Re(il(t)/3,r.r,r.g,r.b,i.color.array),this.setAttributes(t)}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return ol},t.prototype.setAttributes=function(t){void 0===t&&(t={});var e,r,i,o=this.geometry.attributes;t.position&&t.vector&&(e=t.position,r=t.vector,i=o.position.array,o.position.needsUpdate=!0);var n=this.size/2,a=this.parameters.scale;if(e&&r)for(var s=0;s<n;s++){var c=2*s*3,u=3*s;i[c+0]=e[u+0],i[c+1]=e[u+1],i[c+2]=e[u+2],i[c+3]=e[u+0]+r[u+0]*a,i[c+4]=e[u+1]+r[u+1]*a,i[c+5]=e[u+2]+r[u+2]*a}},Object.defineProperties(t.prototype,e),t}(sa),al=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="helixorient",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"sstruc"),e.radiusType=st(e.radiusType,"size"),e.radiusSize=st(e.radiusSize,.15),e.radiusScale=st(e.radiusScale,1),e.useInteriorColor=st(e.useInteriorColor,!0),i.prototype.init.call(this,e)},t.prototype.createData=function(t){var a=this,s=[],c=[];return this.structure.eachPolymer(function(t){if(!(t.residueCount<4)){c.push(t);var e=new Xa(t),r=e.getPosition(),i=e.getColor(a.getColorParams()),o=e.getSize(a.getRadiusParams()),n=e.getPicking();s.push(new _c({position:r.center,color:i.color,radius:o.size,picking:n.picking},a.getBufferParams({sphereDetail:a.sphereDetail,disableImpostor:a.disableImpostor,dullInterior:!0})),new nl({position:r.center,vector:r.axis},a.getBufferParams({color:"skyblue",scale:1})),new nl({position:r.center,vector:r.resdir},a.getBufferParams({color:"lightgreen",scale:1})))}},t.getSelection()),{bufferList:s,polymerList:c}},t.prototype.updateData=function(t,e){de.Debug&&me.time(this.type+" repr update"),t=t||{};for(var r=0,i=e.polymerList.length;r<i;++r){var o=3*r,n={},a=e.polymerList[r],s=new Xa(a);if(t.position){var c=s.getPosition();Object.assign(n,{position:c.center}),e.bufferList[o+1].setAttributes({position:c.center,vector:c.axis}),e.bufferList[o+2].setAttributes({position:c.center,vector:c.resdir})}e.bufferList[o].setAttributes(n)}de.Debug&&me.timeEnd(this.type+" repr update")},t}(ah);Ut.add("helixorient",al);var sl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="licorice",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.aspectRatio=1,i.prototype.init.call(this,e)},t}(Lh);Ut.add("licorice",sl),Wt.add("shader/HyperballStickImpostor.vert","\nattribute vec3 mapping;\nattribute float radius;\nattribute float radius2;\nattribute vec3 position1;\nattribute vec3 position2;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform float shrink;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewProjectionMatrixInverse;\nvoid main(){\nvRadius = radius;\nvRadius2 = radius2;\nvec4 spaceposition;\nvec3 position_atom1;\nvec3 position_atom2;\nvec4 vertex_position;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nfloat radius1 = radius;\nposition_atom1 = position1;\nposition_atom2 = position2;\nfloat distance = distance( position_atom1, position_atom2 );\nspaceposition.z = mapping.z * distance;\nif (radius1 > radius2) {\nspaceposition.y = mapping.y * 1.5 * radius1;\nspaceposition.x = mapping.x * 1.5 * radius1;\n} else {\nspaceposition.y = mapping.y * 1.5 * radius2;\nspaceposition.x = mapping.x * 1.5 * radius2;\n}\nspaceposition.w = 1.0;\nvec4 e3 = vec4( 1.0 );\nvec3 e1, e1_temp, e2, e2_temp;\ne3.xyz = normalize(position_atom1-position_atom2);\nif (e3.z == 0.0) { e3.z = 0.0000000000001;}\nif ( (position_atom1.x - position_atom2.x) == 0.0) { position_atom1.x += 0.001;}\nif ( (position_atom1.y - position_atom2.y) == 0.0) { position_atom1.y += 0.001;}\nif ( (position_atom1.z - position_atom2.z) == 0.0) { position_atom1.z += 0.001;}\nvec4 focus = vec4( 1.0 );\nfocus.x = ( position_atom1.x*position_atom1.x - position_atom2.x*position_atom2.x +\n( radius2*radius2 - radius1*radius1 )*e3.x*e3.x/shrink )/(2.0*(position_atom1.x - position_atom2.x));\nfocus.y = ( position_atom1.y*position_atom1.y - position_atom2.y*position_atom2.y +\n( radius2*radius2 - radius1*radius1 )*e3.y*e3.y/shrink )/(2.0*(position_atom1.y - position_atom2.y));\nfocus.z = ( position_atom1.z*position_atom1.z - position_atom2.z*position_atom2.z +\n( radius2*radius2 - radius1*radius1 )*e3.z*e3.z/shrink )/(2.0*(position_atom1.z - position_atom2.z));\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2_temp = e1.yzx * e3.zxy - e1.zxy * e3.yzx;\ne2 = normalize(e2_temp);\nmat3 R= mat3( e1.xyz, e2.xyz, e3.xyz );\nvertex_position.xyz = R * spaceposition.xyz;\nvertex_position.w = 1.0;\nvertex_position.x += (position_atom1.x+position_atom2.x) / 2.0;\nvertex_position.y += (position_atom1.y+position_atom2.y) / 2.0;\nvertex_position.z += (position_atom1.z+position_atom2.z) / 2.0;\ngl_Position = modelViewProjectionMatrix * vertex_position;\nvec4 i_near, i_far;\nvec4 near = gl_Position;\nnear.z = 0.0 ;\nnear = modelViewProjectionMatrixInverse * near;\ni_near = near;\nvec4 far = gl_Position;\nfar.z = far.w ;\ni_far = modelViewProjectionMatrixInverse * far;\nprime1 = vec4( position_atom1 - (position_atom1 - focus.xyz)*shrink, 1.0 );\nprime2 = vec4( position_atom2 - (position_atom2 - focus.xyz)*shrink, 1.0 );\nfloat Rsquare = (radius1*radius1/shrink) - (\n(position_atom1.x - focus.x)*(position_atom1.x - focus.x) +\n(position_atom1.y - focus.y)*(position_atom1.y - focus.y) +\n(position_atom1.z - focus.z)*(position_atom1.z - focus.z)\n);\nfocus.w = Rsquare;\nmatrix_near = mat4( i_near, i_far, focus, e3 );\ngl_Position.z = 1.0;\n}"),Wt.add("shader/HyperballStickImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float shrink;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrixInverseTranspose;\nuniform mat4 projectionMatrix;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat calcClip( vec4 cameraPos ){\nreturn dot( cameraPos, vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nfloat calcClip( vec3 cameraPos ){\nreturn calcClip( vec4( cameraPos, 1.0 ) );\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nstruct Ray {\nvec3 origin ;\nvec3 direction ;\n};\nbool cutoff_plane (vec3 M, vec3 cutoff, vec3 x3){\nfloat a = x3.x;\nfloat b = x3.y;\nfloat c = x3.z;\nfloat d = -x3.x*cutoff.x-x3.y*cutoff.y-x3.z*cutoff.z;\nfloat l = a*M.x+b*M.y+c*M.z+d;\nif (l<0.0) {return true;}\nelse{return false;}\n}\nvec3 isect_surf(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t1 =(-b-sqrt(delta))/a;\nreturn r.origin+t1*r.direction;\n}\nvec3 isect_surf2(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t2 =(-b+sqrt(delta))/a;\nreturn r.origin+t2*r.direction;\n}\nRay primary_ray(vec4 near1, vec4 far1){\nvec3 near=near1.xyz/near1.w;\nvec3 far=far1.xyz/far1.w;\nreturn Ray(near,far-near);\n}\nfloat update_z_buffer(vec3 M, mat4 ModelViewP){\nfloat depth1;\nvec4 Ms=(ModelViewP*vec4(M,1.0));\nreturn depth1=(1.0+Ms.z/Ms.w)/2.0;\n}\nvoid main(){\nfloat radius = max( vRadius, vRadius2 );\nvec4 i_near, i_far, focus;\nvec3 e3, e1, e1_temp, e2;\ni_near = vec4(matrix_near[0][0],matrix_near[0][1],matrix_near[0][2],matrix_near[0][3]);\ni_far = vec4(matrix_near[1][0],matrix_near[1][1],matrix_near[1][2],matrix_near[1][3]);\nfocus = vec4(matrix_near[2][0],matrix_near[2][1],matrix_near[2][2],matrix_near[2][3]);\ne3 = vec3(matrix_near[3][0],matrix_near[3][1],matrix_near[3][2]);\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2 = normalize(cross(e1,e3));\nvec4 equation = focus;\nfloat shrinkfactor = shrink;\nfloat t1 = -1.0/(1.0-shrinkfactor);\nfloat t2 = 1.0/(shrinkfactor);\nvec4 colonne1, colonne2, colonne3, colonne4;\nmat4 mat;\nvec3 equation1 = vec3(t2,t2,t1);\nfloat A1 = - e1.x*equation.x - e1.y*equation.y - e1.z*equation.z;\nfloat A2 = - e2.x*equation.x - e2.y*equation.y - e2.z*equation.z;\nfloat A3 = - e3.x*equation.x - e3.y*equation.y - e3.z*equation.z;\nfloat A11 = equation1.x*e1.x*e1.x + equation1.y*e2.x*e2.x + equation1.z*e3.x*e3.x;\nfloat A21 = equation1.x*e1.x*e1.y + equation1.y*e2.x*e2.y + equation1.z*e3.x*e3.y;\nfloat A31 = equation1.x*e1.x*e1.z + equation1.y*e2.x*e2.z + equation1.z*e3.x*e3.z;\nfloat A41 = equation1.x*e1.x*A1 + equation1.y*e2.x*A2 + equation1.z*e3.x*A3;\nfloat A22 = equation1.x*e1.y*e1.y + equation1.y*e2.y*e2.y + equation1.z*e3.y*e3.y;\nfloat A32 = equation1.x*e1.y*e1.z + equation1.y*e2.y*e2.z + equation1.z*e3.y*e3.z;\nfloat A42 = equation1.x*e1.y*A1 + equation1.y*e2.y*A2 + equation1.z*e3.y*A3;\nfloat A33 = equation1.x*e1.z*e1.z + equation1.y*e2.z*e2.z + equation1.z*e3.z*e3.z;\nfloat A43 = equation1.x*e1.z*A1 + equation1.y*e2.z*A2 + equation1.z*e3.z*A3;\nfloat A44 = equation1.x*A1*A1 + equation1.y*A2*A2 + equation1.z*A3*A3 - equation.w;\ncolonne1 = vec4(A11,A21,A31,A41);\ncolonne2 = vec4(A21,A22,A32,A42);\ncolonne3 = vec4(A31,A32,A33,A43);\ncolonne4 = vec4(A41,A42,A43,A44);\nmat = mat4(colonne1,colonne2,colonne3,colonne4);\nRay ray = primary_ray(i_near,i_far) ;\nvec3 M;\nM = isect_surf(ray, mat);\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nvec4 M1 = vec4(M,1.0);\nvec4 M2 = mat*M1;\nvec3 _normal = ( modelViewMatrixInverseTranspose * M2 ).xyz;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\n#ifdef NEAR_CLIP\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 ){\nM = isect_surf2(ray, mat);\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / radius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix);\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#endif\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\nfloat distance_ratio = ((M.x-prime2.x)*e3.x + (M.y-prime2.y)*e3.y +(M.z-prime2.z)*e3.z) /\ndistance(prime2.xyz,prime1.xyz);\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -( modelViewMatrix * vec4( M, 1.0 ) ).xyz;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distance_ratio>0.5 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var cl=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]),ul=new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]),hl=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,"v3",t,e)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return e.mapping.get=function(){return cl},e.mappingIndices.get=function(){return ul},e.mappingIndicesSize.get=function(){return 36},e.mappingSize.get=function(){return 8},e.mappingItemSize.get=function(){return 3},Object.defineProperties(t.prototype,e),t}(gc),ll=Object.assign({shrink:.14},na),pl=Object.assign({shrink:{uniform:!0}},aa),dl=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e),this.parameterTypes=pl,this.isImpostor=!0,this.vertexShader="HyperballStickImpostor.vert",this.fragmentShader="HyperballStickImpostor.frag",this.addUniforms({modelViewProjectionMatrix:{value:new fe.Matrix4},modelViewProjectionMatrixInverse:{value:new fe.Matrix4},modelViewMatrixInverseTranspose:{value:new fe.Matrix4},shrink:{value:this.parameters.shrink}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return ll},Object.defineProperties(t.prototype,e),t}(hl),fl=(Object.assign({disableImpostor:!1},Ih,ll),function(t,e){return void 0===e&&(e={}),!$t||e&&e.disableImpostor?(t.radius=function(t,e){for(var r=t.length,i=new Float32Array(r),o=0;o<r;o++)i[o]=Math.min(t[o],e[o]);return i}(t.radius,t.radius2),new kh(t,e)):new dl(t,e)}),ml=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="hyperball",this.parameters=Object.assign({shrink:{type:"number",precision:3,max:1,min:.001,buffer:!0}},this.parameters,{multipleBond:null,bondSpacing:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.radiusScale=st(e.radiusScale,.2),e.radiusType=st(e.radiusType,"vdw"),e.useInteriorColor=st(e.useInteriorColor,!0),this.shrink=st(e.shrink,.12),i.prototype.init.call(this,e)},t.prototype.getBondParams=function(t,e){return t&&!t.radius||(e=Object.assign({radius2:!0},e)),i.prototype.getBondParams.call(this,t,e)},t.prototype.createData=function(t){var e=new _c(t.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));return this.__center=new Float32Array(3*t.bondCount),{bufferList:[e,new fl(t.getBondData(this.getBondParams()),this.getBufferParams({shrink:this.shrink,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))]}},t.prototype.updateData=function(t,e){var r=e.sview.getAtomData(this.getAtomParams()),i=e.sview.getBondData(this.getBondParams()),o={},n={};if(!t||t.position){Object.assign(o,{position:r.position});var a=i.position1,s=i.position2;Object.assign(n,{position:Be(a,s,this.__center),position1:a,position2:s})}t&&!t.color||(Object.assign(o,{color:r.color}),Object.assign(n,{color:i.color,color2:i.color2})),t&&!t.radius||(Object.assign(o,{radius:r.radius}),Object.assign(n,{radius:i.radius,radius2:i.radius2})),e.bufferList[0].setAttributes(o),e.bufferList[1].setAttributes(n)},t}(sl);Ut.add("hyperball",ml);var gl=function(t,e,r){void 0===e&&(e={}),void 0===r&&(r=""),this.type=t,this.text=e,this.format=r};gl.prototype.atomLabel=function(t){var e;switch(this.type){case"atomname":e=t.atomname;break;case"atomindex":e=""+t.index;break;case"occupancy":e=t.occupancy.toFixed(2);break;case"bfactor":e=t.bfactor.toFixed(2);break;case"serial":e=""+t.serial;break;case"element":e=t.element;break;case"atom":e=t.atomname+"|"+t.index;break;case"resname":e=t.resname;break;case"resno":e=""+t.resno;break;case"res":e=""+(fo[t.resname.toUpperCase()]||t.resname)+t.resno;break;case"residue":var r=fo[t.resname.toUpperCase()];e=r&&!t.inscode?""+r+t.resno:"["+t.resname+"]"+t.resno+t.inscode;break;case"text":e=this.text[t.index];break;case"format":e=a.sprintf(this.format,t);break;default:e=t.qualifiedName()}return void 0===e?"":e},gl.types={"":"",atomname:"atom name",atomindex:"atom index",occupancy:"occupancy",bfactor:"b-factor",serial:"serial",element:"element",atom:"atom name + index",resname:"residue name",resno:"residue no",res:"one letter code + no",residue:"[residue name] + no + inscode",text:"text",format:"format",qualified:"qualified name"};var yl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="label",this.parameters=Object.assign({labelType:{type:"select",options:gl.types,rebuild:!0},labelText:{type:"hidden",rebuild:!0},labelFormat:{type:"text",rebuild:!0},labelGrouping:{type:"select",options:{atom:"atom",residue:"residue"},rebuild:!0},fontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:!0},fontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:!0},fontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:!0},xOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},yOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},zOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},attachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},showBorder:{type:"boolean",buffer:!0},borderColor:{type:"color",buffer:!0},borderWidth:{type:"number",precision:2,max:.3,min:0,buffer:!0},showBackground:{type:"boolean",rebuild:!0},backgroundColor:{type:"color",buffer:!0},backgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},backgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:!0},fixedSize:{type:"boolean",buffer:!0}},this.parameters,{side:null,flatShaded:null,wireframe:null,linewidth:null,roughness:null,metalness:null,diffuse:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};this.labelType=st(e.labelType,"res"),this.labelText=st(e.labelText,{}),this.labelFormat=st(e.labelFormat,""),this.labelGrouping=st(e.labelGrouping,"atom"),this.fontFamily=st(e.fontFamily,"sans-serif"),this.fontStyle=st(e.fontStyle,"normal"),this.fontWeight=st(e.fontWeight,"bold"),this.xOffset=st(e.xOffset,0),this.yOffset=st(e.yOffset,0),this.zOffset=st(e.zOffset,.5),this.attachment=st(e.attachment,"bottom-left"),this.showBorder=st(e.showBorder,!1),this.borderColor=st(e.borderColor,"lightgrey"),this.borderWidth=st(e.borderWidth,.15),this.showBackground=st(e.showBackground,!1),this.backgroundColor=st(e.backgroundColor,"lightgrey"),this.backgroundMargin=st(e.backgroundMargin,.5),this.backgroundOpacity=st(e.backgroundOpacity,1),this.fixedSize=st(e.fixedSize,!1),i.prototype.init.call(this,e)},t.prototype.getTextData=function(t,r){var e,i,o,n,a,s,c,u=this.getAtomParams(r),h=new gl(this.labelType,this.labelText,this.labelFormat);if("atom"===this.labelGrouping){var l=t.getAtomData(u);e=l.position,i=l.radius,o=l.color,r&&!r.text||(n=[],t.eachAtom(function(t){return n.push(h.atomLabel(t))}))}else if("residue"===this.labelGrouping){r&&!r.position||(a=[]),r&&!r.color||(c=[]),r&&!r.radius||(s=[]),r&&!r.text||(n=[]),u.colorParams&&(u.colorParams.structure=t.getStructure());var p=Vt.getScheme(u.colorParams),d=new Ea(u.radiusParams),f=t.getAtomProxy(),m=0;t.eachResidue(function(t){var e=3*m;t.isProtein()||t.isNucleic()?(f.index=t.traceAtomIndex,r&&!r.position||f.positionToArray(a,e)):(f.index=t.atomOffset,r&&!r.position||t.positionToArray(a,e)),r&&!r.color||p.atomColorToArray(f,c,e),r&&!r.radius||(s[m]=d.atomRadius(f)),r&&!r.text||n.push(h.atomLabel(f)),++m}),r&&!r.position||(e=new Float32Array(a)),r&&!r.color||(o=new Float32Array(c)),r&&!r.radius||(i=new Float32Array(s))}return{position:e,size:i,color:o,text:n}},t.prototype.createData=function(t){return{bufferList:[new vh(this.getTextData(t,{position:!0,color:!0,radius:!0,text:!0}),this.getBufferParams({fontFamily:this.fontFamily,fontStyle:this.fontStyle,fontWeight:this.fontWeight,xOffset:this.xOffset,yOffset:this.yOffset,zOffset:this.zOffset,attachment:this.attachment,showBorder:this.showBorder,borderColor:this.borderColor,borderWidth:this.borderWidth,showBackground:this.showBackground,backgroundColor:this.backgroundColor,backgroundMargin:this.backgroundMargin,backgroundOpacity:this.backgroundOpacity,fixedSize:this.fixedSize}))]}},t.prototype.updateData=function(t,e){e.bufferList[0].setAttributes(this.getTextData(e.sview,t))},t.prototype.getAtomRadius=function(){return 0},t}(ah);Ut.add("label",yl);var vl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="line",this.parameters=Object.assign({multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0},lines:{type:"boolean",rebuild:!0},crosses:{type:"select",rebuild:!0,options:{off:"off",lone:"lone",all:"all"}},crossSize:{type:"number",precision:2,max:2,min:.1}},this.parameters,{flatShaded:null,side:null,wireframe:null,roughness:null,metalness:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};this.multipleBond=st(e.multipleBond,"off"),this.bondSpacing=st(e.bondSpacing,1),this.linewidth=st(e.linewidth,2),this.lines=st(e.lines,!0),this.crosses=st(e.crosses,"lone"),this.crossSize=st(e.crossSize,.4),i.prototype.init.call(this,e)},t.prototype.getAtomRadius=function(t){return.1},t.prototype.getBondParams=function(t,e){return e=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,radiusParams:{type:"size",size:.1,scale:1}},e),i.prototype.getBondParams.call(this,t,e)},t.prototype._crossData=function(t,e){if(!t||t.position||t.color){var r,i,o,n,a={};"lone"===this.crosses&&Object.assign(a,{atomSet:(r=e,i=r.getAtomSet(),o=r.getBondSet(),n=r.getBondProxy(),o.forEach(function(t){n.index=t,i.clear(n.atomIndex1),i.clear(n.atomIndex2)}),i)});var s=e.getAtomData(this.getAtomParams(t,a)),c={},u=s.position,h=s.color,l=s.picking,p=(u||h).length,d=3*p,f=new Float32Array(0),m=new Float32Array(0),g=new Float32Array(0),y=new Float32Array(0),v=0,b=new Float32Array(0);t&&!t.position||(f=c.position1=new Float32Array(d),m=c.position2=new Float32Array(d),v=this.crossSize/2),t&&!t.color||(g=c.color=new Float32Array(d),y=c.color2=new Float32Array(d)),t&&!t.picking||(b=new Float32Array(3*s.picking.array.length));for(var x=0;x<p;x++){var _=3*x,w=3*_;if(!t||t.position){var A=u[_],S=u[_+1],C=u[_+2];f[w]=A-v,f[w+1]=S,f[w+2]=C,m[w]=A+v,m[w+1]=S,m[w+2]=C,f[w+3]=A,f[w+4]=S-v,f[w+5]=C,m[w+3]=A,m[w+4]=S+v,m[w+5]=C,f[w+6]=A,f[w+7]=S,f[w+8]=C-v,m[w+6]=A,m[w+7]=S,m[w+8]=C+v}if(!t||t.color)for(var P=w+9,I=w;I<P;I+=3)g[I]=y[I]=h[_],g[I+1]=y[I+1]=h[_+1],g[I+2]=y[I+2]=h[_+2];t&&!t.picking||(b[_]=b[_+1]=b[_+2]=l.array[x])}return t&&!t.picking||(c.picking=new on(b,l.structure)),c}},t.prototype.createData=function(t){var e={position:!0,color:!0,picking:!0},r=[];if(this.lines){var i=t.getBondData(this.getBondParams(e)),o=new _h(i,this.getBufferParams({linewidth:this.linewidth}));r.push(o)}if("off"!==this.crosses){var n=new _h(this._crossData(e,t),this.getBufferParams({linewidth:this.linewidth}));r.push(n)}return{bufferList:r}},t.prototype.updateData=function(t,e){var r=0;if(this.lines){var i=e.sview.getBondData(this.getBondParams(t)),o={};t&&!t.position||Object.assign(o,{position1:i.position1,position2:i.position2}),t&&!t.color||Object.assign(o,{color:i.color,color2:i.color2}),e.bufferList[r++].setAttributes(o)}if("off"!==this.crosses){var n=this._crossData(t,e.sview),a={};t&&!t.position||Object.assign(a,{position1:n.position1,position2:n.position2}),t&&!t.color||Object.assign(a,{color:n.color,color2:n.color2}),e.bufferList[r++].setAttributes(a)}},t.prototype.setParameters=function(t){var e={};return t&&(t.bondSpacing||t.crossSize)&&Object.assign(e,{position:!0}),i.prototype.setParameters.call(this,t,e,!1),this},t}(ah);function bl(t,i,o,e,s){var c=new(e=e||Int32Array)(t*i*o*(s=s||1));function u(t,e,r){return((t*i+e)*o+r)*s}return{data:c,index:u,set:function(t,e,r){for(var i=[],o=arguments.length-3;0<o--;)i[o]=arguments[o+3];for(var n=u(t,e,r),a=0;a<s;++a)c[n+a]=i[a]},toArray:function(t,e,r,i,o){void 0===i&&(i=[]),void 0===o&&(o=0);for(var n=u(t,e,r),a=0;a<s;++a)i[o+a]=c[n+a]},fromArray:function(t,e,r,i,o){void 0===o&&(o=0);for(var n=u(t,e,r),a=0;a<s;++a)c[n+a]=i[o+a]},copy:function(t){c.set(t.data)}}}function xl(k,M,c){var p=Yn(M),t=oi(k);0===k.length&&(t[0].set([0,0,0]),t[1].set([0,0,0]));var d,B,g,T,D,R,u,F,E,$,y,L,N,w,z,h=t[0],l=t[1];var j=1,I=2,A=4,S=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];function f(t){var e,r,i,o,n,a,s,c,u,h;for(var l in p)if(e=parseFloat(l),!E[l]){for(a=(s=t?(e+d)*B+.5:e*B+.5)*s,c=Math.floor(s)+1,u=new Int32Array(c*c),r=h=0;r<c;++r)for(i=0;i<c;++i)a<(o=r*r+i*i)?u[h]=-1:(n=Math.sqrt(a-o),u[h]=Math.floor(n)),++h;$[l]=c,E[l]=u}}function m(t){var e,r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b=3*t,x=t;e=Math.floor(.5+B*(k[b]+F[0])),r=Math.floor(.5+B*(k[b+1]+F[1])),i=Math.floor(.5+B*(k[b+2]+F[2]));var _,w=M[x],A=E[w],S=0,C=D*R,P=$[w];for(h=0;h<P;++h)for(l=0;l<P;++l){if(-1!==(_=A[S]))for(g=-1;g<2;++g)for(y=-1;y<2;++y)for(v=-1;v<2;++v)if(0!==g&&0!==y&&0!==v)for(s=g*h,u=v*l,p=0;p<=_;++p)if(f=r+(c=p*y),m=i+u,!((d=e+s)<0||f<0||m<0||T<=d||D<=f||R<=m)){var I=d*C+f*R+m;if(L)if(N[I]&j){if(N[I]&j){var O=z[I];O!==b&&s*s+c*c+u*u<(o=e+s-Math.floor(.5+B*(k[O]+F[0])))*o+(n=r+c-Math.floor(.5+B*(k[O+1]+F[1])))*n+(a=i+u-Math.floor(.5+B*(k[O+2]+F[2])))*a&&(z[I]=t)}}else N[I]|=j,z[I]=t;else N[I]|=j}S++}}function v(t){var e,r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b,x=3*t,_=t,w=0;e=Math.floor(.5+B*(k[x]+F[0])),r=Math.floor(.5+B*(k[x+1]+F[1])),i=Math.floor(.5+B*(k[x+2]+F[2]));var A=M[_],S=D*R;for(d=0,b=$[A];d<b;++d)for(f=0;f<b;++f){if(-1!==E[A][w])for(g=-1;g<2;++g)for(y=-1;y<2;++y)for(v=-1;v<2;++v)if(0!==g&&0!==y&&0!==v)for(s=g*d,u=v*f,m=0;m<=E[A][w];++m)if(l=r+(c=m*y),p=i+u,!((h=e+s)<0||l<0||p<0||T<=h||D<=l||R<=p)){var C=h*S+l*R+p;if(N[C]&I){if(L){var P=z[C];s*s+c*c+u*u<(o=Math.floor(.5+B*(k[P]+F[0])))*o+(n=Math.floor(.5+B*(k[P+1]+F[1])))*n+(a=Math.floor(.5+B*(k[P+2]+F[2])))*a&&(z[C]=t)}}else N[C]|=I,L&&(z[C]=t)}w++}}function b(t,e,r,i){var o,n,a,s,c,u,h,l,p,d,f,m,g=new Uint16Array(3),y=0;if(0===r)return y;var v=-1,b=-1,x=-1,_=D*R;for(h=0,p=r;h<p;h+=3)for(o=t[h],n=t[h+1],a=t[h+2],e.toArray(o,n,a,g),l=0;l<6;++l)v=o+(m=S[l])[0],b=n+m[1],x=a+m[2],v<T&&-1<v&&b<D&&-1<b&&x<R&&-1<x&&(N[f=v*_+R*b+x]&j&&!(N[f]&I)?(e.fromArray(v,b,x,g),d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u,w[f]=d,N[f]|=I,N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3):N[f]&j&&N[f]&I&&(d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u)<w[f]&&(e.fromArray(v,b,x,g),w[f]=d,N[f]&A||(N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3)));for(h=0,p=r;h<p;h+=3)for(o=t[h],n=t[h+1],a=t[h+2],e.toArray(o,n,a,g),l=6;l<18;l++)v=o+(m=S[l])[0],b=n+m[1],x=a+m[2],v<T&&-1<v&&b<D&&-1<b&&x<R&&-1<x&&(N[f=v*_+R*b+x]&j&&!(N[f]&I)?(e.fromArray(v,b,x,g),d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u,w[f]=d,N[f]|=I,N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3):N[f]&j&&N[f]&I&&(d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u)<w[f]&&(e.fromArray(v,b,x,g),w[f]=d,N[f]&A||(N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3)));for(h=0,p=r;h<p;h+=3)for(o=t[h],n=t[h+1],a=t[h+2],e.toArray(o,n,a,g),l=18;l<26;l++)v=o+(m=S[l])[0],b=n+m[1],x=a+m[2],v<T&&-1<v&&b<D&&-1<b&&x<R&&-1<x&&(N[f=v*_+R*b+x]&j&&!(N[f]&I)?(e.fromArray(v,b,x,g),d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u,w[f]=d,N[f]|=I,N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3):N[f]&j&&N[f]&I&&(d=(s=v-g[0])*s+(c=b-g[1])*c+(u=x-g[2])*u)<w[f]&&(e.fromArray(v,b,x,g),w[f]=d,N[f]&A||(N[f]|=A,i[y]=v,i[y+1]=b,i[y+2]=x,y+=3)));return y}this.getVolume=function(t,e,r,i,o){console.time("EDTSurface.getVolume");var n="vws"!==t;!function(t,e,r,i,o){d=e||1.4,B=r||2,L=o||!0;var n=0;for(var a in p)n=Math.max(n,a);var s=Kn(h,l,n,B,t?d:0);T=s.dim[0],D=s.dim[1],R=s.dim[2],u=s.matrix,F=s.tran,B=s.scaleFactor,E={},$={},f(t),y=d*B,g=i||d/B,N=new Uint8Array(T*D*R),t&&(w=new Float64Array(T*D*R)),L&&(z=new Int32Array(T*D*R))}(n,e,r,i,o),function(t){var e,r;for(console.time("EDTSurface fillvoxels"),e=0,r=N.length;e<r;++e)N[e]=0,t&&(w[e]=-1),L&&(z[e]=-1);for(e=0,r=k.length/3;e<r;++e)m(e);for(e=0,r=N.length;e<r;++e)N[e]&j&&(N[e]|=I);console.timeEnd("EDTSurface fillvoxels")}(n),function(){var t,e,r,i=D*R;for(t=0;t<T;++t)for(e=0;e<R;++e)for(r=0;r<D;++r){var o=t*i+r*R+e;if(N[o]&j)for(var n=0;n<26;){var a=t+S[n][0],s=e+S[n][2],c=r+S[n][1];if(-1<a&&a<T&&-1<c&&c<D&&-1<s&&s<R&&!(N[a*i+c*R+s]&j)){N[o]|=A;break}n++}}}(),"ms"!==t&&"ses"!==t||function(){var t,e,r,i;console.time("EDTSurface fastdistancemap");var o,n=bl(T,D,R,Uint16Array,3),a=D*R,s=y*y,c=0;for(t=0;t<T;++t)for(e=0;e<D;++e)for(r=0;r<R;++r)N[o=t*a+e*R+r]&=~I,N[o]&j&&N[o]&A&&(n.set(t,e,r,t,e,r),w[o]=0,N[o]|=I,c+=1);var u=new Int32Array(3*c),h=0,l=new Int32Array(3*c),p=0;for(t=0;t<T;++t)for(e=0;e<D;++e)for(r=0;r<R;++r)N[o=t*a+e*R+r]&A&&(u[h]=t,u[h+1]=e,u[h+2]=r,h+=3,N[o]&=~A);do{for(p=b(u,n,h,l),t=h=0,i=p;t<i;t+=3)o=a*l[t]+R*l[t+1]+l[t+2],N[o]&=~A,w[o]<=1.0404*s&&(u[h]=l[t],u[h+1]=l[t+1],u[h+2]=l[t+2],h+=3)}while(0<h);var d,f=g*g,m=new Uint16Array(3);for(t=0;t<T;++t)for(e=0;e<D;++e)for(r=0;r<R;++r)N[o=t*a+e*R+r]&=~A,N[o]&j&&(N[o]&I&&!(N[o]&I&&w[o]>=f)||(N[o]|=A,L&&N[o]&I&&(n.toArray(t,e,r,m),d=m[0]*a+m[1]*R+m[2],z[o]=z[d])));console.timeEnd("EDTSurface fastdistancemap")}(),"ses"===t&&(f(!1),function(){var t,e;for(t=0,e=N.length;t<e;++t)N[t]&=~I;for(t=0,e=k.length/3;t<e;++t)v(t)}()),function(t){var e,r=N.length;if("vws"===t)for(e=0;e<r;++e)N[e]&=~A,N[e]=N[e]&I?1:0;else if("ms"===t)for(e=0;e<r;++e)N[e]&=~I,N[e]&A&&(N[e]|=I),N[e]&=~A,N[e]=N[e]&I?1:0;else if("ses"===t)for(e=0;e<r;++e)N[e]&A&&N[e]&I?N[e]&=~A:N[e]&A&&!(N[e]&I)&&(N[e]|=I),N[e]=N[e]&I?1:0;else if("sas"===t)for(e=0;e<r;++e)N[e]&=~A,N[e]=N[e]&I?1:0}(t);for(var a=0,s=z.length;a<s;++a)z[a]=c[z[a]];return console.timeEnd("EDTSurface.getVolume"),{data:N,nx:R,ny:D,nz:T,atomindex:z}},this.getSurface=function(t,e,r,i,o,n,a){var s=this.getVolume(t,e,r,i,o);return new Jn(s.data,s.nx,s.ny,s.nz,s.atomindex).getSurface(1,n,void 0,u,a)}}function _l(k,M,B,T,t,e,r){var i=k.length,D=t[0],R=t[1],F=t[2],o=e[0],n=e[1],a=e[2];function E(t,e){return Math.floor((t-e)/r)}for(var s,c,u,$=E(o,D)+1,L=E(n,R)+1,N=E(a,F)+1,h=$*L*N,z=L*N,l=[],p=0;p<i;p++){var d=(s=k[p],c=M[p],u=B[p],(E(s,D)*L+E(c,R))*N+E(u,F));void 0===l[d]?l[d]=[p]:l[d].push(p)}var j=new Uint32Array(h),V=new Uint16Array(h),G=new Uint32Array(i),f=0,m=0;for(p=0;p<h;p++){var g=j[p]=f,y=l[p];if(void 0!==y)for(var v=0;v<y.length;v++)G[f]=y[v],f++;var b=f-g;m<(V[p]=b)&&(m=b)}return{neighbourListLength:27*m+1,withinRadii:function(t,e,r,i,o){for(var n=0,a=E(t,D),s=E(e,R),c=E(r,F),u=Math.max(0,a-1),h=Math.max(0,s-1),l=Math.max(0,c-1),p=Math.min($,a+2),d=Math.min(L,s+2),f=Math.min(N,c+2),m=u;m<p;++m)for(var g=m*z,y=h;y<d;++y)for(var v=y*N,b=l;b<f;++b)for(var x=g+v+b,_=j[x],w=_+V[x],A=_;A<w;A++){var S=G[A],C=k[S]-t,P=M[S]-e,I=B[S]-r,O=T[S]+i;C*C+P*P+I*I<=O*O&&(o[n++]=G[A])}o[n]=-1}}}function wl(u,c,i){for(var D=c.length,L=new Float32Array(D),N=new Float32Array(D),z=new Float32Array(D),t=0;t<D;t++){var e=3*t;L[t]=u[e],N[t]=u[e+1],z[t]=u[e+2]}var r=oi(u);0===u.length&&(r[0].set([0,0,0]),r[1].set([0,0,0]));var j,R,h,l,V,G,U,H,p,W,q,X,Y,K,Z,Q,F,E,J,tt=r[0],d=r[1],et=-1,rt=new Float32Array([0,0,0]),it=new Float32Array([0,0,0]),ot=new Float32Array([0,0,0]),nt=new Float32Array([0,0,0]);function o(t,e,r,i){l=st(t,1.4),V=st(e,2),G=st(r,!0),U=st(i,30),j=new Float32Array(D),R=new Float32Array(D);for(var o=0;o<j.length;++o){var n=c[o]+l;j[o]=n,R[o]=n*n}for(var a=h=0;a<j.length;++a)j[a]>h&&(h=j[a]);var s;s=Kn(tt,d,h,V,0),V=s.scaleFactor,H=s.dim,p=s.matrix,J=Math.max(5,2+Math.floor(l*V)),W=De(H[0]*H[1]*H[2],-1001),q=new Int32Array(W.length),X=new Float32Array(H[0]),Y=new Float32Array(H[1]),K=new Float32Array(H[2]),f(X,tt[0],1/V),f(Y,tt[1],1/V),f(K,tt[2],1/V),function(){var t=0,e=2*Math.PI/U;Q=new Float32Array(U),Z=new Float32Array(U);for(var r=0;r<U;r++)Q[r]=Math.cos(t),Z[r]=Math.sin(t),t+=e}(),F=_l(L,N,z,j,tt,d,2.01*h),E=new Int32Array(F.neighbourListLength),et=-1}function f(t,e,r){for(var i=0;i<t.length;i++)t[i]=e+r*i}function at(t,e,r,i,o){var n;if(-1!==et){if((n=et)!==i&&n!==o&&s(n,t,e,r))return n;et=-1}var a=0;for(n=E[a];0<=n;){if(n!==i&&n!==o&&s(n,t,e,r))return et=n;n=E[++a]}return et=-1}function s(t,e,r,i){var o=3*t,n=R[t],a=u[o]-e,s=u[o+1]-r,c=u[o+2]-i;return a*a+s*s+c*c<n}function n(t,e){var r,i,o=j[t],n=j[e],a=rt[0]=L[e]-L[t],s=rt[1]=N[e]-N[t],c=rt[2]=z[e]-z[t],u=a*a+s*s+c*c,h=Math.sqrt(u),l=o*((o*o+h*h-n*n)/(2*o*h));vi(rt,rt),i=rt,(r=ot)[0]=r[1]=r[2]=1,0!==i[0]?r[0]=(i[1]+i[2])/-i[0]:0!==i[1]?r[1]=(i[0]+i[2])/-i[1]:0!==i[2]&&(r[2]=(i[0]+i[1])/-i[2]),vi(ot,ot),ui(nt,rt,ot),vi(nt,nt);var p=Math.sqrt(o*o-l*l);yi(ot,ot,p),yi(nt,nt,p),yi(rt,rt,l),it[0]=rt[0]+L[t],it[1]=rt[1]+N[t],it[2]=rt[2]+z[t],et=-1;for(var d=J,f=0;f<U;f++){var m=Q[f],g=Z[f],y=it[0]+m*ot[0]+g*nt[0],v=it[1]+m*ot[1]+g*nt[1],b=it[2]+m*ot[2]+g*nt[2];if(-1===at(y,v,b,t,e))for(var x=Math.floor(V*(y-tt[0])),_=Math.floor(V*(v-tt[1])),w=Math.floor(V*(b-tt[2])),A=Math.max(0,x-d),S=Math.max(0,_-d),C=Math.max(0,w-d),P=Math.min(H[0],x+d+2),I=Math.min(H[1],_+d+2),O=Math.min(H[2],w+d+2),k=A;k<P;k++){a=y-X[k];for(var M=H[1]*H[2]*k,B=S;B<I;B++)for(var T=a*a+(s=v-Y[B])*s,D=M+H[2]*B,R=C;R<O;R++){u=T+(c=b-K[R])*c;var F=R+D,E=W[F];if(0<E&&u<E*E&&(W[F]=Math.sqrt(u),G)){var $=a*rt[0]+s*rt[1]+c*rt[2];q[F]=$<0?e:t}}}}}function m(t,e,r){console.time("AVSurface.getVolume"),console.time("AVSurface.init"),o(t,e,r),console.timeEnd("AVSurface.init"),console.time("AVSurface.projectPoints"),function(){for(var t=0;t<D;t++){var e=L[t],r=N[t],i=z[t],o=j[t],n=R[t];F.withinRadii(e,r,i,o,E);for(var a=Math.ceil(o*V),s=Math.floor(V*(e-tt[0])),c=Math.floor(V*(r-tt[1])),u=Math.floor(V*(i-tt[2])),h=Math.max(0,s-a),l=Math.max(0,c-a),p=Math.max(0,u-a),d=Math.min(H[0],s+a+2),f=Math.min(H[1],c+a+2),m=Math.min(H[2],u+a+2),g=h;g<d;g++)for(var y=X[g]-e,v=H[1]*H[2]*g,b=l;b<f;b++)for(var x=Y[b]-r,_=y*y+x*x,w=v+H[2]*b,A=p;A<m;A++){var S=K[A]-i,C=_+S*S;if(C<n){var P=A+w;W[P]<0&&(W[P]=-W[P]);var I=Math.sqrt(C),O=o/I,k=y*O,M=x*O,B=S*O;if(-1===at(k+=e,M+=r,B+=i,t,-1)){var T=o-I;T<W[P]&&(W[P]=T,G&&(q[P]=t))}}}}}(),console.timeEnd("AVSurface.projectPoints"),console.time("AVSurface.projectTorii"),function(){for(var t=0;t<D;t++){F.withinRadii(L[t],N[t],z[t],j[t],E);for(var e=0,r=E[e];0<=r;)t<r&&n(t,r),r=E[++e]}}(),console.timeEnd("AVSurface.projectTorii"),function(){for(var t=0;t<W.length;t++)W[t]<0&&(W[t]=0)}(),function(){for(var t=0;t<q.length;t++)q[t]=i[q[t]]}(),console.timeEnd("AVSurface.getVolume")}this.getSurface=function(t,e,r,i,o,n,a){return m(e,r,o),new Jn(W,H[2],H[1],H[0],q).getSurface(e,!1,void 0,p,a)}}Ut.add("line",vl),Object.assign(xl,{__deps:[Kn,Yn,Jn,oi,bl]}),Object.assign(wl,{__deps:[Kn,Jn,De,oi,yi,ui,vi,_l,st]}),jt.add("molsurf",function(t,e){var r=t.data.args,i=t.data.params;if(r&&i){var o=new("av"===i.type?wl:xl)(r.coordList,r.radiusList,r.indexList).getSurface(i.type,i.probeRadius,i.scaleFactor,i.cutoff,!0,i.smooth,i.contour),n=[o.position.buffer,o.index.buffer];o.normal&&n.push(o.normal.buffer),o.atomindex&&n.push(o.atomindex.buffer),e({sd:o,p:i},n)}},[xl,wl]);var Al=function(t){this.structure=t};Al.prototype._getAtomData=function(t){return this.structure.getAtomData({what:{position:!0,radius:!0,index:!0},radiusParams:st(t.radiusParams,{type:"vdw",scale:1})})},Al.prototype._makeSurface=function(t,e){var r=new Zn(e.name,"",t);return r.info.type=e.type,r.info.probeRadius=e.probeRadius,r.info.scaleFactor=e.scaleFactor,r.info.smooth=e.smooth,r.info.cutoff=e.cutoff,r},Al.prototype.getSurface=function(t){var e=t||{},r=this._getAtomData(t),i=r.position,o=r.radius,n=r.index,a=new("av"===e.type?wl:xl)(i,o,n).getSurface(e.type,e.probeRadius,e.scaleFactor,e.cutoff,!0,e.smooth,e.contour);return this._makeSurface(a,e)},Al.prototype.getSurfaceWorker=function(t,r){var i=this,o=Object.assign({},t);if(window.hasOwnProperty("Worker")){void 0===this.worker&&(this.worker=new ti("molsurf"));var e=this._getAtomData(t),n=e.position,a=e.radius,s=e.index,c={args:{coordList:n,radiusList:a,indexList:s},params:o},u=[n.buffer,a.buffer,s.buffer];this.worker.post(c,u,function(t){r(i._makeSurface(t.data.sd,o))},function(t){console.warn("MolecularSurface.getSurfaceWorker error - trying without worker",t),i.worker.terminate(),i.worker=void 0;var e=i.getSurface(o);r(e)})}else{var h=this.getSurface(o);r(h)}},Al.prototype.dispose=function(){this.worker&&this.worker.terminate()};var Sl=function(o){function t(t,e,r){var i=this;o.call(this,t,e,r),this.type="surface",this.parameters=Object.assign({surfaceType:{type:"select",rebuild:!0,options:{vws:"vws",sas:"sas",ms:"ms",ses:"ses",av:"av"}},probeRadius:{type:"number",precision:1,max:20,min:0,rebuild:!0},smooth:{type:"integer",precision:1,max:10,min:0,rebuild:!0},scaleFactor:{type:"number",precision:1,max:5,min:0,rebuild:!0},cutoff:{type:"number",precision:2,max:50,min:0,rebuild:!0},contour:{type:"boolean",rebuild:!0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},filterSele:{type:"text",rebuild:!0},colorVolume:{type:"hidden"},useWorker:{type:"boolean",rebuild:!0}},this.parameters,{radius:null,scale:null}),this.__infoList=[],this.structure.signals.refreshed.add(function(){i.__forceNewMolsurf=!0}),this.toBePrepared=!0,this.init(r)}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"uniform"),e.colorValue=st(e.colorValue,14540253),e.disablePicking=st(e.disablePicking,!0),this.surfaceType=st(e.surfaceType,"ms"),this.probeRadius=st(e.probeRadius,1.4),this.smooth=st(e.smooth,2),this.scaleFactor=st(e.scaleFactor,2),this.cutoff=st(e.cutoff,0),this.contour=st(e.contour,!1),this.background=st(e.background,!1),this.opaqueBack=st(e.opaqueBack,!0),this.filterSele=st(e.filterSele,""),this.colorVolume=st(e.colorVolume,void 0),this.useWorker=st(e.useWorker,!0),o.prototype.init.call(this,t)},t.prototype.prepareData=function(t,e,r){var i=this.__infoList[e];if(i||(i={},this.__infoList[e]=i),i.molsurf&&i.sele===t.selection.string)r(e);else{if(this.filterSele){var o=t.structure.getView(new Ct(this.filterSele)),n=o.boundingBox.getSize(new fe.Vector3),a=Math.max(n.x,n.y,n.z),s=t.getAtomSetWithinPoint(o.center,a/2+6);t=t.getView(new Ct(t.getAtomSetWithinSelection(s,3).toSeleString()))}i.sele=t.selection.string,i.molsurf=new Al(t);var c=this.getSurfaceParams(),u=function(t){i.surface=t,r(e)};this.useWorker?i.molsurf.getSurfaceWorker(c,u):u(i.molsurf.getSurface(c))}},t.prototype.prepare=function(t){var i=this;if((this.__forceNewMolsurf||this.__sele!==this.selection.string||this.__surfaceParams!==JSON.stringify(this.getSurfaceParams()))&&(this.__infoList.forEach(function(t){t.molsurf.dispose()}),this.__infoList.length=0),0!==this.structureView.atomCount){var o=function(){i.__sele=i.selection.string,i.__surfaceParams=JSON.stringify(i.getSurfaceParams()),i.__forceNewMolsurf=!1,t()},e="default"===this.assembly?this.defaultAssembly:this.assembly,n=this.structure.biomolDict[e];n?n.partList.forEach(function(t,e){var r=t.getView(i.structureView);i.prepareData(r,e,function(t){t===n.partList.length-1&&o()})}):this.prepareData(this.structureView,0,o)}else t()},t.prototype.createData=function(t,e){var r=this.__infoList[e],i=r.surface,o={position:i.getPosition(),color:i.getColor(this.getColorParams()),index:i.getFilteredIndex(this.filterSele,t)},n=[];if(i.contour){var a=new ma(o,this.getBufferParams({wireframe:!1}));n.push(a)}else{Object.assign(o,{normal:i.getNormal(),picking:i.getPicking(t.getStructure())});var s=new ha(o,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));if("double"==this.getBufferParams().side){var c=new da(s);n.push(c)}else n.push(s)}return{bufferList:n,info:r}},t.prototype.updateData=function(t,e){var r={};if(t.position||t.radius)return this.__forceNewMolsurf=!0,void this.build();t.color&&(r.color=e.info.surface.getColor(this.getColorParams())),t.index&&(r.index=e.info.surface.getFilteredIndex(this.filterSele,e.sview)),e.bufferList[0].setAttributes(r)},t.prototype.setParameters=function(t,e,r){return void 0===e&&(e={}),t&&t.filterSele&&(e.index=!0),t&&void 0!==t.colorVolume&&(e.color=!0),t&&t.wireframe&&(t.contour||void 0===t.contour&&this.contour)&&(t.wireframe=!1),o.prototype.setParameters.call(this,t,e,r),this},t.prototype.getSurfaceParams=function(t){return void 0===t&&(t={}),Object.assign({type:this.surfaceType,probeRadius:this.probeRadius,scaleFactor:this.scaleFactor,smooth:this.smooth&&!this.contour,cutoff:this.cutoff,contour:this.contour,useWorker:this.useWorker,radiusParams:this.getRadiusParams()},t)},t.prototype.getColorParams=function(){var t=o.prototype.getColorParams.call(this);return t.volume=this.colorVolume,t},t.prototype.getAtomRadius=function(){return 0},t.prototype.clear=function(){o.prototype.clear.call(this)},t.prototype.dispose=function(){this.__infoList.forEach(function(t){t.molsurf.dispose()}),this.__infoList.length=0,o.prototype.dispose.call(this)},t}(ah);Ut.add("surface",Sl);var Cl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="point",this.parameters=Object.assign({pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{flatShaded:null,wireframe:null,linewidth:null,side:null,roughness:null,metalness:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};this.pointSize=st(e.pointSize,1),this.sizeAttenuation=st(e.sizeAttenuation,!0),this.sortParticles=st(e.sortParticles,!1),this.useTexture=st(e.useTexture,!1),this.alphaTest=st(e.alphaTest,.5),this.forceTransparent=st(e.forceTransparent,!1),this.edgeBleach=st(e.edgeBleach,0),i.prototype.init.call(this,e)},t.prototype.createData=function(t){var e=t.getAtomData(this.getAtomParams({position:!0,color:!0,picking:!0}));return{bufferList:[new Sc(e,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach}))]}},t.prototype.updateData=function(t,e){var r=e.sview.getAtomData(this.getAtomParams(t)),i={};t&&!t.position||Object.assign(i,{position:r.position}),t&&!t.color||Object.assign(i,{color:r.color}),e.bufferList[0].setAttributes(i)},t.prototype.getAtomRadius=function(){return.1},t}(ah);Ut.add("point",Cl),Wt.add("shader/Ribbon.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nattribute vec3 dir;\nattribute float size;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\ntransformed += normalize( dir ) * size;\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}");var Pl=new Uint16Array([0,1,2,1,3,2]);function Il(t){return 3*(4*(t.position.length/3-1))}var Ol=function(n){function t(t,e){void 0===e&&(e={}),n.call(this,{position:new Float32Array(Il(t)),color:new Float32Array(Il(t)),index:S(Il(t),Il(t)/3),normal:new Float32Array(Il(t)),picking:t.picking},e),this.vertexShader="Ribbon.vert";var r=t.position.length/3-1,i=4*r,o=3*i;this.addAttributes({dir:{type:"v3",value:new Float32Array(o)}}),this.addAttributes({size:{type:"f",value:new Float32Array(i)}}),t.primitiveId=Fe(r),this.setAttributes(t),this.makeIndex()}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.setAttributes=function(t){void 0===t&&(t={});var e,r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b,x=this.size/4,_=this.geometry.attributes;t.position&&(e=t.position,s=_.position.array,_.position.needsUpdate=!0),t.normal&&(r=t.normal,c=_.normal.array,_.normal.needsUpdate=!0),t.size&&(i=t.size,u=_.size.array,_.size.needsUpdate=!0),t.dir&&(o=t.dir,h=_.dir.array,_.dir.needsUpdate=!0),t.color&&(n=t.color,l=_.color.array,_.color.needsUpdate=!0),t.primitiveId&&(a=t.primitiveId,p=_.primitiveId.array,_.primitiveId.needsUpdate=!0);var w=i?i[0]:null;for(d=0;d<x;++d){for(m=(v=3*d)*4,y=4*d,e&&(s[m]=s[m+3]=e[v],s[m+1]=s[m+4]=e[v+1],s[m+2]=s[m+5]=e[v+2],s[m+6]=s[m+9]=e[v+3],s[m+7]=s[m+10]=e[v+4],s[m+8]=s[m+11]=e[v+5]),r&&(c[m]=c[m+3]=-r[v],c[m+1]=c[m+4]=-r[v+1],c[m+2]=c[m+5]=-r[v+2],c[m+6]=c[m+9]=-r[v+3],c[m+7]=c[m+10]=-r[v+4],c[m+8]=c[m+11]=-r[v+5]),f=0;f<4;++f)g=m+3*f,n&&(l[g]=n[v],l[g+1]=n[v+1],l[g+2]=n[v+2]),a&&(p[y+f]=a[d]);i&&(b=i[d],w!==i[d]?(u[y]=w,u[y+1]=w):(u[y]=b,u[y+1]=b),u[y+2]=b,w=u[y+3]=b),o&&(h[m]=o[v],h[m+1]=o[v+1],h[m+2]=o[v+2],h[m+3]=-o[v],h[m+4]=-o[v+1],h[m+5]=-o[v+2],h[m+6]=o[v+3],h[m+7]=o[v+4],h[m+8]=o[v+5],h[m+9]=-o[v+3],h[m+10]=-o[v+4],h[m+11]=-o[v+5])}},t.prototype.makeIndex=function(){for(var t=this.geometry.getIndex().array,e=t.length/4/3,r=0;r<e;++r){var i=6*r,o=4*r;t.set(Pl,i);for(var n=0;n<6;++n)t[i+n]+=o}},t}(ua),kl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="ribbon",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{side:null,wireframe:null,linewidth:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"chainname"),e.colorScale=st(e.colorScale,"RdYlBu"),e.radiusType=st(e.radiusType,"sstruc"),e.radiusScale=st(e.radiusScale,4),"low"===e.quality?this.subdiv=3:"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=st(e.subdiv,6),this.tension=st(e.tension,NaN),this.smoothSheet=st(e.smoothSheet,!1),i.prototype.init.call(this,e)},t.prototype.getSplineParams=function(t){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!0,smoothSheet:this.smoothSheet},t)},t.prototype.getAtomRadius=function(t){return t.isTrace()?i.prototype.getAtomRadius.call(this,t):0},t.prototype.createData=function(t){var s=this,c=[],u=[];return this.structure.eachPolymer(function(t){if(!(t.residueCount<4)){u.push(t);var e=new Vh(t,s.getSplineParams()),r=e.getSubdividedPosition(),i=e.getSubdividedOrientation(),o=e.getSubdividedColor(s.getColorParams()),n=e.getSubdividedPicking(),a=e.getSubdividedSize(s.getRadiusParams());c.push(new Ol({position:r.position,normal:i.binormal,dir:i.normal,color:o.color,size:a.size,picking:n.picking},s.getBufferParams()))}},t.getSelection()),{bufferList:c,polymerList:u}},t.prototype.updateData=function(t,e){t=t||{};var r=0,i=e.polymerList.length;for(r=0;r<i;++r){var o={},n=new Vh(e.polymerList[r],this.getSplineParams());if(t.position){var a=n.getSubdividedPosition(),s=n.getSubdividedOrientation();Object.assign(o,{position:a.position,normal:s.binormal,dir:s.normal})}if(t.radius||t.scale){var c=n.getSubdividedSize(this.getRadiusParams());Object.assign(o,{size:c.size})}if(t.color){var u=n.getSubdividedColor(this.getColorParams());Object.assign(o,{color:u.color})}e.bufferList[r].setAttributes(o)}},t.prototype.setParameters=function(t){var e={};return t&&t.tension&&Object.assign(e,{position:!0}),i.prototype.setParameters.call(this,t,e,!1),this},t}(ah);Ut.add("ribbon",kl);var Ml=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="rocket",this.parameters=Object.assign({localAngle:{type:"integer",max:180,min:0,rebuild:!0},centerDist:{type:"number",precision:1,max:10,min:0,rebuild:!0},ssBorder:{type:"boolean",rebuild:!0},radialSegments:!0,openEnded:!0,disableImpostor:!0},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"sstruc"),e.radiusSize=st(e.radiusSize,1.5),e.radiusScale=st(e.radiusScale,1),e.openEnded=st(e.openEnded,!1),e.useInteriorColor=st(e.useInteriorColor,!0),this.localAngle=st(e.localAngle,30),this.centerDist=st(e.centerDist,2.5),this.ssBorder=st(e.ssBorder,!1),i.prototype.init.call(this,e)},t.prototype.createData=function(t){var i=this,o=0,n=[],a=[];this.structure.eachPolymer(function(t){if(!(t.residueCount<4||t.isNucleic())){var e=new Ya(t),r=e.getAxis(i.localAngle,i.centerDist,i.ssBorder,i.getColorParams(),i.getRadiusParams());o+=r.size.length,n.push(r),a.push(e)}},t.getSelection());var e={begin:new Float32Array(3*o),end:new Float32Array(3*o),size:new Float32Array(o),color:new Float32Array(3*o),picking:{}},r=new Float32Array(o),s=0;return n.forEach(function(t){e.begin.set(t.begin,3*s),e.end.set(t.end,3*s),e.size.set(t.size,s),e.color.set(t.color,3*s),r.set(t.picking.array,s),s+=t.size.length}),o&&(e.picking=new on(r,t.getStructure())),{bufferList:[new Eh({position1:e.begin,position2:e.end,color:e.color,color2:e.color,radius:e.size,picking:e.picking},this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))],axisList:n,helixbundleList:a,axisData:e}},t.prototype.updateData=function(r,i){var o=this;if((r=r||{}).position)this.build();else{var t={};if(r.color||r.radius){var n=0;i.helixbundleList.forEach(function(t){var e=t.getAxis(o.localAngle,o.centerDist,o.ssBorder,o.getColorParams(),o.getRadiusParams());r.color&&i.axisData.color.set(e.color,3*n),(r.radius||r.scale)&&i.axisData.size.set(e.size,n),n+=e.size.length}),r.color&&Object.assign(t,{color:i.axisData.color,color2:i.axisData.color}),(r.radius||r.scale)&&Object.assign(t,{radius:i.axisData.size})}i.bufferList[0].setAttributes(t)}},t}(ah);Ut.add("rocket",Ml);var Bl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="rope",this.parameters=Object.assign({smooth:{type:"integer",max:15,min:0,rebuild:!0}},this.parameters,{aspectRatio:null,smoothSheet:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.aspectRatio=1,e.tension=st(e.tension,.5),e.radiusScale=st(e.radiusScale,5),e.smoothSheet=!1,this.smooth=st(e.smooth,2),i.prototype.init.call(this,e)},t.prototype.getSpline=function(t){var e=new Xa(t);return new Vh(t,this.getSplineParams({directional:!1,positionIterator:e.getCenterIterator(this.smooth)}))},t}(qh);Ut.add("rope",Bl);var Tl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="spacefill",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.useInteriorColor=st(e.useInteriorColor,!0),i.prototype.init.call(this,e)},t.prototype.createData=function(t){return{bufferList:[new _c(t.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,dullInterior:!0,disableImpostor:this.disableImpostor}))]}},t.prototype.updateData=function(t,e){var r=e.sview.getAtomData(this.getAtomParams(t)),i={};t&&!t.position||Object.assign(i,{position:r.position}),t&&!t.color||Object.assign(i,{color:r.color}),t&&!t.radius||Object.assign(i,{radius:r.radius}),e.bufferList[0].setAttributes(i)},t}(ah);function Dl(t){return 3*(t.position.length/3-1)*2}Ut.add("spacefill",Tl);var Rl=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,{position:new Float32Array(Dl(t)),color:new Float32Array(Dl(t))},e),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag",this.setAttributes(t)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.setAttributes=function(t){var e,r,i,o,n=this.geometry.attributes;if(t.position&&(e=t.position,i=n.position.array,n.position.needsUpdate=!0),t.color&&(r=t.color,o=n.color.array,n.color.needsUpdate=!0),e||r)for(var a,s,c=this.size-1,u=0;u<c;++u)s=(a=3*u)*2,e&&(i[s]=e[a],i[s+1]=e[a+1],i[s+2]=e[a+2],i[s+3]=e[a+3],i[s+4]=e[a+4],i[s+5]=e[a+5]),r&&(o[s]=r[a],o[s+1]=r[a+1],o[s+2]=r[a+2],o[s+3]=r[a+3],o[s+4]=r[a+4],o[s+5]=r[a+5]);else me.warn("TraceBuffer.prototype.setAttributes no data")},t}(sa),Fl=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="trace",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorScheme=st(e.colorScheme,"chainname"),e.colorScale=st(e.colorScale,"RdYlBu"),"low"===e.quality?this.subdiv=3:"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=st(e.subdiv,6),this.tension=st(e.tension,NaN),this.smoothSheet=st(e.smoothSheet,!1),i.prototype.init.call(this,e)},t.prototype.getSplineParams=function(t){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!1,smoothSheet:this.smoothSheet},t)},t.prototype.getAtomRadius=function(t){return t.isTrace()?.1:0},t.prototype.createData=function(t){var o=this,n=[],a=[];return this.structure.eachPolymer(function(t){if(!(t.residueCount<4)){a.push(t);var e=new Vh(t,o.getSplineParams()),r=e.getSubdividedPosition(),i=e.getSubdividedColor(o.getColorParams());n.push(new Rl(Object.assign({},r,i),o.getBufferParams()))}},t.getSelection()),{bufferList:n,polymerList:a}},t.prototype.updateData=function(t,e){t=t||{};var r=0,i=e.polymerList.length;for(r=0;r<i;++r){var o={},n=new Vh(e.polymerList[r],this.getSplineParams());if(t.position){var a=n.getSubdividedPosition();Object.assign(o,{position:a.position})}if(t.color){var s=n.getSubdividedColor(this.getColorParams());Object.assign(o,{color:s.color})}e.bufferList[r].setAttributes(o)}},t.prototype.setParameters=function(t){var e={};return t&&t.tension&&Object.assign(e,{position:!0}),i.prototype.setParameters.call(this,t,e,!1),this},t}(ah);Ut.add("trace",Fl);var El=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="tube",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.aspectRatio=1,e.radiusScale=st(e.radiusScale,2),"low"===e.quality&&(this.radialSegments=5),i.prototype.init.call(this,e)},t.prototype.getSplineParams=function(){return i.prototype.getSplineParams.call(this,{directional:!1})},t}(qh);Ut.add("tube",El);var $l=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="unitcell",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0},this.parameters,{assembly:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{},r=.5;this.structure.unitcell&&(r=Math.cbrt(this.structure.unitcell.volume)/200),e.radiusSize=st(e.radiusSize,r),e.colorValue=st(e.colorValue,"orange"),e.useInteriorColor=st(e.useInteriorColor,!0),i.prototype.init.call(this,e)},t.prototype.getUnitcellData=function(t){return t.unitcell.getData(t)},t.prototype.create=function(){var t=this.structureView.getStructure();if(t.unitcell){var e=this.getUnitcellData(t);this.sphereBuffer=new _c(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new Eh(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}},t.prototype.createData=function(t){},t.prototype.updateData=function(t,e){var r=e.sview.getStructure();if(r.unitcell){var i=this.getUnitcellData(r),o={},n={};t&&!t.position||(Object.assign(o,{position:i.vertex.position}),Object.assign(n,{position1:i.edge.position1,position2:i.edge.position2})),t&&!t.color||(Object.assign(o,{color:i.vertex.color}),Object.assign(n,{color:i.edge.color,color2:i.edge.color2})),t&&!t.radius||(Object.assign(o,{radius:i.vertex.radius}),Object.assign(n,{radius:i.edge.radius})),this.sphereBuffer.setAttributes(o),this.cylinderBuffer.setAttributes(n)}},t}(ah);Ut.add("unitcell",$l);var Ll=function(i){function t(t,e,r){i.call(this,t,e,r),this.type="validation",this.parameters=Object.assign({},this.parameters,{radiusType:null,radiusSize:null,radiusScale:null}),this.init(r)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.init=function(t){var e=t||{};e.colorValue=st(e.colorValue,"#f0027f"),e.useInteriorColor=st(e.useInteriorColor,!0),i.prototype.init.call(this,e)},t.prototype.createData=function(t){if(t.validation){var e=t.validation.getClashData({structure:t,color:this.colorValue});return{bufferList:[new Eh(e,this.getBufferParams({openEnded:!1}))]}}},t}(ah);Ut.add("validation",Ll);var Nl=new fe.Vector3,zl=new fe.Vector3,jl=new fe.Vector3,Vl=new fe.Vector3(0,1,0);var Gl=Object.assign({radialSegments:60,openEnded:!1},na),Ul=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,{position:new Float32Array(t.position1.length),color:t.color,picking:t.picking},e,function(t){void 0===t&&(t={});var e=new fe.ConeBufferGeometry(1,1,st(t.radialSegments,60),1,st(t.openEnded,!1));return e.applyMatrix((new fe.Matrix4).makeRotationX(-Math.PI/2)),e}(e)),this.updateNormals=!0,this._position=new Float32Array(t.position1.length),this.setAttributes(t,!0)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return Gl},t.prototype.applyPositionTransform=function(t,e,r){zl.fromArray(this._position1,r),jl.fromArray(this._position2,r),t.lookAt(zl,jl,Vl);var i=this._radius[e];Nl.set(i,i,zl.distanceTo(jl)),t.scale(Nl)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.position1&&t.position2&&(Be(t.position1,t.position2,this._position),this._position1=t.position1,this._position2=t.position2,t.position=this._position),t.radius&&(this._radius=t.radius),r.prototype.setAttributes.call(this,t,e)},Object.defineProperties(t.prototype,e),t}(pc);Yt.add("cone",Ul);var Hl=function(t){void 0===t&&(t=[]),this.geometryList=t};Hl.prototype.computeBoundingBox=function(){var e=this;this.boundingBox?this.boundingBox.empty():this.boundingBox=new fe.Box3,this.geometryList.forEach(function(t){t.boundingBox||t.computeBoundingBox(),e.boundingBox.union(t.boundingBox)})};var Wl=Object.assign({aspectRatio:1.5,radialSegments:50,openEnded:!1,disableImpostor:!1},na),ql=function(t,e){void 0===e&&(e={}),this.group=new fe.Group,this.wireframeGroup=new fe.Group,this.pickingGroup=new fe.Group,this.visible=!0,this.parameters=w(e,this.defaultParameters),this.splitPosition=new Float32Array(t.position1.length),this.cylinderRadius=new Float32Array(t.radius.length);var r=this.makeAttributes(t),i={radialSegments:this.parameters.radialSegments,openEnded:this.parameters.openEnded,disableImpostor:this.parameters.disableImpostor};this.cylinderBuffer=new Eh(r.cylinder,i),this.coneBuffer=new Ul(r.cone,i),this.geometry=new Hl([this.cylinderBuffer.geometry,this.coneBuffer.geometry]),this.matrix=st(e.matrix,new fe.Matrix4),this.picking=t.picking},Xl={defaultParameters:{configurable:!0},matrix:{configurable:!0},pickable:{configurable:!0}};Xl.defaultParameters.get=function(){return Wl},Xl.matrix.set=function(t){sa.prototype.setMatrix.call(this,t)},Xl.matrix.get=function(){return this.group.matrix.clone()},Xl.pickable.get=function(){return!!this.picking},ql.prototype.makeAttributes=function(t){void 0===t&&(t={});var e,r,i=this.splitPosition,o=this.cylinderRadius,n=this.parameters.aspectRatio,a={},s={};if(t.radius){for(e=0,r=o.length;e<r;++e)o[e]=t.radius[e]/n;a.radius=o,s.radius=t.radius}if(t.position1&&t.position2){var c=new fe.Vector3,u=new fe.Vector3,h=new fe.Vector3,l=new fe.Vector3;for(e=0,r=i.length;e<r;e+=3){c.fromArray(t.position1,e),u.fromArray(t.position2,e),h.subVectors(c,u);var p=h.length(),d=o[e/3]*n*2,f=Math.min(p,d);h.setLength(f),l.copy(u).add(h),l.toArray(i,e)}a.position1=t.position1,a.position2=i,s.position1=i,s.position2=t.position2}return t.color&&(a.color=t.color,a.color2=t.color,s.color=t.color),{cylinder:a,cone:s}},ql.prototype.getMesh=function(){return(new fe.Group).add(this.cylinderBuffer.getMesh(),this.coneBuffer.getMesh())},ql.prototype.getWireframeMesh=function(){return(new fe.Group).add(this.cylinderBuffer.getWireframeMesh(),this.coneBuffer.getWireframeMesh())},ql.prototype.getPickingMesh=function(){return(new fe.Group).add(this.cylinderBuffer.getPickingMesh(),this.coneBuffer.getPickingMesh())},ql.prototype.setAttributes=function(t){void 0===t&&(t={});var e=this.makeAttributes(t);this.cylinderBuffer.setAttributes(e.cylinder),this.coneBuffer.setAttributes(e.cone)},ql.prototype.setParameters=function(t){void 0===t&&(t={}),(t=Object.assign({},t))&&void 0!==t.matrix&&(this.matrix=t.matrix),delete t.matrix,t&&void 0!==t.wireframe&&(this.parameters.wireframe=t.wireframe,this.setVisibility(this.visible)),this.cylinderBuffer.setParameters(t),this.coneBuffer.setParameters(t)},ql.prototype.setVisibility=function(t){sa.prototype.setVisibility.call(this,t)},ql.prototype.dispose=function(){this.cylinderBuffer.dispose(),this.coneBuffer.dispose()},Object.defineProperties(ql.prototype,Xl),Yt.add("arrow",ql);var Yl=new fe.Vector3,Kl=new fe.Vector3,Zl=new fe.Vector3,Ql=new fe.Vector3(0,0,0),Jl=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.BoxBufferGeometry(1,1,1)),this.updateNormals=!0,this.setAttributes(t,!0)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.applyPositionTransform=function(t,e,r){Kl.fromArray(this._heightAxis,r),Zl.fromArray(this._depthAxis,r),t.lookAt(Ql,Kl,Zl),Yl.set(this._size[e],Zl.length(),Kl.length()),t.scale(Yl)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),r.prototype.setAttributes.call(this,t,e)},t}(pc);Yt.add("box",Jl);var tp=new fe.Vector3,ep=new fe.Vector3,rp=new fe.Vector3,ip=new fe.Vector3(0,0,0),op=Object.assign({sphereDetail:2},na),np=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.IcosahedronBufferGeometry(1,st(e.sphereDetail,2))),this.updateNormals=!0,this.setAttributes(t,!0)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return op},t.prototype.applyPositionTransform=function(t,e,r){ep.fromArray(this._majorAxis,r),rp.fromArray(this._minorAxis,r),t.lookAt(ip,ep,rp),tp.set(this._radius[e],rp.length(),ep.length()),t.scale(tp)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),t.majorAxis&&(this._majorAxis=t.majorAxis),t.minorAxis&&(this._minorAxis=t.minorAxis),r.prototype.setAttributes.call(this,t,e)},Object.defineProperties(t.prototype,e),t}(pc);Yt.add("ellipsoid",np);var ap=new fe.Vector3,sp=new fe.Vector3,cp=new fe.Vector3,up=new fe.Vector3(0,0,0),hp=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.OctahedronBufferGeometry(1,0)),this.updateNormals=!0,this.setAttributes(t,!0)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.applyPositionTransform=function(t,e,r){sp.fromArray(this._heightAxis,r),cp.fromArray(this._depthAxis,r),t.lookAt(up,sp,cp),ap.set(this._size[e],cp.length(),sp.length()),t.scale(ap)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),r.prototype.setAttributes.call(this,t,e)},t}(pc);Yt.add("octahedron",hp);var lp=new fe.Vector3,pp=new fe.Vector3,dp=new fe.Vector3,fp=new fe.Vector3(0,0,0),mp=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.TetrahedronBufferGeometry(1,0)),this.updateNormals=!0,this.setAttributes(t,!0)}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.applyPositionTransform=function(t,e,r){pp.fromArray(this._heightAxis,r),dp.fromArray(this._depthAxis,r),t.lookAt(fp,pp,dp),lp.set(this._size[e],dp.length(),pp.length()),t.scale(lp)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),r.prototype.setAttributes.call(this,t,e)},t}(pc);Yt.add("tetrahedron",mp);var gp=new fe.Vector3,yp=new fe.Vector3,vp=new fe.Vector3,bp=new fe.Vector3(0,0,0),xp=Object.assign({radiusRatio:.2,radialSegments:16,tubularSegments:32},na),_p=function(r){function t(t,e){void 0===e&&(e={}),r.call(this,t,e,new fe.TorusBufferGeometry(1,st(e.radiusRatio,.2),st(e.radialSegments,16),st(e.tubularSegments,32))),this.updateNormals=!0,this.setAttributes(t,!0)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={defaultParameters:{configurable:!0}};return e.defaultParameters.get=function(){return xp},t.prototype.applyPositionTransform=function(t,e,r){yp.fromArray(this._majorAxis,r),vp.fromArray(this._minorAxis,r),t.lookAt(bp,yp,vp);var i=this._radius[e];gp.set(i,i,i),t.scale(gp)},t.prototype.setAttributes=function(t,e){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),t.majorAxis&&(this._majorAxis=t.majorAxis),t.minorAxis&&(this._minorAxis=t.minorAxis),r.prototype.setAttributes.call(this,t,e)},Object.defineProperties(t.prototype,e),t}(pc);Yt.add("torus",_p);var wp=function(t,e){var r=e||{};this.streamer=t,this.name=st(r.name,""),this.path=st(r.path,"")},Ap={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0},isJson:{configurable:!0},isXml:{configurable:!0}};Ap.type.get=function(){return""},Ap.__objName.get=function(){return""},Ap.isBinary.get=function(){return!1},Ap.isJson.get=function(){return!1},Ap.isXml.get=function(){return!1},wp.prototype.parse=function(){var t=this;return this.streamer.read().then(function(){return t._beforeParse(),t._parse(),t._afterParse(),t[t.__objName]})},wp.prototype._parse=function(){},wp.prototype._beforeParse=function(){},wp.prototype._afterParse=function(){de.Debug&&me.log(this[this.__objName])},Object.defineProperties(wp.prototype,Ap);var Sp=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.firstModelOnly=st(r.firstModelOnly,!1),this.asTrajectory=st(r.asTrajectory,!1),this.cAlphaOnly=st(r.cAlphaOnly,!1),this.structure=new rc(this.name,this.path),this.structureBuilder=new ps(this.structure)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"structure"},e.__objName.get=function(){return"structure"},Object.defineProperties(t.prototype,e),t}(wp);var Cp=function(e,r,t,i,o){void 0===t&&(t=""),void 0===o&&(o=[]),this.structure=e,this.index=r,this.description=t,this.entityType=function(t){switch(t=t.toLowerCase()){case"polymer":return 1;case"non-polymer":return 2;case"macrolide":return 3;case"water":return 4;default:return 0}}(i||""),(this.chainIndexList=o).forEach(function(t){e.chainStore.entityIndex[t]=r})},Pp={type:{configurable:!0}};Pp.type.get=function(){return function(t){switch(t){case 1:return"polymer";case 2:return"non-polymer";case 3:return"macrolide";case 4:return"water";default:return}}(this.entityType)},Cp.prototype.getEntityType=function(){return this.entityType},Cp.prototype.isPolymer=function(){return 1===this.entityType},Cp.prototype.isNonPolymer=function(){return 2===this.entityType},Cp.prototype.isMacrolide=function(){return 3===this.entityType},Cp.prototype.isWater=function(){return 4===this.entityType},Cp.prototype.eachChain=function(e){var r=this.structure.getChainProxy();this.chainIndexList.forEach(function(t){r.index=t,e(r)})},Object.defineProperties(Cp.prototype,Pp);var Ip={a:1,b:1,c:1,alpha:90,beta:90,gamma:90,spacegroup:"P 1"},Op=function(t){void 0===t&&(t=Ip),this.cartToFrac=new fe.Matrix4,this.fracToCart=new fe.Matrix4,this.a=t.a,this.b=t.b,this.c=t.c,this.alpha=t.alpha,this.beta=t.beta,this.gamma=t.gamma,this.spacegroup=t.spacegroup;var e=et(this.alpha),r=et(this.beta),i=et(this.gamma),o=Math.cos(e),n=Math.cos(r),a=Math.cos(i),s=Math.sin(r),c=Math.sin(i);if(this.volume=this.a*this.b*this.c*Math.sqrt(1-o*o-n*n-a*a+2*o*n*a),void 0===t.cartToFrac){var u=this.a*this.b*c/this.volume,h=(n*a-o)/(s*c);this.fracToCart.set(this.a,0,0,0,this.b*a,this.b*c,0,0,this.c*n,-this.c*s*h,1/u,0,0,0,0,1).transpose(),this.cartToFrac.getInverse(this.fracToCart)}else this.cartToFrac.copy(t.cartToFrac),this.fracToCart.getInverse(this.cartToFrac)};Op.prototype.getPosition=function(t){var i=new Float32Array(24);if(t.unitcell){var o=t.unitcell,n=t.center.clone().applyMatrix4(o.cartToFrac).floor(),a=new fe.Vector3,s=0,e=function(t,e,r){a.set(t,e,r).add(n).applyMatrix4(o.fracToCart).toArray(i,s),s+=3};e(0,0,0),e(1,0,0),e(0,1,0),e(0,0,1),e(1,1,0),e(1,0,1),e(0,1,1),e(1,1,1)}return i},Op.prototype.getCenter=function(t){return function(t,e){void 0===e&&(e=new fe.Vector3);for(var r=t.length,i=0;i<r;i+=3)e.x+=t[i],e.y+=t[i+1],e.z+=t[i+2];return e.divideScalar(r/3),e}(this.getPosition(t))},Op.prototype.getData=function(t,e){void 0===e&&(e={});var r=st(e.colorValue,"orange"),i=st(e.radius,Math.cbrt(this.volume)/200),o=new fe.Color(r),n=new fe.Vector3,a=this.getPosition(t),s=Re(8,o.r,o.g,o.b),c=De(8,i),u=new Float32Array(36),h=new Float32Array(36),l=Re(12,o.r,o.g,o.b),p=De(12,i),d=0;function f(t,e){n.fromArray(a,3*t).toArray(u,d),n.fromArray(a,3*e).toArray(h,d),d+=3}f(0,1),f(0,2),f(0,3),f(1,4),f(1,5),f(2,6),f(3,5),f(4,7),f(5,7),f(2,4),f(7,6),f(3,6);var m=new xn(this,t);return{vertex:{position:a,color:s,radius:c,picking:m},edge:{position1:u,position2:h,color:l,color2:l,radius:p,picking:m}}};var kp={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h",0:"h"},Mp=["DAL","DAR","DSG","DAS","DCY","DGL","DGN","DHI","DIL","DLE","DLY","MED","DPN","DPR","DSN","DTH","DTR","DTY","DVA","DNE"],Bp=["MOL_ID","MOLECULE","CHAIN","FRAGMENT","SYNONYM","EC","ENGINEERED","MUTATION","OTHER_DETAILS"],Tp=/\s+/;function Dp(t,e,r){var i=""+t;return e&&(i+=":"+e),r&&(i+="^"+r),i}var Rp=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.hex=st(r.hex,!1)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0}};return e.type.get=function(){return"pdb"},t.prototype._parse=function(){de.Debug&&me.time("PdbParser._parse "+this.name);var rt=!1,t=this.streamer.peekLines(1)[0],e=t.substr(62,4),r=t.substr(72,4);e===r&&r.trim()&&(rt=!0);var it,ot,nt,at,st,ct,ut,ht,lt,pt,dt,ft,mt,gt,yt,vt,bt,xt,_t,wt,At,St,Ct,Pt,It,Ot,kt,Mt,Bt,Tt,Dt,Rt,Ft,Et="pqr"===this.type,$t="pdbqt"===this.type,Lt=this.structure,Nt=this.structureBuilder,zt=this.hex,jt=10,Vt=10,Gt=this.firstModelOnly,Ut=this.asTrajectory,Ht=this.cAlphaOnly,Wt=Lt.frames,qt=Lt.boxes,Xt=!1,Yt=Lt.biomolDict,Kt={},Zt={},Qt={},Jt=[],te={},ee={},re={},ie={},i={helices:[],sheets:[]},oe=i.helices,ne=i.sheets,ae=Lt.atomMap,se=Lt.atomStore;se.resize(Math.round(this.streamer.data.length/80)),(Et||$t)&&se.addField("partialCharge",1,"float32"),Et&&se.addField("radius",1,"float32");var ce=Lt.getAtomProxy(),ue=Lt.getAtomProxy(),he=0,le=0,pe=!0;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i,o=t;o<e;++o)if(ct=r[o],"ATOM  "===(ut=ct.substr(0,6))||"HETATM"===ut){if(pe&&(Ut?(Xt?(it=new Float32Array(3*se.count),Wt.push(it)):it=[],ot=0):Gt||(Kt={}),kt=(Ot=1).toString(),pe=!(Mt=!0)),Gt&&0<le)continue;var n=void 0,a=void 0,s=void 0,c=void 0,u=0;if(Et){if(u=10===(c=ct.split(Tp)).length?1:0,gt=c[2],Ht&&"CA"!==gt)continue;n=parseFloat(c[6-u]),a=parseFloat(c[7-u]),s=parseFloat(c[8-u])}else{if(gt=ct.substr(12,4).trim(),Ht&&"CA"!==gt)continue;n=parseFloat(ct.substr(30,8)),a=parseFloat(ct.substr(38,8)),s=parseFloat(ct.substr(46,8))}if(Ut){var h=3*ot;if(it[h+0]=n,it[h+1]=a,it[h+2]=s,ot+=1,Xt)continue}var l=void 0;Et?(ht=parseInt(c[1]),l="",yt="H"===ct[0]?1:0,lt=u?"":c[4],pt=parseInt(c[5-u]),mt="",dt=c[3],bt="",ft=1):(ht=parseInt(ct.substr(6,5),jt),zt&&99999===ht&&(jt=16),yt="H"===ct[0]?1:0,lt=ct[21].trim(),pt=parseInt(ct.substr(22,4),Vt),zt&&9999===pt&&(Vt=16),mt=ct[26].trim(),dt=ct.substr(17,4).trim()||"MOL",vt=parseFloat(ct.substr(60,6)),bt=ct[16].trim(),ft=parseFloat(ct.substr(54,6)),rt||($t?l=ct.substr(12,2).trim():(l=ct.substr(76,2).trim(),lt||(lt=ct.substr(72,4).trim())))),se.growIfFull(),se.atomTypeId[he]=ae.add(gt,l),se.x[he]=n,se.y[he]=a,se.z[he]=s,se.serial[he]=ht,se.altloc[he]=bt.charCodeAt(0),se.occupancy[he]=isNaN(ft)?0:ft,Et?(se.partialCharge[he]=parseFloat(c[9-u]),se.radius[he]=parseFloat(c[10-u])):(se.bfactor[he]=isNaN(vt)?0:vt,$t&&(se.partialCharge[he]=parseFloat(ct.substr(70,6))));var p=Dp(pt,lt,mt);!yt||ee[p]||Mp.includes(dt)?Mt||Bt===lt||(kt=(Ot+=1).toString()):Bt===lt&&Dt===dt&&(xo.includes(dt)||Tt===pt&&Rt===mt)||(kt=(Ot+=1).toString(),Tt=pt,Dt=dt,Rt=mt),Nt.addAtom(le,lt,kt,dt,pt,yt,void 0,mt),Kt[ht]=he,he+=1,Mt=!1,Bt=lt}else if("CONECT"===ut){var d=Kt[parseInt(ct.substr(6,5))],f=[11,16,21,26],m={};if(void 0===d)continue;for(var g=0;g<4;++g){var y=parseInt(ct.substr(f[g],5));if(!Number.isNaN(y)&&void 0!==(y=Kt[y]))if(d<y?(ce.index=d,ue.index=y):(ce.index=y,ue.index=d),void 0!==m[y])Lt.bondStore.bondOrder[m[y]]+=1;else{var v=ce.index+"|"+ue.index;void 0===Qt[v]&&(Qt[v]=!0,m[y]=Lt.bondStore.count,Lt.bondStore.addBond(ce,ue,1))}}}else if("HELIX "===ut){xt=ct[19].trim(),_t=parseInt(ct.substr(21,4)),wt=ct[25].trim(),At=ct[31].trim(),St=parseInt(ct.substr(33,4)),Ct=ct[37].trim();var b=parseInt(ct.substr(39,1));b=(kp[b]||kp[0]).charCodeAt(0),oe.push([xt,_t,wt,At,St,Ct,b])}else if("SHEET "===ut)xt=ct[21].trim(),_t=parseInt(ct.substr(22,4)),wt=ct[26].trim(),At=ct[32].trim(),St=parseInt(ct.substr(33,4)),Ct=ct[37].trim(),ne.push([xt,_t,wt,At,St,Ct]);else if("HETNAM"===ut)te[ct.substr(11,3)]=ct.substr(15).trim();else if("SEQRES"===ut){var x=ct[11].trim();x!==Ft&&(ie[x]=[],Ft=x),(i=ie[x]).push.apply(i,ct.substr(19).trim().split(Tp))}else if("MODRES"===ut){var _=ct.substr(12,3).trim(),w=ct[16].trim(),A=ct[22].trim(),S=parseInt(ct.substr(18,4).trim()),C=Dp(S,w,A);ee[C]={resname:_,chainname:w,inscode:A,resno:S}}else if("COMPND"===ut){var P=ct.substr(10,70).trim(),I=P.indexOf(":"),O=P.substring(0,I),k=void 0;Bp.includes(O)?(It=O,k=P.substring(I+2)):k=P,k=k.replace(/;$/,""),"MOL_ID"===It?(Pt={chainList:[],name:""},Jt.push(Pt)):"MOLECULE"===It?(Pt.name&&(Pt.name+=" "),Pt.name+=k):"CHAIN"===It&&Array.prototype.push.apply(Pt.chainList,k.split(/\s*,\s*/))}else if(ct.startsWith("TER")){var M=Lt.getChainProxy(Lt.chainStore.count-1);re[M.chainname]=M.index,kt=(Ot+=1).toString(),Mt=!0}else if("REMARK"===ut&&"350"===ct.substr(7,3)){if("BIOMOLECULE:"===ct.substr(11,12)){var B=ct.substr(23).trim();/^(0|[1-9][0-9]*)$/.test(B)&&(B="BU"+B),nt=new cs(B),Yt[B]=nt}else if("BIOMT"===ct.substr(13,5)){var T=ct.split(/\s+/),D=parseInt(ct[18])-1;0===D&&(st=new fe.Matrix4,at.matrixList.push(st));var R=st.elements;R[0+D]=parseFloat(T[4]),R[4+D]=parseFloat(T[5]),R[8+D]=parseFloat(T[6]),R[12+D]=parseFloat(T[7])}else if("APPLY THE FOLLOWING TO CHAINS:"===ct.substr(11,30)||"                   AND CHAINS:"===ct.substr(11,30)){"APPLY"===ct.substr(11,5)&&(at=nt.addPart());for(var F=ct.substr(41,30).split(","),E=0,$=F.length;E<$;++E){var L=F[E].trim();L&&at.chainList.push(L)}}}else if("HEADER"===ut)Lt.id=ct.substr(62,4);else if("TITLE "===ut)Lt.title+=(Lt.title?" ":"")+ct.substr(10,70).trim();else if("MODEL "===ut)pe=!0;else if("ENDMDL"===ut||"END"===ct.trim()){if(pe)continue;Ut&&!Xt&&(Wt.push(new Float32Array(it)),Xt=!0),le+=1,pe=!0}else if("MTRIX"===ct.substr(0,5)){if("1"===ct[59])continue;nt&&"NCS"===nt.name||(nt=new cs("NCS"),Yt.NCS=nt,at=nt.addPart());var N=ct.split(/\s+/),z=parseInt(ct[5])-1;0===z&&(st=new fe.Matrix4,at.matrixList.push(st));var j=st.elements;j[0+z]=parseFloat(N[2]),j[4+z]=parseFloat(N[3]),j[8+z]=parseFloat(N[4]),j[12+z]=parseFloat(N[5])}else if("ORIGX"===ct.substr(0,5)){Zt.origx||(Zt.origx=new fe.Matrix4);var V=ct.split(/\s+/),G=parseInt(ct[5])-1,U=Zt.origx.elements;U[0+G]=parseFloat(V[1]),U[4+G]=parseFloat(V[2]),U[8+G]=parseFloat(V[3]),U[12+G]=parseFloat(V[4])}else if("SCALE"===ct.substr(0,5)){Zt.scale||(Zt.scale=new fe.Matrix4);var H=ct.split(/\s+/),W=parseInt(ct[5])-1,q=Zt.scale.elements;q[0+W]=parseFloat(H[1]),q[4+W]=parseFloat(H[2]),q[8+W]=parseFloat(H[3]),q[12+W]=parseFloat(H[4])}else if("CRYST1"===ut){var X=parseFloat(ct.substr(6,9)),Y=parseFloat(ct.substr(15,9)),K=parseFloat(ct.substr(24,9)),Z=parseFloat(ct.substr(33,7)),Q=parseFloat(ct.substr(40,7)),J=parseFloat(ct.substr(47,7)),tt=ct.substr(55,11).trim(),et=new Float32Array(9);et[0]=X,et[4]=Y,et[8]=K,qt.push(et),0===le&&(Zt.a=X,Zt.b=Y,Zt.c=K,Zt.alpha=Z,Zt.beta=Q,Zt.gamma=J,Zt.spacegroup=tt)}}(0,t.length,t)}),Nt.finalize();var o=Jt.length;if(o){Lt.eachChain(function(t){t.entityIndex=o}),Jt.forEach(function(t,e){var r=t.chainList.map(function(t){return re[t]});Lt.entityList.push(new Cp(Lt,e,t.name,"polymer",r))});var n=Jt.length,a=Lt.getResidueProxy(),s={};Lt.eachChain(function(t){t.entityIndex===o&&(a.index=t.residueOffset,s[a.resname]||(s[a.resname]=[]),s[a.resname].push(t.index))}),Object.keys(s).forEach(function(t){var e=s[t],r="non-polymer",i=te[t]||t;xo.includes(t)&&(r=i="water"),Lt.entityList.push(new Cp(Lt,n,i,r,e)),n+=1})}void 0!==Zt.a?Lt.unitcell=new Op(Zt):Lt.unitcell=void 0,(oe.length||ne.length)&&ds(Lt,i),Lt.finalizeAtoms(),rt||vs(Lt),bs(Lt),Lt.finalizeBonds(),oe.length||ne.length||ms(Lt),Ss(Lt),de.Debug&&me.timeEnd("PdbParser._parse "+this.name)},Object.defineProperties(t.prototype,e),t}(Sp);Ht.add("pdb",Rp),Ht.add("pdb1",Rp),Ht.add("ent",Rp);var Fp=/\s+/,Ep=/'((?:(?!'\s).)*)'|"((?:(?!"\s).)*)"|(\S+)/g,$p=/"/g,Lp=/^['"]+|['"]+$/g;function Np(t){return!t||t[0]!==t[t.length-1]||"'"!==t[0]&&'"'!==t[0]?t:t.substring(1,t.length-1)}function zp(e,t){Array.isArray(e[t])||Object.keys(e).forEach(function(t){e[t]=[e[t]]})}function jp(t){return"?"!==t}function Vp(t,e){return jp(t)?t:e}function Gp(t){switch(t.toLowerCase()){case"?":case"sing":return 1;case"doub":return 2;case"trip":return 3;case"quad":return 4}return 0}var Up=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"cif"},e.prototype._parse=function(){me.time("CifParser._parse "+this.name);var D,R,F,E,$,L,N,z,j,V,G,U,H,W,q,X,Y,K,Z,Q,J,tt=this.structure,et=this.structureBuilder,rt=this.firstModelOnly,it=this.asTrajectory,ot=this.cAlphaOnly,nt=tt.frames,at={},st={},ct={},ut=!1,ht=null,lt=!1,pt=!1,dt=!1,ft=[],mt=null,gt=null,yt=null,vt=null,bt=[],xt=tt.atomMap,_t=tt.atomStore;_t.resize(this.streamer.data.length/100);var wt,At=0,St=0;if(this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i)if(F=r[i],((E=F.trim())||ut||pt)&&"#"!==E[0])if("data_"===E.substring(0,5))at.data=E.substring(5).trim();else if(";"===E[0])ut?(pt?(mt===ft.length&&(mt=0),ft[mt].push(ht),mt+=1):!1===yt?at[gt]=ht:at[gt][yt]=ht,ut=!1,ht=null):(ut=!0,ht=E.substring(1));else if("loop_"===E)dt=pt=!0,ft.length=0,bt.length=0,mt=0;else if("_"===E[0]){var o,n,a;if(pt&&!dt&&(pt=!1),pt)n=(o=E.split("."))[0].substring(1),a=o[1],1===o.length?(a=!1,at[n]||(at[n]=[]),ft.push(at[n])):(at[n]||(at[n]={}),at[n][a]?de.Debug&&me.warn(n,a,"already exists"):(at[n][a]=[],ft.push(at[n][a]),bt.push(a))),gt=n,yt=a,vt=!0;else{var s=E.match(Ep),c=s[0],u=s[1];n=(o=c.split("."))[0].substring(1),a=o[1],1===o.length?(a=!1,at[n]=u):(at[n]||(at[n]={}),at[n][a]?de.Debug&&me.warn(n,a,"already exists"):at[n][a]=u),u||(lt=!0),gt=n,yt=a}}else if(ut)ht+=F;else if(pt){if(!E)continue;if("atom_site"===gt){var h=E.split(Fp);vt&&($=bt.indexOf("auth_asym_id"),L=bt.indexOf("auth_seq_id"),N=bt.indexOf("label_atom_id"),z=bt.indexOf("label_comp_id"),j=bt.indexOf("label_asym_id"),V=bt.indexOf("label_entity_id"),G=bt.indexOf("label_alt_id"),Y=bt.indexOf("Cartn_x"),K=bt.indexOf("Cartn_y"),Z=bt.indexOf("Cartn_z"),H=bt.indexOf("id"),W=bt.indexOf("type_symbol"),U=bt.indexOf("group_PDB"),Q=bt.indexOf("B_iso_or_equiv"),q=bt.indexOf("pdbx_PDB_model_num"),X=bt.indexOf("pdbx_PDB_ins_code"),J=bt.indexOf("occupancy"),vt=!1,wt=parseInt(h[q]),it&&(D=[],R=0));var l=parseInt(h[q]);if(wt!==l&&(it&&(0===St&&nt.push(new Float32Array(D)),D=new Float32Array(3*_t.count),nt.push(D),R=0),St+=1),wt=l,rt&&0<St)continue;var p=h[N].replace($p,"");if(ot&&"CA"!==p)continue;var d=parseFloat(h[Y]),f=parseFloat(h[K]),m=parseFloat(h[Z]);if(it){var g=3*R;if(D[g+0]=d,D[g+1]=f,D[g+2]=m,R+=1,0<St)continue}var y=h[z],v=parseInt(h[L]),b=h[X];b="?"===b?"":b;var x=h[$],_=h[j],w="H"===h[U][0]?1:0,A=h[W],S=parseFloat(h[Q]),C=parseFloat(h[J]),P=h[G];if(P="."===P?"":P,_t.growIfFull(),_t.atomTypeId[At]=xt.add(p,A),_t.x[At]=d,_t.y[At]=f,_t.z[At]=m,_t.serial[At]=parseInt(h[H]),_t.bfactor[At]=isNaN(S)?0:S,_t.occupancy[At]=isNaN(C)?0:C,_t.altloc[At]=P.charCodeAt(0),et.addAtom(St,x,_,y,v,w,void 0,b),de.Debug){var I=st[_];void 0!==I&&I!==x&&de.Debug&&me.warn(I,x)}st[_]=x;var O=h[V];ct[O]||(ct[O]=new Set),ct[O].add(tt.chainStore.count-1),At+=1}else{var k=E.match(Ep),M=k.length;mt===ft.length&&(mt=0);for(var B=0;B<M;++B)ft[mt+B].push(k[B]);mt+=M}dt=!1}else if("'"===E[0]&&"'"===E[E.length-1]){var T=E.substring(1,E.length-1);!1===yt?at[gt]=T:at[gt][yt]=T}else lt?!1===yt?at[gt]=E:at[gt][yt]=E:de.Debug&&me.log("CifParser._parse: unknown state",E);else lt=pt=ut=!1,ft.length=0,vt=yt=gt=mt=null,bt.length=0}(0,t.length,t)}),at.chem_comp&&at.chem_comp_atom)!function(t,e,r){var i,o,n=e.atomStore,a=e.atomMap,s=t.chem_comp,c=t.chem_comp_atom,u=t.chem_comp_bond;s&&(s.name&&(e.title=s.name.trim().replace(Lp,"")),s.id&&(e.id=s.id.trim().replace(Lp,"")));var h={};if(c){var l,p,d,f;for(zp(c,"comp_id"),o=c.comp_id.length,i=0;i<o;++i)n.growIfFull(),l=c.atom_id[i].replace($p,""),p=c.type_symbol[i],h[l]=i,n.atomTypeId[i]=a.add(l,p),n.x[i]=c.model_Cartn_x[i],n.y[i]=c.model_Cartn_y[i],n.z[i]=c.model_Cartn_z[i],n.serial[i]=i,d=c.pdbx_component_comp_id[i],f=c.pdbx_residue_numbering?c.pdbx_residue_numbering[i]:1,r.addAtom(0,"","",d,f,!0);for(i=0;i<o;++i){var m=i+o;n.growIfFull(),l=c.atom_id[i].replace($p,""),p=c.type_symbol[i],n.atomTypeId[m]=a.add(l,p),n.x[m]=c.pdbx_model_Cartn_x_ideal[i],n.y[m]=c.pdbx_model_Cartn_y_ideal[i],n.z[m]=c.pdbx_model_Cartn_z_ideal[i],n.serial[m]=m,d=c.pdbx_component_comp_id[i],f=c.pdbx_residue_numbering?c.pdbx_residue_numbering[i]:1,r.addAtom(1,"","",d,f,!0)}}if(c&&u){var g,y,v;zp(u,"comp_id"),o=u.comp_id.length;var b=c.comp_id.length,x=e.getAtomProxy(),_=e.getAtomProxy();for(i=0;i<o;++i)g=u.atom_id_1[i].replace($p,""),y=u.atom_id_2[i].replace($p,""),v=Gp(u.value_order[i]),x.index=h[g],_.index=h[y],e.bondStore.growIfFull(),e.bondStore.addBond(x,_,v),x.index+=b,_.index+=b,e.bondStore.growIfFull(),e.bondStore.addBond(x,_,v)}}(at,tt,et),et.finalize(),tt.finalizeAtoms(),tt.finalizeBonds(),Os(tt);else if(at.atom_site_type_symbol&&at.atom_site_label&&at.atom_site_fract_x)!function(t,e,c){var u=e.atomStore,r=e.atomMap;t.data&&(e.id=t.data,e.name=t.data),e.unitcell=new Op({a:parseFloat(t.cell_length_a),b:parseFloat(t.cell_length_b),c:parseFloat(t.cell_length_c),alpha:parseFloat(t.cell_angle_alpha),beta:parseFloat(t.cell_angle_beta),gamma:parseFloat(t.cell_angle_gamma),spacegroup:Np(t["symmetry_space_group_name_H-M"])});for(var h=new fe.Vector3,i=new fe.Vector3,l=t.atom_site_type_symbol.length,o=0;o<l;++o){u.growIfFull();var n=t.atom_site_label[o],a=t.atom_site_type_symbol[o];u.atomTypeId[o]=r.add(n,a),h.set(t.atom_site_fract_x[o],t.atom_site_fract_y[o],t.atom_site_fract_z[o]),h.applyMatrix4(e.unitcell.fracToCart),i.add(h),u.x[o]=h.x,u.y[o]=h.y,u.z[o]=h.z,t.atom_site_occupancy&&(u.occupancy[o]=parseFloat(t.atom_site_occupancy[o])),u.serial[o]=o,c.addAtom(0,"","","HET",1,!0)}i.divideScalar(l),e.center=i,Ss(e);var p=new fe.Vector3,d=new fe.Vector3,f=e.biomolDict.SUPERCELL.partList[0].matrixList,m=l;function g(t){return r.get(u.atomTypeId[t]).covalent}for(var y=new fe.Matrix4,s=function(a){var s=g(a);h.set(u.x[a],u.y[a],u.z[a]),f.forEach(function(t){if(!y.equals(t)){p.copy(h),p.applyMatrix4(t);for(var e=0;e<l;++e){d.set(u.x[e],u.y[e],u.z[e]);var r=p.distanceToSquared(d),i=g(e)+s,o=i+.3,n=i-.5;if(r<o*o&&n*n<r)return u.growIfFull(),u.atomTypeId[m]=u.atomTypeId[a],u.x[m]=p.x,u.y[m]=p.y,u.z[m]=p.z,u.occupancy[m]=u.occupancy[a],u.serial[m]=m,u.altloc[m]="A".charCodeAt(0),c.addAtom(0,"","","HET",1,!0),void(m+=1)}}})},v=0;v<l;++v)s(v)}(at,tt,et),et.finalize(),tt.finalizeAtoms(),bs(tt),tt.finalizeBonds();else{var t=function(t,e,r){var i,o,n,a,s=[],c=[],u=t.struct_conf;if(u)for(zp(u,"id"),i=0,o=u.beg_auth_seq_id.length;i<o;++i){var h=parseInt(u.pdbx_PDB_helix_class[i]);Number.isNaN(h)||(n=u.pdbx_beg_PDB_ins_code[i],a=u.pdbx_end_PDB_ins_code[i],s.push([r[u.beg_label_asym_id[i]],parseInt(u.beg_auth_seq_id[i]),Vp(n,""),r[u.end_label_asym_id[i]],parseInt(u.end_auth_seq_id[i]),Vp(a,""),(kp[h]||kp[0]).charCodeAt(0)]))}var l=t.struct_sheet_range;if(l)for(zp(l,"id"),i=0,o=l.beg_auth_seq_id.length;i<o;++i)n=l.pdbx_beg_PDB_ins_code[i],a=l.pdbx_end_PDB_ins_code[i],c.push([r[l.beg_label_asym_id[i]],parseInt(l.beg_auth_seq_id[i]),Vp(n,""),r[l.end_label_asym_id[i]],parseInt(l.end_auth_seq_id[i]),Vp(a,"")]);return!(!u&&!l)&&{helices:s,sheets:c}}(at,0,st);if(function(t,e,p){var n={},d=e.biomolDict;if(t.pdbx_struct_oper_list){var o=t.pdbx_struct_oper_list;zp(o,"id"),o.id.forEach(function(t,e){var r=new fe.Matrix4,i=r.elements;i[0]=parseFloat(o["matrix[1][1]"][e]),i[1]=parseFloat(o["matrix[1][2]"][e]),i[2]=parseFloat(o["matrix[1][3]"][e]),i[4]=parseFloat(o["matrix[2][1]"][e]),i[5]=parseFloat(o["matrix[2][2]"][e]),i[6]=parseFloat(o["matrix[2][3]"][e]),i[8]=parseFloat(o["matrix[3][1]"][e]),i[9]=parseFloat(o["matrix[3][2]"][e]),i[10]=parseFloat(o["matrix[3][3]"][e]),i[3]=parseFloat(o["vector[1]"][e]),i[7]=parseFloat(o["vector[2]"][e]),i[11]=parseFloat(o["vector[3]"][e]),r.transpose(),n[t]=r})}if(t.pdbx_struct_assembly_gen){var f=t.pdbx_struct_assembly_gen;zp(f,"assembly_id");var m=function(t){var o={};return t.replace(/[()']/g,"").split(",").forEach(function(t){if(t.includes("-"))for(var e=t.split("-"),r=parseInt(e[0]),i=parseInt(e[1]);r<=i;++r)o[r]=n[r];else o[t]=n[t]}),o};f.assembly_id.forEach(function(t,e){var i={},r=f.oper_expression[e].replace(/['"]\(|['"]/g,"");if(r.includes(")(")||0<r.indexOf("(")){r=r.split("(");var o=m(r[0]),n=m(r[1]);Object.keys(o).forEach(function(r){Object.keys(n).forEach(function(t){var e=new fe.Matrix4;e.multiplyMatrices(o[r],n[t]),i[r+"x"+t]=e})})}else i=m(r);var a=[];for(var s in i)a.push(i[s]);var c=t;/^(0|[1-9][0-9]*)$/.test(c)&&(c="BU"+c);for(var u=f.asym_id_list[e].split(","),h=0,l=u.length;h<l;++h)u[h]=p[u[h]];void 0===d[c]&&(d[c]=new cs(c)),d[c].addPart(a,u)})}if(t.struct_ncs_oper){var a=t.struct_ncs_oper;zp(a,"id"),d.NCS=new cs("NCS");var s=d.NCS.addPart();a.id.forEach(function(t,e){if("given"!==a.code[e]){var r=new fe.Matrix4,i=r.elements;i[0]=parseFloat(a["matrix[1][1]"][e]),i[1]=parseFloat(a["matrix[1][2]"][e]),i[2]=parseFloat(a["matrix[1][3]"][e]),i[4]=parseFloat(a["matrix[2][1]"][e]),i[5]=parseFloat(a["matrix[2][2]"][e]),i[6]=parseFloat(a["matrix[2][3]"][e]),i[8]=parseFloat(a["matrix[3][1]"][e]),i[9]=parseFloat(a["matrix[3][2]"][e]),i[10]=parseFloat(a["matrix[3][3]"][e]),i[3]=parseFloat(a["vector[1]"][e]),i[7]=parseFloat(a["vector[2]"][e]),i[11]=parseFloat(a["vector[3]"][e]),r.transpose(),s.matrixList.push(r)}}),0===s.matrixList.length&&delete d.NCS}var r={};if(t.cell){var i=t.cell,c=parseFloat(i.length_a),u=parseFloat(i.length_b),h=parseFloat(i.length_c),l=new Float32Array(9);l[0]=c,l[4]=u,l[8]=h,e.boxes.push(l),r.a=c,r.b=u,r.c=h,r.alpha=parseFloat(i.angle_alpha),r.beta=parseFloat(i.angle_beta),r.gamma=parseFloat(i.angle_gamma)}t.symmetry&&(r.spacegroup=Np(t.symmetry["space_group_name_H-M"]));var g=new fe.Matrix4;if(t.database_PDB_matrix){var y=t.database_PDB_matrix,v=g.elements;v[0]=parseFloat(y["origx[1][1]"]),v[1]=parseFloat(y["origx[1][2]"]),v[2]=parseFloat(y["origx[1][3]"]),v[4]=parseFloat(y["origx[2][1]"]),v[5]=parseFloat(y["origx[2][2]"]),v[6]=parseFloat(y["origx[2][3]"]),v[8]=parseFloat(y["origx[3][1]"]),v[9]=parseFloat(y["origx[3][2]"]),v[10]=parseFloat(y["origx[3][3]"]),v[3]=parseFloat(y["origx_vector[1]"]),v[7]=parseFloat(y["origx_vector[2]"]),v[11]=parseFloat(y["origx_vector[3]"]),g.transpose(),r.origx=g}var b=new fe.Matrix4;if(t.atom_sites){var x=t.atom_sites,_=b.elements;_[0]=parseFloat(x["fract_transf_matrix[1][1]"]),_[1]=parseFloat(x["fract_transf_matrix[1][2]"]),_[2]=parseFloat(x["fract_transf_matrix[1][3]"]),_[4]=parseFloat(x["fract_transf_matrix[2][1]"]),_[5]=parseFloat(x["fract_transf_matrix[2][2]"]),_[6]=parseFloat(x["fract_transf_matrix[2][3]"]),_[8]=parseFloat(x["fract_transf_matrix[3][1]"]),_[9]=parseFloat(x["fract_transf_matrix[3][2]"]),_[10]=parseFloat(x["fract_transf_matrix[3][3]"]),_[3]=parseFloat(x["fract_transf_vector[1]"]),_[7]=parseFloat(x["fract_transf_vector[2]"]),_[11]=parseFloat(x["fract_transf_vector[3]"]),b.transpose(),r.scale=b}void 0!==r.a?e.unitcell=new Op(r):e.unitcell=void 0}(at,tt,st),function(t,e,r){var i=t.struct_conn;if(i){zp(i,"id");for(var o=/"/g,n=e.getAtomProxy(),a=e.getAtomProxy(),s={},c=0,u=i.id.length;c<u;++c){var h=i.conn_type_id[c];if("hydrog"!==h&&"mismat"!==h&&"saltbr"!==h&&"1_555"===i.ptnr1_symmetry[c]&&"1_555"===i.ptnr2_symmetry[c]){var l=i.pdbx_ptnr1_PDB_ins_code[c],p=i.pdbx_ptnr1_label_alt_id[c],d=i.ptnr1_auth_seq_id[c]+(jp(l)?"^"+l:"")+":"+r[i.ptnr1_label_asym_id[c]]+"."+i.ptnr1_label_atom_id[c].replace(o,"")+(jp(p)?"%"+p:""),f=s[d];if(!f){var m=new Ct(d);if(m.selection.error){de.Debug&&me.warn("invalid selection for connection",d);continue}f=e.getAtomIndices(m),s[d]=f}var g=i.pdbx_ptnr2_PDB_ins_code[c],y=i.pdbx_ptnr2_label_alt_id[c],v=i.ptnr2_auth_seq_id[c]+(jp(g)?"^"+g:"")+":"+r[i.ptnr2_label_asym_id[c]]+"."+i.ptnr2_label_atom_id[c].replace(o,"")+(jp(y)?"%"+y:""),b=s[v];if(!b){var x=new Ct(v);if(x.selection.error){de.Debug&&me.warn("invalid selection for connection",v);continue}b=e.getAtomIndices(x),s[v]=b}var _=f.length,w=b.length;if(w<_){var A=_;_=w,w=A;var S=f;f=b,b=S}if(0!==_&&0!==w)for(var C=0;C<w;++C)n.index=f[C%_],a.index=b[C],n&&a?e.bondStore.addBond(n,a,Gp(i.pdbx_value_order[c])):me.log("atoms for connection not found");else de.Debug&&me.warn("no atoms found for",d,v)}}}}(at,tt,st),function(t,e,r){if(t.entity){zp(t.entity,"id");for(var i=t.entity,o=i.id.length,n=0;n<o;++n){var a=i.pdbx_description[n],s=i.type[n],c=Array.from(r[i.id[n]]);e.entityList[n]=new Cp(e,n,a,s,c)}}}(at,tt,ct),at.struct&&at.struct.title&&(tt.title=at.struct.title.trim().replace(Lp,"")),at.entry&&at.entry.id&&(tt.id=at.entry.id.trim().replace(Lp,"")),at.pdbx_audit_revision_history){if(at.pdbx_audit_revision_history.revision_date){zp(at.pdbx_audit_revision_history,"revision_date");var e=at.pdbx_audit_revision_history.revision_date.filter(jp);e.length&&(tt.header.releaseDate=e[0])}if(at.pdbx_database_status.recvd_initial_deposition_date){zp(at.pdbx_database_status,"recvd_initial_deposition_date");var r=at.pdbx_database_status.recvd_initial_deposition_date.filter(jp);r.length&&(tt.header.depositionDate=r[0])}}else if(at.database_PDB_rev){if(at.database_PDB_rev.date){zp(at.database_PDB_rev,"date");var i=at.database_PDB_rev.date.filter(jp);i.length&&(tt.header.releaseDate=i[0])}if(at.database_PDB_rev.date_original){zp(at.database_PDB_rev,"date_original");var o=at.database_PDB_rev.date_original.filter(jp);o.length&&(tt.header.depositionDate=o[0])}}at.reflns&&at.reflns.d_resolution_high?jp(at.reflns.d_resolution_high)&&(tt.header.resolution=parseFloat(at.reflns.d_resolution_high)):at.refine&&at.refine.ls_d_res_high&&jp(at.refine.ls_d_res_high)&&(tt.header.resolution=parseFloat(at.refine.ls_d_res_high)),at.refine&&at.refine.ls_R_factor_R_free&&jp(at.refine.ls_R_factor_R_free)&&(tt.header.rFree=parseFloat(at.refine.ls_R_factor_R_free)),at.refine&&at.refine.ls_R_factor_R_work&&jp(at.refine.ls_R_factor_R_work)&&(tt.header.rWork=parseFloat(at.refine.ls_R_factor_R_work)),at.exptl&&at.exptl.method&&(zp(at.exptl,"method"),tt.header.experimentalMethods=at.exptl.method.map(function(t){return t.replace(Lp,"")})),et.finalize(),tt.finalizeAtoms(),bs(tt),tt.finalizeBonds(),t?ds(tt,t):ms(tt),Ss(tt),tt.extraData.cif=at}de.Debug&&me.timeEnd("CifParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("cif",Up),Ht.add("mcif",Up),Ht.add("mmcif",Up);var Hp=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"gro"},e.prototype._parse=function(){de.Debug&&me.time("GroParser._parse "+this.name);var p,d,t=this.structure,f=this.structureBuilder,m=this.firstModelOnly,g=this.asTrajectory,y=this.cAlphaOnly,v=t.frames,b=t.boxes,e=this.streamer.peekLines(3);t.title=e[0].trim();var x,_,w,A,S=5+(e[2].length-e[2].lastIndexOf(".")-1),C=20,P=20+S,I=20+2*S,O=parseInt(e[1]),k=O+3,M=t.atomMap,B=t.atomStore;B.resize(O);var T=0,D=0,R=0;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=++R-1,n=r[i];if(n)if(o%k==0)g&&(p=new Float32Array(3*O),v.push(p),d=0);else if(o%k==1);else if(o%k==k-1){var a=n.trim().split(/\s+/),s=new Float32Array(9);if(s[0]=10*parseFloat(a[0]),s[4]=10*parseFloat(a[1]),s[8]=10*parseFloat(a[2]),b.push(s),m)return;D+=1}else{if(x=n.substr(10,5).trim(),y&&"CA"!==x)continue;var c=10*parseFloat(n.substr(C,S)),u=10*parseFloat(n.substr(P,S)),h=10*parseFloat(n.substr(I,S));if(g){var l=3*d;if(p[l+0]=c,p[l+1]=u,p[l+2]=h,d+=1,k<o)continue}_=n.substr(5,5).trim(),w=parseInt(n.substr(0,5)),A=parseInt(n.substr(15,5)),B.growIfFull(),B.atomTypeId[T]=M.add(x),B.x[T]=c,B.y[T]=u,B.z[T]=h,B.serial[T]=A,f.addAtom(D,"","",_,w,0,"l"),T+=1}}}(0,t.length,t)}),f.finalize(),t.finalizeAtoms(),vs(t),bs(t),t.finalizeBonds(),ms(t),de.Debug&&me.timeEnd("GroParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("gro",Hp);var Wp=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"].concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]);function qp(t,e,r){return e?new t(e.buffer,e.byteOffset,e.byteLength/(r||1)):void 0}function Xp(t){return qp(DataView,t)}function Yp(t){return qp(Int8Array,t)}function Kp(t){return qp(Int32Array,t,4)}function Zp(t,e){var r=t.length/2;e||(e=new Int16Array(r));for(var i=0,o=0;i<r;++i,o+=2)e[i]=t[o]<<8^t[o+1]<<0;return e}function Qp(t,e){var r=t.length/4;e||(e=new Int32Array(r));for(var i=0,o=0;i<r;++i,o+=4)e[i]=t[o]<<24^t[o+1]<<16^t[o+2]<<8^t[o+3]<<0;return e}function Jp(t,e,r){var i=t.length,o=1/e;r||(r=new Float32Array(i));for(var n=0;n<i;++n)r[n]=t[n]*o;return r}function td(t,e){var r,i;if(!e){var o=0;for(r=0,i=t.length;r<i;r+=2)o+=t[r+1];e=new t.constructor(o)}var n=0;for(r=0,i=t.length;r<i;r+=2)for(var a=t[r],s=t[r+1],c=0;c<s;++c)e[n]=a,++n;return e}function ed(t,e){var r=t.length;e||(e=new t.constructor(r)),r&&(e[0]=t[0]);for(var i=1;i<r;++i)e[i]=t[i]+e[i-1];return e}function rd(t,e){var r,i,o=t instanceof Int8Array?127:32767,n=-o-1,a=t.length;if(!e){var s=0;for(r=0;r<a;++r)t[r]<o&&t[r]>n&&++s;e=new Int32Array(s)}for(i=r=0;r<a;){for(var c=0;t[r]===o||t[r]===n;)c+=t[r],++r;c+=t[r],++r,e[i]=c,++i}return e}function id(t,e,r){return Jp(rd(t,Kp(r)),e,r)}function od(t,e,r){var i,o,n,a=rd(t,Kp(r));return o=e,n=qp(Float32Array,i=a,4),Jp(ed(i,Kp(n)),o,n)}function nd(o){var n=0,i=new DataView(o.buffer);function a(t){for(var e={},r=0;r<t;r++){e[h()]=h()}return e}function s(t){var e=o.subarray(n,n+t);return n+=t,e}function c(t){var e=o.subarray(n,n+t);n+=t;if(65535<t){for(var r=[],i=0;i<e.length;i+=65535)r.push(String.fromCharCode.apply(null,e.subarray(i,i+65535)));return r.join("")}return String.fromCharCode.apply(null,e)}function u(t){for(var e=new Array(t),r=0;r<t;r++)e[r]=h();return e}function h(){var t,e,r=o[n];if(0==(128&r))return n++,r;if(128==(240&r))return n++,a(e=15&r);if(144==(240&r))return n++,u(e=15&r);if(160==(224&r))return n++,c(e=31&r);if(224==(224&r))return t=i.getInt8(n),n++,t;switch(r){case 192:return n++,null;case 194:return n++,!1;case 195:return n++,!0;case 196:return e=i.getUint8(n+1),n+=2,s(e);case 197:return e=i.getUint16(n+1),n+=3,s(e);case 198:return e=i.getUint32(n+1),n+=5,s(e);case 202:return t=i.getFloat32(n+1),n+=5,t;case 203:return t=i.getFloat64(n+1),n+=9,t;case 204:return t=o[n+1],n+=2,t;case 205:return t=i.getUint16(n+1),n+=3,t;case 206:return t=i.getUint32(n+1),n+=5,t;case 208:return t=i.getInt8(n+1),n+=2,t;case 209:return t=i.getInt16(n+1),n+=3,t;case 210:return t=i.getInt32(n+1),n+=5,t;case 217:return e=i.getUint8(n+1),n+=2,c(e);case 218:return e=i.getUint16(n+1),n+=3,c(e);case 219:return e=i.getUint32(n+1),n+=5,c(e);case 220:return e=i.getUint16(n+1),n+=3,u(e);case 221:return e=i.getUint32(n+1),n+=5,u(e);case 222:return e=i.getUint16(n+1),n+=3,a(e);case 223:return e=i.getUint32(n+1),n+=5,a(e)}throw new Error("Unknown type 0x"+r.toString(16))}return h()}function ad(t,e,r,i){switch(t){case 1:return function(t,e){var r=t.length;e||(e=new Float32Array(r/4));for(var i=Xp(e),o=Xp(t),n=0,a=0,s=r/4;n<s;++n,a+=4)i.setFloat32(a,o.getFloat32(a),!0);return e}(e);case 2:return Yp(e);case 3:return Zp(e);case 4:return Qp(e);case 5:return qp(Uint8Array,e);case 6:return td(Qp(e),new Uint8Array(r));case 7:return td(Qp(e));case 8:return ed(td(Qp(e)),s);case 9:return o=Qp(e),n=Qp(i)[0],Jp(td(o,Kp(a)),n,a);case 10:return od(Zp(e),Qp(i)[0]);case 11:return Jp(Zp(e),Qp(i)[0]);case 12:return id(Zp(e),Qp(i)[0]);case 13:return id(Yp(e),Qp(i)[0]);case 14:return rd(Zp(e));case 15:return rd(Yp(e))}var o,n,a,s}function sd(c,t){var u=(t=t||{}).ignoreFields,h={};return Wp.forEach(function(t){var e,r,i,o,n,a=!!u&&-1!==u.indexOf(t),s=c[t];a||void 0===s||(s instanceof Uint8Array?h[t]=ad.apply(null,(r=Xp(e=s),i=r.getInt32(0),o=r.getInt32(4),n=e.subarray(8,12),[i,e=e.subarray(12),o,n])):h[t]=s)}),h}var cd={0:"i".charCodeAt(0),1:"s".charCodeAt(0),2:"h".charCodeAt(0),3:"e".charCodeAt(0),4:"g".charCodeAt(0),5:"b".charCodeAt(0),6:"t".charCodeAt(0),7:"l".charCodeAt(0),"-1":"".charCodeAt(0)},ud=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"mmtf"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){var t,e,r,i,o;de.Debug&&me.time("MmtfParser._parse "+this.name);var n,a,s,c,u,h,l=this.structure,p=sd(nd(this.streamer.data));if(["depositionDate","releaseDate","resolution","rFree","rWork","experimentalMethods"].forEach(function(t){void 0!==p[t]&&(l.header[t]=p[t])}),l.id=p.structureId,l.title=p.title,l.atomStore.addField("formalCharge",1,"int8"),this.firstModelOnly||this.asTrajectory){for(u=1,t=s=0,e=c=p.chainsPerModel[0];t<e;++t)s+=p.groupsPerChain[t];for(t=a=0,e=s;t<e;++t)a+=(o=p.groupList[p.groupTypeList[t]]).atomNameList.length;n=p.numBonds,h=[c]}else n=p.numBonds,a=p.numAtoms,s=p.numGroups,c=p.numChains,u=p.numModels,h=p.chainsPerModel;if(n+=s,this.asTrajectory)for(t=0,e=p.numModels;t<e;++t){var d=new Float32Array(3*a),f=a*t;for(r=0;r<a;++r){var m=3*r,g=r+f;d[m]=p.xCoordList[g],d[m+1]=p.yCoordList[g],d[m+2]=p.zCoordList[g]}l.frames.push(d)}var y=new Uint32Array(n),v=new Uint32Array(n),b=new Uint8Array(n),x=new Uint32Array(a),_=new Int8Array(a),w=new Uint32Array(s),A=new Uint32Array(s),S=new Uint16Array(s),C=new Uint16Array(c),P=new Uint32Array(c),I=new Uint32Array(c),O=new Uint32Array(u),k=new Uint32Array(u),M=0;for(t=0,e=u;t<e;++t){var B=h[t];for(O[t]=M,k[t]=B,r=0;r<B;++r)C[r+M]=t;M+=B}var T=p.groupsPerChain,D=0;for(t=0,e=c;t<e;++t){var R=T[t];for(P[t]=D,I[t]=R,r=0;r<R;++r)w[r+D]=t;D+=R}var F=0,E=0;for(t=0,e=s;t<e;++t){var $=(o=p.groupList[p.groupTypeList[t]]).atomNameList.length,L=o.formalChargeList,N=o.bondAtomList,z=o.bondOrderList;for(r=0,i=z.length;r<i;++r)y[E]=F+N[2*r],v[E]=F+N[2*r+1],b[E]=z[r],E+=1;for(A[t]=F,S[t]=$,r=0;r<$;++r)x[F]=t,_[F]=L[r],F+=1}var j=p.bondAtomList;if(j)for(p.bondOrderList&&b.set(p.bondOrderList,E),t=0,e=j.length;t<e;t+=2){var V=j[t],G=j[t+1];V<a&&G<a&&(y[E]=V,v[E]=G,E+=1)}l.bondStore.length=b.length,l.bondStore.count=E,l.bondStore.atomIndex1=y,l.bondStore.atomIndex2=v,l.bondStore.bondOrder=b,l.atomStore.length=a,l.atomStore.count=a,l.atomStore.residueIndex=x,l.atomStore.atomTypeId=new Uint16Array(a),l.atomStore.x=p.xCoordList.subarray(0,a),l.atomStore.y=p.yCoordList.subarray(0,a),l.atomStore.z=p.zCoordList.subarray(0,a),l.atomStore.serial=p.atomIdList.subarray(0,a),l.atomStore.bfactor=p.bFactorList.subarray(0,a),l.atomStore.altloc=p.altLocList.subarray(0,a),l.atomStore.occupancy=p.occupancyList.subarray(0,a),l.atomStore.formalCharge=_,l.residueStore.length=s,l.residueStore.count=s,l.residueStore.chainIndex=w,l.residueStore.residueTypeId=p.groupTypeList,l.residueStore.atomOffset=A,l.residueStore.atomCount=S,l.residueStore.resno=p.groupIdList.subarray(0,s),l.residueStore.sstruc=p.secStructList.subarray(0,s),l.residueStore.inscode=p.insCodeList.subarray(0,s),l.chainStore.length=c,l.chainStore.count=c,l.chainStore.entityIndex=new Uint16Array(c),l.chainStore.modelIndex=C,l.chainStore.residueOffset=P,l.chainStore.residueCount=I,l.chainStore.chainname=p.chainNameList.subarray(0,4*c),l.chainStore.chainid=p.chainIdList.subarray(0,4*c),l.modelStore.length=u,l.modelStore.count=u,l.modelStore.chainOffset=O,l.modelStore.chainCount=k;var U={};for(t=0,e=p.groupList.length;t<e;++t){var H=p.groupList[t],W=[];for(r=0,i=H.atomNameList.length;r<i;++r){var q=H.elementList[r].toUpperCase(),X=H.atomNameList[r];W.push(l.atomMap.add(X,q))}var Y=H.chemCompType.toUpperCase(),K=ro.includes(Y),Z=H.bondOrderList.length,Q=new Array(Z),J=new Array(Z);for(r=0;r<Z;++r)Q[r]=H.bondAtomList[2*r],J[r]=H.bondAtomList[2*r+1];var tt={atomIndices1:Q,atomIndices2:J,bondOrders:H.bondOrderList};U[t]=l.residueMap.add(H.groupName,W,K,Y,tt)}for(t=0,e=s;t<e;++t)l.residueStore.residueTypeId[t]=U[l.residueStore.residueTypeId[t]];for(t=0,e=l.atomStore.count;t<e;++t){var et=l.atomStore.residueIndex[t],rt=l.residueMap.list[l.residueStore.residueTypeId[et]],it=l.residueStore.atomOffset[et];l.atomStore.atomTypeId[t]=rt.atomTypeIdList[t-it]}if(p.secStructList){var ot=p.secStructList.length;for(t=0,e=l.residueStore.count;t<e;++t){var nt=cd[l.residueStore.sstruc[t%ot]];void 0!==nt&&(l.residueStore.sstruc[t]=nt)}}if(p.entityList&&p.entityList.forEach(function(t,e){l.entityList[e]=new Cp(l,e,t.description,t.type,t.chainIndexList)}),p.bioAssemblyList&&p.bioAssemblyList.forEach(function(t,e){var r=e+1,o=new cs(""+r);l.biomolDict["BU"+r]=o;var n={};t.transformList.forEach(function(t){var e=(new fe.Matrix4).fromArray(t.matrix).transpose(),r=t.chainIndexList.map(function(t){for(var e="",r=0;r<4;++r){var i=p.chainNameList[4*t+r];if(!i)break;e+=String.fromCharCode(i)}return e}),i=n[r.toString()];i?i.matrixList.push(e):n[r.toString()]=o.addPart([e],r)})}),p.ncsOperatorList){var at=new cs("NCS"),st=at.addPart();p.ncsOperatorList.forEach(function(t){var e=(new fe.Matrix4).fromArray(t).transpose();st.matrixList.push(e)}),0<st.matrixList.length&&(l.biomolDict.NCS=at)}var ct=p.unitCell;ct&&Array.isArray(ct)&&ct[0]?l.unitcell=new Op({a:ct[0],b:ct[1],c:ct[2],alpha:ct[3],beta:ct[4],gamma:ct[5],spacegroup:p.spaceGroup}):l.unitcell=void 0,As(l,!0),ws(l,!0),l.finalizeAtoms(),l.finalizeBonds(),Ss(l),de.Debug&&me.timeEnd("MmtfParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("mmtf",ud);var hd=/\s+/,ld={1:1,2:2,3:3,am:1,ar:1,du:1,un:1,nc:0},pd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"mol2"},e.prototype._parse=function(){de.Debug&&me.time("Mol2Parser._parse "+this.name);var b,x,_=this.structure,w=this.structureBuilder,A=this.firstModelOnly,S=this.asTrajectory,C=_.frames,P=!1,I=_.atomMap,O=_.atomStore;O.resize(Math.round(this.streamer.data.length/60)),O.addField("partialCharge",1,"float32");var k=0,M=0,B=0,T=-1,D=0,R=0,F=1,E=2,$=3,L=_.getAtomProxy(),N=_.getAtomProxy();this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i].trim();if(""!==o&&"#"!==o[0])if("@"===o[0])"@<TRIPOS>MOLECULE"===o?(R=F,M=0,++T):"@<TRIPOS>ATOM"===o?(R=E,B=O.count,S&&(x=0,b=new Float32Array(3*D),C.push(b),0<T&&(P=!0))):R="@<TRIPOS>BOND"===o?$:0;else if(R===F){if(0===M)_.title=o,_.id=o;else if(1===M){var n=o.split(hd);D=parseInt(n[0])}++M}else if(R===E){var a=o.split(hd);if(A&&0<T)continue;var s=parseFloat(a[2]),c=parseFloat(a[3]),u=parseFloat(a[4]);if(S){var h=3*x;if(b[h+0]=s,b[h+1]=c,b[h+2]=u,x+=1,P)continue}var l=a[0],p=a[1],d=a[5].split(".")[0],f=a[6]?parseInt(a[6]):1,m=a[7]?a[7]:"",g=a[8]?parseFloat(a[8]):0;O.growIfFull(),O.atomTypeId[k]=I.add(p,d),O.x[k]=s,O.y[k]=c,O.z[k]=u,O.serial[k]=l,O.partialCharge[k]=g,w.addAtom(T,"","",m,f,1),k+=1}else if(R===$){if(A&&0<T)continue;if(S&&0<T)continue;var y=o.split(hd);L.index=parseInt(y[1])-1+B,N.index=parseInt(y[2])-1+B;var v=ld[y[3]];_.bondStore.addBond(L,N,v)}}}(0,t.length,t)}),w.finalize(),_.finalizeAtoms(),vs(_),ws(_,!0),As(_,!0),_.finalizeBonds(),Os(_),ms(_),de.Debug&&me.timeEnd("Mol2Parser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("mol2",pd);var dd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"pdbqt"},Object.defineProperties(e.prototype,r),e}(Rp);Ht.add("pdbqt",dd);var fd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"pqr"},Object.defineProperties(e.prototype,r),e}(Rp);Ht.add("pqr",fd);var md=/> <(.+)>/,gd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"sdf"},e.prototype._parse=function(){de.Debug&&me.time("SdfParser._parse "+this.name);var y=this.structure,v=this.structureBuilder,b=this.firstModelOnly,x=this.asTrajectory,t=this.streamer.peekLines(2);y.id=t[0].trim(),y.title=t[1].trim();var _,w,A=y.frames,S=!1,C=y.atomMap,P=y.atomStore;P.resize(Math.round(this.streamer.data.length/50)),P.addField("formalCharge",1,"int8");var I,O,k,M,B,T,D,R=y.getAtomProxy(),F=y.getAtomProxy(),E=0,$=0,L=0,N=0,z=[],j=!1,V={};y.extraData.sdf=z,this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i];if("$$$$"===o.substr(0,4))$=-1,++L,N=P.count,z.push(V),j=!(V={});else if(3===$)O=parseInt(o.substr(0,3)),k=parseInt(o.substr(3,3)),D=(T=B=(M=4)+O)+k,x&&(w=0,_=new Float32Array(3*O),A.push(_),0<L&&(S=!0));else if(M<=$&&$<B){if(b&&0<L)continue;var n=parseFloat(o.substr(0,10)),a=parseFloat(o.substr(10,10)),s=parseFloat(o.substr(20,10));if(x){var c=3*w;if(_[c+0]=n,_[c+1]=a,_[c+2]=s,w+=1,S)continue}var u=o.substr(31,3).trim(),h=u+(E+1);P.growIfFull(),P.atomTypeId[E]=C.add(h,u),P.x[E]=n,P.y[E]=a,P.z[E]=s,P.serial[E]=E,P.formalCharge[E]=0,v.addAtom(L,"","","HET",1,1),E+=1}else if(T<=$&&$<D){if(b&&0<L)continue;if(x&&0<L)continue;R.index=parseInt(o.substr(0,3))-1+N,F.index=parseInt(o.substr(3,3))-1+N;var l=parseInt(o.substr(6,3));y.bondStore.addBond(R,F,l)}else if(o.match(/M {2}CHG/))for(var p=parseInt(o.substr(6,3)),d=0,f=10;d<p;++d,f+=8){var m=parseInt(o.substr(f,3))-1+N,g=parseInt(o.substr(f+4,3));P.formalCharge[m]=g}else(I=o.match(md))?(j=I[1],V[j]=[]):!1!==j&&o&&V[j].push(o);++$}}(0,t.length,t)}),v.finalize(),y.finalizeAtoms(),y.finalizeBonds(),Os(y),de.Debug&&me.timeEnd("SdfParser._parse "+this.name)},e.prototype._postProcess=function(){Os(this.structure)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("sdf",gd),Ht.add("sd",gd),Ht.add("mol",gd);function yd(t,e,r){return parseInt(t.substr(e,r).trim())}var vd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"prmtop"},e.prototype._parse=function(){de.Debug&&me.time("PrmtopParser._parse "+this.name);var t=this.structure,e=this.structureBuilder,r=t.atomMap,P=t.atomStore;P.addField("partialCharge",1,"float32"),P.addField("radius",1,"float32");var I,O,k,M,B,T=[],D={},R=["NATOM","NTYPES","NBONH","MBONA","NTHETH","MTHETA","NPHIH","MPHIA","NHPARM","NPARM","NNB","NRES","NBONA","NTHETA","NPHIA","NUMBND","NUMANG","NPTRA","NATYP","NPHB","IFPERT","NBPER","NGPER","NDPER","MBPER","MGPER","MDPER","IFBOX","NMXRS","IFCAP","NUMEXTRA","NCOPY"];R.forEach(function(t){D[t]=0});var F,E,$,L,N,z=new Uint8Array(0);this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i],n=o.trim();if(n)if(o.startsWith("%FORMAT"));else if(o.startsWith("%FLAG")){var a=o.substr(5).trim();L=0,"TITLE"===a?$=0:"POINTERS"===a?$=1:"ATOM_NAME"===a?$=2:"CHARGE"===a?$=3:"MASS"===a?$=4:"RESIDUE_LABEL"===a?$=5:"RESIDUE_POINTER"===a?$=6:"BONDS_INC_HYDROGEN"===a?(N=0,$=7):"BONDS_WITHOUT_HYDROGEN"===a?(N=D.NBONH,$=8):$="RADII"===a?9:void 0}else if(0===$)T.push(n);else if(1===$){for(var s=Math.min(L+10,32),c=0;L<s;++c,++L)D[R[L]]=parseInt(o.substr(8*c,8).trim());I=new Array(D.NATOM),O=new Float32Array(D.NATOM),k=new Float32Array(D.NATOM),P.resize(D.NATOM);var u=D.NBONH+D.MBONA;M=new Uint32Array(u),B=new Uint32Array(u),z=new Uint8Array(u),F=new Array(D.NRES),E=new Uint32Array(D.NRES)}else if(2===$)for(var h=Math.min(L+20,D.NATOM),l=0;L<h;++l,++L)I[L]=o.substr(4*l,4).trim();else if(3===$)for(var p=Math.min(L+5,D.NATOM),d=0;L<p;++d,++L)O[L]=parseFloat(o.substr(16*d,16))/18.2223;else if(4===$);else if(5===$)for(var f=Math.min(L+20,D.NRES),m=0;L<f;++m,++L)F[L]=o.substr(4*m,4).trim();else if(6===$)for(var g=Math.min(L+10,D.NRES),y=0;L<g;++y,++L)E[L]=yd(o,8*y,8);else if(7===$)for(var v=Math.min(L+10,3*D.NBONH),b=0;L<v;++b,++L){var x=L%3;0===x&&(M[N]=yd(o,8*b,8)/3),1===x&&(B[N]=yd(o,8*b,8)/3,z[N]=1,++N)}else if(8===$)for(var _=Math.min(L+10,3*D.MBONA),w=0;L<_;++w,++L){var A=L%3;0===A&&(M[N]=yd(o,8*w,8)/3),1===A&&(B[N]=yd(o,8*w,8)/3,z[N]=1,++N)}else if(9===$)for(var S=Math.min(L+5,D.NATOM),C=0;L<S;++C,++L)k[L]=parseFloat(o.substr(16*C,16))}}(0,t.length,t)}),t.title=T.join(" ");for(var i=D.NATOM,o=0,n=F[0],a=1,s=0;s<i;++s)s+1===E[o+1]&&(n=F[++o],a=o+1),P.atomTypeId[s]=r.add(I[s]),P.serial[s]=s+1,e.addAtom(0,"","",n,a);P.partialCharge.set(O),P.radius.set(k),t.bondStore.length=z.length,t.bondStore.count=z.length,t.bondStore.atomIndex1=M,t.bondStore.atomIndex2=B,t.bondStore.bondOrder=z,e.finalize(),t.finalizeAtoms(),t.finalizeBonds(),ws(t,!0),As(t,!0,!0),vs(t,!0),Os(t),de.Debug&&me.timeEnd("PrmtopParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("prmtop",vd),Ht.add("parm7",vd);var bd=/\s+/,xd=/(^\*|REMARK)*/,_d=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"psf"},e.prototype._parse=function(){de.Debug&&me.time("PsfParser._parse "+this.name);var t=this.structure,y=this.structureBuilder,v=t.atomMap,b=t.atomStore;b.addField("partialCharge",1,"float32");var x,_,w,A,S,C,P=[],I=0,O=0,k=0;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i].trim();if(o)if(2===x){var n=o.split(bd),a=parseInt(n[0]),s=n[1],c=parseInt(n[2]),u=n[3],h=n[4],l=parseFloat(n[6]);s!==w&&(_=ys(O),++O),b.growIfFull(),b.atomTypeId[I]=v.add(h),b.serial[I]=a,b.partialCharge[I]=l,y.addAtom(0,_,_,u,c),I+=1,w=s}else if(3===x)for(var p=o.split(bd),d=0,f=p.length;d<f;d+=2)A[k]=parseInt(p[d])-1,S[k]=parseInt(p[d+1])-1,C[k]=1,k+=1;else if(1===x)P.push(o.replace(xd,"").trim());else if(4===x);else if(5===x);else if(6===x);else if(o.includes("!NATOM")){x=2;var m=parseInt(o.split(bd)[0]);b.resize(m)}else if(o.includes("!NBOND")){x=3;var g=parseInt(o.split(bd)[0]);A=new Uint32Array(g),S=new Uint32Array(g),C=new Uint8Array(g)}else o.includes("!NTITLE")?x=1:o.includes("!NTHETA")?x=4:o.includes("!NPHI")?x=5:o.includes("!NIMPHI")&&(x=6);else x=void 0}}(0,t.length,t)}),t.title=P.join(" "),t.bondStore.length=C.length,t.bondStore.count=k,t.bondStore.atomIndex1=A,t.bondStore.atomIndex2=S,t.bondStore.bondOrder=C,y.finalize(),t.finalizeAtoms(),t.finalizeBonds(),ws(t,!0),As(t,!0,!0),Os(t),de.Debug&&me.timeEnd("PsfParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("psf",_d);var wd=/\[ (.+) \]/,Ad=/\s+/,Sd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"top"},e.prototype._parse=function(){de.Debug&&me.time("TopParser._parse "+this.name);var d=this.structure,s=this.structureBuilder,c=d.atomMap,u=d.bondStore,h=d.atomStore;h.addField("partialCharge",1,"float32");var f,m,g=[],y={};this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i],n=o.trim();if(n&&"*"!==n[0]&&";"!==n[0]){if(n.startsWith("#include"))throw new Error("TopParser: #include statements not allowed");var a=o.match(wd);if(null===a){var s=n.indexOf(";");if(-1!==s&&(n=n.substring(0,s).trim()),2===m){var c=n.split(Ad)[0];y[c]=f}else if(3===m){var u=n.split(Ad);f.atoms.push([parseInt(u[2]),u[3],u[4],parseFloat(u[6])])}else if(4===m){var h=n.split(Ad);f.bonds.push([parseInt(h[0]),parseInt(h[1])])}else if(0===m)d.title=n;else if(1===m){var l=n.split(Ad);g.push([l[0],parseInt(l[1])])}}else{var p=a[1];"moleculetype"===p?(m=2,f={atoms:[],bonds:[]}):m="atoms"===p?3:"bonds"===p?4:"system"===p?0:"molecules"===p?1:void 0}}}}(0,t.length,t)});var o=0,n=0;g.forEach(function(t){var e=t[0],r=t[1],i=y[e];o+=r*i.atoms.length,n+=r*i.bonds.length}),h.resize(o),u.resize(n);var l,p=0,v=0,b=0,x=0,_=0,w=0;g.forEach(function(t){for(var e=t[0],r=t[1],i=y[e],a=ys(x),o=function(t){l=-1;var n=xo.includes(e)?a:ys(b);i.atoms.forEach(function(t){var e=t[0],r=t[1],i=t[2],o=t[3];e!==l&&++v,h.atomTypeId[p]=c.add(i),h.serial[p]=p+1,h.partialCharge[p]=o,s.addAtom(0,a,n,r,v+1),++p,l=e}),i.bonds.forEach(function(t){u.atomIndex1[_]=w+t[0]-1,u.atomIndex2[_]=w+t[1]-1,++_}),++b,w+=i.atoms.length},n=0;n<r;++n)o();++x}),u.count=n,s.finalize(),d.finalizeAtoms(),d.finalizeBonds(),ws(d,!0),As(d,!0,!0),Os(d),de.Debug&&me.timeEnd("TopParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Sp);Ht.add("top",Sd);var Cd=function(r){function t(t,e){r.call(this,t,e),this.frames=new Yc(this.name,this.path)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"trajectory"},e.__objName.get=function(){return"frames"},Object.defineProperties(t.prototype,e),t}(wp),Pd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dcd"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("DcdParser._parse "+this.name);var t=L(this.streamer.data),e=new DataView(t),r=this.frames,i=r.coordinates,o=r.boxes,n={},a=0,s=new Int32Array(t,0,23),c=s[0]!==e.getInt32(0);if(84!==s[0])for(var u=t.byteLength,h=0;h<u;h+=4)e.setFloat32(h,e.getFloat32(h),!0);84!==s[0]&&me.error("dcd bad format, header block start"),"CORD"!==String.fromCharCode(e.getUint8(4),e.getUint8(5),e.getUint8(6),e.getUint8(7))&&me.error("dcd bad format, format string");var l=!1,p=!1,d=!1;0!==s[22]&&(l=!0,0!==s[12]&&(p=!0),1===s[13]&&(d=!0)),n.NSET=s[2],n.ISTART=s[3],n.NSAVC=s[4],n.NAMNF=s[10],n.DELTA=l?e.getFloat32(44,c):e.getFloat64(44,c),84!==s[22]&&me.error("dcd bad format, header block end"),a=a+84+8;var f=e.getInt32(a,c),m=a+1;if((f-4)%80!=0&&me.error("dcd bad format, title block start"),n.TITLE=C(new Uint8Array(t,m,f)),e.getInt32(m+f+4-1,c)!==f&&me.error("dcd bad format, title block end"),a=a+f+8,4!==e.getInt32(a,c)&&me.error("dcd bad format, natom block start"),n.NATOM=e.getInt32(a+4,c),4!==e.getInt32(a+8,c)&&me.error("dcd bad format, natom block end"),a=a+4+8,0<n.NAMNF)me.error("dcd format with fixed atoms unsupported, aborting");else{for(var g=n.NATOM,y=4*g,v=0,b=n.NSET;v<b;++v){if(p){a+=4;var x=new Float32Array(9);x[0]=e.getFloat64(a,c),x[4]=e.getFloat64(a+16,c),x[8]=e.getFloat64(a+40,c),o.push(x),a+=48,a+=4}for(var _=new Float32Array(3*g),w=0;w<3;++w){e.getInt32(a,c)!==y&&me.error("dcd bad format, coord block start",v,w),a+=4;for(var A=new Float32Array(t,a,g),S=0;S<g;++S)_[3*S+w]=A[S];a+=y,e.getInt32(a,c)!==y&&me.error("dcd bad format, coord block end",v,w),a+=4}if(i.push(_),d)a+=4+e.getInt32(a,c)+4}n.DELTA&&(r.deltaTime=20.45482949774598*n.DELTA),1<=n.ISTART&&(r.timeOffset=(n.ISTART-1)*r.deltaTime),de.Debug&&me.timeEnd("DcdParser._parse "+this.name)}},Object.defineProperties(e.prototype,r),e}(Cd);function Id(t,e){if(t)throw new TypeError("Not a valid NetCDF v3.x file: "+e)}function Od(t){t.offset%4!=0&&t.skip(4-t.offset%4)}function kd(t){var e=t.readUint32(),r=t.readChars(e);return Od(t),r}Ht.add("dcd",Pd);var Md={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function Bd(t){switch(Number(t)){case Md.BYTE:return"byte";case Md.CHAR:return"char";case Md.SHORT:return"short";case Md.INT:return"int";case Md.FLOAT:return"float";case Md.DOUBLE:return"double";default:return"undefined"}}function Td(t){switch(Number(t)){case Md.BYTE:case Md.CHAR:return 1;case Md.SHORT:return 2;case Md.INT:case Md.FLOAT:return 4;case Md.DOUBLE:return 8;default:return-1}}function Dd(t){switch(String(t)){case"byte":return Md.BYTE;case"char":return Md.CHAR;case"short":return Md.SHORT;case"int":return Md.INT;case"float":return Md.FLOAT;case"double":return Md.DOUBLE;default:return-1}}function Rd(t,e){if(1!==t){for(var r=new Array(t),i=0;i<t;i++)r[i]=e();return r}return e()}function Fd(t,e,r){switch(e){case Md.BYTE:return t.readBytes(r);case Md.CHAR:return function(t){if(0===t.charCodeAt(t.length-1))return t.substring(0,t.length-1);return t}(t.readChars(r));case Md.SHORT:return Rd(r,t.readInt16.bind(t));case Md.INT:return Rd(r,t.readInt32.bind(t));case Md.FLOAT:return Rd(r,t.readFloat32.bind(t));case Md.DOUBLE:return Rd(r,t.readFloat64.bind(t));default:return void Id(!0,"non valid type "+e)}}var Ed=0,$d=10,Ld=11,Nd=12;function zd(t,e){var r={recordDimension:{length:t.readUint32()}};r.version=e;var i=function(t){var e,r,i,o=t.readUint32();{if(o===Ed)return Id(t.readUint32()!==Ed,"wrong empty tag for list of dimensions"),[];Id(o!==$d,"wrong tag for list of dimensions");var n=t.readUint32();e=new Array(n);for(var a=0;a<n;a++){var s=kd(t),c=t.readUint32();0===c&&(r=a,i=s),e[a]={name:s,size:c}}return{dimensions:e,recordId:r,recordName:i}}}(t);r.recordDimension.id=i.recordId,r.recordDimension.name=i.recordName,r.dimensions=i.dimensions,r.globalAttributes=jd(t);var o=function(t,e,r){var i,o=t.readUint32(),n=0;{if(o===Ed)return Id(t.readUint32()!==Ed,"wrong empty tag for list of variables"),[];Id(o!==Ld,"wrong tag for list of variables");var a=t.readUint32();i=new Array(a);for(var s=0;s<a;s++){for(var c=kd(t),u=t.readUint32(),h=new Array(u),l=0;l<u;l++)h[l]=t.readUint32();var p=jd(t),d=t.readUint32();Id(d<1&&6<d,"non valid type "+d);var f=t.readUint32(),m=t.readUint32();2===r&&(Id(0<m,"offsets larger than 4GB not supported"),m=t.readUint32()),h[0]===e&&(n+=f),i[s]={name:c,dimensions:h,attributes:p,type:Bd(d),size:f,offset:m,record:h[0]===e}}}return{variables:i,recordStep:n}}(t,i.recordId,e);return r.variables=o.variables,r.recordDimension.recordStep=o.recordStep,r}function jd(t){var e,r=t.readUint32();if(r===Ed)return Id(t.readUint32()!==Ed,"wrong empty tag for list of attributes"),[];Id(r!==Nd,"wrong tag for list of attributes");var i=t.readUint32();e=new Array(i);for(var o=0;o<i;o++){var n=kd(t),a=t.readUint32();Id(a<1||6<a,"non valid type "+a);var s=Fd(t,a,t.readUint32());Od(t),e[o]={name:n,type:Bd(a),value:s}}return e}var Vd=function(t){var e=new le(t);e.setBigEndian(),Id("CDF"!==e.readChars(3),"should start with CDF");var r=e.readByte();Id(2<r,"unknown version"),this.header=zd(e,r),this.buffer=e},Gd={version:{configurable:!0},recordDimension:{configurable:!0},dimensions:{configurable:!0},globalAttributes:{configurable:!0},variables:{configurable:!0}};Gd.version.get=function(){return 1===this.header.version?"classic format":"64-bit offset format"},Gd.recordDimension.get=function(){return this.header.recordDimension},Gd.dimensions.get=function(){return this.header.dimensions},Gd.globalAttributes.get=function(){return this.header.globalAttributes},Gd.variables.get=function(){return this.header.variables},Vd.prototype.hasDataVariable=function(e){return-1!==this.header.variables.findIndex(function(t){return t.name===e})},Vd.prototype.getDataVariable=function(e){var t;return Id(void 0===(t="string"==typeof e?this.header.variables.find(function(t){return t.name===e}):e),"variable not found"),this.buffer.seek(t.offset),t.record?function(t,e,r){for(var i=Dd(e.type),o=e.size?e.size/Td(i):1,n=r.length,a=new Array(n),s=r.recordStep,c=0;c<n;c++){var u=t.offset;a[c]=Fd(t,i,o),t.seek(u+s)}return a}(this.buffer,t,this.header.recordDimension):function(t,e){for(var r=Dd(e.type),i=e.size/Td(r),o=new Array(i),n=0;n<i;n++)o[n]=Fd(t,r,1);return o}(this.buffer,t)},Object.defineProperties(Vd.prototype,Gd);var Ud=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"nctraj"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("NctrajParser._parse "+this.name);var t=new Vd(this.streamer.data),e=this.frames,r=e.coordinates,i=e.boxes,o=e.times;t.getDataVariable("coordinates").forEach(function(t){r.push(new Float32Array(t))}),t.hasDataVariable("cell_lengths")&&t.getDataVariable("cell_lengths").forEach(function(t){i.push(new Float32Array(t))}),t.hasDataVariable("time")&&t.getDataVariable("time").forEach(function(t){o.push(t)}),1<=o.length&&(e.timeOffset=o[0]),2<=o.length&&(e.deltaTime=o[1]-o[0]),de.Debug&&me.timeEnd("NctrajParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Cd);Ht.add("nctraj",Ud),Ht.add("ncdf",Ud),Ht.add("nc",Ud);var Hd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"trr"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("TrrParser._parse "+this.name);for(var t=L(this.streamer.data),e=new DataView(t),r=this.frames,i=r.coordinates,o=r.boxes,n=r.times,a=0;;){a+=8;var s=e.getInt32(a);a+=4,a+=s;var c=e.getInt32(a+8),u=e.getInt32(a+12),h=e.getInt32(a+16),l=e.getInt32(a+28),p=e.getInt32(a+32),d=e.getInt32(a+36),f=e.getInt32(a+40);a+=52;var m=c/9,g=3*f;if(8===m?n.push(e.getFloat64(a)):n.push(e.getFloat32(a)),a+=2*m,c){var y=new Float32Array(9);if(8===m)for(var v=0;v<9;++v)y[v]=10*e.getFloat64(a),a+=8;else for(var b=0;b<9;++b)y[b]=10*e.getFloat32(a),a+=4;o.push(y)}if(a+=u,a+=h,l){var x=void 0;if(8===m){x=new Float32Array(g);for(var _=0;_<g;++_)x[_]=10*e.getFloat64(a),a+=8}else{for(var w=new Uint32Array(t,a,g),A=0;A<g;++A){var S=w[A];w[A]=(255&S)<<24|(65280&S)<<8|S>>8&65280|S>>24&255}x=new Float32Array(t,a,g);for(var C=0;C<g;++C)x[C]*=10,a+=4}i.push(x)}if(a+=p,(a+=d)>=t.byteLength)break}1<=n.length&&(r.timeOffset=n[0]),2<=n.length&&(r.deltaTime=n[1]-n[0]),de.Debug&&me.timeEnd("TrrParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Cd);Ht.add("trr",Hd);var Wd=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]);function qd(t){for(var e=1,r=0;e<=t&&r<32;)r++,e<<=1;return r}var Xd=new Uint8Array(32);function Yd(t,e){var r=1,i=0;Xd[0]=1;for(var o=0;o<t;o++){var n=void 0,a=0;for(n=0;n<r;n++)a+=Xd[n]*e[o],Xd[n]=255&a,a>>=8;for(;0!==a;)Xd[n++]=255&a,a>>=8;r=n}var s=1;for(r--;Xd[r]>=s;)i++,s*=2;return i+8*r}function Kd(t,e,r,i){for(var o=(1<<r)-1,n=i[1],a=i[2],s=t[0],c=0;8<=r;)c|=(a=a<<8|e[s++])>>n<<r-8,r-=8;return 0<r&&(n<r&&(n+=8,a=a<<8|e[s++]),c|=a>>(n-=r)&(1<<r)-1),c&=o,t[0]=s,t[1]=n,t[2]=a,c}var Zd=new Int32Array(32);function Qd(t,e,r,i,o,n,a){var s=0;for(Zd[1]=0,Zd[2]=0,Zd[3]=0;8<i;)Zd[s++]=Kd(t,e,8,a),i-=8;0<i&&(Zd[s++]=Kd(t,e,i,a));for(var c=r-1;0<c;c--){for(var u=0,h=s-1;0<=h;h--){var l=(u=u<<8|Zd[h])/o[c]|0;u-=(Zd[h]=l)*o[c]}n[c]=u}n[0]=Zd[0]|Zd[1]<<8|Zd[2]<<16|Zd[3]<<24}var Jd=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"xtc"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("XtcParser._parse "+this.name);for(var t=L(this.streamer.data),e=new DataView(t),r=this.frames,i=r.coordinates,o=r.boxes,n=r.times,a=new Int32Array(6),s=new Int32Array(3),c=new Int32Array(3),u=new Uint32Array(3),h=new Float32Array(3),l=new Float32Array(3),p=0,d=new Int32Array(3),f=new Uint32Array(d.buffer);;){var m=void 0,g=e.getInt32(p+4);p+=12;var y=3*g;n.push(e.getFloat32(p)),p+=4;for(var v=new Float32Array(9),b=0;b<9;++b)v[b]=10*e.getFloat32(p),p+=4;if(o.push(v),g<=9){m=new Float32Array(g);for(var x=0;x<g;++x)m[x]=e.getFloat32(p),p+=4}else{d[0]=d[1]=d[2]=0,s[0]=s[1]=s[2]=0,u[0]=u[1]=u[2]=0,c[0]=c[1]=c[2]=0,h[0]=h[1]=h[2]=0,l[0]=l[1]=l[2]=0,m=new Float32Array(y);var _=0,w=e.getInt32(p);p+=4;var A=e.getFloat32(p);p+=4,a[0]=e.getInt32(p),a[1]=e.getInt32(p+4),a[2]=e.getInt32(p+8),a[3]=e.getInt32(p+12),a[4]=e.getInt32(p+16),a[5]=e.getInt32(p+20),s[0]=a[3]-a[0]+1,s[1]=a[4]-a[1]+1,s[2]=a[5]-a[2]+1,p+=24;var S=void 0;16777215<(s[0]|s[1]|s[2])?(c[0]=qd(s[0]),c[1]=qd(s[1]),c[2]=qd(s[2]),S=0):S=Yd(3,s);var C=e.getInt32(p);p+=4;var P=C-1,I=Wd[P=P<9?9:P]/2|0,O=Wd[C]/2|0;u[0]=u[1]=u[2]=Wd[C];var k=4*Math.ceil(e.getInt32(p)/4);p+=4;var M=1/A,B=0,T=0,D=new Uint8Array(t,p);for(h[0]=h[1]=h[2]=0;T<w;){0===S?(h[0]=Kd(d,D,c[0],f),h[1]=Kd(d,D,c[1],f),h[2]=Kd(d,D,c[2],f)):Qd(d,D,3,S,s,h,f),T++,h[0]+=a[0],h[1]+=a[1],h[2]+=a[2],l[0]=h[0],l[1]=h[1],l[2]=h[2];var R=0;if(1===Kd(d,D,1,f)&&(B=Kd(d,D,5,f),B-=R=B%3,R--),0<B){h[0]=h[1]=h[2]=0;for(var F=0;F<B;F+=3){if(Qd(d,D,3,C,u,h,f),T++,h[0]+=l[0]-O,h[1]+=l[1]-O,h[2]+=l[2]-O,0===F){var E=h[0];h[0]=l[0],l[0]=E,E=h[1],h[1]=l[1],l[1]=E,E=h[2],h[2]=l[2],l[2]=E,m[_++]=l[0]*M,m[_++]=l[1]*M,m[_++]=l[2]*M}else l[0]=h[0],l[1]=h[1],l[2]=h[2];m[_++]=h[0]*M,m[_++]=h[1]*M,m[_++]=h[2]*M}}else m[_++]=h[0]*M,m[_++]=h[1]*M,m[_++]=h[2]*M;if(C+=R,R<0?(O=I,I=9<C?Wd[C-1]/2|0:0):0<R&&(I=O,O=Wd[C]/2|0),u[0]=u[1]=u[2]=Wd[C],0===u[0]||0===u[1]||0===u[2])return void console.error("(xdrfile error) Undefined error.")}p+=k}for(var $=0;$<y;$++)m[$]*=10;if(i.push(m),p>=t.byteLength)break}1<=n.length&&(r.timeOffset=n[0]),2<=n.length&&(r.deltaTime=n[1]-n[0]),de.Debug&&me.timeEnd("XtcParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(Cd);Ht.add("xtc",Jd);var tf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.volume=new ta(this.name,this.path),this.voxelSize=st(r.voxelSize,1)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"volume"},e.__objName.get=function(){return"volume"},t.prototype._afterParse=function(){this.volume.setMatrix(this.getMatrix()),i.prototype._afterParse.call(this)},t.prototype.getMatrix=function(){return new fe.Matrix4},Object.defineProperties(t.prototype,e),t}(wp),ef=/\s+/,rf=/-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?/g,of=.529177210859,nf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"cube"},e.prototype._parse=function(){de.Debug&&me.time("CubeParser._parse "+this.name);var t=this.volume,i=this.streamer.peekLines(6),c={},e=of*this.voxelSize;function r(t,e){var r=i[t].trim().split(ef)[e];return parseFloat(r)}c.atomCount=Math.abs(r(2,0)),c.originX=r(2,1)*of,c.originY=r(2,2)*of,c.originZ=r(2,3)*of,c.NVX=r(3,0),c.NVY=r(4,0),c.NVZ=r(5,0),c.basisX=new fe.Vector3(r(3,1),r(3,2),r(3,3)).multiplyScalar(e),c.basisY=new fe.Vector3(r(4,1),r(4,2),r(4,3)).multiplyScalar(e),c.basisZ=new fe.Vector3(r(5,1),r(5,2),r(5,3)).multiplyScalar(e);var u=new Float32Array(c.NVX*c.NVY*c.NVZ),h=0,l=0,p=0<r(2,0)?0:1;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i].trim();if(""!==o&&l>=c.atomCount+6+p)for(var n=o.match(rf),a=0,s=n.length;a<s;++a)u[h]=parseFloat(n[a]),++h;++l}}(0,t.length,t)}),t.header=c,t.setData(u,c.NVZ,c.NVY,c.NVX),de.Debug&&me.timeEnd("CubeParser._parse "+this.name)},e.prototype.getMatrix=function(){var t=this.volume.header,e=new fe.Matrix4;return e.multiply((new fe.Matrix4).makeTranslation(t.originX,t.originY,t.originZ)),e.multiply((new fe.Matrix4).makeBasis(t.basisZ,t.basisY,t.basisX)),e},Object.defineProperties(e.prototype,r),e}(tf);Ht.add("cub",nf),Ht.add("cube",nf);var af=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dsn6"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("Dsn6Parser._parse "+this.name);var t,e,r=this.volume,i={},o=L(this.streamer.data),n=new Int16Array(o),a=new Uint8Array(o),s=String.fromCharCode.apply(null,a.subarray(0,512));if(s.startsWith(":-)"))i.xStart=parseInt(s.substr(10,5)),i.yStart=parseInt(s.substr(15,5)),i.zStart=parseInt(s.substr(20,5)),i.xExtent=parseInt(s.substr(32,5)),i.yExtent=parseInt(s.substr(38,5)),i.zExtent=parseInt(s.substr(42,5)),i.xRate=parseInt(s.substr(52,5)),i.yRate=parseInt(s.substr(58,5)),i.zRate=parseInt(s.substr(62,5)),i.xlen=parseFloat(s.substr(73,10))*this.voxelSize,i.ylen=parseFloat(s.substr(83,10))*this.voxelSize,i.zlen=parseFloat(s.substr(93,10))*this.voxelSize,i.alpha=parseFloat(s.substr(103,10)),i.beta=parseFloat(s.substr(113,10)),i.gamma=parseFloat(s.substr(123,10)),t=parseFloat(s.substr(138,12))/100,e=parseInt(s.substr(155,8)),i.sigma=100*parseFloat(s.substr(170,12));else{if(100!==n[18])for(var c=0,u=n.length;c<u;++c){var h=n[c];n[c]=(255&h)<<8|h>>8&255}i.xStart=n[0],i.yStart=n[1],i.zStart=n[2],i.xExtent=n[3],i.yExtent=n[4],i.zExtent=n[5],i.xRate=n[6],i.yRate=n[7],i.zRate=n[8];var l=1/n[17],p=l*this.voxelSize;i.xlen=n[9]*p,i.ylen=n[10]*p,i.zlen=n[11]*p,i.alpha=n[12]*l,i.beta=n[13]*l,i.gamma=n[14]*l,t=n[15]/100,e=n[16],i.gamma=n[14]*l}r.header=i,de.Debug&&me.log(i,t,e);for(var d=new Float32Array(i.xExtent*i.yExtent*i.zExtent),f=512,m=Math.ceil(i.xExtent/8),g=Math.ceil(i.yExtent/8),y=Math.ceil(i.zExtent/8),v=0;v<y;++v)for(var b=0;b<g;++b)for(var x=0;x<m;++x)for(var _=0;_<8;++_)for(var w=8*v+_,A=0;A<8;++A)for(var S=8*b+A,C=0;C<8;++C){var P=8*x+C;if(!(P<i.xExtent&&S<i.yExtent&&w<i.zExtent)){f+=8-C;break}d[(P*i.yExtent+S)*i.zExtent+w]=(a[f]-e)/t,++f}r.setData(d,i.zExtent,i.yExtent,i.xExtent),i.sigma&&r.setStats(void 0,void 0,void 0,i.sigma),de.Debug&&me.timeEnd("Dsn6Parser._parse "+this.name)},e.prototype.getMatrix=function(){var t=this.volume.header,e=[t.xlen,0,0],r=[t.ylen*Math.cos(Math.PI/180*t.gamma),t.ylen*Math.sin(Math.PI/180*t.gamma),0],i=[t.zlen*Math.cos(Math.PI/180*t.beta),t.zlen*(Math.cos(Math.PI/180*t.alpha)-Math.cos(Math.PI/180*t.gamma)*Math.cos(Math.PI/180*t.beta))/Math.sin(Math.PI/180*t.gamma),0];i[2]=Math.sqrt(t.zlen*t.zlen*Math.sin(Math.PI/180*t.beta)*Math.sin(Math.PI/180*t.beta)-i[1]*i[1]);var o=[[],e,r,i],n=[0,t.xRate,t.yRate,t.zRate],a=[0,1,2,3],s=new fe.Matrix4;return s.set(o[a[1]][0]/n[a[1]],o[a[2]][0]/n[a[2]],o[a[3]][0]/n[a[3]],0,o[a[1]][1]/n[a[1]],o[a[2]][1]/n[a[2]],o[a[3]][1]/n[a[3]],0,o[a[1]][2]/n[a[1]],o[a[2]][2]/n[a[2]],o[a[3]][2]/n[a[3]],0,0,0,0,1),s.multiply((new fe.Matrix4).makeRotationY(et(90))),s.multiply((new fe.Matrix4).makeTranslation(-t.zStart,t.yStart,t.xStart)),s.multiply((new fe.Matrix4).makeScale(-1,1,1)),s},Object.defineProperties(e.prototype,r),e}(tf);Ht.add("dsn6",af),Ht.add("brix",af);var sf=/\s+/,cf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"dx"},e.prototype._parse=function(){de.Debug&&me.time("DxParser._parse "+this.name);var t=this.volume,e=this.streamer.peekLines(30),r=this.parseHeaderLines(e),i=this.volume.header,c=r.dataLineStart,u=i.nx*i.ny*i.nz,h=new Float32Array(u),l=0,p=0;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){if(l<u&&c<p){var o=r[i].trim();if(""!==o)for(var n=o.split(sf),a=0,s=n.length;a<s;++a)h[l]=parseFloat(n[a]),++l}++p}}(0,t.length,t)}),t.setData(h,i.nz,i.ny,i.nx),de.Debug&&me.timeEnd("DxParser._parse "+this.name)},e.prototype.parseHeaderLines=function(t){for(var e={},r=t.length,i=0,o=0,n=0,a=0;a<r;++a){var s=void 0,c=t[a];if(c.startsWith("object 1"))s=c.split(sf),e.nx=parseInt(s[5]),e.ny=parseInt(s[6]),e.nz=parseInt(s[7]);else if(c.startsWith("origin"))s=c.split(sf),e.xmin=parseFloat(s[1]),e.ymin=parseFloat(s[2]),e.zmin=parseFloat(s[3]);else if(c.startsWith("delta"))s=c.split(sf),0===n?e.hx=parseFloat(s[1])*this.voxelSize:1===n?e.hy=parseFloat(s[2])*this.voxelSize:2===n&&(e.hz=parseFloat(s[3])*this.voxelSize),n+=1;else if(c.startsWith("object 3")){i=a,o+=c.length+1;break}o+=c.length+1}return this.volume.header=e,{dataLineStart:i,headerByteCount:o}},e.prototype.getMatrix=function(){var t=this.volume.header,e=new fe.Matrix4;return e.multiply((new fe.Matrix4).makeRotationY(et(90))),e.multiply((new fe.Matrix4).makeTranslation(-t.zmin,t.ymin,t.xmin)),e.multiply((new fe.Matrix4).makeScale(-t.hz,t.hy,t.hx)),e},Object.defineProperties(e.prototype,r),e}(tf);Ht.add("dx",cf);var uf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dxbin"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("DxbinParser._parse "+this.name);for(var t=L(this.streamer.data),e=function(t,e,r){void 0===e&&(e=10485760),void 0===r&&(r="\n");for(var i="",o=[],n=0;n<t.length;n+=e){var a=C(t.subarray(n,n+e)),s=a.lastIndexOf(r);if(-1===s)i+=a;else{var c=i+a.substr(0,s);o=o.concat(c.split(r)),i=s===a.length-r.length?"":a.substr(s+r.length)}}return""!==i&&o.push(i),o}(new Uint8Array(t,0,1e3)),r=this.parseHeaderLines(e),i=this.volume.header,o=r.headerByteCount,n=i.nx*i.ny*i.nz,a=new DataView(t),s=new Float32Array(n),c=0;c<n;++c)s[c]=a.getFloat64(8*c+o,!0);this.volume.setData(s,i.nz,i.ny,i.nx),de.Debug&&me.timeEnd("DxbinParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(cf);Ht.add("dxbin",uf);var hf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"mrc"},r.isBinary.get=function(){return!0},e.prototype._parse=function(){de.Debug&&me.time("MrcParser._parse "+this.name);var t,e=this.volume,r={},i=L(this.streamer.data),o=new Int32Array(i,0,56),n=new Float32Array(i,0,56),a=new DataView(i);if(r.MAP=String.fromCharCode(a.getUint8(208),a.getUint8(209),a.getUint8(210),a.getUint8(211)),r.MACHST=[a.getUint8(212),a.getUint8(213)],17===r.MACHST[0]&&17===r.MACHST[1])for(var s=i.byteLength,c=0;c<s;c+=4)a.setFloat32(c,a.getFloat32(c),!0);if(r.NX=o[0],r.NY=o[1],r.NZ=o[2],r.MODE=o[3],r.NXSTART=o[4],r.NYSTART=o[5],r.NZSTART=o[6],r.MX=o[7],r.MY=o[8],r.MZ=o[9],r.xlen=n[10]*this.voxelSize,r.ylen=n[11]*this.voxelSize,r.zlen=n[12]*this.voxelSize,r.alpha=n[13],r.beta=n[14],r.gamma=n[15],r.MAPC=o[16],r.MAPR=o[17],r.MAPS=o[18],r.DMIN=n[19],r.DMAX=n[20],r.DMEAN=n[21],r.ISPG=o[22],r.NSYMBT=o[23],r.LSKFLG=o[24],r.originX=n[49],r.originY=n[50],r.originZ=n[51],r.ARMS=n[54],2===(e.header=r).MODE)t=new Float32Array(i,1024+r.NSYMBT,r.NX*r.NY*r.NZ);else if(0===r.MODE){if(t=new Float32Array(new Int8Array(i,1024+r.NSYMBT,r.NX*r.NY*r.NZ)),-128===o[39]&&127===o[40])for(var u=(r.DMAX-r.DMIN)/255,h=.5*(r.DMIN+r.DMAX+u),l=0,p=t.length;l<p;++l)t[l]=u*t[l]+h}else me.error("MrcParser unknown mode",r.MODE);e.setData(t,r.NX,r.NY,r.NZ),0!==r.ARMS&&e.setStats(r.DMIN,r.DMAX,r.DMEAN,r.ARMS),de.Debug&&me.timeEnd("MrcParser._parse "+this.name)},e.prototype.getMatrix=function(){var t=this.volume.header,e=[t.xlen,0,0],r=[t.ylen*Math.cos(Math.PI/180*t.gamma),t.ylen*Math.sin(Math.PI/180*t.gamma),0],i=[t.zlen*Math.cos(Math.PI/180*t.beta),t.zlen*(Math.cos(Math.PI/180*t.alpha)-Math.cos(Math.PI/180*t.gamma)*Math.cos(Math.PI/180*t.beta))/Math.sin(Math.PI/180*t.gamma),0];i[2]=Math.sqrt(t.zlen*t.zlen*Math.sin(Math.PI/180*t.beta)*Math.sin(Math.PI/180*t.beta)-i[1]*i[1]);var o=[[],e,r,i],n=[0,t.MX,t.MY,t.MZ],a=[0,t.MAPC,t.MAPR,t.MAPS],s=new fe.Matrix4;return s.set(o[a[1]][0]/n[a[1]],o[a[2]][0]/n[a[2]],o[a[3]][0]/n[a[3]],0,o[a[1]][1]/n[a[1]],o[a[2]][1]/n[a[2]],o[a[3]][1]/n[a[3]],0,o[a[1]][2]/n[a[1]],o[a[2]][2]/n[a[2]],o[a[3]][2]/n[a[3]],0,0,0,0,1),s.setPosition(new fe.Vector3(t.originX,t.originY,t.originZ)),s.multiply((new fe.Matrix4).makeTranslation(t.NXSTART,t.NYSTART,t.NZSTART)),s},Object.defineProperties(e.prototype,r),e}(tf);Ht.add("mrc",hf),Ht.add("ccp4",hf),Ht.add("map",hf);var lf=/\s+/;function pf(t){return t.trim().split(lf).map(parseFloat)}var df=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"xplor"},e.prototype._parse=function(){de.Debug&&me.time("XplorParser._parse "+this.name);var t,e=this.volume,r=this.streamer.peekLines(8),u={},h=(t=r[2].startsWith("REMARKS")?parseInt(r[1].substring(0,8))+2:5)+3,i=pf(r[t]);u.NA=i[0],u.AMIN=i[1],u.AMAX=i[2],u.NB=i[3],u.BMIN=i[4],u.BMAX=i[5],u.NC=i[6],u.CMIN=i[7],u.CMAX=i[8];var o=pf(r[t+1]);u.a=o[0]*this.voxelSize,u.b=o[1]*this.voxelSize,u.c=o[2]*this.voxelSize,u.alpha=o[3],u.beta=o[4],u.gamma=o[5];var n=u.AMAX-u.AMIN+1,a=u.BMAX-u.BMIN+1,s=u.CMAX-u.CMIN+1,l=n*a*s,p=new Float32Array(l),d=Math.ceil(1+n*a/6),f=0,m=0;this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i];if(h<=m&&(m-h)%d!=0&&f<l)for(var n=0;n<6;++n){var a=parseFloat(o.substr(12*n,12));if(isNaN(a))break;p[f++]=a}else if(f===l){var s=o.trim();if(s&&"-9999"!==s){var c=pf(o);u.RAVE=c[0],u.RSIGMA=c[1]}}++m}}(0,t.length,t)}),e.header=u,e.setData(p,n,a,s),0!==u.RAVE&&1!==u.RSIGMA&&e.setStats(void 0,void 0,u.RAVE,u.RSIGMA),de.Debug&&me.timeEnd("XplorParser._parse "+this.name)},e.prototype.getMatrix=function(){var t=this.volume.header,e=[t.a,0,0],r=[t.b*Math.cos(Math.PI/180*t.gamma),t.b*Math.sin(Math.PI/180*t.gamma),0],i=[t.c*Math.cos(Math.PI/180*t.beta),t.c*(Math.cos(Math.PI/180*t.alpha)-Math.cos(Math.PI/180*t.gamma)*Math.cos(Math.PI/180*t.beta))/Math.sin(Math.PI/180*t.gamma),0];i[2]=Math.sqrt(t.c*t.c*Math.sin(Math.PI/180*t.beta)*Math.sin(Math.PI/180*t.beta)-i[1]*i[1]);var o=[[],e,r,i],n=[0,t.NA,t.NB,t.NC],a=[0,1,2,3],s=new fe.Matrix4;return s.set(o[a[1]][0]/n[a[1]],o[a[2]][0]/n[a[2]],o[a[3]][0]/n[a[3]],0,o[a[1]][1]/n[a[1]],o[a[2]][1]/n[a[2]],o[a[3]][1]/n[a[3]],0,o[a[1]][2]/n[a[1]],o[a[2]][2]/n[a[2]],o[a[3]][2]/n[a[3]],0,0,0,0,1),s.multiply((new fe.Matrix4).makeTranslation(t.AMIN,t.BMIN,t.CMIN)),s},Object.defineProperties(e.prototype,r),e}(tf);function ff(t,e,r){var i,o,n;t/=360,e/=100,r/=100;var a=Math.floor(6*t),s=6*t-a,c=r*(1-e),u=r*(1-s*e),h=r*(1-(1-s)*e);switch(a%6){case 0:i=r,o=h,n=c;break;case 1:i=u,o=r,n=c;break;case 2:i=c,o=r,n=h;break;case 3:i=c,o=u,n=r;break;case 4:i=h,o=c,n=r;break;case 5:i=r,o=c,n=u}return[i,o,n]}Ht.add("xplor",df),Ht.add("cns",df);var mf={red:ff(0,100,100),orange:ff(20,100,100),gold:ff(40,100,100),yellow:ff(60,100,100),lime:ff(80,100,100),green:ff(120,80,100),sea:ff(150,100,100),cyan:ff(180,100,85),sky:ff(210,75,95),blue:ff(240,70,100),purple:ff(275,75,100),magenta:ff(300,95,100),hotpink:ff(335,100,100),pink:ff(350,55,100),peach:ff(25,75,100),lilac:ff(275,55,100),pinktint:ff(340,30,100),peachtint:ff(25,50,100),yellowtint:ff(60,50,100),greentint:ff(135,40,100),bluetint:ff(220,40,100),lilactint:ff(275,35,100),white:ff(0,0,100),gray:ff(0,0,50),brown:ff(20,45,75),deadwhite:[1,1,1],deadblack:[0,0,0],invisible:[0,0,0]},gf=/[\s,]+/,yf=/[^{}\s]*{[^{}]+}|[^{}\s]+/g,vf=/^{+|}+$/g,bf=/^['"]+|['"]+$/g,xf=/\s*=\s*/g;function _f(t){for(var e,r,i,o=[],n=(t=t.replace(xf,"=")).match(yf),a=1;a<n.length;++a){var s=n[a];if("{"===s[0])e=s.substring(1,s.length-1);else{var c=s.split("=");2===c.length&&("color"===c[0]?r=mf[c[1]]:"width"===c[0]?i=parseInt(c[1]):"master"===c[0]&&o.push(c[1].replace(vf,"")))}}return{listName:e,listColor:r,listMasters:o,listWidth:i}}function wf(t){for(var e,r,i,o=(t=t.trim()).indexOf("{"),n=t.indexOf("}"),a=t.substr(n+1).split(gf),s=t.substr(o+1,n-1),c=[parseFloat(a[a.length-3]),parseFloat(a[a.length-2]),parseFloat(a[a.length-1])],u=4;u<=a.length;u++){var h=a[a.length-u];h in mf&&(e=mf[a[a.length-u]]),h.startsWith("width")&&(r=parseInt(h.substring(5))),h.startsWith("r=")&&(i=parseFloat(h.split("=")[1]))}return{label:s,position:c,color:e,radius:i,width:r}}function Af(t){var e=t.indexOf("{"),r=t.indexOf("}");return t.substring(-1!==e?e+1:0,-1!==r?r:void 0).trim()}function Sf(t){for(var e,r={},i=(t=t.replace(xf,"=")).match(yf),o=1;o<i.length;++o){var n=i[o];if("{"===n[0])e=n.substring(1,n.length-1);else{var a=n.split("=");2===a.length?r[a[0]]=a[1].replace(vf,""):r[a[0]]=!0}}return[e,r]}var Cf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"kin"},r.__objName.get=function(){return"kinemage"},e.prototype._parse=function(){de.Debug&&me.time("KinParser._parse "+this.name);var ut={kinemage:void 0,onewidth:void 0,"1viewid":void 0,pdbfile:void 0,texts:[],text:"",captions:[],caption:"",groupDict:{},subgroupDict:{},masterDict:{},pointmasterDict:{},dotLists:[],vectorLists:[],ballLists:[],ribbonLists:[]};this.kinemage=ut;var ht,lt,pt,dt,ft,mt,gt,yt,vt,bt,xt,_t,wt,At,St,Ct,Pt,It,Ot,kt,Mt,Bt,Tt,Dt=!1,Rt="",Ft=!1,Et="",$t=!1,Lt="",Nt=!1,zt="",jt=!1,Vt=!1;if(this.streamer.eachChunkOfLines(function(t){!function(t,e,r){for(var i=t;i<e;++i){var o=r[i];if("@"===o[0]&&(Vt=jt=Nt=$t=Ft=Dt=!1),o)if(o.startsWith("@dotlist")){var n=_f(o),a=n.listColor,s=n.listName,c=n.listMasters;Dt=!0,Rt="",lt=[],pt=[],dt=[],ht=a,ut.dotLists.push({name:s,masterArray:c,labelArray:lt,positionArray:pt,colorArray:dt})}else if(o.startsWith("@vectorlist")){var u=_f(o),h=u.listMasters,l=u.listName,p=u.listWidth,d=u.listColor;h&&h.forEach(function(t){ut.masterDict[t]||(ut.masterDict[t]={indent:!1,visible:!1})}),Ft=!0,Et="",mt=ft=null,vt=[],bt=[],xt=[],_t=[],wt=[],At=[],gt=d,yt=[],p&&yt.push(p),ut.vectorLists.push({name:l,masterArray:h,label1Array:vt,label2Array:bt,position1Array:xt,position2Array:_t,color1Array:wt,color2Array:At,width:yt})}else if(o.startsWith("@balllist")){var f=_f(o),m=f.listName,g=f.listColor,y=f.listMasters;y&&y.forEach(function(t){ut.masterDict[t]||(ut.masterDict[t]={indent:!1,visible:!1})}),$t=!0,Lt="",Pt=[],St=[],It=[],Ot=[],Ct=g,ut.ballLists.push({name:m,masterArray:y,labelArray:Pt,radiusArray:St,positionArray:It,colorArray:Ot})}else if(o.startsWith("@ribbonlist")){var v=_f(o),b=v.listMasters,x=v.listName,_=v.listColor;b&&b.forEach(function(t){ut.masterDict[t]||(ut.masterDict[t]={indent:!1,visible:!1})}),Nt=!0,zt="",Mt=[],Bt=[],Tt=[],kt=_,ut.ribbonLists.push({name:x,masterArray:b,labelArray:Mt,positionArray:Bt,colorArray:Tt})}else if(o.startsWith("@text"))jt=!0,ut.texts.push(o.substr(5));else if(o.startsWith("@caption"))Vt=!0,ut.captions.push(o.substr(8));else if(Dt){var w=wf(o),A=w.label,S=w.color,C=w.position;'"'===A?A=Rt:Rt=A,void 0===S&&(S=ht),lt.push(A),pt.push.apply(pt,C),dt.push.apply(dt,S)}else if(Ft){var P=o.indexOf("{"),I=o.indexOf("{",P+1),O=void 0,k=void 0;-1===I?k=O=o:(O=o.substr(0,I),k=o.substr(I));var M=wf(O),B=M.label,T=M.color,D=M.width,R=M.position;if('"'===B?B=Et:Et=B,void 0===T&&(T=gt),D&&yt.push(D),vt.push(B),xt.push.apply(xt,R),wt.push.apply(wt,T),-1===I&&ft)bt.push(Et),_t.push.apply(_t,ft),At.push.apply(At,mt),Et=B,ft=R,mt=T;else{var F=wf(k),E=F.label,$=F.color,L=F.position;'"'===E?E=Et:Et=E,void 0===$&&($=gt),bt.push(E),_t.push.apply(_t,L),At.push.apply(At,$),ft=L,mt=$}}else if($t){var N=wf(o),z=N.label,j=N.radius,V=N.color,G=N.position;'"'===z?z=Lt:Lt=z,void 0===j&&(j=1),void 0===V&&(V=Ct),Pt.push(z),St.push(j),It.push.apply(It,G),Ot.push.apply(Ot,V)}else if(Nt){var U=wf(o),H=U.label,W=U.color,q=U.position;'"'===H?H=zt:zt=H,void 0===W&&(W=kt),Mt.push(H),Bt.push.apply(Bt,q),Tt.push.apply(Tt,W)}else if(jt)ut.texts.push(o);else if(Vt)ut.captions.push(o);else if(o.startsWith("@kinemage"))ut.kinemage=parseInt(o.substr(9).trim());else if(o.startsWith("@onewidth"))ut.onewidth=!0;else if(o.startsWith("@1viewid"))ut["1viewid"]=Af(o);else if(o.startsWith("@pdbfile"))ut.pdbfile=Af(o);else if(o.startsWith("@group")){var X=Sf(o),Y=X[0],K=X[1];for(var Z in ut.groupDict[Y]||(ut.groupDict[Y]={dominant:!1,animate:!1}),K)ut.groupDict[Y][Z]=K[Z]}else if(o.startsWith("@subgroup")){var Q=Sf(o),J=Q[0],tt=Q[1];for(var et in ut.subgroupDict[J]||(ut.subgroupDict[J]={dominant:!1,animate:!1,master:void 0}),tt)ut.subgroupDict[J][et]=tt[et]}else if(o.startsWith("@master")){var rt=Af(o),it=-1===(ct=(st=o).indexOf("}"))?void 0:st.substr(ct+1).trim();ut.masterDict[rt]||(ut.masterDict[rt]={indent:!1,visible:!1}),"on"===it?ut.masterDict[rt].visible=!0:"off"===it?ut.masterDict[rt].visible=!1:"indent"===it&&(ut.masterDict[rt].indent=!0)}else if(o.startsWith("@pointmaster")){var ot=Sf(o),nt=ot[0],at=ot[1];ut.pointmasterDict[nt]={id:Object.keys(at)[0].replace(bf,"")}}else console.log(o);else Nt=$t=Ft=Dt=!1}var st,ct}(0,t.length,t)}),ut.text=ut.texts.join("\n").trim(),ut.caption=ut.captions.join("\n").trim(),ut.ribbonLists){var e=[];ut.ribbonLists.forEach(function(t){e.push(function(t){for(var e=t.labelArray,r=t.positionArray,i=t.colorArray,o=[],n=0;n<3*(e.length-2);++n)o[n]=e[n-2*Math.floor(n/3)];for(var a=[],s=0;s<9*(r.length/3-2);++s)a[s]=r[s-6*Math.floor(s/9)];for(var c=[],u=0;u<9*(i.length/3-2);++u)c[u]=i[u-6*Math.floor(u/9)];return{name:t.name,masterArray:t.masterArray,labelArray:o,positionArray:a,colorArray:c}}(t))}),ut.ribbonLists=e}de.Debug&&me.timeEnd("KinParser._parse "+this.name)},Object.defineProperties(e.prototype,r),e}(wp);Ht.add("kin",Cf);var Pf=function(r){function t(t,e){r.call(this,t,e),this.loader=this.getLoader(),this.surface=new Zn(this.name,this.path)}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"surface"},e.__objName.get=function(){return"surface"},t.prototype._parse=function(){var t=this.loader.parse(this.streamer.asText());this.surface.fromGeometry(t)},Object.defineProperties(t.prototype,e),t}(wp),If=function(){this.regexp={vertex_pattern:/^v\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,normal_pattern:/^vn\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,uv_pattern:/^vt\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}};If.prototype={constructor:If,setPath:function(t){this.path=t},_createParserState:function(){var t={objects:[],object:{},vertices:[],normals:[],startObject:function(t,e){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=t,void(this.object.fromDeclaration=!1!==e);this.object={name:t||"",geometry:{vertices:[],normals:[]},fromDeclaration:!1!==e},this.objects.push(this.object)},parseVertexIndex:function(t,e){var r=parseInt(t,10);return 3*(0<=r?r-1:r+e/3)},parseNormalIndex:function(t,e){var r=parseInt(t,10);return 3*(0<=r?r-1:r+e/3)},addVertex:function(t,e,r){var i=this.vertices,o=this.object.geometry.vertices;o.push(i[t+0]),o.push(i[t+1]),o.push(i[t+2]),o.push(i[e+0]),o.push(i[e+1]),o.push(i[e+2]),o.push(i[r+0]),o.push(i[r+1]),o.push(i[r+2])},addVertexLine:function(t){var e=this.vertices,r=this.object.geometry.vertices;r.push(e[t+0]),r.push(e[t+1]),r.push(e[t+2])},addNormal:function(t,e,r){var i=this.normals,o=this.object.geometry.normals;o.push(i[t+0]),o.push(i[t+1]),o.push(i[t+2]),o.push(i[e+0]),o.push(i[e+1]),o.push(i[e+2]),o.push(i[r+0]),o.push(i[r+1]),o.push(i[r+2])},addFace:function(t,e,r,i,o,n,a,s){var c,u=this.vertices.length,h=this.parseVertexIndex(t,u),l=this.parseVertexIndex(e,u),p=this.parseVertexIndex(r,u);if(void 0===i?this.addVertex(h,l,p):(c=this.parseVertexIndex(i,u),this.addVertex(h,l,c),this.addVertex(l,p,c)),void 0!==o){var d=this.normals.length;h=this.parseNormalIndex(o,d),l=o===n?h:this.parseNormalIndex(n,d),p=o===a?h:this.parseNormalIndex(a,d),void 0===i?this.addNormal(h,l,p):(c=this.parseNormalIndex(s,d),this.addNormal(h,l,c),this.addNormal(l,p,c))}},addLineGeometry:function(t){this.object.geometry.type="Line";for(var e=this.vertices.length,r=0,i=t.length;r<i;r++)this.addVertexLine(this.parseVertexIndex(t[r],e))}};return t.startObject("",!1),t},parse:function(t){var e,r,i=this,o=this._createParserState();-1!==t.indexOf("\r\n")&&(t=t.replace(/\r\n/g,"\n")),-1!==t.indexOf("\\\n")&&(t=t.replace(/\\\n/g,""));var n=t.split("\n"),a="",s="",c="",u=[],h="function"==typeof"".trimLeft;for(e=0,r=n.length;e<r;e++)if(a=n[e],0!==(a=h?a.trimLeft():a.trim()).length&&"#"!==(s=a.charAt(0)))if("v"===s){if(" "===(c=a.charAt(1))&&null!==(u=i.regexp.vertex_pattern.exec(a)))o.vertices.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]));else if("n"===c&&null!==(u=i.regexp.normal_pattern.exec(a)))o.normals.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]));else if("t"!==c||null===i.regexp.uv_pattern.exec(a))throw new Error("Unexpected vertex/normal/uv line: '"+a+"'")}else if("f"===s)if(null!==(u=i.regexp.face_vertex_uv_normal.exec(a)))o.addFace(u[1],u[4],u[7],u[10],u[3],u[6],u[9],u[12]);else if(null!==i.regexp.face_vertex_uv.exec(a));else if(null!==(u=i.regexp.face_vertex_normal.exec(a)))o.addFace(u[1],u[3],u[5],u[7],u[2],u[4],u[6],u[8]);else{if(null===(u=i.regexp.face_vertex.exec(a)))throw new Error("Unexpected face line: '"+a+"'");o.addFace(u[1],u[2],u[3],u[4])}else if("l"===s){var l=a.substring(1).trim().split(" "),p=[],d=[];if(-1===a.indexOf("/"))p=l;else for(var f=0,m=l.length;f<m;f++){var g=l[f].split("/");""!==g[0]&&p.push(g[0]),""!==g[1]&&d.push(g[1])}o.addLineGeometry(p,d)}else if(null!==(u=i.regexp.object_pattern.exec(a))){var y=u[0].substr(1).trim();o.startObject(y)}else if(i.regexp.material_use_pattern.test(a));else if(i.regexp.material_library_pattern.test(a));else if(null===i.regexp.smoothing_pattern.exec(a)){if("\0"===a)continue;throw new Error("Unexpected line: '"+a+"'")}var v=[];for(e=0,r=o.objects.length;e<r;e++){var b=o.objects[e].geometry;if(0!==b.vertices.length){var x=new fe.BufferGeometry;x.setAttribute("position",new fe.BufferAttribute(new Float32Array(b.vertices),3)),0<b.normals.length?x.setAttribute("normal",new fe.BufferAttribute(new Float32Array(b.normals),3)):x.computeVertexNormals(),v.push(x)}}return v}};var Of=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"obj"},e.prototype.getLoader=function(){return new If},Object.defineProperties(e.prototype,r),e}(Pf);Ht.add("obj",Of);var kf=function(){this.propertyNameMapping={}};kf.prototype={constructor:kf,setPropertyNameMapping:function(t){this.propertyNameMapping=t},bin2str:function(t){for(var e=new Uint8Array(t),r="",i=0;i<t.byteLength;i++)r+=String.fromCharCode(e[i]);return r},isASCII:function(t){return"ascii"===this.parseHeader(this.bin2str(t)).format},parse:function(t){return t instanceof ArrayBuffer?this.isASCII(t)?this.parseASCII(this.bin2str(t)):this.parseBinary(t):this.parseASCII(t)},parseHeader:function(t){var e="",r=0,i=/ply([\s\S]*)end_header\s/.exec(t);null!==i&&(e=i[1],r=i[0].length);var o,n,a,s,c,u,h={comments:[],elements:[],headerLength:r},l=e.split("\n");for(var p=0;p<l.length;p++){var d=l[p];if(""!==(d=d.trim()))switch(n=(a=d.split(/\s+/)).shift(),d=a.join(" "),n){case"format":h.format=a[0],h.version=a[1];break;case"comment":h.comments.push(d);break;case"element":void 0!==o&&h.elements.push(o),(o={}).name=a[0],o.count=parseInt(a[1]),o.properties=[];break;case"property":o.properties.push((s=a,c=this.propertyNameMapping,u=void 0,"list"===(u={type:s[0]}).type?(u.name=s[3],u.countType=s[1],u.itemType=s[2]):u.name=s[1],u.name in c&&(u.name=c[u.name]),u));break;default:console.log("unhandled",n,a)}}return void 0!==o&&h.elements.push(o),h},parseASCIINumber:function(t,e){switch(e){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(t);case"float":case"double":case"float32":case"float64":return parseFloat(t)}},parseASCIIElement:function(t,e){for(var r=e.split(/\s+/),i={},o=0;o<t.length;o++)if("list"===t[o].type){for(var n=[],a=this.parseASCIINumber(r.shift(),t[o].countType),s=0;s<a;s++)n.push(this.parseASCIINumber(r.shift(),t[o].itemType));i[t[o].name]=n}else i[t[o].name]=this.parseASCIINumber(r.shift(),t[o].type);return i},parseASCII:function(t){var e,r=new fe.Geometry,i=this.parseHeader(t),o="";null!==(e=/end_header\s([\s\S]*)$/.exec(t))&&(o=e[1]);var n=o.split("\n"),a=0,s=0;r.useColor=!1;for(var c=0;c<n.length;c++){var u=n[c];if(""!==(u=u.trim())){s>=i.elements[a].count&&(a++,s=0);var h=this.parseASCIIElement(i.elements[a].properties,u);this.handleElement(r,i.elements[a].name,h),s++}}return this.postProcess(r)},postProcess:function(t){if(t.useColor){for(var e=0;e<t.faces.length;e++)t.faces[e].vertexColors=[t.colors[t.faces[e].a],t.colors[t.faces[e].b],t.colors[t.faces[e].c]];t.elementsNeedUpdate=!0}return t.computeBoundingSphere(),t},handleElement:function(t,e,r){if("vertex"===e){if(t.vertices.push(new fe.Vector3(r.x,r.y,r.z)),"red"in r&&"green"in r&&"blue"in r){t.useColor=!0;var i=new fe.Color;i.setRGB(r.red/255,r.green/255,r.blue/255),t.colors.push(i)}}else if("face"===e){var o=r.vertex_indices;3===o.length?t.faces.push(new fe.Face3(o[0],o[1],o[2])):4===o.length&&t.faces.push(new fe.Face3(o[0],o[1],o[3]),new fe.Face3(o[1],o[2],o[3]))}},binaryRead:function(t,e,r,i){switch(r){case"int8":case"char":return[t.getInt8(e),1];case"uint8":case"uchar":return[t.getUint8(e),1];case"int16":case"short":return[t.getInt16(e,i),2];case"uint16":case"ushort":return[t.getUint16(e,i),2];case"int32":case"int":return[t.getInt32(e,i),4];case"uint32":case"uint":return[t.getUint32(e,i),4];case"float32":case"float":return[t.getFloat32(e,i),4];case"float64":case"double":return[t.getFloat64(e,i),8]}},binaryReadElement:function(t,e,r,i){for(var o,n={},a=0,s=0;s<r.length;s++)if("list"===r[s].type){var c=[],u=(o=this.binaryRead(t,e+a,r[s].countType,i))[0];a+=o[1];for(var h=0;h<u;h++)o=this.binaryRead(t,e+a,r[s].itemType,i),c.push(o[0]),a+=o[1];n[r[s].name]=c}else o=this.binaryRead(t,e+a,r[s].type,i),n[r[s].name]=o[0],a+=o[1];return[n,a]},parseBinary:function(t){for(var e,r=new fe.Geometry,i=this.parseHeader(this.bin2str(t)),o="binary_little_endian"===i.format,n=new DataView(t,i.headerLength),a=0,s=0;s<i.elements.length;s++)for(var c=0;c<i.elements[s].count;c++){a+=(e=this.binaryReadElement(n,a,i.elements[s].properties,o))[1];var u=e[0];this.handleElement(r,i.elements[s].name,u)}return this.postProcess(r)}};var Mf=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={type:{configurable:!0}};return r.type.get=function(){return"ply"},e.prototype.getLoader=function(){return new kf},Object.defineProperties(e.prototype,r),e}(Pf);Ht.add("ply",Mf);var Bf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.delimiter=st(r.delimiter,","),this.comment=st(r.comment,"#"),this.columnNames=st(r.columnNames,!1),this.table={name:this.name,path:this.path,columnNames:[],data:[]}}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"csv"},e.__objName.get=function(){return"table"},t.prototype._parse=function(){var n=this,a=this.table.data,s=new RegExp("\\s*"+this.delimiter+"\\s*"),c=0;this.streamer.eachChunkOfLines(function(t){for(var e=t.length,r=0;r<e;++r){var i=t[r].trim();if(!i.startsWith(n.comment)){var o=i.split(s);0===c?n.table.columnNames=o:i&&a.push(o),++c}}})},Object.defineProperties(t.prototype,e),t}(wp);Ht.add("csv",Bf);var Tf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.string=st(r.string,!1),this.json={name:this.name,path:this.path,data:{}}}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0},isJson:{configurable:!0}};return e.type.get=function(){return"json"},e.__objName.get=function(){return"json"},e.isJson.get=function(){return!0},t.prototype._parse=function(){this.streamer.isBinary()||this.string?this.json.data=JSON.parse(this.streamer.asText()):this.json.data=this.streamer.data},Object.defineProperties(t.prototype,e),t}(wp);Ht.add("json",Tf);var Df=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.msgpack={name:this.name,path:this.path,data:void 0}}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0}};return e.type.get=function(){return"msgpack"},e.__objName.get=function(){return"msgpack"},e.isBinary.get=function(){return!0},t.prototype._parse=function(){de.Debug&&me.time("MsgpackParser._parse "+this.name),this.msgpack.data=nd(this.streamer.data),de.Debug&&me.timeEnd("MsgpackParser._parse "+this.name)},Object.defineProperties(t.prototype,e),t}(wp);Ht.add("msgpack",Df);var Rf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.netcdf={name:this.name,path:this.path,data:void 0}}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0}};return e.type.get=function(){return"netcdf"},e.__objName.get=function(){return"netcdf"},e.isBinary.get=function(){return!0},t.prototype._parse=function(){de.Debug&&me.time("NetcdfParser._parse "+this.name),this.netcdf.data=new Vd(this.streamer.data),de.Debug&&me.timeEnd("NetcdfParser._parse "+this.name)},Object.defineProperties(t.prototype,e),t}(wp);Ht.add("netcdf",Rf);var Ff=function(r){function t(t,e){r.call(this,t,e),this.text={name:this.name,path:this.path,data:""}}r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0}};return e.type.get=function(){return"text"},e.__objName.get=function(){return"text"},t.prototype._parse=function(){this.text.data=this.streamer.asText()},Object.defineProperties(t.prototype,e),t}(wp);Ht.add("txt",Ff),Ht.add("text",Ff);var Ef=/^['"]|['"]$/g,$f=/^<([\w-:.]+)\s*/,Lf=/^([^<]*)/,Nf=/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/;function zf(r){return r=r.trim().replace(/<!--[\s\S]*?-->/g,""),{declaration:function(){if(s(/^<\?xml\s*/)){for(var t={attributes:{}};!c()&&!u("?>");){var e=a();if(!e)return t;t.attributes[e.name]=e.value}return s(/\?>\s*/),t}}(),root:function t(){var e=s($f);if(e){for(var r,i,o={name:e[1],attributes:{},children:[]};!(c()||u(">")||u("?>")||u("/>"));){var n=a();if(!n)return o;o.attributes[n.name]=n.value}if(s(/^\s*\/>\s*/))return o;for(s(/\??>\s*/),o.content=(r=s(Lf))?r[1]:"";i=t();)o.children.push(i);return s(/^<\/[\w-:.]+>\s*/),o}}()};function a(){var t,e=s(Nf);if(e)return{name:e[1],value:(t=e[2],t.replace(Ef,""))}}function s(t){var e=r.match(t);if(e)return r=r.slice(e[0].length),e}function c(){return 0===r.length}function u(t){return 0===r.indexOf(t)}}var jf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.useDomParser=st(r.useDomParser,!1),this.xml={name:this.name,path:this.path,data:{}}}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={type:{configurable:!0},__objName:{configurable:!0},isXml:{configurable:!0}};return e.type.get=function(){return"xml"},e.__objName.get=function(){return"xml"},e.isXml.get=function(){return!0},t.prototype.__xmlParser=function(t){return zf(t)},t.prototype.__domParser=function(t){return(new window.DOMParser).parseFromString(t,"text/xml")},t.prototype._parse=function(){de.Debug&&me.time("XmlParser._parse "+this.name),this.useDomParser?this.streamer.data instanceof Document?this.xml.data=this.streamer.data:this.xml.data=this.__domParser(this.streamer.asText()):this.xml.data=this.__xmlParser(this.streamer.asText()),de.Debug&&me.timeEnd("XmlParser._parse "+this.name)},Object.defineProperties(t.prototype,e),t}(wp);function Vf(t,e){var r=t.getNamedItem(e);return null!==r?r.value:""}function Gf(t,e,r){void 0===r&&(r=!1);var i=Vf(t,"icode").trim(),o=Vf(t,"chain").trim(),n=Vf(t,"altcode"),a=Vf(t,"resnum");return i&&(a+="^"+i),o&&(a+=":"+o),e&&(a+="."+e),r&&n.trim()&&(a+="%"+n),a+="/"+(parseInt(Vf(t,"model"))-1)}function Uf(t,e,r){void 0===t[e]?t[e]=r:t[e]|=r}function Hf(t,e){return null!==t&&t.value===e}function Wf(t,e,r){for(var i=0,o=e.getElementsByTagName("clash"),n=0,a=o.length;n<a;++n)if(t[Vf(o[n].attributes,"cid")]){i+=1;break}return 0<e.getElementsByTagName("angle-outlier").length&&(i+=1),0<e.getElementsByTagName("bond-outlier").length&&(i+=1),0<e.getElementsByTagName("plane-outlier").length&&(i+=1),Hf(r.getNamedItem("rota"),"OUTLIER")&&(i+=1),Hf(r.getNamedItem("rama"),"OUTLIER")&&(i+=1),Hf(r.getNamedItem("RNApucker"),"outlier")&&(i+=1),i}Ht.add("xml",jf);var qf=function(t,e){this.name=t,this.path=e,this.rsrzDict={},this.rsccDict={},this.rciDict={},this.clashDict={},this.clashArray=[],this.geoDict={},this.geoAtomDict={},this.atomDict={},this.clashSele="NONE"},Xf={type:{configurable:!0}};Xf.type.get=function(){return"validation"},qf.prototype.fromXml=function(t){de.Debug&&me.time("Validation.fromXml");var e,r,i,o=this.rsrzDict,n=this.rsccDict,a=this.rciDict,s=this.clashDict,c=this.clashArray,u=this.geoDict,h=this.geoAtomDict,l=this.atomDict,p=t.getElementsByTagName("Entry");if(1===p.length){var d=p[0].getElementsByTagName("chemical_shift_list");if(1===d.length)for(var f=d[0].getElementsByTagName("random_coil_index"),m=0,g=f.length;m<g;++m){var y=f[m].attributes;a[(i=void 0,r=Vf(e=y,"chain").trim(),i="["+Vf(e,"rescode")+"]"+Vf(e,"resnum"),r&&(i+=":"+r),i)]=parseFloat(Vf(y,"value"))}}var v=t.getElementsByTagName("ModelledSubgroup"),b={},x=[];de.Debug&&me.time("Validation.fromXml#clashDict");for(var _=0,w=v.length;_<w;++_){var A=v[_],S=A.attributes,C=Gf(S);null!==S.getNamedItem("rsrz")&&(o[C]=parseFloat(Vf(S,"rsrz"))),null!==S.getNamedItem("rscc")&&(n[C]=parseFloat(Vf(S,"rscc")));var P=t.createAttribute("sele");P.value=C,S.setNamedItem(P);for(var I=A.getElementsByTagName("clash"),O=0,k=I.length;O<k;++O){var M=I[O].attributes,B=Vf(M,"atom");if("H"!==Is(B)){var T=Vf(M,"cid"),D=Gf(S,B,!0);if(l[D]=!0,void 0===b[T])b[T]={sele1:D,res1:C};else{var R=b[T];R.res1!==C&&(R.sele2=D,R.res2=C,x.push(R.res1,C),s[T]=R,c.push(R))}}}}de.Debug&&me.timeEnd("Validation.fromXml#clashDict");for(var F=0,E=v.length;F<E;++F){var $=v[F],L=$.attributes,N=Vf(L,"sele");if("."!==Vf(L,"seq")){var z=Wf(s,$,L);0<z&&(u[N]=z)}else{var j=$.getElementsByTagName("clash"),V=$.getElementsByTagName("mog-bond-outlier"),G=$.getElementsByTagName("mog-angle-outlier");if(0<V.length||0<G.length||0<j.length){var U={};h[N]=U;for(var H=0,W=j.length;H<W;++H){var q=j[H].attributes;s[Vf(q,"cid")]&&Uf(U,Vf(q,"atom"),1)}for(var X=0,Y=V.length;X<Y;++X){Vf(V[X].attributes,"atoms").split(",").forEach(function(t){Uf(U,t,2)})}for(var K=0,Z=G.length;K<Z;++K){Vf(G[K].attributes,"atoms").split(",").forEach(function(t){Uf(U,t,4)})}}}}this.clashSele=x.length?x.join(" OR "):"NONE",de.Debug&&me.timeEnd("Validation.fromXml")},qf.prototype.getClashData=function(t){de.Debug&&me.time("Validation.getClashData");var e=t||{},r=e.structure,n=r.atomSet,i=new fe.Color(st(e.color,"#f0027f")),a=r.getAtomProxy(),s=r.getAtomProxy(),c=new fe.Vector3,u=new fe.Vector3,h=new fe.Vector3,o=this.clashArray,l=o.length,p=new Float32Array(3*l),d=new Float32Array(3*l),f=Re(l,i.r,i.g,i.b),m=new Float32Array(l),g=new Float32Array(l);de.Debug&&me.time("Validation.getClashData#atomDict");var y=this.atomDict;r.eachAtom(function(t){var e,r,i,o,n,a,s=(r=(e=t).inscode,i=e.chainname,o=e.atomname,n=e.altloc,a=e.resno+"",r&&(a+="^"+r),i&&(a+=":"+i),o&&(a+="."+o),n&&(a+="%"+n),a+="/"+e.modelIndex);!0===y[s]&&(y[s]=t.index)}),de.Debug&&me.timeEnd("Validation.getClashData#atomDict");var v=0;return o.forEach(function(t,e){if(a.index=y[t.sele1],s.index=y[t.sele2],void 0!==a.index&&void 0!==s.index&&n.isSet(a.index,s.index)){c.subVectors(s,a).setLength(a.vdw),u.copy(a).add(c),c.subVectors(a,s).setLength(s.vdw),h.copy(s).add(c);var r=a.distanceTo(s)/2,i=Math.sqrt(a.vdw*a.vdw-r*r),o=Math.sqrt(s.vdw*s.vdw-r*r);u.toArray(p,3*v),h.toArray(d,3*v),m[v]=(i+o)/2,g[v]=e,++v}}),de.Debug&&me.timeEnd("Validation.getClashData"),{position1:p.subarray(0,3*v),position2:d.subarray(0,3*v),color:f.subarray(0,3*v),color2:f.subarray(0,3*v),radius:m.subarray(0,v),picking:new un(g.subarray(0,v),this,r)}},Object.defineProperties(qf.prototype,Xf);var Yf=function(i){function t(t,e){var r=e||{};i.call(this,t,r),this.useDomParser=!0,this.validation=new qf(this.name,this.path)}i&&(t.__proto__=i),(t.prototype=Object.create(i&&i.prototype)).constructor=t;var e={__objName:{configurable:!0},isXml:{configurable:!0}};return e.__objName.get=function(){return"validation"},e.isXml.get=function(){return!0},t.prototype._parse=function(){i.prototype._parse.call(this),de.Debug&&me.time("ValidationParser._parse "+this.name),this.validation.fromXml(this.xml.data),de.Debug&&me.timeEnd("ValidationParser._parse "+this.name)},Object.defineProperties(t.prototype,e),t}(jf);function Kf(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)}function Zf(t,e,r,i,o){if(e.subarray&&t.subarray)t.set(e.subarray(r,r+i),o);else for(var n=0;n<i;n++)t[o+n]=e[r+n]}function Qf(t,e,r,i){for(var o=65535&t|0,n=t>>>16&65535|0,a=0;0!==r;){for(r-=a=2e3<r?2e3:r;n=n+(o=o+e[i++]|0)|0,--a;);o%=65521,n%=65521}return o|n<<16|0}Ht.add("validation",Yf);var Jf=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t}return e}();function tm(t,e,r,i){var o=Jf,n=i+r;t^=-1;for(var a=i;a<n;a++)t=t>>>8^o[255&(t^e[a])];return-1^t}var em=30,rm=12;function im(t,e){var r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b,x,_,w,A,S,C,P;r=t.state,i=t.next_in,C=t.input,o=i+(t.avail_in-5),n=t.next_out,P=t.output,a=n-(e-t.avail_out),s=n+(t.avail_out-257),c=r.dmax,u=r.wsize,h=r.whave,l=r.wnext,p=r.window,d=r.hold,f=r.bits,m=r.lencode,g=r.distcode,y=(1<<r.lenbits)-1,v=(1<<r.distbits)-1;t:do{f<15&&(d+=C[i++]<<f,f+=8,d+=C[i++]<<f,f+=8),b=m[d&y];e:for(;;){if(d>>>=x=b>>>24,f-=x,0===(x=b>>>16&255))P[n++]=65535&b;else{if(!(16&x)){if(0==(64&x)){b=m[(65535&b)+(d&(1<<x)-1)];continue e}if(32&x){r.mode=rm;break t}t.msg="invalid literal/length code",r.mode=em;break t}_=65535&b,(x&=15)&&(f<x&&(d+=C[i++]<<f,f+=8),_+=d&(1<<x)-1,d>>>=x,f-=x),f<15&&(d+=C[i++]<<f,f+=8,d+=C[i++]<<f,f+=8),b=g[d&v];r:for(;;){if(d>>>=x=b>>>24,f-=x,!(16&(x=b>>>16&255))){if(0==(64&x)){b=g[(65535&b)+(d&(1<<x)-1)];continue r}t.msg="invalid distance code",r.mode=em;break t}if(w=65535&b,f<(x&=15)&&(d+=C[i++]<<f,(f+=8)<x&&(d+=C[i++]<<f,f+=8)),c<(w+=d&(1<<x)-1)){t.msg="invalid distance too far back",r.mode=em;break t}if(d>>>=x,f-=x,(x=n-a)<w){if(h<(x=w-x)&&r.sane){t.msg="invalid distance too far back",r.mode=em;break t}if(S=p,(A=0)===l){if(A+=u-x,x<_){for(_-=x;P[n++]=p[A++],--x;);A=n-w,S=P}}else if(l<x){if(A+=u+l-x,(x-=l)<_){for(_-=x;P[n++]=p[A++],--x;);if(A=0,l<_){for(_-=x=l;P[n++]=p[A++],--x;);A=n-w,S=P}}}else if(A+=l-x,x<_){for(_-=x;P[n++]=p[A++],--x;);A=n-w,S=P}for(;2<_;)P[n++]=S[A++],P[n++]=S[A++],P[n++]=S[A++],_-=3;_&&(P[n++]=S[A++],1<_&&(P[n++]=S[A++]))}else{for(A=n-w;P[n++]=P[A++],P[n++]=P[A++],P[n++]=P[A++],2<(_-=3););_&&(P[n++]=P[A++],1<_&&(P[n++]=P[A++]))}break}}break}}while(i<o&&n<s);i-=_=f>>3,d&=(1<<(f-=_<<3))-1,t.next_in=i,t.next_out=n,t.avail_in=i<o?o-i+5:5-(i-o),t.avail_out=n<s?s-n+257:257-(n-s),r.hold=d,r.bits=f}var om=15,nm=852,am=592,sm=0,cm=1,um=2,hm=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],lm=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],pm=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],dm=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function fm(t,e,r,i,o,n,a,s){var c,u,h,l,p,d,f,m,g,y=s.bits,v=0,b=0,x=0,_=0,w=0,A=0,S=0,C=0,P=0,I=0,O=null,k=0,M=new Uint16Array(om+1),B=new Uint16Array(om+1),T=null,D=0;for(v=0;v<=om;v++)M[v]=0;for(b=0;b<i;b++)M[e[r+b]]++;for(w=y,_=om;1<=_&&0===M[_];_--);if(_<w&&(w=_),0===_)return o[n++]=20971520,o[n++]=20971520,s.bits=1,0;for(x=1;x<_&&0===M[x];x++);for(w<x&&(w=x),v=C=1;v<=om;v++)if(C<<=1,(C-=M[v])<0)return-1;if(0<C&&(t===sm||1!==_))return-1;for(B[1]=0,v=1;v<om;v++)B[v+1]=B[v]+M[v];for(b=0;b<i;b++)0!==e[r+b]&&(a[B[e[r+b]]++]=b);if(t===sm?(O=T=a,d=19):t===cm?(O=hm,k-=257,T=lm,D-=257,d=256):(O=pm,T=dm,d=-1),v=x,p=n,S=b=I=0,h=-1,l=(P=1<<(A=w))-1,t===cm&&nm<P||t===um&&am<P)return 1;for(;;){for(f=v-S,a[b]<d?(m=0,g=a[b]):a[b]>d?(m=T[D+a[b]],g=O[k+a[b]]):(m=96,g=0),c=1<<v-S,x=u=1<<A;o[p+(I>>S)+(u-=c)]=f<<24|m<<16|g|0,0!==u;);for(c=1<<v-1;I&c;)c>>=1;if(0!==c?(I&=c-1,I+=c):I=0,b++,0==--M[v]){if(v===_)break;v=e[r+a[b]]}if(w<v&&(I&l)!==h){for(0===S&&(S=w),p+=x,C=1<<(A=v-S);A+S<_&&!((C-=M[A+S])<=0);)A++,C<<=1;if(P+=1<<A,t===cm&&nm<P||t===um&&am<P)return 1;o[h=I&l]=w<<24|A<<16|p-n|0}}return 0!==I&&(o[p+I]=v-S<<24|64<<16|0),s.bits=w,0}var mm=0,gm=1,ym=2,vm=4,bm=5,xm=6,_m=0,wm=1,Am=2,Sm=-2,Cm=-3,Pm=-4,Im=-5,Om=8,km=1,Mm=2,Bm=3,Tm=4,Dm=5,Rm=6,Fm=7,Em=8,$m=9,Lm=10,Nm=11,zm=12,jm=13,Vm=14,Gm=15,Um=16,Hm=17,Wm=18,qm=19,Xm=20,Ym=21,Km=22,Zm=23,Qm=24,Jm=25,tg=26,eg=27,rg=28,ig=29,og=30,ng=31,ag=32,sg=852,cg=592;function ug(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function hg(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function lg(t){var e,r,i;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,(r=t)&&r.state?(i=r.state,r.total_in=r.total_out=i.total=0,r.msg="",i.wrap&&(r.adler=1&i.wrap),i.mode=km,i.last=0,i.havedict=0,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new Int32Array(sg),i.distcode=i.distdyn=new Int32Array(cg),i.sane=1,i.back=-1,_m):Sm):Sm}function pg(t,e){var r,i,o,n,a,s;return t?(i=new hg,(t.state=i).window=null,n=e,(r=(o=t)&&o.state?(s=o.state,n<0?(a=0,n=-n):(a=1+(n>>4),n<48&&(n&=15)),n&&(n<8||15<n)?Sm:(null!==s.window&&s.wbits!==n&&(s.window=null),s.wrap=a,s.wbits=n,lg(o))):Sm)!==_m&&(t.state=null),r):Sm}var dg,fg,mg=!0;function gg(t){if(mg){var e;for(dg=new Int32Array(512),fg=new Int32Array(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(fm(gm,t.lens,0,288,dg,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;fm(ym,t.lens,0,32,fg,0,t.work,{bits:5}),mg=!1}t.lencode=dg,t.lenbits=9,t.distcode=fg,t.distbits=5}function yg(t,e,r,i){var o,n=t.state;return null===n.window&&(n.wsize=1<<n.wbits,n.wnext=0,n.whave=0,n.window=new Uint8Array(n.wsize)),i>=n.wsize?(Zf(n.window,e,r-n.wsize,n.wsize,0),n.wnext=0,n.whave=n.wsize):(i<(o=n.wsize-n.wnext)&&(o=i),Zf(n.window,e,r-i,o,n.wnext),(i-=o)?(Zf(n.window,e,r-i,i,0),n.wnext=i,n.whave=n.wsize):(n.wnext+=o,n.wnext===n.wsize&&(n.wnext=0),n.whave<n.wsize&&(n.whave+=o))),0}function vg(t,e){var r,i,o,n,a,s,c,u,h,l,p,d,f,m,g,y,v,b,x,_,w,A,S,C,P=0,I=new Uint8Array(4),O=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return Sm;(r=t.state).mode===zm&&(r.mode=jm),a=t.next_out,o=t.output,c=t.avail_out,n=t.next_in,i=t.input,s=t.avail_in,u=r.hold,h=r.bits,l=s,p=c,A=_m;t:for(;;)switch(r.mode){case km:if(0===r.wrap){r.mode=jm;break}for(;h<16;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(2&r.wrap&&35615===u){I[r.check=0]=255&u,I[1]=u>>>8&255,r.check=tm(r.check,I,2,0),h=u=0,r.mode=Mm;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){t.msg="incorrect header check",r.mode=og;break}if((15&u)!==Om){t.msg="unknown compression method",r.mode=og;break}if(h-=4,w=8+(15&(u>>>=4)),0===r.wbits)r.wbits=w;else if(w>r.wbits){t.msg="invalid window size",r.mode=og;break}r.dmax=1<<w,t.adler=r.check=1,r.mode=512&u?Lm:zm,h=u=0;break;case Mm:for(;h<16;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(r.flags=u,(255&r.flags)!==Om){t.msg="unknown compression method",r.mode=og;break}if(57344&r.flags){t.msg="unknown header flags set",r.mode=og;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&(I[0]=255&u,I[1]=u>>>8&255,r.check=tm(r.check,I,2,0)),h=u=0,r.mode=Bm;case Bm:for(;h<32;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.head&&(r.head.time=u),512&r.flags&&(I[0]=255&u,I[1]=u>>>8&255,I[2]=u>>>16&255,I[3]=u>>>24&255,r.check=tm(r.check,I,4,0)),h=u=0,r.mode=Tm;case Tm:for(;h<16;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(I[0]=255&u,I[1]=u>>>8&255,r.check=tm(r.check,I,2,0)),h=u=0,r.mode=Dm;case Dm:if(1024&r.flags){for(;h<16;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(I[0]=255&u,I[1]=u>>>8&255,r.check=tm(r.check,I,2,0)),h=u=0}else r.head&&(r.head.extra=null);r.mode=Rm;case Rm:if(1024&r.flags&&(s<(d=r.length)&&(d=s),d&&(r.head&&(w=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),Zf(r.head.extra,i,n,d,w)),512&r.flags&&(r.check=tm(r.check,i,d,n)),s-=d,n+=d,r.length-=d),r.length))break t;r.length=0,r.mode=Fm;case Fm:if(2048&r.flags){if(0===s)break t;for(d=0;w=i[n+d++],r.head&&w&&r.length<65536&&(r.head.name+=String.fromCharCode(w)),w&&d<s;);if(512&r.flags&&(r.check=tm(r.check,i,d,n)),s-=d,n+=d,w)break t}else r.head&&(r.head.name=null);r.length=0,r.mode=Em;case Em:if(4096&r.flags){if(0===s)break t;for(d=0;w=i[n+d++],r.head&&w&&r.length<65536&&(r.head.comment+=String.fromCharCode(w)),w&&d<s;);if(512&r.flags&&(r.check=tm(r.check,i,d,n)),s-=d,n+=d,w)break t}else r.head&&(r.head.comment=null);r.mode=$m;case $m:if(512&r.flags){for(;h<16;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(u!==(65535&r.check)){t.msg="header crc mismatch",r.mode=og;break}h=u=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),t.adler=r.check=0,r.mode=zm;break;case Lm:for(;h<32;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}t.adler=r.check=ug(u),h=u=0,r.mode=Nm;case Nm:if(0===r.havedict)return t.next_out=a,t.avail_out=c,t.next_in=n,t.avail_in=s,r.hold=u,r.bits=h,Am;t.adler=r.check=1,r.mode=zm;case zm:if(e===bm||e===xm)break t;case jm:if(r.last){u>>>=7&h,h-=7&h,r.mode=eg;break}for(;h<3;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}switch(r.last=1&u,h-=1,3&(u>>>=1)){case 0:r.mode=Vm;break;case 1:if(gg(r),r.mode=Xm,e===xm){u>>>=2,h-=2;break t}break;case 2:r.mode=Hm;break;case 3:t.msg="invalid block type",r.mode=og}u>>>=2,h-=2;break;case Vm:for(u>>>=7&h,h-=7&h;h<32;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if((65535&u)!=(u>>>16^65535)){t.msg="invalid stored block lengths",r.mode=og;break}if(r.length=65535&u,h=u=0,r.mode=Gm,e===xm)break t;case Gm:r.mode=Um;case Um:if(d=r.length){if(s<d&&(d=s),c<d&&(d=c),0===d)break t;Zf(o,i,n,d,a),s-=d,n+=d,c-=d,a+=d,r.length-=d;break}r.mode=zm;break;case Hm:for(;h<14;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(r.nlen=257+(31&u),u>>>=5,h-=5,r.ndist=1+(31&u),u>>>=5,h-=5,r.ncode=4+(15&u),u>>>=4,h-=4,286<r.nlen||30<r.ndist){t.msg="too many length or distance symbols",r.mode=og;break}r.have=0,r.mode=Wm;case Wm:for(;r.have<r.ncode;){for(;h<3;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.lens[O[r.have++]]=7&u,u>>>=3,h-=3}for(;r.have<19;)r.lens[O[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,S={bits:r.lenbits},A=fm(mm,r.lens,0,19,r.lencode,0,r.work,S),r.lenbits=S.bits,A){t.msg="invalid code lengths set",r.mode=og;break}r.have=0,r.mode=qm;case qm:for(;r.have<r.nlen+r.ndist;){for(;y=(P=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,v=65535&P,!((g=P>>>24)<=h);){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(v<16)u>>>=g,h-=g,r.lens[r.have++]=v;else{if(16===v){for(C=g+2;h<C;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(u>>>=g,h-=g,0===r.have){t.msg="invalid bit length repeat",r.mode=og;break}w=r.lens[r.have-1],d=3+(3&u),u>>>=2,h-=2}else if(17===v){for(C=g+3;h<C;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}h-=g,w=0,d=3+(7&(u>>>=g)),u>>>=3,h-=3}else{for(C=g+7;h<C;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}h-=g,w=0,d=11+(127&(u>>>=g)),u>>>=7,h-=7}if(r.have+d>r.nlen+r.ndist){t.msg="invalid bit length repeat",r.mode=og;break}for(;d--;)r.lens[r.have++]=w}}if(r.mode===og)break;if(0===r.lens[256]){t.msg="invalid code -- missing end-of-block",r.mode=og;break}if(r.lenbits=9,S={bits:r.lenbits},A=fm(gm,r.lens,0,r.nlen,r.lencode,0,r.work,S),r.lenbits=S.bits,A){t.msg="invalid literal/lengths set",r.mode=og;break}if(r.distbits=6,r.distcode=r.distdyn,S={bits:r.distbits},A=fm(ym,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,S),r.distbits=S.bits,A){t.msg="invalid distances set",r.mode=og;break}if(r.mode=Xm,e===xm)break t;case Xm:r.mode=Ym;case Ym:if(6<=s&&258<=c){t.next_out=a,t.avail_out=c,t.next_in=n,t.avail_in=s,r.hold=u,r.bits=h,im(t,p),a=t.next_out,o=t.output,c=t.avail_out,n=t.next_in,i=t.input,s=t.avail_in,u=r.hold,h=r.bits,r.mode===zm&&(r.back=-1);break}for(r.back=0;y=(P=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,v=65535&P,!((g=P>>>24)<=h);){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(y&&0==(240&y)){for(b=g,x=y,_=v;y=(P=r.lencode[_+((u&(1<<b+x)-1)>>b)])>>>16&255,v=65535&P,!(b+(g=P>>>24)<=h);){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}u>>>=b,h-=b,r.back+=b}if(u>>>=g,h-=g,r.back+=g,r.length=v,0===y){r.mode=tg;break}if(32&y){r.back=-1,r.mode=zm;break}if(64&y){t.msg="invalid literal/length code",r.mode=og;break}r.extra=15&y,r.mode=Km;case Km:if(r.extra){for(C=r.extra;h<C;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,h-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=Zm;case Zm:for(;y=(P=r.distcode[u&(1<<r.distbits)-1])>>>16&255,v=65535&P,!((g=P>>>24)<=h);){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(0==(240&y)){for(b=g,x=y,_=v;y=(P=r.distcode[_+((u&(1<<b+x)-1)>>b)])>>>16&255,v=65535&P,!(b+(g=P>>>24)<=h);){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}u>>>=b,h-=b,r.back+=b}if(u>>>=g,h-=g,r.back+=g,64&y){t.msg="invalid distance code",r.mode=og;break}r.offset=v,r.extra=15&y,r.mode=Qm;case Qm:if(r.extra){for(C=r.extra;h<C;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,h-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){t.msg="invalid distance too far back",r.mode=og;break}r.mode=Jm;case Jm:if(0===c)break t;if(d=p-c,r.offset>d){if((d=r.offset-d)>r.whave&&r.sane){t.msg="invalid distance too far back",r.mode=og;break}d>r.wnext?(d-=r.wnext,f=r.wsize-d):f=r.wnext-d,d>r.length&&(d=r.length),m=r.window}else m=o,f=a-r.offset,d=r.length;for(c<d&&(d=c),c-=d,r.length-=d;o[a++]=m[f++],--d;);0===r.length&&(r.mode=Ym);break;case tg:if(0===c)break t;o[a++]=r.length,c--,r.mode=Ym;break;case eg:if(r.wrap){for(;h<32;){if(0===s)break t;s--,u|=i[n++]<<h,h+=8}if(p-=c,t.total_out+=p,r.total+=p,p&&(t.adler=r.check=r.flags?tm(r.check,o,p,a-p):Qf(r.check,o,p,a-p)),p=c,(r.flags?u:ug(u))!==r.check){t.msg="incorrect data check",r.mode=og;break}h=u=0}r.mode=rg;case rg:if(r.wrap&&r.flags){for(;h<32;){if(0===s)break t;s--,u+=i[n++]<<h,h+=8}if(u!==(4294967295&r.total)){t.msg="incorrect length check",r.mode=og;break}h=u=0}r.mode=ig;case ig:A=wm;break t;case og:A=Cm;break t;case ng:return Pm;case ag:default:return Sm}return t.next_out=a,t.avail_out=c,t.next_in=n,t.avail_in=s,r.hold=u,r.bits=h,(r.wsize||p!==t.avail_out&&r.mode<og&&(r.mode<eg||e!==vm))&&yg(t,t.output,t.next_out,p-t.avail_out),l-=t.avail_in,p-=t.avail_out,t.total_in+=l,t.total_out+=p,r.total+=p,r.wrap&&p&&(t.adler=r.check=r.flags?tm(r.check,o,p,t.next_out-p):Qf(r.check,o,p,t.next_out-p)),t.data_type=r.bits+(r.last?64:0)+(r.mode===zm?128:0)+(r.mode===Xm||r.mode===Gm?256:0),(0===l&&0===p||e===vm)&&A===_m&&(A=Im),A}var bg=!0,xg=!0;try{String.fromCharCode.apply(null,[0])}catch(t){bg=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){xg=!1}for(var _g=new Uint8Array(256),wg=0;wg<256;wg++)_g[wg]=252<=wg?6:248<=wg?5:240<=wg?4:224<=wg?3:192<=wg?2:1;function Ag(t){var e,r,i,o,n,a=t.length,s=0;for(o=0;o<a;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),s+=r<128?1:r<2048?2:r<65536?3:4;for(e=new Uint8Array(s),o=n=0;n<s;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),r<128?e[n++]=r:(r<2048?e[n++]=192|r>>>6:(r<65536?e[n++]=224|r>>>12:(e[n++]=240|r>>>18,e[n++]=128|r>>>12&63),e[n++]=128|r>>>6&63),e[n++]=128|63&r);return e}function Sg(t,e){var r,i,o,n,a=e||t.length,s=new Array(2*a);for(r=i=0;r<a;)if((o=t[r++])<128)s[i++]=o;else if(4<(n=_g[o]))s[i++]=65533,r+=n-1;else{for(o&=2===n?31:3===n?15:7;1<n&&r<a;)o=o<<6|63&t[r++],n--;1<n?s[i++]=65533:o<65536?s[i++]=o:(o-=65536,s[i++]=55296|o>>10&1023,s[i++]=56320|1023&o)}return function(t,e){if(e<65537&&(t.subarray&&xg||!t.subarray&&bg))return String.fromCharCode.apply(null,Kf(t,e));for(var r="",i=0;i<e;i++)r+=String.fromCharCode(t[i]);return r}(s,i)}function Cg(t,e){var r;for((e=e||t.length)>t.length&&(e=t.length),r=e-1;0<=r&&128==(192&t[r]);)r--;return r<0?e:0===r?e:r+_g[t[r]]>e?r:e}_g[254]=_g[254]=1;var Pg=0,Ig={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function Og(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function kg(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Mg=Object.prototype.toString;function Bg(t){if(!(this instanceof Bg))return new Bg(t);this.options=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var r=e.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])}}return t}({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&0<=e.windowBits&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(0<=e.windowBits&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),15<e.windowBits&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Og,this.strm.avail_out=0;var r,i,o,n=pg(this.strm,e.windowBits);if(n!==Pg)throw new Error(Ig[n]);this.header=new kg,r=this.strm,i=this.header,r&&r.state&&(0==(2&(o=r.state).wrap)||((o.head=i).done=!1))}Bg.prototype.push=function(t,e){var r,i,o,n,a,s,c,u,h,l,p=this.strm,d=this.options.chunkSize,f=this.options.dictionary,m=!1;if(this.ended)return!1;i=e===~~e?e:!0===e?4:0,"string"==typeof t?p.input=function(t){for(var e=new Uint8Array(t.length),r=0,i=e.length;r<i;r++)e[r]=t.charCodeAt(r);return e}(t):"[object ArrayBuffer]"===Mg.call(t)?p.input=new Uint8Array(t):p.input=t,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new Uint8Array(d),p.next_out=0,p.avail_out=d),2===(r=vg(p,0))&&f&&(s="string"==typeof f?Ag(f):"[object ArrayBuffer]"===Mg.call(f)?new Uint8Array(f):f,c=this.strm,h=void 0,l=(u=s).length,r=c&&c.state?0!==(h=c.state).wrap&&h.mode!==Nm?Sm:h.mode===Nm&&Qf(1,u,l,0)!==h.check?Cm:yg(c,u,l,l)?(h.mode=ng,Pm):(h.havedict=1,_m):Sm),-5===r&&!0===m&&(r=Pg,m=!1),1!==r&&r!==Pg)return this.onEnd(r),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&1!==r&&(0!==p.avail_in||4!==i&&2!==i)||("string"===this.options.to?(o=Cg(p.output,p.next_out),n=p.next_out-o,a=Sg(p.output,o),p.next_out=n,p.avail_out=d-n,n&&Zf(p.output,p.output,o,n,0),this.onData(a)):this.onData(Kf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(m=!0)}while((0<p.avail_in||0===p.avail_out)&&1!==r);return 1===r&&(i=4),4===i?(r=function(t){if(!t||!t.state)return Sm;var e=t.state;return e.window&&(e.window=null),t.state=null,_m}(this.strm),this.onEnd(r),this.ended=!0,r===Pg):2!==i||(this.onEnd(Pg),!(p.avail_out=0))},Bg.prototype.onData=function(t){this.chunks.push(t)},Bg.prototype.onEnd=function(t){t===Pg&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=function(t){var e,r,i,o,n,a;for(e=i=0,r=t.length;e<r;e++)i+=t[e].length;for(a=new Uint8Array(i),e=o=0,r=t.length;e<r;e++)n=t[e],a.set(n,o),o+=n.length;return a}(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},qt.add("gz",function(e){var r;e instanceof ArrayBuffer&&(e=new Uint8Array(e));try{r=function(t,e){var r=new Bg(e);if(r.push(t,!0),r.err)throw r.msg;return r.result}(e)}catch(t){r=e}return r});var Tg=function(){},Dg="//mmtf.rcsb.org/v1.0/",Rg=Dg+"full/",Fg=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.getUrl=function(t){var e,r=oe(t),i=r.name.substr(0,4);return!["pdb","cif"].includes(r.ext)||!1!==r.compressed&&"gz"!==r.compressed?"mmtf"===r.ext?e=r.base.endsWith(".bb")?"//mmtf.rcsb.org/v1.0/reduced/"+i:Rg+i:(r.ext&&me.warn("unsupported ext",r.ext),e=Rg+i):e="//files.rcsb.org/download/"+r.path,f()+e},e.prototype.getExt=function(t){var e=oe(t).ext;return e||"mmtf"},e}(Tg);Gt.add("rcsb",new Fg);var Eg="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",$g="/SDF?record_type=3d",Lg=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.getUrl=function(t){var e,r=oe(t),i=r.name;return r.ext&&"sdf"!==r.ext&&me.warn("unsupported ext",r.ext),e=Eg+i+$g,f()+e},e.prototype.getExt=function(t){var e=oe(t).ext;return e||"sdf"},e}(Tg);Gt.add("pubchem",new Lg);var Ng=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.getUrl=function(t){return t},e.prototype.getExt=function(t){return oe(t).ext},e}(Tg);Gt.add("ftp",new Ng),Gt.add("http",new Ng),Gt.add("https",new Ng);var zg=/^((http|https|ftp):)*\/\//,jg=function(e){function t(t){void 0===t&&(t=""),e.call(this),this.baseUrl=t}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.getUrl=function(t){var e,r,i,o,n=oe(t),a=this.baseUrl+n.path;return zg.test(this.baseUrl)||(e=a,r=window.location,i=r.pathname,o=i.substring(0,i.lastIndexOf("/")+1),a=r.origin+o+e),a},t.prototype.getExt=function(t){return oe(t).ext},t}(Tg),Vg=function(e){function t(t){void 0===t&&(t=""),e.call(this),this.baseUrl=t}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.getListing=function(e){void 0===e&&(e="");var t=this.baseUrl+"dir/"+e;return"/"!==t[t.length-1]&&(t+="/"),ae(t,{ext:"json"}).then(function(t){return{path:e,data:t.data}})},t.prototype.getUrl=function(t){var e=oe(t);return this.baseUrl+"file/"+e.path+e.query},t.prototype.getCountUrl=function(t){var e=oe(t);return this.baseUrl+"traj/numframes/"+e.path+e.query},t.prototype.getFrameUrl=function(t,e){var r=oe(t);return this.baseUrl+"traj/frame/"+e+"/"+r.path+r.query},t.prototype.getFrameParams=function(t,e){return"atomIndices="+e.join(";")},t.prototype.getPathUrl=function(t,e){var r=oe(t);return this.baseUrl+"traj/path/"+e+"/"+r.path+r.query},t.prototype.getExt=function(t){return oe(t).ext},t}(Tg);function Gg(t,e){return{type:"integer",max:t,min:e}}function Ug(t,e,r){return{type:"number",precision:t,max:e,min:r}}function Hg(t,e,r){return{type:"range",step:t,max:e,min:r}}function Wg(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return{type:"select",options:t.reduce(function(t,e){var r;return Object.assign(Object.assign({},t),((r={})[e]=e,r))},{})}}var qg={backgroundColor:{type:"color"},quality:Wg("auto","low","medium","high"),sampleLevel:Hg(1,5,-1),impostor:{type:"boolean"},workerDefault:{type:"boolean"},rotateSpeed:Ug(1,10,0),zoomSpeed:Ug(1,10,0),panSpeed:Ug(1,10,0),clipNear:Hg(1,100,0),clipFar:Hg(1,100,0),clipDist:Gg(200,0),clipMode:Wg("scene","camera"),clipScale:Wg("relative","absolute"),fogNear:Hg(1,100,0),fogFar:Hg(1,100,0),cameraType:Wg("perspective","orthographic","stereo"),cameraEyeSep:Ug(3,1,.01),cameraFov:Hg(1,120,15),lightColor:{type:"color"},lightIntensity:Ug(2,10,0),ambientColor:{type:"color"},ambientIntensity:Ug(2,10,0),hoverTimeout:Gg(1e4,-1),tooltip:{type:"boolean"},mousePreset:Wg.apply(void 0,Object.keys(va))};window.Promise||(window.Promise=t),de.Matrix3=fe.Matrix3,de.Matrix4=fe.Matrix4,de.Vector2=fe.Vector2,de.Vector3=fe.Vector3,de.Box3=fe.Box3,de.Quaternion=fe.Quaternion,de.Euler=fe.Euler,de.Plane=fe.Plane,de.Color=fe.Color,de.Signal=u.Signal,de.Version="2.0.0-dev.37",de.StaticDatasource=jg,de.MdsrvDatasource=Vg,de.Colormaker=q,de.Selection=Ct,de.PdbWriter=ce,de.SdfWriter=ue,de.StlWriter=pe,de.Stage=xu,de.Collection=Uc,de.ComponentCollection=gu,de.RepresentationCollection=Wc,de.Component=Vc,de.ShapeComponent=_u,de.StructureComponent=du,de.SurfaceComponent=fu,de.VolumeComponent=mu,de.Assembly=cs,de.TrajectoryPlayer=Jc,de.Superposition=Zc,de.Frames=Yc,de.Queue=Qr,de.Counter=ge,de.BufferRepresentation=uc,de.ArrowBuffer=ql,de.BoxBuffer=Jl,de.ConeBuffer=Ul,de.CylinderBuffer=Eh,de.EllipsoidBuffer=np,de.MeshBuffer=ua,de.OctahedronBuffer=hp,de.PointBuffer=Sc,de.SphereBuffer=_c,de.TetrahedronBuffer=mp,de.TextBuffer=vh,de.TorusBuffer=_p,de.WidelineBuffer=_h,de.Shape=sc,de.Structure=rc,de.Kdtree=is,de.SpatialHash=Vi,de.MolecularSurface=Al,de.Volume=ta,de.MouseActions=ya,de.KeyActions=_a,de.setDebug=function(t){de.Debug=t},de.MeasurementDefaultParams=Nt,de.setMeasurementDefaultParams=function(t){void 0===t&&(t={}),Object.assign(Nt,t)},de.ScriptExtensions=zt,de.ColormakerRegistry=Vt,de.DatasourceRegistry=Gt,de.DecompressorRegistry=qt,de.ParserRegistry=Ht,de.RepresentationRegistry=Ut,de.setListingDatasource=function(t){de.ListingDatasource=t},de.setTrajectoryDatasource=function(t){de.TrajectoryDatasource=t},de.autoLoad=ae,de.getDataInfo=ne,de.getFileInfo=oe,de.superpose=lu,de.guessElement=Is,de.concatStructures=function(t){for(var e=[],r=arguments.length-1;0<r--;)e[r]=arguments[r+1];de.Debug&&me.time("concatStructures");var i=new rc(t,""),o=new ps(i),n=i.atomStore,a=i.atomMap;n.addField("formalCharge",1,"int8"),n.addField("partialCharge",1,"float32");var s={},c=0,u=0,h=0;e.forEach(function(t){t.eachAtom(function(t){n.growIfFull(),n.atomTypeId[c]=a.add(t.atomname,t.element),n.x[c]=t.x,n.y[c]=t.y,n.z[c]=t.z,n.serial[c]=t.serial,n.formalCharge[c]=t.formalCharge,n.partialCharge[c]=t.partialCharge,n.altloc[c]=t.altloc,n.occupancy[c]=t.occupancy,n.bfactor[c]=t.bfactor,o.addAtom(t.modelIndex+h,t.chainname,t.chainid,t.resname,t.resno,1===t.hetero,t.sstruc,t.inscode),s[t.index+u]=c,c+=1}),u+=t.atomStore.count,h+=t.modelStore.count});var l=i.bondStore,p=i.getAtomProxy(),d=i.getAtomProxy();return u=0,e.forEach(function(t){t.eachBond(function(t){p.index=s[t.atomIndex1+u],d.index=s[t.atomIndex2+u],l.addBond(p,d,t.bondOrder)}),u+=t.atomStore.count}),o.finalize(),As(i,!0),ws(i,!0),i.finalizeAtoms(),i.finalizeBonds(),Os(i),de.Debug&&me.timeEnd("concatStructures"),i},de.flatten=function t(e,r){r=st(r,[]);for(var i=0;i<e.length;i++)Array.isArray(e[i])?t(e[i],r):r.push(e[i]);return r},de.throttle=function(r,i,o){var n,a,s,c=null,u=0;function h(){u=!1===o.leading?0:Date.now(),c=null,s=r.apply(n,a),c||(n=a=null)}return o||(o={}),function(){var t=Date.now();u||!1!==o.leading||(u=t);var e=i-(t-u);return n=this,a=arguments,e<=0||i<e?(c&&(clearTimeout(c),c=null),u=t,s=r.apply(n,a),c||(n=a=null)):c||!1===o.trailing||(c=setTimeout(h,e)),s}},de.download=y,de.getQuery=p,de.uniqueArray=_,de.LeftMouseButton=1,de.MiddleMouseButton=2,de.RightMouseButton=3,de.UIStageParameters=qg,Object.defineProperty(de,"__esModule",{value:!0})});
